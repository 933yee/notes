<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Deep Learning</title>
    <link href="/notes/2025/11/06/deep-learning/"/>
    <url>/notes/2025/11/06/deep-learning/</url>
    
    <content type="html"><![CDATA[<h2 id="Linear-Algebra"><a href="#Linear-Algebra" class="headerlink" title="Linear Algebra"></a>Linear Algebra</h2><h3 id="Span-Linear-Dependence"><a href="#Span-Linear-Dependence" class="headerlink" title="Span &amp; Linear Dependence"></a>Span &amp; Linear Dependence</h3><p>在 Machine Learning 裡面，不管原本的 function 是不是 Linear，我們都會試著用 Linear function 來 Approximate 它。</p><ul><li><p>$\text{span}(A_{:,1}, A_{:,2}, \ldots, A_{:,n})$ 被稱為 column space of A，記作 $\text{Col}(A)$</p></li><li><p>$\text{rank}(A)$ 是 $\text{Col}(A)$ 的維度 (dimension)</p></li><li><p>給定 $A$ 和 $y$，解方程式 $Ax &#x3D; y$，其中 $A$ 是 $m \times n$ 矩陣，$x$ 是 $n \times 1$ 向量，$y$ 是 $m \times 1$ 向量</p><ul><li><p><strong>一定至少有一個解</strong></p><p>因為 $Ax &#x3D; \Sigma_{i} x_i A_{:,i}$，所以 $Ax$ 只不過是 $A$ 的 column vectors 的 linear combination，只要 $y$ 能寫成 $A$ 的 column vectors 的 linear combination，就一定有解</p><p>因此，$\text{span}(A_{:,1}, A_{:,2}, \ldots, A_{:,n}) \ni \mathbb{R}^m$，也代表 $n \geq m$</p></li><li><p><strong>唯一解</strong></p><p>$A$ 最多只能有 $m$ 個 Column，也代表 $n &#x3D; m$，且 $A$ 的 column vectors 必須是線性獨立 linearly independent 的</p><p>在這種情況下，$A$ 是 full rank 的，且為 invertible，因此 $x &#x3D; A^{-1}y$ 是唯一解</p></li></ul></li></ul><h3 id="Norms"><a href="#Norms" class="headerlink" title="Norms"></a>Norms</h3><p>norm 是一個 function ($|\cdot|$)，能夠把 vector 映射到非負實數 (non-negative real number)</p><h4 id="L-p-norm"><a href="#L-p-norm" class="headerlink" title="$L^p$ norm:"></a>$L^p$ norm:</h4><p>$$<br>|x|_p &#x3D; \left( \sum_i |x_i|^p \right)^{1&#x2F;p}<br>$$</p><ul><li><p>$p&#x3D;1$: Manhattan norm</p></li><li><p>$p&#x3D;2$: Euclidean norm (通常直接寫成 $|x|$)</p><p>$$<br> |x| &#x3D; (x^Tx)^{1&#x2F;2} &#x3D; \sqrt{\sum_i x_i^2}<br>$$</p></li><li><p>$p \to \infty$: Maximum norm</p><p>$$<br> |x|_{\infty} &#x3D; \max_i |x_i|<br>$$</p></li><li><p>$x^Ty &#x3D; |x| |y| \cos \theta$，其中 $\theta$ 是 $x$ 和 $y$ 之間的夾角</p><ul><li>當 $x \perp y$ 時，$x^Ty &#x3D; 0$，稱為 orthogonal。且如果 $|x| &#x3D; |y| &#x3D; 1$ (unit vectors)，則 $x$ 和 $y$ 是 orthonormal 的</li></ul></li></ul><h4 id="Matrix-Norms"><a href="#Matrix-Norms" class="headerlink" title="Matrix Norms"></a>Matrix Norms</h4><ul><li><p>Frobenius norm:</p><p>$$<br> |A|<em>F &#x3D; \sqrt{\sum</em>{i,j} A_{i,j}^2} &#x3D; \sqrt{\text{trace}(A^TA)}<br>$$</p></li><li><p>Orthogonal matrix:</p><p>每個 column vector 都是 unit vector，且彼此 orthogonal，通常不會特別去區分 orthogonal matrix 和 orthonormal matrix，都稱為 orthogonal matrix</p><p>$$<br> Q^TQ &#x3D; QQ^T &#x3D; I<br>$$</p><ul><li>也代表 $Q^{-1} &#x3D; Q^T$</li></ul></li></ul><h3 id="Eigendecomposition"><a href="#Eigendecomposition" class="headerlink" title="Eigendecomposition"></a>Eigendecomposition</h3><p>Decomposition 可以幫助我們快速了解矩陣的性質</p><h4 id="Eigen-vectors-Eigen-values"><a href="#Eigen-vectors-Eigen-values" class="headerlink" title="Eigen vectors &amp; Eigen values"></a>Eigen vectors &amp; Eigen values</h4><ul><li><p>給定一個方陣 $A$，如果存在一個非零向量 $v$ 和一個純量 $\lambda$，使得</p><p>$$<br> Av &#x3D; \lambda v<br>$$</p><p>則稱 $v$ 為 $A$ 的 <strong>eigen vector</strong>，$\lambda$ 為對應的 <strong>eigen value</strong></p><p>可以想像成，某個 function A 遇到 eigen vector 時，只會對其進行伸縮 (scaling)，不會改變方向</p></li><li><p>如果 $v$ 是一個 eigen vector，則 $cv$ (c 為非零常數) 也是 eigen vector，對應的 eigen value 不變，所以一般只會討論 unit eigen vectors</p></li></ul><h4 id="Eigendecomposition-1"><a href="#Eigendecomposition-1" class="headerlink" title="Eigendecomposition"></a>Eigendecomposition</h4><ul><li><p>任何 <strong>real symmetric matrix</strong> $A \in \mathbb{R}^{n \times n}$ 都可以被分解成</p><p>$$<br>A &#x3D; Q \text{diag}(\lambda) Q^T<br>$$</p><ul><li>$\lambda \in \mathbb{R}^n$: eigen values of $A$，通常會由大到小排序</li><li>$Q &#x3D; [v_1, v_2, \ldots, v_n]$: 由 $A$ 的 eigen vectors 組成的 orthogonal matrix</li></ul></li><li><p>Eigendecomposition 不是唯一的</p></li></ul><p><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT9qejWx2-LxS3zRwd4QcDk7cob7ZWCQJhRoxOjFTb5kmmPzmFDrMYrEEkpc5OwNYNJhPY&usqp=CAU" alt="eigendecomposition"></p><p>可以想成把矩陣 A 當作一個線性轉換 (linear transformation)，先把空間旋轉到 eigen vector 的方向 (由 Q 決定)，再沿著各個 eigen vector 方向進行伸縮 (由 $\lambda$ 決定)，最後再把空間旋轉回來 (由 $Q^T$ 決定)</p><h4 id="Rayleigh’s-Quotient"><a href="#Rayleigh’s-Quotient" class="headerlink" title="Rayleigh’s Quotient"></a>Rayleigh’s Quotient</h4><p>給定一個 real symmetric matrix $A \in \mathbb{R}^{n \times n}$，對任意非零向量 $x \in \mathbb{R}^n$，定義 Rayleigh’s Quotient 為</p><p>$$<br>R(x) &#x3D; \frac{x^T A x}{x^T x}<br>$$</p><p>且</p><p>$$<br>\lambda_{\min} \leq R(x) \leq \lambda_{\max}<br>$$</p><ul><li>$\lambda_{\min}$: $A$ 的最小 eigen value</li><li>$\lambda_{\max}$: $A$ 的最大 eigen value</li><li>當且僅當 $x$ 是對應於 $\lambda_{\min}$ 或 $\lambda_{\max}$ 的 eigen vector 時，等號成立</li></ul><h4 id="Singularity"><a href="#Singularity" class="headerlink" title="Singularity"></a>Singularity</h4><p>若 $A &#x3D; Q \text{diag}(\lambda) Q^T$，則 $A^{-1} &#x3D; Q \text{diag}(\lambda)^{-1} Q^T$</p><p>因為 Diagonal matrix 的反矩陣是把對角線元素取倒數，所以當 $\lambda_i &#x3D; 0$ 時，$A$ 就沒有反矩陣，稱為 singular matrix</p><h4 id="Positive-Definiteness"><a href="#Positive-Definiteness" class="headerlink" title="Positive Definiteness"></a>Positive Definiteness</h4><ul><li><p>Positive Definite:</p><p>對所有非零向量 $x$，都有 $x^T A x &gt; 0$，等價於所有的 eigen values 都是正的</p></li><li><p>Positive Semi-Definite:</p><p>對所有非零向量 $x$，都有 $x^T A x \geq 0$，等價於所有的 eigen values 都是非負的</p></li></ul><p>對於一個 Quadratic Function $f(x) &#x3D; \frac{1}{2} x^T A x - b^T x + c$，可以藉由檢查 $A$ 是否為 <code>Positive Definite</code>、<code>Positive Semi-Definite</code>、<code>Negative Definite</code>、<code>Negative Semi-Definite</code> 來判斷其凸性 (convexity)：</p><table><thead><tr><th>Definiteness</th><th>Convexity</th><th>Condition on Eigenvalues</th></tr></thead><tbody><tr><td>Positive Definite</td><td>Strictly Convex</td><td>All eigenvalues &gt; 0</td></tr><tr><td>Positive Semi-Definite</td><td>Convex</td><td>All eigenvalues ≥ 0</td></tr><tr><td>Negative Definite</td><td>Strictly Concave</td><td>All eigenvalues &lt; 0</td></tr><tr><td>Negative Semi-Definite</td><td>Concave</td><td>All eigenvalues ≤ 0</td></tr><tr><td>Indefinite</td><td>Neither</td><td>Eigenvalues of mixed signs</td></tr></tbody></table><h3 id="Singular-Value-Decomposition-SVD"><a href="#Singular-Value-Decomposition-SVD" class="headerlink" title="Singular Value Decomposition (SVD)"></a>Singular Value Decomposition (SVD)</h3><p>Eigendecomposition 要求矩陣是方陣 (square matrix) 且為 symmetric matrix，但 SVD 不需要這些限制</p><p>任何一個矩陣 $A \in \mathbb{R}^{m \times n}$ 都可以被分解成</p><p>$$<br>A &#x3D; U \Sigma V^T<br>$$</p><ul><li>$U \in \mathbb{R}^{m \times m}$: 左奇異向量 (left singular vectors)，為 $AA^T$ 的 eigen vectors 組成的 orthogonal matrix</li><li>$\Sigma \in \mathbb{R}^{m \times n}$: 對角矩陣 (diagonal matrix)，對角線上的元素為 $AA^T$ 或 $A^TA$ 的 eigen values 的平方根，稱為 singular values，且通常會由大到小排序</li><li>$V \in \mathbb{R}^{n \times n}$: 右奇異向量 (right singular vectors)，為 $A^TA$ 的 eigen vectors 組成的 orthogonal matrix</li></ul><h3 id="Moore-Penrose-Pseudoinverse"><a href="#Moore-Penrose-Pseudoinverse" class="headerlink" title="Moore-Penrose Pseudoinverse"></a>Moore-Penrose Pseudoinverse</h3><p>對於一般情況，一個非方陣 $A \in \mathbb{R}^{m \times n}$，我們無法計算其反矩陣 $A^{-1}$，但我們可以用另一個矩陣 $B \in \mathbb{R}^{n \times m}$ ，用來解出 $Ax &#x3D; y$，即 $x &#x3D; By$</p><p>Moore-Penrose Pseudoinverse 令 $B &#x3D; A^+$，可以把任務拆成三種 Case：</p><ol><li><p><strong>$m &#x3D; n$</strong>:</p><ul><li>有唯一解 (如果 $A$ 是 invertible 的)</li><li>解為 $A^+ &#x3D; A^{-1}$</li></ul></li><li><p><strong>$m &lt; n$</strong>:</p><ul><li>有無限多解</li><li>目標是找到一個 $x$，使得 $|x|_2$ 最小，找一個最小範數解</li></ul></li><li><p><strong>$m &gt; n$</strong>:</p><ul><li>沒有精確解</li><li>目標是找到一個 $x$，使得 $|Ax - y|_2$ 最小，找一個最佳近似解</li></ul></li></ol><p>Moore-Penrose Pseudoinverse 定義為</p><p>$$<br>A^+ &#x3D; \text{lim}_{\lambda \to 0^+} (A^TA + \lambda I)^{-1} A^T<br>$$</p><p>其中 $\lambda$ 是一個非常小的正數，用來確保 $A^TA + \lambda I$ 是 Full Rank 的，因此可以被反轉</p><p>實際上計算時，可以直接用 SVD 來計算，先把 $A$ 分解成 $A &#x3D; U \Sigma V^T$，則</p><p>$$<br>A^+ &#x3D; V \Sigma^+ U^T<br>$$</p><p>其中 $\Sigma^+$ 是把 $\Sigma$ 的非零奇異值取倒數後，再轉置得到的矩陣</p><h3 id="Maximum-Likelihood-Estimation-MLE"><a href="#Maximum-Likelihood-Estimation-MLE" class="headerlink" title="Maximum Likelihood Estimation (MLE)"></a>Maximum Likelihood Estimation (MLE)</h3><ul><li>假設資料是獨立同分佈 (i.i.d)</li><li>給定資料集 $D &#x3D; {x_1, x_2, \ldots, x_N}$，假設資料來自某個參數化的分佈 $p(x|\theta)$</li><li>目標是找到參數 $\theta$，使得在該參數下，資料出現的機率最大</li><li>定義似然函數 (Likelihood Function) 為資料在參數 $\theta$ 下的聯合機率<ul><li>$L(\theta; D) &#x3D; p(D|\theta) &#x3D; \prod_{i&#x3D;1}^{N} p(x_i|\theta)$</li></ul></li><li>最大化似然函數等價於最大化對數似然函數 (Log-Likelihood Function)<ul><li>$\ell(\theta; D) &#x3D; \log L(\theta; D) &#x3D; \sum_{i&#x3D;1}^{N} \log p(x_i|\theta)$</li></ul></li><li>最大化對數似然函數的參數 $\theta$ 即為 MLE<ul><li>$\hat{\theta}<em>{MLE} &#x3D; \arg\max</em>{\theta} \ell(\theta; D)$</li></ul></li></ul><h2 id="Large-Scale-Machine-Learning"><a href="#Large-Scale-Machine-Learning" class="headerlink" title="Large-Scale Machine Learning"></a>Large-Scale Machine Learning</h2><p>Solve problems by leveraging the posteriror knowledge learned from the big data.</p><ul><li>Characteristics of Big Data:<ul><li>Volume: 大量的資料</li><li>Variety: 多樣化的資料類型和來源</li><li>Velocity: 單位時間的資料量</li><li>Veracity: 資料的真實性和可靠性</li></ul></li></ul><h2 id="Neural-Networks-Design"><a href="#Neural-Networks-Design" class="headerlink" title="Neural Networks: Design"></a>Neural Networks: Design</h2><ul><li><p>Feedforward neural networks (FNN) 又稱 multi-layer perceptron (MLP)</p><p>$$<br> \begin{aligned}<br>  \hat{y} &#x3D; f^{(L)}(\ldots f^{(2)}(f^{(1)}(x; \theta^{(1)}); \theta^{(2)}) \ldots; \theta^{(L)})<br> \end{aligned}<br>$$</p><ul><li>$L$: number of layers</li><li>$f^{(l)}$: nonlinear function of layer $l$</li><li>$\theta^{(l)}$: parameters of layer $l$</li><li>$x$: input vector</li></ul></li><li><p>$f^{(k)}$ outputs value $a^{(k)}$, where</p><p>$$<br> \begin{aligned}<br>  a^{(k)} &amp;&#x3D; f^{(k)}(a^{(k-1)}; \theta^{(k)}) \newline<br>  &amp;&#x3D; \text{act}^{(k)}(W^{(k)\top} a^{(k-1)} + b^{(k)}) \newline<br> \end{aligned}<br>$$</p><ul><li>$W^{(k)}$: weight matrix of layer $k$</li><li>$b^{(k)}$: bias vector of layer $k$</li><li>$\text{act}^{(k)}$: activation function of layer $k$</li><li>$a^{(0)} &#x3D; x$</li></ul></li></ul><p>沒有非線性，模型就沒有深度，等價於單層線性模型而已。</p><h3 id="Training-an-NN"><a href="#Training-an-NN" class="headerlink" title="Training an NN"></a>Training an NN</h3><ul><li>Most NNs are trained using the <strong>maximum likelihood</strong> by default.</li></ul><p>$$<br>\begin{aligned}<br>    \text{argmax}<em>{\Theta} \text{log } P(X | \Theta) &amp;&#x3D; \text{argmin}</em>{\Theta} -\text{log } P(X | \Theta) \newline<br>    &amp;&#x3D; \text{argmin}<em>{\Theta} \Sigma_i -\text{log } P(x_i, y_i | \Theta) \newline<br>    &amp;&#x3D; \text{argmin}</em>{\Theta} \Sigma_i [-\text{log } P(y_i | x_i, \Theta) - \text{log } P(x_i | \Theta)] \newline<br>    &amp;&#x3D; \text{argmin}<em>{\Theta} \Sigma_i -\text{log } P(y_i | x_i, \Theta) \quad \text{(if we ignore } P(x_i | \Theta)) \newline<br>    &amp;&#x3D; \text{argmin}</em>{\Theta} \Sigma_i C_i (\Theta)<br>\end{aligned}<br>$$</p><ul><li><p>通常 $P(x_i | \Theta)$ 不依賴於模型參數 $\Theta$，可以把他想像成常數，最小化時不會影響結果，所以可以忽略</p></li><li><p>decision</p></li><li><p>xgboost</p></li><li><p>lightgbm</p></li><li><p>rnn</p></li><li><p>lstm<br><a href="https://blog.nbswords.com/2020/12/xgboostlightgbmcatboost.html">https://blog.nbswords.com/2020/12/xgboostlightgbmcatboost.html</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>deep learning</tag>
      
      <tag>ai</tag>
      
      <tag>machine learning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LeetCode Contest</title>
    <link href="/notes/2025/11/02/leetcode-contest/"/>
    <url>/notes/2025/11/02/leetcode-contest/</url>
    
    <content type="html"><![CDATA[<h2 id="Weekly-Contest-474"><a href="#Weekly-Contest-474" class="headerlink" title="Weekly Contest 474"></a>Weekly Contest 474</h2><h3 id="3731-Find-Missing-Elements-Easy"><a href="#3731-Find-Missing-Elements-Easy" class="headerlink" title="3731. Find Missing Elements - Easy"></a>3731. Find Missing Elements - Easy</h3><p>給定 nums 陣列，找出裡面最小和最大的值之間缺少的所有整數。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">findMissingElements</span><span class="hljs-params">(std::vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">int</span> min_val = *<span class="hljs-built_in">min_element</span>(nums.<span class="hljs-built_in">begin</span>(), nums.<span class="hljs-built_in">end</span>());<br>        <span class="hljs-type">int</span> max_val = *<span class="hljs-built_in">max_element</span>(nums.<span class="hljs-built_in">begin</span>(), nums.<span class="hljs-built_in">end</span>());<br><br>        <span class="hljs-function">unordered_set&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">nums_set</span><span class="hljs-params">(nums.begin(), nums.end())</span></span>;<br><br>        vector&lt;<span class="hljs-type">int</span>&gt; missing;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = min_val + <span class="hljs-number">1</span>; i &lt; max_val; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (nums_set.<span class="hljs-built_in">find</span>(i) == nums_set.<span class="hljs-built_in">end</span>())<br>                missing.<span class="hljs-built_in">push_back</span>(i);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> missing;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3732-Maximum-Product-of-Three-Elements-After-One-Replacement-Medium"><a href="#3732-Maximum-Product-of-Three-Elements-After-One-Replacement-Medium" class="headerlink" title="3732. Maximum Product of Three Elements After One Replacement - Medium"></a>3732. Maximum Product of Three Elements After One Replacement - Medium</h3><p>給定 nums 陣列，可以用 [$-10^5, 10^5$] 範圍內的任意整數替換陣列中的一個元素，求替換後三個元素乘積的最大值。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">maxProduct</span><span class="hljs-params">(std::vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-keyword">using</span> ll = <span class="hljs-type">long</span> <span class="hljs-type">long</span>;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-built_in">sort</span>(nums.<span class="hljs-built_in">begin</span>(), nums.<span class="hljs-built_in">end</span>());<br><br>        ll s1 = nums[<span class="hljs-number">0</span>];<br>        ll s2 = nums[<span class="hljs-number">1</span>];<br>        ll l1 = nums[n - <span class="hljs-number">1</span>];<br>        ll l2 = nums[n - <span class="hljs-number">2</span>];<br><br>        <span class="hljs-type">const</span> ll R = <span class="hljs-number">100000LL</span>;<br><br>        ll prod1 = <span class="hljs-built_in">max</span>(s1 * s2, l1 * l2) * R;<br>        ll prod2 = (s1 * l1) * (-R);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(&#123;prod1, prod2&#125;);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3733-Minimum-Time-to-Complete-All-Deliveries-Medium"><a href="#3733-Minimum-Time-to-Complete-All-Deliveries-Medium" class="headerlink" title="3733. Minimum Time to Complete All Deliveries - Medium"></a>3733. Minimum Time to Complete All Deliveries - Medium</h3><p>給定兩個無人機， 分別需要完成 d[0] 和 d[1] 個任務，兩台分別每 r[0] 和 r[1] 小時需要充電一次，且兩者不能同時工作，求完成所有任務的最少時間。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">gcd</span><span class="hljs-params">(<span class="hljs-type">long</span> <span class="hljs-type">long</span> a, <span class="hljs-type">long</span> <span class="hljs-type">long</span> b)</span></span>&#123;<br>        <span class="hljs-keyword">while</span>(b)&#123;<br>            a %= b;<br>            <span class="hljs-built_in">swap</span>(a, b);<br>        &#125;<br>        <span class="hljs-keyword">return</span> a;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">lcm</span><span class="hljs-params">(<span class="hljs-type">long</span> <span class="hljs-type">long</span> a, <span class="hljs-type">long</span> <span class="hljs-type">long</span> b)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span> || b == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> a / <span class="hljs-built_in">gcd</span>(a, b) * b;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">valid</span><span class="hljs-params">(<span class="hljs-type">long</span> <span class="hljs-type">long</span> t, vector&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt;&amp; lld, vector&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt;&amp; llr, <span class="hljs-type">long</span> <span class="hljs-type">long</span> rlcm)</span></span>&#123;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> r0 = t / llr[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> r1 = t / llr[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> r_both = t / rlcm;<br><br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> slot0 = r1 - r_both;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> slot1 = r0 - r_both;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> slot_both = t - r0 - r1 + r_both;<br><br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> remaining0 = <span class="hljs-built_in">max</span>(lld[<span class="hljs-number">0</span>] - slot0, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>) <span class="hljs-number">0</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> remaining1 = <span class="hljs-built_in">max</span>(lld[<span class="hljs-number">1</span>] - slot1, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>) <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> (remaining0 + remaining1) &lt;= slot_both;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">minimumTime</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; d, vector&lt;<span class="hljs-type">int</span>&gt;&amp; r)</span> </span>&#123;<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt; <span class="hljs-title">lld</span><span class="hljs-params">(d.begin(), d.end())</span></span>;<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt; <span class="hljs-title">llr</span><span class="hljs-params">(r.begin(), r.end())</span></span>;<br><br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> left = d[<span class="hljs-number">0</span>] + d[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> right = <span class="hljs-number">2</span> * left;<br><br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> ans = right;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> rlcm = <span class="hljs-built_in">lcm</span>(llr[<span class="hljs-number">0</span>], llr[<span class="hljs-number">1</span>]);<br>        <span class="hljs-keyword">while</span>(left &lt;= right)&#123;<br>            <span class="hljs-type">long</span> <span class="hljs-type">long</span> m = left + (right - left) / <span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">valid</span>(m, lld, llr, rlcm))&#123;<br>                right = m - <span class="hljs-number">1</span>;<br>                ans = m;<br>            &#125;<span class="hljs-keyword">else</span><br>                left = m + <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ans;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="3734-Lexicographically-Smallest-Palindromic-Permutation-Greater-Than-Target"><a href="#3734-Lexicographically-Smallest-Palindromic-Permutation-Greater-Than-Target" class="headerlink" title="3734. Lexicographically Smallest Palindromic Permutation Greater Than Target"></a>3734. Lexicographically Smallest Palindromic Permutation Greater Than Target</h3><p>給定一個字串 s 和 target，找出 s 的所有回文排列中，比 target 字典序更大的最小回文排列，若無則回傳空字串。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">string <span class="hljs-title">lexPalindromicPermutation</span><span class="hljs-params">(string s, string target)</span> </span>&#123;<br>        <span class="hljs-type">int</span> left[<span class="hljs-number">26</span>]&#123;&#125;;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> b : s) &#123;<br>            left[b - <span class="hljs-string">&#x27;a&#x27;</span>]++;<br>        &#125;<br>        <span class="hljs-keyword">auto</span> valid = [&amp;]() -&gt; <span class="hljs-type">bool</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> c : left) &#123;<br>                <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;;<br><br>        string mid_ch;<br>        <span class="hljs-comment">// 先檢查 s 能不能組成回文，順便把中間字元找出來</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">26</span>; i++) &#123;<br>            <span class="hljs-type">int</span> c = left[i];<br>            <span class="hljs-keyword">if</span> (c % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!mid_ch.<span class="hljs-built_in">empty</span>()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>            mid_ch = <span class="hljs-string">&#x27;a&#x27;</span> + i;<br>            left[i]--;<br>        &#125;<br><br>        <span class="hljs-type">int</span> n = s.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-comment">// 先假設能夠組成和 target 左半邊相同的字串 (不含中間字元)</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n / <span class="hljs-number">2</span>; i++) &#123;<br>            left[target[i] - <span class="hljs-string">&#x27;a&#x27;</span>] -= <span class="hljs-number">2</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">valid</span>()) &#123;<br>            <span class="hljs-comment">// 特殊情況，如果合理且 s 右半邊 (包含中間字元) 比 target 大，直接回傳</span><br>            string right_s = target.<span class="hljs-built_in">substr</span>(<span class="hljs-number">0</span>, n / <span class="hljs-number">2</span>);<br>            ranges::<span class="hljs-built_in">reverse</span>(right_s);<br>            right_s = mid_ch + right_s;<br>            <span class="hljs-keyword">if</span> (right_s &gt; target.<span class="hljs-built_in">substr</span>(n / <span class="hljs-number">2</span>)) &#123;<br>                <span class="hljs-keyword">return</span> target.<span class="hljs-built_in">substr</span>(<span class="hljs-number">0</span>, n / <span class="hljs-number">2</span>) + right_s;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 不能的話就從中間開始往前找，嘗試把字元換成更大的字元</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = n / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>            <span class="hljs-type">int</span> b = target[i] - <span class="hljs-string">&#x27;a&#x27;</span>;<br>            left[b] += <span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">valid</span>()) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = b + <span class="hljs-number">1</span>; j &lt; <span class="hljs-number">26</span>; j++) &#123;<br>                <span class="hljs-keyword">if</span> (left[j] == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br><br>                left[j] -= <span class="hljs-number">2</span>;<br>                target.<span class="hljs-built_in">resize</span>(i + <span class="hljs-number">1</span>);<br>                target[i] = <span class="hljs-string">&#x27;a&#x27;</span> + j;<br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">26</span>; k++) &#123;<br>                    target += <span class="hljs-built_in">string</span>(left[k] / <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;a&#x27;</span> + k);<br>                &#125;<br><br>                string right_s = target;<br>                ranges::<span class="hljs-built_in">reverse</span>(right_s);<br>                target += mid_ch;<br>                target += right_s;<br><br>                <span class="hljs-keyword">return</span> target;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Leetcode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Tech Reflections</title>
    <link href="/notes/2025/11/01/tech-reflections/"/>
    <url>/notes/2025/11/01/tech-reflections/</url>
    
    <content type="html"><![CDATA[<h2 id="軟體開發的第一原則"><a href="#軟體開發的第一原則" class="headerlink" title="軟體開發的第一原則"></a>軟體開發的第一原則</h2><ol><li>Make it work</li><li>Make it right</li><li>Make it fast</li></ol><h3 id="Make-it-work"><a href="#Make-it-work" class="headerlink" title="Make it work"></a>Make it work</h3><ul><li>如果總是糾結於 refactor、優化，沒有完整能運作的系統，一切都是空談。</li><li>軟體的生命始於上線，一個沒有上線、沒有被實際使用過的軟體，無論架構多好、程式碼多漂亮，都是毫無意義的。</li></ul><h3 id="Make-it-right"><a href="#Make-it-right" class="headerlink" title="Make it right"></a>Make it right</h3><ul><li>隨著對問題的理解，會接觸到更多的 edge case 和新技術，會逐漸改變對「正確」的認知，不太可能一開始就做出正確的東西。</li><li>市面上所謂的「state-of-the-art」也是漸進演變的，不是一夕之間決定的，不會是某個人突然發明了一個完美無缺的解法。</li><li>軟體開發不存在絕對的 right 或 wrong，只有 better 跟 worse ，應該把目標放在 good enough。</li></ul><h3 id="Make-it-fast"><a href="#Make-it-fast" class="headerlink" title="Make it fast"></a>Make it fast</h3><p>大多數的軟體根本不會走到這一步。</p><ul><li>一般使用者感覺不出來。</li><li>外部優化 &gt;&gt; 程式碼優化： 用好的 CDN 服務商、設計合理的部署策略，對使用者體驗的提升遠大於在程式碼層面的優化。</li><li>優先級很低，等到 work 和 right 兩大根基打穩了，追求極致的效能優化才有意義。<br>&#96;</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>tech</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Algorithm</title>
    <link href="/notes/2025/10/24/algorithm/"/>
    <url>/notes/2025/10/24/algorithm/</url>
    
    <content type="html"><![CDATA[<h2 id="Moore’s-Voting-Algorithm-摩爾投票法"><a href="#Moore’s-Voting-Algorithm-摩爾投票法" class="headerlink" title="Moore’s Voting Algorithm 摩爾投票法"></a>Moore’s Voting Algorithm 摩爾投票法</h2><p>找出一個序列中出現次數超過一半的元素。 (majority element)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">candidate = <span class="hljs-literal">None</span><br>count = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> nums:<br>    <span class="hljs-keyword">if</span> count == <span class="hljs-number">0</span>:<br>        candidate = num<br>    <span class="hljs-keyword">if</span> num == candidate:<br>        count += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        count -= <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="龜兔賽跑演算法-快慢指標法-Floyd’s-Tortoise-and-Hare"><a href="#龜兔賽跑演算法-快慢指標法-Floyd’s-Tortoise-and-Hare" class="headerlink" title="龜兔賽跑演算法 &#x2F; 快慢指標法 (Floyd’s Tortoise and Hare)"></a>龜兔賽跑演算法 &#x2F; 快慢指標法 (Floyd’s Tortoise and Hare)</h2><table><thead><tr><th>類型</th><th>解釋</th><th>範例</th></tr></thead><tbody><tr><td><strong>Cycle Detection</strong></td><td>判斷 linked list 是否有環。若有，<code>slow</code> 和 <code>fast</code> 最終會相遇。</td><td><code>Floyd’s Cycle Detection</code></td></tr><tr><td><strong>Middle Node Finding</strong></td><td>當 <code>fast</code> 走兩步、<code>slow</code> 走一步時，當 <code>fast</code> 到終點，<code>slow</code> 在中間。</td><td>找中間節點</td></tr><tr><td><strong>Nth Node from End</strong></td><td><code>fast</code> 先走 N 步，再讓 <code>slow</code> 一起走，<code>fast</code> 到尾時，<code>slow</code> 就在倒數第 N 個。</td><td>找倒數第 k 個節點</td></tr><tr><td><strong>List Intersection</strong></td><td>判斷兩條 linked list 是否交會。</td><td>判斷是否有共同節點</td></tr></tbody></table><h3 id="Linked-List-Cycle"><a href="#Linked-List-Cycle" class="headerlink" title="Linked List Cycle"></a>Linked List Cycle</h3><p><a href="https://leetcode.com/problems/linked-list-cycle/">Leetcode 141. Linked List Cycle</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(ListNode *head)</span> </span>&#123;<br>        ListNode* fast = head;<br>        ListNode* slow = head;<br>        <span class="hljs-keyword">while</span>(fast &amp;&amp; fast-&gt;next)&#123;<br>            slow = slow-&gt;next;<br>            fast = fast-&gt;next-&gt;next;<br>            <span class="hljs-keyword">if</span>(slow == fast) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>快指針每次走兩步，慢指針每次走一步。如果有環，兩者在環中的相對距離會每次減少 1，最終相遇。</p><h3 id="Middle-of-the-Linked-List"><a href="#Middle-of-the-Linked-List" class="headerlink" title="Middle of the Linked List"></a>Middle of the Linked List</h3><p><a href="https://leetcode.com/problems/reorder-list/">Leetcode 143. Reorder List</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reorderList</span><span class="hljs-params">(ListNode* head)</span> </span>&#123;<br>        <span class="hljs-comment">// find the middle node</span><br>        ListNode* slow = head, * fast = head;<br>        <span class="hljs-keyword">while</span>(fast &amp;&amp; fast-&gt;next)&#123;<br>            fast = fast-&gt;next-&gt;next;<br>            slow = slow-&gt;next;<br>        &#125;<br><br>        <span class="hljs-comment">// reverse</span><br>        ListNode* cur = slow-&gt;next, * prev = <span class="hljs-literal">nullptr</span>;<br>        slow-&gt;next = <span class="hljs-literal">nullptr</span>;<br>        <span class="hljs-keyword">while</span>(cur)&#123;<br>            ListNode* tmp = cur-&gt;next;<br>            cur-&gt;next = prev;<br>            prev = cur;<br>            cur = tmp;<br>        &#125;<br>        <span class="hljs-comment">// combine two linked list</span><br>        ListNode* l1 = head;<br>        ListNode* l2 = prev;<br>        <span class="hljs-keyword">while</span>(l1 &amp;&amp; l2)&#123;<br>            ListNode* n1 = l1-&gt;next;<br>            ListNode* n2 = l2-&gt;next;<br>            l1-&gt;next = l2;<br>            <span class="hljs-keyword">if</span>(n1 == <span class="hljs-literal">nullptr</span>) <span class="hljs-keyword">break</span>;<br>            l2-&gt;next = n1;<br>            l1 = n1;<br>            l2 = n2;<br>        &#125;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>藉由快慢指標快速找到中間節點後，將後半段 linked list 反轉，最後將前後兩段交錯合併即可。</p><h3 id="Remove-Nth-Node-From-End-of-List"><a href="#Remove-Nth-Node-From-End-of-List" class="headerlink" title="Remove Nth Node From End of List"></a>Remove Nth Node From End of List</h3><p><a href="https://leetcode.com/problems/remove-nth-node-from-end-of-list/">Leetcode 19. Remove Nth Node From End of List</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">ListNode* <span class="hljs-title">removeNthFromEnd</span><span class="hljs-params">(ListNode* head, <span class="hljs-type">int</span> n)</span> </span>&#123;<br>        ListNode* dummy = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ListNode</span>(<span class="hljs-number">0</span>, head);<br>        ListNode* slow = dummy, * fast = dummy;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= n; i++)<br>            fast = fast-&gt;next;<br>        <span class="hljs-keyword">while</span>(fast)&#123;<br>            fast = fast-&gt;next;<br>            slow = slow-&gt;next;<br>        &#125;<br>        slow-&gt;next = slow-&gt;next-&gt;next;<br>        <span class="hljs-keyword">return</span> dummy-&gt;next;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>可以使用一個虛擬節點 <code>dummy</code> 指向 head，讓 <code>fast</code> 先走 n+1 步，然後 <code>slow</code> 和 <code>fast</code> 一起走，當 <code>fast</code> 到尾時，<code>slow</code> 就在倒數第 n 個節點的前一個節點，將其刪除即可。</p><h2 id="Binary-Search-Tree-二元搜尋樹"><a href="#Binary-Search-Tree-二元搜尋樹" class="headerlink" title="Binary Search Tree 二元搜尋樹"></a>Binary Search Tree 二元搜尋樹</h2><p>二元搜尋樹 (BST) 是一種特殊的二元樹，對於每個節點：</p><ul><li>左子樹的所有節點值都小於該節點值。</li><li>右子樹的所有節點值都大於該節點值。</li><li>每個子樹也是一棵二元搜尋樹。</li></ul><h3 id="Validate-Binary-Search-Tree"><a href="#Validate-Binary-Search-Tree" class="headerlink" title="Validate Binary Search Tree"></a>Validate Binary Search Tree</h3><p><a href="https://leetcode.com/problems/validate-binary-search-tree/">Leetcode 98. Validate Binary Search Tree</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">inorder</span><span class="hljs-params">(TreeNode* root, <span class="hljs-type">long</span>&amp; prev)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(!root) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">inorder</span>(root-&gt;left, prev))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span>(root-&gt;val &lt;= prev) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">else</span> prev = root-&gt;val;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">inorder</span>(root-&gt;right, prev))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isValidBST</span><span class="hljs-params">(TreeNode* root)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(!root) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-type">long</span> prev = LONG_MIN;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">inorder</span>(root, prev);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>對於 BST 來說，中序遍歷 (Inorder) 會得到一個嚴格遞增的序列，可以利用這個特性來驗證這棵二元樹是否為合法的 BST。</p><h3 id="Kth-Smallest-Element-in-a-BST"><a href="#Kth-Smallest-Element-in-a-BST" class="headerlink" title="Kth Smallest Element in a BST"></a>Kth Smallest Element in a BST</h3><p><a href="https://leetcode.com/problems/kth-smallest-element-in-a-bst/">Leetcode 230. Kth Smallest Element in a BST</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">inorder</span><span class="hljs-params">(TreeNode* root, <span class="hljs-type">int</span> k, <span class="hljs-type">int</span>&amp; cur, <span class="hljs-type">int</span>&amp; step)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(!root) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">inorder</span>(root-&gt;left, k, cur, step))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        cur = root-&gt;val;<br>        <span class="hljs-keyword">if</span>(++step == k) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">inorder</span>(root-&gt;right, k, cur, step))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">kthSmallest</span><span class="hljs-params">(TreeNode* root, <span class="hljs-type">int</span> k)</span> </span>&#123;<br>        <span class="hljs-type">int</span> cur = <span class="hljs-number">0</span>, step = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">inorder</span>(root, k, cur, step);<br>        <span class="hljs-keyword">return</span> cur;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>一樣利用中序遍歷嚴格遞增的特性，當遍歷到第 k 個節點時，即為第 k 小的元素。</p>]]></content>
    
    
    <categories>
      
      <category>Algorithm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Deep Learning Lab</title>
    <link href="/notes/2025/10/11/deep-learning-lab/"/>
    <url>/notes/2025/10/11/deep-learning-lab/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab-10-Word2Vec-Noise-Contrastive-Estimation-using-Subclassing"><a href="#Lab-10-Word2Vec-Noise-Contrastive-Estimation-using-Subclassing" class="headerlink" title="Lab 10: Word2Vec &amp; Noise Contrastive Estimation using Subclassing"></a>Lab 10: Word2Vec &amp; Noise Contrastive Estimation using Subclassing</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br>os.environ[<span class="hljs-string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>] = <span class="hljs-string">&#x27;2&#x27;</span> <span class="hljs-comment"># disable warning and info message</span><br><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> random<br><br>gpus = tf.config.experimental.list_physical_devices(<span class="hljs-string">&#x27;GPU&#x27;</span>)<br><span class="hljs-keyword">if</span> gpus:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># Restrict TensorFlow to only use the first GPU</span><br>        tf.config.experimental.set_visible_devices(gpus[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;GPU&#x27;</span>)<br><br>        <span class="hljs-comment"># Currently, memory growth needs to be the same across GPUs</span><br>        <span class="hljs-keyword">for</span> gpu <span class="hljs-keyword">in</span> gpus:<br>            tf.config.experimental.set_memory_growth(gpu, <span class="hljs-literal">True</span>)<br>        logical_gpus = tf.config.experimental.list_logical_devices(<span class="hljs-string">&#x27;GPU&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(gpus), <span class="hljs-string">&quot;Physical GPUs,&quot;</span>, <span class="hljs-built_in">len</span>(logical_gpus), <span class="hljs-string">&quot;Logical GPUs&quot;</span>)<br>    <span class="hljs-keyword">except</span> RuntimeError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-comment"># Memory growth must be set before GPUs have been initialized</span><br>        <span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><p>Successfully downloaded the file data&#x2F;text8.zip</p><h3 id="下載並讀取資料集"><a href="#下載並讀取資料集" class="headerlink" title="下載並讀取資料集"></a>下載並讀取資料集</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> urllib<br><br><span class="hljs-comment"># Download the data.</span><br>DOWNLOAD_URL = <span class="hljs-string">&#x27;http://mattmahoney.net/dc/&#x27;</span><br>DATA_FOLDER = <span class="hljs-string">&quot;data&quot;</span><br>FILE_NAME = <span class="hljs-string">&quot;text8.zip&quot;</span><br>EXPECTED_BYTES = <span class="hljs-number">31344016</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_dir</span>(<span class="hljs-params">path</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Create a directory if there isn&#x27;t one already. &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        os.mkdir(path)<br>    <span class="hljs-keyword">except</span> OSError:<br>        <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params">file_name, expected_bytes</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Download the dataset text8 if it&#x27;s not already downloaded &quot;&quot;&quot;</span><br>    local_file_path = os.path.join(DATA_FOLDER, file_name)<br>    <span class="hljs-keyword">if</span> os.path.exists(local_file_path):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Dataset ready&quot;</span>)<br>        <span class="hljs-keyword">return</span> local_file_path<br>    file_name, _ = urllib.request.urlretrieve(os.path.join(DOWNLOAD_URL, file_name), local_file_path)<br>    file_stat = os.stat(local_file_path)<br>    <span class="hljs-keyword">if</span> file_stat.st_size == expected_bytes:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Successfully downloaded the file&#x27;</span>, file_name)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<br>              <span class="hljs-string">&#x27;File &#x27;</span> + file_name +<br>              <span class="hljs-string">&#x27; might be corrupted. You should try downloading it with a browser.&#x27;</span>)<br>    <span class="hljs-keyword">return</span> local_file_path<br><br>make_dir(DATA_FOLDER)<br>file_path = download(FILE_NAME, EXPECTED_BYTES)<br><br><span class="hljs-keyword">import</span> zipfile<br><br><span class="hljs-comment"># Read the data into a list of strings.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_data</span>(<span class="hljs-params">file_path</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Read data into a list of tokens &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(file_path) <span class="hljs-keyword">as</span> f:<br>        <span class="hljs-comment"># tf.compat.as_str() converts the input into string</span><br>        data = tf.compat.as_str(f.read(f.namelist()[<span class="hljs-number">0</span>])).split()<br>    <span class="hljs-keyword">return</span> data<br><br>vocabulary = read_data(file_path)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Data size&#x27;</span>, <span class="hljs-built_in">len</span>(vocabulary))<br>vocabulary[:<span class="hljs-number">5</span>]<br></code></pre></td></tr></table></figure><p>Data size 17005207<br>[‘anarchism’, ‘originated’, ‘as’, ‘a’, ‘term’]</p><h3 id="建立字典"><a href="#建立字典" class="headerlink" title="建立字典"></a>建立字典</h3><ul><li>常見詞彙會被編號為較小的 ID</li><li>不常見的詞彙會被標記為 <code>UNK</code>，並被編號為 0</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> collections<br><span class="hljs-comment"># Build the dictionary and replace rare words with UNK token.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_dataset</span>(<span class="hljs-params">words, n_words</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Create two dictionaries and count of occuring words</span><br><span class="hljs-string">        - word_to_id: map of words to their codes</span><br><span class="hljs-string">        - id_to_word: maps codes to words (inverse word_to_id)</span><br><span class="hljs-string">        - count: map of words to count of occurrences</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># map unknown words to -1</span><br>    count = [[<span class="hljs-string">&#x27;UNK&#x27;</span>, -<span class="hljs-number">1</span>]]<br>    <span class="hljs-comment"># count of occurences for words in vocabulary</span><br>    count.extend(collections.Counter(words).most_common(n_words - <span class="hljs-number">1</span>))<br>    word_to_id = <span class="hljs-built_in">dict</span>() <span class="hljs-comment"># (word, id)</span><br>    <span class="hljs-comment"># record word id</span><br>    <span class="hljs-keyword">for</span> word, _ <span class="hljs-keyword">in</span> count:<br>        word_to_id[word] = <span class="hljs-built_in">len</span>(word_to_id)<br>    id_to_word = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(word_to_id.values(), word_to_id.keys())) <span class="hljs-comment"># (id, word)</span><br>    <span class="hljs-keyword">return</span> word_to_id, id_to_word, count<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_words_to_id</span>(<span class="hljs-params">words, dictionary, count</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Replace each word in the dataset with its index in the dictionary &quot;&quot;&quot;</span><br>    data_w2id = []<br>    unk_count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> words:<br>        <span class="hljs-comment"># return 0 if word is not in dictionary</span><br>        index = dictionary.get(word, <span class="hljs-number">0</span>) <span class="hljs-comment"># 找不到就回傳 0 (UNK)</span><br>        <span class="hljs-keyword">if</span> index == <span class="hljs-number">0</span>:<br>            unk_count += <span class="hljs-number">1</span><br>        data_w2id.append(index)<br>    count[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] = unk_count<br>    <span class="hljs-keyword">return</span> data_w2id, count<br>    ```<br><br><span class="hljs-string">&quot;&quot;&quot;Filling 4 global variables:</span><br><span class="hljs-string"># data_w2id - list of codes (integers from 0 to vocabulary_size-1).</span><br><span class="hljs-string">              This is the original text but words are replaced by their codes</span><br><span class="hljs-string"># count - map of words(strings) to count of occurrences</span><br><span class="hljs-string"># word_to_id - map of words(strings) to their codes(integers)</span><br><span class="hljs-string"># id_to_word - maps codes(integers) to words(strings)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>vocabulary_size = <span class="hljs-number">50000</span><br>word_to_id, id_to_word, count = build_dataset(vocabulary, vocabulary_size)<br>data_w2id, count = convert_words_to_id(vocabulary, word_to_id, count)<br><span class="hljs-keyword">del</span> vocabulary  <span class="hljs-comment"># reduce memory.</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Most common words (+UNK)&#x27;</span>, count[:<span class="hljs-number">5</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Sample data: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(data_w2id[:<span class="hljs-number">10</span>]))<br><span class="hljs-built_in">print</span>([id_to_word[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data_w2id[:<span class="hljs-number">10</span>]])<br></code></pre></td></tr></table></figure><p>Most common words (+UNK) [[‘UNK’, 418391], (‘the’, 1061396), (‘of’, 593677), (‘and’, 416629), (‘one’, 411764)]<br>Sample data: [5234, 3081, 12, 6, 195, 2, 3134, 46, 59, 156]<br>[‘anarchism’, ‘originated’, ‘as’, ‘a’, ‘term’, ‘of’, ‘abuse’, ‘first’, ‘used’, ‘against’]</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># utility function</span><br><span class="hljs-comment"># 給一串文字（已轉成 ID）和一個「視窗大小」，輸出許多 (中心詞, 上下文詞) 的配對。</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sample</span>(<span class="hljs-params">center_words, context_window_size</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Form training pairs according to the skip-gram model. &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> idx, center <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(center_words):<br>        context = random.randint(<span class="hljs-number">1</span>, context_window_size)<br>        <span class="hljs-comment"># get a random target before the center word</span><br>        <span class="hljs-comment"># 取出中心詞左邊最多 context 個字</span><br>        <span class="hljs-keyword">for</span> target <span class="hljs-keyword">in</span> center_words[<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, idx - context) : idx]:<br>            <span class="hljs-keyword">yield</span> center, target<br>        <span class="hljs-comment"># get a random target after the center word</span><br>        <span class="hljs-comment"># 取出中心詞右邊最多 context 個字</span><br>        <span class="hljs-keyword">for</span> target <span class="hljs-keyword">in</span> center_words[idx + <span class="hljs-number">1</span> : idx + context + <span class="hljs-number">1</span>]:<br>            <span class="hljs-keyword">yield</span> center, target<br><br><span class="hljs-comment"># 把上面那個樣本產生器包成「批次」(batch)，每次吐出兩個 NumPy 陣列：center_batch 和 target_batch。</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_generator</span>(<span class="hljs-params">data, skip_window, batch_size</span>):<br>    <span class="hljs-string">&quot;&quot;&quot; Group a numeric stream into batches and yield them as Numpy arrays. &quot;&quot;&quot;</span><br>    single_gen = generate_sample(data, skip_window)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        center_batch = np.zeros(batch_size, dtype=np.int32)<br>        target_batch = np.zeros([batch_size, <span class="hljs-number">1</span>], dtype=np.int32)<br>        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size):<br>            center_batch[idx], target_batch[idx] = <span class="hljs-built_in">next</span>(single_gen)<br>        <span class="hljs-keyword">yield</span> center_batch, target_batch<br></code></pre></td></tr></table></figure><h3 id="設定訓練參數，建立模型"><a href="#設定訓練參數，建立模型" class="headerlink" title="設定訓練參數，建立模型"></a>設定訓練參數，建立模型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## some training settings</span><br>training_steps = <span class="hljs-number">80000</span><br>skip_step = <span class="hljs-number">2000</span><br><br><span class="hljs-comment">## some hyperparameters</span><br>batch_size = <span class="hljs-number">512</span><br>embed_size = <span class="hljs-number">512</span><br>num_sampled = <span class="hljs-number">256</span><br>learning_rate = <span class="hljs-number">1.0</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># from tensorflow.keras.layers import Layer</span><br><span class="hljs-comment"># 所有 TensorFlow 自訂層都要繼承它，並覆寫兩個方法：</span><br><span class="hljs-comment"># __init__(): 定義要訓練的權重</span><br><span class="hljs-comment"># call(): 前向傳播的計算邏輯</span><br><span class="hljs-keyword">from</span> tensorflow.python.keras.layers <span class="hljs-keyword">import</span> Layer<br><br><span class="hljs-comment"># embedding matrix - hidden layer</span><br><span class="hljs-comment"># 這一層用來把「字的 ID」轉成對應的向量 (embedding)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">embedding_lookup</span>(<span class="hljs-title class_ inherited__">Layer</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(embedding_lookup, self).__init__()<br>        <span class="hljs-comment"># 設定初始值的方法（Glorot/Xavier 初始化），讓權重不會太大或太小</span><br>        embedding_init = tf.keras.initializers.GlorotUniform()<br>        <span class="hljs-comment"># 建立一個可訓練矩陣</span><br>        self.embedding_matrix = self.add_weight(name=<span class="hljs-string">&quot;embedding_matrix&quot;</span>,<br>                                                trainable=<span class="hljs-literal">True</span>,<br>                                                shape=[vocabulary_size, embed_size],<br>                                                initializer=embedding_init)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">self, inputs</span>):<br>        center_words = inputs<br>        <span class="hljs-comment"># tf.nn.embedding_lookup(matrix, ids) 會幫你做查表，從 embedding_matrix 取出指定 ID 的那幾行。</span><br>        embedding = tf.nn.embedding_lookup(self.embedding_matrix,<br>                                           center_words,<br>                                           name=<span class="hljs-string">&#x27;embedding&#x27;</span>)<br>        <span class="hljs-keyword">return</span> embedding<br><br><span class="hljs-comment"># context matrix - prediction layer</span><br><span class="hljs-comment"># 用來學習「正樣本」比「隨機噪聲詞」更相關</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">nce_loss</span>(<span class="hljs-title class_ inherited__">Layer</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(nce_loss, self).__init__()<br>        <span class="hljs-comment"># 截斷正態分佈，每個權重初始值會介於一個小範圍內</span><br>        nce_w_init = tf.keras.initializers.TruncatedNormal(stddev=<span class="hljs-number">1.0</span>/(embed_size ** <span class="hljs-number">0.5</span>))<br>        self.nce_weight = self.add_weight(name=<span class="hljs-string">&#x27;nce_weight&#x27;</span>,<br>                                          trainable=<span class="hljs-literal">True</span>,<br>                                          shape=[vocabulary_size, embed_size],<br>                                          initializer=nce_w_init)<br><br>        self.nce_bias = self.add_weight(name=<span class="hljs-string">&#x27;nce_bias&#x27;</span>,<br>                                        trainable=<span class="hljs-literal">True</span>,<br>                                        shape=[vocabulary_size],<br>                                        initializer=tf.keras.initializers.Zeros)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">self, inputs</span>):<br>        <span class="hljs-comment"># （中心詞向量, 目標詞 ID）</span><br>        embedding, target_words = inputs[<span class="hljs-number">0</span>], inputs[<span class="hljs-number">1</span>]<br>        loss = tf.reduce_mean(tf.nn.nce_loss(weights=self.nce_weight,<br>                                             biases=self.nce_bias,<br>                                             labels=target_words,<br>                                             inputs=embedding,<br>                                             num_sampled=num_sampled,<br>                                             num_classes=vocabulary_size),<br>                                             name=<span class="hljs-string">&#x27;loss&#x27;</span>)<br>        <span class="hljs-keyword">return</span> loss<br></code></pre></td></tr></table></figure><h3 id="建立整個-Word2Vec-模型"><a href="#建立整個-Word2Vec-模型" class="headerlink" title="建立整個 Word2Vec 模型"></a>建立整個 Word2Vec 模型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># from tensorflow.keras import Model, Input</span><br><span class="hljs-keyword">from</span> tensorflow.python.keras <span class="hljs-keyword">import</span> Model, Input<br><br>center_words = Input(shape=(), name=<span class="hljs-string">&#x27;center_words&#x27;</span>, dtype=<span class="hljs-string">&#x27;int32&#x27;</span>)<br>target_words = Input(shape=(<span class="hljs-number">1</span>), name=<span class="hljs-string">&#x27;target_words&#x27;</span>, dtype=<span class="hljs-string">&#x27;int32&#x27;</span>)<br><br>embedding = embedding_lookup()(center_words)<br>loss = nce_loss()((embedding, target_words))<br><br>word2vec = Model(name=<span class="hljs-string">&#x27;word2vec&#x27;</span>,<br>                 inputs=[center_words, target_words],<br>                 outputs=[loss])<br><br>word2vec.summary()<br></code></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown">Model: &quot;word2vec&quot;<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>__<br><span class="hljs-section">Layer (type)                    Output Shape         Param #     Connected to</span><br><span class="hljs-section">==================================================================================================</span><br>center<span class="hljs-emphasis">_words (InputLayer)       [(None,)]            0</span><br><span class="hljs-emphasis"><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_</span>_<br>embedding<span class="hljs-emphasis">_lookup (embedding_</span>loo (None, 512)          25600000    center<span class="hljs-emphasis">_words[<span class="hljs-string">0</span>][<span class="hljs-symbol">0</span>]</span><br><span class="hljs-emphasis"><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_</span>_<br>target<span class="hljs-emphasis">_words (InputLayer)       [(None, 1)]          0</span><br><span class="hljs-emphasis"><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span>_</span>_<br>nce<span class="hljs-emphasis">_loss (nce_</span>loss)             ()                   25650000    embedding<span class="hljs-emphasis">_lookup[<span class="hljs-string">0</span>][<span class="hljs-symbol">0</span>]</span><br><span class="hljs-emphasis">                                                                 target_</span>words[<span class="hljs-string">0</span>][<span class="hljs-symbol">0</span>]<br>==================================================================================================<br>Total params: 51,250,000<br>Trainable params: 51,250,000<br>Non-trainable params: 0<br><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">____</span><span class="hljs-strong">__</span><br></code></pre></td></tr></table></figure><h3 id="生成資料集-中心詞-上下文詞-batch"><a href="#生成資料集-中心詞-上下文詞-batch" class="headerlink" title="生成資料集 (中心詞, 上下文詞) batch"></a>生成資料集 (中心詞, 上下文詞) batch</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## generator for `tf.data.Dataset`</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>():<br>    <span class="hljs-string">&quot;&quot;&quot; Return a python generator that generates batches. &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> batch_generator(data_w2id, <span class="hljs-number">2</span>, batch_size)<br><br><br><br>dataset = tf.data.Dataset.from_generator(<br>  gen,                                 <span class="hljs-comment"># 資料來源：Python generator</span><br>  (tf.int32, tf.int32),                <span class="hljs-comment"># 每次 yield 的兩個輸出類型</span><br>  (tf.TensorShape([batch_size]),       <span class="hljs-comment"># 第 1 個輸出形狀</span><br>    tf.TensorShape([batch_size, <span class="hljs-number">1</span>])),  <span class="hljs-comment"># 第 2 個輸出形狀</span><br>).repeat()<br></code></pre></td></tr></table></figure><h3 id="定義優化器和訓練指標"><a href="#定義優化器和訓練指標" class="headerlink" title="定義優化器和訓練指標"></a>定義優化器和訓練指標</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">train_loss = tf.keras.metrics.Mean(name=<span class="hljs-string">&#x27;train_loss&#x27;</span>)<br>optimizer = tf.keras.optimizers.SGD(learning_rate=learning_rate, momentum=<span class="hljs-number">0.1</span>,nesterov=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><h3 id="訓練模型"><a href="#訓練模型" class="headerlink" title="訓練模型"></a>訓練模型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@tf.function</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_step</span>(<span class="hljs-params">center_words, target_words</span>):<br>    <span class="hljs-comment"># tf.GradientTape() 是 TensorFlow 的「自動微分引擎 (autodiff engine)」。</span><br>    <span class="hljs-comment"># 所有在這個 with 區塊裡發生的計算，</span><br>    <span class="hljs-comment"># 都會被記錄在 tape 物件裡。</span><br>    <span class="hljs-keyword">with</span> tf.GradientTape() <span class="hljs-keyword">as</span> tape:<br>        <span class="hljs-comment"># forward pass</span><br>        loss = word2vec([center_words, target_words])<br><br>    <span class="hljs-comment"># backward pass</span><br>    gradients = tape.gradient(loss, word2vec.trainable_variables)<br>    <span class="hljs-comment"># update weights</span><br>    optimizer.apply_gradients(<span class="hljs-built_in">zip</span>(gradients, word2vec.trainable_variables))<br>    <span class="hljs-comment"># 印出平均 loss</span><br>    train_loss(loss)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">x = []<br>y = []<br><span class="hljs-keyword">for</span> step, (center_words, target_words) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(dataset):<br>    <span class="hljs-keyword">if</span> step == training_steps:<br>        <span class="hljs-keyword">break</span><br>    train_step(center_words, target_words)<br><br>    <span class="hljs-keyword">if</span> ((step+<span class="hljs-number">1</span>) % skip_step) == <span class="hljs-number">0</span>:<br>        template = <span class="hljs-string">&#x27;Step &#123;:0&#125;, Loss: &#123;:.2f&#125;&#x27;</span><br>        x.append(step+<span class="hljs-number">1</span>)<br>        y.append(train_loss.result())<br>        <span class="hljs-built_in">print</span>(template.<span class="hljs-built_in">format</span>(step+<span class="hljs-number">1</span>, train_loss.result()))<br>        train_loss.reset_state()<br></code></pre></td></tr></table></figure><p>Step 2000, Loss: 97.47<br>Step 4000, Loss: 20.06<br>Step 6000, Loss: 13.44<br>Step 8000, Loss: 10.15<br>Step 10000, Loss: 9.45<br>Step 12000, Loss: 8.64<br>Step 14000, Loss: 8.10<br>Step 16000, Loss: 7.40<br>Step 18000, Loss: 7.18<br>Step 20000, Loss: 6.91<br>Step 22000, Loss: 6.88<br>Step 24000, Loss: 6.70<br>Step 26000, Loss: 6.56<br>Step 28000, Loss: 6.40<br>Step 30000, Loss: 6.42<br>Step 32000, Loss: 6.38<br>Step 34000, Loss: 6.27<br>Step 36000, Loss: 6.26<br>Step 38000, Loss: 6.15<br>Step 40000, Loss: 6.13<br>Step 42000, Loss: 6.10<br>Step 44000, Loss: 5.95<br>Step 46000, Loss: 5.94<br>Step 48000, Loss: 5.96<br>Step 50000, Loss: 5.90<br>…<br>Step 74000, Loss: 5.77<br>Step 76000, Loss: 5.45<br>Step 78000, Loss: 5.59<br>Step 80000, Loss: 5.71</p><h2 id="Lab-11-CNN"><a href="#Lab-11-CNN" class="headerlink" title="Lab 11: CNN"></a>Lab 11: CNN</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment"># construct a new dataset with time informantion</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeMeasuredDataset</span>(tf.data.Dataset):<br>    <span class="hljs-comment"># OUTPUT: (steps, timings, counters, img, label)</span><br>    <span class="hljs-comment"># 這個 Dataset 每次「產出」的資料結構長什麼樣子 (輸出規格)</span><br>    OUTPUT_SIGNATURE=(<br>        tf.TensorSpec(shape=(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>), dtype=tf.string), <span class="hljs-comment"># steps: [(&quot;Open&quot;,), (&quot;Read&quot;,)]</span><br><br>        <span class="hljs-comment"># open_enter -&gt; 開始開檔時的時間點</span><br>        <span class="hljs-comment"># open_elapsed -&gt; 開檔這個動作花了多久時間（開完後再扣回開始）</span><br>        <span class="hljs-comment"># read_enter -&gt; 開始讀檔時的時間點</span><br>        <span class="hljs-comment"># read_elapsed -&gt; 讀檔這個動作花了多久時間（讀完後再扣回開始）</span><br>        tf.TensorSpec(shape=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), dtype=tf.float32), <span class="hljs-comment"># timings: [(open_enter, open_elapsed), (read_enter, read_elapsed)]</span><br><br>        <span class="hljs-comment"># instance_idx -&gt; 第幾個 TimeMeasuredDataset 實例</span><br>        <span class="hljs-comment"># epoch_idx -&gt; 目前是第幾輪（每跑一次 dataset +1）</span><br>        <span class="hljs-comment"># 第三個數字（-1）-&gt; 特殊標記：這筆是 &quot;Open&quot; 階段，不屬於任何單一圖片</span><br>        <span class="hljs-comment"># example_idx -&gt; 這個 epoch 裡的第幾張 sample</span><br>        tf.TensorSpec(shape=(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), dtype=tf.int32), <span class="hljs-comment"># counters: [(instance_idx, epoch_idx, -1), (instance_idx, epoch_idx, example_idx)]</span><br>        tf.TensorSpec(shape=(<span class="hljs-number">3072</span>), dtype=tf.float32), <span class="hljs-comment"># img: 32*32*3</span><br>        tf.TensorSpec(shape=(), dtype=tf.int32) <span class="hljs-comment"># label</span><br>    )<br><br>    <span class="hljs-comment"># example</span><br>    <span class="hljs-comment"># 對 image0：</span><br>    <span class="hljs-comment"># [</span><br>    <span class="hljs-comment"># (&quot;Open&quot;,),  (&quot;Read&quot;,),</span><br>    <span class="hljs-comment"># [(12.0, 0.002), (12.002, 0.001)],       # 時間資訊</span><br>    <span class="hljs-comment"># [(0, 2, -1),    (0, 2, 0)],             # 計數器資訊</span><br>    <span class="hljs-comment"># imgs[0], labels[0]</span><br>    <span class="hljs-comment"># ]</span><br><br>    <span class="hljs-comment"># # 對 image1：</span><br>    <span class="hljs-comment"># [</span><br>    <span class="hljs-comment"># (&quot;Open&quot;,),  (&quot;Read&quot;,),</span><br>    <span class="hljs-comment"># [(-1., -1.), (12.003, 0.0011)],         # Open 已設為 -1 表示跳過</span><br>    <span class="hljs-comment"># [(0, 2, -1), (0, 2, 1)],                # 第 1 張圖片</span><br>    <span class="hljs-comment"># imgs[1], labels[1]</span><br>    <span class="hljs-comment"># ]</span><br><br>    <span class="hljs-comment"># 第幾個 dataset 實例的編號</span><br>    _INSTANCES_COUNTER = itertools.count()<br><br>    <span class="hljs-comment"># 為每個資料集（用 instance_idx 區分）維護一個「epoch 次數計數器」，每次跑新的 epoch 時會自動 +1。</span><br>    _EPOCHS_COUNTER = defaultdict(itertools.count)<br><br>    <span class="hljs-comment"># 一張一張圖片逐個 yield 出來</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_generator</span>(<span class="hljs-params">instance_idx, filename, open_file, read_file</span>):<br>        epoch_idx = <span class="hljs-built_in">next</span>(TimeMeasuredDataset._EPOCHS_COUNTER[instance_idx])<br><br>        <span class="hljs-comment"># Opening the file</span><br>        open_enter = time.perf_counter()<br>        filenames = open_file(filename)<br>        open_elapsed = time.perf_counter() - open_enter<br>        <span class="hljs-comment"># ----------------</span><br><br>        <span class="hljs-comment"># Reading the file</span><br>        read_enter = time.perf_counter()<br>        imgs, label = [], []<br>        <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> filenames:<br>            tmp_imgs, tmp_label = read_file(filename)<br>            imgs.append(tmp_imgs)<br>            label.append(tmp_label)<br>        imgs = tf.concat(imgs, axis=<span class="hljs-number">0</span>)<br>        label = tf.concat(label, axis=<span class="hljs-number">0</span>)<br>        read_elapsed = (time.perf_counter() - read_enter) / imgs.shape[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">for</span> sample_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(imgs.shape[<span class="hljs-number">0</span>]):<br>            read_enter = read_enter <span class="hljs-keyword">if</span> sample_idx == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> time.perf_counter()<br><br>            <span class="hljs-keyword">yield</span> (<br>                [(<span class="hljs-string">&quot;Open&quot;</span>,), (<span class="hljs-string">&quot;Read&quot;</span>,)],<br>                [(open_enter, open_elapsed), (read_enter, read_elapsed)],<br>                [(instance_idx, epoch_idx, -<span class="hljs-number">1</span>), (instance_idx, epoch_idx, sample_idx)],<br>                imgs[sample_idx],<br>                label[sample_idx]<br>            )<br>            open_enter, open_elapsed = -<span class="hljs-number">1.</span>, -<span class="hljs-number">1.</span>  <span class="hljs-comment"># Negative values will be filtered</span><br><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, filename, open_file, read_file</span>):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">generator_func</span>(<span class="hljs-params">instance_idx, filename</span>):<br>            <span class="hljs-keyword">return</span> cls._generator(instance_idx, filename, open_file, read_file)<br><br>        <span class="hljs-keyword">return</span> tf.data.Dataset.from_generator(<br>            generator_func,<br>            output_signature=cls.OUTPUT_SIGNATURE,<br>            args=(<span class="hljs-built_in">next</span>(cls._INSTANCES_COUNTER), filename)<br>        )<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 讀一個 CSV 檔，裡面有多個小檔案名稱</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">open_file</span>(<span class="hljs-params">filename</span>):<br>    rows = pd.read_csv(filename.decode(<span class="hljs-string">&quot;utf-8&quot;</span>))<br>    filenames = rows[<span class="hljs-string">&#x27;filenames&#x27;</span>]<br>    <span class="hljs-keyword">return</span> filenames<br><br><span class="hljs-comment"># 讀一個 CIFAR-10 檔案</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_file</span>(<span class="hljs-params">filename</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> fo:<br>        raw_data = pickle.load(fo, encoding=<span class="hljs-string">&#x27;bytes&#x27;</span>)<br>    <span class="hljs-keyword">return</span> raw_data[<span class="hljs-string">b&#x27;data&#x27;</span>], raw_data[<span class="hljs-string">b&#x27;labels&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dataset_generator_fun_train</span>(<span class="hljs-params">*args</span>):<br>    <span class="hljs-keyword">return</span> TimeMeasuredDataset(<span class="hljs-string">&#x27;cifar10_train.csv&#x27;</span>, open_file, read_file)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dataset_generator_fun_test</span>(<span class="hljs-params">*args</span>):<br>    <span class="hljs-keyword">return</span> TimeMeasuredDataset(<span class="hljs-string">&#x27;cifar10_test.csv&#x27;</span>, open_file, read_file)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tf.data.Dataset.<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>).flat_map(dataset_generator_fun_train).take(<span class="hljs-number">2</span>):<br>    <span class="hljs-built_in">print</span>(i)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;now time&quot;</span>, time.perf_counter())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;-------------------------------------------------------------------------------&quot;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python">IMAGE_SIZE_CROPPED = <span class="hljs-number">24</span><br>IMAGE_HEIGHT = <span class="hljs-number">32</span><br>IMAGE_WIDTH = <span class="hljs-number">32</span><br>IMAGE_DEPTH = <span class="hljs-number">3</span><br><span class="hljs-comment"># 原圖是 32×32×3，經過裁切後會變成 24×24×3。</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">map_decorator</span>(<span class="hljs-params">func</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">steps, times, values, image, label</span>):<br>        <span class="hljs-comment"># Use a tf.py_function to prevent auto-graph from compiling the method</span><br>        <span class="hljs-keyword">return</span> tf.py_function(<br>            func,<br>            inp=(steps, times, values, image, label),<br>            Tout=(steps.dtype, times.dtype, values.dtype, image.dtype, tf.float32)<br>        )<br>    <span class="hljs-keyword">return</span> wrapper<br><br><span class="hljs-meta">@map_decorator</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">map_fun_with_time</span>(<span class="hljs-params">steps, times, values, image, label</span>):<br>    <span class="hljs-comment"># sleep to avoid concurrency issue</span><br>    time.sleep(<span class="hljs-number">0.05</span>)<br><br>    <span class="hljs-comment"># record the enter time into map_fun()</span><br>    map_enter = time.perf_counter()<br><br>    <span class="hljs-comment"># CIFAR-10 的資料原本是 [3072] = [3, 32, 32] 排列的。</span><br>    <span class="hljs-comment"># 所以要先 reshape 成 (3,32,32)，</span><br>    <span class="hljs-comment"># 再轉置成 (32,32,3) 才是標準 RGB 格式，</span><br>    <span class="hljs-comment"># 然後轉成浮點數並除以 255 → 範圍變成 [0,1]</span><br>    image = tf.reshape(image,[IMAGE_DEPTH, IMAGE_HEIGHT, IMAGE_WIDTH])<br>    image = tf.divide(tf.cast(tf.transpose(image,[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>]),tf.float32),<span class="hljs-number">255.0</span>)<br><br>    label = tf.one_hot(label, <span class="hljs-number">10</span>)<br><br>    <span class="hljs-comment"># 隨機裁切成 24×24×3</span><br>    <span class="hljs-comment"># 隨機左右翻轉</span><br>    <span class="hljs-comment"># 隨機改亮度與對比度</span><br>    <span class="hljs-comment"># 標準化成零均值單位方差</span><br>    distorted_image = tf.image.random_crop(image, [IMAGE_SIZE_CROPPED,IMAGE_SIZE_CROPPED,IMAGE_DEPTH])<br>    <span class="hljs-comment"># distorted_image = tf.image.resize(image, [IMAGE_SIZE_CROPPED,IMAGE_SIZE_CROPPED])</span><br>    distorted_image = tf.image.random_flip_left_right(distorted_image)<br>    distorted_image = tf.image.random_brightness(distorted_image, max_delta=<span class="hljs-number">63</span>)<br>    distorted_image = tf.image.random_contrast(distorted_image, lower=<span class="hljs-number">0.2</span>, upper=<span class="hljs-number">1.8</span>)<br>    distorted_image = tf.image.per_image_standardization(distorted_image)<br><br>    map_elapsed = time.perf_counter() - map_enter<br>    <span class="hljs-comment"># ----------------</span><br><br>    <span class="hljs-keyword">return</span> tf.concat((steps, [[<span class="hljs-string">&quot;Map&quot;</span>]]), axis=<span class="hljs-number">0</span>),\<br>           tf.concat((times, [[map_enter, map_elapsed]]), axis=<span class="hljs-number">0</span>),\<br>           tf.concat((values, [values[-<span class="hljs-number">1</span>]]), axis=<span class="hljs-number">0</span>),\<br>           distorted_image,\<br>           label<br><br><span class="hljs-comment"># 類似，但不用 augmentation</span><br><span class="hljs-meta">@map_decorator</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">map_fun_test_with_time</span>(<span class="hljs-params">steps, times, values, image, label</span>):<br>    <span class="hljs-comment"># sleep to avoid concurrency issue</span><br>    time.sleep(<span class="hljs-number">0.05</span>)<br><br>    <span class="hljs-comment"># record the enter time into map_fun_test()</span><br>    map_enter = time.perf_counter()<br><br>    image = tf.reshape(image,[IMAGE_DEPTH,IMAGE_HEIGHT,IMAGE_WIDTH])<br>    image = tf.divide(tf.cast(tf.transpose(image,[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>]),tf.float32),<span class="hljs-number">255.0</span>)<br>    label = tf.one_hot(label,<span class="hljs-number">10</span>)<br>    distorted_image = tf.image.resize(image, [IMAGE_SIZE_CROPPED,IMAGE_SIZE_CROPPED])<br>    distorted_image = tf.image.per_image_standardization(distorted_image)<br><br>    map_elapsed = time.perf_counter() - map_enter<br>    <span class="hljs-comment"># ----------------</span><br><br>    <span class="hljs-keyword">return</span> tf.concat((steps, [[<span class="hljs-string">&quot;Map&quot;</span>]]), axis=<span class="hljs-number">0</span>),\<br>           tf.concat((times, [[map_enter, map_elapsed]]), axis=<span class="hljs-number">0</span>),\<br>           tf.concat((values, [values[-<span class="hljs-number">1</span>]]), axis=<span class="hljs-number">0</span>),\<br>           distorted_image,\<br>           label<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>deep learning</tag>
      
      <tag>ai</tag>
      
      <tag>machine learning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TOEIC</title>
    <link href="/notes/2025/09/29/toeic/"/>
    <url>/notes/2025/09/29/toeic/</url>
    
    <content type="html"><![CDATA[<h2 id="Corporate-Development"><a href="#Corporate-Development" class="headerlink" title="Corporate Development"></a>Corporate Development</h2><h3 id="innovation"><a href="#innovation" class="headerlink" title="innovation"></a>innovation</h3><ul><li>The company encourages innovation to stay ahead of its competitors.<ul><li>encourage innovation</li><li>drive innovation</li><li>foster innovation</li></ul></li></ul><h3 id="strategy"><a href="#strategy" class="headerlink" title="strategy"></a>strategy</h3><ul><li>Our marketing strategy focuses on attracting young professionals.<ul><li>marketing strategy</li><li>business strategy</li><li>develop a strategy</li></ul></li></ul><h3 id="partnership"><a href="#partnership" class="headerlink" title="partnership"></a>partnership</h3><ul><li>The two firms formed a partnership to expand into the Asian market.<ul><li>form a partnership</li><li>strategic partnership</li><li>long-term partnership</li></ul></li></ul><h3 id="investment"><a href="#investment" class="headerlink" title="investment"></a>investment</h3><ul><li>The CEO announced a major investment in renewable energy.<ul><li>make an investment</li><li>attract investment</li><li>investment opportunity</li></ul></li></ul><h3 id="diversification"><a href="#diversification" class="headerlink" title="diversification"></a>diversification</h3><ul><li>Product diversification helps reduce business risk.<ul><li>product diversification</li><li>business diversification</li><li><strong>diversify the portfolio</strong></li></ul></li></ul><h3 id="sustainability"><a href="#sustainability" class="headerlink" title="sustainability"></a>sustainability</h3><ul><li>The company promotes sustainability by using eco-friendly packaging.<ul><li>promote sustainability</li><li>environmental sustainability</li><li>sustainable development</li></ul></li></ul><h3 id="entrepreneurship"><a href="#entrepreneurship" class="headerlink" title="entrepreneurship"></a>entrepreneurship</h3><ul><li>Entrepreneurship is essential for driving economic growth.<ul><li>promote entrepreneurship</li><li>entrepreneurship program</li><li>spirit of entrepreneurship</li></ul></li></ul><h3 id="benchmarking"><a href="#benchmarking" class="headerlink" title="benchmarking"></a>benchmarking</h3><ul><li>The team conducted benchmarking to compare their services with industry leaders.<ul><li>conduct benchmarking</li><li>benchmarking study</li><li>benchmarking process</li></ul></li></ul><h3 id="capital"><a href="#capital" class="headerlink" title="capital"></a>capital</h3><ul><li>The startup raised enough capital to launch its first product.<ul><li>raise capital</li><li>venture capital</li><li>capital investment</li></ul></li></ul><h3 id="competitiveness"><a href="#competitiveness" class="headerlink" title="competitiveness"></a>competitiveness</h3><ul><li>Employee training programs improve the company’s competitiveness.<ul><li>global competitiveness</li><li>enhance competitiveness</li><li>maintain competitiveness</li></ul></li></ul><h3 id="consolidation"><a href="#consolidation" class="headerlink" title="consolidation"></a>consolidation</h3><ul><li>Market consolidation has reduced the number of small players in the industry.<ul><li>market consolidation</li><li>industry consolidation,</li><li>consolidate resources</li></ul></li></ul><h3 id="corporate-culture"><a href="#corporate-culture" class="headerlink" title="corporate culture"></a>corporate culture</h3><ul><li>A positive corporate culture attracts and retains top talent.<ul><li>strong corporate culture</li><li>build corporate culture</li><li>corporate values</li></ul></li></ul><h3 id="growth"><a href="#growth" class="headerlink" title="growth"></a>growth</h3><ul><li>The company reported steady sales growth over the past year.<ul><li>sales growth</li><li>economic growth</li><li>achieve growth</li></ul></li></ul><h3 id="joint-venture"><a href="#joint-venture" class="headerlink" title="joint venture"></a>joint venture</h3><ul><li>The two companies established a joint venture to develop new technology.<ul><li>form a joint venture</li><li>joint venture agreement</li><li>joint venture partner</li></ul></li></ul><h3 id="market-share"><a href="#market-share" class="headerlink" title="market share"></a>market share</h3><ul><li>The brand increased its market share through aggressive advertising.<ul><li>gain market share</li><li>lose market share</li><li>dominate the market</li></ul></li></ul><h3 id="outsourcing"><a href="#outsourcing" class="headerlink" title="outsourcing"></a>outsourcing</h3><ul><li>Many firms use outsourcing to cut costs and focus on core activities.<ul><li>outsourcing services</li><li>outsourcing partner</li><li>outsource operations</li></ul></li></ul><h3 id="product-development"><a href="#product-development" class="headerlink" title="product development"></a>product development</h3><ul><li>The company invested heavily in product development to launch new models.<ul><li>product development team</li><li>product development cycle</li><li>new product development</li></ul></li></ul><h3 id="research-and-development"><a href="#research-and-development" class="headerlink" title="research and development"></a>research and development</h3><ul><li>The firm’s research and development team is working on an AI-based solution.<ul><li>R&amp;D department</li><li>invest in R&amp;D</li><li>research and development costs</li></ul></li></ul><h3 id="market-research"><a href="#market-research" class="headerlink" title="market research"></a>market research</h3><ul><li>Conducting market research helps identify customer needs.<ul><li>conduct market research</li><li>market research survey</li><li>market research report</li></ul></li></ul><h3 id="patent"><a href="#patent" class="headerlink" title="patent"></a>patent</h3><ul><li>The company applied for a patent to protect its new invention.<ul><li>apply for a patent</li><li>hold a patent</li><li>patent rights</li></ul></li></ul><h3 id="intellectual-property"><a href="#intellectual-property" class="headerlink" title="intellectual property"></a>intellectual property</h3><ul><li>Protecting intellectual property is crucial in the technology sector.<ul><li>intellectual property rights</li><li>protect intellectual property</li><li>intellectual property law</li></ul></li></ul><h3 id="validation"><a href="#validation" class="headerlink" title="validation"></a>validation</h3><ul><li>The new medical device is waiting for FDA validation.<ul><li>seek validation</li><li>validation process</li><li>validation test</li></ul></li></ul><h3 id="commercialization"><a href="#commercialization" class="headerlink" title="commercialization"></a>commercialization</h3><ul><li>The startup is preparing for the commercialization of its new app.<ul><li>product commercialization</li><li>commercialization strategy</li><li>commercialization process</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>toeic</category>
      
    </categories>
    
    
    <tags>
      
      <tag>toeic</tag>
      
      <tag>english</tag>
      
      <tag>test</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Natural Language Processing</title>
    <link href="/notes/2025/09/24/nlp/"/>
    <url>/notes/2025/09/24/nlp/</url>
    
    <content type="html"><![CDATA[<p>以前一定要從語言學去分析，才能處理比較好。<br>現在都用統計的方式做，雖然人看不懂，但效果更好。</p><h2 id="Information-Retrieval-IR-資訊檢索"><a href="#Information-Retrieval-IR-資訊檢索" class="headerlink" title="Information Retrieval (IR): 資訊檢索"></a>Information Retrieval (IR): 資訊檢索</h2><ul><li>Stemming: 詞幹還原</li><li>Lemmatization: 詞形還原</li><li>Stop Words: 常見但無意義的詞彙（如 “the”, “is”, “in”）</li><li>Term Frequency (TF): 詞彙在文件中出現的頻率<ul><li>$TF(t, d) &#x3D; \frac{f_{t,d}}{\sum_{t’ \in d} f_{t’,d}}$</li></ul></li><li>Inverse Document Frequency (IDF): 詞彙在整個語料庫中出現的稀有程度<ul><li>$IDF(t) &#x3D; \log(\frac{N}{DF(t)})$<ul><li>$N$: 文件總數</li><li>$DF(t)$: 包含詞彙 $t$ 的文件數</li></ul></li><li>同個 Feature 如果所有文本都有出現，代表他沒甚麼重要性，所以越稀有的詞彙，IDF 越高越重要</li></ul></li><li>Cosine Document Similarity: 衡量兩個向量之間的相似度<ul><li>$Cosine_Document_Similarity(A, B) &#x3D; \frac{A \cdot B}{||A|| \times ||B||}$</li></ul></li><li>BM25: 一種改進的 TF-IDF 權重計算方法，計算文件與查詢的相關性<ul><li>$BM25(t, d) &#x3D; IDF(t) \times \frac{f_{t,d} \times (k_1 + 1)}{f_{t,d} + k_1 \times (1 - b + b \times \frac{|d|}{avgdl})}$<ul><li>$k_1$ 和 $b$ 是調整參數</li><li>$|d|$: 文件長度</li><li>$avgdl$: 平均文件長度</li></ul></li></ul></li></ul><h2 id="Word-Representation-詞彙表示"><a href="#Word-Representation-詞彙表示" class="headerlink" title="Word Representation: 詞彙表示"></a>Word Representation: 詞彙表示</h2><ul><li>Bag of Words (BoW): 將文本表示為詞彙的無序集合，忽略語法和詞序</li><li>One-hot Encoding: 將詞彙表示為高維稀疏向量，只有對應詞彙的位置為 1，其餘為 0</li><li>Word Embeddings (dense space): 將詞彙映射到低維連續向量空間，捕捉詞彙之間的語義關係</li><li>Latent Semantic Analysis (LSA): 使用奇異值分解 (SVD) 將詞彙和文件映射到潛在語義空間</li><li>Continuous Bag of Words (CBOW): 預測中心詞彙，給定上下文詞彙</li><li>Skip-gram: 預測上下文詞彙，給定中心詞</li><li>part of speech (POS): 分析詞性</li><li>word sense ambiguity (WSA): 詞義歧異</li><li>N-grams: 連續 n 個字詞的組合<ul><li>unigram: 1 個字詞</li><li>bigram: 2 個字詞</li><li>trigram: 3 個字詞</li><li>越長越短都有各自的優缺點</li></ul></li><li>Linguistic Signature: 獨特且可辨識的語言模式</li><li>Perplexity (PPL): 衡量語言模型預測下一個字詞的困難程度<ul><li>$PPL(W) &#x3D; P(w_1, w_2, …, w_N)^{-1&#x2F;N}$</li><li>PPL 越低，表示模型越好</li><li>在 Fine-tuning 的時候，可以用來評估模型是不是保有原有的語言能力</li></ul></li><li>TF-IDF: 衡量詞彙在文件中的重要性<ul><li>$TF-IDF(t, d) &#x3D; TF(t, d) \times IDF(t)$</li></ul></li><li>PPMI (Positive Pointwise Mutual Information): 衡量詞彙與上下文之間的關聯強度<ul><li>$PMI(t, c) &#x3D; \log(\frac{P(t, c)}{P(t) \times P(c)})$</li><li>$PPMI(t, c) &#x3D; \max(PMI(t, c), 0)$<ul><li>$P(t, c)$: 詞彙 $t$ 和上下文 $c$ 同時出現的概率</li><li>$P(t)$: 詞彙 $t$ 出現的概率</li><li>$P(c)$: 上下文 $c$ 出現的概率</li></ul></li></ul></li><li>Word2Vec: 基於 nn 的詞嵌入方法，包括 CBOW 和 Skip-gram 兩種模型<ul><li>要定義 <code>Positive Sample</code> 和 <code>Negative Sample</code>，且兩者比例要適當</li></ul></li><li>Contextualized Embeddings: 根據上下文動態生成詞嵌入，想是 BERT、GPT<ul><li>同一個詞彙在不同上下文中會有不同的表示，像是 <code>bank</code> 在 <code>river bank</code> 和 <code>financial bank</code> 中會有不同的向量</li></ul></li><li>Name Entity Recognition (NER): 識別文本中的專有名詞，如人名、地名、組織名等</li></ul><h2 id="RNN"><a href="#RNN" class="headerlink" title="RNN"></a>RNN</h2><ul><li>RNNs for NER</li><li>RNNs for Sequence Classification</li><li>Stacked RNNs</li><li>Bidirectional RNNs<ul><li>結合前向和後向的 RNN，捕捉上下文資訊</li></ul></li><li>Bidirectional RNNs for Sequence Classification</li></ul><h2 id="Sequence-to-Sequence-Models"><a href="#Sequence-to-Sequence-Models" class="headerlink" title="Sequence to Sequence Models"></a>Sequence to Sequence Models</h2><ul><li><p>機器翻譯</p></li><li><p>文件摘要</p></li><li><p>對話生成</p></li><li><p>RNN for Sequence Generation</p></li><li><p>RNN for Machine Translation</p><ul><li>context vector</li><li>RNN 需要 End to End 的訓練，做摘要和做翻譯訓練出來的 Decoder 不一樣</li></ul></li></ul><h2 id="Long-Short-Term-Memory-LSTM"><a href="#Long-Short-Term-Memory-LSTM" class="headerlink" title="Long Short-Term Memory (LSTM)"></a>Long Short-Term Memory (LSTM)</h2><p>大量的訓練參數，為了捨棄不重要的資訊，只保留重要的資訊。能稍為解決 Vanishing&#x2F; Exploding Gradient 的問題，但還是會有。</p><p>最大的問題是依然不能平行化</p><ul><li>Forget Gate</li><li>Input Gate</li><li>Candidate MEmory</li><li>Output Gate</li></ul><h2 id="Attention-Mechanism"><a href="#Attention-Mechanism" class="headerlink" title="Attention Mechanism"></a>Attention Mechanism</h2><p>讓模型能夠專注於輸入序列的特定部分，而不是像傳統 RNN 那樣一次處理整個 Sequence。</p><h3 id="Attention-with-RNNs"><a href="#Attention-with-RNNs" class="headerlink" title="Attention with RNNs"></a>Attention with RNNs</h3><p>一開始是把 Attention 接上 RNN ，把每個時間點的 Hidden State 都拿來算 Attention。但是這樣還是有 RNN 的缺點，無法平行化。</p><h3 id="Attention-without-RNNs"><a href="#Attention-without-RNNs" class="headerlink" title="Attention without RNNs"></a>Attention without RNNs</h3><p>Transformer 就是完全用 Attention 機制來取代 RNN，讓模型能夠平行化處理序列資料。</p><h2 id="Sub-word-Tokenization"><a href="#Sub-word-Tokenization" class="headerlink" title="Sub-word Tokenization"></a>Sub-word Tokenization</h2><ul><li><img src="https://platform.openai.com/tokenizer" alt="OpenAI Tokenizer"></li></ul><h3 id="Common-Methods"><a href="#Common-Methods" class="headerlink" title="Common Methods"></a>Common Methods</h3><ul><li>Delimiter-based Segmentation: 以空格或標點符號作為分隔符來切詞<ul><li>像英文這種拼音型的語言可以用空格切詞，但像中文、日文就沒辦法。</li><li>對於翻譯任務來說，不一定是 1 to 1 的對應關係。</li></ul></li></ul><p>基於上述問題，後來發展出一些統計上的方法：</p><h4 id="Byte-Pair-Encoding-BPE"><a href="#Byte-Pair-Encoding-BPE" class="headerlink" title="Byte Pair Encoding (BPE)"></a>Byte Pair Encoding (BPE)</h4><p>基於頻率的子詞切分方法，將最常見的字元對合併成子詞單位</p><p>$$<br>\begin{aligned}<br>    \text{Final Vocabulary Size} &amp;&#x3D; \text{Initial Vocabulary Size} + \text{Number of Merges}<br>\end{aligned}<br>$$</p><ul><li>BPE 是基於 Greedy Algorithm，最高頻率的不一定是最好的選擇，像是 <code>Hello World</code> 會被切成 <code>Hell</code> + <code>o</code> + <code>World</code>，因為 <code>Hell</code> 本身也是一個詞彙。</li><li>不過其實也不會影響太大，BPE 已經很夠用，GPT 系列也是用這個。</li></ul><h4 id="Unigram-Language-Model"><a href="#Unigram-Language-Model" class="headerlink" title="Unigram Language Model"></a>Unigram Language Model</h4><p>每個 subword 都有一個機率，演算法會選出能最大化整句機率的分割方式。</p><h2 id="ELMo-BERT-GPT-and-T5-BERT-and-its-Family"><a href="#ELMo-BERT-GPT-and-T5-BERT-and-its-Family" class="headerlink" title="ELMo, BERT, GPT, and T5 (BERT and its Family)"></a>ELMo, BERT, GPT, and T5 (BERT and its Family)</h2><p>Pretrained Word Embeddings 是靜態的，無法根據上下文改變詞彙的表示，像是 <code>I record a record</code>，兩個 <code>record</code> 的意思不一樣，但 Embedding 是一樣的，因此應該要能夠根據上下文改變詞彙的表示。</p><h3 id="ELMo-Embeddings-from-Language-Models"><a href="#ELMo-Embeddings-from-Language-Models" class="headerlink" title="ELMo (Embeddings from Language Models)"></a>ELMo (Embeddings from Language Models)</h3><ul><li>Bidirectional Language Model (biLM)<ul><li>使用雙向 LSTM 來捕捉詞彙的語義資訊，能根據上下文動態生成 word embeddings</li></ul></li><li>生不逢時，ELMo 發表的時候，Transformer 已經出來了，且效果更好</li></ul><h3 id="Encoder-based-Models-BERT"><a href="#Encoder-based-Models-BERT" class="headerlink" title="Encoder-based Models: BERT"></a>Encoder-based Models: BERT</h3><h4 id="Bidirectional-Encoder-Representations-from-Transformers-BERT"><a href="#Bidirectional-Encoder-Representations-from-Transformers-BERT" class="headerlink" title="Bidirectional Encoder Representations from Transformers (BERT)"></a>Bidirectional Encoder Representations from Transformers (BERT)</h4><ul><li>使用 Transformer 的 Encoder 結構，捕捉遠距離的依賴關係</li><li>Masked Language Model (MLM): 隨機遮蔽輸入序列中的部分詞彙，讓模型預測被遮蔽的詞彙 (克漏字)</li><li>Next Sentence Prediction (NSP): 預測兩個句子是否連續出現<ul><li>後來發現這個任務沒什麼幫助，反而刪掉效果更好</li></ul></li><li>直接訓練會太呆版，所以會加入一些隨機性<ul><li>對於 Training Set 的 15% 的 Token 做 Mask<ul><li>80% 的機率換成 <code>[MASK]</code></li><li>10% 的機率換成隨機的 Token</li><li>10% 的機率不變</li></ul></li></ul></li><li>訓練好的 BERT 可以用來做下游任務的 Fine-tuning</li><li>BERT 的輸入格式<ul><li><code>[CLS]</code>：句子開始標記</li><li><code>[SEP]</code>：句子分隔標記</li></ul></li><li>不同任務會有不同的輸出方式<ul><li>分類任務：使用 <code>[CLS]</code> 的輸出向量 (情感分析)</li><li>序列標註任務：使用每個 Token 的輸出向量 (NER, POS)</li></ul></li></ul><h4 id="Limitations-of-Encoders"><a href="#Limitations-of-Encoders" class="headerlink" title="Limitations of Encoders"></a>Limitations of Encoders</h4><ul><li>無法做生成相關的任務 (如：QA、對話生成)</li></ul><h3 id="Encoder-Decoder-Models-T5"><a href="#Encoder-Decoder-Models-T5" class="headerlink" title="Encoder-Decoder Models: T5"></a>Encoder-Decoder Models: T5</h3><h4 id="Text-to-Text-Transfer-Transformer-T5"><a href="#Text-to-Text-Transfer-Transformer-T5" class="headerlink" title="Text-to-Text Transfer Transformer (T5)"></a>Text-to-Text Transfer Transformer (T5)</h4><ul><li>使用 Transformer 的 Encoder-Decoder 結構</li><li>將所有 NLP 任務都轉換為文本到文本的格式<ul><li>例如：情感分析任務，輸入為 “classify sentiment: I love this movie!”，輸出為 “positive”</li></ul></li><li>靠著大量的資料讓模型硬學會各種任務</li></ul><h4 id="Extensions-of-T5-BART"><a href="#Extensions-of-T5-BART" class="headerlink" title="Extensions of T5: BART"></a>Extensions of T5: BART</h4><ul><li>Bidirectional and Auto-Regressive Transformers (BART)</li><li>Token Masking, Token Deletion, Text Infilling, Sentence Permutation, Document Rotation</li></ul><h3 id="Decoder-based-Models-GPT"><a href="#Decoder-based-Models-GPT" class="headerlink" title="Decoder-based Models: GPT"></a>Decoder-based Models: GPT</h3><ul><li>2018 年 OpenAI 發表 GPT，使用 Transformer 的 Decoder 結構，作者是 Alec Radford</li><li>一開始效果沒有很好，後來 GPT-2、GPT-3、GPT-4 效果越來越好</li><li>使用自回歸語言模型 (Auto-Regressive Language Model, ARLM)<ul><li>根據前面的詞彙預測下一個詞彙</li></ul></li></ul><h4 id="GPT-3"><a href="#GPT-3" class="headerlink" title="GPT-3"></a>GPT-3</h4><ul><li>有 1750 億個參數</li><li>發現大型模型有 Emergent Abilities<ul><li>隨著模型規模增大，會出現一些小模型沒有的能力</li></ul></li></ul><h4 id="In-context-Learning"><a href="#In-context-Learning" class="headerlink" title="In-context Learning"></a>In-context Learning</h4><ul><li>不需要微調模型，只要在輸入中提供一些範例，模型就能學會任務</li><li>分為 Few-shot Learning、One-shot Learning、Zero-shot Learning</li><li>沒有實際跟新模型的參數</li></ul><h4 id="Scaling-Laws"><a href="#Scaling-Laws" class="headerlink" title="Scaling Laws"></a>Scaling Laws</h4><ul><li>模型的性能與參數數量、訓練資料量和計算資源之間存在一定的關係<br><img src="/notes/./images/nlp/scaling_laws.png" alt="Scaling Laws"></li></ul><h2 id="Decoding-Strategies-and-Evaluation-for-Natural-Language-Generation"><a href="#Decoding-Strategies-and-Evaluation-for-Natural-Language-Generation" class="headerlink" title="Decoding Strategies and Evaluation for Natural Language Generation"></a>Decoding Strategies and Evaluation for Natural Language Generation</h2><h3 id="Natural-Language-Generation-NLG"><a href="#Natural-Language-Generation-NLG" class="headerlink" title="Natural Language Generation (NLG)"></a>Natural Language Generation (NLG)</h3><ul><li>生成 text 的過程就叫做 NLG<ul><li>Machine Translation</li><li>Abstractive Summarization</li><li>Dialogue Generation (e.g., ChatGPT)</li><li>Story Generation</li><li>Image Captioning</li></ul></li></ul><h3 id="How-to-Train-a-Conditional-Language-Model"><a href="#How-to-Train-a-Conditional-Language-Model" class="headerlink" title="How to Train a Conditional Language Model"></a>How to Train a Conditional Language Model</h3><ul><li>如果是翻譯任務，會需要平行語料庫 (source, target)</li><li>Teacher Forcing: 在訓練過程中，使用真實的前一個詞彙作為輸入，而不是模型預測的詞彙<ul><li>可以加速收斂，但會導致 Exposure Bias</li><li>不用的話通常結果很爛</li></ul></li></ul><h3 id="Greedy-Decoding"><a href="#Greedy-Decoding" class="headerlink" title="Greedy Decoding"></a>Greedy Decoding</h3><ul><li><p>每次都選擇機率最高的詞彙作為輸出</p><ul><li>優點：簡單且快速</li><li>缺點：容易陷入局部最優解，生成的文本可能缺乏多樣性</li></ul></li><li><p>Top-K Sampling</p><ul><li>在生成過程中，先選擇前 K 個機率最高的詞彙，然後從中進行隨機抽樣</li><li>有可能選到機率很低的詞彙，導致生成的文本不連貫</li></ul></li><li><p>Nucleus Sampling (Top-p Sampling)</p><ul><li>選擇累積機率達到 p 的詞彙集合，然後從中進行隨機抽樣</li></ul></li><li><p>Beam Search</p><ul><li><p>同時維護多個候選序列，選擇最有可能的序列作為最終輸出</p><p><img src="https://towardsdatascience.com/wp-content/uploads/2021/04/1tEjhWqUgjX37VnT7gJN-4g.png" alt="Beam Search"></p></li><li><p>但是越長的句子會被懲罰，機率會越來越小，所以需要做 Normalization</p></li></ul></li></ul><h3 id="How-to-Evaluate-NLG-Models"><a href="#How-to-Evaluate-NLG-Models" class="headerlink" title="How to Evaluate NLG Models"></a>How to Evaluate NLG Models</h3><h4 id="BLEU-Bilingual-Evaluation-Understudy"><a href="#BLEU-Bilingual-Evaluation-Understudy" class="headerlink" title="BLEU (Bilingual Evaluation Understudy)"></a>BLEU (Bilingual Evaluation Understudy)</h4><ul><li><p>計算 n-gram 的 precision</p><ul><li>Unigrams -&gt; BLEU-1</li><li>Bigrams -&gt; BLEU-2</li><li>Trigrams -&gt; BLEU-3</li><li>4-grams -&gt; BLEU-4</li></ul></li><li><p>Precision: 你猜的答案中有多少是對的</p><ul><li>$Precision &#x3D; \frac{|\text{Relevant and Retrieved instances}|}{|\text{All Retrieved instances}|}$</li></ul></li><li><p>Recall: 正確答案中有多少被你猜出來</p><ul><li>$Recall &#x3D; \frac{|\text{Relevant and Retrieved instances}|}{|\text{All Relevant instances}|}$</li></ul></li><li><p>Example:</p><ul><li>Chinese: 我想要讀那本書</li><li>Reference1: I want to read that book</li><li>Reference2: I want to read the book</li><li>Model Output: the the the the the the</li><li>Precision &#x3D; 6&#x2F;6 &#x3D; 1</li></ul></li><li><p>Brevity Penalty (BP): 懲罰過短的句子<br>因為分母是生成句子的長度，分子是參考句子的長度，如果生成的句子太短，precision 通常會比較高，但這樣不合理，所以要加上 BP 來懲罰過短的句子</p><p>$$<br>BP &#x3D;<br>\begin{cases}<br>1 &amp; \text{if } c &gt; r \newline<br>e^{(1 - r&#x2F;c)} &amp; \text{if } c \leq r<br>\end{cases}<br>$$</p><ul><li>$c$: candidate translation length</li><li>$r$: reference translation length</li></ul></li><li><p>最終 BLEU 分數計算：</p><p>$$<br>BLEU &#x3D; BP \cdot \exp\left( \sum_{n&#x3D;1}^{N} w_n \log p_n \right)<br>$$</p><ul><li>$p_n$: n-gram precision</li><li>$w_n$: n-gram 的權重，通常均等分配</li><li>$N$: 最大 n-gram 長度</li></ul></li></ul><h4 id="ROUGE-Recall-Oriented-Understudy-for-Gisting-Evaluation"><a href="#ROUGE-Recall-Oriented-Understudy-for-Gisting-Evaluation" class="headerlink" title="ROUGE (Recall-Oriented Understudy for Gisting Evaluation)"></a>ROUGE (Recall-Oriented Understudy for Gisting Evaluation)</h4><ul><li><p>ROUGE-N: 計算 n-gram 的 recall</p><p>$$<br>ROUGE-N &#x3D; \frac{\sum_{S \in \text{Reference Summaries}} \sum_{\text{gram}<em>n \in S} \text{Count}</em>{\text{match}}(\text{gram}<em>n)}{\sum</em>{S \in \text{Reference Summaries}} \sum_{\text{gram}_n \in S} \text{Count}(\text{gram}_n)}<br>$$</p></li><li><p>ROUGE-L: 計算兩個序列的 Longest Common Subsequence (LCS)</p></li></ul><h3 id="NLP-Benchmarks"><a href="#NLP-Benchmarks" class="headerlink" title="NLP Benchmarks"></a>NLP Benchmarks</h3><h4 id="GLUE-General-Language-Understanding-Evaluation"><a href="#GLUE-General-Language-Understanding-Evaluation" class="headerlink" title="GLUE (General Language Understanding Evaluation)"></a>GLUE (General Language Understanding Evaluation)</h4><ul><li>總共有 9 個任務</li><li>任務可以分成三類<ul><li>Single-Sentence Tasks<ul><li>模型只需要理解單一句子的語義</li><li>CoLA (Corpus of Linguistic Acceptability): 判斷句子是否符合語法規則</li><li>SST-2 (Stanford Sentiment Treebank): 判斷句子的情感傾向（正面或負面）</li></ul></li><li>Sentence Pair Tasks<ul><li>模型需要理解兩個句子之間的關係</li><li>MNLI (Multi-Genre Natural Language Inference): 判斷兩個句子之間的邏輯關係（蕴涵、中立、矛盾）</li><li>RTE (Recognizing Textual Entailment): 判斷兩個句子是否存在蕴涵關係 (簡化版 MNLI)</li><li>QQP (Quora Question Pairs): 判斷兩個問題是否具有相同的語義</li><li>MRPC (Microsoft Research Paraphrase Corpus): 判斷兩個句子是否為同義句</li><li>QNLI (Question Natural Language Inference): 判斷問題和句子之間的蕴涵關係</li></ul></li><li>Semantic Similarity Tasks<ul><li>STS-B (Semantic Textual Similarity Benchmark): 評估兩個句子之間的語義相似度，分數範圍為 0 到 5</li></ul></li></ul></li><li>最後分數會綜合各個任務的結果，不過有時候會只看部分任務的結果</li></ul><h4 id="SQuAD-Stanford-Question-Answering-Dataset"><a href="#SQuAD-Stanford-Question-Answering-Dataset" class="headerlink" title="SQuAD (Stanford Question Answering Dataset)"></a>SQuAD (Stanford Question Answering Dataset)</h4><ul><li>由 Stanford 大學釋出的閱讀理解資料集</li><li>SQuAD 1.1: 包含 100,000 個問題，答案都是文章中的一段文字</li><li>SQuAD 2.0: 在 SQuAD 1.1 的基礎上增加了無答案的問題，模型需要判斷問題是否有答案</li></ul><h4 id="MMLU-Massive-Multitask-Language-Understanding"><a href="#MMLU-Massive-Multitask-Language-Understanding" class="headerlink" title="MMLU (Massive Multitask Language Understanding)"></a>MMLU (Massive Multitask Language Understanding)</h4><ul><li>包含 57 個不同領域的多選題</li><li>測試模型在各種專業知識領域的理解能力</li><li>涵蓋範圍廣泛，包括 STEM、Humanities、Social Sciences 等等</li><li>模型需要在沒有額外訓練的情況下，直接回答這些問題</li></ul><h4 id="MTEB-Massive-Text-Embedding-Benchmark"><a href="#MTEB-Massive-Text-Embedding-Benchmark" class="headerlink" title="MTEB (Massive Text Embedding Benchmark)"></a>MTEB (Massive Text Embedding Benchmark)</h4><ul><li>評估文本嵌入 (Text Embedding) 模型在多種任務上的表現</li><li>包含文本分類、文本生成、文本相似度等多個任務</li></ul><h3 id="Watermark-for-text"><a href="#Watermark-for-text" class="headerlink" title="Watermark for text"></a>Watermark for text</h3><h2 id="GPT-3-InstructGPT-and-RLHF"><a href="#GPT-3-InstructGPT-and-RLHF" class="headerlink" title="GPT-3, InstructGPT, and RLHF"></a>GPT-3, InstructGPT, and RLHF</h2><h3 id="GPT-1"><a href="#GPT-1" class="headerlink" title="GPT-1"></a>GPT-1</h3><ul><li>Decoder-only Transformer</li><li>12 層，117M 個參數</li></ul><p><img src="/notes/./images/nlp/gpt1.png" alt="GPT-1"></p><h3 id="GPT-2"><a href="#GPT-2" class="headerlink" title="GPT-2"></a>GPT-2</h3><ul><li>Layer Normalization 放在每個 sub-block 的前面</li><li>最後的 self-attention layer 後面多加一個 Layer Normalization</li><li>GPT-2-medium: 24 層，345M 個參數</li><li>GPT-2-large: 36 層，762M 個參數</li><li>GPT-2-xl: 48 層，1.5B 個參數</li></ul><p><img src="/notes/./images/nlp/gpt2.png" alt="GPT-2"></p><h3 id="GPT-3-1"><a href="#GPT-3-1" class="headerlink" title="GPT-3"></a>GPT-3</h3><ul><li>Sparse Transformer<ul><li>與其讓每個 token 都看所有 token，不如讓它只看「部分有意義的 token」。</li><li>大幅減少計算量，且效果不會差太多</li></ul></li></ul><h3 id="Instruct-Tuning"><a href="#Instruct-Tuning" class="headerlink" title="Instruct Tuning"></a>Instruct Tuning</h3><ul><li>一種微調方法，讓模型能夠更好地理解和執行人類的指令</li><li>讓模型更理解人類語氣與意圖，提升泛化與實用性，可以回答沒有看過的問題。</li></ul><h3 id="InstructGPT-GPT-3-5"><a href="#InstructGPT-GPT-3-5" class="headerlink" title="InstructGPT (GPT-3.5)"></a>InstructGPT (GPT-3.5)</h3><p>InstructGPT 是在 GPT-3 的基礎上，透過 <strong>人類標註與反饋</strong> 進行再訓練</p><p>訓練過程是，<strong>先學人類怎麼說，再學人類喜歡怎麼說</strong>。</p><h4 id="監督式微調-Supervised-Fine-tuning-SFT"><a href="#監督式微調-Supervised-Fine-tuning-SFT" class="headerlink" title="監督式微調 (Supervised Fine-tuning, SFT)"></a>監督式微調 (Supervised Fine-tuning, SFT)</h4><p>讓模型學會如何「遵循指令」</p><p>收集一個由人類標註者撰寫的高品質「指令-回應」資料集。使用這個資料集來微調 (fine-tuning) 一個預訓練好的基礎模型 (如 GPT-3)。</p><p>產生 SFT 模型。這個模型能理解並執行指令，但回答的品質可能還不夠穩定或不符合人類偏好。</p><h4 id="訓練獎勵模型-Reward-Model-RM"><a href="#訓練獎勵模型-Reward-Model-RM" class="headerlink" title="訓練獎勵模型 (Reward Model, RM)"></a>訓練獎勵模型 (Reward Model, RM)</h4><p>訓練一個模型來 <strong>「評估回應的品質」</strong>，使其學會人類的偏好。</p><p>使用上一步的 SFT 模型，針對一個指令（prompt）產生多個不同的回應。人類標註者排序 (ranking) 這些回應（例如：從最好到最差）。使用這些「排序資料」來訓練一個新的模型，即獎勵模型 (RM)。</p><p>產生 RM。這個模型會為任何「指令-回應」組合打一個分數 (reward)，分數越高代表越符合人類偏好。</p><h4 id="使用強化學習-Reinforcement-Learning"><a href="#使用強化學習-Reinforcement-Learning" class="headerlink" title="使用強化學習 (Reinforcement Learning)"></a>使用強化學習 (Reinforcement Learning)</h4><p>利用 RM 作為「評審」，進一步優化 SFT 模型，使其產生的回應能獲得最高的「獎勵分數」。</p><p>將 SFT 模型（在 RL 術語中稱為「策略 Policy」）複製一份。讓 Policy 針對新的指令產生回應。讓獎勵模型 (RM) 為這個「指令-回應」組合打分 (reward)。使用這個 reward 分數，透過 RL 演算法 (PPO, Proximal Policy Optimization) 來更新 Policy 模型的參數。</p><p>產生最終的 InstructGPT 模型。這個模型被訓練成傾向於產生那些「RM 會給高分」的回應，而 RM 的評分標準又來自於人類的偏好。</p>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ai</tag>
      
      <tag>machine learning</tag>
      
      <tag>nlp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>數學筆記</title>
    <link href="/notes/2025/08/12/math/"/>
    <url>/notes/2025/08/12/math/</url>
    
    <content type="html"><![CDATA[<blockquote><p>我的數學好爛，忘光光，小補一下</p></blockquote><h2 id="Entropy"><a href="#Entropy" class="headerlink" title="Entropy"></a>Entropy</h2><p>$$<br>H(P) &#x3D; -\sum_{i} P(i) \log P(i)<br>$$</p><p>對於真實分布 $P$，設計最佳的編碼表，平均需要多少 bits。</p><p>bits 代表了資訊量，$H(P)$ 越小，代表分佈本身資訊量小</p><h3 id="Cross-Entropy"><a href="#Cross-Entropy" class="headerlink" title="Cross Entropy"></a>Cross Entropy</h3><p>$$<br>H(P, Q) &#x3D; -\sum_{i} P(i) \log Q(i)<br>$$</p><p>對於真實分布 $P$，用 $Q$ 來設計編碼表，平均需要多少 bits。</p><p>$Q$ 越小，錯誤的懲罰越大。 Cross Entropy 越接近 $H(P)$，代表編碼表越好。</p><h3 id="KL-Divergence"><a href="#KL-Divergence" class="headerlink" title="KL Divergence"></a>KL Divergence</h3><p>$$<br>D_{KL}(P || Q) &#x3D; \sum_{i} P(i) \log \frac{P(i)}{Q(i)}<br>$$</p><p>當你用 $Q$ 來近似 $P$ 時，會多付出多少額外資訊成本。</p><h4 id="與-Cross-Entropy-的關係"><a href="#與-Cross-Entropy-的關係" class="headerlink" title="與 Cross Entropy 的關係"></a>與 Cross Entropy 的關係</h4><p>$$<br>\begin{aligned}<br>D_{KL}(P || Q)<br>&amp;&#x3D; \sum_{i} P(i) \log \frac{P(i)}{Q(i)} \newline<br>&amp;&#x3D; \sum_{i} P(i) \log P(i) - \sum_{i} P(i) \log Q(i) \newline<br>&amp;&#x3D; - H(P) + H(P, Q)<br>\end{aligned}<br>$$</p><p>得到</p><p>$$<br>H(P, Q) &#x3D; H(P) + D_{KL}(P || Q)<br>$$</p><p>也就是 Entropy &#x3D; 真實分布的 Entropy + 額外的資訊浪費</p><h4 id="壞處"><a href="#壞處" class="headerlink" title="壞處"></a>壞處</h4><ol><li><p>不對稱</p><ul><li>$D_{KL}(P || Q) \neq D_{KL}(Q || P)$</li><li>$D_{KL}(P || Q)$ 衡量的是用 $Q$ 來近似 $P$ 的效果，反之則不然。</li></ul></li><li><p>可能無窮大</p><ul><li>當 $Q(i) &#x3D; 0$ 而 $P(i) &gt; 0$ 時，$D_{KL}(P || Q)$ 會無窮大。</li></ul></li></ol><h3 id="JS-Divergence"><a href="#JS-Divergence" class="headerlink" title="JS Divergence"></a>JS Divergence</h3><p>$$<br>D_{JS}(P || Q) &#x3D; \frac{1}{2} D_{KL}(P || M) + \frac{1}{2} D_{KL}(Q || M)<br>$$</p><p>其中</p><p>$$<br>M &#x3D; \frac{1}{2}(P + Q)<br>$$</p><p>是 $P$ 和 $Q$ 的平均分布。</p><h2 id="泰勒展開式"><a href="#泰勒展開式" class="headerlink" title="泰勒展開式"></a>泰勒展開式</h2><p>出發點：希望能夠用多項式來近似任何函數，包含 $sin(x)$、$cos(x)$、$e^x$ 等等，這樣就可以用微積分的方法來解決問題。</p><p>$$<br>f(x) &#x3D; f(a) + f’(a)(x-a) + \frac{f’’(a)}{2!}(x-a)^2 + \frac{f’’’(a)}{3!}(x-a)^3 + \cdots + \frac{f^{(n)}(a)}{n!}(x-a)^n + R_n(x)<br>$$</p><p>其中 $R_n(x)$ 是餘項</p><h3 id="推導"><a href="#推導" class="headerlink" title="推導"></a>推導</h3><p>$$<br>f(x) &#x3D; a_0 + a_1x + a_2x^2 + a_3x^3 + \cdots + a_nx^n<br>$$</p><p>以 $x &#x3D; 0$ 為例，當兩邊微分 $n$ 次後，得到通式 $a_n$：</p><p>$$<br>f^{(n)}(0) &#x3D; n! \cdot a_n \Rightarrow a_n &#x3D; \frac{f^{(n)}(0)}{n!}<br>$$</p><p>把 $a_n$ 代入 $f(x)$ 得到 <strong>馬克勞林級數 (Maclaurin Series)</strong> ：</p><p>$$<br>f(x) &#x3D; f(0) + \frac{f’(0)}{1!}x + \frac{f’’(0)}{2!}x^2 + \frac{f’’’(0)}{3!}x^3 + \cdots + \frac{f^{(n)}(0)}{n!}x^n<br>$$</p><p>現在為了適用於任意點 $a$，以函數平移的角度來看，從 $x &#x3D; 0$ 平移到 $x &#x3D; a$，就是 $x - a$，得到 <strong>泰勒展開式 (Taylor Series)</strong> ：</p><p>$$<br>f(x) &#x3D; f(a) + \frac{f’(a)}{1!}(x-a) + \frac{f’’(a)}{2!}(x-a)^2 + \frac{f’’’(a)}{3!}(x-a)^3 + \cdots + \frac{f^{(n)}(a)}{n!}(x-a)^n<br>$$</p><p>可以看到，<strong>泰勒展開式</strong> 是在 $x &#x3D; a$ 的點展開，<strong>馬克勞林級數</strong> 是在 $x &#x3D; 0$ 的點展開，<strong>泰勒展開式</strong> 是 <strong>馬克勞林級數</strong> 的一般化。</p><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><h4 id="e-x"><a href="#e-x" class="headerlink" title="$e^x$"></a>$e^x$</h4><p>在 $x &#x3D; a$ 展開：</p><p>$$<br>e^x &#x3D; e^a + e^a(x-a) + \frac{e^a}{2!}(x-a)^2 + \frac{e^a}{3!}(x-a)^3 + \cdots + \frac{e^a}{n!}(x-a)^n &#x3D; \sum_{n&#x3D;0}^{\infty} \frac{e^a}{n!}(x-a)^n<br>$$</p><p>在 $x &#x3D; 0$ 展開：</p><p>$$<br>e^x &#x3D; 1 + x + \frac{x^2}{2!} + \frac{x^3}{3!} + \cdots + \frac{x^n}{n!} &#x3D; \sum_{n&#x3D;0}^{\infty} \frac{x^n}{n!}<br>$$</p><h4 id="sin-x"><a href="#sin-x" class="headerlink" title="$sin(x)$"></a>$sin(x)$</h4><p>在 $x &#x3D; 0$ 展開：</p><p>$$<br>sin(x) &#x3D; x - \frac{x^3}{3!} + \frac{x^5}{5!} - \frac{x^7}{7!} + \cdots &#x3D; \sum_{n&#x3D;0}^{\infty} (-1)^n \frac{x^{2n+1}}{(2n+1)!}<br>$$</p><h4 id="cos-x"><a href="#cos-x" class="headerlink" title="$cos(x)$"></a>$cos(x)$</h4><p>在 $x &#x3D; 0$ 展開：</p><p>$$<br>cos(x) &#x3D; 1 - \frac{x^2}{2!} + \frac{x^4}{4!} - \frac{x^6}{6!} + \cdots &#x3D; \sum_{n&#x3D;0}^{\infty} (-1)^n \frac{x^{2n}}{(2n)!}<br>$$</p><h4 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h4><ul><li><a href="https://www.youtube.com/watch?v=ViRvw2Hfto4">如何理解泰勒展开？它有何用途？高中生也能听懂的泰勒展开式</a></li></ul><h2 id="Lagrange-Multipliers"><a href="#Lagrange-Multipliers" class="headerlink" title="Lagrange Multipliers"></a>Lagrange Multipliers</h2><p>用來解決 <strong>帶約束條件的最佳化問題</strong>。當一個函數的極值問題受到其他等式約束時，可以用 <strong>Lagrange Multipliers</strong> 來解決。</p><h3 id="Level-Curves"><a href="#Level-Curves" class="headerlink" title="Level Curves"></a>Level Curves</h3><p>圖中的紫色平面會把藍色函式 $f(x, y) &#x3D; 3x - x^3 -2y^2 + y^4$ 切成不同的等高線，每條等高線代表著相同的函數值。綠色的點為紫色平面上的某一點，可以發現這個點不管在哪裡，其算出的梯度向量 $\nabla f$ 永遠與等高線的切線向量垂直。</p><p><img src="/notes/./images/math/LevelCurves-1.png" alt="Level Curves"><br><img src="/notes/./images/math/LevelCurves-2.png" alt="Level Curves"></p><h3 id="有限制的最佳化問題"><a href="#有限制的最佳化問題" class="headerlink" title="有限制的最佳化問題"></a>有限制的最佳化問題</h3><p>在這個圖中，綠色為紅色函式的等高線投影，藍色函式為 $x$、$y$ 的限制條件，橘色函式為紅色函式在限制條件下的函式。<br><img src="/notes/./images/math/Gradient-0.png" alt="Gradient Example"></p><p>可以發現當極值發生時，等高線的的 <code>Gradient</code> 和限制條件的 <code>Gradient</code> 會平行</p><p><img src="/notes/./images/math/Gradient-1.png" alt="Gradient Example"><br><img src="/notes/./images/math/Gradient-2.png" alt="Gradient Example"></p><p>因此可以得到</p><p>$$<br>\nabla f(x, y) &#x3D; \lambda \nabla g(x, y)<br>$$</p><p>其中 $\lambda$ 就是 <strong>Lagrange Multipliers</strong></p><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>求 $f(x, y) &#x3D; x^2 + 2y^2$ 在 $g(x, y) &#x3D; x^2 + y^2 &#x3D; 1$ 的極值。</p><p>已知：</p><p>$$<br>\begin{aligned}<br>f(x, y) &amp;&#x3D; x^2 + 2y^2 \newline<br>g(x, y) &amp;&#x3D; x^2 + y^2 &#x3D; 1 \newline<br>\end{aligned}<br>$$</p><p>Gradient:</p><p>$$<br>\begin{aligned}<br>\nabla f(x, y) &amp;&#x3D; \begin{bmatrix} 2x \ 4y \end{bmatrix} \newline<br>\nabla g(x, y) &amp;&#x3D; \begin{bmatrix} 2x \ 2y \end{bmatrix} \newline\newline<br>\nabla f(x, y) &amp;&#x3D; \lambda \nabla g(x, y) \newline<br>\Rightarrow \begin{bmatrix} 2x \ 4y \end{bmatrix} &amp;&#x3D; \lambda \begin{bmatrix} 2x \ 2y \end{bmatrix} \newline<br>\end{aligned}<br>$$</p><p>得到</p><p>$$<br>\begin{aligned}<br>2x &amp;&#x3D; \lambda 2x \Rightarrow (\lambda-1)x&#x3D;0 \Rightarrow \begin{cases} x&#x3D;0 \Rightarrow y^2&#x3D;1 \Rightarrow y&#x3D;\pm 1\newline \lambda&#x3D;1 \end{cases} \newline<br>&amp;\Rightarrow  (x, y) &#x3D; (0, 1) \text{ or } (0, -1)<br>\end{aligned}<br>$$</p><p>$$<br>\begin{aligned}<br>4y &amp;&#x3D; \lambda 2y \Rightarrow (\lambda-2)y&#x3D;0 \Rightarrow \begin{cases} y&#x3D;0 \Rightarrow x^2&#x3D;1 \Rightarrow x&#x3D;\pm 1\newline \lambda&#x3D;2 \end{cases} \newline<br>&amp;\Rightarrow  (x, y) &#x3D; (1, 0) \text{ or } (-1, 0)<br>\end{aligned}<br>$$</p><p>最後把所有 case 代入 $f(x, y)$ 就可以得到極值</p><h3 id="Langrange-Function"><a href="#Langrange-Function" class="headerlink" title="Langrange Function"></a>Langrange Function</h3><p>同樣的邏輯，可以整理出更系統化的 <strong>Langrange Function</strong>：</p><p>$$<br>L(x, y, \lambda) &#x3D; f(x, y) - \lambda \cdot g(x, y)<br>$$</p><p>且</p><p>$$<br>\frac{\partial L}{\partial x} &#x3D; 0 ,\quad<br>\frac{\partial L}{\partial y} &#x3D; 0 ,\quad<br>\frac{\partial L}{\partial \lambda} &#x3D; 0<br>$$</p><h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><p>剛剛的題目，求 $f(x, y) &#x3D; x^2 + 2y^2$ 在 $g(x, y) &#x3D; x^2 + y^2 &#x3D; 1$ 的極值，可以變成：</p><p>$$<br>\begin{aligned}<br>L(x, y, \lambda) &amp;&#x3D; f(x, y) - \lambda \cdot g(x, y) \newline<br>&amp;&#x3D; x^2 + 2y^2 - \lambda(x^2 + y^2 - 1) \newline<br>\end{aligned}<br>$$</p><p>$$<br>\begin{aligned}<br>\frac{\partial L}{\partial x} &amp;&#x3D; 2x-2\lambda x &#x3D;0 \Rightarrow (1 - \lambda)x &#x3D; 0 \Rightarrow \lambda &#x3D; 1 \text{ or } x&#x3D;0\newline<br>\frac{\partial L}{\partial y} &amp;&#x3D; 4y-2\lambda y &#x3D;0 \Rightarrow (2 - \lambda)y &#x3D; 0 \Rightarrow \lambda &#x3D; 2 \text{ or } y&#x3D;0\newline<br>\frac{\partial L}{\partial \lambda} &amp;&#x3D; -(x^2 + y^2 - 1) &#x3D; 0 \Rightarrow x^2 + y^2 &#x3D; 1<br>\end{aligned}<br>$$</p><p>得到</p><p>$$<br>\begin{aligned}<br>\lambda &#x3D; 1 &amp;\Rightarrow y &#x3D; 0 \Rightarrow x &#x3D; \pm 1 \newline<br>\Rightarrow (x, y) &amp;&#x3D; (1, 0) \text{ or } (-1, 0) \newline \newline<br>\lambda &#x3D; 2 &amp;\Rightarrow x &#x3D; 0 \Rightarrow y &#x3D; \pm 1 \newline<br>\Rightarrow (x, y) &amp;&#x3D; (0, 1) \text{ or } (0, -1)<br>\end{aligned}<br>$$</p><p>最後一樣把所有 case 代入 $f(x, y)$ 就可以得到極值</p><h4 id="參考資料-1"><a href="#參考資料-1" class="headerlink" title="參考資料"></a>參考資料</h4><ul><li><a href="https://www.geogebra.org/m/RGZNtfu3">Gradient and Level Curve</a></li><li><a href="https://www.geogebra.org/m/cqmCmg7V">Máximos e Mínimos Condicionados</a></li><li><a href="https://www.youtube.com/watch?v=fYe0tU1Yimo">30 分鐘快速了解 Lagrange 乘數、Lagrange 函數與有限制條件的函數極值求法</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>LLM</title>
    <link href="/notes/2025/05/11/llm/"/>
    <url>/notes/2025/05/11/llm/</url>
    
    <content type="html"><![CDATA[<ul><li><p>詞向量<br>像是如果要表示 <strong>貓</strong>，會用類似 [0.0074, 0.0023, -0.0012…] 的數字來表示貓的特徵，這些數字就是詞向量，共有 300 個數字。用這樣的向量可以表示詞空間的關係，像是 <strong>狗</strong>、<strong>寵物</strong> 等也用一樣的方法表示，這些詞在詞 World Space 中就會與 <strong>貓</strong> 比較接近。</p><p>這種高維度的表示法還有一個優勢是，可以用向量運算推理單字，像是 <strong>biggest</strong> - <strong>big</strong> &#x3D; <strong>smallest</strong> - <strong>small</strong>、<strong>瑞士人</strong> - <strong>瑞士</strong> &#x3D; <strong>德國人</strong> - <strong>德國</strong> 等等。</p><p>以 GPT-3 為例，詞向量的維度高達 12288，比 Google 的 word2vec 還要高出 20 倍。</p></li><li><p>LLM<br>會由多層 Transformer，前幾層的神經網路會專注理解句子的語法，解決字上的歧義，像是代詞 <strong>his</strong> 和多義詞 <strong>bank</strong> 等等。後面的層會專注於理解整個文本段落的理解。</p></li><li><p>Memory</p><ul><li>optimizer states, gradients, parameters, activations</li></ul></li><li><p>Batch size、 sequence length 與 activation memory 的關係</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>llm</category>
      
    </categories>
    
    
    <tags>
      
      <tag>llm</tag>
      
      <tag>research</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Paper</title>
    <link href="/notes/2025/05/11/paper/"/>
    <url>/notes/2025/05/11/paper/</url>
    
    <content type="html"><![CDATA[<h1 id="Quantized-Side-Tuning-Fast-and-Memory-Efficient-Tuning-of-Quantized-Large-Language-Models"><a href="#Quantized-Side-Tuning-Fast-and-Memory-Efficient-Tuning-of-Quantized-Large-Language-Models" class="headerlink" title="Quantized Side Tuning: Fast and Memory-Efficient Tuning of Quantized Large Language Models"></a>Quantized Side Tuning: Fast and Memory-Efficient Tuning of Quantized Large Language Models</h1><h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>本文提出一種名為 Quantized Side Tuning (QST) 的訓練框架，旨在快速且記憶體效率高地微調大型語言模型（LLMs）。該方法透過兩階段處理：</p><ol><li>將模型權重量化為 4-bit，減少儲存所需的記憶體。</li><li>設計一個與主模型分離的「側邊網路（side network）」，該網路僅根據主模型的隱藏層輸出進行任務預測，從而避免在主模型上進行反向傳播，進一步減少中介激活值的記憶體消耗。</li></ol><p>此外，QST 運用低秩適配器（如 LoRA、Adapter）與無梯度下取樣模組來降低可訓練參數數量。實驗顯示，QST 能夠將總記憶體占用降低至最多 1&#x2F;7，訓練速度提升 3 倍，並在準確率上保持與現有最先進方法相當的水準。</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>隨著大型語言模型（LLMs）不斷增大（達數百億參數），其在微調過程中所需的記憶體與計算資源急遽上升。現有的 PEFT（參數高效率微調）雖能部分減少訓練參數，但仍需保留大量中介激活值，因此無法從根本上解決記憶體瓶頸。本文提出 QST，目的在於同時解決模型權重、優化器狀態與中介激活值三大記憶體來源問題。</p><h2 id="研究目的本研究主要目的為："><a href="#研究目的本研究主要目的為：" class="headerlink" title="研究目的本研究主要目的為："></a>研究目的本研究主要目的為：</h2><ul><li>設計一個針對量化 LLMs 的記憶體節省且快速微調方法。</li><li>減少三個主要記憶體負擔來源：模型權重、優化器狀態與中介激活值。</li><li>維持微調後模型的高效性能，並提升在多種下游任務上的表現。</li></ul><h2 id="文獻探討"><a href="#文獻探討" class="headerlink" title="文獻探討"></a>文獻探討</h2><ul><li><p>2.1 Parameter-Efficient Finetuning：<br>回顧 PEFT 方法如 LoRA、Adapters、Prompt Tuning 等，其特點在於僅微調少量參數；但這些方法仍需保留大部分中介激活值，導致記憶體需求仍偏高。</p></li><li><p>2.2 Memory-Efficient Training and Finetuning：<br>探討如 Gradient Checkpointing、可逆網路、網路剪枝與蒸餾等降低記憶體需求技術，指出這些技術或需額外運算、或不適用於大模型；因此提出 QST 為一種可針對全模型大小皆適用的解法。</p></li></ul><h2 id="研究方法"><a href="#研究方法" class="headerlink" title="研究方法"></a>研究方法</h2><ul><li><p>研究設計：<br>提出 QST 架構，包含 4-bit 量化與 side tuning 雙階段設計。</p></li><li><p>研究對象：<br>使用多種主流 LLM 架構（如 OPT、LLaMA-2）進行實驗，涵蓋模型參數從 1.3B 至 70B。</p></li><li><p>研究工具：<br>實作於 PyTorch 與 HuggingFace 平台，使用 NF4 為 4-bit 資料型態、bfloat16 為計算型態。</p></li><li><p>資料處理與分析：<br>評估模型在 GLUE、MMLU 等標準資料集上的準確率與記憶體消耗，並以 FLOPS&#x2F;token 量測訓練速度。</p></li></ul><h2 id="研究結果"><a href="#研究結果" class="headerlink" title="研究結果"></a>研究結果</h2><ul><li>記憶體消耗： QST 可比 QLoRA 降低記憶體使用量高達 2.3 倍。</li><li>訓練速度： 相較 QLoRA 提升 3 倍以上。</li><li>準確率： 在 GLUE 與 MMLU 數據集上與 QLoRA 等方法表現相當，誤差小於 1%。</li><li>模型擴展性： 可有效應用於 70B 參數的 LLaMA-2 模型。</li><li>下取樣模組比較： Adapter 為最佳方案，在效能與記憶體效率間取得平衡。</li><li>應用測試： 在 MT-Bench 聊天測試中，QST 甚至超越原始 LLaMA-2-70B 模型。</li></ul><h2 id="結論與建議"><a href="#結論與建議" class="headerlink" title="結論與建議"></a>結論與建議</h2><ul><li>結論：<ul><li>QST 為一項具突破性的微調方法，能在不犧牲效能的情況下，顯著降低訓練資源消耗，特別適合應用於記憶體受限的現實場景。</li></ul></li><li>建議：<ul><li>未來可擴展 QST 至多模態模型。</li><li>探索更多無參數下取樣方法，以進一步降低資源需求。</li><li>深入研究 QST 於推論時的優化策略。</li></ul></li></ul><h3 id="需要查的"><a href="#需要查的" class="headerlink" title="需要查的"></a>需要查的</h3><ul><li>gradient checkpointing</li><li>PEFT</li><li>quantization</li><li>QLoRA</li><li>finetuning</li><li>side network</li><li>LLM head</li></ul><h1 id="DISP-LLM-Dimension-Independent-Structural-Pruning-for-Large-Language-Models"><a href="#DISP-LLM-Dimension-Independent-Structural-Pruning-for-Large-Language-Models" class="headerlink" title="DISP-LLM: Dimension-Independent Structural Pruning for Large Language Models"></a>DISP-LLM: Dimension-Independent Structural Pruning for Large Language Models</h1><h2 id="摘要-1"><a href="#摘要-1" class="headerlink" title="摘要"></a>摘要</h2><p>本研究提出一種新穎的維度無關結構剪枝方法，DISP-LLM，針對大型語言模型（LLMs）進行壓縮。相較於既有的結構剪枝方法（如 LLM-Pruner 和 SliceGPT）在彈性或額外參數負擔上的侷限，本方法打破了剪枝過程中嵌入維度的結構依賴性，允許每個轉換層使用不同的特徵子集。本法具備以下優勢：每層可使用不同輸入&#x2F;輸出寬度，提升剪枝彈性且不引入額外參數。實驗驗證指出，本方法於 OPT、LLaMA、LLaMA-2、Phi-1.5 與 Phi-2 等模型上優於現有技術，首次證明結構剪枝可達與半結構剪枝相當的準確性。</p><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>大型語言模型在自然語言處理任務上表現卓越，但其龐大的參數量與高昂的運算成本限制了其在資源受限設備上的應用。過往解法如稀疏化、量化與剪枝方法已獲關注，尤其是結構剪枝能在不改變模型權重的情況下減少成本。然現有方法如 LLM-Pruner 受限於結構依賴性，SliceGPT 則需額外投影參數，影響效能與結構簡潔性。故本研究旨在提供一種不引入額外參數且具高彈性的結構剪枝策略。</p><h2 id="研究目的"><a href="#研究目的" class="headerlink" title="研究目的"></a>研究目的</h2><ul><li>目標：設計一種維度無關（dimension-independent）結構剪枝方法，避免層與層間的特徵依賴，達成靈活剪枝與高效推論。</li><li>問題：如何在不引入額外參數的前提下，讓每層自由選擇輸入&#x2F;輸出特徵子集，並同時維持模型效能？</li></ul><h2 id="文獻探討-1"><a href="#文獻探討-1" class="headerlink" title="文獻探討"></a>文獻探討</h2><ul><li>Magnitude-based Pruning： 透過 L1&#x2F;L2 範數移除小權重，但對 LLMs 效能傷害大（Han et al., 2015）；</li><li>Optimal Brain Damage &#x2F; Surgeon： 依據 Hessian 資訊進行剪枝，計算成本高（LeCun et al., 1990；Hassibi &amp; Stork, 1993）；</li><li>LLM-Pruner： 遵循結構依賴進行剪枝，彈性不足（Ma et al., 2023）；</li><li>SliceGPT： 使用主成分分析進行空間投影，具彈性但需新增轉換參數（Ashkboos et al., 2024）；</li><li>SparseGPT&#x2F;Wanda： 使用 Hessian 近似進行半結構剪枝，難以達成實際加速（Frantar et al., 2023；Sun et al., 2024）；</li></ul><h2 id="研究方法-1"><a href="#研究方法-1" class="headerlink" title="研究方法"></a>研究方法</h2><ul><li>研究設計： 提出 DISP-LLM 方法，透過<strong>索引選擇與索引加總（Index Select &amp; Add）</strong>打破層間特徵依賴；</li><li>研究對象： 多種 LLMs 模型（OPT、LLaMA、Phi 系列）；</li><li>研究工具： 使用 Pytorch 與 Hugging Face 進行訓練與剪枝，搭配 GRU 型超網路（Hypernetwork）與 ReinMax 方法決定每層剪枝寬度；</li><li>資料處理與分析： 透過語言建模損失與正規化條項進行結構優化，並使用 WikiText-2、Alpaca 等資料進行訓練與評估。</li></ul><h2 id="研究結果-1"><a href="#研究結果-1" class="headerlink" title="研究結果"></a>研究結果</h2><ul><li>DISP-LLM 在各剪枝率（10%~50%）下均優於 LLM-Pruner、SliceGPT 與 LLM Surgeon；</li><li>相對於 SliceGPT，效能更佳且無新增參數負擔；</li><li>在多種任務如 WinoGrande、HellaSwag、ARC 等零樣本評估中具備領先表現；</li><li>可靈活決定每層寬度，各層剪枝比率不一，有助於效率與效能的雙重提升。</li></ul><h2 id="結論與建議-1"><a href="#結論與建議-1" class="headerlink" title="結論與建議"></a>結論與建議</h2><ul><li>結論： DISP-LLM 透過打破結構依賴、使用超網路與指標操作成功提升剪枝彈性，為大型語言模型剪枝提供新路徑；</li><li>建議：<ul><li>後續可探討不同任務導向下的子網路學習；</li><li>評估結合 LoRA 等方法進行微調與壓縮的混合應用；</li><li>延伸至多模態模型壓縮場景。</li></ul></li></ul><h1 id="Hot-or-Cold-Adaptive-Temperature-Sampling-for-Code-Generation-with-Large-Language-Models"><a href="#Hot-or-Cold-Adaptive-Temperature-Sampling-for-Code-Generation-with-Large-Language-Models" class="headerlink" title="Hot or Cold? Adaptive Temperature Sampling for Code Generation with Large Language Models"></a>Hot or Cold? Adaptive Temperature Sampling for Code Generation with Large Language Models</h1><h2 id="摘要-2"><a href="#摘要-2" class="headerlink" title="摘要"></a>摘要</h2><p>該研究指出現有大型語言模型（LLMs）使用的解碼策略多為自然語言生成所設計，忽略了自然語言與程式語言間的差異。本文首度系統性探討專為程式碼生成設計的解碼策略，分析發現程式碼中存在「困難標記（challenging tokens）」與「穩定標記（confident tokens）」，且困難標記通常出現在程式碼區塊的開頭。基於此，作者提出「自適應溫度採樣法（Adaptive Temperature Sampling, AdapT）」，針對不同類型的標記動態調整溫度參數，結果顯示此法顯著優於現有狀態最佳解碼方法。</p><h2 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h2><ul><li>背景：大型語言模型（LLMs）在自動程式碼生成方面展現強大潛力，例如 AlphaCode、Codex 等模型。</li><li>動機：現有解碼策略未專為程式碼設計，沿用自然語言生成的方法，如溫度採樣（temperature sampling）在語法嚴格的程式碼生成中成效有限，需開發新策略提升準確性與多樣性。</li></ul><h2 id="研究目的-1"><a href="#研究目的-1" class="headerlink" title="研究目的"></a>研究目的</h2><ul><li>分析程式碼生成中損失函數（loss distribution）的特性，找出難預測與易預測的標記類型。</li><li>根據上述分析，設計自適應溫度採樣法（AdapT）。</li><li>評估該方法於不同大型語言模型與資料集上的實際效能。</li></ul><h2 id="文獻探討-2"><a href="#文獻探討-2" class="headerlink" title="文獻探討"></a>文獻探討</h2><ul><li>解碼策略分類：搜尋式（如 Greedy、Beam Search）與採樣式（如 Temperature、Top-k、Top-p Sampling）。</li><li>限制：搜尋式缺乏多樣性，採樣式易受尾部亂數影響，對語法嚴格的程式碼生成成效有限。</li><li>現有方法如 Codex 雖使用溫度調節技術，但其本質設計仍偏向自然語言處理。</li></ul><h2 id="研究方法-2"><a href="#研究方法-2" class="headerlink" title="研究方法"></a>研究方法</h2><ul><li>研究設計：<ul><li>比較自然語言與程式碼的損失分布特性。</li><li>定義「挑戰性標記」與「穩定標記」並量化其預測困難度。</li></ul></li><li>研究對象：<ul><li>開源 LLM 模型：CodeGen-2B、InCoder-6B、CodeGeeX-13B。</li><li>資料集：HumanEval（164 題）、MBPP（500 題）、APPS（訓練集 5000 題）。</li></ul></li><li>研究工具與實驗設置：<ul><li>使用 PyTorch 與 GPU (NVIDIA V100) 執行模型。</li><li>評估指標：Pass@k（k&#x3D;1,5,10,15）。</li></ul></li><li>資料分析：<ul><li>分析預測困難度（Prediction Difficulty, PD）。</li><li>將溫度係數動態設定為兩值：a（困難標記）、b（穩定標記），依條件分配。</li></ul></li></ul><h2 id="研究結果-2"><a href="#研究結果-2" class="headerlink" title="研究結果"></a>研究結果</h2><ul><li>挑戰性標記集中出現在程式區塊起始位置。</li><li>AdapT 採樣法顯著提升程式碼正確率：<ul><li>CodeGeeX 在 HumanEval 中 Pass@15 提升 13.6%（36.0% → 40.9%）。</li></ul></li><li>AdapT 提高生成程式碼品質：<ul><li>降低 NameError、SyntaxError、TypeError 等錯誤發生率。</li><li>比 SP（標準溫度採樣）產出更多通過測試的程式碼片段。</li></ul></li></ul><h2 id="結論與建議-2"><a href="#結論與建議-2" class="headerlink" title="結論與建議"></a>結論與建議</h2><ul><li>結論：<ul><li>LLM 在程式碼生成中面臨的挑戰與自然語言不同。</li><li>自適應溫度採樣有效區分挑戰性與穩定標記，提升準確率與可讀性。</li><li>AdapT 展現高魯棒性與跨模型、跨資料集適應性。</li></ul></li><li>建議：<ul><li>可採學習型方法動態決定溫度。</li><li>將領域知識納入解碼過程，以應對真實開發需求。</li><li>建立多階段解碼策略（如先產出自然語言規劃，再生成程式碼）。</li></ul></li></ul><h1 id="Memory-Efficient-Vision-Transformers-An-Activation-Aware-Mixed-Rank-Compression-Strategy"><a href="#Memory-Efficient-Vision-Transformers-An-Activation-Aware-Mixed-Rank-Compression-Strategy" class="headerlink" title="Memory-Efficient Vision Transformers: An Activation-Aware Mixed-Rank Compression Strategy"></a>Memory-Efficient Vision Transformers: An Activation-Aware Mixed-Rank Compression Strategy</h1><h2 id="摘要-3"><a href="#摘要-3" class="headerlink" title="摘要"></a>摘要</h2><p>本研究針對 Vision Transformers (ViTs) 模型推論時所面臨的高記憶體需求問題，提出一種基於輸入啟動（activation-aware）的混合秩（mixed-rank）壓縮策略，藉由對各層權重張量進行低秩分解，並搭配層別誤差補償方法，以達成大幅減少模型參數量而不明顯損失預測準確度的目標。方法上，將原始權重張量拆解為兩個參數高效的子張量之和，並透過啟動輸入與誤差梯度導向的最小化策略進行細緻優化。實驗顯示，該方法能將 DeiT-B 模型參數減少 60%，準確率僅下降不到 1%，並可壓縮大型 ViT 至與較小模型同級的參數量，同時提升預測精度，證明其為記憶體受限環境中可行之解決方案。</p><h2 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h2><p>Vision Transformers 自提出後在多項視覺任務中展現卓越性能，包括圖像分類、物件偵測與語意分割。然而，其高參數與記憶體使用成本限制了其在實務中之部署潛力。傳統壓縮方法如剪枝、量化、知識蒸餾、token pruning 雖有效，但在 transformer 架構中效果有限，尤其是直接應用低秩分解時會導致性能大幅下降。本研究即在此背景下，探索能兼顧效能與記憶體需求的新式壓縮方法。</p><h2 id="研究目的-2"><a href="#研究目的-2" class="headerlink" title="研究目的"></a>研究目的</h2><p>本研究旨在提出一種新型「啟動感知混合秩壓縮方法（Activation-Aware Mixed-Rank Compression）」，目標包括：</p><ol><li>利用啟動輸入資訊導引權重張量之低秩分解。</li><li>對 ViT 各層進行差異化秩配置（mixed-rank）。</li><li>發展層級誤差補償機制（layer-wise error compensation）。</li><li>在大幅壓縮參數量的同時維持高準確率，避免過去低秩方法常見之性能損失。</li></ol><h2 id="文獻探討-3"><a href="#文獻探討-3" class="headerlink" title="文獻探討"></a>文獻探討</h2><ul><li>Eckart &amp; Young (1936)：理論基礎，證明 SVD 在固定秩下為最小誤差解。</li><li>Jaderberg et al. (2014)、Hsu et al. (2022)：探討低秩在 CNN&#x2F;Transformer 壓縮中之應用與挑戰。</li><li>Yu &amp; Wu (2023)：證明輸出特徵比權重更適合低秩近似，並導入激活感知策略。</li><li>Li et al. (2023)：採用低秩與稀疏矩陣聯合表示，但仍會因能量流失導致準確率下降。</li><li>Kumar (2022)：提出 attention block 採低秩，feed-forward 採剪枝的混合法。</li></ul><h2 id="研究方法-3"><a href="#研究方法-3" class="headerlink" title="研究方法"></a>研究方法</h2><ul><li>研究設計：<ul><li>分三階段：Activation-Aware SVD、Mixed-Rank Optimization、Layer-Wise Error Compensation</li></ul></li><li>研究對象：<ul><li>多個 ViT 架構（包括 DeiT、ViT-B、Swin）</li></ul></li><li>研究工具與技術：<ul><li>Singular Value Decomposition (SVD)</li><li>啟動輸入加權的張量分解</li><li>啟發式逐層秩指派（greedy local search）</li><li>層別梯度導向補償（gradient-based optimization）</li></ul></li><li>資料處理與分析：<ul><li>以 proxy dataset 模擬啟動輸入</li><li>使用 Frobenius norm 評估重建誤差</li><li>進行 ImageNet 準確率與參數壓縮比分析</li></ul></li></ul><h2 id="研究結果-3"><a href="#研究結果-3" class="headerlink" title="研究結果"></a>研究結果</h2><ul><li>壓縮率與精度：<ul><li>DeiT-B 壓縮 60% 僅下降 0.7%（81.80% → 81.10%）</li><li>DeiT-S 壓縮後比原模型準確度更高（79.80% → 80.30%）</li></ul></li><li>相較其他方法：<ul><li>優於 SPViT、S2ViTE、WDPruning 等現有壓縮技術</li></ul></li><li>極端壓縮案例：<ul><li>ViT-L 壓縮為 ViT-B 尺寸後仍優於原 ViT-B 模型</li></ul></li><li>與量化兼容性強：<ul><li>搭配 8-bit quantization 仍可維持準確率</li></ul></li></ul><h2 id="結論與建議-3"><a href="#結論與建議-3" class="headerlink" title="結論與建議"></a>結論與建議</h2><ul><li>結論：<ul><li>本研究提出的啟動感知混合秩壓縮方法，能有效降低 ViT 模型參數量，並在保留原始準確率的同時，顯著減少記憶體需求。所提出的三階段流程具有高度可擴展性與實作效能，亦兼容後訓量化策略。</li></ul></li><li>建議：<ul><li>此法未來可延伸應用至語言模型（如 LLMs）。</li><li>建議探討動態秩指派與多任務情境下之壓縮策略。</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>paper</category>
      
    </categories>
    
    
    <tags>
      
      <tag>research</tag>
      
      <tag>paper</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>日語筆記 - 單字</title>
    <link href="/notes/2025/03/28/japanese-2/"/>
    <url>/notes/2025/03/28/japanese-2/</url>
    
    <content type="html"><![CDATA[<table><thead><tr><th align="center"></th><th align="center">漢字</th><th>翻譯</th></tr></thead><tbody><tr><td align="center">おちゃ</td><td align="center">お茶</td><td>Tea</td></tr><tr><td align="center">ください</td><td align="center">下さい</td><td>Please</td></tr><tr><td align="center">すし</td><td align="center">寿司</td><td>Sushi</td></tr><tr><td align="center">みず</td><td align="center">水</td><td>Water</td></tr><tr><td align="center">ごはん</td><td align="center">ご飯</td><td>Rice</td></tr><tr><td align="center">と</td><td align="center"></td><td>And</td></tr><tr><td align="center">いしゃ</td><td align="center">医者</td><td>Doctor</td></tr><tr><td align="center">せんせい</td><td align="center">先生</td><td>Teacher</td></tr><tr><td align="center">やさしい</td><td align="center">優しい</td><td>Kind</td></tr><tr><td align="center">べんごし</td><td align="center">弁護士</td><td>Lawyer</td></tr><tr><td align="center">かっこいい</td><td align="center">格好いい</td><td>Cool</td></tr><tr><td align="center">ひと</td><td align="center">人</td><td>Person</td></tr><tr><td align="center">がくせい</td><td align="center">学生</td><td>Student</td></tr><tr><td align="center">こんにちは</td><td align="center">今日は</td><td>Hello</td></tr><tr><td align="center">どうぞよろしく</td><td align="center"></td><td>Nice to meet you</td></tr><tr><td align="center">はな</td><td align="center"></td><td>Flower</td></tr><tr><td align="center">こんばんは</td><td align="center"></td><td>Good evening</td></tr><tr><td align="center">さん</td><td align="center"></td><td>Mr.</td></tr><tr><td align="center">じゃあね</td><td align="center"></td><td>See you</td></tr><tr><td align="center">またあした</td><td align="center">また明日</td><td>See you tomorrow</td></tr><tr><td align="center">カレー</td><td align="center"></td><td>Curry</td></tr><tr><td align="center">おいしい</td><td align="center"></td><td>Delicious</td></tr><tr><td align="center">ラーメン</td><td align="center"></td><td>Ramen</td></tr><tr><td align="center">これ</td><td align="center"></td><td>This</td></tr><tr><td align="center">それ</td><td align="center"></td><td>That</td></tr><tr><td align="center">ピサ</td><td align="center"></td><td>Pizza</td></tr><tr><td align="center">ケーキ</td><td align="center"></td><td>Cake</td></tr><tr><td align="center">はい</td><td align="center"></td><td>Yes</td></tr><tr><td align="center">いいえ</td><td align="center"></td><td>No</td></tr><tr><td align="center">おおきい</td><td align="center"></td><td>Big</td></tr><tr><td align="center">ちいさい</td><td align="center"></td><td>Small</td></tr><tr><td align="center">にほん</td><td align="center"></td><td>Japan</td></tr><tr><td align="center">アメリカ</td><td align="center"></td><td>America</td></tr><tr><td align="center">カナダ</td><td align="center"></td><td>Canada</td></tr><tr><td align="center">イギリス</td><td align="center"></td><td>England</td></tr><tr><td align="center">ブラジル</td><td align="center"></td><td>Brazil</td></tr><tr><td align="center">どこ</td><td align="center"></td><td>Where</td></tr><tr><td align="center">コンビニ</td><td align="center"></td><td>Convenience</td></tr><tr><td align="center">ホテル</td><td align="center"></td><td>Hotel</td></tr><tr><td align="center">バスてい</td><td align="center"></td><td>Bus stop</td></tr><tr><td align="center">ここ</td><td align="center"></td><td>Here</td></tr><tr><td align="center">そこ</td><td align="center"></td><td>There</td></tr><tr><td align="center">デパート</td><td align="center"></td><td>Department store</td></tr><tr><td align="center">えき</td><td align="center">駅</td><td>Train station</td></tr><tr><td align="center">だいがく</td><td align="center">大学</td><td>University</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>japanese</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Chisel</title>
    <link href="/notes/2025/03/22/chisel/"/>
    <url>/notes/2025/03/22/chisel/</url>
    
    <content type="html"><![CDATA[<p>Chisel 是基於 Scala 語言設計的 HDL，用設計數位電路。</p><h2 id="Scala-語法"><a href="#Scala-語法" class="headerlink" title="Scala 語法"></a>Scala 語法</h2><h4 id="變數、常數"><a href="#變數、常數" class="headerlink" title="變數、常數"></a>變數、常數</h4><ul><li>var: 變數</li><li>val: 常數</li></ul><h4 id="If-else"><a href="#If-else" class="headerlink" title="If else"></a>If else</h4><ul><li>if else: 會有 <strong>回傳值</strong> (最後一行)<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> x = <span class="hljs-keyword">if</span> (a &gt; b) a <span class="hljs-keyword">else</span> b<br></code></pre></td></tr></table></figure></li></ul><h4 id="函數"><a href="#函數" class="headerlink" title="函數"></a>函數</h4><ul><li><p>def: <strong>函數名(參數名: 參數型別): 回傳型別</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">max</span></span>(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>): <span class="hljs-type">Int</span> = <span class="hljs-keyword">if</span> (a &gt; b) a <span class="hljs-keyword">else</span> b<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">max</span></span>(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>): <span class="hljs-type">Int</span> = &#123;<br>  <span class="hljs-keyword">if</span> (a &gt; b) a<br>  <span class="hljs-keyword">else</span> b<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>函數裡面可以有其他子函數</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">max</span></span>(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>): <span class="hljs-type">Int</span> = &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">min</span></span>(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>): <span class="hljs-type">Int</span> = <span class="hljs-keyword">if</span> (a &lt; b) a <span class="hljs-keyword">else</span> b<br>    min(a, b)<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> list1 = <span class="hljs-type">List</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)<br><span class="hljs-keyword">val</span> list2 = <span class="hljs-number">1</span> :: <span class="hljs-number">2</span> :: <span class="hljs-number">3</span> :: <span class="hljs-number">4</span> :: <span class="hljs-number">5</span> :: <span class="hljs-type">Nil</span> <span class="hljs-comment">// Nil: 代表 List 的結尾</span><br><br><span class="hljs-keyword">var</span> list3 = list1 ++ list2 <span class="hljs-comment">// 合併 list</span><br><span class="hljs-keyword">var</span> m = list1.length <span class="hljs-comment">// 長度</span><br><span class="hljs-keyword">var</span> n = list1.size <span class="hljs-comment">// 長度</span><br><span class="hljs-keyword">var</span> x = list1.head <span class="hljs-comment">// 取第一個元素</span><br><span class="hljs-keyword">var</span> z = list1(<span class="hljs-number">2</span>) <span class="hljs-comment">// 取第三個元素</span><br><br></code></pre></td></tr></table></figure><h4 id="for-loop"><a href="#for-loop" class="headerlink" title="for loop"></a>for loop</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">1</span> to <span class="hljs-number">10</span>) &#123; <span class="hljs-comment">// 包含 10</span><br>    println(i)<br>&#125;<br><span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">1</span> until <span class="hljs-number">10</span>) &#123; <span class="hljs-comment">// 不包含 10</span><br>    println(i)<br>&#125;<br><span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">1</span> to <span class="hljs-number">10</span> by <span class="hljs-number">2</span>) &#123; <span class="hljs-comment">// 間隔 2</span><br>    println(i)<br>&#125;<br><span class="hljs-keyword">for</span> (i &lt;- list1) &#123; <span class="hljs-comment">// iterator</span><br>    println(i)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="class"><a href="#class" class="headerlink" title="class"></a>class</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Point</span>(<span class="hljs-params">xc: <span class="hljs-type">Int</span>, yc: <span class="hljs-type">Int</span></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> x: <span class="hljs-type">Int</span> = xc<br>    <span class="hljs-keyword">var</span> y: <span class="hljs-type">Int</span> = yc<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">move</span></span>(dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>): <span class="hljs-type">Unit</span> = &#123;<br>        x = x + dx<br>        y = y + dy<br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">toString</span></span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;(&quot;</span> + x + <span class="hljs-string">&quot;, &quot;</span> + y + <span class="hljs-string">&quot;)&quot;</span><br>    println(<span class="hljs-string">&quot;Point x: &quot;</span> + x + <span class="hljs-string">&quot;, y: &quot;</span> + y) <span class="hljs-comment">// 每次 new 一個 Point 就會執行</span><br>&#125;<br><br><span class="hljs-keyword">val</span> pt = <span class="hljs-keyword">new</span> <span class="hljs-type">Point</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)<br><span class="hljs-keyword">val</span> pt2 = <span class="hljs-keyword">new</span> <span class="hljs-type">Point</span>(xc = <span class="hljs-number">10</span>, yc = <span class="hljs-number">20</span>)<br>pt.move(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>)<br></code></pre></td></tr></table></figure><h2 id="Chisel-語法"><a href="#Chisel-語法" class="headerlink" title="Chisel 語法"></a>Chisel 語法</h2><h3 id="Signal-Types-and-Constants"><a href="#Signal-Types-and-Constants" class="headerlink" title="Signal Types and Constants"></a>Signal Types and Constants</h3><ul><li><p>有三種主要的資料型態：Bits、UInt、SInt</p><ul><li><p>Bits: 用來表示固定長度的二進位數字</p></li><li><p>UInt: 用來表示無號整數</p></li><li><p>SInt: 用來表示有號整數</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> x = <span class="hljs-type">Bits</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>) <span class="hljs-comment">// 8-bit</span><br><span class="hljs-keyword">val</span> y = <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>) <span class="hljs-comment">// unsigned 8-bit</span><br><span class="hljs-keyword">val</span> z = <span class="hljs-type">SInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>) <span class="hljs-comment">// signed 8-bit (two&#x27;s complement)</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>可以看到整數的後面有 .W，是用來表示整數的長度</p><ul><li>8.W: 8-bit 整數，W 是 width 的縮寫</li><li>8.U: 值為 8 的 UInt，U 是 unsigned 的縮寫，會自動推論有幾個 bit</li><li>8.S: 值為 8 的 SInt，S 是 signed 的縮寫，會自動推論有幾個 bit</li><li>3.U(4.W): 值為 3 的 UInt，原本只需要 2-bit，但是括號裡面指定他有 4-bit (3.U(4.W) &#x3D; 0011)</li></ul></li><li><p>如果括號裡面的數字沒有加 <code>.W</code>，會變成 bit position，且是 0 從 LSB 開始</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-number">1.</span><span class="hljs-type">U</span>(<span class="hljs-number">0</span>) <span class="hljs-comment">// 1</span><br><span class="hljs-number">1.</span><span class="hljs-type">U</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 0</span><br></code></pre></td></tr></table></figure></li><li><p>如果不是十進位，宣告的時候要用 <code>&quot;</code> 框住，並且加上 <code>b</code>、<code>h</code>、<code>o</code> 來表示二進位、十六進位、八進位</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-string">&quot;hff&quot;</span>.<span class="hljs-type">U</span> <span class="hljs-comment">// 255 in hex</span><br><span class="hljs-string">&quot;o377&quot;</span>.<span class="hljs-type">U</span> <span class="hljs-comment">// 255 in octal</span><br><span class="hljs-string">&quot;b1111_1111&quot;</span>.<span class="hljs-type">U</span> <span class="hljs-comment">// 255 in binary</span><br></code></pre></td></tr></table></figure></li><li><p>Boolean 型態</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> a = <span class="hljs-literal">true</span>.<span class="hljs-type">B</span><br><span class="hljs-keyword">val</span> b = <span class="hljs-literal">false</span>.<span class="hljs-type">B</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="Combinational-Circuits"><a href="#Combinational-Circuits" class="headerlink" title="Combinational Circuits"></a>Combinational Circuits</h3><ul><li><p>可以宣告一個空的 Wire，他的寬度會在之後自動推論</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> w = <span class="hljs-type">Wire</span>(<span class="hljs-type">UInt</span>())<br>w := a &amp; b<br></code></pre></td></tr></table></figure></li><li><p>提取 Single Bit</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> sign = x(<span class="hljs-number">31</span>)<br></code></pre></td></tr></table></figure></li><li><p>提取 Bit Range</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> sign = x(<span class="hljs-number">31</span>, <span class="hljs-number">30</span>)<br></code></pre></td></tr></table></figure></li><li><p>Concatenation</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> y = <span class="hljs-type">Cat</span>(x, z)<br><span class="hljs-keyword">val</span> z = x ## y <span class="hljs-comment">// same as Cat(x, y)</span><br></code></pre></td></tr></table></figure></li><li><p>Mux<br>Chisel 提供 Mux 函數，用來實現多路選擇器，第一個參數是 Bool 型態</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> result = <span class="hljs-type">Mux</span>(sel, a, b)<br></code></pre></td></tr></table></figure></li></ul><h3 id="Registers"><a href="#Registers" class="headerlink" title="Registers"></a>Registers</h3><p>在 Chisel 中，register 默認是連到一個 global clock 上的，且是 rising edge-triggered，還會連到一個同步的 reset signal 上。</p><ul><li><p>RegInit: 用來初始化 register 的值</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> reg = <span class="hljs-type">RegInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)) <span class="hljs-comment">// 8-bit register with initial value 0</span><br></code></pre></td></tr></table></figure></li><li><p>更新 register 的值，有多種方法</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scala">reg := d <span class="hljs-comment">// d is the new value of reg</span><br><span class="hljs-keyword">val</span> q = reg <span class="hljs-comment">// q is the value of reg</span><br><br><span class="hljs-keyword">val</span> nextReg = <span class="hljs-type">RegNext</span>(d) <span class="hljs-comment">// nextReg is the value of d in the next cycle</span><br><br><span class="hljs-keyword">val</span> bothReg = <span class="hljs-type">RegNext</span>(d, <span class="hljs-number">0.</span><span class="hljs-type">U</span>) <span class="hljs-comment">// 0.U is the reset value</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="Structure-with-Bundle-and-Vec"><a href="#Structure-with-Bundle-and-Vec" class="headerlink" title="Structure with Bundle and Vec"></a>Structure with Bundle and Vec</h3><ul><li><p>Bundle: 用來封裝多個訊號，繼承 Bundle Class，定義自己的結構</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBundle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>    <span class="hljs-keyword">val</span> a = <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>)<br>    <span class="hljs-keyword">val</span> b = <span class="hljs-type">Bool</span>()<br>&#125;<br><br><span class="hljs-keyword">val</span> bundle = <span class="hljs-type">Wire</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">MyBundle</span>)<br>bundle.a := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>bundle.b := <span class="hljs-literal">true</span>.<span class="hljs-type">B</span><br><span class="hljs-keyword">val</span> a = bundle.a<br><span class="hljs-keyword">val</span> anotherBundle = bundle <span class="hljs-comment">// anotherBundle is a reference to bundle</span><br></code></pre></td></tr></table></figure><p>在接電線的時候會用 <code>:=</code>，像是 <code>a</code>、<code>anotherBundle</code> 都是 reference，所以是用 <code>=</code></p></li><li><p>Vec: 用來封裝多個相同型態的訊號</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> vec = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)))<br>vec(<span class="hljs-number">0</span>) := <span class="hljs-number">1.</span><span class="hljs-type">U</span><br>vec(<span class="hljs-number">1</span>) := <span class="hljs-number">2.</span><span class="hljs-type">U</span><br>vec(<span class="hljs-number">2</span>) := <span class="hljs-number">3.</span><span class="hljs-type">U</span><br>vec(<span class="hljs-number">3</span>) := <span class="hljs-number">4.</span><span class="hljs-type">U</span><br><span class="hljs-keyword">val</span> x = vec(<span class="hljs-number">2</span>) <span class="hljs-comment">// 像是 Mux</span><br></code></pre></td></tr></table></figure><p>register 型態的 vec init，Seq.fill(4)(0.U(8.W)) 會產生一個 4 個 8-bit 0 的 Vec</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> regVec = <span class="hljs-type">RegInit</span>(<span class="hljs-type">VecInit</span>(<span class="hljs-type">Seq</span>.fill(<span class="hljs-number">4</span>)(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>))))<br></code></pre></td></tr></table></figure><p>Vec 不支援範圍 Assignment，可以用 Bundle 自己拆，最後再合併</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">val</span> assignWord = <span class="hljs-type">Wire</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">16.</span><span class="hljs-type">W</span>))<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Split</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>&#123;<br>    <span class="hljs-keyword">val</span> high = <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)<br>    <span class="hljs-keyword">val</span> low = <span class="hljs-type">UInt</span>(<span class="hljs-number">8.</span><span class="hljs-type">W</span>)<br>&#125;<br><span class="hljs-keyword">val</span> split = <span class="hljs-type">Wire</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Split</span>())<br>split.low := lowByte<br>split.high := highByte<br>assignWord := split.asUInt() <span class="hljs-comment">// asUInt() is used to convert a Bundle to a UInt</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><h3 id="Full-Adder"><a href="#Full-Adder" class="headerlink" title="Full Adder"></a>Full Adder</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HalfAdder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">A</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">B</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">Sum</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">Carry</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br>  <span class="hljs-comment">//the behavior of circuit</span><br>  io.<span class="hljs-type">Sum</span> := io.<span class="hljs-type">A</span> ^ io.<span class="hljs-type">B</span><br>  io.<span class="hljs-type">Carry</span> := io.<span class="hljs-type">A</span> &amp; io.<span class="hljs-type">B</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FullAdder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">A</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">B</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">Cin</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">Sum</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> <span class="hljs-type">Cout</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br><br>  <span class="hljs-comment">//Module Declaration</span><br>  <span class="hljs-keyword">val</span> ha1 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">HalfAdder</span>())<br>  <span class="hljs-keyword">val</span> ha2 = <span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">HalfAdder</span>())<br><br>  <span class="hljs-comment">//Wiring</span><br>  ha1.io.<span class="hljs-type">A</span> := io.<span class="hljs-type">A</span><br>  ha1.io.<span class="hljs-type">B</span> := io.<span class="hljs-type">B</span><br><br>  ha2.io.<span class="hljs-type">A</span> := ha1.io.<span class="hljs-type">Sum</span><br>  ha2.io.<span class="hljs-type">B</span> := io.<span class="hljs-type">Cin</span><br><br>  io.<span class="hljs-type">Sum</span> := ha2.io.<span class="hljs-type">Sum</span><br>  io.<span class="hljs-type">Cout</span> := ha1.io.<span class="hljs-type">Carry</span> | ha2.io.<span class="hljs-type">Carry</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Testbench"><a href="#Testbench" class="headerlink" title="Testbench"></a>Testbench</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3.iotesters.&#123;<span class="hljs-type">PeekPokeTester</span>,<span class="hljs-type">Driver</span>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FullAdderTest</span> (<span class="hljs-params">fa : <span class="hljs-type">FullAdder</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">PeekPokeTester</span>(<span class="hljs-params">fa</span>)</span>&#123;<br>  <span class="hljs-keyword">for</span>(a &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">2</span>)&#123;<br>    <span class="hljs-keyword">for</span>(b &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">2</span>)&#123;<br>  <span class="hljs-keyword">for</span>(c &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">2</span>)&#123;<br>    poke(fa.io.<span class="hljs-type">A</span>,a)<br>poke(fa.io.<span class="hljs-type">B</span>,b)<br>poke(fa.io.<span class="hljs-type">Cin</span>,c)<br><br><span class="hljs-keyword">var</span> x = c &amp; (a^b)<br><span class="hljs-keyword">var</span> y = a &amp; b<br><br>expect(fa.io.<span class="hljs-type">Sum</span>,(a^b^c))<br>expect(fa.io.<span class="hljs-type">Cout</span>,(x|y))<br>step(<span class="hljs-number">1</span>)<br>  &#125;<br>&#125;<br>  &#125;<br>  println(<span class="hljs-string">&quot;FullAdder test completed!!!&quot;</span>)<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">FullAdderTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">App</span></span>&#123;<br><span class="hljs-type">Driver</span>.execute(<span class="hljs-type">Array</span>(<span class="hljs-string">&quot;-td&quot;</span>,<span class="hljs-string">&quot;./generated&quot;</span>,<span class="hljs-string">&quot;-tbn&quot;</span>,<span class="hljs-string">&quot;verilator&quot;</span>),() =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">FullAdder</span>())&#123;<br>c =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">FullAdderTest</span>(c)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Execute"><a href="#Execute" class="headerlink" title="Execute"></a>Execute</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sbt &#x27;Test/runMain acal_lab04.Lab.FullAdderTest&#x27;<br></code></pre></td></tr></table></figure><h4 id="waveform"><a href="#waveform" class="headerlink" title="waveform"></a>waveform</h4><p><img src="/notes/./images/chisel/FullAdder.png" alt="FullAdder"></p><h3 id="32-bits-Ripple-Carry-Adder"><a href="#32-bits-Ripple-Carry-Adder" class="headerlink" title="32-bits Ripple Carry Adder"></a>32-bits Ripple Carry Adder</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RCAdder</span> (<span class="hljs-params">n:<span class="hljs-type">Int</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">Cin</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">In1</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(n.<span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">In2</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(n.<span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">Sum</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(n.<span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">Cout</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br><br>  <span class="hljs-comment">//FullAdder ports: A B Cin Sum Cout</span><br>  <span class="hljs-keyword">val</span> <span class="hljs-type">FA_Array</span> = <span class="hljs-type">Array</span>.fill(n)(<span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FullAdder</span>()).io)<br>  <span class="hljs-keyword">val</span> carry = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(n+<span class="hljs-number">1</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-keyword">val</span> sum   = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(n, <span class="hljs-type">Bool</span>()))<br><br>  carry(<span class="hljs-number">0</span>) := io.<span class="hljs-type">Cin</span><br><br>  <span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">0</span> until n) &#123;<br>    <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">A</span> := io.<span class="hljs-type">In1</span>(i)<br>    <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">B</span> := io.<span class="hljs-type">In2</span>(i)<br>    <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">Cin</span> := carry(i)<br>    carry(i+<span class="hljs-number">1</span>) := <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">Cout</span><br>    sum(i) := <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">Sum</span><br>  &#125;<br><br>  io.<span class="hljs-type">Sum</span> := sum.asUInt<br>  io.<span class="hljs-type">Cout</span> := carry(n)<br>&#125;<br></code></pre></td></tr></table></figure><p>不能直接在 for loop 裡面寫 <code>io.Sum(i) = sum(i)</code>，因為 Chisel3 不支援 <strong>subword assignment</strong></p><h4 id="Testbench-1"><a href="#Testbench-1" class="headerlink" title="Testbench"></a>Testbench</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3.iotesters.&#123;<span class="hljs-type">Driver</span>,<span class="hljs-type">PeekPokeTester</span>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RCAdderTest</span> (<span class="hljs-params">dut:<span class="hljs-type">RCAdder</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">PeekPokeTester</span>(<span class="hljs-params">dut</span>)</span>&#123;<br><br>    <span class="hljs-keyword">val</span> in1 = <span class="hljs-type">Array</span>(<span class="hljs-number">5</span>,<span class="hljs-number">32</span>,<span class="hljs-number">1</span>,<span class="hljs-number">77</span>,<span class="hljs-number">34</span>,<span class="hljs-number">55</span>,<span class="hljs-number">12</span>)<br>    <span class="hljs-keyword">val</span> in2 = <span class="hljs-type">Array</span>(<span class="hljs-number">3456</span>,<span class="hljs-number">89489</span>,<span class="hljs-number">78</span>,<span class="hljs-number">5216</span>,<span class="hljs-number">4744</span>,<span class="hljs-number">8</span>,<span class="hljs-number">321</span>)<br><br>    <span class="hljs-comment">//in1.zip(in2)</span><br>    (in1 zip in2).foreach&#123;<br>      <span class="hljs-keyword">case</span>(i,j)=&gt;<br>          poke(dut.io.<span class="hljs-type">In1</span>,i)<br>          poke(dut.io.<span class="hljs-type">In2</span>,j)<br>          expect(dut.io.<span class="hljs-type">Sum</span>,i+j)<br>          step(<span class="hljs-number">1</span>)<br>    &#125;<br><br><br>    <span class="hljs-comment">// for(i &lt;- in1)&#123;</span><br>    <span class="hljs-comment">//     for(j &lt;- in2)&#123;</span><br>    <span class="hljs-comment">//         poke(dut.io.In1,i)</span><br>    <span class="hljs-comment">//         poke(dut.io.In2,j)</span><br>    <span class="hljs-comment">//         expect(dut.io.Sum,i+j)</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    println(<span class="hljs-string">&quot;RCAdder test completed!!!!!&quot;</span>)<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">RCAdderTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">App</span></span>&#123;<br>    <span class="hljs-type">Driver</span>.execute(args,()=&gt;<span class="hljs-keyword">new</span> <span class="hljs-type">RCAdder</span>(<span class="hljs-number">32</span>))&#123;<br>        c =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">RCAdderTest</span>(c)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Execute-1"><a href="#Execute-1" class="headerlink" title="Execute"></a>Execute</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sbt &#x27;Test/runMain acal_lab04.Lab.RCAdderTest -tbn verilator -td ./generated&#x27;<br></code></pre></td></tr></table></figure><h4 id="waveform-1"><a href="#waveform-1" class="headerlink" title="waveform"></a>waveform</h4><p><img src="/notes/./images/chisel/RCAdder.png" alt="RCAdder"></p><h3 id="Carry-Lookahead-Adder"><a href="#Carry-Lookahead-Adder" class="headerlink" title="Carry Lookahead Adder"></a>Carry Lookahead Adder</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3._<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CLAdder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>      <span class="hljs-keyword">val</span> in1 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> in2 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">Cin</span> = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">Sum</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">4.</span><span class="hljs-type">W</span>))<br>      <span class="hljs-keyword">val</span> <span class="hljs-type">Cout</span> = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">1.</span><span class="hljs-type">W</span>))<br>  &#125;)<br><br>  <span class="hljs-keyword">val</span> <span class="hljs-type">P</span> = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>,<span class="hljs-type">UInt</span>()))<br>  <span class="hljs-keyword">val</span> <span class="hljs-type">G</span> = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>,<span class="hljs-type">UInt</span>()))<br>  <span class="hljs-keyword">val</span> <span class="hljs-type">C</span> = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>,<span class="hljs-type">UInt</span>()))<br>  <span class="hljs-keyword">val</span> <span class="hljs-type">S</span> = <span class="hljs-type">Wire</span>(<span class="hljs-type">Vec</span>(<span class="hljs-number">4</span>,<span class="hljs-type">UInt</span>()))<br><br>  <span class="hljs-keyword">for</span>(i &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">4</span>)&#123;<br>      <span class="hljs-type">G</span>(i) := io.in1(i) &amp; io.in2(i)<br>      <span class="hljs-type">P</span>(i) := io.in1(i) | io.in2(i)<br>  &#125;<br><br>  <span class="hljs-type">C</span>(<span class="hljs-number">0</span>) := io.<span class="hljs-type">Cin</span><br>  <span class="hljs-type">C</span>(<span class="hljs-number">1</span>) := <span class="hljs-type">G</span>(<span class="hljs-number">0</span>)|(<span class="hljs-type">P</span>(<span class="hljs-number">0</span>)&amp;<span class="hljs-type">C</span>(<span class="hljs-number">0</span>))<br>  <span class="hljs-type">C</span>(<span class="hljs-number">2</span>) := <span class="hljs-type">G</span>(<span class="hljs-number">1</span>)|(<span class="hljs-type">P</span>(<span class="hljs-number">1</span>)&amp;<span class="hljs-type">G</span>(<span class="hljs-number">0</span>))|(<span class="hljs-type">P</span>(<span class="hljs-number">1</span>)&amp;<span class="hljs-type">P</span>(<span class="hljs-number">0</span>)&amp;<span class="hljs-type">C</span>(<span class="hljs-number">0</span>))<br>  <span class="hljs-type">C</span>(<span class="hljs-number">3</span>) := <span class="hljs-type">G</span>(<span class="hljs-number">2</span>)|(<span class="hljs-type">P</span>(<span class="hljs-number">2</span>)&amp;<span class="hljs-type">G</span>(<span class="hljs-number">1</span>))|(<span class="hljs-type">P</span>(<span class="hljs-number">2</span>)&amp;<span class="hljs-type">P</span>(<span class="hljs-number">1</span>)&amp;<span class="hljs-type">G</span>(<span class="hljs-number">0</span>))|(<span class="hljs-type">P</span>(<span class="hljs-number">2</span>)&amp;<span class="hljs-type">P</span>(<span class="hljs-number">1</span>)&amp;<span class="hljs-type">P</span>(<span class="hljs-number">0</span>)&amp;<span class="hljs-type">C</span>(<span class="hljs-number">0</span>))<br><br>  <span class="hljs-keyword">val</span> <span class="hljs-type">FA_Array</span> = <span class="hljs-type">Array</span>.fill(<span class="hljs-number">4</span>)(<span class="hljs-type">Module</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FullAdder</span>).io)<br><br>  <span class="hljs-keyword">for</span>(i &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">4</span>)&#123;<br>      <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">A</span> := io.in1(i)<br>      <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">B</span> := io.in2(i)<br>      <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">Cin</span> := <span class="hljs-type">C</span>(i)<br>      <span class="hljs-type">S</span>(i) := <span class="hljs-type">FA_Array</span>(i).<span class="hljs-type">Sum</span><br>  &#125;<br><br>  io.<span class="hljs-type">Sum</span> := <span class="hljs-type">S</span>.asUInt<br>  io.<span class="hljs-type">Cout</span> := <span class="hljs-type">FA_Array</span>(<span class="hljs-number">3</span>).<span class="hljs-type">Cout</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Testbench-2"><a href="#Testbench-2" class="headerlink" title="Testbench"></a>Testbench</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3.iotesters.&#123;<span class="hljs-type">Driver</span>,<span class="hljs-type">PeekPokeTester</span>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CLAdderTest</span> (<span class="hljs-params">dut:<span class="hljs-type">CLAdder</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">PeekPokeTester</span>(<span class="hljs-params">dut</span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(i &lt;- <span class="hljs-number">0</span> to  <span class="hljs-number">15</span>)&#123;<br>        <span class="hljs-keyword">for</span>(j &lt;- <span class="hljs-number">0</span> to <span class="hljs-number">15</span>)&#123;<br>            poke(dut.io.in1,i)<br>            poke(dut.io.in2,j)<br>            <span class="hljs-keyword">if</span>(peek(dut.io.<span class="hljs-type">Cout</span>)*<span class="hljs-number">16</span>+peek(dut.io.<span class="hljs-type">Sum</span>)!=(i+j))&#123;<br>                println(<span class="hljs-string">&quot;Oh No!!&quot;</span>)<br>            &#125;<br>            step(<span class="hljs-number">1</span>)<br>        &#125;<br>    &#125;<br>    println(<span class="hljs-string">&quot;CLAdder test completed!!!&quot;</span>)<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">CLAdderTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">App</span></span>&#123;<br>    <span class="hljs-type">Driver</span>.execute(args,()=&gt;<span class="hljs-keyword">new</span> <span class="hljs-type">CLAdder</span>)&#123;<br>        c =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">CLAdderTest</span>(c)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Execute-2"><a href="#Execute-2" class="headerlink" title="Execute"></a>Execute</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sbt &#x27;Test/runMain acal_lab04.Lab.CLAdderTest -tbn verilator -td ./generated&#x27;<br></code></pre></td></tr></table></figure><h3 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h3><h4 id="Testbench-3"><a href="#Testbench-3" class="headerlink" title="Testbench"></a>Testbench</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-comment">// See LICENSE from https://github.com/ucb-bar/chisel-tutorial/blob/release/src/test/scala/examples/StackTests.scala</span><br><span class="hljs-keyword">package</span> acal_lab04.<span class="hljs-type">Lab</span><br><br><span class="hljs-keyword">import</span> chisel3.iotesters.&#123;<span class="hljs-type">PeekPokeTester</span>, <span class="hljs-type">Driver</span>, <span class="hljs-type">ChiselFlatSpec</span>&#125;<br><span class="hljs-keyword">import</span> scala.collection.mutable.&#123;<span class="hljs-type">ArrayStack</span> =&gt; <span class="hljs-type">ScalaStack</span>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StackTestsOrig</span>(<span class="hljs-params">c: <span class="hljs-type">Stack</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">PeekPokeTester</span>(<span class="hljs-params">c</span>) </span>&#123;<br>  <span class="hljs-keyword">var</span> nxtDataOut = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">var</span> dataOut = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">val</span> stack = <span class="hljs-keyword">new</span> <span class="hljs-type">ScalaStack</span>[<span class="hljs-type">Int</span>]()<br><br>  <span class="hljs-keyword">for</span> (t &lt;- <span class="hljs-number">0</span> until <span class="hljs-number">16</span>) &#123;<br>    println(<span class="hljs-string">s&quot;Tick <span class="hljs-subst">$t</span>&quot;</span>)<br>    <span class="hljs-keyword">val</span> enable  = rnd.nextInt(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">val</span> push    = rnd.nextInt(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">val</span> pop     = rnd.nextInt(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">val</span> top     = rnd.nextInt(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">val</span> dataIn  = rnd.nextInt(<span class="hljs-number">256</span>)<br>    <span class="hljs-keyword">val</span> empty   = stack.isEmpty<br>    <span class="hljs-keyword">val</span> full    = stack.length == c.depth<br>    println(<span class="hljs-string">s&quot;enable <span class="hljs-subst">$enable</span> push <span class="hljs-subst">$push</span> pop <span class="hljs-subst">$pop</span> dataIn <span class="hljs-subst">$dataIn</span> top <span class="hljs-subst">$top</span> isempty <span class="hljs-subst">$empty</span> isfull <span class="hljs-subst">$full</span>&quot;</span>)<br>    <span class="hljs-keyword">if</span> (enable == <span class="hljs-number">1</span>) &#123;<br>      dataOut = nxtDataOut<br>      <span class="hljs-keyword">if</span> (push == <span class="hljs-number">1</span> &amp;&amp; stack.length &lt; c.depth) &#123;<br>        stack.push(dataIn)<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pop == <span class="hljs-number">1</span> &amp;&amp; stack.length &gt; <span class="hljs-number">0</span>) &#123;<br>        stack.pop()<br>      &#125;<br>      <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) &#123;<br>        nxtDataOut = stack.top<br>      &#125;<br>    &#125;<br><br>    poke(c.io.pop,    pop)<br>    poke(c.io.push,   push)<br>    poke(c.io.en,     enable)<br>    poke(c.io.dataIn, dataIn)<br>    poke(c.io.peek,   top)<br>    step(<span class="hljs-number">1</span>)<br>    expect(c.io.dataOut, dataOut)<br>    expect(c.io.empty, stack.isEmpty)<br>    expect(c.io.full, stack.length == c.depth)<br>  &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">StackTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">App</span> </span>&#123;<br>  <span class="hljs-type">Driver</span>.execute(<span class="hljs-type">Array</span>(<span class="hljs-string">&quot;-td&quot;</span>,<span class="hljs-string">&quot;./generated&quot;</span>,<span class="hljs-string">&quot;-tbn&quot;</span>,<span class="hljs-string">&quot;verilator&quot;</span>),() =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">Stack</span>(<span class="hljs-number">8</span>)) &#123;<br>    c =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">StackTestsOrig</span>(c)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Execute-3"><a href="#Execute-3" class="headerlink" title="Execute"></a>Execute</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sbt &#x27;Test/runMain acal_lab04.Lab.StackTest&#x27;<br></code></pre></td></tr></table></figure><h3 id="32-bit-Mux2"><a href="#32-bit-Mux2" class="headerlink" title="32-bit Mux2"></a>32-bit Mux2</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mux2_32b</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br><span class="hljs-comment">//Port Declaration</span><br><span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>    <span class="hljs-keyword">val</span> sel = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> in1 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> in2 = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br><br>    <span class="hljs-keyword">val</span> out = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>&#125;)<br><br><span class="hljs-comment">//Method One</span><br>when(~io.sel)&#123;<br>    io.out := io.in1<br>&#125;.otherwise&#123;<br>    io.out := io.in2<br>&#125;<br><br><span class="hljs-comment">//Method Two</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">myMux</span></span>[<span class="hljs-type">T</span> &lt;: <span class="hljs-type">Data</span>](sel:<span class="hljs-type">Bool</span>,in1:<span class="hljs-type">T</span>,in2:<span class="hljs-type">T</span>):<span class="hljs-type">T</span>=&#123;<br>    <span class="hljs-keyword">val</span> x = <span class="hljs-type">WireDefault</span>(in1)<br>    when(sel)&#123;x := in2&#125;<br>    x<br>&#125;<br>io.out := myMux(io.sel,io.in1,io.in2)<br><br><span class="hljs-comment">//Method Three</span><br>io.out := <span class="hljs-type">Mux</span>(io.sel,io.in1,io.in2)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="32xINT32-Register-File-2R1W"><a href="#32xINT32-Register-File-2R1W" class="headerlink" title="32xINT32 Register File (2R1W)"></a>32xINT32 Register File (2R1W)</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RegisterFile</span> (<span class="hljs-params">readPorts: <span class="hljs-type">Int</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>  <span class="hljs-keyword">val</span> wen = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>  <span class="hljs-keyword">val</span> waddr = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">5.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> wdata = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> raddr = <span class="hljs-type">Input</span>(<span class="hljs-type">Vec</span>(readPorts, <span class="hljs-type">UInt</span>(<span class="hljs-number">5.</span><span class="hljs-type">W</span>)))<br>  <span class="hljs-keyword">val</span> rdata = <span class="hljs-type">Output</span>(<span class="hljs-type">Vec</span>(readPorts, <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>)))<br>  &#125;)<br>  <span class="hljs-keyword">val</span> regs = <span class="hljs-type">RegInit</span>(<span class="hljs-type">VecInit</span>(<span class="hljs-type">Seq</span>.fill(<span class="hljs-number">32</span>)(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))))<br><br>  when(io.wen)&#123;regs(io.waddr) := io.wdata&#125;<br>  regs(<span class="hljs-number">0</span>) := <span class="hljs-number">0.</span><span class="hljs-type">U</span><br><br>  <span class="hljs-keyword">for</span>(i&lt;<span class="hljs-number">-0</span> until readPorts)&#123;<br>      io.rdata(i) := regs(io.raddr(i))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="On-chip-SRAM"><a href="#On-chip-SRAM" class="headerlink" title="On-chip SRAM"></a>On-chip SRAM</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">import</span> chisel3.util.experimental.loadMemoryFromFile<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SyncMem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span>&#123;<br>    <span class="hljs-keyword">val</span> raddr = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">5.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> rdata = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br><br>    <span class="hljs-keyword">val</span> wen   = <span class="hljs-type">Input</span>(<span class="hljs-type">Bool</span>())<br>    <span class="hljs-keyword">val</span> waddr = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">5.</span><span class="hljs-type">W</span>))<br>    <span class="hljs-keyword">val</span> wdata = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>  &#125;)<br><br>  <span class="hljs-comment">//這個是async的宣告方式：Mem(depth,dtype(width))</span><br>  <span class="hljs-comment">//val memory = Mem(32, UInt(32.W))</span><br><br>  <span class="hljs-comment">//這個是sync的宣告方式</span><br>  <span class="hljs-keyword">val</span> memory = <span class="hljs-type">SyncReadMem</span>(<span class="hljs-number">32</span>, <span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br><br>  <span class="hljs-comment">//Load Memory From File</span><br>  loadMemoryFromFile(memory, <span class="hljs-string">&quot;./src/main/resource/value.txt&quot;</span>)<br><br>  <span class="hljs-comment">//Wiring</span><br>  io.rdata := memory(io.raddr)<br>  when(io.wen) &#123; memory(io.waddr) := io.wdata &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="閹割版-INT32-2-Input-ALU"><a href="#閹割版-INT32-2-Input-ALU" class="headerlink" title="閹割版 INT32 2-Input ALU"></a>閹割版 INT32 2-Input ALU</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ALUIO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span></span>&#123;<br>  <span class="hljs-keyword">val</span> src1    = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> src2    = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> funct3   = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">3.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> funct7   = <span class="hljs-type">Input</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">7.</span><span class="hljs-type">W</span>))<br>  <span class="hljs-keyword">val</span> <span class="hljs-type">ALUout</span>  = <span class="hljs-type">Output</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">32.</span><span class="hljs-type">W</span>))<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ALU</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Module</span></span>&#123;<br>  <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">ALUIO</span>)<br><br>  io.<span class="hljs-type">ALUout</span> := <span class="hljs-type">MuxLookup</span>(io.funct3,<span class="hljs-number">0.</span><span class="hljs-type">U</span>,<span class="hljs-type">Seq</span>(<br>    <span class="hljs-type">ADD_SUB</span> -&gt; (<span class="hljs-type">Mux</span>(io.funct7===<span class="hljs-type">SUB_SRA</span>, io.src1-io.src2, io.src1+io.src2)),<br>    <span class="hljs-type">SLL</span>     -&gt; (io.src1 &lt;&lt; io.src2(<span class="hljs-number">4</span>,<span class="hljs-number">0</span>)) ,<br>    <span class="hljs-type">SLT</span>     -&gt;(<span class="hljs-type">Mux</span>(io.src1.asSInt&lt;io.src2.asSInt,<span class="hljs-number">1.</span><span class="hljs-type">U</span>,<span class="hljs-number">0.</span><span class="hljs-type">U</span>)),<br>    <span class="hljs-type">SLTU</span>    -&gt;(<span class="hljs-type">Mux</span>(io.src1&lt;io.src2,<span class="hljs-number">1.</span><span class="hljs-type">U</span>,<span class="hljs-number">0.</span><span class="hljs-type">U</span>)),<br>    <span class="hljs-type">XOR</span>     -&gt; (io.src1 ^ io.src2)   ,<br>    <span class="hljs-type">SRL_SRA</span> -&gt; (<span class="hljs-type">Mux</span>(io.funct7===<span class="hljs-type">SUB_SRA</span>,(io.src1.asSInt &gt;&gt; io.src2(<span class="hljs-number">4</span>,<span class="hljs-number">0</span>)).asUInt,io.src1 &gt;&gt; io.src2(<span class="hljs-number">4</span>,<span class="hljs-number">0</span>)))<br>  ))<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://www.cnblogs.com/JamesDYX/p/10072885.html">Chisel 学习笔记 - JamesDYX</a><br><a href="https://www.imm.dtu.dk/~masca/chisel-book.pdf">Digital Design with Chisel</a><br><a href="">偉棻老師的筆記</a></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>hardware</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hardware</tag>
      
      <tag>chisel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VLSI DFM - Dummy Fill Insertion</title>
    <link href="/notes/2025/03/18/vlsi-design-for-manufacturability-3/"/>
    <url>/notes/2025/03/18/vlsi-design-for-manufacturability-3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考清大麥偉基老師課程講義</p></blockquote><h2 id="Dummy-Fill-Insertion"><a href="#Dummy-Fill-Insertion" class="headerlink" title="Dummy Fill Insertion"></a>Dummy Fill Insertion</h2>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>VLSI DFM - Redundant Via Insertion</title>
    <link href="/notes/2025/03/18/vlsi-design-for-manufacturability-2/"/>
    <url>/notes/2025/03/18/vlsi-design-for-manufacturability-2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考清大麥偉基老師課程講義</p></blockquote><h2 id="Redundant-Via-Insertion"><a href="#Redundant-Via-Insertion" class="headerlink" title="Redundant Via Insertion"></a>Redundant Via Insertion</h2><p>一個 IC 有幾十億個 <code>via</code>，任何一個掛掉，整個 IC 也會掛掉</p><h2 id="Redundant-Via"><a href="#Redundant-Via" class="headerlink" title="Redundant Via"></a>Redundant Via</h2><p>可以讓上下兩層 <code>metal</code> 凸出來一個，多塞一個 <code>via</code> 進去，這樣就算其中一個 <code>via</code> 掛掉，還有另一個 <code>via</code> 可以通電，增加 <code>Reliabllity</code>。多出來的 <code>metal</code> 也要考慮 <code>Design Rule</code>。</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/RedundantVia.png" alt="Redundant Via"></p><h2 id="Post-Routing-Double-Via-Insertion-DVI"><a href="#Post-Routing-Double-Via-Insertion-DVI" class="headerlink" title="Post-Routing Double Via Insertion (DVI)"></a>Post-Routing Double Via Insertion (DVI)</h2><p>輸入一個已經繞線好、 <code>via</code> 也打好的設計，目標是取代原本單一的 <code>via</code>，插入兩個 <code>via</code>，越多越好</p><h3 id="Maximum-Independent-Set-MIS-based-approach-to-DVI"><a href="#Maximum-Independent-Set-MIS-based-approach-to-DVI" class="headerlink" title="Maximum Independent Set (MIS)-based approach to DVI"></a>Maximum Independent Set (MIS)-based approach to DVI</h3><p>把 DVI 問題轉換成 MIS 問題，找出最大的獨立集合，然後把這些 <code>via</code> 插入進去</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/PostRoutingDoubleViaInsertion.png" alt="Post-Routing Double Via Insertion"></p><h4 id="Conflict-Graph-Construction"><a href="#Conflict-Graph-Construction" class="headerlink" title="Conflict Graph Construction"></a>Conflict Graph Construction</h4><p><img src="/notes/./images/vlsi-design-for-manufacturability/ConflictGraphConstruction.png" alt="Conflict Graph Construction"></p><p>Feasible Candidate Via 會變成 Graph 裡面的 Node，如果兩個 <code>via</code> 有 <code>via conflict</code>，就會有一條 Edge</p><ul><li>如果原本有的兩個 Single Via，他們長出的 Double Via 有衝突，就會有一條 <strong>External Edge</strong> (上圖綠線)</li><li>源自同個 Single Via 的 Double Via 之間，會有一條 <strong>Internal Edge</strong> (上圖黑線)</li></ul><h4 id="Heuristic-for-solving-the-MIS-Problem-–-H2K"><a href="#Heuristic-for-solving-the-MIS-Problem-–-H2K" class="headerlink" title="Heuristic for solving the MIS Problem – H2K"></a>Heuristic for solving the MIS Problem – H2K</h4><p>H2K 會迭代很多次，每次都從 <code>Priority Queue</code> 裡面選出前 <code>k</code> 個 <code>via</code> 組成的 subgraph，然後這個算出 subgraph 的 Maximal Independent Set。選好之後更新 <code>Conflict Graph</code>，把 <strong>這些 via 和他們的鄰居 via 通通刪掉</strong>，這樣就完成一次 iteration。</p><p>其中，<code>Priority Queue</code> 的 <code>Priority</code> 是由兩個數值決定的</p><ul><li><strong>Feasible Number</strong>: 這個 <code>Double Via</code> 源自的 <code>Single Via</code> 有多少個 <code>Feasible Candidate Via</code> - 1 (去掉自己)</li><li><strong>Degree</strong>: 這個 <code>Double Via</code> 有多少條 Edge</li></ul><p><strong>Feasible Number</strong> 和 <strong>Degree</strong> 越小，<code>Priority</code> 越高，因為去掉它比較不會影響其他 <code>via</code> 的選擇，有機會選到更多的 <code>Double Via</code>。</p><h5 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h5><p>我有一個這樣的設計</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ExampleDesign.png" alt="Example Design"></p><p>可以建構出這樣的 <code>Conflict Graph</code></p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ExampleConflictGraph.png" alt="Example Conflict Graph"></p><p>其中 Vertex 上的數字代表 (Degree, Feasible Number)，藉由這組數字來決定 <code>Priority</code></p><p>這邊假設 <code>k</code> &#x3D; 4，取出前 4 個 <code>via</code> (f, g, l, n) 組成 subgraph，然後算出 MIS。</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ExampleSubgraph.png" alt="Example Subgraph"></p><p>算出 MIS (f, l) 後，更新 <code>Conflict Graph</code></p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ExampleUpdatedConflictGraph.png" alt="Example Updated Conflict Graph"></p><p>這樣就完成一次 iteration。持續迭代直到 <code>Conflict Graph</code> 為空。</p><ul><li>Reference: <a href="https://ieeexplore.ieee.org/document/1594699">Post-routing redundant via insertion for yield&#x2F;reliability improvement</a></li></ul><h3 id="0-1-ILP-approach-to-DVI-Integer-Linear-Programming"><a href="#0-1-ILP-approach-to-DVI-Integer-Linear-Programming" class="headerlink" title="0-1 ILP approach to DVI (Integer Linear Programming)"></a>0-1 ILP approach to DVI (Integer Linear Programming)</h3><p>把 DVI 問題轉換成受很多限制條件的 ILP 問題</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/01ILPApproachToDVI.png" alt="0-1 ILP approach to DVI"></p><p>直接硬解問題太難 (ILP 是 NP-Hard)，所以要先用其他方式簡化問題</p><h4 id="Pre-selection"><a href="#Pre-selection" class="headerlink" title="Pre-selection"></a>Pre-selection</h4><p>盡量不要選碰到 <code>External Edge</code> 的 <code>via</code>，因為這樣會影響其他 <code>via</code> 的選擇</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/PreSelection.png" alt="Pre-selection"></p><h4 id="Connected-Components"><a href="#Connected-Components" class="headerlink" title="Connected Components"></a>Connected Components</h4><p>做完 Pre-selection 之後，可以想像會有很多獨立的 Subgraph，使用 <code>DFS</code> 把這些 <code>Connected Components</code> 找出來，每個 <code>Connected Component</code> 都是一個更小的 ILP 問題</p><h4 id="Reduction-in-Constraints"><a href="#Reduction-in-Constraints" class="headerlink" title="Reduction in Constraints"></a>Reduction in Constraints</h4><p>合併一些限制條件，讓 ILP 問題變得更簡單</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ReductionInConstraints.png" alt="Reduction in Constraints"></p><h4 id="Via-Density-Constraint"><a href="#Via-Density-Constraint" class="headerlink" title="Via Density Constraint"></a>Via Density Constraint</h4><p>在現實層面，因為 CMP (Chemical Mechanical Planarization) 的關係，每個區域內的 <code>via</code> 數量是有限制的，所以要多考慮 Via Density。</p><p>以剛剛的 0-1 ILP 問題為例，加上 Via Density Constraint 之後：</p><p>多了一個限制條件，讓每個區域內的 <code>via</code> 數量不能超過一定的數量</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ViaDensityConstraint.png" alt="Via Density Constraint"></p><p>Pre-selection 時除了避免選到 <code>External Edge</code> 的 <code>via</code>，還要避免選到 <code>Potential violating region</code> 的 <code>via</code></p><p><img src="/notes/./images/vlsi-design-for-manufacturability/PreSelectionWithViaDensityConstraint.png" alt="Pre-selection with Via Density Constraint"></p><p>分割 <code>Connected Components</code> 時，不能把 <code>Potential violating region</code> 分開</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/ConnectedComponentsWithViaDensityConstraint.png" alt="Connected Components with Via Density Constraint"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>AIAS - Digital Design</title>
    <link href="/notes/2025/03/17/ai-computing-system-3/"/>
    <url>/notes/2025/03/17/ai-computing-system-3/</url>
    
    <content type="html"><![CDATA[<h2 id="Lecture"><a href="#Lecture" class="headerlink" title="Lecture"></a>Lecture</h2><ul><li>Moore’s Law is slowing down<br>製成技術的瓶頸</li><li>Dennard Scaling is dead two decades ago<br>雖然 Transistor 數量增加，但是 Power Consumption 也增加，晶片的運作沒辦法滿載，因此 Power 是現今重要的議題。</li><li>Specialized &amp; Customization<ul><li>現今逐漸趨向 Specialized Hardware，像是專門 for AI training、inference 的晶片，比較少用 General Purpose 的晶片來做，這樣 Power Consumption 和 Performance 會比較好</li></ul></li><li>設計成本高</li></ul><h3 id="Design-Flow-and-Abstraction"><a href="#Design-Flow-and-Abstraction" class="headerlink" title="Design Flow and Abstraction"></a>Design Flow and Abstraction</h3><p>以 RISC-V Design Process 為例</p><ul><li><p>Specification (in plain text)<br>如果要設計 RISC-V 相容的 CPU，要去官方網站下載 Spec。RISC-V 是一個 Modulized 的 Spec，除了 Basic Instruction Set 之外，還有很多 Extension，像是矩陣乘法、浮點數運算等等。不同公司會為了不同的需求，選擇不同的 Extension。</p><p>Spec 是軟體與硬體共同 Follow 的標準，只要你硬體是符合 Spec 的，其他跟這個 Spec 相容的軟體都可以跑在這個硬體上。</p></li><li><p>Model (in C&#x2F;C++&#x2F;SystemVerilog)<br>用 High Level Language 把重要的 Parameter、Feature Model 出來，去衡量做出的晶片能否符合需求。不過 ASIC 不太會做 Model，因為它行為固定，很容易預測。但像是 CPU、GPU 這種複雜的晶片，就會做 Model。像是 Performance Modeling，幫助去了解要設計的硬體長什麼樣子，衡量 Design Trade-off。</p><p>另一個原因是軟體和硬體是同時開發的，去 Model 執行硬體的 Behavior，可以幫助軟體早期開發。</p></li><li><p>Architecture (in-order&#x2F;out-of-order)<br>這個階段會決定 CPU 的架構，像是 In-Order、Out-of-Order，這個架構會影響到 CPU 的 PPA。Modeling 是幫助 Architecture 去選擇最適合的架構。</p></li><li><p>RTL Logic Design (in Verilog&#x2F;SystemVerilog)<br>在 RISC-V 的 CPU 世界，Chisel 比較常見</p></li><li><p>Physical Design</p></li><li><p>Manufacture part</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VLSI DFM - Maze Routing</title>
    <link href="/notes/2025/03/10/vlsi-design-for-manufacturability-1/"/>
    <url>/notes/2025/03/10/vlsi-design-for-manufacturability-1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考清大麥偉基老師課程講義</p></blockquote><h2 id="Lithography"><a href="#Lithography" class="headerlink" title="Lithography"></a>Lithography</h2><ul><li>Lithography: 光刻<br>框出電路圖案，然後進行蝕刻</li><li>Diffraction: 繞射<br>會造成 Lithography 不準確，可以從目標圖案反推出 Mask 的設計，稱為 Computational Lithography</li></ul><p><img src="/notes/./images/vlsi-design-for-manufacturability/LithographyDevelopment.png" alt="Lithography Development"></p><ul><li>193i 的 <code>i</code> 代表 Immersion Lithography<br>用液體取代空氣，縮短光的波長，就好像換了一個 Light Source，減少繞射的影響，而且波長 193nm 的技術已經很成熟</li><li>EUV 代表 Extreme Ultraviolet Lithography<br>波長更短，繞射更少，但是製程更難，因為要用真空，光源也很難做</li><li>Multi-Patterning<br>把一個圖案分成多個小圖案，然後分別曝光，最後合併成一個圖案。在 EUV Lithography 之前很常用，現在因為 EUV 很貴，有些先進製程還是用 193i + Multi-Patterning</li><li>隨著技術進步，單位面積上的 Transistor 數量越來越多，但是製程成本也越來越高，所以不是每個裝置都用最先進的製程</li></ul><h2 id="Routing-in-Advanced-Nodes"><a href="#Routing-in-Advanced-Nodes" class="headerlink" title="Routing in Advanced Nodes"></a>Routing in Advanced Nodes</h2><p>受限於 <code>Lithography printability</code>、<code>Process Variation</code> 等，即使你用一樣的方法，做出來的也不一定是你要的。所以要考慮 <code>Design for Manufacturability</code>。</p><h3 id="Design-Rule-Handling"><a href="#Design-Rule-Handling" class="headerlink" title="Design Rule Handling"></a>Design Rule Handling</h3><p><strong>Optical Proximity Correction (OPC)</strong> 是一種 Computational Lithography 的技術，修改 mask 來補償繞射和光刻製程中的非理想效應，讓實際製造出的 Pattern 更接近設計的目標。</p><ul><li>OPC 會造成線寬變寬，所以要考慮 <code>Design Rule</code>，ex：兩條線之間要留多少空間</li></ul><p><img src="/notes/./images/vlsi-design-for-manufacturability/OPC.png" alt="OPC"></p><h4 id="End-to-End-Seperation-Rule"><a href="#End-to-End-Seperation-Rule" class="headerlink" title="End-to-End Seperation Rule"></a>End-to-End Seperation Rule</h4><p><img src="/notes/./images/vlsi-design-for-manufacturability/EndToEndSeperationRule.png" alt="End-to-End Seperation Rule"></p><ul><li>如果一條 Wire 的端點的相鄰軌道上有另一條 Wire，那這條 Wire 的末端至少要留 <strong>S2</strong> 的空間</li><li>其他情況只需要預留 <strong>S1</strong> 的空間</li></ul><h4 id="Minimum-Length-Rule"><a href="#Minimum-Length-Rule" class="headerlink" title="Minimum Length Rule"></a>Minimum Length Rule</h4><p>每條線至少要有多長</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/MinimumLengthRule.png" alt="Minimum Length Rule"></p><h3 id="MANA-A-Shortest-Path-MAze-Algorithm-under-Separation-and-Minimum-Length-NAnometer-Rules"><a href="#MANA-A-Shortest-Path-MAze-Algorithm-under-Separation-and-Minimum-Length-NAnometer-Rules" class="headerlink" title="MANA (A Shortest Path MAze Algorithm under Separation and Minimum Length NAnometer Rules)"></a>MANA (A Shortest Path MAze Algorithm under Separation and Minimum Length NAnometer Rules)</h3><p>傳統的 Maze Routing Algorithm 是在 Grid 上找一條最短的路徑，可能用 BFS 或 Dijkstra 等等，但是在 VLSI 設計中，還要考慮一些 <code>Design Rule</code></p><h4 id="考慮到-Design-Rule-的-Maze-Routing-Algorithm"><a href="#考慮到-Design-Rule-的-Maze-Routing-Algorithm" class="headerlink" title="考慮到 Design Rule 的 Maze Routing Algorithm"></a>考慮到 Design Rule 的 Maze Routing Algorithm</h4><ul><li><p>Post-Processing<br>把找到的路徑再做一些調整，像是延伸 Wire，讓他們符合先前提到的 <code>Design Rule</code>，不過這方法沒那麼好，會花很多資源</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/PostProcessing.png" alt="Post-Processing"></p></li><li><p>增強型 Maze Routing Algorithm<br>在找路徑的時候就考慮 <code>Design Rule</code>，像是「每條 Wire 至少要有多長」<br><img src="/notes/./images/vlsi-design-for-manufacturability/EnhancedMazeRoutingAlgorithm.png" alt="Enhanced Maze Routing Algorithm"></p><p>不能直接用個 L 型的 Wire，每一層要馬是水平，要馬是垂直</p></li></ul><h5 id="End-end-separation-rule-handling"><a href="#End-end-separation-rule-handling" class="headerlink" title="End-end separation rule handling"></a>End-end separation rule handling</h5><p>檢查每個 grid point，如果這個 grid point 不能滿足 <code>End-end separation</code>，就把它濾掉</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/EndEndSeparationRuleHandling.png" alt="End-end separation rule handling"></p><h5 id="Minimum-length-rule-handling"><a href="#Minimum-length-rule-handling" class="headerlink" title="Minimum length rule handling"></a>Minimum length rule handling</h5><p>在做 Maze Routing 的時候，要看這條 wire 有沒有足夠的空間做 extension</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/MinimumLengthRuleHandling.png" alt="Minimum length rule handling"></p><h4 id="Find-a-Shortest-Path"><a href="#Find-a-Shortest-Path" class="headerlink" title="Find a Shortest Path"></a>Find a Shortest Path</h4><ul><li>Min Length: 全部的 wire 長度加起來，不包含最後一段的 extension</li><li>Max Length: 全部的 wire 長度加起來，包含最後一段的 extension</li></ul><p><img src="/notes/./images/vlsi-design-for-manufacturability/FindAShortestPath.png" alt="Find a Shortest Path"></p><h4 id="Polynomial-time-complexity"><a href="#Polynomial-time-complexity" class="headerlink" title="Polynomial time complexity"></a>Polynomial time complexity</h4><p>對不需要的 partial path 做 pruning，可以達到 Polynomial time complexity</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/PolynomialTimeComplexityExample.png" alt="Polynomial time complexity Example"></p><p>像是這邊可以只保留 $P^\prime$，捨棄 $P$</p><h5 id="Pruning-Strategy"><a href="#Pruning-Strategy" class="headerlink" title="Pruning Strategy"></a>Pruning Strategy</h5><ul><li><p>Stradgy 1</p><p>如果 $\text{minlen}(P) \geq \text{maxlen}(P^\prime)$，就捨棄 $P$</p></li></ul><p><img src="/notes/./images/vlsi-design-for-manufacturability/PruningStrategy1.png" alt="Pruning Strategy 1"></p><ul><li><p>Stradgy 2</p><p>如果 $\text{maxlen}(P) &#x3D; \text{maxlen}(P^\prime)$ 且 $\text{minlen}(P) &#x3D; \text{minlen}(P^\prime)$，兩個一樣好，捨棄其中一個即可</p></li></ul><p><img src="/notes/./images/vlsi-design-for-manufacturability/PruningStrategy2.png" alt="Pruning Strategy 2"></p><h4 id="Best-Cost-First-Expansion"><a href="#Best-Cost-First-Expansion" class="headerlink" title="Best Cost-First Expansion"></a>Best Cost-First Expansion</h4><p>Maze Routing 的演算法本質上是還是 A*-Search，要考慮某個 grid point 和 destination 的 manhattan distance，才能夠有方向性，所以</p><p>$$<br>\text{Cost}(P) &#x3D; \text{maxlen}(P) + \text{Manhattan dist.}<br>$$</p><p><img src="/notes/./images/vlsi-design-for-manufacturability/AStarSearch.png" alt="A-Star Search"></p>]]></content>
    
    
    
    <tags>
      
      <tag>VLSI</tag>
      
      <tag>DFM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Machine Learning - Basic Concepts</title>
    <link href="/notes/2025/03/06/machine-learning-1/"/>
    <url>/notes/2025/03/06/machine-learning-1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>惡補 ML <a href="https://www.youtube.com/watch?v=Ye018rCVvOo&list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J">https://www.youtube.com/watch?v=Ye018rCVvOo&amp;list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J</a></p></blockquote><h2 id="機器學習基本概念"><a href="#機器學習基本概念" class="headerlink" title="機器學習基本概念"></a>機器學習基本概念</h2><p>機器學習的核心是讓機器根據資料學習一個模型（function），讓新的輸入做出相對的預測或決策。</p><h3 id="分類"><a href="#分類" class="headerlink" title="分類"></a>分類</h3><ul><li>Regression<ul><li>ex: 預測東西</li></ul></li><li>Classification<ul><li>ex: Alphago</li></ul></li><li>Structured Learning<ul><li>創造東西，ex: 生成式?</li></ul></li></ul><h3 id="機器學習的-Framework"><a href="#機器學習的-Framework" class="headerlink" title="機器學習的 Framework"></a>機器學習的 Framework</h3><ol><li><p>找 Model ，ex:$y &#x3D; b + wx$</p><ul><li>帶有未知 parameter 的 function 稱為 <code>Model</code></li><li>$x$ 稱為 <code>feature</code>，為 <strong>輸入給模型的資料</strong></li><li>$w$ 稱為 <code>weight</code></li><li>$b$ 稱為 <code>bias</code></li></ul></li><li><p>定義 <code>Loss Function</code>，ex: $L(b, w)$</p><ul><li>假設一開始是 $b &#x3D; 0.5$、$w &#x3D; 1$，就以 $y &#x3D; 0.5 + 1x$ 來算出 <code>每一筆資料的計算結果</code> 與 <code>label</code> 之間的誤差 $e$<ul><li>實際上正確的 $y$ 稱為 <code>label</code><br>計算誤差的方法有很多，像是<ul><li>MAE(Mean Absolute Error): $e &#x3D; \lvert y - \hat{y} \rvert$</li><li>MSE(Mean Square Error): $e &#x3D; (y - \hat{y})^2$</li><li>Cross-entropy</li></ul></li></ul></li><li>算好後把每個 $e$ 套入 <code>Loss Function</code><ul><li>ex: $L &#x3D; \frac{1}{N}\Sigma_{n}e_n$</li></ul></li></ul></li><li><p>Optimization，找到 $w$ 和 $b$ 能夠讓 <code>Loss Function</code> 算出最小的值</p><ul><li>Gradient Descent<ol><li>隨便選一個 $w_0$、$b_0$</li><li>計算斜率，以 $w$ 為例，$\eta \cdot \frac{\partial L}{\partial w}|_{w&#x3D;w^0, b&#x3D;b^0}$<ul><li>$\eta$ 是 <code>learning rate</code>，需要自己設定<ul><li>這種要自己設定的值稱為 <code>hyperparameter</code></li></ul></li></ul></li><li>更新 $w$ 和 $b$，以 $w$ 為例，$w^1 &#x3D; w^0 - \eta \cdot \frac{\partial L}{\partial w}|_{w&#x3D;w^0, b&#x3D;b^0}$</li><li>持續更新，最後 $L$ 會接近 <code>local minimum</code> 或 <code>global minimum</code> 附近</li></ol></li></ul></li></ol><p>實際上在算 Gradient 的時候，不會每次都拿所有訓練資料去算，會把所有訓練資料隨便分成很多 <code>Batch</code>，每次都拿一個 <code>Batch</code> 算出 Gradient，叫做一次 <code>update</code>，如果把所有 <code>Batch</code> 都看過一輪，叫做一個 <code>epoch</code></p><p>此外，上面的 Model 是定為 $y &#x3D; b + wx$，但實際上這種 <code>Linear Model</code> 可能不足以描述現實情況，也就是 Model 不夠力，稱為 <code>Model Bias</code>，這時候可以加入更多 <code>Feature</code>，定出一個更複雜的 Model</p><ul><li>Piecewise Linear</li></ul><p><img src="https://optimization.cbe.cornell.edu/images/thumb/9/93/Numerical_example.jpg/680px-Numerical_example.jpg" alt="Piecewise Linear"></p><p>現實中可能是 <code>Continuous Function</code>，可以用 <code>Piecewise Linear</code> 來模擬，<code>Piecewise Linear</code> 又可以用很多不同的 <code>Hard Sigmoid</code> 來組合出來，而 <code>Hard Sigmoid</code> 又可以由 <code>Sigmoid Function</code> 模擬出來</p><p><img src="https://www.researchgate.net/publication/368305965/figure/fig4/AS:11431281118383692@1675742756740/Comparison-diagram-of-sigmoid-and-hard-sigmoid.png" alt="Sigmoid vs Hard Sigmoid"></p><ul><li>Sigmoid Function<br>$$c \cdot sigmoid(b+wx_1) &#x3D; y &#x3D; c \cdot \frac{1}{1+e^{-b+wx_1}}$$</li></ul><p><code>Hard Sigmoid</code> 也能用兩個 <code>ReLU (Rectified Linear Unit)</code> 算出</p><p><img src="https://machinelearningmastery.com/wp-content/uploads/2018/10/Line-Plot-of-Rectified-Linear-Activation-for-Negative-and-Positive-Inputs.png" alt="ReLU"></p><h2 id="機器學習的任務攻略"><a href="#機器學習的任務攻略" class="headerlink" title="機器學習的任務攻略"></a>機器學習的任務攻略</h2><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*KmNACQdl5FvoXvQt5n41nQ.png" alt="機器學習的任務攻略"></p><ul><li><p>Model Bias<br>模型不給力</p></li><li><p>Optimization<br>可能是 Optimization 的方式有問題，像是 <code>Gradient Descent</code> 不給力</p></li></ul><p>透過比較不同模型的來區分是不是 Model 的問題</p><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Rl5VIRnXCJbvR6e6cTsZcg.png" alt="Model Bias v.s. Optimization Issue"></p><p>像這個例子中， <code>20-layer</code> 在 <code>Traning Data</code> 上表現的還比 <code>56-layer</code> 好，就可以知道是 <code>Optimization</code> 的問題。可以先測比較淺的 Model 或是比較簡單的 Model，比較不會有 Optimization 的問題。</p><ul><li>Overfitting<br>Traning Data 表現好，Testing Data 表現很爛<ul><li>增加 Traning Data</li><li>Data augmentation<br>根據理解創造出新的資料，ex: 翻轉圖片、放大圖片等</li><li>限制模型，不要讓他彈性那麼大，ex: 減少 <code>Feature</code>、減少 <code>Parameter</code>、Sharing Parameter、Early Stopping、Regularization、Dropout 等</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Machine Learning - Training Difficulties</title>
    <link href="/notes/2025/03/06/machine-learning-2/"/>
    <url>/notes/2025/03/06/machine-learning-2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>惡補 ML <a href="https://www.youtube.com/watch?v=Ye018rCVvOo&list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J">https://www.youtube.com/watch?v=Ye018rCVvOo&amp;list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J</a></p></blockquote><h2 id="類神經網路訓練不起來"><a href="#類神經網路訓練不起來" class="headerlink" title="類神經網路訓練不起來"></a>類神經網路訓練不起來</h2><h3 id="卡在-Critical-Point"><a href="#卡在-Critical-Point" class="headerlink" title="卡在 Critical Point"></a>卡在 <code>Critical Point</code></h3><ul><li><code>Local Minimum</code></li><li><code>Saddle Point</code></li></ul><p><img src="https://media.geeksforgeeks.org/wp-content/uploads/20240829080037/Saddle-Points-02.webp" alt="Saddle Point"></p><h3 id="泰勒展開式"><a href="#泰勒展開式" class="headerlink" title="泰勒展開式"></a>泰勒展開式</h3><p>對於 $L(\theta)$，在 $\theta &#x3D; \theta^\prime$ 可以被近似為：</p><p>$$<br>L(\theta) \approx L(\theta^\prime) + (\theta - \theta^\prime)^T \cdot g + \frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime)<br>$$</p><ul><li>$g$ 為 Gradient Vector，$g &#x3D; \nabla L(\theta^\prime)$</li><li>$H$ 為 Hessian Matrix，$H &#x3D; \nabla^2 L(\theta^\prime)$</li></ul><p>當走到 <code>Critical Point</code> 時，Gradient 會等於 0，所以可以得到：</p><p>$$<br>L(\theta) \approx L(\theta^\prime) + \frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime)<br>$$</p><p>因此可以利用 <code>Hessian Matrix</code> 來判斷是 <code>Local Minimum</code> 、 <code>Local Maximum</code> 還是 <code>Saddle Point</code></p><ul><li>當 $\frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime) &gt; 0$ 時，可以知道任何在 $\theta^\prime$ 附近的 $\theta$，$L(\theta) &gt; L(\theta^\prime)$ ，所以 $L(\theta^\prime)$ 是 <code>Local Minimum</code></li><li>當 $\frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime) &lt; 0$ 時，可以知道任何在 $\theta^\prime$ 附近的 $\theta$，$L(\theta) &lt; L(\theta^\prime)$ ，所以 $L(\theta^\prime)$ 是 <code>Local Maximum</code></li><li>當 $\frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime)$ 有時候大於 0 有時候小於 0 時， $\theta^\prime$ 是 <code>Saddle Point</code></li></ul><p>基於線性代數的知識，可以知道 <code>Hessian Matrix</code> 是 <code>Symmetric Matrix</code>，所以可以透過 <code>Eigenvalue</code> 來判斷是 <code>Local Minimum</code> 、 <code>Local Maximum</code> 還是 <code>Saddle Point</code></p><ul><li>當 <code>Hessian Matrix</code> 的 <code>Eigenvalue</code> 全部大於 0 時，是 <code>Local Minimum</code></li><li>當 <code>Hessian Matrix</code> 的 <code>Eigenvalue</code> 全部小於 0 時，是 <code>Local Maximum</code></li><li>當 <code>Hessian Matrix</code> 的 <code>Eigenvalue</code> 有正有負時，是 <code>Saddle Point</code></li></ul><p>如果是 <code>Saddle Point</code>，可以透過 Hessian Matrix 來判斷出 Loss 更小的方向，然後往那個方向走：</p><p>$$<br>L(\theta) \approx L(\theta^\prime) + \frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime)<br>$$</p><p>假設 $u$ 是 <code>Hessian Matrix</code> 的 <code>Eigen vector</code>，$\lambda$ 是 <code>Eigen value</code>，可以得到：</p><p>$$<br>u^T \cdot H \cdot u &#x3D; u^T \cdot (\lambda \cdot u) &#x3D; \lambda \lVert u \rVert^2<br>$$</p><p>當 $(\theta - \theta^\prime) &#x3D; u$ 且 $\lambda &lt; 0$ 時：</p><p>$$<br>\frac{1}{2}(\theta - \theta^\prime)^T \cdot H \cdot (\theta - \theta^\prime) &#x3D; \frac{1}{2}u^T \cdot H \cdot u &#x3D; \frac{1}{2}\lambda \lVert u \rVert^2 &lt; 0<br>$$</p><p>可以知道 $L(\theta) &lt; L(\theta^\prime)$。因此如果讓 $\theta^\prime$ 往 $u$ 的方向走，$\theta^\prime + u &#x3D; \theta$，可以得到更小 Loss 的 $\theta$。</p><p>這只是一種解法，在實作上計算量很大，沒有人會這樣做。</p><p>此外，實際上 <code>Local minimum</code> 並不常見，Loss 下不去常常是卡在 <code>Saddle Point</code>，但是用一般的 <code>Gradient Descent</code> 通常不會卡在 <code>Critical Point</code>。</p><h3 id="為什麼要用-Batch"><a href="#為什麼要用-Batch" class="headerlink" title="為什麼要用 Batch"></a>為什麼要用 Batch</h3><ul><li><p>Batch size &#x3D; N(Full Batch)</p><ul><li>一次拿所有資料去算 Gradient</li><li>每一次的 Gradient 都很穩定</li><li>理論上花的時間比較多，但考慮到平行運算，若以 epoch 為單位，實際上可能更快</li></ul></li><li><p>Batch size &#x3D; 1</p><ul><li>一次只拿一筆資料去算 Gradient</li><li>每一次的 Gradient 都很不穩定，可能會跳來跳去</li></ul></li></ul><p><img src="/notes/./images/machine-learning/diff-batch-size.png" alt="Different Batch Size"></p><p>既然時間差不多，乍看之下 Batch Size 大一點比較好，但實際上小的 Batch Size 可能會有更好的訓練效果</p><p><img src="/notes/./images/machine-learning/diff-batch-size-2.png" alt="Different Batch Size"></p><p>上圖可以看到小的 Batch Size Optimization 的效果會比較好</p><table><thead><tr><th align="center"></th><th align="center">Batch Size 小</th><th align="center">Batch Size 大</th></tr></thead><tbody><tr><td align="center">每次 update (沒有平行運算)</td><td align="center">快</td><td align="center">慢</td></tr><tr><td align="center">每次 update (有平行運算)</td><td align="center">一樣</td><td align="center">一樣 (在不是超大的情況下)</td></tr><tr><td align="center">每個 epoch</td><td align="center">慢</td><td align="center">快</td></tr><tr><td align="center">Gradient 的穩定性</td><td align="center">差</td><td align="center">穩定</td></tr><tr><td align="center">Optimization 的效果</td><td align="center">好</td><td align="center">差</td></tr></tbody></table><h3 id="Momentum"><a href="#Momentum" class="headerlink" title="Momentum"></a>Momentum</h3><ul><li><p>一般的 Gradient Descent</p><ul><li>$\theta_{t+1} &#x3D; \theta_t - \eta \cdot \nabla L(\theta_t)$</li></ul></li><li><p>Momentum</p><p>$$<br>\begin{aligned}<br>\texttt{Start at} \quad \theta^0 \newline<br>\texttt{Movement} \quad m^0 &amp;&#x3D; 0 \newline<br>\texttt{Compute gradient} \quad g^0 \newline<br>\texttt{Movement} \quad m^1 &amp;&#x3D; \lambda \cdot m^0 - \eta \cdot g^0 \newline<br>\texttt{Move to} \quad \theta^1 &amp;&#x3D; \theta^0 + m^1 \newline<br>\texttt{Compute gradient} \quad g^1 \newline<br>\texttt{Movement} \quad m^2 &amp;&#x3D; \lambda \cdot m^1 - \eta \cdot g^1 \newline<br>\texttt{Move to} \quad \theta^2 &amp;&#x3D; \theta^1 + m^2 \newline<br>\end{aligned}<br>$$</p><p>$m^i$ 就像是所有過去 <code>Weighted Gradient</code> 的總和，$g^0, g^1, \cdots g^{i-1}$</p><p>$$<br>\begin{aligned}<br>m^0 &amp;&#x3D; 0 \newline<br>m^1 &amp;&#x3D; \lambda \cdot m^0 - \eta \cdot g^0 \newline<br>&amp;&#x3D; -\eta \cdot g^0 \newline<br>m^2 &amp;&#x3D; \lambda \cdot m^1 - \eta \cdot g^1 \newline<br>&amp;&#x3D; \lambda \cdot (-\eta \cdot g^0) - \eta \cdot g^1<br>\end{aligned}<br>$$</p><p><img src="https://i.imgur.com/DdabCqX.png" alt="Momentum"></p></li></ul><h3 id="Learning-Rate"><a href="#Learning-Rate" class="headerlink" title="Learning Rate"></a>Learning Rate</h3><h4 id="一般情況下的-Learning-Rate-造成的問題"><a href="#一般情況下的-Learning-Rate-造成的問題" class="headerlink" title="一般情況下的 Learning Rate 造成的問題"></a>一般情況下的 Learning Rate 造成的問題</h4><p><img src="/notes/./images/machine-learning/LearningRate.png" alt="Learning Rate"></p><ul><li>當 <code>Learning Rate</code> 設定太大時，可能會造成 <code>Oscillation</code> 的問題，Loss 會一直在上下跳動，無法收斂</li><li>當 <code>Learning Rate</code> 設定太小時，可能會造成 <code>Convergence</code> 的問題，Loss 會一直往下收斂，但是收斂的速度很慢。就像上圖一樣，當 <code>Gradient</code> 很大時，沒什麼問題，但是當 <code>Gradient</code> 很小時，就會卡住</li></ul><p>上述例子中，每個參數的 <code>Learning Rate</code> 都是一樣的，但是實際上每個參數的 <code>Gradient</code> 都不一樣，應該要為每個參數的 <code>Learning Rate</code> 客製化。</p><h4 id="AdaGrad-Adaptive-Gradient"><a href="#AdaGrad-Adaptive-Gradient" class="headerlink" title="AdaGrad (Adaptive Gradient)"></a>AdaGrad (Adaptive Gradient)</h4><p>用 <code>Root Mean Square</code> 來調整 <code>Learning Rate</code></p><p>$$<br>\begin{aligned}<br>\theta^1_i \leftarrow \theta^0_i - \frac{\eta}{\sigma^0_i} \cdot g^0_i &amp;\quad \sigma^0_i &#x3D; \sqrt{(g^0_i)^2} &#x3D; \lvert g^0_i \rvert \newline<br>\theta^2_i \leftarrow \theta^1_i - \frac{\eta}{\sigma^1_i} \cdot g^1_i &amp;\quad \sigma^1_i &#x3D; \sqrt{\frac{1}{2} \cdot [(g^0_i)^2 + (g^1_i)^2]} \newline<br>\theta^3_i \leftarrow \theta^2_i - \frac{\eta}{\sigma^2_i} \cdot g^2_i &amp;\quad \sigma^2_i &#x3D; \sqrt{\frac{1}{3} \cdot [(g^0_i)^2 + (g^1_i)^2 + (g^2_i)^2]} \newline<br>\vdots \newline<br>\theta^{t+1}_i \leftarrow \theta^t_i - \frac{\eta}{\sigma^t_i} \cdot g^t_i &amp;\quad \sigma^t_i &#x3D; \sqrt{\frac{1}{t} \cdot \sum^t_k (g^k_i)^2}<br>\end{aligned}<br>$$</p><p>從公式可以觀察到，當坡度小的時候，<code>Gradient</code> 會比較小，算出來的 $\sigma$ 也會比較小，所以 <code>Learning Rate</code> 會比較大，反之亦然。</p><p>然而，當 <code>t</code> 很大時，當前的 <code>Gradient</code> 可能會被過去累積的 <code>Gradient</code> 稀釋掉，導致收斂速度變慢，不能實時考慮梯度的變化情況。</p><h4 id="RMSprop"><a href="#RMSprop" class="headerlink" title="RMSprop"></a>RMSprop</h4><p><code>RMSprop</code> 增加了 <code>Decay Rate</code> $\alpha$，可以控制 <strong>當前的 <code>Gradient</code></strong> 和 <strong>過去累積的 <code>Gradient</code></strong> 的重要程度</p><p>$$<br>\begin{aligned}<br>\theta^1_i \leftarrow \theta^0_i - \frac{\eta}{\sigma^0_i} \cdot g^0_i &amp;\quad \sigma^0_i &#x3D; \sqrt{(g^0_i)^2} &#x3D; \lvert g^0_i \rvert \newline<br>\theta^2_i \leftarrow \theta^1_i - \frac{\eta}{\sigma^1_i} \cdot g^1_i &amp;\quad \sigma^1_i &#x3D; \sqrt{\alpha \cdot (\sigma^0_i)^2 + (1 - \alpha) \cdot (g^1_i)^2} \newline<br>\theta^3_i \leftarrow \theta^2_i - \frac{\eta}{\sigma^2_i} \cdot g^2_i &amp;\quad \sigma^2_i &#x3D; \sqrt{\alpha \cdot (\sigma^1_i)^2 + (1 - \alpha) \cdot (g^2_i)^2} \newline<br>\vdots \newline<br>\theta^{t+1}_i \leftarrow \theta^t_i - \frac{\eta}{\sigma^t_i} \cdot g^t_i &amp;\quad \sigma^t_i &#x3D; \sqrt{\alpha \cdot (\sigma^{t-1}_i)^2 + (1 - \alpha) \cdot (g^t_i)^2}<br>\end{aligned}<br>$$</p><ul><li>$\alpha$ 為 <code>Decay Rate</code>，通常設為 0.9</li></ul><p>最常用的 <code>Optimizer</code> 是 <code>Adam</code>，他就是 <code>RMSprop</code> 和 <code>Momentum</code> 的結合</p><h4 id="Learning-Rate-Scheduling"><a href="#Learning-Rate-Scheduling" class="headerlink" title="Learning Rate Scheduling"></a>Learning Rate Scheduling</h4><ul><li><p>Learning Rate Decay</p><p>隨著參數的更新，<code>Learning Rate</code> 逐漸變小</p><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*iFCd4c6Bq8vQgFHpxTXFUA.png" alt="Learning Rate Decay"></p><p>左邊是 <code>AdaGrad</code>，當縱軸的 <code>Gradient</code> 一直都是很小的值時，會導致 $\sigma$ 變得很小，造成 <code>Learning Rate</code> 放的很大，因此會飛出去。右邊是加上 <code>Learning Rate Decay</code>。</p></li><li><p>Warm Up</p><p>在一開始的時候，<code>Learning Rate</code> 會比較小，然後逐漸變大，最後再變小</p><p><img src="/notes/./images/machine-learning/WarmUp.png" alt="Warm Up"></p></li></ul><h3 id="Loss-Function"><a href="#Loss-Function" class="headerlink" title="Loss Function"></a>Loss Function</h3><p><code>Loss Function</code> 也會影響到 <code>Optimization</code> 的效果，這邊以分類問題為例。</p><h4 id="Classification"><a href="#Classification" class="headerlink" title="Classification"></a>Classification</h4><p>在 Classification 的問題中，通常會用 one-hot encoding 來表示 label，例如：</p><p>$$<br>\begin{aligned}<br>\hat{y} &amp;&#x3D; [1, 0, 0] \newline<br>\hat{y} &amp;&#x3D; [0, 1, 0] \newline<br>\hat{y} &amp;&#x3D; [0, 0, 1] \newline<br>\end{aligned}<br>$$</p><p>最後在 Output 的時候，通常會把輸出 <code>y</code> 通過 <code>Softmax</code> 函數，再讓他和 <code>one-hot encoding</code> 的 <code>label</code> 做比較，計算出 <code>Loss</code></p><p>$$<br>\begin{aligned}<br>\text{Softmax}(z)_i &amp;&#x3D; \frac{e^{z_i}}{\sum^n_j e^{z_j}} \newline<br>\hat{y} \leftrightarrow y^\prime &amp;&#x3D; \text{Softmax}(y) \newline<br>\end{aligned}<br>$$</p><ul><li>這裡的 <code>y</code> 稱為 <code>logit</code></li><li><code>Softmax</code> 可以把 <code>Output</code> 變成 <code>Probability</code>，讓 <code>Output</code> 的值在 0 到 1 之間，並且總和為 1</li><li>當只有兩個 Class 時，<code>Softmax</code> 和 <code>Sigmoid</code> 的作用是一樣的</li></ul><h4 id="Loss-Function-of-Classification"><a href="#Loss-Function-of-Classification" class="headerlink" title="Loss Function of Classification"></a>Loss Function of Classification</h4><p>可以直接用 <code>MSE</code>，但是 <code>Cross-entropy</code> 通常表現的比較好</p><ul><li><code>Cross-entropy</code><br>$$L &#x3D; -\sum_{i&#x3D;1}^{n} \hat{y_i} \cdot \ln(\hat{y}_i)$$<ul><li>Minimize <code>Cross-entropy</code> 就是最大化 <code>Likelihood</code></li></ul></li></ul><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*nvX_2FTKK6-e2L-XlxZMrw.png" alt="Cross-entropy"></p><p>上圖可以看到，在 <code>Classfication</code> 問題用 <code>MSE</code> 可能會 train 不起來</p><h4 id="Batch-Normalization"><a href="#Batch-Normalization" class="headerlink" title="Batch Normalization"></a>Batch Normalization</h4><p>有時候在 <code>Error Surface</code> 中，不同維度的輸入值可能差很多，導致 <code>Error Surface</code> 很扭曲，斜率、坡度都不同</p><p><img src="https://miro.medium.com/v2/resize:fit:4800/format:webp/1*XSpgDZ9r7FG6vlE9Rv9kCA.png" alt="Error Surface"></p><p>對於一個 <code>Batch</code> 的資料，對每一個 <code>Feature</code> 做 <code>Feature Normalization</code>，讓他的 <code>Mean</code> 為 0，<code>Variance</code> 為 1，稱為 <code>Batch Normalization</code></p><p>$$<br>\begin{aligned}<br>\mu &amp;&#x3D; \frac{1}{m} \sum_{i&#x3D;1}^{m} x_i \newline<br>\sigma^2 &amp;&#x3D; \frac{1}{m} \sum_{i&#x3D;1}^{m} (x_i - \mu)^2 \newline<br>\hat{x}_i &amp;&#x3D; \frac{x_i - \mu}{\sqrt{\sigma^2 + \epsilon}} \newline<br>\end{aligned}<br>$$</p><h3 id="Regularization"><a href="#Regularization" class="headerlink" title="Regularization"></a>Regularization</h3><p>最常使用 <code>L1</code> 和 <code>L2</code> Regularization，在 <code>Loss Function</code> 中加上 <code>Regularization Term</code>，讓 <code>Model</code> 不要太複雜</p><p>公式來源可以參考 Lagrange Multiplier。</p><h4 id="L1-Regularization"><a href="#L1-Regularization" class="headerlink" title="L1 Regularization"></a>L1 Regularization</h4><p>$$<br>Loss_Fn &#x3D; original_Loss_Fn + \lambda \cdot \sum_{i&#x3D;1}^{n} \lvert w_i \rvert<br>$$</p><h4 id="L2-Regularization"><a href="#L2-Regularization" class="headerlink" title="L2 Regularization"></a>L2 Regularization</h4><p>$$<br>Loss_Fn &#x3D; original_Loss_Fn + \lambda \cdot \sum_{i&#x3D;1}^{n} w_i^2<br>$$</p><p><img src="/notes/./images/machine-learning/Regularization.png" alt="Regularization"></p><h4 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h4><ul><li><a href="https://allen108108.github.io/blog/2019/10/22/L1%20,%20L2%20Regularization%20%E5%88%B0%E5%BA%95%E6%AD%A3%E5%89%87%E5%8C%96%E4%BA%86%E4%BB%80%E9%BA%BC%20_/">L1 , L2 Regularization 到底正則化了什麼 ?</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Machine Learning - Self-Attention &amp; Transformer</title>
    <link href="/notes/2025/03/06/machine-learning-4/"/>
    <url>/notes/2025/03/06/machine-learning-4/</url>
    
    <content type="html"><![CDATA[<blockquote><p>惡補 ML <a href="https://www.youtube.com/watch?v=Ye018rCVvOo&list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J">https://www.youtube.com/watch?v=Ye018rCVvOo&amp;list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J</a></p></blockquote><h2 id="Self-Attention"><a href="#Self-Attention" class="headerlink" title="Self-Attention"></a>Self-Attention</h2><p>先前提到的 <code>Input</code> 都只是一個 <code>Vector</code>，然而很多時候，模型吃的是 <strong>一組 Vector</strong>，又稱 <code>Vector Set</code>、<code>Sequence</code>，又可以分成三類</p><ul><li>每個 <code>Vector</code> 有一個 <code>Label</code>，輸入的數量等於輸出的數量，稱為 <code>Sequence Labeling</code><ul><li>ex: <code>Pos-Tagging</code></li></ul></li><li>整個 <code>Sequence</code> 只有一個 <code>Label</code><ul><li>ex: <code>Sentiment Analysis</code></li></ul></li><li>機器自己決定要有幾個 <code>Label</code><ul><li>ex: <code>Sequence-to-Sequence</code>、<code>Machine Translation</code></li></ul></li></ul><p>對於 <code>Sequence Labeling</code>，如果像前面提到的 <code>CNN</code> 一樣，每個 <code>Vector</code> 都是獨立的，可能會忽略掉 <code>Vector</code> 之間的關係 (Context)。你也可以把整個 <code>Sequence</code> 丟到 <code>CNN</code> 裡面，但參數量、計算量都會超大，又久又容易 <code>Overfitting</code>，因此有了 <code>Self-Attention</code></p><p><img src="https://sebastianraschka.com/images/blog/2023/self-attention-from-scratch/summary.png" alt="https://sebastianraschka.com/blog/2023/self-attention-from-scratch.html"></p><p><code>Self-Attention</code> 的概念是，對於每個 <code>Vector</code>，都會有一個 <code>Query</code>、<code>Key</code>、<code>Value</code>，然後透過 <code>Query</code> 和 <code>Key</code> 的 <code>Dot Product</code> 來計算 <code>Attention Score</code>，再透過 <code>Softmax</code> 來計算 <code>Attention Weight</code>，最後再把 <code>Value</code> 乘上 <code>Attention Weight</code> 來得到 <code>Output</code></p><ul><li><code>Softmax</code> 是最常見的，不過也可以用別的 <code>Activation Function</code></li><li><code>Attention Weight</code> 會讓 <code>Model</code> 知道哪些 <code>Vector</code> 是重要的，哪些是不重要的</li></ul><h3 id="Multi-Head-Self-Attention"><a href="#Multi-Head-Self-Attention" class="headerlink" title="Multi-Head Self-Attention"></a>Multi-Head Self-Attention</h3><p>相關這件事情可能有很多種形式，為了要找到資料中不同種類的相關性，可以用 <code>Multi-Head Self-Attention</code></p><ul><li>Head 的數量也是 <code>Hyperparameter</code></li></ul><p><img src="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff406d55e-990a-4e3b-be82-d966eb74a3e7_1766x1154.png" alt="https://magazine.sebastianraschka.com/p/understanding-and-coding-self-attention"></p><h3 id="Positional-Encoding"><a href="#Positional-Encoding" class="headerlink" title="Positional Encoding"></a>Positional Encoding</h3><p><code>Self-Attention</code> 並不會考慮到 <code>Position</code>，因此需要加上 <code>Positional Encoding</code>，讓 <code>Model</code> 知道 <code>Vector</code> 的位置</p><p><img src="https://i.imgur.com/QYpn2J3.png" alt="Positional Encoding"></p><h3 id="Truncated-Self-Attention"><a href="#Truncated-Self-Attention" class="headerlink" title="Truncated Self-Attention"></a>Truncated Self-Attention</h3><p>有時候 <code>Sequence</code> 會超長，造成 <code>Attention Matrix</code> 太大，計算量太大，甚至 Train 不起來，因此可以用 <code>Truncated Self-Attention</code>，只考慮某距離以內的 <code>Vector</code>，不考慮太遠的 <code>Vector</code></p><p><img src="https://lh5.googleusercontent.com/E-BGMJXwdWbYORmuf9OFvIDZ9ciriH88oWI8otaIjJDNuCyYvdFMtAeR7HqbbhK_WwHSLhMGyr77wBh7W1_kB1AQ9XAdouBsONFfqWltGXxlqtclXC7uRUU5NUxwFU80JHhIHDE" alt="Truncated Self-Attention"></p><h3 id="Self-Attention-vs-CNN"><a href="#Self-Attention-vs-CNN" class="headerlink" title="Self-Attention vs CNN"></a>Self-Attention vs CNN</h3><p>一般圖片都是用 <code>CNN</code> 來處理，但其實 <code>CNN</code> 是 <code>Self-Attention</code> 的一種，只是 <code>CNN</code> 會考慮到 <code>Local Pattern</code>，而 <code>Self-Attention</code> 會考慮到 <code>Global Pattern</code></p><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*IRvXQeATmX0JxJxz45_XUA.png" alt="Self-Attention vs CNN"></p><p><code>Self-Attention</code> 就是一種更彈性的 <code>CNN</code>，因此在訓練資料很大的時候，<code>Self-Attention</code> 可能比 <code>CNN</code> 更好</p><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*2xKkjuDVe8zTUa6lVf3QGw.png" alt="Self-Attention vs CNN"></p><h3 id="Self-Attention-vs-RNN"><a href="#Self-Attention-vs-RNN" class="headerlink" title="Self-Attention vs RNN"></a>Self-Attention vs RNN</h3><p>現在 <code>RNN</code> 幾乎被 <code>Self-Attention</code> 取代，因為 <code>RNN</code> 有兩大缺陷</p><ul><li><code>Long-Term Dependency</code> 的問題，當 <code>Sequence</code> 很長時，很容易忘記越早輸入進來的資料</li><li>只能 <code>Sequential</code> 計算，無法平行運算</li></ul><p><img src="https://miro.medium.com/v2/resize:fit:1400/1*qATp1B0W4BK0J4IL-sIsig.png" alt="Self-Attention vs RNN"></p><h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p>是一個 <code>Sequence-to-Sequence</code> 的模型，由機器自己決定輸出的長度，常用在 <code>Machine Translation</code>、<code>Speech Recognition</code>、<code>Speech Translation</code>、<code>Chatbot</code></p><p>大部分的 NLP 問題都可以直接看成 <code>QA</code> 問題，而 <code>QA</code> 問題都可以看成 <code>Sequence-to-Sequence</code> 的問題，只要把 <code>Question</code> 和 <code>Context</code> 組合在一起，丟進 <code>Sequence-to-Sequence</code> 的模型裡面，就可以得到答案。但是 NLP 的問題中，客製化模型的表現通常會更好。</p><p>有很多應用都可以硬用 <code>Sequence-to-Sequence</code> 的模型，像是 <code>Syntacic Parsing</code>，可以把這棵樹轉成 <code>Sequence</code>，直接塞進 <code>Sequence-to-Sequence</code> 的模型裡。其他還有 <code>Multi-label Classification</code>、<code>Object Detection</code> 等</p><h3 id="Sequence-to-Sequence-Structure"><a href="#Sequence-to-Sequence-Structure" class="headerlink" title="Sequence-to-Sequence Structure"></a>Sequence-to-Sequence Structure</h3><p>Transformer 的 Encoder 就像一位記憶力超強的老師，他把一整本書（你的輸入句子）讀完，並且整理出一本精華筆記（Encoder 的輸出）。<br>然後，Decoder 是一個學生，他想要用自己的話來解釋這本書的內容（生成輸出句子）。</p><p>但這位學生不會一次就把整本書背出來，而是一步一步地問老師：「接下來我要怎麼說？」<br>每當學生說出一個單詞，他就會回頭看看老師的筆記（Cross-Attention），確認自己沒說錯，然後再繼續下一個單詞。</p><p>所以，Encoder 負責總結資訊，Decoder 負責一步步產生句子，並透過 Cross-Attention 確保自己說的話合理。</p><h4 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h4><p><img src="/notes/./images/machine-learning/Encoder.png" alt="Encoder"><br><img src="/notes/./images/machine-learning/Encoder-1.png" alt="Encoder"></p><h4 id="Decoder-Autoregressive"><a href="#Decoder-Autoregressive" class="headerlink" title="Decoder - Autoregressive"></a>Decoder - Autoregressive</h4>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Machine Learning - CNN</title>
    <link href="/notes/2025/03/06/machine-learning-3/"/>
    <url>/notes/2025/03/06/machine-learning-3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>惡補 ML <a href="https://www.youtube.com/watch?v=Ye018rCVvOo&list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J">https://www.youtube.com/watch?v=Ye018rCVvOo&amp;list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J</a></p></blockquote><h2 id="Convolutional-Neural-Network-CNN"><a href="#Convolutional-Neural-Network-CNN" class="headerlink" title="Convolutional Neural Network (CNN)"></a>Convolutional Neural Network (CNN)</h2><p>如果用 <code>Fully Connected Network</code> 的方式來做圖片的分類，會有很多參數，雖然可以增加 Model 的彈性，但也會增加 <code>Overfitting</code> 的風險</p><p><img src="/notes/./images/machine-learning/CNN-1.png" alt="Fully Connected Network"></p><p>像上圖這個例子，圖片大小是 <code>100 x 100</code>，算上 <code>RGB</code> 三個 Channel，就有 <code>100 x 100 x 3</code> 個 <code>Feature</code>，第一層有 <code>1000</code> 個 <code>Neuron</code>，每個 <code>Neuron</code> 對於這 <code>100 x 100 x 3</code> 個 <code>Feature</code> 都有一個 <code>Weight</code>，所以總共有 <code>100 x 100 x 3 x 1000</code> 個 <code>Weight</code></p><h3 id="Receptive-Field"><a href="#Receptive-Field" class="headerlink" title="Receptive Field"></a>Receptive Field</h3><p>然而對於圖片辨識來說，他只在乎圖片有沒有重要的 <code>Pattern</code>，因此這些 <code>Neuron</code> 其實不用把整張圖片當作輸入，只要關心自己的 <code>Receptive Field</code> 就好</p><p><img src="/notes/./images/machine-learning/ReceptiveField.png" alt="Receptive Field"></p><p>典型的設置方式是像下圖</p><ul><li>會檢查所有 <code>Channel</code></li><li><code>Kernel Size</code>: <code>3 x 3</code></li><li><code>Stride</code>: 通常是 <code>1</code> 或 <code>2</code>，避免有些 <code>Pattern</code> 被忽略</li><li>超出去的部分要補 <code>Padding</code></li><li>每個 <code>Receptive Field</code> 會有一組 <code>Neuron</code> 看著</li></ul><p><img src="/notes/./images/machine-learning/CNNTypicalSetting.png" alt="CNN Typical Setting"></p><p>雖然 <code>Kernel Size</code> 只有 <code>3 x 3</code>，但當 Model 疊的越深，每個 <code>Receptive Field</code> 就會看到更大的 <code>Pattern</code>，不用擔心太大的 <code>Pattern</code> 偵測不到</p><h3 id="Shared-Parameter"><a href="#Shared-Parameter" class="headerlink" title="Shared Parameter"></a>Shared Parameter</h3><p>有時候同樣的 <code>Pattern</code> 會在不同圖片的不同位置出現，這些 <code>Neuron</code> 做的事情其實是一樣的</p><p><img src="/notes/./images/machine-learning/SamePatternDifferentRegions.png" alt="Same Pattern Different Regions"></p><p>這時候可以用 <code>Shared Parameter</code> 來解決，讓不同的 <code>Receptive Field</code> 的不同 <code>Neuron</code> 用同樣的 <code>Weight</code>，減少參數。(在實作上，其實就是一個 <code>Filter</code> 掃過整張圖片)</p><p><img src="/notes/./images/machine-learning/SharedPatameters.png" alt="Shared Patameters"></p><p><code>Fully Connected Network</code> 很彈性，可以做各式各樣的事情，但可能沒辦法在任何特定的任務上做好。<code>CNN</code> 則是專注在圖片辨識上，即使 <code>Model Bias</code> 比較大，比較不會 <code>Overfitting</code></p><p><img src="/notes/./images/machine-learning/CNNBenefit.png" alt="CNN Benefit"></p><h3 id="Pooling"><a href="#Pooling" class="headerlink" title="Pooling"></a>Pooling</h3><p>有時候為了減少運算量，會用 <code>Pooling</code> 來做 <code>Subsampling</code>，通常是 <code>Max Pooling</code> 或 <code>Average Pooling</code></p><p><img src="https://www.researchgate.net/publication/333593451/figure/fig2/AS:765890261966848@1559613876098/llustration-of-Max-Pooling-and-Average-Pooling-Figure-2-above-shows-an-example-of-max.png" alt="Max Pooling &amp; Average Pooling"></p><p>一般都是在 <code>Convolutional Layer</code> 後面接 <code>Pooling Layer</code>，交替使用</p><p><img src="/notes/./images/machine-learning/MaxPooling.png" alt="Max Pooling"></p><p>不過 <code>Pooling</code> 可能會造成 <code>Information Loss</code>，有些比較細微的特徵會偵測不到，因此也有人從頭到尾都只用 <code>Convolution</code>，像是 <code>AlphaGo</code></p><h3 id="CNN-Structure"><a href="#CNN-Structure" class="headerlink" title="CNN Structure"></a>CNN Structure</h3><p>在 <code>CNN</code> 中 <code>Convolutional Layer</code> 和 <code>Pooling Layer</code> 的最後，<code>Flatten</code> 過後會再接幾層 <code>Fully Connected Layer</code>，再接一個 <code>Softmax</code> 來做分類</p><p><img src="/notes/./images/machine-learning/CNNStructure.png" alt="CNN Structure"></p>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Machine Learning - PyTorch</title>
    <link href="/notes/2025/03/06/machine-learning-5/"/>
    <url>/notes/2025/03/06/machine-learning-5/</url>
    
    <content type="html"><![CDATA[<blockquote><p>惡補 ML <a href="https://www.youtube.com/watch?v=Ye018rCVvOo&list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J">https://www.youtube.com/watch?v=Ye018rCVvOo&amp;list=PLJV_el3uVTsMhtt7_Y6sgTHGHp1Vb2P2J</a></p></blockquote><ul><li>PyTorch 是一個開源的機器學習框架<ul><li>可以做 <code>Tensor Computation</code>，像是 <code>Numpy</code>，但可以用 <code>GPU</code> 加速</li><li>可以幫你算 <code>Gradient</code></li></ul></li></ul><h4 id="Tensor"><a href="#Tensor" class="headerlink" title="Tensor"></a>Tensor</h4><ul><li>Tensor: 高維度的矩陣或陣列</li><li>常用的 <code>Data Type</code> 有 <code>torch.float</code>、<code>torch.long</code>、<code>torch.FloatTensor</code>、<code>torch.LongTensor</code> 等</li><li>PyTorch 的 <code>dim</code> 跟 <code>Numpy</code> 的 <code>axis</code> 一樣</li></ul><h5 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h5><ul><li><p>Constructor</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], dtype=torch.<span class="hljs-built_in">float</span>)<br><span class="hljs-comment"># tensor([1., 2., 3., 4.])</span><br><br>x = torch.from_numpy(np.array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]))<br><br>x = toch.zeros(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br><span class="hljs-comment"># tensor([[0., 0., 0.],</span><br><span class="hljs-comment">#         [0., 0., 0.]])</span><br><br>x = torch.ones(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br><span class="hljs-comment"># tensor([[1., 1., 1.],</span><br><span class="hljs-comment">#         [1., 1., 1.]])</span><br></code></pre></td></tr></table></figure></li><li><p>Operators</p><ul><li><code>squeeze</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.zeros([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br><span class="hljs-built_in">print</span>(x.shape)<br><span class="hljs-comment"># torch.Size([1, 2, 3])</span><br>x = x.squeeze(<span class="hljs-number">0</span>) <span class="hljs-comment"># 把第 0 維度的 1 拿掉</span><br><span class="hljs-built_in">print</span>(x.shape)<br><span class="hljs-comment"># torch.Size([2, 3])</span><br></code></pre></td></tr></table></figure></li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs fortran">- `unsqueeze`<br>  ```python<br>  x = torch.zeros([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br>  <span class="hljs-built_in">print</span>(x.<span class="hljs-built_in">shape</span>)<br>  # torch.<span class="hljs-built_in">Size</span>([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br>  x = x.unsqueeze(<span class="hljs-number">1</span>) # 在第 <span class="hljs-number">1</span> 維度插入 <span class="hljs-number">1</span><br>  <span class="hljs-built_in">print</span>(x.<span class="hljs-built_in">shape</span>)<br>  # torch.<span class="hljs-built_in">Size</span>([<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>])<br></code></pre></td></tr></table></figure><ul><li><code>cat</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.zeros([<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>])<br>y = torch.zeros([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>])<br>z = torch.zeros([<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br>w = torch.cat([x, y, z], dim=<span class="hljs-number">1</span>) <span class="hljs-comment"># 合併第 1 維度</span><br><span class="hljs-built_in">print</span>(w.shape)<br><span class="hljs-comment"># torch.Size([2, 6, 3])</span><br></code></pre></td></tr></table></figure></li><li><code>pow</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], dtype=torch.<span class="hljs-built_in">float</span>)<br>x = x.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>)<br><span class="hljs-comment"># tensor([ 1.,  4.,  9., 16.])</span><br></code></pre></td></tr></table></figure></li><li><code>sum</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], dtype=torch.<span class="hljs-built_in">float</span>)<br>x = x.<span class="hljs-built_in">sum</span>()<br><span class="hljs-comment"># tensor(10.)</span><br></code></pre></td></tr></table></figure></li><li><code>mean</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], dtype=torch.<span class="hljs-built_in">float</span>)<br>x = x.mean()<br><span class="hljs-comment"># tensor(2.5000)</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h5 id="vs-Numpy"><a href="#vs-Numpy" class="headerlink" title="vs Numpy"></a>vs Numpy</h5><table><thead><tr><th align="center">PyTorch</th><th align="center">Numpy</th></tr></thead><tbody><tr><td align="center">x.shape</td><td align="center">x.shape</td></tr><tr><td align="center">x.dtype</td><td align="center">x.dtype</td></tr><tr><td align="center">x.reshape() &#x2F; x.view()</td><td align="center">x.reshape()</td></tr><tr><td align="center">x.squeeze()</td><td align="center">x.squeeze()</td></tr><tr><td align="center">x.unsqueeze(1)</td><td align="center">np.expand_dims(x, 1)</td></tr></tbody></table><h5 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h5><p>可以用 <code>toruch.cuda.is_available()</code> 檢查有沒有 <code>GPU</code>，然後用 <code>torch.cuda.device_count()</code> 來看有幾個 <code>GPU</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], dtype=torch.<span class="hljs-built_in">float</span>)<br>x = x.to(<span class="hljs-string">&#x27;cuda&#x27;</span>) <span class="hljs-comment"># 把 tensor 放到 GPU 上計算</span><br></code></pre></td></tr></table></figure><h2 id="DNN-的架構"><a href="#DNN-的架構" class="headerlink" title="DNN 的架構"></a>DNN 的架構</h2><p><img src="/notes/./images/machine-learning/PytorchDNN.png" alt="PyTorch DNN"></p><h3 id="Gradient"><a href="#Gradient" class="headerlink" title="Gradient"></a>Gradient</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor([[<span class="hljs-number">1.</span>, <span class="hljs-number">0.</span>], [-<span class="hljs-number">1.</span>, <span class="hljs-number">1.</span>]], requires_grad=<span class="hljs-literal">True</span>) <span class="hljs-comment"># 設定 requires_grad=True 會記錄 Gradient</span><br>z = x.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>).<span class="hljs-built_in">sum</span>()<br>z.backward() <span class="hljs-comment"># 計算 Gradient</span><br><span class="hljs-built_in">print</span>(x.grad) <span class="hljs-comment"># tensor([[ 2.,  0.],</span><br>              <span class="hljs-comment">#         [-2.,  2.]])</span><br></code></pre></td></tr></table></figure><h3 id="Dataset-DataLoader"><a href="#Dataset-DataLoader" class="headerlink" title="Dataset &amp; DataLoader"></a>Dataset &amp; DataLoader</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset, DataLoader<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-comment"># Read data and preprocess</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.data = ...<br><br>    <span class="hljs-comment"># Returns one sample at a time</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><br>    <span class="hljs-comment"># Returns the size of the dataset</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.data)<br><br>dataset = MyDataset()<br>dataloader = DataLoader(dataset, batch_size=<span class="hljs-number">4</span>, shuffle=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/machine-learning/DatasetDataLoader.png" alt="Dataset &amp; DataLoader"></p><h3 id="Neural-Network-Layers"><a href="#Neural-Network-Layers" class="headerlink" title="Neural Network Layers"></a>Neural Network Layers</h3><p>Linear Layer (Fully-connected Layer)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">layer = torch.nn.Linear(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>) <span class="hljs-comment"># 32 -&gt; 64</span><br><span class="hljs-built_in">print</span>(layer.weight.shape)<br><span class="hljs-comment"># torch.Size([64, 32])</span><br><span class="hljs-built_in">print</span>(layer.bias.shape)<br><span class="hljs-comment"># torch.Size([64])</span><br></code></pre></td></tr></table></figure><h3 id="Activation-Function"><a href="#Activation-Function" class="headerlink" title="Activation Function"></a>Activation Function</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">nn.ReLU()<br>nn.Sigmoid()<br>nn.Tanh()<br>nn.Softmax()<br></code></pre></td></tr></table></figure><h3 id="Loss-Function"><a href="#Loss-Function" class="headerlink" title="Loss Function"></a>Loss Function</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">nn.MSELoss()<br>nn.CrossEntropyLoss()<br></code></pre></td></tr></table></figure><h3 id="Optimizer"><a href="#Optimizer" class="headerlink" title="Optimizer"></a>Optimizer</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.optim.SGD(model.parameters(), lr, momentum) <span class="hljs-comment"># Stoachastic Gradient Descent</span><br>torch.optim.Adam(model.parameters(), lr) <span class="hljs-comment"># Adam</span><br></code></pre></td></tr></table></figure><h3 id="Build-Model"><a href="#Build-Model" class="headerlink" title="Build Model"></a>Build Model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(nn.Module):<br>    <span class="hljs-comment"># Initialize the model &amp; define the layers</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(MyModel, self).__init__()<br>        self.nn = nn.Sequential(<br>            nn.Linear(<span class="hljs-number">10</span>, <span class="hljs-number">32</span>),<br>            nn.Sigmoid(),<br>            nn.Linear(<span class="hljs-number">32</span>, <span class="hljs-number">1</span>),<br>        )<br><br>    <span class="hljs-comment"># Compute the output of NN</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-keyword">return</span> self.nn(x)<br></code></pre></td></tr></table></figure><h3 id="Training"><a href="#Training" class="headerlink" title="Training"></a>Training</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">dataset = MyDataset(filename)<br>training_set = DataLoader(dataset, batch_size=<span class="hljs-number">16</span>, shuffle=<span class="hljs-literal">True</span>)<br>model = MyModel().to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br>critertion = nn.MSELoss()<br>optimizer = torch.optim.SGD(model.parameters(), lr=<span class="hljs-number">0.001</span>)<br><br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>    model.train() <span class="hljs-comment"># Set the model to training mode</span><br>    <span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> training_set:<br>        x, y = x.to(<span class="hljs-string">&#x27;cuda&#x27;</span>), y.to(<span class="hljs-string">&#x27;cuda&#x27;</span>) <span class="hljs-comment"># Move the data to GPU</span><br>        optimizer.zero_grad() <span class="hljs-comment"># Clear the gradient</span><br>        y_pred = model(x) <span class="hljs-comment"># Forward pass</span><br>        loss = criterion(y_pred, y) <span class="hljs-comment"># Compute the loss</span><br>        loss.backward() <span class="hljs-comment"># Compute the gradient</span><br>        optimizer.step() <span class="hljs-comment"># Update the parameters</span><br></code></pre></td></tr></table></figure><h3 id="Evaluation-Validation"><a href="#Evaluation-Validation" class="headerlink" title="Evaluation (Validation)"></a>Evaluation (Validation)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">model.<span class="hljs-built_in">eval</span>() <span class="hljs-comment"># Set the model to evaluation mode</span><br>total_loss = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> validation_set:<br>    x, y = x.to(<span class="hljs-string">&#x27;cuda&#x27;</span>), y.to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br>    <span class="hljs-keyword">with</span> torch.no_grad(): <span class="hljs-comment"># Disable gradient computation</span><br>        y_pred = model(x)<br>        loss = criterion(y_pred, y)<br><br>    total_loss += loss.cpu().item() * x.size(<span class="hljs-number">0</span>) <span class="hljs-comment"># Accumulate the loss</span><br>    avg_loss = total_loss / <span class="hljs-built_in">len</span>(validation_set.dataset) <span class="hljs-comment"># Compute the average loss</span><br></code></pre></td></tr></table></figure><h3 id="Evaluation-Testing"><a href="#Evaluation-Testing" class="headerlink" title="Evaluation (Testing)"></a>Evaluation (Testing)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">model.<span class="hljs-built_in">eval</span>() <span class="hljs-comment"># Set the model to evaluation mode</span><br>predictions = []<br><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> test_set:<br>    x = x.to(<span class="hljs-string">&#x27;cuda&#x27;</span>)<br>    <span class="hljs-keyword">with</span> torch.no_grad(): <span class="hljs-comment"># Disable gradient computation</span><br>        y_pred = model(x)<br>        predictions.append(y_pred.cpu())<br></code></pre></td></tr></table></figure><h3 id="Save-Load-Model"><a href="#Save-Load-Model" class="headerlink" title="Save &amp; Load Model"></a>Save &amp; Load Model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">torch.save(model.state_dict(), path) <span class="hljs-comment"># Save the model</span><br><br>checkpoint = torch.load(path) <span class="hljs-comment"># Load the model</span><br>model.load_state_dict(checkpoint)<br></code></pre></td></tr></table></figure><h2 id="可重現性-Reproducibility"><a href="#可重現性-Reproducibility" class="headerlink" title="可重現性 (Reproducibility)"></a>可重現性 (Reproducibility)</h2><p>為了讓每次執行的結果都保持一樣，不然很難確定效果改進是因為調整 <code>hyperparameter</code>，還是來自隨機性的變異。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">myseed = <span class="hljs-number">42069</span><br>torch.backends.cudnn.deterministic = <span class="hljs-literal">True</span><br>torch.backends.cudnn.benchmark = <span class="hljs-literal">False</span><br>np.random.seed(myseed)<br>torch.manual_seed(myseed)<br><span class="hljs-keyword">if</span> torch.cuda.is_available():<br>    torch.cuda.manual_seed_all(myseed)<br></code></pre></td></tr></table></figure><ul><li><code>myseed = 42069</code>: 設定固定的 <code>seed</code></li><li><code>torch.backends.cudnn.deterministic = True</code>: <code>cuDNN</code> 為了加速計算，會默認選擇最快的方法，可能導致 non-deterministic 的行為發生，改成 <code>True</code> 可以確保每次結果都一樣</li><li><code>torch.backends.cudnn.benchmark = False</code>: 禁止 <code>cuDNN</code> 自己選擇最佳的計算方法，使用固定的方法來保證每次計算方式相同</li></ul><p>如果為了 Performance 而不在乎 Reproducibility，可以把上面設成相反的</p>]]></content>
    
    
    
    <tags>
      
      <tag>ml</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AIAS - Basic</title>
    <link href="/notes/2025/03/03/ai-computing-system-1/"/>
    <url>/notes/2025/03/03/ai-computing-system-1/</url>
    
    <content type="html"><![CDATA[<h2 id="Lecture"><a href="#Lecture" class="headerlink" title="Lecture"></a>Lecture</h2><ul><li><p>Base Conversion<br>可以直接用 gdb 來看數字的表示方式，例如</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">(gdb) p/t 43275<br><span class="hljs-meta prompt_">$</span><span class="language-bash">1 = 1010100100001011</span><br>(gdb) p 0b1010100100001011<br><span class="hljs-meta prompt_">$</span><span class="language-bash">2 = 43275</span><br>(gdb) p/x 43275<br><span class="hljs-meta prompt_">$</span><span class="language-bash">3 = 0xa90b</span><br>(gdb) p 0xa90b<br><span class="hljs-meta prompt_">$</span><span class="language-bash">4 = 43275</span><br></code></pre></td></tr></table></figure><p>這樣就可以看到 43275 的二進位、十進位、十六進位表示方式。</p></li><li><p>Digital &amp; Analog</p><ul><li>Quantization: 把類比轉成數位訊號。<br>會先在時間軸上做 Sampling，再對 Sample 出的訊號強度做數值 Mapping。</li></ul></li></ul><h2 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a>Lab</h2><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><h3 id="C-C"><a href="#C-C" class="headerlink" title="C&#x2F;C++"></a>C&#x2F;C++</h3><h4 id="Bitwise-Operation"><a href="#Bitwise-Operation" class="headerlink" title="Bitwise Operation"></a>Bitwise Operation</h4><p>多用 <code>bitwise</code> 增加 <code>readability</code> 和 <code>performance</code>。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BIT_MASK(start, end) (((~0U) &gt;&gt; (31 - (start))) &amp; ~((1U &lt;&lt; (end)) - 1))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET_ADDR_BITS(addr, start, end)  (((addr) &amp; BIT_MASK(start, end)) &gt;&gt; (end))</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">decode</span><span class="hljs-params">( <span class="hljs-type">uint32_t</span> addr)</span></span>&#123;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GET_ADDR_BITS</span>(addr, <span class="hljs-number">31</span>, <span class="hljs-number">8</span>) == <span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-comment">// 0x00000000 - 0x000000FF</span><br>      <span class="hljs-keyword">return</span> VIRT_DEBUG;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GET_ADDR_BITS</span>(addr, <span class="hljs-number">31</span>, <span class="hljs-number">16</span>) == <span class="hljs-number">0</span> &amp;&amp;<br>             <span class="hljs-built_in">GET_ADDR_BITS</span>(addr, <span class="hljs-number">16</span>, <span class="hljs-number">12</span>) !=<span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-comment">// 0x00001000 - 0x0000FFFF</span><br>  &#125;<br>  ....<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>BIT_MASK(start, end)</code> 會產生從 start 到 end 都是 1 的 mask<ul><li><code>(~0U) &gt;&gt; (31 - (start))</code> 會產生從 start 和 start 之後的 bit 都是 1 的 mask</li><li><code>~((1U &lt;&lt; (end)) - 1)</code> 會產生 end 之後的 bit 都是 0 的 mask</li></ul></li></ul><p>方便對以下做 decode</p><p><img src="https://course.playlab.tw/md/uploads/5d04d2c9-3cfb-4222-bddb-bdfddc6483cf.png" alt="Example"></p><h4 id="Valgrind"><a href="#Valgrind" class="headerlink" title="Valgrind"></a>Valgrind</h4><p>C 語言沒有 garbage collection，記憶體要自己控制，可以用 <code>valgrind</code> 來檢查記憶體是否有釋放。</p><blockquote><p>編譯時要加上 <code>-g</code> 參數，才能看到程式碼的行數。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">valgrind &#123;-valgrind parameter&#125; ./my_program &#123;-program parameter&#125;<br></code></pre></td></tr></table></figure><p>Valgrind 訊息可以分成幾種：</p><ul><li><p><code>definitely lost</code>: 直接遺失，程式完全無法訪問這塊記憶體</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">int</span>* ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">==346==    definitely lost: 40 bytes in 1 blocks<br>==346==    indirectly lost: 0 bytes in 0 blocks<br>==346==      possibly lost: 0 bytes in 0 blocks<br>==346==    still reachable: 0 bytes in 0 blocks<br>==346==         suppressed: 0 bytes in 0 blocks<br></code></pre></td></tr></table></figure></li><li><p><code>indirectly lost</code>: 因為其他記憶體被洩漏而無法釋放</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> &#123;</span><br>    <span class="hljs-type">int</span> value;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> *<span class="hljs-title">next</span>;</span><br>&#125; Node;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leak_linked_list</span><span class="hljs-params">()</span> &#123;<br>    Node *head = (Node *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(Node));<br>    head-&gt;next = (Node *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(Node));<br>    head-&gt;next-&gt;next = (Node *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(Node));<br>    head-&gt;next-&gt;next-&gt;next = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">free</span>(head);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    leak_linked_list();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">==334== LEAK SUMMARY:<br>==334==    definitely lost: 16 bytes in 1 blocks<br>==334==    indirectly lost: 16 bytes in 1 blocks<br>==334==      possibly lost: 0 bytes in 0 blocks<br>==334==    still reachable: 0 bytes in 0 blocks<br>==334==         suppressed: 0 bytes in 0 blocks<br></code></pre></td></tr></table></figure></li><li><p><code>possibly lost</code>: 有奇怪的操作，valgrind 也不確定這塊記憶體是不是真的 <code>lost</code></p></li><li><p><code>still reachable</code>: 記憶體在程式結束時仍然可訪問，但沒有 free 掉</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> *global_ptr;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">still_reachable_memory</span><span class="hljs-params">()</span> &#123;<br>    global_ptr = (<span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    still_reachable_memory();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">==406== LEAK SUMMARY:<br>==406==    definitely lost: 0 bytes in 0 blocks<br>==406==    indirectly lost: 0 bytes in 0 blocks<br>==406==      possibly lost: 0 bytes in 0 blocks<br>==406==    still reachable: 40 bytes in 1 blocks<br>==406==         suppressed: 0 bytes in 0 blocks<br></code></pre></td></tr></table></figure></li></ul><h3 id="Verilog"><a href="#Verilog" class="headerlink" title="Verilog"></a>Verilog</h3><ul><li>Combinational Circuit</li></ul><p>輸出只取決於當前的輸入，與電路中的狀態無關。根據 <code>input signal</code> 的組合，直接計算出 <code>output signal</code> 的邏輯函數，過程中不會有任何的 <code>memory</code>。</p><ul><li>Sequential Circuit</li></ul><p>輸出不僅取決於當前的輸入，還取決於電路中留存的狀態。在 <code>combinational circuit</code> 的基礎上，加入了 <code>memory</code> 元件，例如 <code>flip-flop</code>。</p><h4 id="Verilog-Syntax"><a href="#Verilog-Syntax" class="headerlink" title="Verilog Syntax"></a>Verilog Syntax</h4><h5 id="Data-Type"><a href="#Data-Type" class="headerlink" title="Data Type"></a>Data Type</h5><ul><li><code>wire</code>: 用來連接不同的元件，只能用來連接 <code>output</code> 和 <code>input</code>，沒有特別註明的話，預設就是 <code>wire</code>。</li><li><code>reg</code>: 用來儲存 <code>state</code>，可以用來儲存 <code>output</code>。<ul><li>對於 <code>module</code> 內部而言，input 只能用 <code>wire</code> 連接，output 可以用 <code>wire</code> 或 <code>reg</code> 連接。</li><li>對於 <code>module</code> 外部而言，input 可以用 <code>wire</code> 或 <code>reg</code> 連接，output 只能用 <code>wire</code> 連接。</li></ul></li></ul><p>當 <code>wire</code> 沒有被 <code>assign</code> 時，預設值為 **X(Unknown)**，當 <code>reg</code> 沒有被 <code>assign</code> 時，預設值為 **Z(High Impedance&#x2F; Floating)**。</p><h5 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h5><p><code>[MSB:LSB]</code> 或 <code>[LSB:MSB]</code> 都可以</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">input</span>  [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>]   in;         <span class="hljs-comment">// Declare 8-bit input wire `in`</span><br><span class="hljs-keyword">output</span> [<span class="hljs-number">127</span>:<span class="hljs-number">0</span>] out;        <span class="hljs-comment">// Declare 128-bit output wire `out`</span><br><span class="hljs-keyword">reg</span>    [<span class="hljs-number">3</span>:<span class="hljs-number">0</span>]   reg0, reg1; <span class="hljs-comment">// Declare 4-bit register `reg0` and `reg1`</span><br><span class="hljs-keyword">wire</span>   [<span class="hljs-number">63</span>:<span class="hljs-number">0</span>]  wire0;      <span class="hljs-comment">// Declare 64-bit wire `wire0`</span><br></code></pre></td></tr></table></figure><h5 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h5><p>要把宣告的 <code>Dimension</code> 寫在變數名稱的後面</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">wire</span> wire0 [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>];               <span class="hljs-comment">// Declare 8 1-bit wire `wire0`</span><br><span class="hljs-keyword">reg</span> [<span class="hljs-number">127</span>:<span class="hljs-number">0</span>] reg0 [<span class="hljs-number">3</span>:<span class="hljs-number">0</span>] [<span class="hljs-number">3</span>:<span class="hljs-number">0</span>];   <span class="hljs-comment">// Declare 4*4(double arrays) 128-bit register `reg0`</span><br></code></pre></td></tr></table></figure><h5 id="Data-Assignment"><a href="#Data-Assignment" class="headerlink" title="Data Assignment"></a>Data Assignment</h5><p>在 HDL 如 Verilog 中最常使用到的表示方法通常是 2 進制以及 16 進制，不過為了方便也可以用 10 進制表示。另外可以加上 <code>_</code> 來增加可讀性。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">wire</span> [<span class="hljs-number">4</span>:<span class="hljs-number">0</span>]  wire0 = <span class="hljs-number">5&#x27;b01101</span>;             <span class="hljs-comment">// Binary</span><br><span class="hljs-keyword">wire</span> [<span class="hljs-number">7</span>:<span class="hljs-number">0</span>]  wire1 = <span class="hljs-number">22</span>;                   <span class="hljs-comment">// Decimal(default), equals to 8&#x27;d22</span><br><span class="hljs-keyword">reg</span>  [<span class="hljs-number">11</span>:<span class="hljs-number">0</span>] reg0  = <span class="hljs-number">12&#x27;b0000_1111_0000</span>;   <span class="hljs-comment">// Divide with bottom line per 4-bit for readability</span><br><span class="hljs-keyword">reg</span>  [<span class="hljs-number">3</span>:<span class="hljs-number">0</span>]  reg1  = <span class="hljs-number">4&#x27;hf</span>;                 <span class="hljs-comment">// Hexadecimal, equals to 4&#x27;b1111</span><br></code></pre></td></tr></table></figure><h5 id="Dataflow-Level"><a href="#Dataflow-Level" class="headerlink" title="Dataflow Level"></a>Dataflow Level</h5><ul><li><p>Data assignment</p><ul><li><code>assign LValue = RValue</code><br>LValue 只可以是 <code>wire</code>，但是 RValue 可以是 <code>wire</code> 或是 <code>reg</code><ul><li>通常用在 assign module output port</li></ul></li></ul></li><li><p>Concatenation operator</p><ul><li><code>LValue = &#123;Concat0, Concat1, ...&#125;</code><ul><li><code>Concat0</code>, <code>Concat1</code> 可以是 <code>wire</code>、<code>reg</code> 或直接寫數字，像是 <code>8&#39;b1010_1010</code></li></ul></li></ul></li><li><p>Replication operator</p><ul><li><code>LValue = &#123;N&#123;Pattern&#125;&#125;</code><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">wire</span> [<span class="hljs-number">31</span>:<span class="hljs-number">0</span>] combine;<br><span class="hljs-keyword">assign</span> combine = &#123;<span class="hljs-number">3</span>&#123;in0&#125;, <span class="hljs-number">2</span>&#123;in1&#125;, <span class="hljs-number">12&#x27;hfaa</span>&#125;;<br><span class="hljs-comment">// combine = 00_in0_in0_in0_in1_in1_1111_1010_1010</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h5 id="Behavior-Level"><a href="#Behavior-Level" class="headerlink" title="Behavior Level"></a>Behavior Level</h5><p>主要就是用 <code>always block</code>，但裡面的 Data Assignment <strong>只能對 <code>reg</code> 進行操作</strong>，Combinational Circuit 或 Sequential Circuit 都可以用。</p><ul><li><p>Combinational Circuit</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">module</span> combinational_circuit (<br>    <span class="hljs-keyword">input</span> A,<br>    <span class="hljs-keyword">input</span> B,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> C<br>);<br>    <span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>        <span class="hljs-comment">// Combinational logic: output Y is the result of ANDing A and B</span><br>        C = A &amp; B;<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure><ul><li><code>always @(*)</code>: 當所有的 <code>input</code> 有變動時，就會執行 <code>always block</code> 裡面的內容。</li><li>可以看到 <code>C</code> 要用 <code>reg</code> 宣告，因為 <code>always block</code> 裡面只能對 <code>reg</code> 進行操作。</li></ul></li><li><p>Sequential Circuit</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs verilog">  <span class="hljs-keyword">module</span> sequential_circuit (<br>    <span class="hljs-keyword">input</span> clk,<br>    <span class="hljs-keyword">input</span> reset,<br>    <span class="hljs-keyword">input</span> data,<br>    <span class="hljs-keyword">output</span> <span class="hljs-keyword">reg</span> out<br>);<br>    <span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk <span class="hljs-keyword">or</span> <span class="hljs-keyword">posedge</span> reset) <span class="hljs-keyword">begin</span><br>        <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>            <span class="hljs-comment">// Asynchronous reset: reset out to 0 when reset is asserted</span><br>            out &lt;= <span class="hljs-number">1&#x27;b0</span>;<br>        <span class="hljs-keyword">end</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>            <span class="hljs-comment">// Sequential logic: out is updated on the rising edge of clk</span><br>            out &lt;= data;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure><ul><li><code>always @(posedge clk or posedge reset)</code>: 當 <code>clk</code> 或 <code>reset</code> 有上升沿時，就會執行 <code>always block</code> 裡面的內容。</li><li><code>&lt;=</code>: Non-blocking assignment，用在 <code>Sequential Circuit</code> 中</li></ul></li><li><p>Blocking<br>描述的順序會影響電路執行結果，執行 assignment 時，會按照描述順序逐一執行，下一個 assignment 會等待前一個 assignment 操作完成。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">always</span> @(*) <span class="hljs-keyword">begin</span><br>  A = <span class="hljs-number">2</span>;      <span class="hljs-comment">// A = 2</span><br>  B = C;      <span class="hljs-comment">// B = C</span><br>  C = A;      <span class="hljs-comment">// C = 2</span><br>  <span class="hljs-comment">// These assignments will be executed in order</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure></li><li><p>Non-blocking<br>Parallel 的進行資料傳遞，描述的順序不會影響電路執行結果。</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk) <span class="hljs-keyword">begin</span><br>  A &lt;= <span class="hljs-number">2</span>;     <span class="hljs-comment">// A = 2</span><br>  B &lt;= C;     <span class="hljs-comment">// B = C</span><br>  C &lt;= A;     <span class="hljs-comment">// C = A</span><br>  <span class="hljs-comment">// These assignments will be executed at the same time</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="Module-Connection"><a href="#Module-Connection" class="headerlink" title="Module Connection"></a>Module Connection</h5><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">module</span> top_module (<br>    <span class="hljs-keyword">input</span>  in0,<br>    <span class="hljs-keyword">input</span>  in1,<br>    <span class="hljs-keyword">output</span> out0<br>);<br>    sub_module sub_module0 (<br>        <span class="hljs-variable">.input0</span>(in0),   <span class="hljs-comment">// Connect to input0</span><br>        <span class="hljs-variable">.input1</span>(in1),   <span class="hljs-comment">// Connect to input1</span><br>        <span class="hljs-variable">.output0</span>(out0)  <span class="hljs-comment">// Connect to output0</span><br>    );<br><span class="hljs-keyword">endmodule</span><br><br><span class="hljs-keyword">module</span> sub_module (<br>    <span class="hljs-keyword">input</span>  input0,<br>    <span class="hljs-keyword">input</span>  input1,<br>    <span class="hljs-keyword">output</span> output0<br>);<br>    <span class="hljs-comment">// Skip...</span><br><span class="hljs-keyword">endmodule</span><br></code></pre></td></tr></table></figure><p>盡量用 <code>named connection</code>，增加程式碼的可讀性。開心的話也可以用 <code>ordered connection</code>。</p><p>其他像是 <code>If Statement</code>、<code>Case Statement</code> 或 <code>? :</code> 本質上都是 <code>MUX</code>，跟軟體有差</p>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AIAS - AI Models</title>
    <link href="/notes/2025/03/03/ai-computing-system-2/"/>
    <url>/notes/2025/03/03/ai-computing-system-2/</url>
    
    <content type="html"><![CDATA[<h2 id="Lecture"><a href="#Lecture" class="headerlink" title="Lecture"></a>Lecture</h2><h3 id="AlexNet"><a href="#AlexNet" class="headerlink" title="AlexNet"></a>AlexNet</h3><p><img src="/notes/./images/machine-learning/AlexNet.png" alt="AlexNet"></p><h3 id="VGG-16"><a href="#VGG-16" class="headerlink" title="VGG-16"></a>VGG-16</h3><p><img src="/notes/./images/machine-learning/VGG-16.png" alt="VGG-16"></p><h3 id="ResNet-50"><a href="#ResNet-50" class="headerlink" title="ResNet-50"></a>ResNet-50</h3><p><img src="/notes/./images/machine-learning/ResNet-50.png" alt="ResNet-50"></p><h3 id="MobileNetV2"><a href="#MobileNetV2" class="headerlink" title="MobileNetV2"></a>MobileNetV2</h3><p><img src="/notes/./images/machine-learning/MobileNetV2.png" alt="MobileNetV2"></p><p><a href="https://www.dropbox.com/scl/fi/2qx0cfz7vim0fdhrmy986/lec02.pdf?rlkey=wdjw92hwohp4bhyos8wf5iinb&e=2&dl=0">EfficientML.ai Lecture 02: Basics of Neural Networks</a></p><h4 id="Model-Analysis"><a href="#Model-Analysis" class="headerlink" title="Model Analysis"></a>Model Analysis</h4><ul><li>Latency: 一個任務完成所需的時間</li><li>Throughput: 一個時間內完成的任務數量<br><code>Latency</code> 跟 <code>Throughput</code> 沒有絕對的關聯，優化 <code>Latency</code> 會更難一些</li><li>Power Consumption<br>不同 Building Block 的 Power Consumption 也不同，像是 floating point operation 會比 integer operation 耗電量高、DRAM (off-chip) 耗電量也比 SRAM 高</li><li>Number of Parameters</li><li>Model Size<br><code>Model Size</code> &#x3D; <code>Number of Parameters</code> * <code>Bit Width</code></li><li>Total&#x2F;Peak Number of Activations<ul><li><code>Peak Number of Activations</code> 成為一個系統能不能跑起來的關鍵 (Inference)</li><li>Early Layer 的 <code>Activations</code> 會比較多，後面的 <code>Activations</code> 會比較少，<code>Weight</code> 會比較大</li></ul></li><li>MACs (Multiply-Accumulate Operations)，一次乘法和一次加法</li><li>FLOPs (Floating Point Operations)<ul><li><code>FLOPs</code> &#x3D; <code>MACs</code> * <code>2</code> (一個 <code>MAC</code> 會有兩次 <code>FLOPs</code>)</li><li><code>FLOPS</code> &#x3D; <code>FLOPs</code> &#x2F; <code>second</code></li></ul></li><li>Roofline Model</li></ul><h2 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a>Lab</h2><p><code>ONNX</code>(Open Neural Network Exchange)，可以讓不同的深度學習框架之間進行模型的轉換，例如 <code>PyTorch</code>、<code>TensorFlow</code>、<code>Caffe2</code>、<code>MXNet</code> 等。</p><h3 id="Pytorch"><a href="#Pytorch" class="headerlink" title="Pytorch"></a>Pytorch</h3><h4 id="PyTorch-Model-轉換成-ONNX"><a href="#PyTorch-Model-轉換成-ONNX" class="headerlink" title="PyTorch Model 轉換成 ONNX"></a>PyTorch Model 轉換成 ONNX</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision.models <span class="hljs-keyword">as</span> models<br><br><span class="hljs-comment"># 下載並載入預訓練的 AlexNet 模型</span><br>model = models.alexnet(pretrained=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># 創建一個隨機的輸入張量（Dummy Input），形狀為 (10, 3, 224, 224)</span><br><span class="hljs-comment"># 代表 10 張 RGB 影像，每張大小為 224x224</span><br>dummy_input = torch.randn(<span class="hljs-number">10</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)<br><br><span class="hljs-comment"># 定義 ONNX 模型的輸入名稱</span><br><span class="hljs-comment"># 第一個輸入名稱為 &quot;actual_input_1&quot;（實際的輸入）</span><br><span class="hljs-comment"># 後面 16 個 &quot;learned_X&quot; 其實是多餘的，通常用於標記權重或內部變數（但這裡不需要）</span><br>input_names = [<span class="hljs-string">&quot;actual_input_1&quot;</span>] + [<span class="hljs-string">&quot;learned_%d&quot;</span> % i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>)]<br><br><span class="hljs-comment"># 定義 ONNX 模型的輸出名稱</span><br><span class="hljs-comment"># 這裡只設定一個輸出名稱 &quot;output1&quot;，代表分類結果（1000 個類別的機率分佈）</span><br>output_names = [<span class="hljs-string">&quot;output1&quot;</span>]<br><br><span class="hljs-comment"># 將 PyTorch 的 AlexNet 模型轉換為 ONNX 格式，並儲存為 &quot;models/alexnet.onnx&quot;</span><br>torch.onnx.export(<br>    model,            <span class="hljs-comment"># PyTorch 模型</span><br>    dummy_input,      <span class="hljs-comment"># 範例輸入，用來確保模型的輸入形狀正確</span><br>    <span class="hljs-string">&quot;models/alexnet.onnx&quot;</span>,  <span class="hljs-comment"># 轉換後的 ONNX 模型儲存路徑</span><br>    verbose=<span class="hljs-literal">True</span>,     <span class="hljs-comment"># 顯示轉換過程的詳細資訊</span><br>    input_names=input_names,  <span class="hljs-comment"># 設定 ONNX 模型的輸入名稱</span><br>    output_names=output_names  <span class="hljs-comment"># 設定 ONNX 模型的輸出名稱</span><br>)<br></code></pre></td></tr></table></figure><h4 id="Model-Analysis-1"><a href="#Model-Analysis-1" class="headerlink" title="Model Analysis"></a>Model Analysis</h4><ul><li><p>取得 Parameter Size</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">total_params = <span class="hljs-built_in">sum</span>(p.numel() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Total number of parameters: &quot;</span>, total_params)<br></code></pre></td></tr></table></figure><p>印出這個 Model 總共的參數數量，其中 <code>p.numel()</code> 會回傳某個 Tensor 裡面總共有多少個元素</p></li><li><p>算出總共需要多少 Memory</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">param_size = <span class="hljs-built_in">sum</span>(p.numel() * p.element_size() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> model.parameters())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Total memory for parameters: &quot;</span>, param_size)<br></code></pre></td></tr></table></figure><p><code>p.element_size()</code> 會回傳某個 Tensor 裡面的 Data Type 佔用多少 Bytes</p></li><li><p>Summary</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> models<br><span class="hljs-keyword">from</span> torchsummary <span class="hljs-keyword">import</span> summary<br><br>model = models.alexnet(pretrained=<span class="hljs-literal">True</span>)<br>summary(model, (<span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>))<br></code></pre></td></tr></table></figure><p>這樣可以印出這個 Model 的 Summary，包含模型的結構、每層輸出的大小、參數數量、總參數數量等等</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs subunit">----------------------------------------------------------------<br>          Layer (type)               Output Shape         Param #<br>  ================================================================<br>              Conv2d<span class="hljs-string">-1</span>           [<span class="hljs-string">-1</span>, 64, 55, 55]          23,296<br>                ReLU<span class="hljs-string">-2</span>           [<span class="hljs-string">-1</span>, 64, 55, 55]               0<br>          MaxPool2d<span class="hljs-string">-3</span>           [<span class="hljs-string">-1</span>, 64, 27, 27]               0<br>              Conv2d<span class="hljs-string">-4</span>          [<span class="hljs-string">-1</span>, 192, 27, 27]         307,392<br>                ReLU<span class="hljs-string">-5</span>          [<span class="hljs-string">-1</span>, 192, 27, 27]               0<br>          MaxPool2d<span class="hljs-string">-6</span>          [<span class="hljs-string">-1</span>, 192, 13, 13]               0<br>              Conv2d<span class="hljs-string">-7</span>          [<span class="hljs-string">-1</span>, 384, 13, 13]         663,936<br>                ReLU<span class="hljs-string">-8</span>          [<span class="hljs-string">-1</span>, 384, 13, 13]               0<br>              Conv2d<span class="hljs-string">-9</span>          [<span class="hljs-string">-1</span>, 256, 13, 13]         884,992<br>              ReLU<span class="hljs-string">-10</span>          [<span class="hljs-string">-1</span>, 256, 13, 13]               0<br>            Conv2d<span class="hljs-string">-11</span>          [<span class="hljs-string">-1</span>, 256, 13, 13]         590,080<br>              ReLU<span class="hljs-string">-12</span>          [<span class="hljs-string">-1</span>, 256, 13, 13]               0<br>          MaxPool2d<span class="hljs-string">-13</span>            [<span class="hljs-string">-1</span>, 256, 6, 6]               0<br>  AdaptiveAvgPool2d<span class="hljs-string">-14</span>            [<span class="hljs-string">-1</span>, 256, 6, 6]               0<br>            Dropout<span class="hljs-string">-15</span>                 [<span class="hljs-string">-1</span>, 9216]               0<br>            Linear<span class="hljs-string">-16</span>                 [<span class="hljs-string">-1</span>, 4096]      37,752,832<br>              ReLU<span class="hljs-string">-17</span>                 [<span class="hljs-string">-1</span>, 4096]               0<br>            Dropout<span class="hljs-string">-18</span>                 [<span class="hljs-string">-1</span>, 4096]               0<br>            Linear<span class="hljs-string">-19</span>                 [<span class="hljs-string">-1</span>, 4096]      16,781,312<br>              ReLU<span class="hljs-string">-20</span>                 [<span class="hljs-string">-1</span>, 4096]               0<br>            Linear<span class="hljs-string">-21</span>                 [<span class="hljs-string">-1</span>, 1000]       4,097,000<br>  ================================================================<br>  Total params: 61,100,840<br>  Trainable params: 61,100,840<br>  Non-trainable params: 0<br>  ----------------------------------------------------------------<br>  Input size (MB): 0.57<br>  Forward/backward pass size (MB): 8.38<br>  Params size (MB): 233.08<br>  Estimated Total Size (MB): 242.03<br>  ----------------------------------------------------------------<br></code></pre></td></tr></table></figure><p>如果單純用 <code>print(model)</code> 只會印出這個 Model 的結構，但是不會有其他資訊</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs routeros">AlexNet(<br>(features): Sequential(<br>  (0): Conv2d(3, 64, kernel_size=(11, 11), stride=(4, 4), padding=(2, 2))<br>  (1): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (2): MaxPool2d(<span class="hljs-attribute">kernel_size</span>=3, <span class="hljs-attribute">stride</span>=2, <span class="hljs-attribute">padding</span>=0, <span class="hljs-attribute">dilation</span>=1, <span class="hljs-attribute">ceil_mode</span>=<span class="hljs-literal">False</span>)<br>  (3): Conv2d(64, 192, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))<br>  (4): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (5): MaxPool2d(<span class="hljs-attribute">kernel_size</span>=3, <span class="hljs-attribute">stride</span>=2, <span class="hljs-attribute">padding</span>=0, <span class="hljs-attribute">dilation</span>=1, <span class="hljs-attribute">ceil_mode</span>=<span class="hljs-literal">False</span>)<br>  (6): Conv2d(192, 384, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))<br>  (7): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (8): Conv2d(384, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))<br>  (9): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (10): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))<br>  (11): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (12): MaxPool2d(<span class="hljs-attribute">kernel_size</span>=3, <span class="hljs-attribute">stride</span>=2, <span class="hljs-attribute">padding</span>=0, <span class="hljs-attribute">dilation</span>=1, <span class="hljs-attribute">ceil_mode</span>=<span class="hljs-literal">False</span>)<br>)<br>(avgpool): AdaptiveAvgPool2d(output_size=(6, 6))<br>(classifier): Sequential(<br>  (0): Dropout(<span class="hljs-attribute">p</span>=0.5, <span class="hljs-attribute">inplace</span>=<span class="hljs-literal">False</span>)<br>  (1): Linear(<span class="hljs-attribute">in_features</span>=9216, <span class="hljs-attribute">out_features</span>=4096, <span class="hljs-attribute">bias</span>=<span class="hljs-literal">True</span>)<br>  (2): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (3): Dropout(<span class="hljs-attribute">p</span>=0.5, <span class="hljs-attribute">inplace</span>=<span class="hljs-literal">False</span>)<br>  (4): Linear(<span class="hljs-attribute">in_features</span>=4096, <span class="hljs-attribute">out_features</span>=4096, <span class="hljs-attribute">bias</span>=<span class="hljs-literal">True</span>)<br>  (5): ReLU(<span class="hljs-attribute">inplace</span>=<span class="hljs-literal">True</span>)<br>  (6): Linear(<span class="hljs-attribute">in_features</span>=4096, <span class="hljs-attribute">out_features</span>=1000, <span class="hljs-attribute">bias</span>=<span class="hljs-literal">True</span>)<br>)<br>)<br></code></pre></td></tr></table></figure></li><li><p>torchinfo<br>如果需要更更更詳細的模型資訊，可以使用 <code>torchinfo</code>，控制格式和詳細程度 (col_names、verbose)</p><ul><li><p>col_names:</p><table><thead><tr><th align="center">選項</th><th align="center">說明</th></tr></thead><tbody><tr><td align="center">input_size</td><td align="center">輸入大小</td></tr><tr><td align="center">output_size</td><td align="center">輸出大小</td></tr><tr><td align="center">num_params</td><td align="center">參數數量</td></tr><tr><td align="center">kernel_size</td><td align="center">Kernel 大小</td></tr><tr><td align="center">mult_adds</td><td align="center">Multiply-Adds 數量</td></tr></tbody></table></li><li><p>verbose:</p><table><thead><tr><th align="center">選項</th><th align="center">說明</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">僅顯示總參數數量</td></tr><tr><td align="center">1</td><td align="center">顯示模型層數和參數資訊</td></tr><tr><td align="center">2</td><td align="center">顯示所有層的輸入&#x2F;輸出張量形狀</td></tr><tr><td align="center">3</td><td align="center">顯示每個層的完整資訊，包括所有內部運算</td></tr></tbody></table></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchinfo<br>torchinfo.summary(model, (<span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>), batch_dim=<span class="hljs-number">0</span>, col_names=(<span class="hljs-string">&quot;input_size&quot;</span>, <span class="hljs-string">&quot;output_size&quot;</span>, <span class="hljs-string">&quot;num_params&quot;</span>, <span class="hljs-string">&quot;kernel_size&quot;</span>, <span class="hljs-string">&quot;mult_adds&quot;</span>), verbose=<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure></li></ul><h3 id="TensorFlow"><a href="#TensorFlow" class="headerlink" title="TensorFlow"></a>TensorFlow</h3><p>TensorFlow 有很多儲存 Model 的格式，這些都可以用 Tensorflow-onnx 工具轉換成 ONNX 格式</p><ul><li><p>Checkpoint (.ckpt)<br>TensorFlow 會用 <code>checkpoint</code> 儲存 Model 訓練的權重，但是不包含 Computation Graph，之後可以繼續訓練</p></li><li><p>Frozen Graph (.pb)<br>把 Graph 和權重都儲存起來，可以直接用來做 Inference，但是權重是 <code>Frozen Weight</code>，不能再繼續訓練 (TensorFlow 2.x 不推薦這種方式)</p></li><li><p>SavedModel (包含 saved_model.pb、variables、assets)<br>是 TensorFlow 推薦的完整儲存格式，封裝了 Model 架構、Graph、權重和 Inference 的方式，不用額外指定輸入輸出，更容易導入 ONNX</p></li><li><p>TFLite (.tflite)<br>TensorFlow Lite 是為了在行動裝置或嵌入式上做 Inference 而設計的，可以將 SavedModel 轉換成 TFLite，並且可以做 Quantization 來減少 Model 的大小</p></li></ul><h4 id="把-TensorFlow-Model-轉換成-ONNX"><a href="#把-TensorFlow-Model-轉換成-ONNX" class="headerlink" title="把 TensorFlow Model 轉換成 ONNX"></a>把 TensorFlow Model 轉換成 ONNX</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<br><span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Conv2D, MaxPooling2D, Flatten, Dense<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 定義一個簡單的 CNN 模型</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_simple_cnn_model</span>(<span class="hljs-params">input_shape=(<span class="hljs-params"><span class="hljs-number">224</span>, <span class="hljs-number">224</span>, <span class="hljs-number">3</span></span>), num_classes=<span class="hljs-number">10</span></span>):<br>    model = tf.keras.Sequential([  <span class="hljs-comment"># 使用 Keras Sequential 模型</span><br>        Conv2D(<span class="hljs-number">32</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">&#x27;relu&#x27;</span>, input_shape=input_shape),  <span class="hljs-comment"># 第一層 Convolution Layer，32 個 3x3 Filter</span><br>        MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)),<br>        Flatten(),<br>        Dense(<span class="hljs-number">128</span>, activation=<span class="hljs-string">&#x27;relu&#x27;</span>),  <span class="hljs-comment"># Fully Connected Layer，128 個 Neurons</span><br>        Dense(num_classes, activation=<span class="hljs-string">&#x27;softmax&#x27;</span>)  <span class="hljs-comment"># 輸出層，10 個 Neurons（10 個類別）</span><br>    ])<br>    <span class="hljs-keyword">return</span> model<br><br>directory = <span class="hljs-string">&quot;models/tf_cnn_models&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(directory):<br>    os.makedirs(directory)<br><br>simple_cnn_model = create_simple_cnn_model()<br><br><span class="hljs-comment"># 儲存模型為 TensorFlow 的 SavedModel 格式</span><br>tf.saved_model.save(simple_cnn_model, directory)<br></code></pre></td></tr></table></figure><p>最後可以用以下指令把 SavedModel 轉換成 ONNX</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">!python3 -m tf2onnx.convert --saved-model models/tf_cnn_models --output models/tf2onnx_cnn_model.onnx<br></code></pre></td></tr></table></figure><p>可以用 <code>--opset</code> (Operator Set Version) 來指定使用的 ONNX Operator 版本，越新的支援越多，預設是 <code>9</code></p><table><thead><tr><th align="center">opset</th><th align="center">ONNX Version</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">9</td><td align="center">1.4</td><td align="center">Default version, includes basic operators</td></tr><tr><td align="center">10</td><td align="center">1.5</td><td align="center">Supports <code>Slice</code> improvements, new <code>QuantizeLinear</code> operator</td></tr><tr><td align="center">11</td><td align="center">1.6</td><td align="center">Supports <code>Loop</code> and <code>Range</code>, optimized for dynamic length</td></tr><tr><td align="center">12</td><td align="center">1.7</td><td align="center">Adds <code>GatherND</code>, improved <code>Reshape</code> operator</td></tr><tr><td align="center">13</td><td align="center">1.8</td><td align="center"><code>Softmax</code>, <code>ReduceMean</code>, etc. support more flexible dimensions</td></tr><tr><td align="center">14</td><td align="center">1.9</td><td align="center">Improved <code>ConvTranspose</code>, supports more data formats</td></tr><tr><td align="center">15+</td><td align="center">1.10+</td><td align="center">Adds more new features (e.g., <code>Reshape</code> with variable dimensions)</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python -m tf2onnx.convert --saved-model &lt;tensorflow_model_name&gt; --opset 13 --output &lt;onnx_model_name&gt;<br></code></pre></td></tr></table></figure><h3 id="ONNX"><a href="#ONNX" class="headerlink" title="ONNX"></a>ONNX</h3><h4 id="Inferencing"><a href="#Inferencing" class="headerlink" title="Inferencing"></a>Inferencing</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> onnxruntime <span class="hljs-keyword">as</span> ort<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># 載入 ONNX 模型</span><br>onnx_session = ort.InferenceSession(<span class="hljs-string">&quot;models/tf2onnx_cnn_model.onnx&quot;</span>)<br><br><span class="hljs-comment"># Test data</span><br>test_input = np.random.rand(<span class="hljs-number">1</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>, <span class="hljs-number">3</span>).astype(np.float32)<br><br><span class="hljs-comment"># Inference</span><br>onnx_input_name = onnx_session.get_inputs()[<span class="hljs-number">0</span>].name<br>onnx_output = onnx_session.run(<span class="hljs-literal">None</span>, &#123;onnx_input_name: test_input&#125;)<br></code></pre></td></tr></table></figure><h3 id="Netron"><a href="#Netron" class="headerlink" title="Netron"></a>Netron</h3><p>Netron 是一個功能強大的機器學習模型的 <strong>可視化</strong> 工具，支援各種模型格式，包括 ONNX、TensorFlow、PyTorch、Keras 等等，可以用來看模型每一層的結構、輸入輸出、權重等等。可以用指令或 <a href="https://netron.app/">官方網站</a> 來開啟模型</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">netron models/lenet.onnx<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/ai-computing-system/LeNet.png" alt="LetNet Architecture"></p><h3 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h3><p>ONNX 格式將模型儲存為 Protobuf（Protocol Buffers）的結構，其中 Protobuf 是一種 Google 開發的 <strong>Data Serialization Format</strong>，可以將 ONNX 模型的 Graph、Layer 結構、權重等資訊儲存在裡面</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> onnx<br><br>onnx_model = onnx.load(<span class="hljs-string">&#x27;./models/lenet.onnx&#x27;</span>)<br><br><span class="hljs-comment"># The model is represented as a protobuf structure and it can be accessed</span><br><span class="hljs-comment"># using the standard python-for-protobuf methods</span><br><br><span class="hljs-comment">## list all the operator types in the model</span><br>node_list = []<br>count = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> onnx_model.graph.node:<br>    <span class="hljs-keyword">if</span> (i.op_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> node_list):<br>        node_list.append(i.op_type)<br>        count.append(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">else</span>:<br>        idx = node_list.index(i.op_type)<br>        count[idx] = count[idx]+<span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(node_list)<br><span class="hljs-built_in">print</span>(count)<br></code></pre></td></tr></table></figure><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs scheme">[<span class="hljs-symbol">&#x27;Reshape</span>&#x27;, <span class="hljs-symbol">&#x27;Conv</span>&#x27;, <span class="hljs-symbol">&#x27;Add</span>&#x27;, <span class="hljs-symbol">&#x27;Relu</span>&#x27;, <span class="hljs-symbol">&#x27;MaxPool</span>&#x27;, <span class="hljs-symbol">&#x27;Identity</span>&#x27;]<br>[<span class="hljs-name">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>]<br></code></pre></td></tr></table></figure><p>這樣可以看到這個 ONNX Model 有哪些 Operator Type，以及每個 Operator Type 的數量。</p><p>可以參考 <a href="https://github.com/onnx/onnx/blob/main/onnx/onnx.proto">onnx.proto</a> 和 <a href="https://protobuf.dev/programming-guides/proto3/">Protocol Buffers Documentation</a>，能看到 ONNX 最外層的結構是 ModelProto，裡面包含 GraphProto，其由 NodeProto 組成，包含 Graph 的許多資訊</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># find the IR version</span><br><span class="hljs-built_in">print</span>(onnx_model.ir_version)<br><span class="hljs-comment">## find the computation graph</span><br><span class="hljs-built_in">print</span>(onnx_model.graph)<br><span class="hljs-comment">## find the number of inputs</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(onnx_model.graph.<span class="hljs-built_in">input</span>))<br><span class="hljs-comment">## find the number of nodes in the graph</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(onnx_model.graph.node))<br></code></pre></td></tr></table></figure><p>以下方式可以印出這個 ONNX Model 的 Convolution Layer 輸入輸出的 Size，其中</p><ul><li>input_nlist: 模型所有的輸入，包含 Placeholder 和 Initializer</li><li>initializer_nlist: 模型所有的權重，是 input_nlist 的子集</li><li>value_info_nlist: 模型中間的計算結果</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## parse_model.py</span><br><span class="hljs-keyword">import</span> onnx<br><br>onnx_model = onnx.load(<span class="hljs-string">&#x27;./models/lenet.onnx&#x27;</span>)<br><br><span class="hljs-comment">## need to run shape inference in order to get a full value_info list</span><br>onnx_model = onnx.shape_inference.infer_shapes(onnx_model)<br><br><span class="hljs-comment">## List all tensor names in the graph</span><br>input_nlist = [k.name <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> onnx_model.graph.<span class="hljs-built_in">input</span>]<br>initializer_nlist = [k.name <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> onnx_model.graph.initializer]<br>value_info_nlist = [k.name <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> onnx_model.graph.value_info]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\ninput list: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(input_nlist))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\ninitializer list: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(initializer_nlist))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\nvalue_info list: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(value_info_nlist))<br><br><span class="hljs-comment">## a simple function to calculate the tensor size and extract dimension information</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_size</span>(<span class="hljs-params">shape</span>):<br>    dims = []<br>    ndim = <span class="hljs-built_in">len</span>(shape.dim)<br>    size = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ndim):<br>        size = size * shape.dim[i].dim_value<br>        dims.append(shape.dim[i].dim_value)<br>    <span class="hljs-keyword">return</span> dims, size<br><br><span class="hljs-comment">## find all `Conv` operators and print its input information</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> onnx_model.graph.node:<br>    <span class="hljs-keyword">if</span> (i.op_type == <span class="hljs-string">&#x27;Conv&#x27;</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\n-- Conv &quot;&#123;&#125;&quot; --&#x27;</span>.<span class="hljs-built_in">format</span>(i.name))<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> i.<span class="hljs-built_in">input</span>:<br>            <span class="hljs-keyword">if</span> j <span class="hljs-keyword">in</span> input_nlist:<br>                idx = input_nlist.index(j)<br>                (dims, size) = get_size(onnx_model.graph.<span class="hljs-built_in">input</span>[idx].<span class="hljs-built_in">type</span>.tensor_type.shape)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;input &#123;&#125; has &#123;&#125; elements dims = &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(j, size, dims  ))<br>            <span class="hljs-keyword">elif</span> j <span class="hljs-keyword">in</span> initializer_nlist:<br>                idx = initializer_nlist.index(j)<br>                (dims, size) = get_size(onnx_model.graph.initializer[idx].<span class="hljs-built_in">type</span>.tensor_type.shape)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;input &#123;&#125; has &#123;&#125; elements dims = &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(j, size, dims))<br>            <span class="hljs-keyword">elif</span> j <span class="hljs-keyword">in</span> value_info_nlist:<br>                idx = value_info_nlist.index(j)<br>                (dims, size) = get_size(onnx_model.graph.value_info[idx].<span class="hljs-built_in">type</span>.tensor_type.shape)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;input &#123;&#125; has &#123;&#125; elements dims = &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(j, size, dims))<br></code></pre></td></tr></table></figure><p>這樣可以除了可以印出 input、initializer、value_info 的名稱，還可以印出所有 Convolution Layer 需要的輸入輸出大小</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs txt">-- Conv &quot;import/conv1first/Conv2D&quot; --<br>input import/Placeholder:0 has 784 elements dims = [1, 1, 28, 28]<br>input import/conv1first/Variable:0 has 800 elements dims = [32, 1, 5, 5]<br><br>-- Conv &quot;import/conv2/Conv2D&quot; --<br>input import/pool1/MaxPool:0 has 6272 elements dims = [1, 32, 14, 14]<br>input import/conv2/Variable:0 has 51200 elements dims = [64, 32, 5, 5]<br><br>-- Conv &quot;import/conv3/Conv2D&quot; --<br>input import/pool2/MaxPool:0 has 3136 elements dims = [1, 64, 7, 7]<br>input import/conv3/Variable:0 has 3211264 elements dims = [1024, 64, 7, 7]<br><br>-- Conv &quot;import/conv4last/Conv2D&quot; --<br>input import/conv3/Relu:0 has 1024 elements dims = [1, 1024, 1, 1]<br>input import/conv4last/Variable:0 has 10240 elements dims = [10, 1024, 1, 1]<br></code></pre></td></tr></table></figure><h3 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h3><p>Hooks 是 PyTorch 中的一個功能，可以註冊在 Forward Pass 或 Backward Pass 中，用來觀察模型的中間過程，例如輸入、輸出、權重、梯度等等，用來檢視每一層算完後到底發生什麼事</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torchvision.models <span class="hljs-keyword">as</span> models<br><span class="hljs-keyword">import</span> torch<br>activation = &#123;&#125;<br><br><span class="hljs-comment"># Define a hook function</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_activation</span>(<span class="hljs-params">name</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hook</span>(<span class="hljs-params">model, <span class="hljs-built_in">input</span>, output</span>):<br>        activation[name] = output.detach()<br>    <span class="hljs-keyword">return</span> hook<br><br>model = models.alexnet(pretrained=<span class="hljs-literal">True</span>)<br>model.<span class="hljs-built_in">eval</span>()<br><br><span class="hljs-comment"># Register hook to each linear layer</span><br><span class="hljs-keyword">for</span> layer_name, layer <span class="hljs-keyword">in</span> model.named_modules():<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer, torch.nn.Linear):<br>        <span class="hljs-comment"># Register forward hook</span><br>        layer.register_forward_hook(get_activation(layer_name))<br><br><span class="hljs-comment"># Run model inference</span><br>data = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)<br>output = model(data)<br><br><span class="hljs-comment"># Access the saved activations</span><br><span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> activation:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Activation from layer <span class="hljs-subst">&#123;layer&#125;</span>: <span class="hljs-subst">&#123;activation[layer].shape&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p>這樣可以印出每個 Fully-connected Layer 的 Activation Shape，在 inference 的過程每一層的 Activation 都會被存起來，用來觀察每一層的輸出</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs txt">Activation from layer classifier.1: torch.Size([1, 4096])<br>Activation from layer classifier.4: torch.Size([1, 4096])<br>Activation from layer classifier.6: torch.Size([1, 1000])<br></code></pre></td></tr></table></figure><p>輸出的大小分別是 <code>[1, 4096]</code>、<code>[1, 4096]</code>、<code>[1, 1000]</code>。</p><h3 id="MACs-and-FLOPs"><a href="#MACs-and-FLOPs" class="headerlink" title="MACs and FLOPs"></a>MACs and FLOPs</h3><p>這是計算 AlexNet MACs 的例子，計算裡面的 Convolutions 和 Fully-connected Layers 總共的 MACs 數量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision.models <span class="hljs-keyword">as</span> models<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_output_shape</span>(<span class="hljs-params">input_shape, layer</span>):<br>    <span class="hljs-comment"># Calculate the output shape for Conv2d, MaxPool2d, and Linear layers</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer, (nn.Conv2d, nn.MaxPool2d)):<br>        kernel_size = (<br>            layer.kernel_size<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer.kernel_size, <span class="hljs-built_in">tuple</span>)<br>            <span class="hljs-keyword">else</span> (layer.kernel_size, layer.kernel_size)<br>        )<br>        stride = (<br>            layer.stride<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer.stride, <span class="hljs-built_in">tuple</span>)<br>            <span class="hljs-keyword">else</span> (layer.stride, layer.stride)<br>        )<br>        padding = (<br>            layer.padding<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer.padding, <span class="hljs-built_in">tuple</span>)<br>            <span class="hljs-keyword">else</span> (layer.padding, layer.padding)<br>        )<br>        dilation = (<br>            layer.dilation<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer.dilation, <span class="hljs-built_in">tuple</span>)<br>            <span class="hljs-keyword">else</span> (layer.dilation, layer.dilation)<br>        )<br><br>        output_height = (<br>            input_shape[<span class="hljs-number">1</span>] + <span class="hljs-number">2</span> * padding[<span class="hljs-number">0</span>] - dilation[<span class="hljs-number">0</span>] * (kernel_size[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>) - <span class="hljs-number">1</span><br>        ) // stride[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span><br>        output_width = (<br>            input_shape[<span class="hljs-number">2</span>] + <span class="hljs-number">2</span> * padding[<span class="hljs-number">1</span>] - dilation[<span class="hljs-number">1</span>] * (kernel_size[<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>) - <span class="hljs-number">1</span><br>        ) // stride[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> (<br>            layer.out_channels <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(layer, <span class="hljs-string">&quot;out_channels&quot;</span>) <span class="hljs-keyword">else</span> input_shape[<span class="hljs-number">0</span>],<br>            output_height,<br>            output_width,<br>        )<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(layer, nn.Linear):<br>        <span class="hljs-comment"># For Linear layers, the output shape is simply the layer&#x27;s output features</span><br>        <span class="hljs-keyword">return</span> (layer.out_features,)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> input_shape<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_macs</span>(<span class="hljs-params">layer, input_shape, output_shape</span>):<br>    <span class="hljs-comment"># Calculate MACs for Conv2d and Linear layers</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer, nn.Conv2d):<br>        kernel_ops = (<br>            layer.kernel_size[<span class="hljs-number">0</span>]<br>            * layer.kernel_size[<span class="hljs-number">1</span>]<br>            * (layer.in_channels / layer.groups)<br>        )<br>        output_elements = output_shape[<span class="hljs-number">1</span>] * output_shape[<span class="hljs-number">2</span>]<br>        macs = <span class="hljs-built_in">int</span>(kernel_ops * output_elements * layer.out_channels)<br>        <span class="hljs-keyword">return</span> macs<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(layer, nn.Linear):<br>        <span class="hljs-comment"># For Linear layers, MACs are the product of input features and output features</span><br>        macs = <span class="hljs-built_in">int</span>(layer.in_features * layer.out_features)<br>        <span class="hljs-keyword">return</span> macs<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><br>model = models.alexnet(pretrained=<span class="hljs-literal">True</span>)<br><br><span class="hljs-comment"># Initial input shape</span><br>input_shape = (<span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)<br>total_macs = <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Iterate through the layers of the model</span><br><span class="hljs-keyword">for</span> name, layer <span class="hljs-keyword">in</span> model.named_modules():<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer, (nn.Conv2d, nn.MaxPool2d, nn.ReLU, nn.Linear)):<br>        output_shape = calculate_output_shape(input_shape, layer)<br>        macs = calculate_macs(layer, input_shape, output_shape)<br>        total_macs += macs<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(layer, (nn.Conv2d, nn.Linear)):<br>            <span class="hljs-built_in">print</span>(<br>                <span class="hljs-string">f&quot;Layer: <span class="hljs-subst">&#123;name&#125;</span>, Type: <span class="hljs-subst">&#123;<span class="hljs-built_in">type</span>(layer).__name__&#125;</span>, Input Shape: <span class="hljs-subst">&#123;input_shape&#125;</span>, Output Shape: <span class="hljs-subst">&#123;output_shape&#125;</span>, MACs: <span class="hljs-subst">&#123;macs&#125;</span>&quot;</span><br>            )<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(layer, nn.MaxPool2d):<br>            <span class="hljs-comment"># Also print shape transformation for MaxPool2d layers (no MACs calculated)</span><br>            <span class="hljs-built_in">print</span>(<br>                <span class="hljs-string">f&quot;Layer: <span class="hljs-subst">&#123;name&#125;</span>, Type: <span class="hljs-subst">&#123;<span class="hljs-built_in">type</span>(layer).__name__&#125;</span>, Input Shape: <span class="hljs-subst">&#123;input_shape&#125;</span>, Output Shape: <span class="hljs-subst">&#123;output_shape&#125;</span>, MACs: N/A&quot;</span><br>            )<br>        input_shape = output_shape  <span class="hljs-comment"># Update the input shape for the next layer</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Total MACs: <span class="hljs-subst">&#123;total_macs&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p>輸出如下</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs txt">Layer: features.0, Type: Conv2d, Input Shape: (3, 224, 224), Output Shape: (64, 55, 55), MACs: 70276800<br>Layer: features.2, Type: MaxPool2d, Input Shape: (64, 55, 55), Output Shape: (64, 27, 27), MACs: N/A<br>Layer: features.3, Type: Conv2d, Input Shape: (64, 27, 27), Output Shape: (192, 27, 27), MACs: 223948800<br>Layer: features.5, Type: MaxPool2d, Input Shape: (192, 27, 27), Output Shape: (192, 13, 13), MACs: N/A<br>Layer: features.6, Type: Conv2d, Input Shape: (192, 13, 13), Output Shape: (384, 13, 13), MACs: 112140288<br>Layer: features.8, Type: Conv2d, Input Shape: (384, 13, 13), Output Shape: (256, 13, 13), MACs: 149520384<br>Layer: features.10, Type: Conv2d, Input Shape: (256, 13, 13), Output Shape: (256, 13, 13), MACs: 99680256<br>Layer: features.12, Type: MaxPool2d, Input Shape: (256, 13, 13), Output Shape: (256, 6, 6), MACs: N/A<br>Layer: classifier.1, Type: Linear, Input Shape: (256, 6, 6), Output Shape: (4096,), MACs: 37748736<br>Layer: classifier.4, Type: Linear, Input Shape: (4096,), Output Shape: (4096,), MACs: 16777216<br>Layer: classifier.6, Type: Linear, Input Shape: (4096,), Output Shape: (1000,), MACs: 4096000<br>Total MACs: 714188480<br></code></pre></td></tr></table></figure><blockquote><p>Some layers in GoogleNet enable ceil_mode, which will affect the calculation formula for output_shape.</p></blockquote><h3 id="Profiling"><a href="#Profiling" class="headerlink" title="Profiling"></a>Profiling</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision.models <span class="hljs-keyword">as</span> models<br><span class="hljs-keyword">from</span> torch.profiler <span class="hljs-keyword">import</span> profile, record_function, ProfilerActivity<br><br>model = models.alexnet(pretrained=<span class="hljs-literal">True</span>)<br>model.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># Set the model to evaluation mode</span><br>inputs = torch.randn(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)<br><br><span class="hljs-keyword">with</span> profile(activities=[ProfilerActivity.CPU], profile_memory=<span class="hljs-literal">True</span>, record_shapes=<span class="hljs-literal">True</span>) <span class="hljs-keyword">as</span> prof:<br>    model(inputs)<br><br><span class="hljs-built_in">print</span>(prof.key_averages().table(sort_by=<span class="hljs-string">&quot;self_cpu_memory_usage&quot;</span>, row_limit=<span class="hljs-number">10</span>))<br><br></code></pre></td></tr></table></figure><p>這樣可以印出這個 Model 的 Profiling 結果，包含每一個 Operator 的 CPU Time、Memory Usage、Input Shape、Output Shape 等等</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs txt">---------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------<br>                             Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg       CPU Mem  Self CPU Mem    # of Calls<br>---------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------<br>                      aten::empty         0.11%      60.000us         0.11%      60.000us       5.455us       9.25 Mb       9.25 Mb            11<br>    aten::max_pool2d_with_indices         3.52%       1.838ms         3.52%       1.838ms     612.667us       5.05 Mb       5.05 Mb             3<br>                    aten::resize_         0.01%       6.000us         0.01%       6.000us       1.000us     180.00 Kb     180.00 Kb             6<br>                      aten::addmm        36.23%      18.939ms        36.32%      18.984ms       6.328ms     179.53 Kb     179.53 Kb             3<br>                     aten::conv2d         0.07%      36.000us        58.54%      30.601ms       6.120ms       9.25 Mb           0 b             5<br>                aten::convolution         0.21%     111.000us        58.47%      30.565ms       6.113ms       9.25 Mb           0 b             5<br>               aten::_convolution         0.10%      54.000us        58.26%      30.454ms       6.091ms       9.25 Mb           0 b             5<br>         aten::mkldnn_convolution        57.99%      30.313ms        58.15%      30.400ms       6.080ms       9.25 Mb           0 b             5<br>                aten::as_strided_         0.05%      24.000us         0.05%      24.000us       4.800us           0 b           0 b             5<br>                      aten::relu_         0.34%     178.000us         0.86%     447.000us      63.857us           0 b           0 b             7<br>---------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------<br>Self CPU time total: 52.275ms<br></code></pre></td></tr></table></figure><h3 id="TensorBoard"><a href="#TensorBoard" class="headerlink" title="TensorBoard"></a>TensorBoard</h3><p>TensorBoard 可以監控和分析機器學習模型的訓練過程，監測 CPU 和 GPU 的使用情況，看看 Bottleneck 在哪個地方</p><p>下面程式碼是用 CIFAR-10 Dataset 進行 ResNet-18 訓練，用 torch.profiler 儲存 Profile 結果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch.optim<br><span class="hljs-keyword">import</span> torch.profiler<br><span class="hljs-keyword">import</span> torch.utils.data<br><span class="hljs-keyword">import</span> torchvision.datasets<br><span class="hljs-keyword">import</span> torchvision.models<br><span class="hljs-keyword">import</span> torchvision.transforms <span class="hljs-keyword">as</span> T<br><br><br>transform = T.Compose(<br>    [T.Resize(<span class="hljs-number">224</span>),<br>     T.ToTensor(),<br>     T.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])<br>train_set = torchvision.datasets.CIFAR10(root=<span class="hljs-string">&#x27;./data&#x27;</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>, transform=transform)<br>train_loader = torch.utils.data.DataLoader(train_set, batch_size=<span class="hljs-number">32</span>, shuffle=<span class="hljs-literal">True</span>)<br><br>device = torch.device(<span class="hljs-string">&quot;cpu&quot;</span>)<br>model = torchvision.models.resnet18(weights=<span class="hljs-string">&#x27;IMAGENET1K_V1&#x27;</span>)<br>criterion = torch.nn.CrossEntropyLoss()<br>optimizer = torch.optim.SGD(model.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)<br>model.train()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">data</span>):<br>    inputs, labels = data[<span class="hljs-number">0</span>].to(device=device), data[<span class="hljs-number">1</span>].to(device=device)<br>    outputs = model(inputs)<br>    loss = criterion(outputs, labels)<br>    optimizer.zero_grad()<br>    loss.backward()<br>    optimizer.step()<br><br><br><span class="hljs-keyword">with</span> torch.profiler.profile(<br>        schedule=torch.profiler.schedule(wait=<span class="hljs-number">1</span>, warmup=<span class="hljs-number">1</span>, active=<span class="hljs-number">3</span>, repeat=<span class="hljs-number">1</span>),<br>        on_trace_ready=torch.profiler.tensorboard_trace_handler(<span class="hljs-string">&#x27;./log/resnet18&#x27;</span>),<br>        record_shapes=<span class="hljs-literal">True</span>,<br>        profile_memory=<span class="hljs-literal">True</span>,<br>        with_stack=<span class="hljs-literal">True</span><br>) <span class="hljs-keyword">as</span> prof:<br>    <span class="hljs-keyword">for</span> step, batch_data <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):<br>        prof.step()  <span class="hljs-comment"># Need to call this at each step to notify profiler of steps&#x27; boundary.</span><br>        <span class="hljs-keyword">if</span> step &gt;= <span class="hljs-number">1</span> + <span class="hljs-number">1</span> + <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">break</span><br>        train(batch_data)<br></code></pre></td></tr></table></figure><p>接下來可以用以下指令啟動 TensorBoard，監測 Profile 的結果</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">tensorboard --logdir=&#x27;~/projects/lab02/lab2-3/log/&#x27; --bind_all --port=10000 &gt; tensorboard.stdout.log &amp;&gt; tensorboard.stderr.log &amp; # Start TensorBoard<br>kill $(ps -e | grep &#x27;tensorboard&#x27; | awk &#x27;&#123;print $1&#125;&#x27;) # Stop TensorBoard<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/ai-computing-system/TensorBoard.png" alt="TensorBoard"></p><h3 id="Python-C-Frontend"><a href="#Python-C-Frontend" class="headerlink" title="Python C++ Frontend"></a>Python C++ Frontend</h3><h4 id="TorchScript"><a href="#TorchScript" class="headerlink" title="TorchScript"></a>TorchScript</h4><p>TorchScript 是 PyTorch 的一種 IR (Intermediate Representation)，可以在其他環境執行，像是 C++、嵌入式設備或伺服器，有兩種方法可以把 PyTorch Model 轉換成 TorchScript</p><ul><li><p>Tracing<br>用 <code>torch.jit.trace</code>，把 Example Input 丟進去模型跑，將這個 Data 在模型的流向全部記錄起來，藉此捕捉模型的結構</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(torch.nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.fc1 = torch.nn.Linear(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)<br>        self.fc2 = torch.nn.Linear(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.fc1(x)<br>        x = self.fc2(x)<br>        <span class="hljs-keyword">return</span> x<br><br>model = MyModel()<br><br><span class="hljs-comment"># Example Input</span><br>example_input = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)<br><br>traced_model = torch.jit.trace(model, example_input)<br><br>traced_model.save(<span class="hljs-string">&quot;traced_model.pt&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>Scripting<br>用 <code>torch.jit.scrip</code> 直接解析 Python Code，轉換成 TorchScript</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModel</span>(torch.nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.fc1 = torch.nn.Linear(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)<br>        self.fc2 = torch.nn.Linear(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.fc1(x)<br>        x = self.fc2(x)<br>        <span class="hljs-keyword">return</span> x<br><br>scripted_model = torch.jit.script(MyModel())<br><br>scripted_model.save(<span class="hljs-string">&quot;scripted_model.pt&quot;</span>)<br></code></pre></td></tr></table></figure></li></ul><h4 id="LibTorch"><a href="#LibTorch" class="headerlink" title="LibTorch"></a>LibTorch</h4><p><a href="https://pytorch.org/get-started/locally/">LibTorch</a> 可以用來在 C++ 環境中執行 TorchScript，可以用 CMake 來建置 C++ 程式，並且連結 LibTorch 的 Library 來執行 TorchScript</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;torch/script.h&gt;</span> <span class="hljs-comment">// One-stop header.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;torch/csrc/jit/api/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;torch/csrc/jit/jit_log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;torch/csrc/jit/ir/ir.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> torch::jit;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* argv[])</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;usage: example-app &lt;path-to-exported-script-module&gt;\n&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">set_jit_logging_levels</span>(<span class="hljs-string">&quot;GRAPH_DUMP&quot;</span>);<br><br>  torch::jit::script::Module <span class="hljs-keyword">module</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// Deserialize the ScriptModule from a file using torch::jit::load().</span><br>    <span class="hljs-keyword">module</span> = torch::jit::<span class="hljs-built_in">load</span>(argv[<span class="hljs-number">1</span>]);<br>  &#125;<br>  <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> c10::Error&amp; e) &#123;<br>    std::cerr &lt;&lt; <span class="hljs-string">&quot;error loading the model\n&quot;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  std::cout &lt;&lt; <span class="hljs-string">&quot;load the torchscript model, &quot;</span> + std::<span class="hljs-built_in">string</span>(argv[<span class="hljs-number">1</span>]) + <span class="hljs-string">&quot;, successfully \n&quot;</span>;<br><br>  <span class="hljs-comment">// Create a vector of inputs.</span><br>  std::vector&lt;torch::jit::IValue&gt; inputs;<br>  inputs.<span class="hljs-built_in">push_back</span>(torch::<span class="hljs-built_in">ones</span>(&#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>&#125;));<br><br>  <span class="hljs-comment">// Execute the model and turn its output into a tensor.</span><br>  at::Tensor output = <span class="hljs-keyword">module</span>.forward(inputs).<span class="hljs-built_in">toTensor</span>();<br>  std::cout &lt;&lt; output.<span class="hljs-built_in">slice</span>(<span class="hljs-comment">/*dim=*/</span><span class="hljs-number">1</span>, <span class="hljs-comment">/*start=*/</span><span class="hljs-number">0</span>, <span class="hljs-comment">/*end=*/</span><span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br><br>  <span class="hljs-comment">//dump the model information</span><br>  <span class="hljs-comment">// source code can be found in</span><br>  <span class="hljs-comment">// https://github.com/pytorch/pytorch/blob/main/torch/csrc/jit/api/module.cpp</span><br>  std::cout &lt;&lt; <span class="hljs-keyword">module</span>.<span class="hljs-built_in">dump_to_str</span>(<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">false</span>) &lt;&lt; <span class="hljs-string">&quot; (\n&quot;</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><p>Build &amp; Compile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># create config</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cmake -DCMAKE_PREFIX_PATH=./libtorch ..</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># compile</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cmake --build . --config Release -j <span class="hljs-variable">$&#123;nproc&#125;</span></span><br></code></pre></td></tr></table></figure></li><li><p>Build 完後，可以跑 C++ 程式，並輸入剛剛轉出來的 TorchScript (.pt) 檔案</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./analyzer ../../traced_resnet18.pt<br></code></pre></td></tr></table></figure></li></ul><p>可以參考 <a href="https://pytorch.org/cppdocs/index.html">PyTorch C++ API</a> 了解更多 C++ API 的使用方式</p>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VLSI PDA - Physical Design Introduction</title>
    <link href="/notes/2025/02/25/vlsi-physical-design-automation-1/"/>
    <url>/notes/2025/02/25/vlsi-physical-design-automation-1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考清大王廷基老師課程講義</p></blockquote><h2 id="IC-Design-Flow"><a href="#IC-Design-Flow" class="headerlink" title="IC Design Flow"></a>IC Design Flow</h2><ul><li><p>System Specification</p><p>定義系統的需求，例如：功耗、面積、效能、功能等等。</p></li><li><p>Functional Design</p><p>定義系統的功能，例如：模擬、驗證、合成等等。</p></li><li><p>Logic Synthesis</p><p>把功能描述轉換成電路描述，並做邏輯上的優化，例如：RTL、Netlist。</p></li><li><p>Circuit Design</p><p>早期才有，這些 Logic Gate 要用那些 Transistor 來做。現在都用 <code>Cell Based Design</code>，從 <code>Cell Library</code> 拿標準元件來做，這些元件的 Layout 都已經設計好了。</p></li><li><p>Physical Design</p></li><li><p>Fabrication</p></li><li><p>Packaging &amp; Testing</p></li></ul><h2 id="Physical-Desgin"><a href="#Physical-Desgin" class="headerlink" title="Physical Desgin"></a>Physical Desgin</h2><p>把 <code>Circuit Netlist</code> 轉換成 <code>Layout</code> 的過程，每個元件要擺哪、要怎麼連接、怎麼樣才能達到最佳的 <strong>Power</strong>, <strong>Performance</strong>, <strong>Area</strong> (PPA)，甚至於 <strong>Security</strong>。</p><p><img src="/notes/./images/vlsi-physical-design-automation/CircuitNetlist.png" alt="Circuit Netlist"></p><h4 id="Computer-Aided-Design-CAD"><a href="#Computer-Aided-Design-CAD" class="headerlink" title="Computer-Aided Design (CAD)"></a>Computer-Aided Design (CAD)</h4><ul><li><strong>CAD</strong> 是一個廣泛的領域，包含了各種不同的應用，例如：電路設計、機械設計、建築設計、電子設計等等。</li><li><strong>EDA</strong> 是 CAD 的一個子集，專門用來設計電子電路。</li></ul><h3 id="Physical-Design-Flow"><a href="#Physical-Design-Flow" class="headerlink" title="Physical Design Flow"></a>Physical Design Flow</h3><ul><li>Partitioning<br>將整個設計拆分成較小的模組或區塊，以便於後續的設計。</li><li>Floorplanning<br>確定各個功能模組 (Functional Unit Block) 的位置</li><li>Placement<br>將標準單元（Standard Cells）、IPs 放到前面的 Functional Unit Block 裡面，常常跟 Floorplanning 一起做。</li><li>Clock Tree Synthesis<br>讓所有 Clock 訊號能夠同步傳遞到各個元件</li><li>Routing<br>根據 Netlist 和 Placement 的資訊，把元件之間的連線接起來</li><li>Post-routing Optimization</li><li>Compaction<br>早期才有，把 Placement 的結果做最佳化，現在都直接在 Placement 決定面積要多大</li><li>Extraction &amp; Verification</li></ul><p>不同步驟之間常常會有 feedback loop</p><h4 id="IP-Intellectual-Property"><a href="#IP-Intellectual-Property" class="headerlink" title="IP (Intellectual Property)"></a>IP (Intellectual Property)</h4><ul><li>Hard IP<br>通常是一個完整的功能模組，例如：CPU、GPU、DDR Controller</li><li>Soft IP<br>通常是一個功能模組的 RTL Code，Layout 還沒決定，可以根據不同的製程和需求做修改</li></ul><h4 id="Moore’s-Law"><a href="#Moore’s-Law" class="headerlink" title="Moore’s Law"></a>Moore’s Law</h4><p>每隔 18-24 個月，晶片上的元件數量會增加一倍</p><ul><li><p><strong>More Moore</strong></p><p>依賴於先進製程技術的推進（7nm → 5nm → 3nm → 2nm）。</p><ul><li>FinFET → GAAFET（環繞閘極電晶體）→ CFET (互補場效應電晶體)</li><li>EUV (Extreme Ultraviolet Lithography)</li><li>先進封裝技術，Chiplet、3D IC</li></ul></li><li><p><strong>More than Moore</strong></p><p>專注於縮小電晶體尺寸</p><ul><li>Compute-in-Memory</li></ul></li></ul><h3 id="VLSI-Design-Considerations"><a href="#VLSI-Design-Considerations" class="headerlink" title="VLSI Design Considerations"></a>VLSI Design Considerations</h3><ul><li>Design Complexity</li><li>Performance</li><li>Time-to-Market</li><li>Cost: Die Area, Packaging, Testing</li><li>Power Consumption、Noise、Reliability</li></ul><p>考慮到不同的目標，會有不同的設計方法，像是：<code>Full Custom Design</code>, <code>Standard Cell Design</code>, <code>Gate Array Design</code>, <code>FPGA</code>, <code>CPLD</code>, <code>SPLD</code>, <code>SSI</code></p><h4 id="Full-Custom-Design"><a href="#Full-Custom-Design" class="headerlink" title="Full Custom Design"></a>Full Custom Design</h4><p>完全自訂，可以達到最佳的 PPA，但是花費時間和金錢最多</p><h4 id="Standard-Cell-Design"><a href="#Standard-Cell-Design" class="headerlink" title="Standard Cell Design"></a>Standard Cell Design</h4><p><img src="/notes/./images/vlsi-physical-design-automation/StandardCellDesign.png" alt="Standard Cell Design"><br>有一個 <code>Cell Library</code>，裡面有很多標準元件，每個都有固定的高度。Layout 都已經設計好了，只要做 Metal Layer 就好</p><p>早期 Metal 層數不多，可以留 Routing Channel、Feedthrough Cell 來連接不同的 Cell。現在層數比較多，連線都在上空，所以可以把整 Row 的 Cell 翻轉，讓 GND 在一邊、VDD 在另一邊，減少 Routing 的複雜度</p><h4 id="Gate-Array-Design"><a href="#Gate-Array-Design" class="headerlink" title="Gate Array Design"></a>Gate Array Design</h4><p><img src="/notes/./images/vlsi-physical-design-automation/GateArrayDesign.png" alt="Gate Array Design"></p><p>Cell 裡面、Cell 之間的連線都沒有決定，可以根據需求來做 (沒什麼人在用?</p><h4 id="FPGA-Field-Programmable-Gate-Array"><a href="#FPGA-Field-Programmable-Gate-Array" class="headerlink" title="FPGA (Field Programmable Gate Array)"></a>FPGA (Field Programmable Gate Array)</h4><p><img src="/notes/./images/vlsi-physical-design-automation/FPGA.png" alt="FPGA"></p><p>可以決定每個 Cell 的功能，線也連好了，線可以用 Switch、Switch Box 控制</p><h5 id="LUT-Look-Up-Table"><a href="#LUT-Look-Up-Table" class="headerlink" title="LUT (Look-Up Table)"></a>LUT (Look-Up Table)</h5><p>把某個計算過程的所有 Input 組合對應的 Output 存起來，這樣就不用每次都重新計算</p><h4 id="SPLD-Simple-Programmable-Logic-Device"><a href="#SPLD-Simple-Programmable-Logic-Device" class="headerlink" title="SPLD (Simple Programmable Logic Device)"></a>SPLD (Simple Programmable Logic Device)</h4><p>比 FPGA 簡單，只有一個矩陣，沒有 LUT</p><h4 id="Comparison"><a href="#Comparison" class="headerlink" title="Comparison"></a>Comparison</h4><table><thead><tr><th align="center"></th><th align="center">Full Custom</th><th align="center">Standard Cell</th><th align="center">Gate Array</th><th align="center">FPGA</th><th align="center">SPLD</th></tr></thead><tbody><tr><td align="center">Cell Size</td><td align="center">variable</td><td align="center">fixed height</td><td align="center">fixed</td><td align="center">fixed</td><td align="center">fixed</td></tr><tr><td align="center">Cell Type</td><td align="center">variable</td><td align="center">variable</td><td align="center">fixed</td><td align="center">programmable</td><td align="center">programmable</td></tr><tr><td align="center">Cell Placement</td><td align="center">variable</td><td align="center">in row</td><td align="center">fixed</td><td align="center">fiexed</td><td align="center">fixed</td></tr><tr><td align="center">Interconnections</td><td align="center">variable</td><td align="center">variable</td><td align="center">variable</td><td align="center">programmable</td><td align="center">programmable</td></tr></tbody></table><p>高度的單位通常用 <code>Track</code> (<strong>T</strong>) 表示。因為 Standard Cell 的高度不是固定的，有些是 5 Track、有些是 7 Track，所以在做 Placement 的時候要考慮這些高度不同的 Cell (哪些 Row 要放某種高度的 Cell 之類的)</p><table><thead><tr><th align="center"></th><th align="center">Full Custom</th><th align="center">Standard Cell</th><th align="center">Gate Array</th><th align="center">FPGA</th><th align="center">SPLD</th></tr></thead><tbody><tr><td align="center">Fabrication Time</td><td align="center">—</td><td align="center">–</td><td align="center">+</td><td align="center">+++</td><td align="center">++</td></tr><tr><td align="center">Packing Density</td><td align="center">+++</td><td align="center">++</td><td align="center">+</td><td align="center">–</td><td align="center">—</td></tr><tr><td align="center">Unit Cost in Large Quantity</td><td align="center">+++</td><td align="center">++</td><td align="center">+</td><td align="center">–</td><td align="center">-</td></tr><tr><td align="center">Unit Cost in Small Quantity</td><td align="center">—</td><td align="center">–</td><td align="center">+</td><td align="center">+++</td><td align="center">++</td></tr><tr><td align="center">Easy Desgin and Simulation</td><td align="center">—</td><td align="center">–</td><td align="center">-</td><td align="center">++</td><td align="center">+</td></tr><tr><td align="center">Easy Desgin Change</td><td align="center">—</td><td align="center">–</td><td align="center">-</td><td align="center">++</td><td align="center">++</td></tr><tr><td align="center">Accuracy of Timing Simulation</td><td align="center">-</td><td align="center">-</td><td align="center">-</td><td align="center">+</td><td align="center">++</td></tr><tr><td align="center">Chip Speed</td><td align="center">+++</td><td align="center">++</td><td align="center">+</td><td align="center">-</td><td align="center">–</td></tr></tbody></table><h4 id="Macro-Cells"><a href="#Macro-Cells" class="headerlink" title="Macro Cells"></a>Macro Cells</h4><p>Macro 是常常用到的，很大片的 Logic Cell，可能包含很多個 Standard Cell，例如：ALU、Multiplier、Memory</p><p><img src="/notes/./images/vlsi-physical-design-automation/MacroCells.png" alt="Macro Cells"></p><h4 id="Structured-ASIC-Application-Specific-Integrated-Circuit"><a href="#Structured-ASIC-Application-Specific-Integrated-Circuit" class="headerlink" title="Structured ASIC (Application Specific Integrated Circuit)"></a>Structured ASIC (Application Specific Integrated Circuit)</h4><ul><li>ASIC<br>專門為某個應用設計的晶片，常常被用來跟 FPGA 做區隔，不是 FPGA 的就稱為 ASIC</li></ul><p>Structured ASIC 介於 FPGA 和 Gate Array 之間，會事先定義好一些 Metal Layers 和 Via Layers (Cut Layers)，剩下的 Layers 都是 Customizable，根據需求來客製化。很適合 ECO (Engineering Change Order)，只要改 Customizable 的部分就好</p><blockquote><p>越低層的 Layer 的線會比較細，RC 特性比較差，Timing 也會比較差，Delay 比較大。反之，越高層的 Layer，線會比較粗，Delay 比較小，因此越重要的 Signal 會放在越高層的 Layer</p></blockquote><h3 id="Design-Rules"><a href="#Design-Rules" class="headerlink" title="Design Rules"></a>Design Rules</h3><ul><li><p>Size Rules<br>限制最小的長度、寬度</p></li><li><p>Seperation Rules<br>限制元件之間最小的間距，可能是同一層或相鄰層，可能是 Rectilinear、Euclidean diagonal distance，避免短路。Spacing 的部分不是常數，會隨著與相鄰 (不同 Track) Metal 重疊的部分有所不同</p></li><li><p>Overlap Rules<br>限制元件之間的重疊的最小面積。每一層 Layer 會有不同的光罩，有時候會有誤差，所以會需要一些 Overlap 來保護</p></li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/DesignRules.png" alt="Design Rules"></p>]]></content>
    
    
    <categories>
      
      <category>VLSI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>vlsi</tag>
      
      <tag>physical design</tag>
      
      <tag>automation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VLSI PDA - Partitioning</title>
    <link href="/notes/2025/02/25/vlsi-physical-design-automation-2/"/>
    <url>/notes/2025/02/25/vlsi-physical-design-automation-2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考清大王廷基老師課程講義</p></blockquote><h2 id="Partitioning"><a href="#Partitioning" class="headerlink" title="Partitioning"></a>Partitioning</h2><p>把整個設計拆分成較小的電路或系統，每個部分可以獨立設計，最後再合併在一起。Decomposition 必須最小化這蠍子系統間的 Interconnection。其他還要考慮的點有</p><ul><li><p>Constraints<br>確保每個部分都符合劃定的條件，像是你每個子系統都要用一個 FPGA 來實現，就要確保子系統的元件數量、I&#x2F;O Pin 的數量不超過 FPGA 的限制</p></li><li><p>Communication<br>子系統之間的連線訊號不要出現在 Critical Path 上，晶片內的 Timing 跟 PCB 的 Timing 不一樣</p></li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/Partitioning.png" alt="Partitioning"></p><ul><li>Cutset: 一個 Cut 包含很多被切掉的 Net，Cutset 就是這些 Net 的集合</li><li>Cut size: Cutset 的大小</li><li>有些 Edge 可以賦予 Weight (像是 Critical Path 上的 Edge)</li></ul><h3 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h3><p>給定 Graph $G &#x3D; (V, E)$，每個 Vertex $v \in V$ 有 Size $s(v)$，每個 Edge $e \in E$ 有 Weight $w(e)$，要把 set $V$ 分成 $k$ 個 Partition，使得每個 Partition 的 Size 在某限制範圍內，並且最小化 Cutset 的 Weight。</p><p>就算是在 $k &#x3D; 2$、每個頂點 size 都一樣、每條邊的 weight 也一樣的情況下，在有 Size Constraint 的情況下，這個問題還是 NP-Hard</p><blockquote><p>若沒有 Size Constraint，這個問題就是 Maximum Flow Minimum Cut 問題，可以在 Polynomial Time 解決</p></blockquote><h3 id="Kernighan-Lin-KL-Algorithm"><a href="#Kernighan-Lin-KL-Algorithm" class="headerlink" title="Kernighan-Lin (KL) Algorithm"></a>Kernighan-Lin (KL) Algorithm</h3><p>KL Algorithm 是一種 Greedy 的 Heuristic Algorithm，不保證找到最佳解，但是通常結果不錯</p><p>針對 2-way Partitioning、每個頂點 Size 一樣、每條邊都是 2-terminal nets 的情況，且兩個集合的 Size 要一樣大 (又稱 Balanced Partitioning、Bi-sectioning)</p><ol><li>隨機把所有頂點分成兩個集合 $A$、$B$</li><li>Pass<ol><li>選出 Gain 最大的 Pair $(u, v)$，$u \in A$、$v \in B$，並且交換 $u$、$v$ 的 Partition</li><li>Lock $u$、$v$，之後交換不再考慮這兩個頂點</li><li>直到所有頂點都被 Lock</li><li>算出最大的 Partial Sum Gain $G$，這個 Gain 就是這次 Pass 的 Gain</li><li>假設前 $k$ 個 Pair 的 Gain 總和 $G_k$ 是最大的，就真的去交換前 $k$ 個 Pair</li></ol></li><li>重複 Pass，直到 Partial Sum Gain $G \leq 0$</li></ol><ul><li>Gain<br>$$<br>\text{Gain}(u, v) &#x3D; \text{Old_Cutset}(A, B) - \text{New_Cutset}(A, B)<br>$$<br>在同個 Pass 中，第二次算 Gain 的時候，它的 $\text{Old_Cutset}(A, B)$ 是第一次算 Gain 的結果</li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/KLAlgorithmExample.png" alt="KL Algorithm Example"></p><p>可以發現交換頂點 $u$、$v$ 之後，$u \in A$、$v \in B$，原本 $u$ 和集合 $B$ 所有頂點的連線都不用算在 Cut (<strong>$u$、$v$ 連線除外</strong>)，但原本 $u$ 和集合 $A$ 所有頂點的連線都要多算，同理於 $v$。因此在計算的時候只要考慮 <code>External Cost</code> 和 <code>Internal Cost</code> 就好</p><ul><li><p>External Cost</p><p>$$<br>\text{External_Cost}(u) &#x3D; \sum_{v \in B} w(u, v)<br>$$</p></li><li><p>Internal Cost</p><p>$$<br>\text{Internal_Cost}(u) &#x3D; \sum_{v \in A} w(u, v)<br>$$</p></li><li><p>Cost Reduction for moving $u$ (D-value)</p><p>$$<br>\text{D-value}(u) &#x3D; \text{External_Cost}(u) - \text{Internal_Cost}(u)<br>$$</p></li><li><p>Cost Reduction for swapping $u$ and $v$ (Gain)<br>$$<br>\text{Gain}(u, v) &#x3D; \text{D-value}(u) + \text{D-value}(v) - 2w(u, v)<br>$$</p></li></ul><p>假設上述的 $u$、$v$ 是第一次交換，且 $x \in A - {u}$ 會在第二次被交換。第一次交換後必須更新 $x$ 的 D-value，因為 $x$ 的 Internal Cost 和 External Cost 都可能改變。</p><p>原本 $x$ 和 $u$ 的連線不用算在 Cut，但是 $x$ 和 $v$ 的連線要算在 Cut，交換後一來一回都各自差兩倍</p><p>$$<br>\text{D-value}^\prime(x) &#x3D; \text{D-value}(x) + 2w(x, u) - 2w(x, v)<br>$$</p><h4 id="Time-Complexity"><a href="#Time-Complexity" class="headerlink" title="Time Complexity"></a>Time Complexity</h4><ul><li>算出每個頂點的 D-value: $O(n^2)$</li><li>一次 Pass 中，要交換所有頂點，每次交換都要找到所有 Pair 中最大的 Gain: $O(n \cdot n^2) &#x3D; O(n^3)$</li><li>若總共有 $r$ 次 Pass: $O(r \cdot n^3)$</li></ul><p>要做幾次 Pass 跟 Initial Partition 有關，但不管要做幾次，最後這個演算法一定可以結束，$r$ 一定是 <em>Finite Number</em></p><p>對於 K-way Partitioning 的問題，也可以用 KL Algorithm 來做</p><ul><li>一開始 Partition 成 K 個 set，讓這些 set 彼此之間套用 KL Algorithm，直到所有 set 都不再改變</li><li>一開始 Partition 成 2 個 set，用 Recursive 的方式來做，直到 Partition 成 K 個 set，一樣兩兩套用 KL Algorithm</li></ul><h4 id="KL-Algorithm-的缺點"><a href="#KL-Algorithm-的缺點" class="headerlink" title="KL Algorithm 的缺點"></a>KL Algorithm 的缺點</h4><ul><li><p>假設所有頂點的 Size 都一樣</p><p>對於真實的 Logic Gate 來說，每個 Gate 的 Size (面積、大小) 都不一樣。</p><p>可以把這個頂點變成很多個單位頂點，形成一個 <code>Clique</code>，兩兩之間都有 Edge 相連，且讓他們的 Weight 超大，在做 KL 的時候可以保證這些頂點會在同一個 Partition。</p><p>但是這樣整個 Graph 的 Size 會變很大，頂點數量和邊數都大幅增加</p></li><li><p>KL Algorithm 只能考慮集合的 Size 相同的情況</p><p>要處理 Unbalanced Partitioning 的問題的話可以加入一些 Dummy Vertices</p></li><li><p>KL Algorithm 不能處理 Hypergraph</p><p>Hypergraph 是一種 Graph 的延伸，一個 Edge 可以連接多個 Vertex。要處裡這種問題要先把 Hypergraph 轉換成一般的 Graph</p></li><li><p>複雜度高: $O(n^3)$</p></li></ul><h3 id="Fiduccia-Mattheyses-FM-Algorithm"><a href="#Fiduccia-Mattheyses-FM-Algorithm" class="headerlink" title="Fiduccia-Mattheyses (FM) Algorithm"></a>Fiduccia-Mattheyses (FM) Algorithm</h3><p>FM Algorithm 一樣是 Greedy 的 Heuristic Algorithm，為 KL Algorithm 的改良版，可以把 Pass 的複雜度降到 Linear Time</p><h4 id="與-KL-Algorithm-不同的地方"><a href="#與-KL-Algorithm-不同的地方" class="headerlink" title="與 KL Algorithm 不同的地方"></a>與 KL Algorithm 不同的地方</h4><ul><li><p>一次只搬運一個 Vertex</p><p>可以想像一次只搬運一個 Vertex 的 Solutuon Space 會更大，更有機會找到更好的解</p></li><li><p>Vertex 可以有不同的 Size</p></li><li><p>可以處理不嚴格的 Unbalanced Partitioning</p></li><li><p>用 Bucket Sort 來選擇要移動的 Vertex</p></li><li><p>每次 Pass 的時間複雜度是 $O(P)$，$P$ 是 Pin 的數量</p></li></ul><h4 id="Notation"><a href="#Notation" class="headerlink" title="Notation"></a>Notation</h4><ul><li>$n(i)$: Net $i$ 連到 Cell 的數量，ex: $n(1) &#x3D; 4$</li><li>$s(i)$: Cell $i$ 的 Size</li><li>$p(i)$: Cell $i$ 的 Pin 的數量，ex: $p(6) &#x3D; 3$</li><li>$C$: Cell 的總數，ex: $C &#x3D; 6$</li><li>$N$: Net 的總數，ex: $N &#x3D; 6$</li><li>$P$: Pin 的總數，ex: $P &#x3D; p(1) + p(2) + \cdots + p(C)$</li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/FMAlgorithmExample.png" alt="FM Algorithm Example"></p><h4 id="Cut"><a href="#Cut" class="headerlink" title="Cut"></a>Cut</h4><p><img src="/notes/./images/vlsi-physical-design-automation/Cut.png" alt="Cut"></p><ul><li>Cutstate: 這個 Net 有沒有被切到<ul><li>Net 1 和 Net 3 的狀態是 <code>Cut</code></li><li>Net 2、Net 4、Net 5 和 Net 6 的狀態是 <code>Uncut</code></li></ul></li><li>Cutset: 被切到的 Net 的集合<ul><li>Cutset &#x3D; {Net 1, Net 3}</li></ul></li><li>$\lvert A \rvert$ &#x3D; size of set $A$ &#x3D; $s(1) + s(5)$</li><li>$\lvert B \rvert$ &#x3D; $s(2) + s(3) + s(4) + s(6)$</li></ul><p>本質上是一個 <code>Balanced Partitioning</code> 的問題加上一點彈性。給定一個常數 $r$，把一個 Hypergraph Partition 成兩個集合 $A$、$B$ 後，要滿足</p><p>$$<br>\frac{\lvert A \rvert}{\lvert A \rvert + \lvert B \rvert} \approx r<br>$$</p><p>也就是 <strong>分在 A 那邊的面積</strong> 要佔整個面積的 $r$，且希望 Cutset 的 Size 越小越好</p><p>其中 $r$ 的意義是</p><p>$$<br>rW - S_{\text{max}} \leq \lvert A \rvert \leq rW + S_{\text{max}}<br>$$</p><p>其中</p><ul><li>$W$ 是整個 Hypergraph 的總面積，$W &#x3D; \lvert A \rvert + \lvert B \rvert$</li><li>$S_{\text{max}}$ 是最大的 Cell 的 Size</li></ul><h4 id="Input-Data-Structure"><a href="#Input-Data-Structure" class="headerlink" title="Input Data Structure"></a>Input Data Structure</h4><p>根據傳進來的 Netlist，可以建立 Cell Array 和 Net Array，分別需要 $O(P)$ (Pin 數量) 的時間複雜度<br><img src="/notes/./images/vlsi-physical-design-automation/InputDataStructure.png" alt="Input Data Structure"></p><h4 id="Balance-Movement"><a href="#Balance-Movement" class="headerlink" title="Balance &amp; Movement"></a>Balance &amp; Movement</h4><ul><li><p>Initial Balance</p><p>先讓 A 為空集合，B 為所有 Cell 的集合，老師提供兩種方法：一種是把 B 按照 Size 做排序，一個一個 Cell 放進 A，直到滿足 $r$ 的條件；另一種是不排序，隨機挑選 Cell 放進 A，直到滿足 $r$ 的條件</p></li><li><p>Gain</p><p>$$<br>\text{Gain}(i) &#x3D; \text{Cutset}(A, B) - \text{Cutset}(A - {i}, B \cup {i})<br>$$</p><p>也就是把 Cell $i$ 從 A 搬到 B，Cutset 的 Size 會變小多少</p></li><li><p>Movement</p><p>每次只搬一個 Cell，兩邊之中選一個 Gain 最大的 Cell 搬過去，如果符合 $r$ 的條件就搬，不符合就不搬，並且 Lock 這個 Cell，之後不再考慮 (沒搬成功的不要 Lock)</p><p>最後跟 KL 一樣，直到所有 Cell 都被 Lock 之後，找出最大的 Partial Sum Gain，這個 Gain 就是這次 Pass 的 Gain，真的去搬那些 Cell</p></li></ul><h4 id="Cell-Gains-and-Data-Structure-Manipulation"><a href="#Cell-Gains-and-Data-Structure-Manipulation" class="headerlink" title="Cell Gains and Data Structure Manipulation"></a>Cell Gains and Data Structure Manipulation</h4><p>首先要知道的是，每個 Cell 移動的 Gain 值跟它的 Pin 數量有關</p><p><img src="/notes/./images/vlsi-physical-design-automation/CellGains.png" alt="Cell Gains"></p><p>因此可以確定移動一個 Cell 的 Gain 絕對不會超出它本身 Pin 的數量</p><p>$$<br>-p(i) \leq \text{Gain}(i) \leq p(i)<br>$$</p><p>接著集合 A 和 B 個有一個 Size 為 $(2 \cdot P_\text{max} + 1)$ 的 <code>Bucket List</code>，每個 Entry 代表一個 Gain 的值，每個 Entry 裡面存放 Gain 值相同的 Cell 的編號，用 Doubly Linked List 儲存起來</p><blockquote><p>$P_\text{max}$ 是所有 Cell 中 Pin 數量最多那個值</p></blockquote><p>除此之外，還會有個 Cell Array，每個 Cell 有一個指標指向它在 Bucket List 中的位置，這樣可以在 $O(1)$ 的時間內找到目標 Cell</p><p>最後，Bucket 裡面還有一個 Max Gain 變數，用來記錄這個集合中最大的 Gain 值，就可以藉由這個變數去找目標 Entry 的第一個 Cell，也就是 Gain 最大的 Cell</p><p><img src="/notes/./images/vlsi-physical-design-automation/BucketList.png" alt="Bucket List"></p><h4 id="Net-Distribution-and-Critical-Nets"><a href="#Net-Distribution-and-Critical-Nets" class="headerlink" title="Net Distribution and Critical Nets"></a>Net Distribution and Critical Nets</h4><ul><li><p>Distribution of Net i 的定義</p><p>$(A(i), B(i)) &#x3D; (2, 3)$ 代表 Net $i$ 有 2 個 Pin 在 A，3 個 Pin 在 B</p><p>計算所有 Net 的 Distribution 的時間複雜度是 $O(P)$</p></li><li><p>Critical Nets</p><p>如果移動任何一個 Cell 會改變這個 Net 的 Cutstate，這個 Net 就稱為 <strong>Critical Net</strong>。</p><p>可以想像只有 <strong>Cut-&gt;Uncut</strong> 或 <strong>Uncut-&gt;Cut</strong> 兩種情況，因此只會發生在 <strong>移動前後所有 Pin 都在同一邊</strong> 的情況下，也就是</p><p>$$<br>(A(i), B(i)) &#x3D; (0, n(i)) \text{ or } (n(i), 0)<br>$$</p><p>只有 Critical Nets 才會影響 Gain 的計算</p></li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/CriticalNets.png" alt="Critical Nets"></p><h4 id="Computing-Cell-Gains"><a href="#Computing-Cell-Gains" class="headerlink" title="Computing Cell Gains"></a>Computing Cell Gains</h4><p>一開始要對每個 Cell <strong>Iterate 一次所有連到它的 Net</strong> ，藉此計算它的 Gain，時間複雜度為 $O(P)$</p><p><img src="/notes/./images/vlsi-physical-design-automation/ComputingCellGainsExample.png" alt="Computing Cell Gains Example"></p><p>可以看到對於某 Net $n$，在 $F(n) &#x3D; 1$ 時，移動這個 Cell $i$ 會讓 Net $n$ 從 Cut 變成 Uncut，因此這個 Net 對於這個 Cell 貢獻的 Gain 就是 1</p><p>另一種情況是當 $T(n) &#x3D; 0$ 時，移動這個 Cell $i$ 會讓 Net $n$ 從 Uncut 變成 Cut，因此這個 Net 對於這個 Cell 貢獻的 Gain 就是 -1</p><h4 id="Algorithm-for-Updating-Cell-Gains"><a href="#Algorithm-for-Updating-Cell-Gains" class="headerlink" title="Algorithm for Updating Cell Gains"></a>Algorithm for Updating Cell Gains</h4><p><img src="/notes/./images/vlsi-physical-design-automation/AlgorithmForUpdatingCellGains.png" alt="Algorithm for Updating Cell Gains"></p><p>只要想成 <strong>目標是 Cut Size 越小越好</strong>，所以要找 <strong>Gain 最大的 Cell</strong>，<strong>我們越傾向於移過去某 Cell 後 Net 會變 Uncut 的情況</strong>，因此該 Net 對於該 Cell 的 Gain 就是 1，反之越不希望 Net 變 Cut，該 Net 對於該 Cell 的 Gain 就是 -1</p><p>每次 Update 的時間複雜度是 $O(P)$</p><h3 id="Simulated-Annealing-SA-Algorithm"><a href="#Simulated-Annealing-SA-Algorithm" class="headerlink" title="Simulated Annealing (SA) Algorithm"></a>Simulated Annealing (SA) Algorithm</h3><p>感覺很像機器學習，目的是找到 Global Optimal Solution，但常常會卡在 Local Optimal Solution</p><p><img src="/notes/./images/vlsi-physical-design-automation/SimulatedAnnealing.png" alt="Simulated Annealing"></p><h4 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h4><p>概念是讓 <code>up-hill move</code> 出現的機率不為 0，其機率會由 <code>up-hill</code> 的量和溫度 T 來決定</p><p>$$<br>\text{Prob}(S \rightarrow S^\prime) &#x3D; \begin{cases}<br>1 &amp; \text{if } \Delta C \leq 0 \<br>e^{-\Delta C &#x2F; T} &amp; \text{if } \Delta C &gt; 0<br>\end{cases}<br>$$</p><ul><li>其中<ul><li>$\Delta C$ 是 Cost 的變化量，$\text{Cost}(S^\prime) - \text{Cost}(S)$</li><li>$T$ 是溫度，隨著時間遞減，讓 <code>up-hill move</code> 的機率越來越小，因此 $T_i &#x3D; r^i \cdot T_0$，$r$ 是一個介於 0 和 1 之間的常數</li></ul></li></ul><h4 id="Generic-SA-Algorithm"><a href="#Generic-SA-Algorithm" class="headerlink" title="Generic SA Algorithm"></a>Generic SA Algorithm</h4><p><img src="/notes/./images/vlsi-physical-design-automation/GenericSAAlgorithm.png" alt="Generic SA Algorithm"></p><blockquote><p>早期受限於記憶體大小，不會把曾經算過的最佳解存起來，這裡就是偏早期的作法</p></blockquote><p>可以看到 SA 構成的四大要素為</p><ul><li>Solution Space: 所有可能的解</li><li>Neighborhood Structure: 定義了如何從一個解移動到另一個解</li><li>Cost Function: 用來評估一個解的好壞</li><li>Annealing Schedule: 決定了溫度如何隨時間變化</li></ul><h4 id="Partitioning-by-SA"><a href="#Partitioning-by-SA" class="headerlink" title="Partitioning by SA"></a>Partitioning by SA</h4><p>在 Partitioning 的問題中</p><ul><li>Solution Space: 所有可能的 Partition</li><li>Neighborhood Structure: 一次只搬一個 Cell 到另一邊</li><li>Cost Function: Cutset 的 Size + Balance 的 Cost</li><li>Annealing Schedule: 溫度隨時間遞減</li></ul><p>其中 Cost Function 的定義為</p><p>$$<br>f &#x3D; C + \lambda B<br>$$</p><ul><li>$C$: Cutset 的 Size</li><li>$B$: 評估現在 Balance 的程度，又定義成 $B &#x3D; (|S1| - |S2|)^2$</li><li>$\lambda$: 一個常數，用來決定 Balance 的重要程度</li></ul><p>Annealing Schedule 的定義為</p><p>$$<br>T_i &#x3D; r^i \cdot T_0<br>$$</p><ul><li>$r$ 通常定成 0.9</li><li>每當 <strong>每個 Cell 平均成功移動 10 次</strong> 或 <strong>嘗試移動次數超過 100 * 總 Cells 數量</strong> 的情況發生，就把溫度調成 $r$ 倍</li><li>如果 <strong>連續 3 種溫度都沒有移動成功</strong> 就結束，像是機器學習的 Early Stopping</li></ul><h3 id="Multi-Level-Partitioning"><a href="#Multi-Level-Partitioning" class="headerlink" title="Multi-Level Partitioning"></a>Multi-Level Partitioning</h3><p>可以分成三個步驟</p><ol><li><p>Coarsening<br>把許多小 Cell 合併成大 Cell，也就是把 Graph 變成更小的 Graph，這樣可以減少計算量。通常會做很多次 Coarsening</p></li><li><p>Initial Partitioning<br>在 Coarsest 的 Graph 上做 Partitioning (KL、FM、SA)</p></li><li><p>Uncoarsening<br>把 Initial Partitioning 的結果做 Uncoarsening，把一些原本併在一起的 Cells 拆開，放大整個 Graph，可以想像原本在 A 集合的 Cells 做 Uncoarsening 後還是在 A 集合。</p><p>做了 Uncoarseing 後，相當於得到一個更好的 Initial Solution，再做一次 Partitioning，收斂的速度會很快，結果也會比較好</p><p>也會做很多次 Uncoarsening，變回最原始的 Graph</p></li></ol><p><img src="/notes/./images/vlsi-physical-design-automation/MultiLevelPartitioning.png" alt="Multi-Level Partitioning"></p><h4 id="Coarsening-Algorithm"><a href="#Coarsening-Algorithm" class="headerlink" title="Coarsening Algorithm"></a>Coarsening Algorithm</h4><ul><li>Edge coarsening<br>兩兩合併</li><li>Hyperedge coarsening<br>會選一組 hyperedges set，把每個 hyperedge 連接到的 Vertices 都合併成一個 Cluster</li><li>Modified hyperedge coarsening<br>先做 Hyperedge coarsening 後，再把剩下落單的 Vertex 合併成一個 Cluster</li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/CoarseningAlgorithm.png" alt="Coarsening Algorithm"></p><h1 id="Assignment"><a href="#Assignment" class="headerlink" title="Assignment"></a>Assignment</h1><h2 id="HW1"><a href="#HW1" class="headerlink" title="HW1"></a>HW1</h2><h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><ul><li><p>Synopsys Design Constraints (.sdc) file<br>是一種用來描述 Timing Constraints 的檔案，可以用來告訴 Synthesis Tool 或 Place &amp; Route Tool 一些 Timing 的限制，例如：Clock Period、Setup Time、Hold Time、Clock Latency 等等</p></li><li><p>Library Exchange Format (.lef) file</p><p>用在 PnR，描述 Standard Cell、Macro Cell 的 Physical Layout Information，包含 Standard Cell 的物理邊界、Macro 的位置與大小、金屬層的 Routing 規則、VDD&#x2F;VSS 的連線資訊、Via 的位置等等</p><p>Import LEF 讓工具知道 Standard Cell 和 Macro 的物理尺寸，以及哪些 Metal Layer 可以用來做 Routing</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs lef">UNITS<br>DATABASE MICRONS 1000 ; // 1 LEF unit = 1 nm<br>END UNITS<br><br>// Metal Layer<br>LAYER M1<br>  TYPE ROUTING ;<br>  DIRECTION HORIZONTAL ;<br>  PITCH 0.14 ;<br>  WIDTH 0.07 ;<br>END M1<br><br>// Standard Cell<br>MACRO INVX1<br>  CLASS CORE ;<br>  SIZE 0.5 BY 1.2 ;<br>  PIN A<br>    DIRECTION INPUT ;<br>    USE SIGNAL ;<br>    PORT<br>      LAYER M1 ;<br>      RECT (0.1 0.2) (0.2 0.3) ;<br>    END<br>  END A<br>END INVX1<br></code></pre></td></tr></table></figure></li><li><p>MMMC (Multi-Mode Multi-Constraint) file<br>為了確保晶片能夠在所有情境下正常運行，像是：高電壓、低電壓、高溫、低溫甚至 Process Variation 等等，這些變因會影響 Timing 和 Power，因此要可以用 MMMC 來描述這些情境，考慮所有的組合，讓晶片在所有情境下都能正常運作</p></li><li><p>None-Negative Slack<br>Slack 是指某個 Timing Path 的 Delay 跟 Constraint 之間的差值，None-Negative Slack 代表這個 Path 是符合 Timing Constraint 的</p></li><li><p><code>innovus setDesignMode -process 7 -node N7</code><br>設定 Design Mode 為 7nm 的製程，並且設定製成技術為 N7</p></li><li><p><code>setDesignMode -bottomRoutingLayer 2</code><br>設定最底層的 Routing Layer 為 Metal 2，讓 PnR 工具知道 Global Routing 的從這一層開始</p></li></ul><h3 id="Pre-power-planning-and-Floorplan"><a href="#Pre-power-planning-and-Floorplan" class="headerlink" title="Pre-power planning and Floorplan"></a>Pre-power planning and Floorplan</h3><p>確保所有 Standard Cells、Macro、Clock Tree 與電源網絡 Power Network 都能正確擺放，為之後 PnR 做準備。Pre-Power Planning 設定 Global Net，確保所有元件都能正確連接到 VDD 和 VSS</p><ul><li><p>Core Size by Aspect Ratio (H&#x2F;W &#x3D; 1.0)<br>指定 Floorplan 的 Core Size，這裡是正方形</p></li><li><p>Core Utilization<br>指定 Core 的使用率，<code>0.4</code> 代表 Standard Cell 的面積佔整個 Core 的 40%，剩下的 60% 留給 Routing，太高會影響 Routing 或 Timing</p></li><li><p>Core to Die Boundary<br>Core 與 Die 的邊界之間的間距，通常會留一些空間給 I&#x2F;O Pads、Power Pads、Bumps</p></li><li><p>Tool Command Language (.tcl) file<br>類似於 Shell Script，可以用來執行一連串的指令，例如：Synthesis、Place &amp; Route、Simulation 等等</p></li><li><p>Well Tap Cell<br>避免 Latch-up，連接 P-Well 到 GND (NMOS)，N-Well 到 VDD (PMOS)</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tcl">addWellTap -cell TAPCELL_ASAP7_75t_L -cellInterval <span class="hljs-number">12.960</span> -inRowOffset <span class="hljs-number">1.296</span><br></code></pre></td></tr></table></figure><ul><li>在 Core 區域內，每隔 12.960 µm 插入 Well Tap Cell，並偏移 1.296 µm 來對齊。</li></ul></li></ul><h3 id="Power-Planning"><a href="#Power-Planning" class="headerlink" title="Power Planning"></a>Power Planning</h3><ul><li><p>Power Ring<br>在 Core 周圍建立一個封閉的電源環，讓所有元件都能夠穩定的接上 VDD 和 VSS</p><p><img src="/notes/./images/vlsi-physical-design-automation/PowerRing.png" alt="Power Ring"></p></li><li><p>Power Stripes<br>在 Core 內部建立一個電源線，連到 Power Ring，形成完整的 Power Network</p><p><img src="/notes/./images/vlsi-physical-design-automation/PowerStripes.png" alt="Power Stripes"></p></li></ul><h3 id="Placement-place-opt-design"><a href="#Placement-place-opt-design" class="headerlink" title="Placement (place_opt_design)"></a>Placement (place_opt_design)</h3><ul><li><p>Placement<br>把所有 Standard Cells、Macro Cells 放到 Floorplan 的 Core 內</p></li><li><p>Placement Optimization<br>透過 Placement Optimization 來最佳化 Placement，達到 Power Optimization 或 Timing Optimization</p></li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/Placement.png" alt="Placement"></p><h3 id="Clock-Tree-Synthesis"><a href="#Clock-Tree-Synthesis" class="headerlink" title="Clock Tree Synthesis"></a>Clock Tree Synthesis</h3><p>CLK 控制晶片裡所有 Flip-Flop 的 Timing，要確保所有 Flip-Flop 都能在同一個 Clock Cycle 內正確的被觸發</p><p><img src="/notes/./images/vlsi-physical-design-automation/ClockTreeSynthesis.png" alt="Clock Tree Synthesis"></p><p>圖中的紅色、綠色、黃色線就是 CLK 訊號</p><h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><ul><li><code>routeDesign</code><br>將所有標準單元、Macro 之間的連線轉換為實際金屬導線，並確保符合 Timing 和 DRC 規則，自動插入 Via 連接不同金屬層</li></ul><p><img src="/notes/./images/vlsi-physical-design-automation/Routing.png" alt="Routing"></p>]]></content>
    
    
    <categories>
      
      <category>VLSI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>vlsi</tag>
      
      <tag>physical design</tag>
      
      <tag>automation</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker 筆記</title>
    <link href="/notes/2025/02/11/docker/"/>
    <url>/notes/2025/02/11/docker/</url>
    
    <content type="html"><![CDATA[<p><a href="https://raw.githubusercontent.com/collabnix/dockerlabs/master/beginners/images/comp_client_server.jpg">Docker 架構</a></p><ul><li><p>Docker Daemon<br>Docker Daemon 負責管理和執行容器的所有操作。</p></li><li><p>Docker Compose<br>定義和管理多個 Docker 容器。讓你能夠用一個 YAML config file 來定義所有容器，然後一個命令就能啟動他們，像是你同時要有前端、後端、資料庫的時候</p></li><li><p>步驟</p><ol><li>建立 <code>Dockerfile</code></li><li>用這個 <code>Dockerfile</code> 來建立 <code>Image</code></li><li>用這個 <code>Image</code> 來建立和運行 <code>Container</code></li></ol></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>React 筆記</title>
    <link href="/notes/2025/02/05/react-note/"/>
    <url>/notes/2025/02/05/react-note/</url>
    
    <content type="html"><![CDATA[<blockquote><p>記錄一下常用到的 Components</p></blockquote><h1 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h1><h2 id="shadcn"><a href="#shadcn" class="headerlink" title="shadcn"></a>shadcn</h2><p>相見恨晚阿.. 太強了<br><a href="https://ui.shadcn.com/docs">官方文件</a></p><h2 id="TanStack"><a href="#TanStack" class="headerlink" title="TanStack"></a>TanStack</h2><p>官方有個非常詳盡的<a href="https://tanstack.com/table/latest">文件</a>，這裡只有寫大概怎麼用。</p><p>文件寫到 <code>TanStack Table is a modular library. Not all code for every single feature is included in the createTable functions/hooks by default.</code>，所以很多功能要在建立 table 的時候自己 import。</p><ul><li><p>安裝</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install @tanstack/react-table<br></code></pre></td></tr></table></figure></li></ul><h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header Group 包含所有 header row</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;thead&gt;<br>  &#123;table.<span class="hljs-title function_">getHeaderGroups</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">headerGroup</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;headerGroup.id&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;headerGroup.headers.map(</span><br><span class="language-xml">          (</span><br><span class="language-xml">            header // map over the headerGroup headers array</span><br><span class="language-xml">          ) =&gt; (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;header.id&#125;</span> <span class="hljs-attr">colSpan</span>=<span class="hljs-string">&#123;header.colSpan&#125;</span>&gt;</span></span><br><span class="language-xml">              &#123;/* */&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span></span><br><span class="language-xml">          )</span><br><span class="language-xml">        )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br>    );<br>  &#125;)&#125;<br>&lt;/thead&gt;<br></code></pre></td></tr></table></figure><h3 id="Column"><a href="#Column" class="headerlink" title="Column"></a>Column</h3><h4 id="可以從-cell-、-header-和-table-取得"><a href="#可以從-cell-、-header-和-table-取得" class="headerlink" title="可以從 cell 、 header 和 table 取得"></a>可以從 <code>cell</code> 、 <code>header</code> 和 <code>table</code> 取得</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> column = cell.<span class="hljs-property">column</span>; <span class="hljs-comment">// get column from cell</span><br><span class="hljs-keyword">const</span> column = header.<span class="hljs-property">column</span>; <span class="hljs-comment">// get column from header</span><br><span class="hljs-keyword">const</span> column = table.<span class="hljs-title function_">getColumn</span>(<span class="hljs-string">&quot;firstName&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h3><p>全部可以用的 row model</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> table = <span class="hljs-title function_">useReactTable</span>(&#123;<br>  columns,<br>  data,<br>  <span class="hljs-attr">getCoreRowModel</span>: <span class="hljs-title function_">getCoreRowModel</span>(),<br>  <span class="hljs-attr">getExpandedRowModel</span>: <span class="hljs-title function_">getExpandedRowModel</span>(),<br>  <span class="hljs-attr">getFacetedMinMaxValues</span>: <span class="hljs-title function_">getFacetedMinMaxValues</span>(),<br>  <span class="hljs-attr">getFacetedRowModel</span>: <span class="hljs-title function_">getFacetedRowModel</span>(),<br>  <span class="hljs-attr">getFacetedUniqueValues</span>: <span class="hljs-title function_">getFacetedUniqueValues</span>(),<br>  <span class="hljs-attr">getFilteredRowModel</span>: <span class="hljs-title function_">getFilteredRowModel</span>(),<br>  <span class="hljs-attr">getGroupedRowModel</span>: <span class="hljs-title function_">getGroupedRowModel</span>(),<br>  <span class="hljs-attr">getPaginationRowModel</span>: <span class="hljs-title function_">getPaginationRowModel</span>(),<br>  <span class="hljs-attr">getSortedRowModel</span>: <span class="hljs-title function_">getSortedRowModel</span>(),<br>&#125;);<br></code></pre></td></tr></table></figure><h4 id="table-getRow"><a href="#table-getRow" class="headerlink" title="table.getRow()"></a><code>table.getRow()</code></h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> row = table.<span class="hljs-title function_">getRow</span>(rowId);<br></code></pre></td></tr></table></figure><h4 id="table-getRowModel"><a href="#table-getRowModel" class="headerlink" title="table.getRowModel()"></a><code>table.getRowModel()</code></h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;tbody&gt;<br>  &#123;table.<span class="hljs-title function_">getRowModel</span>().<span class="hljs-property">rows</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">row</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;row.id&#125;</span>&gt;</span>&#123;/* ... */&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br>  ))&#125;<br>&lt;/tbody&gt;<br></code></pre></td></tr></table></figure><h4 id="table-getSelectedRowModel"><a href="#table-getSelectedRowModel" class="headerlink" title="table.getSelectedRowModel()"></a><code>table.getSelectedRowModel()</code></h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> selectedRows = table.<span class="hljs-title function_">getSelectedRowModel</span>().<span class="hljs-property">rows</span>;<br></code></pre></td></tr></table></figure><h4 id="row-getValue-、row-renderValue"><a href="#row-getValue-、row-renderValue" class="headerlink" title="row.getValue()、row.renderValue()"></a><code>row.getValue()</code>、<code>row.renderValue()</code></h4><p>兩個只差在檢查 value 是否為 <code>undefined</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> firstName = row.<span class="hljs-title function_">getValue</span>(<span class="hljs-string">&quot;firstName&quot;</span>); <span class="hljs-comment">// read the row value from the firstName column</span><br><span class="hljs-keyword">const</span> renderedLastName = row.<span class="hljs-title function_">renderValue</span>(<span class="hljs-string">&quot;lastName&quot;</span>); <span class="hljs-comment">// render the value from the lastName column</span><br></code></pre></td></tr></table></figure><h4 id="row-original"><a href="#row-original" class="headerlink" title="row.original"></a><code>row.original</code></h4><p>跟 <code>row.getValue()</code> 類似，但是回傳 <code>accessorFn</code> <strong>處理前</strong> 的值，是最原始的資料</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> firstName = row.<span class="hljs-property">original</span>.<span class="hljs-property">firstName</span>;<br></code></pre></td></tr></table></figure><h3 id="Cell"><a href="#Cell" class="headerlink" title="Cell"></a>Cell</h3><p>每個 Cell 的 id 是由 parent row 和 parent col 決定的：<code>&#123; id: </code>${row.id}_${column.id}<code> &#125;</code></p><h4 id="cell-getValue-、cell-renderValue"><a href="#cell-getValue-、cell-renderValue" class="headerlink" title="cell.getValue()、cell.renderValue()"></a><code>cell.getValue()</code>、<code>cell.renderValue()</code></h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> firstName = cell.<span class="hljs-title function_">getValue</span>(); <span class="hljs-comment">// read the cell value</span><br><span class="hljs-keyword">const</span> renderedLastName = cell.<span class="hljs-title function_">renderValue</span>(); <span class="hljs-comment">// render the value</span><br></code></pre></td></tr></table></figure><h4 id="取得-parent-row"><a href="#取得-parent-row" class="headerlink" title="取得 parent row"></a>取得 parent row</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> firstName = cell.<span class="hljs-property">row</span>.<span class="hljs-property">original</span>.<span class="hljs-property">firstName</span>;<br></code></pre></td></tr></table></figure><h4 id="flexRender"><a href="#flexRender" class="headerlink" title="flexRender()"></a>flexRender()</h4><p>如果 <code>column.cell</code> 是 <strong>函數回傳 JSX</strong> 而不是純數據，就一定要用 <code>flexRender</code> 渲染，不能用 <code>getValue()</code></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; flexRender &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@tanstack/react-table&#x27;</span><br><br><span class="hljs-keyword">const</span> columns = [<br>  &#123;<br>    <span class="hljs-attr">accessorKey</span>: <span class="hljs-string">&#x27;fullName&#x27;</span>,<br>    <span class="hljs-attr">cell</span>: <span class="hljs-function">(<span class="hljs-params">&#123; cell, row &#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>&#123;row.original.firstName&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span> &#123;row.original.lastName&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    &#125;<br>    <span class="hljs-comment">//...</span><br>  &#125;<br>]<br><span class="hljs-comment">//...</span><br>&lt;tr&gt;<br>  &#123;row.<span class="hljs-title function_">getVisibleCells</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">cell</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;cell.id&#125;</span>&gt;</span>&#123;flexRender(cell.column.columnDef.cell, cell.getContext())&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br>  &#125;)&#125;<br>&lt;/tr&gt;<br></code></pre></td></tr></table></figure><h5 id="getVisibleCells"><a href="#getVisibleCells" class="headerlink" title="getVisibleCells()"></a><code>getVisibleCells()</code></h5><p>只回傳當前可見的 Cells，避免 render 不需要的內容</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&#123;<br>  table.<span class="hljs-title function_">getRowModel</span>().<span class="hljs-property">rows</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">row</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;row.id&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;row.getVisibleCells().map((cell) =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;cell.id&#125;</span>&gt;</span>&#123;cell.renderValue()&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br>  ));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="React-Hook-Form"><a href="#React-Hook-Form" class="headerlink" title="React Hook Form"></a>React Hook Form</h2><p>透過 <code>useForm hook</code> 管理表單</p><ul><li><p>安裝</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install react-hook-form<br></code></pre></td></tr></table></figure></li><li><p><code>shadui</code> + <code>react hook form</code> + <code>zod</code> 驗證範例</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; useForm &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-hook-form&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; zodResolver &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@hookform/resolvers/zod&quot;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> z <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;zod&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/button&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Form</span>, <span class="hljs-title class_">FormField</span>, <span class="hljs-title class_">FormItem</span>, <span class="hljs-title class_">FormLabel</span>, <span class="hljs-title class_">FormControl</span>, <span class="hljs-title class_">FormMessage</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/form&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Input</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/input&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Checkbox</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/checkbox&quot;</span>;<br><br><span class="hljs-keyword">const</span> formSchema = z.<span class="hljs-title function_">object</span>(&#123;<br>  <span class="hljs-attr">name</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;名稱至少需要 2 個字&quot;</span>),<br>  <span class="hljs-attr">email</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">email</span>(<span class="hljs-string">&quot;請輸入有效的 Email&quot;</span>),<br>  <span class="hljs-attr">agreeTerms</span>: z.<span class="hljs-title function_">boolean</span>().<span class="hljs-title function_">refine</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> val === <span class="hljs-literal">true</span>, &#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;您必須同意條款與條件&quot;</span><br>  &#125;)<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">useForm</span>(&#123;<br>    <span class="hljs-attr">resolver</span>: <span class="hljs-title function_">zodResolver</span>(formSchema),<br>    <span class="hljs-attr">defaultValues</span>: &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-attr">email</span>: <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-attr">agreeTerms</span>: <span class="hljs-literal">false</span><br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onSubmit</span> = (<span class="hljs-params">data</span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Submitted data:&quot;</span>, data);<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span> &#123;<span class="hljs-attr">...form</span>&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;form.handleSubmit(onSubmit)&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4 p-4 border rounded-lg w-full max-w-md&quot;</span>&gt;</span></span><br><span class="language-xml">        &#123;/* Name Field */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">FormField</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">control</span>=<span class="hljs-string">&#123;form.control&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">field</span> &#125;) =&gt;</span> (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormLabel</span>&gt;</span>名稱<span class="hljs-tag">&lt;/<span class="hljs-name">FormLabel</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;輸入您的名稱&quot;</span> &#123;<span class="hljs-attr">...field</span>&#125; /&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormMessage</span> /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">          )&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml"></span><br><span class="language-xml">        &#123;/* Email Field */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">FormField</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">control</span>=<span class="hljs-string">&#123;form.control&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;email&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">field</span> &#125;) =&gt;</span> (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormLabel</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">FormLabel</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;輸入您的 Email&quot;</span> &#123;<span class="hljs-attr">...field</span>&#125; /&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormMessage</span> /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">          )&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml"></span><br><span class="language-xml">        &#123;/* Agree Terms Checkbox */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">FormField</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">control</span>=<span class="hljs-string">&#123;form.control&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;agreeTerms&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">field</span> &#125;) =&gt;</span> (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center space-x-2&quot;</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span> <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;field.value&#125;</span> <span class="hljs-attr">onCheckedChange</span>=<span class="hljs-string">&#123;field.onChange&#125;</span> /&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormLabel</span>&gt;</span>我同意條款與條件<span class="hljs-tag">&lt;/<span class="hljs-name">FormLabel</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormMessage</span> /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">          )&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml"></span><br><span class="language-xml">        &#123;/* Submit Button */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full&quot;</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span></span><br>  );<br>&#125;<br><span class="hljs-keyword">import</span> &#123; useForm &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-hook-form&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; zodResolver &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@hookform/resolvers/zod&quot;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> z <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;zod&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Button</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/button&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Form</span>, <span class="hljs-title class_">FormField</span>, <span class="hljs-title class_">FormItem</span>, <span class="hljs-title class_">FormLabel</span>, <span class="hljs-title class_">FormControl</span>, <span class="hljs-title class_">FormMessage</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/form&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Input</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/input&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Checkbox</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/components/ui/checkbox&quot;</span>;<br><br><span class="hljs-keyword">const</span> formSchema = z.<span class="hljs-title function_">object</span>(&#123;<br>  <span class="hljs-attr">name</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;名稱至少需要 2 個字&quot;</span>),<br>  <span class="hljs-attr">email</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">email</span>(<span class="hljs-string">&quot;請輸入有效的 Email&quot;</span>),<br>  <span class="hljs-attr">agreeTerms</span>: z.<span class="hljs-title function_">boolean</span>().<span class="hljs-title function_">refine</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> val === <span class="hljs-literal">true</span>, &#123;<br>    <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;您必須同意條款與條件&quot;</span><br>  &#125;)<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">useForm</span>(&#123;<br>    <span class="hljs-attr">resolver</span>: <span class="hljs-title function_">zodResolver</span>(formSchema),<br>    <span class="hljs-attr">defaultValues</span>: &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-attr">email</span>: <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-attr">agreeTerms</span>: <span class="hljs-literal">false</span><br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onSubmit</span> = (<span class="hljs-params">data</span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Submitted data:&quot;</span>, data);<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span> &#123;<span class="hljs-attr">...form</span>&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;form.handleSubmit(onSubmit)&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4 p-4 border rounded-lg w-full max-w-md&quot;</span>&gt;</span></span><br><span class="language-xml">        &#123;/* Name Field */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">FormField</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">control</span>=<span class="hljs-string">&#123;form.control&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">field</span> &#125;) =&gt;</span> (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormLabel</span>&gt;</span>名稱<span class="hljs-tag">&lt;/<span class="hljs-name">FormLabel</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;輸入您的名稱&quot;</span> &#123;<span class="hljs-attr">...field</span>&#125; /&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormMessage</span> /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">          )&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml"></span><br><span class="language-xml">        &#123;/* Email Field */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">FormField</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">control</span>=<span class="hljs-string">&#123;form.control&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;email&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">field</span> &#125;) =&gt;</span> (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormLabel</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">FormLabel</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;輸入您的 Email&quot;</span> &#123;<span class="hljs-attr">...field</span>&#125; /&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormMessage</span> /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">          )&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml"></span><br><span class="language-xml">        &#123;/* Agree Terms Checkbox */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">FormField</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">control</span>=<span class="hljs-string">&#123;form.control&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;agreeTerms&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">field</span> &#125;) =&gt;</span> (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center space-x-2&quot;</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span> <span class="hljs-attr">checked</span>=<span class="hljs-string">&#123;field.value&#125;</span> <span class="hljs-attr">onCheckedChange</span>=<span class="hljs-string">&#123;field.onChange&#125;</span> /&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">FormControl</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormLabel</span>&gt;</span>我同意條款與條件<span class="hljs-tag">&lt;/<span class="hljs-name">FormLabel</span>&gt;</span></span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">FormMessage</span> /&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span></span><br><span class="language-xml">          )&#125;</span><br><span class="language-xml">        /&gt;</span><br><span class="language-xml"></span><br><span class="language-xml">        &#123;/* Submit Button */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;w-full&quot;</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="Swiper"><a href="#Swiper" class="headerlink" title="Swiper"></a>Swiper</h2><ul><li><p>安裝</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install swiper<br></code></pre></td></tr></table></figure></li><li><p>import</p><ul><li><p>一定要的</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Swiper</span>, <span class="hljs-title class_">SwiperSlide</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;swiper/react&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;swiper/css&quot;</span>;<br></code></pre></td></tr></table></figure></li><li><p>其他一些可用的 modules</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">EffectCoverflow</span>, <span class="hljs-title class_">Pagination</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;swiper/modules&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;swiper/css/pagination&quot;</span>;<br></code></pre></td></tr></table></figure></li></ul></li><li><p>用法範例</p><ul><li>Swiper<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Swiper</span><br>  onSlideChange=&#123;<span class="hljs-function">(<span class="hljs-params">swiper</span>) =&gt;</span> <span class="hljs-title function_">setcurrentAppIntroIndex</span>(swiper.<span class="hljs-property">activeIndex</span>)&#125;<br>  initialSlide=&#123;<span class="hljs-number">2</span>&#125;<br>  slidesPerView=&#123;<span class="hljs-string">&quot;auto&quot;</span>&#125;<br>  coverflowEffect=&#123;&#123;<br>    <span class="hljs-attr">rotate</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">stretch</span>: <span class="hljs-number">80</span>,<br>    <span class="hljs-attr">depth</span>: <span class="hljs-number">300</span>,<br>    <span class="hljs-attr">modifier</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">slideShadows</span>: <span class="hljs-literal">true</span>,<br>  &#125;&#125;<br>  effect=&#123;<span class="hljs-string">&quot;coverflow&quot;</span>&#125;<br>  grabCursor=&#123;<span class="hljs-literal">true</span>&#125;<br>  centeredSlides=&#123;<span class="hljs-literal">true</span>&#125;<br>  onSwiper=&#123;<span class="hljs-function">(<span class="hljs-params">swiper</span>) =&gt;</span> (appSwiperRef.<span class="hljs-property">current</span> = swiper)&#125;<br>  pagination=&#123;&#123; <span class="hljs-attr">el</span>: <span class="hljs-string">&quot;.app-pagination&quot;</span>, <span class="hljs-attr">clickable</span>: <span class="hljs-literal">true</span> &#125;&#125;<br>  modules=&#123;[<span class="hljs-title class_">EffectCoverflow</span>, <span class="hljs-title class_">Pagination</span>]&#125;<br>&gt;<br>  &#123;appFeatures.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SwiperSlide</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;index&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;item.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">SwiperSlide</span>&gt;</span></span><br>  ))&#125;<br>&lt;/<span class="hljs-title class_">Swiper</span>&gt;<br></code></pre></td></tr></table></figure></li><li>Pagination<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;div<br>  className=<span class="hljs-string">&quot;app-pagination mt-2 flex justify-center space-x-4&quot;</span><br>  style=&#123;&#123;<br>    <span class="hljs-string">&quot;--swiper-pagination-color&quot;</span>: <span class="hljs-string">&quot;#000000&quot;</span>,<br>    <span class="hljs-string">&quot;--swiper-pagination-bullet-inactive-color&quot;</span>: <span class="hljs-string">&quot;#999999&quot;</span>,<br>    <span class="hljs-string">&quot;--swiper-pagination-bullet-inactive-opacity&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-string">&quot;--swiper-pagination-bullet-size&quot;</span>: <span class="hljs-string">&quot;8px&quot;</span>,<br>  &#125;&#125;<br>/&gt;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h2 id="Collapse"><a href="#Collapse" class="headerlink" title="Collapse"></a>Collapse</h2><ul><li><p>安裝</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install --save react-collapse<br></code></pre></td></tr></table></figure></li><li><p>import</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Collapse</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-collapse&quot;</span>;<br></code></pre></td></tr></table></figure><p>另外，<code>index.html</code> 要加入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://unpkg.com/react/umd/react.production.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://unpkg.com/react-collapse/build/react-collapse.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>用法範例<br>用 <code>isOpened</code> 控制 Toggle 就好，內容隨意</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">Collapse</span> isOpened=&#123;isExpanded[index]&#125;&gt;<br>  &#123;question.<span class="hljs-property">description</span> &amp;&amp;<br>    question.<span class="hljs-property">description</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">desc, index</span>) =&gt;</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;index&#125;</span>&gt;</span>&#123;desc.description&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        &#123;desc.details &amp;&amp; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;ml-10 list-disc&quot;</span>&gt;</span></span><br><span class="language-xml">            &#123;desc.details.map((detail, index) =&gt; (</span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;index&#125;</span>&gt;</span></span><br><span class="language-xml">                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-bold&quot;</span>&gt;</span>&#123;detail.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">                &#123;detail.description&#125;</span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">            ))&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    ))&#125;<br>&lt;/<span class="hljs-title class_">Collapse</span>&gt;<br></code></pre></td></tr></table></figure><ul><li>Collapse 動畫的時間</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.ReactCollapse--collapse</span> &#123;<br>  <span class="hljs-attribute">transition</span>: height <span class="hljs-number">500ms</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><ul><li><p>安裝</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm i --save react-select<br></code></pre></td></tr></table></figure></li><li><p>import</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Select</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-select&quot;</span>;<br></code></pre></td></tr></table></figure></li><li><p>範例</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> options = [<br>  &#123; <span class="hljs-attr">value</span>: <span class="hljs-string">&quot;chocolate&quot;</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Chocolate&quot;</span> &#125;,<br>  &#123; <span class="hljs-attr">value</span>: <span class="hljs-string">&quot;strawberry&quot;</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Strawberry&quot;</span> &#125;,<br>  &#123; <span class="hljs-attr">value</span>: <span class="hljs-string">&quot;vanilla&quot;</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Vanilla&quot;</span> &#125;,<br>];<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"></span>) =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span> <span class="hljs-attr">options</span>=<span class="hljs-string">&#123;options&#125;</span> /&gt;</span></span>;<br></code></pre></td></tr></table></figure></li><li><p><a href="https://react-select.com/home#getting-started">更多用法</a></p></li></ul><h2 id="Spinner"><a href="#Spinner" class="headerlink" title="Spinner"></a>Spinner</h2><ul><li><p>安裝</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install --save react-spinners<br></code></pre></td></tr></table></figure></li><li><p>import</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ClipLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-spinners/ClipLoader&quot;</span>;<br></code></pre></td></tr></table></figure></li><li><p>範例</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;<span class="hljs-title class_">ClipLoader</span><br>  color=<span class="hljs-string">&quot;#ffffff&quot;</span><br>  loading=&#123;loading&#125; <span class="hljs-comment">// bool 值</span><br>  size=&#123;<span class="hljs-number">150</span>&#125;<br>  aria-label=<span class="hljs-string">&quot;Loading Spinner&quot;</span><br>  data-testid=<span class="hljs-string">&quot;loader&quot;</span><br>/&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">BeatLoader</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">color</span>=<span class="hljs-string">&quot;#000000&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">loading</span>=<span class="hljs-string">&#123;true&#125;</span> // <span class="hljs-attr">bool</span> <span class="hljs-attr">值</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">size</span>=<span class="hljs-string">&#123;10&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;Loading Spinner&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">data-testid</span>=<span class="hljs-string">&quot;loader&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">/&gt;</span></span><br></code></pre></td></tr></table></figure></li><li><p><a href="https://www.npmjs.com/package/react-spinners">更多用法</a></p></li></ul><h1 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h1><h2 id="flexwrap"><a href="#flexwrap" class="headerlink" title="flexwrap"></a>flexwrap</h2><p>用 <code>flex</code> 的時候，會與下一行有一些奇怪的間隔，是因為他會啟動 <code>aligin-content: strench</code>，要改成 <code>align-content: flex-start</code>，或 Tailwind 的 <code>content-start</code></p><ul><li><a href="https://stackoverflow.com/questions/40890613/remove-space-gaps-between-multiple-lines-of-flex-items-when-they-wrap">更多資訊</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>web</tag>
      
      <tag>frontend</tag>
      
      <tag>react</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Webpack 換成 Vite</title>
    <link href="/notes/2025/02/05/vite/"/>
    <url>/notes/2025/02/05/vite/</url>
    
    <content type="html"><![CDATA[<blockquote><p>原本的專案都是用 webpack 打包，現在想換成 vite 看看</p></blockquote><h3 id="安裝-Vite-和相關的-Plugins"><a href="#安裝-Vite-和相關的-Plugins" class="headerlink" title="安裝 Vite 和相關的 Plugins"></a>安裝 Vite 和相關的 Plugins</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm install vite @vitejs/plugin-react --save-dev<br></code></pre></td></tr></table></figure><h3 id="Restructure-Project"><a href="#Restructure-Project" class="headerlink" title="Restructure Project"></a>Restructure Project</h3><p>原本我是只有 <code>src</code> 和 <code>dist</code> 資料夾，但是 Vite 會需要 <code>src</code>、<code>dist</code> 和 <code>public</code>。所有靜態資源包含圖片、<code>404.html</code>和 <code>CNAME</code> 等都要放在 <code>public</code>，在跑 vite build 的時候它會去讀取 <code>public</code> 資料夾裡面的資源，最後一並放入 <code>dist</code>。</p><h3 id="新增-vite-config-js"><a href="#新增-vite-config-js" class="headerlink" title="新增 vite.config.js"></a>新增 vite.config.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vite&quot;</span>;<br><span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@vitejs/plugin-react&quot;</span>;<br><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;path&quot;</span>;<br><br><span class="hljs-comment">// Detect environment mode</span><br><span class="hljs-keyword">const</span> isDev = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&quot;development&quot;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;isDev: &quot;</span>, isDev);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],<br>  <span class="hljs-attr">root</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;src&quot;</span>),<br>  <span class="hljs-attr">publicDir</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;public&quot;</span>),<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">alias</span>: &#123;<br>      <span class="hljs-title class_">States</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;src/States&quot;</span>),<br>      <span class="hljs-title class_">Utilities</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;src/Utilities&quot;</span>),<br>      <span class="hljs-title class_">Components</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;src/Components&quot;</span>),<br>    &#125;,<br>  &#125;,<br>  <span class="hljs-attr">server</span>: &#123;<br>    <span class="hljs-attr">port</span>: <span class="hljs-number">7070</span>,<br>    <span class="hljs-attr">strictPort</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Open browser automatically</span><br>  &#125;,<br>  <span class="hljs-attr">build</span>: &#123;<br>    <span class="hljs-attr">outDir</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;dist&quot;</span>),<br>    <span class="hljs-attr">emptyOutDir</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">sourcemap</span>: isDev ? <span class="hljs-string">&quot;inline-source-map&quot;</span> : <span class="hljs-literal">false</span>,<br>  &#125;,<br>  <span class="hljs-attr">define</span>: &#123;<br>    <span class="hljs-string">&quot;process.env.NODE_ENV&quot;</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>),<br>  &#125;,<br>  <span class="hljs-attr">base</span>: isDev ? <span class="hljs-string">&quot;/&quot;</span> : <span class="hljs-string">&quot;https://bms.carbon-walker.com/&quot;</span>,<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h3><p>這部分要改成</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;build&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vite build --emptyOutDir&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;predeploy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;npm run build&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;deploy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;gh-pages -d dist&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;format&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;prettier --write .&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure><h3 id="刪掉-Webpack-Specific-的-Packages"><a href="#刪掉-Webpack-Specific-的-Packages" class="headerlink" title="刪掉 Webpack-Specific 的 Packages"></a>刪掉 Webpack-Specific 的 Packages</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">npm remove webpack webpack-cli webpack-dev-server html-webpack-plugin babel-loader style-loader css-loader postcss-loader<br></code></pre></td></tr></table></figure><p>雖然 Vite 速度感覺快很多，但是花了一堆時間在 debug，遇到一堆怪怪的問題，之後再看有沒有更酷的功能<br><img src="https://media2.dev.to/dynamic/image/width=1000,height=500,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Farticles%2Fd4u62vy3h2bptsynmuu6.png" alt="金句"></p>]]></content>
    
    
    
    <tags>
      
      <tag>frontend</tag>
      
      <tag>website</tag>
      
      <tag>vite</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Frontend Information Security</title>
    <link href="/notes/2025/02/04/information-security/"/>
    <url>/notes/2025/02/04/information-security/</url>
    
    <content type="html"><![CDATA[<ul><li><p><code>npm init -y</code></p><ul><li><code>-y</code> 代表接下來詢問的 <code>package name</code>、<code>version</code>、<code>description</code>…之類的東西一律回答 yes，快速建立 <code>package.json</code><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;infosec&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;main&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index.js&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;keywords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;license&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ISC&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p><code>FQDN (Fully Qualified Domain Name)</code> 是指 <code>hostname</code> + <code>domain name</code></p><ul><li>比方說 <code>bms.carbon-walker.com</code> 是 <code>FQDN</code>，其 <code>hostname</code> 是 bms，<code>domain name</code> 是 <code>carbon-walker.com</code></li></ul></li><li><p>HTTP methods</p><table><thead><tr><th align="center">Method</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">GET</td><td align="center">取得資源</td></tr><tr><td align="center">HEAD</td><td align="center">取得 HTTP header，不包含 body</td></tr><tr><td align="center">POST</td><td align="center">註冊資料、建立資源</td></tr><tr><td align="center">PUT</td><td align="center">更新資源，若該資源不存在就新建資源</td></tr><tr><td align="center">DELETE</td><td align="center">刪除資源</td></tr><tr><td align="center">CONNECT</td><td align="center">建立到目標資源的 tunnel，用於 SSL&#x2F;TLS 加密的代理連線</td></tr><tr><td align="center">OPTIONS</td><td align="center">查詢 server 可支援的 HTTP method</td></tr><tr><td align="center">TRACE</td><td align="center">伺服器直接回傳收到的資料，用於偵錯 (好像沒人在用，瀏覽器也不支援</td></tr></tbody></table><ul><li>其中 <code>GET</code>、<code>HEAD</code>、<code>OPTIONS</code>、<code>TRACE</code> 不會影響到伺服器的資源，因此被 <code>RFC 7231</code> 視為安全的 HTTP method</li></ul></li><li><p>Status Code</p><table><thead><tr><th align="center">Method</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center">100 Continue</td><td align="center">通知瀏覽器，伺服器處理尚未完成</td></tr><tr><td align="center">200 OK</td><td align="center">順利完成</td></tr><tr><td align="center">201 Created</td><td align="center">順利完成新建立資源</td></tr><tr><td align="center">301 Moved Permanently</td><td align="center">將指定資料移動到別處</td></tr><tr><td align="center">302 Found</td><td align="center">暫時移動資源位置 (可能臨時要維修之類的)</td></tr><tr><td align="center">400 Bad Request</td><td align="center">請求資訊有誤</td></tr><tr><td align="center">404 Not Found</td><td align="center">找不到啦</td></tr><tr><td align="center">500 Internal Server Error</td><td align="center">伺服器內部有錯誤</td></tr><tr><td align="center">503 Service Unavailable</td><td align="center">通知伺服器當機</td></tr></tbody></table></li><li><p>TLS&#x2F;SSL</p><ul><li>加密傳輸資料<ul><li>公開金鑰加密</li><li>對稱密鑰加密</li><li>綜合</li></ul></li><li>驗證通訊對象<ul><li>數位憑證確認伺服器為本尊，非冒牌</li></ul></li><li>資料完整性<ul><li>避免金鑰和憑證被竄改，所以在開始跟伺服器通訊前要先檢查有沒有被偷改 (shakehand)</li></ul></li></ul></li><li><p>Mixed Content</p><ul><li>passive</li><li>active</li></ul></li><li><p>iframe (inline frame) 內嵌假網站防止方法</p><ol><li>CSP (HTTP Header)<ul><li>禁止任何網站嵌入<ul><li><code>X-Frame-Options: DENY</code> (聽說有點過時</li><li><code>Content-Security-Policy: frame-ancestors &#39;none&#39;;</code></li></ul></li><li>禁止自己以外的網站嵌入<ul><li><code>X-Frame-Options: SAMEORIGIN</code></li><li><code>Content-Security-Policy: frame-ancestors &#39;self&#39;;</code></li></ul></li><li>兩個一起用會比較好，避免一些瀏覽器端的問題</li></ul></li><li>Frame busting (javascript)<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span>) &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span>.<span class="hljs-property">location</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>;<br>&#125;<br></code></pre></td></tr></table></figure>推薦文章: <a href="https://blog.huli.tw/2021/09/26/what-is-clickjacking/">不識廬山真面目：Clickjacking 點擊劫持攻擊</a></li></ol></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>frontend</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>React DOM</title>
    <link href="/notes/2025/02/03/react-dom/"/>
    <url>/notes/2025/02/03/react-dom/</url>
    
    <content type="html"><![CDATA[<blockquote><p>從來沒去搞懂 react 的一些機制</p></blockquote><h2 id="瀏覽器怎麼渲染網頁"><a href="#瀏覽器怎麼渲染網頁" class="headerlink" title="瀏覽器怎麼渲染網頁"></a>瀏覽器怎麼渲染網頁</h2><p>瀏覽器會遵照一些既有的規則，去解析我們的 HTML 和 CSS 檔案，分別做成 DOM 和 CSSOM 等樹狀結構，最後再合併成 Render Tree。</p><p><img src="https://www.lumin.tech/articles/browser-reflow-repaint/reflow_repaint.png" alt="Web Browser Rendering"></p><h4 id="Reflow"><a href="#Reflow" class="headerlink" title="Reflow"></a>Reflow</h4><p>當 DOM 結構、元素的大小、位置或其他與 layout 的屬性改變時，瀏覽器會重新計算所有元素的位置</p><h4 id="Repaint"><a href="#Repaint" class="headerlink" title="Repaint"></a>Repaint</h4><p>當 DOM 變更影響了元素的外觀（顏色、背景、陰影等），瀏覽器只需要重新繪製該元素，成本沒有 Reflow 那麼高</p><h2 id="React-Virtual-DOM"><a href="#React-Virtual-DOM" class="headerlink" title="React Virtual DOM"></a>React Virtual DOM</h2><p>傳統的方法是直接更改 Real DOM，像是如果我有 <code>document.getElementById().innerHTML = &quot;new content&quot;</code>，他會直接去更新 Real DOM，更新完後 Reflow 或 Repaint 可能會再做一遍，成本很高。如果我有數個相似的操作，就會很慢。</p><p>React 會在記憶體中建立一個 JavaScript 物件（Virtual DOM），這個物件是一個與 Real DOM 結構相似的樹。當 State 改變時， React 比較新舊版本的 Virtual DOM 的樹上的每一個節點，然後更新，最後批次更改 Real DOM，減少花費的成本。</p><h3 id="React-的-re-rendering"><a href="#React-的-re-rendering" class="headerlink" title="React 的 re-rendering"></a>React 的 re-rendering</h3><p>上面提到，React 會比較新舊 Virtual DOM 的差異，最後更新到 Real DOM 上面。其中他會檢查 Virtual DOM 更新的部分，稱為 re-render，而非指 repaint。</p><h3 id="React-中可以減少-re-rendering-的方式"><a href="#React-中可以減少-re-rendering-的方式" class="headerlink" title="React 中可以減少 re-rendering 的方式"></a>React 中可以減少 re-rendering 的方式</h3><ul><li>memo</li><li>useCallback</li><li>babel-plugin-react-compiler</li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p><a href="https://www.lumin.tech/articles/browser-reflow-repaint/">浏览器的重绘 (repaint) 和重排 (reflow)</a><br><a href="https://www.youtube.com/watch?v=INLq9RPAYUw">Why is every React site so slow?</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>frontend</tag>
      
      <tag>react</tag>
      
      <tag>DOM</tag>
      
      <tag>website</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>日語筆記</title>
    <link href="/notes/2025/02/03/japanese-1/"/>
    <url>/notes/2025/02/03/japanese-1/</url>
    
    <content type="html"><![CDATA[<h2 id="五十音入門"><a href="#五十音入門" class="headerlink" title="五十音入門"></a>五十音入門</h2><h3 id="平假名（清音）"><a href="#平假名（清音）" class="headerlink" title="平假名（清音）"></a>平假名（清音）</h3><table><thead><tr><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">あ a</td><td align="center">い i</td><td align="center">う u</td><td align="center">え e</td><td align="center">お o</td></tr><tr><td align="center">か ka</td><td align="center">き ki</td><td align="center">く ku</td><td align="center">け ke</td><td align="center">こ ko</td></tr><tr><td align="center">さ sa</td><td align="center">し si</td><td align="center">す su</td><td align="center">せ se</td><td align="center">そ so</td></tr><tr><td align="center">た ta</td><td align="center">ち chi</td><td align="center">つ tsu</td><td align="center">て te</td><td align="center">と to</td></tr><tr><td align="center">な na</td><td align="center">に ni</td><td align="center">ぬ nu</td><td align="center">ね ne</td><td align="center">の no</td></tr><tr><td align="center">は ha</td><td align="center">ひ hi</td><td align="center">ふ hu</td><td align="center">へ he</td><td align="center">ほ ho</td></tr><tr><td align="center">ま ma</td><td align="center">み mi</td><td align="center">む mu</td><td align="center">め me</td><td align="center">も mo</td></tr><tr><td align="center">や ya</td><td align="center"></td><td align="center">ゆ yu</td><td align="center"></td><td align="center">よ yo</td></tr><tr><td align="center">ら ra</td><td align="center">り ri</td><td align="center">る ru</td><td align="center">れ re</td><td align="center">ろ ro</td></tr><tr><td align="center">わ wa</td><td align="center"></td><td align="center">ん n</td><td align="center"></td><td align="center">を o</td></tr></tbody></table><h3 id="平假名（濁音、半濁音）"><a href="#平假名（濁音、半濁音）" class="headerlink" title="平假名（濁音、半濁音）"></a>平假名（濁音、半濁音）</h3><table><thead><tr><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">が ga</td><td align="center">ぎ gi</td><td align="center">ぐ gu</td><td align="center">げ ge</td><td align="center">ご go</td></tr><tr><td align="center">ざ za</td><td align="center">じ zi</td><td align="center">ず zu</td><td align="center">ぜ ze</td><td align="center">ぞ zo</td></tr><tr><td align="center">だ da</td><td align="center">ぢ di</td><td align="center">づ du</td><td align="center">で de</td><td align="center">ど do</td></tr><tr><td align="center">ば ba</td><td align="center">び bi</td><td align="center">ぶ bu</td><td align="center">べ be</td><td align="center">ぼ bo</td></tr><tr><td align="center">ぱ pa</td><td align="center">ぴ pi</td><td align="center">ぷ pu</td><td align="center">ぺ pe</td><td align="center">ぽ po</td></tr></tbody></table><h3 id="片假名（清音）"><a href="#片假名（清音）" class="headerlink" title="片假名（清音）"></a>片假名（清音）</h3><table><thead><tr><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">ア a</td><td align="center">イ i</td><td align="center">ウ u</td><td align="center">エ e</td><td align="center">オ o</td></tr><tr><td align="center">カ ka</td><td align="center">キ ki</td><td align="center">ク ku</td><td align="center">ケ ke</td><td align="center">コ ko</td></tr><tr><td align="center">サ sa</td><td align="center">シ si</td><td align="center">ス su</td><td align="center">セ se</td><td align="center">ソ so</td></tr><tr><td align="center">タ ta</td><td align="center">チ chi</td><td align="center">ツ tsu</td><td align="center">テ te</td><td align="center">ト to</td></tr><tr><td align="center">ナ na</td><td align="center">ニ ni</td><td align="center">ヌ nu</td><td align="center">ネ ne</td><td align="center">ノ no</td></tr><tr><td align="center">ハ ha</td><td align="center">ヒ hi</td><td align="center">フ hu</td><td align="center">ヘ he</td><td align="center">ホ ho</td></tr><tr><td align="center">マ ma</td><td align="center">ミ mi</td><td align="center">ム mu</td><td align="center">メ me</td><td align="center">モ mo</td></tr><tr><td align="center">ヤ ya</td><td align="center"></td><td align="center">ユ yu</td><td align="center"></td><td align="center">ヨ yo</td></tr><tr><td align="center">ラ ra</td><td align="center">リ ri</td><td align="center">ル ru</td><td align="center">レ re</td><td align="center">ロ ro</td></tr><tr><td align="center">ワ wa</td><td align="center"></td><td align="center">ン n</td><td align="center"></td><td align="center">ヲ o</td></tr></tbody></table><h3 id="片假名（濁音、半濁音）"><a href="#片假名（濁音、半濁音）" class="headerlink" title="片假名（濁音、半濁音）"></a>片假名（濁音、半濁音）</h3><table><thead><tr><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center">ガ ga</td><td align="center">ギ gi</td><td align="center">グ gu</td><td align="center">ゲ ge</td><td align="center">ゴ go</td></tr><tr><td align="center">ザ za</td><td align="center">ジ zi</td><td align="center">ズ zu</td><td align="center">ゼ ze</td><td align="center">ゾ zo</td></tr><tr><td align="center">ダ da</td><td align="center">ヂ di</td><td align="center">ヅ du</td><td align="center">デ de</td><td align="center">ド do</td></tr><tr><td align="center">バ ba</td><td align="center">ビ bi</td><td align="center">ブ bu</td><td align="center">ベ be</td><td align="center">ボ bo</td></tr><tr><td align="center">パ pa</td><td align="center">ピ pi</td><td align="center">プ pu</td><td align="center">ペ pe</td><td align="center">ポ po</td></tr></tbody></table><h3 id="促音"><a href="#促音" class="headerlink" title="促音"></a>促音</h3><ul><li><p>中間有包含 つ、ツ 的詞，要頓一下</p><table><thead><tr><th align="center">日文</th><th align="center">中文</th></tr></thead><tbody><tr><td align="center">きつぷ</td><td align="center">車票</td></tr><tr><td align="center">ざつし</td><td align="center">雜誌</td></tr><tr><td align="center">につき</td><td align="center">日記</td></tr><tr><td align="center">コツプ</td><td align="center">杯子</td></tr><tr><td align="center">ベツド</td><td align="center">床</td></tr></tbody></table></li></ul><h3 id="長音"><a href="#長音" class="headerlink" title="長音"></a>長音</h3><ul><li><p>包含 AA、II、UU、EE、OO、OU、EI 等，要拉長音，片假名用 <code>ー</code> 表示</p><table><thead><tr><th align="center">日文</th><th align="center">中文</th></tr></thead><tbody><tr><td align="center">おかあさん</td><td align="center">媽媽</td></tr><tr><td align="center">おにいさん</td><td align="center">哥哥</td></tr><tr><td align="center">ゆうき</td><td align="center">勇氣</td></tr><tr><td align="center">ひこうき</td><td align="center">飛機</td></tr><tr><td align="center">おとうと</td><td align="center">弟弟</td></tr><tr><td align="center">こうこう</td><td align="center">高中</td></tr><tr><td align="center">とけい</td><td align="center">手錶</td></tr><tr><td align="center">せんせん</td><td align="center">老師</td></tr><tr><td align="center">スーパー</td><td align="center">超市</td></tr><tr><td align="center">タクシー</td><td align="center">計程車</td></tr></tbody></table></li></ul><h3 id="重音"><a href="#重音" class="headerlink" title="重音"></a>重音</h3><ul><li><p>前</p><table><thead><tr><th align="center">日文</th><th align="center">中文</th></tr></thead><tbody><tr><td align="center">てんき</td><td align="center">天氣</td></tr><tr><td align="center">ほん</td><td align="center">書</td></tr><tr><td align="center">カード</td><td align="center">卡片</td></tr></tbody></table></li><li><p>中</p><table><thead><tr><th align="center">日文</th><th align="center">中文</th></tr></thead><tbody><tr><td align="center">たまご</td><td align="center">雞蛋</td></tr><tr><td align="center">にほん</td><td align="center">日本</td></tr></tbody></table></li><li><p>後</p><table><thead><tr><th align="center">日文</th><th align="center">中文</th></tr></thead><tbody><tr><td align="center">りんご</td><td align="center">蘋果</td></tr><tr><td align="center">さけ</td><td align="center">酒</td></tr></tbody></table></li></ul><h2 id="常用問候語"><a href="#常用問候語" class="headerlink" title="常用問候語"></a>常用問候語</h2><table><thead><tr><th align="center">日文</th><th align="center">中文</th><th align="center">註解</th></tr></thead><tbody><tr><td align="center">こんにちは</td><td align="center">你好</td><td align="center">は 當助詞念作 <code>wa</code></td></tr><tr><td align="center">おはよう（ございます）</td><td align="center">早安</td><td align="center"></td></tr><tr><td align="center">こんばんは</td><td align="center">晚上好</td><td align="center"></td></tr><tr><td align="center">おやすみ（なさい）</td><td align="center">晚安</td><td align="center"></td></tr><tr><td align="center">さようなら</td><td align="center">再見</td><td align="center"></td></tr><tr><td align="center">じゃ また あいましょう</td><td align="center">再見</td><td align="center"></td></tr><tr><td align="center">ありがとう（ございます）</td><td align="center">謝謝</td><td align="center"></td></tr><tr><td align="center">どういたしまして</td><td align="center">不客氣</td><td align="center"></td></tr><tr><td align="center">すみません</td><td align="center">對不起、不好意思</td><td align="center"></td></tr><tr><td align="center">よろしく（おねがいします）</td><td align="center">請多指教</td><td align="center"></td></tr><tr><td align="center">おねがいします</td><td align="center">麻煩你</td><td align="center"></td></tr><tr><td align="center">（お）ひさしぶり（です）</td><td align="center">好久不見</td><td align="center"></td></tr><tr><td align="center">（お）げんき（ですか）</td><td align="center">你好嗎？</td><td align="center"></td></tr><tr><td align="center">おめでとう（ございます）</td><td align="center">恭喜你</td><td align="center"></td></tr><tr><td align="center">おだいじに</td><td align="center">請保重</td><td align="center"></td></tr><tr><td align="center">おつかれさまです</td><td align="center">辛苦了</td><td align="center"></td></tr><tr><td align="center">いただきます</td><td align="center">開動了</td><td align="center"></td></tr><tr><td align="center">ごちそうさまでした</td><td align="center">吃完飯</td><td align="center"></td></tr><tr><td align="center">いってきます</td><td align="center">出門了</td><td align="center"></td></tr><tr><td align="center">いってらっしゃい</td><td align="center">慢走</td><td align="center"></td></tr><tr><td align="center">ただいま</td><td align="center">我回來了</td><td align="center"></td></tr><tr><td align="center">おかえり（なさい）</td><td align="center">你回來了</td><td align="center"></td></tr><tr><td align="center">はじめまして</td><td align="center">初次見面</td><td align="center"></td></tr><tr><td align="center">ちょっとまって（こださい）</td><td align="center">請等一下</td><td align="center"></td></tr></tbody></table><h2 id="基礎文法"><a href="#基礎文法" class="headerlink" title="基礎文法"></a>基礎文法</h2><h3 id="基本文型"><a href="#基本文型" class="headerlink" title="基本文型"></a>基本文型</h3><table><thead><tr><th align="center">日文</th><th align="center">中文</th><th align="center">註解</th></tr></thead><tbody><tr><td align="center">わたしは台湾人です</td><td align="center">我是台灣人</td><td align="center">台灣人（たいわんじん）</td></tr><tr><td align="center">わたしは日本人ではありません</td><td align="center">我不是日本人</td><td align="center">日本人（にほんじん）</td></tr><tr><td align="center">わたしは日本人じゃありません</td><td align="center">我不是日本人</td><td align="center">比較口語</td></tr><tr><td align="center">あなたは台湾人ですか</td><td align="center">你是台灣人嗎？</td><td align="center"></td></tr><tr><td align="center">わたしも台湾人です</td><td align="center">我也是台灣人</td><td align="center"></td></tr><tr><td align="center">（わたしは）王さんではありません</td><td align="center">我不是王先生</td><td align="center">王（おう）、さん（先生、小姐）</td></tr><tr><td align="center">（あなたは）鈴木さんですか</td><td align="center">你是鈴木先生嗎?</td><td align="center">鈴木（すずき）</td></tr></tbody></table><h3 id="指示代名詞：事物（これ、それ、あれ、どれ）"><a href="#指示代名詞：事物（これ、それ、あれ、どれ）" class="headerlink" title="指示代名詞：事物（これ、それ、あれ、どれ）"></a>指示代名詞：事物（これ、それ、あれ、どれ）</h3><table><thead><tr><th align="center">日文</th><th align="center">中文</th><th align="center">註解</th></tr></thead><tbody><tr><td align="center">これは何ですか</td><td align="center">這是什麼？</td><td align="center">これ（這個）、何（なん or なに）</td></tr><tr><td align="center">それは切符です</td><td align="center">那是車票</td><td align="center">それ（那個）、切符（きっぷ）</td></tr><tr><td align="center">あれは何ですか</td><td align="center">那是什麼？</td><td align="center">あれ（那個），比較遠的</td></tr><tr><td align="center">あれはデパートです</td><td align="center">那是百貨公司</td><td align="center">デパート（百貨公司）</td></tr><tr><td align="center">わたしたちの車はどれですか</td><td align="center">我們的車子是哪一個？</td><td align="center">どれ（哪一個）、わたしたち（我們）、車（くるま）</td></tr><tr><td align="center">あれです</td><td align="center">那個</td><td align="center"></td></tr><tr><td align="center">これはわたしのかぎですか</td><td align="center">這是我的鑰匙嗎？</td><td align="center">かぎ（鑰匙）</td></tr><tr><td align="center">あなたのバイクはどれですか</td><td align="center">你的摩托車是哪個？</td><td align="center">バイク（摩托車）</td></tr></tbody></table><h3 id="指示代名詞：地點（ここ、そこ、あそこ、どこ）"><a href="#指示代名詞：地點（ここ、そこ、あそこ、どこ）" class="headerlink" title="指示代名詞：地點（ここ、そこ、あそこ、どこ）"></a>指示代名詞：地點（ここ、そこ、あそこ、どこ）</h3><table><thead><tr><th align="center">日文</th><th align="center">中文</th><th align="center">註解</th></tr></thead><tbody><tr><td align="center">ここは神戸駅です</td><td align="center">這裡是神戶車站</td><td align="center">ここ（這裡）、神戸駅（こうべえき）</td></tr><tr><td align="center">トイレはどこですか</td><td align="center">廁所在哪裡？</td><td align="center">トイレ（廁所）、どこ（哪裡）</td></tr><tr><td align="center">（トイレは）あそこです</td><td align="center">廁所在那裡</td><td align="center">あそこ（那裡），比較遠的</td></tr></tbody></table><h3 id="連體詞：事物（この、その、あの）"><a href="#連體詞：事物（この、その、あの）" class="headerlink" title="連體詞：事物（この、その、あの）"></a>連體詞：事物（この、その、あの）</h3><ul><li>用於修飾名詞，所以後面一定要接名詞</li></ul><table><thead><tr><th align="center">日文</th><th align="center">中文</th><th align="center">註解</th></tr></thead><tbody><tr><td align="center">このかばんはわたしのです</td><td align="center">這個包包是我的</td><td align="center">この（這個）、かばん（包包）</td></tr><tr><td align="center">あのかさは誰のですか</td><td align="center">那個雨傘是誰的？</td><td align="center">あの（那個）、かさ（雨傘）、誰（だれ）</td></tr><tr><td align="center">（あのかさは）田中さんのです</td><td align="center">那個雨傘是田中先生的</td><td align="center">田中（たなか）</td></tr><tr><td align="center">この本は誰のですか</td><td align="center">這本書是誰的？</td><td align="center">本（ほん）</td></tr></tbody></table><h3 id="疑問詞（どこ、だれ、いつ、いくら）"><a href="#疑問詞（どこ、だれ、いつ、いくら）" class="headerlink" title="疑問詞（どこ、だれ、いつ、いくら）"></a>疑問詞（どこ、だれ、いつ、いくら）</h3><table><thead><tr><th align="center">日文</th><th align="center">中文</th><th align="center">註解</th></tr></thead><tbody><tr><td align="center">トイレはどこですか</td><td align="center">廁所在哪裡？</td><td align="center">どこ（哪裡），禮貌點可以說どちら</td></tr><tr><td align="center">彼はだれですか</td><td align="center">他是誰？</td><td align="center">だれ（誰），禮貌點可以說どなた、 彼（かれ、他）</td></tr><tr><td align="center">誕生日はいつですか</td><td align="center">生日是什麼時候？</td><td align="center">いつ（什麼時候）、誕生日（たんじょび）</td></tr><tr><td align="center">これはいくらですか</td><td align="center">這個是多少錢？</td><td align="center">いくら（多少錢）</td></tr><tr><td align="center">これは何ですか</td><td align="center">這個是什麼？</td><td align="center"></td></tr><tr><td align="center">わたしのコップはどれですか</td><td align="center">我的杯子是哪一個？</td><td align="center">どれ（哪一個）、コップ（杯子）</td></tr><tr><td align="center">これはどんな映画ですか</td><td align="center">這是什麼樣的電影？</td><td align="center">どんは（什麼樣的）、映画（えいが、電影）</td></tr><tr><td align="center">これはどうやって使いますか</td><td align="center">這個怎麼用？</td><td align="center">どうやって（怎麼）、使（つか）</td></tr><tr><td align="center">どうしてですか</td><td align="center">為什麼？</td><td align="center"></td></tr><tr><td align="center">なんでですか</td><td align="center">為什麼？</td><td align="center"></td></tr><tr><td align="center">このかばんはいくらですか</td><td align="center">這個包包多少錢？</td><td align="center"></td></tr><tr><td align="center">これはどんな本ですか</td><td align="center">這是什麼樣的書？</td><td align="center"></td></tr><tr><td align="center">結婚式はいつですか</td><td align="center">婚禮是什麼時候</td><td align="center">結婚式（けっこんしき、婚禮）</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>japanese</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>leetcode javascript 30 days</title>
    <link href="/notes/2025/02/01/leetcode-js/"/>
    <url>/notes/2025/02/01/leetcode-js/</url>
    
    <content type="html"><![CDATA[<blockquote><p>沒在 leetcode 寫過 js 耶，酷</p></blockquote><h3 id="2667-Create-Hello-World-Function"><a href="#2667-Create-Hello-World-Function" class="headerlink" title="2667. Create Hello World Function"></a><a href="https://leetcode.com/problems/create-hello-world-function/description/?envType=study-plan-v2&envId=30-days-of-javascript">2667. Create Hello World Function</a></h3><ul><li>了解 closure 的概念就好</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> createHelloWorld = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const f = createHelloWorld();</span><br><span class="hljs-comment"> * f(); // &quot;Hello World&quot;</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2620-Counter"><a href="#2620-Counter" class="headerlink" title="2620. Counter"></a><a href="https://leetcode.com/problems/counter/description/?envType=study-plan-v2&envId=30-days-of-javascript">2620. Counter</a></h3><ul><li>一樣 closure，之後 call return 的 function 都可以修改最初傳進來的變數的值</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">n</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">counter</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> createCounter = <span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> n++;<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const counter = createCounter(10)</span><br><span class="hljs-comment"> * counter() // 10</span><br><span class="hljs-comment"> * counter() // 11</span><br><span class="hljs-comment"> * counter() // 12</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2704-To-Be-Or-Not-To-Be"><a href="#2704-To-Be-Or-Not-To-Be" class="headerlink" title="2704. To Be Or Not To Be"></a><a href="https://leetcode.com/studyplan/30-days-of-javascript/">2704. To Be Or Not To Be</a></h3><ul><li>這題是寫測試 code，教我們怎麼 throw error</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">string</span>&#125; <span class="hljs-variable">val</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Object</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> expect = <span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">toBe</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (v === val) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Not Equal&quot;</span>);<br>    &#125;,<br>    <span class="hljs-attr">notToBe</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (v !== val) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Equal&quot;</span>);<br>    &#125;,<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * expect(5).toBe(5); // true</span><br><span class="hljs-comment"> * expect(5).notToBe(5); // throws &quot;Equal&quot;</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2665-Counter-II"><a href="#2665-Counter-II" class="headerlink" title="2665. Counter II"></a><a href="https://leetcode.com/problems/counter-ii/description/?envType=study-plan-v2&envId=30-days-of-javascript">2665. Counter II</a></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">integer</span>&#125; <span class="hljs-variable">init</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type"> increment: Function, decrement: Function, reset: Function </span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> createCounter = <span class="hljs-keyword">function</span> (<span class="hljs-params">init</span>) &#123;<br>  <span class="hljs-keyword">var</span> cnt = init;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> ++cnt,<br>    <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> (cnt = init),<br>    <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> --cnt,<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const counter = createCounter(5)</span><br><span class="hljs-comment"> * counter.increment(); // 6</span><br><span class="hljs-comment"> * counter.reset(); // 5</span><br><span class="hljs-comment"> * counter.decrement(); // 4</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2635-Apply-Transform-Over-Each-Element-in-Array"><a href="#2635-Apply-Transform-Over-Each-Element-in-Array" class="headerlink" title="2635. Apply Transform Over Each Element in Array"></a><a href="https://leetcode.com/problems/apply-transform-over-each-element-in-array/description/?envType=study-plan-v2&envId=30-days-of-javascript">2635. Apply Transform Over Each Element in Array</a></h3><blockquote><p>實作 map 來跑 input function，題目規定不能用 <code>Array.map</code> 讓我愣了一下<br>有各種不同的寫法</p></blockquote><ul><li><p><code>for loop</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number[]</span>&#125; <span class="hljs-variable">arr</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">number[]</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret = [];<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) ret.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">fn</span>(arr[i], i));<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>js 可以不用 <code>push</code>，會自動填充</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret = [];<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) ret[i] = <span class="hljs-title function_">fn</span>(arr[i], i);<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>補充</p><ul><li><p>如果中間有空的沒填，比方說</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> arr = [];<br>arr[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>arr[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p>那麼 <code>arr[1]</code> 會自動填成 <code>undefined</code>，因此 <code>arr.length</code> 會是 <code>3</code></p></li><li><p><code>array</code> 可以用 <code>const</code> 是因為在 javascript 中，<code>const</code> 是 <strong>保證變數本身的記憶體位置不變，但不保證內部內容不可變</strong>，因此在陣列 arr reference 不變的情況下改內容是可以接受的</p></li></ul></li></ul></li><li><p><code>forEach</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret = [];<br>  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el, idx</span>) =&gt;</span> (ret[idx] = <span class="hljs-title function_">fn</span>(el, idx)));<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>forEach</code> 沒有回傳值，不能像 <code>map</code> 那樣直接 <code>return</code></p></li><li><p><code>array.reduce</code>，但不太直觀</p><ul><li><code>array.reduce(callback, initialValue);</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, fn</span>) &#123;<br>  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">ret, el, idx</span>) =&gt;</span> &#123;<br>    ret[idx] = <span class="hljs-title function_">fn</span>(el, idx);<br>    <span class="hljs-keyword">return</span> ret;<br>  &#125;, []);<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>如果可以用 <code>Array.map</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title function_">map</span> = (<span class="hljs-params">arr, fn</span>) =&gt; arr.<span class="hljs-title function_">map</span>(fn);<br></code></pre></td></tr></table></figure><blockquote><p>健康又快樂</p></blockquote></li></ul><h3 id="2634-Filter-Elements-from-Array"><a href="#2634-Filter-Elements-from-Array" class="headerlink" title="2634. Filter Elements from Array"></a><a href="https://leetcode.com/problems/filter-elements-from-array/description/?envType=study-plan-v2&envId=30-days-of-javascript">2634. Filter Elements from Array</a></h3><blockquote><p>跟前一題類似</p></blockquote><ul><li><p><code>forEach</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number[]</span>&#125; <span class="hljs-variable">arr</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">number[]</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> filter = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret = [];<br>  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el, idx</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(el, idx) &amp;&amp; ret.<span class="hljs-title function_">push</span>(el));<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>如果可以用 <code>Array.filter</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title function_">filter</span> = (<span class="hljs-params">arr, fn</span>) =&gt; arr.<span class="hljs-title function_">filter</span>(fn);<br></code></pre></td></tr></table></figure></li></ul><h3 id="2626-Array-Reduce-Transformation"><a href="#2626-Array-Reduce-Transformation" class="headerlink" title="2626. Array Reduce Transformation"></a><a href="https://leetcode.com/problems/array-reduce-transformation/description/?envType=study-plan-v2&envId=30-days-of-javascript">2626. Array Reduce Transformation</a></h3><blockquote><p>跟前幾題類似</p></blockquote><ul><li><p><code>forEach</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number[]</span>&#125; <span class="hljs-variable">nums</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">init</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">number</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> reduce = <span class="hljs-keyword">function</span> (<span class="hljs-params">nums, fn, init</span>) &#123;<br>  <span class="hljs-keyword">let</span> acc = init;<br>  nums.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> (acc = <span class="hljs-title function_">fn</span>(acc, el)));<br>  <span class="hljs-keyword">return</span> acc;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p>如果可以用 <code>Array.reduce</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title function_">reduce</span> = (<span class="hljs-params">nums, fn, init</span>) =&gt; nums.<span class="hljs-title function_">reduce</span>(fn, init);<br></code></pre></td></tr></table></figure></li></ul><h3 id="2629-Function-Composition"><a href="#2629-Function-Composition" class="headerlink" title="2629. Function Composition"></a><a href="https://leetcode.com/problems/function-composition/description/?envType=study-plan-v2&envId=30-days-of-javascript">2629. Function Composition</a></h3><p>從最後面開始每個 function 跑一次</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function[]</span>&#125; <span class="hljs-variable">functions</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> compose = <span class="hljs-keyword">function</span> (<span class="hljs-params">functions</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>    functions.<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> (x = <span class="hljs-title function_">fn</span>(x)));<br>    <span class="hljs-keyword">return</span> x;<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const fn = compose([x =&gt; x + 1, x =&gt; 2 * x])</span><br><span class="hljs-comment"> * fn(4) // 9</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><ul><li><code>reduceRight</code><br>跟 <code>array.reduce()</code> 一樣，只是是從最右邊往左 reduce<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> compose = <span class="hljs-keyword">function</span> (<span class="hljs-params">functions</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">x</span>) =&gt;</span> functions.<span class="hljs-title function_">reduceRight</span>(<span class="hljs-function">(<span class="hljs-params">acc, fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(acc), x);<br>&#125;;<br></code></pre></td></tr></table></figure></li></ul><h3 id="2703-Return-Length-of-Arguments-Passed"><a href="#2703-Return-Length-of-Arguments-Passed" class="headerlink" title="2703. Return Length of Arguments Passed"></a><a href="https://leetcode.com/problems/return-length-of-arguments-passed/description/?envType=study-plan-v2&envId=30-days-of-javascript">2703. Return Length of Arguments Passed</a></h3><p>好像只是在考 javascript 的 rest parameter?</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">...(null|boolean|number|string|Array|Object)</span>&#125; <span class="hljs-variable">args</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">number</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> argumentsLength = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>  <span class="hljs-keyword">return</span> args.<span class="hljs-property">length</span>;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * argumentsLength(1, 2, 3); // 3</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2666-Allow-One-Function-Call"><a href="#2666-Allow-One-Function-Call" class="headerlink" title="2666. Allow One Function Call"></a><a href="https://leetcode.com/problems/allow-one-function-call/description/?envType=study-plan-v2&envId=30-days-of-javascript">2666. Allow One Function Call</a></h3><p>closure + rest parameter</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> once = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) &#123;<br>  <span class="hljs-keyword">let</span> seen = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!seen) &#123;<br>      seen = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args);<br>    &#125;<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * let fn = (a,b,c) =&gt; (a + b + c)</span><br><span class="hljs-comment"> * let onceFn = once(fn)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * onceFn(1,2,3); // 6</span><br><span class="hljs-comment"> * onceFn(2,3,6); // returns undefined without calling fn</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2623-Memoize"><a href="#2623-Memoize" class="headerlink" title="2623. Memoize"></a><a href="https://leetcode.com/problems/memoize/description/?envType=study-plan-v2&envId=30-days-of-javascript">2623. Memoize</a></h3><ul><li><p>Map</p><ul><li>在 javascript 中，<code>Map</code> 不能用中括號來存取，一定要 <code>Map.get()</code>、<code>Map.set()</code>、<code>Map.has()</code>。另外這題可以用 <code>JSON.stringif()</code> 把 <code>args</code> 變成 <code>key</code></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoize</span>(<span class="hljs-params">fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> key = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args);<br>    <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(key);<br>    hash.<span class="hljs-title function_">set</span>(key, <span class="hljs-title function_">fn</span>(...args));<br>    <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(key);<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * let callCount = 0;</span><br><span class="hljs-comment"> * const memoizedFn = memoize(function (a, b) &#123;</span><br><span class="hljs-comment"> * callCount += 1;</span><br><span class="hljs-comment"> *   return a + b;</span><br><span class="hljs-comment"> * &#125;)</span><br><span class="hljs-comment"> * memoizedFn(2, 3) // 5</span><br><span class="hljs-comment"> * memoizedFn(2, 3) // 5</span><br><span class="hljs-comment"> * console.log(callCount) // 1</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure></li><li><p>Object</p><ul><li><code>Object</code> 就比較靈活</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">memoize</span>(<span class="hljs-params">fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> hash = &#123;&#125;;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> key = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(args);<br>    <span class="hljs-keyword">if</span> (hash[key] != <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> hash[key];<br>    hash[key] = <span class="hljs-title function_">fn</span>(...args);<br>    <span class="hljs-keyword">return</span> hash[key];<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="2723-Add-Two-Promises"><a href="#2723-Add-Two-Promises" class="headerlink" title="2723. Add Two Promises"></a><a href="https://leetcode.com/problems/add-two-promises/description/?envType=study-plan-v2&envId=30-days-of-javascript">2723. Add Two Promises</a></h3><p>這邊要用 <code>Promise.all</code> 來等所有 <code>promise</code> 算好一起跑 <code>then</code>。</p><ul><li><p>直接加</p><ul><li>因為這裡 arg 只有兩個數字，可以直接加起來就好</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Promise</span>&#125; <span class="hljs-variable">promise1</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Promise</span>&#125; <span class="hljs-variable">promise2</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Promise</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> addTwoPromises = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">promise1, promise2</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([promise1, promise2]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[a, b]</span>) =&gt;</span> a + b);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * addTwoPromises(Promise.resolve(2), Promise.resolve(2))</span><br><span class="hljs-comment"> *   .then(console.log); // 4</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure></li><li><p>當 arguments 不只兩個時，可以用 <code>Array.reduce()</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> addTwoPromises = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(args).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret</span>) =&gt;</span><br>    ret.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> acc + val, <span class="hljs-number">0</span>)<br>  );<br>&#125;;<br></code></pre></td></tr></table></figure></li></ul><h3 id="2621-Sleep"><a href="#2621-Sleep" class="headerlink" title="2621. Sleep"></a><a href="https://leetcode.com/problems/sleep/description/?envType=study-plan-v2&envId=30-days-of-javascript">2621. Sleep</a></h3><ul><li><code>resolve()</code> 是 Promise 提供的 function，用來把 Promise 的狀態變成已完成。所以這邊在 <code>millis</code> 時間後執行 <code>resolve()</code> 就能完成 <code>return</code>。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">millis</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Promise</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-params">millis</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, millis));<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * let t = Date.now()</span><br><span class="hljs-comment"> * sleep(100).then(() =&gt; console.log(Date.now() - t)) // 100</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2715-Timeout-Cancellation"><a href="#2715-Timeout-Cancellation" class="headerlink" title="2715. Timeout Cancellation"></a><a href="https://leetcode.com/problems/timeout-cancellation/description/?envType=study-plan-v2&envId=30-days-of-javascript">2715. Timeout Cancellation</a></h3><blockquote><p>滿酷的題目，很有趣</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">args</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">t</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> cancellable = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn, args, t</span>) &#123;<br>  <span class="hljs-keyword">let</span> timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(...args), t);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timeout);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  const result = [];</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const fn = (x) =&gt; x * 5;</span><br><span class="hljs-comment"> *  const args = [2], t = 20, cancelTimeMs = 50;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const start = performance.now();</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const log = (...argsArr) =&gt; &#123;</span><br><span class="hljs-comment"> *      const diff = Math.floor(performance.now() - start);</span><br><span class="hljs-comment"> *      result.push(&#123;&quot;time&quot;: diff, &quot;returned&quot;: fn(...argsArr)&#125;);</span><br><span class="hljs-comment"> *  &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const cancel = cancellable(log, args, t);</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const maxT = Math.max(t, cancelTimeMs);</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  setTimeout(cancel, cancelTimeMs);</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  setTimeout(() =&gt; &#123;</span><br><span class="hljs-comment"> *      console.log(result); // [&#123;&quot;time&quot;:20,&quot;returned&quot;:10&#125;]</span><br><span class="hljs-comment"> *  &#125;, maxT + 15)</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2725-Interval-Cancellation"><a href="#2725-Interval-Cancellation" class="headerlink" title="2725. Interval Cancellation"></a><a href="https://leetcode.com/problems/interval-cancellation/?envType=study-plan-v2&envId=30-days-of-javascript">2725. Interval Cancellation</a></h3><p>跟上一題差不多，但要先馬上 call fn 一次</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">args</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">t</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> cancellable = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn, args, t</span>) &#123;<br>  <span class="hljs-title function_">fn</span>(...args);<br>  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(...args), t);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  const result = [];</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const fn = (x) =&gt; x * 2;</span><br><span class="hljs-comment"> *  const args = [4], t = 35, cancelTimeMs = 190;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const start = performance.now();</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const log = (...argsArr) =&gt; &#123;</span><br><span class="hljs-comment"> *      const diff = Math.floor(performance.now() - start);</span><br><span class="hljs-comment"> *      result.push(&#123;&quot;time&quot;: diff, &quot;returned&quot;: fn(...argsArr)&#125;);</span><br><span class="hljs-comment"> *  &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  const cancel = cancellable(log, args, t);</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  setTimeout(cancel, cancelTimeMs);</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  setTimeout(() =&gt; &#123;</span><br><span class="hljs-comment"> *      console.log(result); // [</span><br><span class="hljs-comment"> *                           //     &#123;&quot;time&quot;:0,&quot;returned&quot;:8&#125;,</span><br><span class="hljs-comment"> *                           //     &#123;&quot;time&quot;:35,&quot;returned&quot;:8&#125;,</span><br><span class="hljs-comment"> *                           //     &#123;&quot;time&quot;:70,&quot;returned&quot;:8&#125;,</span><br><span class="hljs-comment"> *                           //     &#123;&quot;time&quot;:105,&quot;returned&quot;:8&#125;,</span><br><span class="hljs-comment"> *                           //     &#123;&quot;time&quot;:140,&quot;returned&quot;:8&#125;,</span><br><span class="hljs-comment"> *                           //     &#123;&quot;time&quot;:175,&quot;returned&quot;:8&#125;</span><br><span class="hljs-comment"> *                           // ]</span><br><span class="hljs-comment"> *  &#125;, cancelTimeMs + t + 15)</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2637-Promise-Time-Limit"><a href="#2637-Promise-Time-Limit" class="headerlink" title="2637. Promise Time Limit"></a><a href="https://leetcode.com/problems/promise-time-limit/description/?envType=study-plan-v2&envId=30-days-of-javascript">2637. Promise Time Limit</a></h3><p><code>Promise.race()</code> 會遍歷傳進來的一堆 <code>Promise</code>，然後回傳最先執行完的那個。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">t</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> timeLimit = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn, t</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> fn1 = <span class="hljs-title function_">fn</span>(...args);<br>    <span class="hljs-keyword">const</span> fn2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span><br>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">&quot;Time Limit Exceeded&quot;</span>), t)<br>    );<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([fn1, fn2]);<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const limited = timeLimit((t) =&gt; new Promise(res =&gt; setTimeout(res, t)), 100);</span><br><span class="hljs-comment"> * limited(150).catch(console.log) // &quot;Time Limit Exceeded&quot; at t=100ms</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2622-Cache-With-Time-Limit"><a href="#2622-Cache-With-Time-Limit" class="headerlink" title="2622. Cache With Time Limit"></a><a href="https://leetcode.com/problems/cache-with-time-limit/description/?envType=study-plan-v2&envId=30-days-of-javascript">2622. Cache With Time Limit</a></h3><p>在 js 中，用 <code>Function.prototype</code> 的方式可以宣告這個物件裡面包含的函式，像這題就宣告了 <code>get</code>、<code>set</code>、<code>count</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">TimeLimitedCache</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = &#123;&#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">key</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">value</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; duration time until expiration in ms</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">boolean</span>&#125; if un-expired key already existed</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">TimeLimitedCache</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">set</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, duration</span>) &#123;<br>  <span class="hljs-keyword">let</span> ret = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key] != <span class="hljs-literal">undefined</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key] != <span class="hljs-literal">undefined</span>) <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key].<span class="hljs-property">timer</span>);<br>  <span class="hljs-keyword">else</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key] = &#123;&#125;;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key].<span class="hljs-property">val</span> = value;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key].<span class="hljs-property">timer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key];<br>  &#125;, duration);<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">key</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">number</span>&#125; value associated with key</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">TimeLimitedCache</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">get</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key] != <span class="hljs-literal">undefined</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[key].<span class="hljs-property">val</span> : -<span class="hljs-number">1</span>;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">number</span>&#125; count of non-expired keys</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">TimeLimitedCache</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">count</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>).<span class="hljs-property">length</span>;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const timeLimitedCache = new TimeLimitedCache()</span><br><span class="hljs-comment"> * timeLimitedCache.set(1, 42, 1000); // false</span><br><span class="hljs-comment"> * timeLimitedCache.get(1) // 42</span><br><span class="hljs-comment"> * timeLimitedCache.count() // 1</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2627-Debounce"><a href="#2627-Debounce" class="headerlink" title="2627. Debounce"></a><a href="https://leetcode.com/problems/debounce/description/?envType=study-plan-v2&envId=30-days-of-javascript">2627. Debounce</a></h3><ul><li>沒什麼特別的</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; t milliseconds</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Function</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> debounce = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn, t</span>) &#123;<br>  <span class="hljs-keyword">let</span> timer;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-built_in">clearTimeout</span>(timer);<br>    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fn</span>(...args), t);<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const log = debounce(console.log, 100);</span><br><span class="hljs-comment"> * log(&#x27;Hello&#x27;); // cancelled</span><br><span class="hljs-comment"> * log(&#x27;Hello&#x27;); // cancelled</span><br><span class="hljs-comment"> * log(&#x27;Hello&#x27;); // Logged at t=100ms</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2721-Execute-Asynchronous-Functions-in-Parallel"><a href="#2721-Execute-Asynchronous-Functions-in-Parallel" class="headerlink" title="2721. Execute Asynchronous Functions in Parallel"></a><a href="https://leetcode.com/problems/execute-asynchronous-functions-in-parallel/description/?envType=study-plan-v2&envId=30-days-of-javascript">2721. Execute Asynchronous Functions in Parallel</a></h3><p>好難阿，題目規定不能用 <code>Promise.all</code>，要注意回傳的順序，還要確保所有 <code>Promise</code> 已經做完。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array&lt;Function&gt;</span>&#125; <span class="hljs-variable">functions</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Promise&lt;any&gt;</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> promiseAll = <span class="hljs-keyword">function</span> (<span class="hljs-params">functions</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> res = [];<br>    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br>    functions.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">fn, idx</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">fn</span>()<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">ret</span>) =&gt;</span> &#123;<br>          res[idx] = ret;<br>          count++;<br>          <span class="hljs-keyword">if</span> (count == functions.<span class="hljs-property">length</span>) <span class="hljs-title function_">resolve</span>(res);<br>        &#125;)<br>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(error));<br>    &#125;);<br>  &#125;);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const promise = promiseAll([() =&gt; new Promise(res =&gt; res(42))])</span><br><span class="hljs-comment"> * promise.then(console.log); // [42]</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><ul><li>如果可以用 <code>Promise.all</code><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title function_">promiseAll</span> = (<span class="hljs-params">functions</span>) =&gt; <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(functions.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>()));<br></code></pre></td></tr></table></figure></li></ul><h3 id="2727-Is-Object-Empty"><a href="#2727-Is-Object-Empty" class="headerlink" title="2727. Is Object Empty"></a><a href="https://leetcode.com/problems/is-object-empty/description/?envType=study-plan-v2&envId=30-days-of-javascript">2727. Is Object Empty</a></h3><p>一開始最直覺的方法，直接轉成 <code>Array</code> 算 <code>length</code>，<code>Array</code> 也是 <code>Object</code> 的一種，所以不用管 <code>obj</code> 是不是 <code>Array</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Object|Array</span>&#125; <span class="hljs-variable">obj</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">boolean</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> isEmpty = <span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-property">length</span> == <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>更簡單的方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> isEmpty = <span class="hljs-keyword">function</span> (<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> _ <span class="hljs-keyword">in</span> obj) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2677-Chunk-Array"><a href="#2677-Chunk-Array" class="headerlink" title="2677. Chunk Array"></a><a href="https://leetcode.com/problems/chunk-array/description/?envType=study-plan-v2&envId=30-days-of-javascript">2677. Chunk Array</a></h3><blockquote><p>我只會這種醜醜 code qq</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">size</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Array</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> chunk = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, size</span>) &#123;<br>  <span class="hljs-keyword">let</span> ret = [];<br>  <span class="hljs-keyword">let</span> cnt = -<span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) &#123;<br>    <span class="hljs-keyword">if</span> (i % size == <span class="hljs-number">0</span>) &#123;<br>      ret.<span class="hljs-title function_">push</span>([]);<br>      cnt++;<br>    &#125;<br>    ret[cnt].<span class="hljs-title function_">push</span>(arr[i]);<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p>更簡潔的寫法</p><ul><li><code>Array.slice()</code> 會回傳一個新的陣列，不會改變原本的陣列</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> chunk = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, size</span>) &#123;<br>  <span class="hljs-keyword">let</span> ret = [];<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i += size) ret.<span class="hljs-title function_">push</span>(arr.<span class="hljs-title function_">slice</span>(i, i + size));<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>arr.slice</code> 會回傳 <code>[i, i+size)</code> 的陣列，不用擔心 <code>i+size</code> 超過 <code>arr.length</code> 的問題，因為 <code>slice</code> 會自動調整</p></li></ul><h3 id="2619-Array-Prototype-Last"><a href="#2619-Array-Prototype-Last" class="headerlink" title="2619. Array Prototype Last"></a><a href="https://leetcode.com/problems/array-prototype-last/description/?envType=study-plan-v2&envId=30-days-of-javascript">2619. Array Prototype Last</a></h3><p><code>this[this.length - 1]</code> 也可以改成像 Python 那樣， <code>this.at(-1)</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">null|boolean|number|string|Array|Object</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">last</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">length</span> == <span class="hljs-number">0</span> ? -<span class="hljs-number">1</span> : <span class="hljs-variable language_">this</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * const arr = [1, 2, 3];</span><br><span class="hljs-comment"> * arr.last(); // 3</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2631-Group-By"><a href="#2631-Group-By" class="headerlink" title="2631. Group By"></a><a href="https://leetcode.com/problems/group-by/description/?envType=study-plan-v2&envId=30-days-of-javascript">2631. Group By</a></h3><p>不知道為什麼是 <code>medium</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Object</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">groupBy</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret = &#123;&#125;;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">fn</span>(el);<br>    <span class="hljs-keyword">if</span> (ret[key] == <span class="hljs-literal">undefined</span>) ret[key] = [];<br>    ret[key].<span class="hljs-title function_">push</span>(el);<br>  &#125;);<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * [1,2,3].groupBy(String) // &#123;&quot;1&quot;:[1],&quot;2&quot;:[2],&quot;3&quot;:[3]&#125;</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2724-Sort-By"><a href="#2724-Sort-By" class="headerlink" title="2724. Sort By"></a><a href="https://leetcode.com/problems/sort-by/description/?envType=study-plan-v2&envId=30-days-of-javascript">2724. Sort By</a></h3><p>javascript 中，lambda function 可以直接寫在 <code>Array.sort()</code> 裡面</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Function</span>&#125; <span class="hljs-variable">fn</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Array</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> <span class="hljs-title function_">sortBy</span> = (<span class="hljs-params">arr, fn</span>) =&gt; arr.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(a) - <span class="hljs-title function_">fn</span>(b));<br></code></pre></td></tr></table></figure><p>不過 <code>arr.sort()</code> 會改變原本的 input array，實際上應該要複製一份才對</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title function_">sortBy</span> = (<span class="hljs-params">arr, fn</span>) =&gt; [...arr].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(a) - <span class="hljs-title function_">fn</span>(b));<br></code></pre></td></tr></table></figure><h3 id="2722-Join-Two-Arrays-by-ID"><a href="#2722-Join-Two-Arrays-by-ID" class="headerlink" title="2722. Join Two Arrays by ID"></a><a href="https://leetcode.com/problems/join-two-arrays-by-id/description/?envType=study-plan-v2&envId=30-days-of-javascript">2722. Join Two Arrays by ID</a></h3><p>有點麻煩的題目</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr1</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr2</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Array</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> join = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr1, arr2</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret = [];<br>  <span class="hljs-keyword">const</span> id_idx_map = &#123;&#125;;<br>  arr1.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el, idx</span>) =&gt;</span> &#123;<br>    ret.<span class="hljs-title function_">push</span>(el);<br>    id_idx_map[el.<span class="hljs-property">id</span>] = idx;<br>  &#125;);<br>  arr2.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (id_idx_map[el.<span class="hljs-property">id</span>] != <span class="hljs-literal">undefined</span>) &#123;<br>      tar_arr = ret[id_idx_map[el.<span class="hljs-property">id</span>]];<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(el).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> (tar_arr[key] = el[key]));<br>    &#125; <span class="hljs-keyword">else</span> ret.<span class="hljs-title function_">push</span>(el);<br>  &#125;);<br>  <span class="hljs-keyword">return</span> ret.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">obj1, obj2</span>) =&gt;</span> obj1.<span class="hljs-property">id</span> - obj2.<span class="hljs-property">id</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>別人精簡的做法，結合我的 <code>ret</code> 和 <code>id_idx_map</code>，最後用 <code>Object.values()</code> 的時候會自動根據 <code>key</code> 做 sort</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr1</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr2</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Array</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> join = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr1, arr2</span>) &#123;<br>  <span class="hljs-keyword">const</span> result = &#123;&#125;;<br><br>  <span class="hljs-comment">// 1. initialization</span><br>  arr1.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    result[item.<span class="hljs-property">id</span>] = item;<br>  &#125;);<br>  <span class="hljs-comment">// 2. joining</span><br>  arr2.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (result[item.<span class="hljs-property">id</span>]) &#123;<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(item).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> &#123;<br>        result[item.<span class="hljs-property">id</span>][key] = item[key];<br>      &#125;);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      result[item.<span class="hljs-property">id</span>] = item;<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(result);<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2625-Flatten-Deeply-Nested-Array"><a href="#2625-Flatten-Deeply-Nested-Array" class="headerlink" title="2625. Flatten Deeply Nested Array"></a><a href="https://leetcode.com/problems/flatten-deeply-nested-array/description/?envType=study-plan-v2&envId=30-days-of-javascript">2625. Flatten Deeply Nested Array</a></h3><p>DFS 陣列裡面的每一層</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">Array</span>&#125; <span class="hljs-variable">arr</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &#123;<span class="hljs-type">number</span>&#125; <span class="hljs-variable">depth</span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-type">Array</span>&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> flat = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, n</span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">dfs</span> = (<span class="hljs-params">arr, depth, tar_depth</span>) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr) == <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> [arr];<br>    <span class="hljs-keyword">const</span> ret_arr = [];<br>    arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (depth &lt; tar_depth) ret_arr.<span class="hljs-title function_">push</span>(...<span class="hljs-title function_">dfs</span>(el, depth + <span class="hljs-number">1</span>, tar_depth));<br>      <span class="hljs-keyword">else</span> ret_arr.<span class="hljs-title function_">push</span>(el);<br>    &#125;);<br>    <span class="hljs-keyword">return</span> ret_arr;<br>  &#125;;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">dfs</span>(arr, <span class="hljs-number">0</span>, n);<br>&#125;;<br></code></pre></td></tr></table></figure><p>也可以簡化成下面這樣，本質上是一樣的</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> flat = <span class="hljs-keyword">function</span> (<span class="hljs-params">arr, n</span>) &#123;<br>  <span class="hljs-keyword">const</span> ret_arr = [];<br>  arr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(el)) ret_arr.<span class="hljs-title function_">push</span>(...<span class="hljs-title function_">flat</span>(el, n - <span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">else</span> ret_arr.<span class="hljs-title function_">push</span>(el);<br>  &#125;);<br>  <span class="hljs-keyword">return</span> ret_arr;<br>&#125;;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>不知道這會持續幾天的 leetcode daily</title>
    <link href="/notes/2025/01/31/leetcode-daily/"/>
    <url>/notes/2025/01/31/leetcode-daily/</url>
    
    <content type="html"><![CDATA[<h3 id="2025-02-01-3151-Special-Array-I"><a href="#2025-02-01-3151-Special-Array-I" class="headerlink" title="2025&#x2F;02&#x2F;01 3151. Special Array I"></a>2025&#x2F;02&#x2F;01 <a href="https://leetcode.com/problems/special-array-i/description/?envType=daily-question&envId=2025-02-01">3151. Special Array I</a></h3><ul><li>bitwise xor + and 即可<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isArraySpecial</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;nums.<span class="hljs-built_in">size</span>(); i++)&#123;<br>            <span class="hljs-keyword">if</span>(((nums[i] ^ nums[i<span class="hljs-number">-1</span>]) &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-02-1752-Check-if-Array-Is-Sorted-and-Rotated"><a href="#2025-02-02-1752-Check-if-Array-Is-Sorted-and-Rotated" class="headerlink" title="2025&#x2F;02&#x2F;02 1752. Check if Array Is Sorted and Rotated"></a>2025&#x2F;02&#x2F;02 <a href="https://leetcode.com/problems/check-if-array-is-sorted-and-rotated/description/?envType=daily-question&envId=2025-02-02">1752. Check if Array Is Sorted and Rotated</a></h3><ul><li>drop 只能一次，最後要檢查頭尾<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">bool</span> drop = <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &lt; nums[i<span class="hljs-number">-1</span>])&#123;<br>                <span class="hljs-keyword">if</span>(drop) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                drop = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> (nums[n<span class="hljs-number">-1</span>] &gt; nums[<span class="hljs-number">0</span>]) ? !drop : <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-03-3105-Longest-Strictly-Increasing-or-Strictly-Decreasing-Subarray"><a href="#2025-02-03-3105-Longest-Strictly-Increasing-or-Strictly-Decreasing-Subarray" class="headerlink" title="2025&#x2F;02&#x2F;03 3105. Longest Strictly Increasing or Strictly Decreasing Subarray"></a>2025&#x2F;02&#x2F;03 <a href="https://leetcode.com/problems/longest-strictly-increasing-or-strictly-decreasing-subarray/description/?envType=daily-question&envId=2025-02-03">3105. Longest Strictly Increasing or Strictly Decreasing Subarray</a></h3><ul><li>寫個 cnt，遍歷陣列兩次，算出最長的值<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">longestMonotonicSubarray</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>(), cnt = <span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> res = INT_MIN;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &gt; nums[i<span class="hljs-number">-1</span>]) cnt++;<br>            <span class="hljs-keyword">else</span> cnt = <span class="hljs-number">1</span>;<br>            res = <span class="hljs-built_in">max</span>(res, cnt);<br>        &#125;<br>        cnt = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &lt; nums[i<span class="hljs-number">-1</span>]) cnt++;<br>            <span class="hljs-keyword">else</span> cnt = <span class="hljs-number">1</span>;<br>            res = <span class="hljs-built_in">max</span>(res, cnt);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(res, cnt);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-04-1800-Maximum-Ascending-Subarray-Sum"><a href="#2025-02-04-1800-Maximum-Ascending-Subarray-Sum" class="headerlink" title="2025&#x2F;02&#x2F;04 1800. Maximum Ascending Subarray Sum"></a>2025&#x2F;02&#x2F;04 <a href="https://leetcode.com/problems/maximum-ascending-subarray-sum/description/?envType=daily-question&envId=2025-02-04">1800. Maximum Ascending Subarray Sum</a></h3><ul><li>遍歷一次，符合條件就累加<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">maxAscendingSum</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">int</span> res = nums[<span class="hljs-number">0</span>], n = nums.<span class="hljs-built_in">size</span>(), cnt = nums[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;n; i++)&#123;<br>            nums[i] &gt; nums[i<span class="hljs-number">-1</span>] ? cnt += nums[i] : cnt = nums[i];<br>            res = <span class="hljs-built_in">max</span>(res, cnt);<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-05-1790-Check-if-One-String-Swap-Can-Make-Strings-Equal"><a href="#2025-02-05-1790-Check-if-One-String-Swap-Can-Make-Strings-Equal" class="headerlink" title="2025&#x2F;02&#x2F;05 1790. Check if One String Swap Can Make Strings Equal"></a>2025&#x2F;02&#x2F;05 <a href="https://leetcode.com/problems/check-if-one-string-swap-can-make-strings-equal/description/?envType=daily-question&envId=2025-02-05">1790. Check if One String Swap Can Make Strings Equal</a></h3><blockquote><p>連五天 easy 耶</p></blockquote><ul><li>題目只允許交換一次，所以記住兩個 idx 就好<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">areAlmostEqual</span><span class="hljs-params">(string s1, string s2)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = s1.<span class="hljs-built_in">size</span>(), cnt = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> idx1, idx2;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(s1[i] != s2[i])&#123;<br>                cnt++;<br>                <span class="hljs-keyword">if</span>(cnt == <span class="hljs-number">1</span>) idx1 = i;<br>                <span class="hljs-keyword">else</span> idx2 = i;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(cnt == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(cnt == <span class="hljs-number">2</span> &amp;&amp; s1[idx1] == s2[idx2] &amp;&amp; s1[idx2] == s2[idx1]) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-06-1726-Tuple-with-Same-Product"><a href="#2025-02-06-1726-Tuple-with-Same-Product" class="headerlink" title="2025&#x2F;02&#x2F;06 1726. Tuple with Same Product"></a>2025&#x2F;02&#x2F;06 <a href="https://leetcode.com/problems/tuple-with-same-product/description/?envType=daily-question&envId=2025-02-06">1726. Tuple with Same Product</a></h3><ul><li>每個數字都不同，所以考慮在不同位置的情況時可以直接乘以 8。用 hash map 來儲存計算的結果的 counter。<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">tupleSameProduct</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>(), res = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i+<span class="hljs-number">1</span>; j&lt;n; j++)&#123;<br>                <span class="hljs-type">int</span> p = nums[i] * nums[j];<br>                mp[p]++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:mp)<br>            res += (i.second * (i.second - <span class="hljs-number">1</span>)) / <span class="hljs-number">2</span> * <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-07-3160-Find-the-Number-of-Distinct-Colors-Among-the-Balls"><a href="#2025-02-07-3160-Find-the-Number-of-Distinct-Colors-Among-the-Balls" class="headerlink" title="2025&#x2F;02&#x2F;07 3160. Find the Number of Distinct Colors Among the Balls"></a>2025&#x2F;02&#x2F;07 <a href="https://leetcode.com/problems/find-the-number-of-distinct-colors-among-the-balls/description/?envType=daily-question&envId=2025-02-07">3160. Find the Number of Distinct Colors Among the Balls</a></h3><ul><li>開兩個 hash map，記錄 <strong>球對應的顏色</strong> 和 <strong>某顏色的數量</strong>，當顏色數量變成 0 &#x2F; 1 時，代表 少一種 &#x2F; 多一種 顏色。<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">queryResults</span><span class="hljs-params">(<span class="hljs-type">int</span> limit, vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; queries)</span> </span>&#123;<br>        vector&lt;<span class="hljs-type">int</span>&gt; res;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; ball, color;<br>        <span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; v:queries)&#123;<br>            <span class="hljs-type">int</span> a = v[<span class="hljs-number">0</span>], b = v[<span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span>(ball[a] != b)&#123;<br>                color[ball[a]]--;<br>                <span class="hljs-keyword">if</span>(color[ball[a]] == <span class="hljs-number">0</span>) cnt--;<br>                ball[a] = b;<br>                color[ball[a]]++;<br>                <span class="hljs-keyword">if</span>(color[ball[a]] == <span class="hljs-number">1</span>) cnt++;<br>            &#125;<br>            res.<span class="hljs-built_in">push_back</span>(cnt);<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-08-2349-Design-a-Number-Container-System"><a href="#2025-02-08-2349-Design-a-Number-Container-System" class="headerlink" title="2025&#x2F;02&#x2F;08 2349. Design a Number Container System"></a>2025&#x2F;02&#x2F;08 <a href="https://leetcode.com/problems/design-a-number-container-system/description/?envType=daily-question&envId=2025-02-08">2349. Design a Number Container System</a></h3><ul><li>因為 <code>1 &lt;= index, number &lt;= 109</code> ，需要開一個 hash map，負責記錄該 index 對應到的值，再開另一個 hash map，記錄 value 有哪些 index 指著。<ul><li>Time Complexity $O(n \lg(n))$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberContainers</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">NumberContainers</span>() &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">change</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">int</span> number)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(index_mp.<span class="hljs-built_in">find</span>(index) != index_mp.<span class="hljs-built_in">end</span>())&#123;<br>            value_map[index_mp[index]].<span class="hljs-built_in">erase</span>(index);<br>            value_map[number].<span class="hljs-built_in">erase</span>(index);<br>        &#125;<br>        index_mp[index] = number;<br>        value_map[number].<span class="hljs-built_in">insert</span>(index);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> number)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(value_map[number].<span class="hljs-built_in">empty</span>()) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        <span class="hljs-keyword">return</span> *value_map[number].<span class="hljs-built_in">begin</span>();<br>    &#125;<br>    unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; index_mp;<br>    unordered_map&lt;<span class="hljs-type">int</span>, set&lt;<span class="hljs-type">int</span>&gt;&gt; value_map;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your NumberContainers object will be instantiated and called as such:</span><br><span class="hljs-comment"> * NumberContainers* obj = new NumberContainers();</span><br><span class="hljs-comment"> * obj-&gt;change(index,number);</span><br><span class="hljs-comment"> * int param_2 = obj-&gt;find(number);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2025-02-09-2364-Count-Number-of-Bad-Pairs"><a href="#2025-02-09-2364-Count-Number-of-Bad-Pairs" class="headerlink" title="2025&#x2F;02&#x2F;09 2364. Count Number of Bad Pairs"></a>2025&#x2F;02&#x2F;09 <a href="https://leetcode.com/problems/count-number-of-bad-pairs/description/?envType=daily-question&envId=2025-02-09">2364. Count Number of Bad Pairs</a></h3><ul><li>用 hash map 記錄 index 和 value 的差值有幾個<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">countBadPairs</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> ret = <span class="hljs-number">0</span>;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;nums.<span class="hljs-built_in">size</span>(); i++)&#123;<br>            ret += i - mp[i - nums[i]];<br>            mp[i - nums[i]]++;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-10-3174-Clear-Digits"><a href="#2025-02-10-3174-Clear-Digits" class="headerlink" title="2025&#x2F;02&#x2F;10 3174. Clear Digits"></a>2025&#x2F;02&#x2F;10 <a href="https://leetcode.com/problems/clear-digits/description/?envType=daily-question&envId=2025-02-10">3174. Clear Digits</a></h3><ul><li>用 Stack 的方式記錄最後要回傳的值<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">string <span class="hljs-title">clearDigits</span><span class="hljs-params">(string s)</span> </span>&#123;<br>        string ret;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">char</span>&amp; c:s)&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isdigit</span>(c) &amp;&amp; ret.<span class="hljs-built_in">size</span>()) ret.<span class="hljs-built_in">pop_back</span>();<br>            <span class="hljs-keyword">else</span> ret.<span class="hljs-built_in">push_back</span>(c);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-11-1910-Remove-All-Occurrences-of-a-Substring"><a href="#2025-02-11-1910-Remove-All-Occurrences-of-a-Substring" class="headerlink" title="2025&#x2F;02&#x2F;11 1910. Remove All Occurrences of a Substring"></a>2025&#x2F;02&#x2F;11 <a href="https://leetcode.com/problems/remove-all-occurrences-of-a-substring/description/?envType=daily-question&envId=2025-02-11">1910. Remove All Occurrences of a Substring</a></h3><blockquote><p>快忘記 substr 和 find 怎麼用了</p></blockquote><ul><li>用 <code>string.substr()</code> 每次都往前檢查，找到就刪掉<ul><li>Time Complexity $O(n^2)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">string <span class="hljs-title">removeOccurrences</span><span class="hljs-params">(string s, string part)</span> </span>&#123;<br>        string ret;<br>        <span class="hljs-type">int</span> n = part.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">char</span>&amp; c:s)&#123;<br>            ret.<span class="hljs-built_in">push_back</span>(c);<br>            <span class="hljs-keyword">if</span>(ret.<span class="hljs-built_in">size</span>() &gt;= n &amp;&amp; ret.<span class="hljs-built_in">substr</span>(ret.<span class="hljs-built_in">size</span>() - n) == part)<br>                ret.<span class="hljs-built_in">erase</span>(ret.<span class="hljs-built_in">size</span>() - n, n);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>用 <code>string.find()</code> 來檢查，可以更簡短<ul><li>Time Complexity $O(n^2)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">string <span class="hljs-title">removeOccurrences</span><span class="hljs-params">(string s, string part)</span> </span>&#123;<br>        <span class="hljs-type">int</span> idx = s.<span class="hljs-built_in">find</span>(part);<br>        <span class="hljs-keyword">while</span>(idx != string::npos)&#123;<br>            s.<span class="hljs-built_in">erase</span>(idx, part.<span class="hljs-built_in">size</span>());<br>            idx = s.<span class="hljs-built_in">find</span>(part);<br>        &#125;<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-12-2342-Max-Sum-of-a-Pair-With-Equal-Sum-of-Digits"><a href="#2025-02-12-2342-Max-Sum-of-a-Pair-With-Equal-Sum-of-Digits" class="headerlink" title="2025&#x2F;02&#x2F;12 2342. Max Sum of a Pair With Equal Sum of Digits"></a>2025&#x2F;02&#x2F;12 <a href="https://leetcode.com/problems/max-sum-of-a-pair-with-equal-sum-of-digits/description/?envType=daily-question&envId=2025-02-12">2342. Max Sum of a Pair With Equal Sum of Digits</a></h3><ul><li>記錄曾經算出的最大值 <code>acc</code> 就好<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">maximumSum</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-type">int</span> res = <span class="hljs-number">-1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span>&amp; n:nums)&#123;<br>            <span class="hljs-type">int</span> acc = <span class="hljs-number">0</span>, n_cpy = n;<br>            <span class="hljs-keyword">while</span>(n_cpy)&#123;<br>                acc += n_cpy%<span class="hljs-number">10</span>;<br>                n_cpy /= <span class="hljs-number">10</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(mp.<span class="hljs-built_in">find</span>(acc) != mp.<span class="hljs-built_in">end</span>())<br>                res = <span class="hljs-built_in">max</span>(res, mp[acc] + n);<br>            mp[acc] = <span class="hljs-built_in">max</span>(mp[acc], n);<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-13-3066-Minimum-Operations-to-Exceed-Threshold-Value-II"><a href="#2025-02-13-3066-Minimum-Operations-to-Exceed-Threshold-Value-II" class="headerlink" title="2025&#x2F;02&#x2F;13 3066. Minimum Operations to Exceed Threshold Value II"></a>2025&#x2F;02&#x2F;13 <a href="https://leetcode.com/problems/minimum-operations-to-exceed-threshold-value-ii/description/?envType=daily-question&envId=2025-02-13">3066. Minimum Operations to Exceed Threshold Value II</a></h3><ul><li>用 <code>heap</code> 來記錄最小的值<ul><li>Time Complexity $O(n\lg{n})$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">minOperations</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> k)</span> </span>&#123;<br>        priority_queue&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>, vector&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt;, greater&lt;<span class="hljs-type">long</span> <span class="hljs-type">long</span>&gt;&gt; <span class="hljs-built_in">pq</span>(nums.<span class="hljs-built_in">begin</span>(), nums.<span class="hljs-built_in">end</span>());<br>        <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span>(!pq.<span class="hljs-built_in">empty</span>())&#123;<br>            <span class="hljs-type">long</span> <span class="hljs-type">long</span> a = pq.<span class="hljs-built_in">top</span>();<br>            pq.<span class="hljs-built_in">pop</span>();<br>            <span class="hljs-keyword">if</span>(a &gt;= k) <span class="hljs-keyword">break</span>;<br>            <span class="hljs-type">long</span> <span class="hljs-type">long</span> b = pq.<span class="hljs-built_in">top</span>();<br>            pq.<span class="hljs-built_in">pop</span>();<br>            pq.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">min</span>(a, b) * <span class="hljs-number">2</span> + <span class="hljs-built_in">max</span>(a, b));<br>            ret++;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-14-1352-Product-of-the-Last-K-Numbers"><a href="#2025-02-14-1352-Product-of-the-Last-K-Numbers" class="headerlink" title="2025&#x2F;02&#x2F;14 1352. Product of the Last K Numbers"></a>2025&#x2F;02&#x2F;14 <a href="https://leetcode.com/problems/product-of-the-last-k-numbers/description/?envType=daily-question&envId=2025-02-14">1352. Product of the Last K Numbers</a></h3><ul><li>儲存最後是 0 的 idx，在 <code>getProduct</code> 的時候才不會除以 <code>0</code>。另外我原本是把 <code> v.size()</code> 直接寫在 <code>if</code> 裡面，後來發現 <code>v.size()</code> 是 <code>unsigned</code> 的型態，算出負數會發生 <code>runtime error</code>。<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductOfNumbers</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">ProductOfNumbers</span>() &#123; &#125;<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(num == <span class="hljs-number">0</span>)&#123;<br>            v.<span class="hljs-built_in">clear</span>();<br>            v.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">1</span>);<br>            lastIdx = v.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            v.<span class="hljs-built_in">push_back</span>(v.<span class="hljs-built_in">back</span>() * num);<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getProduct</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span> </span>&#123;<br>        <span class="hljs-type">int</span> sz = v.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-keyword">if</span>(sz - <span class="hljs-number">1</span> - k &lt; lastIdx) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> v.<span class="hljs-built_in">back</span>() / v[sz - <span class="hljs-number">1</span> - k];<br>    &#125;<br>    vector&lt;<span class="hljs-type">int</span>&gt; v&#123;<span class="hljs-number">1</span>&#125;;<br>    <span class="hljs-type">int</span> lastIdx = <span class="hljs-number">0</span>;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your ProductOfNumbers object will be instantiated and called as such:</span><br><span class="hljs-comment"> * ProductOfNumbers* obj = new ProductOfNumbers();</span><br><span class="hljs-comment"> * obj-&gt;add(num);</span><br><span class="hljs-comment"> * int param_2 = obj-&gt;getProduct(k);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2025-02-15-2698-Find-the-Punishment-Number-of-an-Integer"><a href="#2025-02-15-2698-Find-the-Punishment-Number-of-an-Integer" class="headerlink" title="2025&#x2F;02&#x2F;15 2698. Find the Punishment Number of an Integer"></a>2025&#x2F;02&#x2F;15 <a href="https://leetcode.com/problems/find-the-punishment-number-of-an-integer/description/?envType=daily-question&envId=2025-02-15">2698. Find the Punishment Number of an Integer</a></h3><p>暴力 DFS + 剪枝</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> cur, <span class="hljs-type">int</span> n, <span class="hljs-type">int</span> sum)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(cur == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> sum == n;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">10</span>; i &lt;= <span class="hljs-number">1000000</span>; i *= <span class="hljs-number">10</span>)&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dfs</span>(cur / i, n, sum + cur % i))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">punishmentNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>        <span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dfs</span>(i * i, i, <span class="hljs-number">0</span>))<br>                res += i * i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-16-1718-Construct-the-Lexicographically-Largest-Valid-Sequence"><a href="#2025-02-16-1718-Construct-the-Lexicographically-Largest-Valid-Sequence" class="headerlink" title="2025&#x2F;02&#x2F;16 1718. Construct the Lexicographically Largest Valid Sequence"></a>2025&#x2F;02&#x2F;16 <a href="https://leetcode.com/problems/construct-the-lexicographically-largest-valid-sequence/description/?envType=daily-question&envId=2025-02-16">1718. Construct the Lexicographically Largest Valid Sequence</a></h3><p>暴力 DFS + 剪枝，每次放 2~n 的數字進 <code>vector</code> 時，可以一起更新 <code>idx + i</code> 的值，因為也只能放那邊</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    vector&lt;<span class="hljs-type">int</span>&gt; v, used;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> idx)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(v.<span class="hljs-built_in">size</span>() == idx)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span>(v[idx] != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">dfs</span>(n, idx+<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=n; i&gt;=<span class="hljs-number">1</span>; i--)&#123;<br>            <span class="hljs-keyword">if</span>(!used[i])&#123;<br>                used[i] = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">if</span>(i == <span class="hljs-number">1</span>)&#123;<br>                    v[idx] = <span class="hljs-number">1</span>;<br>                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dfs</span>(n, idx+<span class="hljs-number">1</span>))<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                    v[idx] = <span class="hljs-number">0</span>;<br>                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(idx + i &lt; v.<span class="hljs-built_in">size</span>() &amp;&amp; v[idx + i] == <span class="hljs-number">0</span>)&#123;<br>                    v[idx] = v[idx + i] = i;<br>                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dfs</span>(n, idx+<span class="hljs-number">1</span>))<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                    v[idx] = v[idx + i] = <span class="hljs-number">0</span>;<br>                &#125;<br>                used[i] = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">constructDistancedSequence</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>        used.<span class="hljs-built_in">resize</span>(n+<span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);<br>        v.<span class="hljs-built_in">resize</span>(n*<span class="hljs-number">2</span><span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">dfs</span>(n, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> v;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-17-1079-Letter-Tile-Possibilities"><a href="#2025-02-17-1079-Letter-Tile-Possibilities" class="headerlink" title="2025&#x2F;02&#x2F;17 1079. Letter Tile Possibilities"></a>2025&#x2F;02&#x2F;17 <a href="https://leetcode.com/problems/letter-tile-possibilities/description/?envType=daily-question&envId=2025-02-17">1079. Letter Tile Possibilities</a></h3><p>DFS，要加個 <code>seen</code> 確保不要在同個地方看同個字母，還有每次準備跑下個 <code>dfs()</code> 之前答案都要 <code>+1</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">int</span> used[<span class="hljs-number">8</span>] = &#123;&#125;;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">dfs</span><span class="hljs-params">(string&amp; s, <span class="hljs-type">int</span> cnt)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(cnt == s.<span class="hljs-built_in">size</span>()) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> seen[<span class="hljs-number">26</span>] = &#123;&#125;;<br>        <span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;s.<span class="hljs-built_in">size</span>(); i++)&#123;<br>            <span class="hljs-keyword">if</span>(!used[i] &amp;&amp; !seen[s[i] - <span class="hljs-string">&#x27;A&#x27;</span>])&#123;<br>                used[i] = <span class="hljs-number">1</span>;<br>                seen[s[i] - <span class="hljs-string">&#x27;A&#x27;</span>] = <span class="hljs-number">1</span>;<br>                res += <span class="hljs-number">1</span> + <span class="hljs-built_in">dfs</span>(s, cnt + <span class="hljs-number">1</span>);<br>                used[i] = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">numTilePossibilities</span><span class="hljs-params">(string tiles)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dfs</span>(tiles, <span class="hljs-number">0</span>);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-18-2375-Construct-Smallest-Number-From-DI-String"><a href="#2025-02-18-2375-Construct-Smallest-Number-From-DI-String" class="headerlink" title="2025&#x2F;02&#x2F;18 2375. Construct Smallest Number From DI String"></a>2025&#x2F;02&#x2F;18 <a href="https://leetcode.com/problems/construct-smallest-number-from-di-string/description/?envType=daily-question&envId=2025-02-18">2375. Construct Smallest Number From DI String</a></h3><p>DFS，跟前一天差不多</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    string res;<br>    <span class="hljs-type">int</span> used[<span class="hljs-number">10</span>] = &#123;&#125;;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">dfs</span><span class="hljs-params">(string&amp; pattern, <span class="hljs-type">int</span> cnt)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(cnt == pattern.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;=pattern.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span>; i++)&#123;<br>            <span class="hljs-keyword">if</span>(!used[i])&#123;<br>                <span class="hljs-keyword">if</span>(cnt &gt;= <span class="hljs-number">1</span> &amp;&amp; pattern[cnt<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;I&#x27;</span> &amp;&amp; (res.<span class="hljs-built_in">back</span>() - <span class="hljs-string">&#x27;0&#x27;</span>) &gt;= i) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span>(cnt &gt;= <span class="hljs-number">1</span> &amp;&amp; pattern[cnt<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;D&#x27;</span> &amp;&amp; (res.<span class="hljs-built_in">back</span>() - <span class="hljs-string">&#x27;0&#x27;</span>) &lt;= i) <span class="hljs-keyword">continue</span>;<br>                used[i] = <span class="hljs-number">1</span>;<br>                res.<span class="hljs-built_in">push_back</span>(i + <span class="hljs-string">&#x27;0&#x27;</span>);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dfs</span>(pattern, cnt + <span class="hljs-number">1</span>))<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                res.<span class="hljs-built_in">pop_back</span>();<br>                used[i] = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function">string <span class="hljs-title">smallestNumber</span><span class="hljs-params">(string pattern)</span> </span>&#123;<br>        <span class="hljs-built_in">dfs</span>(pattern, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-19-1415-The-k-th-Lexicographical-String-of-All-Happy-Strings-of-Length-n"><a href="#2025-02-19-1415-The-k-th-Lexicographical-String-of-All-Happy-Strings-of-Length-n" class="headerlink" title="2025&#x2F;02&#x2F;19 1415. The k-th Lexicographical String of All Happy Strings of Length n"></a>2025&#x2F;02&#x2F;19 <a href="https://leetcode.com/problems/the-k-th-lexicographical-string-of-all-happy-strings-of-length-n/description/?envType=daily-question&envId=2025-02-19">1415. The k-th Lexicographical String of All Happy Strings of Length n</a></h3><p>DFS，確保不要重複，且在找到第 k 個時就可以直接 return</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    string str = <span class="hljs-string">&quot;abc&quot;</span>;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; n, <span class="hljs-type">int</span>&amp; k, <span class="hljs-type">int</span>&amp; k_cnt, string&amp; ret)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(ret.<span class="hljs-built_in">size</span>() == n)&#123;<br>            k_cnt++;<br>            <span class="hljs-keyword">return</span> k_cnt == k;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">char</span>&amp; c:str)&#123;<br>            <span class="hljs-keyword">if</span>(!ret.<span class="hljs-built_in">empty</span>() &amp;&amp; ret.<span class="hljs-built_in">back</span>() == c) <span class="hljs-keyword">continue</span>;<br>            ret.<span class="hljs-built_in">push_back</span>(c);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dfs</span>(n, k, k_cnt, ret))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            ret.<span class="hljs-built_in">pop_back</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-function">string <span class="hljs-title">getHappyString</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> </span>&#123;<br>        string ret;<br>        <span class="hljs-type">int</span> k_cnt = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">dfs</span>(n, k, k_cnt, ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-20-1980-Find-Unique-Binary-String"><a href="#2025-02-20-1980-Find-Unique-Binary-String" class="headerlink" title="2025&#x2F;02&#x2F;20 1980. Find Unique Binary String"></a>2025&#x2F;02&#x2F;20 <a href="https://leetcode.com/problems/find-unique-binary-string/description/?envType=daily-question&envId=2025-02-20">1980. Find Unique Binary String</a></h3><p><code>n</code> 最大到 16，應該也可以窮舉。這裡是直接讓每個 <code>num</code> 在不同位置至少有一個不同的位元，就能確保不會有重複的字串。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">string <span class="hljs-title">findDifferentBinaryString</span><span class="hljs-params">(vector&lt;string&gt;&amp; nums)</span> </span>&#123;<br>        string res;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nums.<span class="hljs-built_in">size</span>(); i++) &#123;<br>            <span class="hljs-keyword">if</span> (nums[i][i] == <span class="hljs-string">&#x27;0&#x27;</span>)<br>                res.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br>            <span class="hljs-keyword">else</span><br>                res.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">&#x27;0&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;;<br><br></code></pre></td></tr></table></figure><h3 id="2025-02-21-1261-Find-Elements-in-a-Contaminated-Binary-Tree"><a href="#2025-02-21-1261-Find-Elements-in-a-Contaminated-Binary-Tree" class="headerlink" title="2025&#x2F;02&#x2F;21 1261. Find Elements in a Contaminated Binary Tree"></a>2025&#x2F;02&#x2F;21 <a href="https://leetcode.com/problems/find-elements-in-a-contaminated-binary-tree/description/?envType=daily-question&envId=2025-02-21">1261. Find Elements in a Contaminated Binary Tree</a></h3><p>好像有沒有 recover 都沒差，只要把所有的值都存起來就好(X</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * struct TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode *left;</span><br><span class="hljs-comment"> *     TreeNode *right;</span><br><span class="hljs-comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span><br><span class="hljs-comment"> * &#125;;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FindElements</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    unordered_set&lt;<span class="hljs-type">int</span>&gt; st;<br>    <span class="hljs-built_in">FindElements</span>(TreeNode* root) &#123;<br>        <span class="hljs-built_in">recover</span>(root, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">recover</span><span class="hljs-params">(TreeNode* node, <span class="hljs-type">int</span> new_val)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(node == <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;<br>        st.<span class="hljs-built_in">insert</span>(new_val);<br>        <span class="hljs-built_in">recover</span>(node-&gt;left, new_val * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">recover</span>(node-&gt;right, new_val * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> target)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> st.<span class="hljs-built_in">find</span>(target) != st.<span class="hljs-built_in">end</span>();<br>    &#125;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your FindElements object will be instantiated and called as such:</span><br><span class="hljs-comment"> * FindElements* obj = new FindElements(root);</span><br><span class="hljs-comment"> * bool param_1 = obj-&gt;find(target);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="2025-02-22-1028-Recover-a-Tree-From-Preorder-Traversal"><a href="#2025-02-22-1028-Recover-a-Tree-From-Preorder-Traversal" class="headerlink" title="2025&#x2F;02&#x2F;22 1028. Recover a Tree From Preorder Traversal"></a>2025&#x2F;02&#x2F;22 <a href="https://leetcode.com/problems/recover-a-tree-from-preorder-traversal/description/?envType=daily-question&envId=2025-02-22">1028. Recover a Tree From Preorder Traversal</a></h3><p>題目給的 input 是 <code>DFS preorder</code> 的結果，所以可以用 stack 還原回去。每次都要檢查 <code>depth</code> 的值 (就是 dash 的數量) 直到深度差一層為止，那就是 parent。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * struct TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode *left;</span><br><span class="hljs-comment"> *     TreeNode *right;</span><br><span class="hljs-comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span><br><span class="hljs-comment"> * &#125;;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">TreeNode* <span class="hljs-title">recoverFromPreorder</span><span class="hljs-params">(string traversal)</span> </span>&#123;<br>        stack&lt;TreeNode*&gt; stk;<br>        stack&lt;<span class="hljs-type">int</span>&gt; depth_stk;<br>        TreeNode* head = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(<span class="hljs-number">0</span>);<br>        stk.<span class="hljs-built_in">push</span>(head);<br>        depth_stk.<span class="hljs-built_in">push</span>(<span class="hljs-number">-1</span>);<br>        <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">while</span>(i &lt; traversal.<span class="hljs-built_in">size</span>())&#123;<br>            <span class="hljs-type">int</span> num_dashes = <span class="hljs-number">0</span>, j = i, cur_num = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">while</span>(j &lt; traversal.<span class="hljs-built_in">size</span>() &amp;&amp; traversal[j] == <span class="hljs-string">&#x27;-&#x27;</span>)&#123;<br>                num_dashes++;<br>                j++;<br>            &#125;<br><br>            <span class="hljs-keyword">while</span>(j &lt; traversal.<span class="hljs-built_in">size</span>() &amp;&amp; traversal[j] != <span class="hljs-string">&#x27;-&#x27;</span>)&#123;<br>                cur_num = (cur_num * <span class="hljs-number">10</span>) + (traversal[j] - <span class="hljs-string">&#x27;0&#x27;</span>);<br>                j++;<br>            &#125;<br><br>            <span class="hljs-keyword">while</span>(depth_stk.<span class="hljs-built_in">top</span>() + <span class="hljs-number">1</span> != num_dashes)&#123;<br>                depth_stk.<span class="hljs-built_in">pop</span>();<br>                stk.<span class="hljs-built_in">pop</span>();<br>            &#125;<br><br>            TreeNode* parent = stk.<span class="hljs-built_in">top</span>();<br>            TreeNode* newNode = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(cur_num);<br>            <span class="hljs-keyword">if</span>(parent-&gt;left == <span class="hljs-literal">nullptr</span>)<br>                parent-&gt;left = newNode;<br>            <span class="hljs-keyword">else</span><br>                parent-&gt;right = newNode;<br><br>            stk.<span class="hljs-built_in">push</span>(newNode);<br>            depth_stk.<span class="hljs-built_in">push</span>(num_dashes);<br>            i = j;<br>        &#125;<br>        <span class="hljs-keyword">return</span> head-&gt;left;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-23-889-Construct-Binary-Tree-from-Preorder-and-Postorder-Traversal"><a href="#2025-02-23-889-Construct-Binary-Tree-from-Preorder-and-Postorder-Traversal" class="headerlink" title="2025&#x2F;02&#x2F;23 889. Construct Binary Tree from Preorder and Postorder Traversal"></a>2025&#x2F;02&#x2F;23 <a href="https://leetcode.com/problems/construct-binary-tree-from-preorder-and-postorder-traversal/description/?envType=daily-question&envId=2025-02-23">889. Construct Binary Tree from Preorder and Postorder Traversal</a></h3><p>從 <code>preorder</code> 開始遍歷，每個值都去 <code>postorder</code> 的位置往右找，第一個已經用過的就是 parent node</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * struct TreeNode &#123;</span><br><span class="hljs-comment"> *     int val;</span><br><span class="hljs-comment"> *     TreeNode *left;</span><br><span class="hljs-comment"> *     TreeNode *right;</span><br><span class="hljs-comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span><br><span class="hljs-comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span><br><span class="hljs-comment"> * &#125;;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">TreeNode* <span class="hljs-title">constructFromPrePost</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; preorder, vector&lt;<span class="hljs-type">int</span>&gt;&amp; postorder)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = preorder.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-function">vector&lt;TreeNode*&gt; <span class="hljs-title">used</span><span class="hljs-params">(n, <span class="hljs-literal">nullptr</span>)</span></span>;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; idx_mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++) idx_mp[postorder[i]] = i;<br><br>        TreeNode* head = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(preorder[<span class="hljs-number">0</span>]);<br>        used.<span class="hljs-built_in">back</span>() = head;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-type">int</span> cur_val = preorder[i];<br>            <span class="hljs-type">int</span> cur_idx = idx_mp[cur_val];<br>            TreeNode* newVal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TreeNode</span>(cur_val);<br>            used[cur_idx] = newVal;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=cur_idx+<span class="hljs-number">1</span>; j&lt;n; j++)&#123;<br>                <span class="hljs-keyword">if</span>(used[j] != <span class="hljs-literal">nullptr</span>)&#123;<br>                    <span class="hljs-keyword">if</span>(used[j]-&gt;left == <span class="hljs-literal">nullptr</span>)<br>                        used[j]-&gt;left = newVal;<br>                    <span class="hljs-keyword">else</span><br>                        used[j]-&gt;right = newVal;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> head;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-02-25-1524-Number-of-Sub-arrays-With-Odd-Sum"><a href="#2025-02-25-1524-Number-of-Sub-arrays-With-Odd-Sum" class="headerlink" title="2025&#x2F;02&#x2F;25 1524. Number of Sub-arrays With Odd Sum"></a>2025&#x2F;02&#x2F;25 <a href="https://leetcode.com/problems/number-of-sub-arrays-with-odd-sum/description/?envType=daily-question&envId=2025-02-25">1524. Number of Sub-arrays With Odd Sum</a></h3><p>記錄當前全部的總和、prefix sum 的奇數和偶數個數。如果當前的總和是偶數，代表它扣掉前面 prefix sum 的奇數個數就是 <code>包含當前數字的 subarray sum 為奇數的個數</code>，反之，如果當前的總和是奇數，代表它扣掉前面 prefix sum 的偶數個數就是 <code>包含當前數字的 subarray sum 為奇數的個數</code>，但是要加上 <code>1</code>，因為自己本身也是一個 subarray。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">numOfSubarrays</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; arr)</span> </span>&#123;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> cur_sum = <span class="hljs-number">0</span>, odd = <span class="hljs-number">0</span>, even = <span class="hljs-number">0</span>, res = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span>&amp; i:arr)&#123;<br>            cur_sum += i;<br>            <span class="hljs-keyword">if</span>(cur_sum &amp; <span class="hljs-number">1</span>)&#123;<br>                res += <span class="hljs-number">1</span> + even;<br>                odd++;<br>            &#125; <span class="hljs-keyword">else</span>&#123;<br>                res += odd;<br>                even++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> res % <span class="hljs-number">1000000007</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-03-01-2460-Apply-Operations-to-an-Array"><a href="#2025-03-01-2460-Apply-Operations-to-an-Array" class="headerlink" title="2025&#x2F;03&#x2F;01 2460. Apply Operations to an Array"></a>2025&#x2F;03&#x2F;01 <a href="https://leetcode.com/problems/apply-operations-to-an-array/description/?envType=daily-question&envId=2025-03-01">2460. Apply Operations to an Array</a></h3><p>可以在初始化的時候就先塞好一堆 0，<code>vector&lt;int&gt; ret(n, 0);</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">applyOperations</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>(), cnt = <span class="hljs-number">0</span>;<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ret</span><span class="hljs-params">(n, <span class="hljs-number">0</span>)</span></span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n<span class="hljs-number">-1</span>; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] == nums[i+<span class="hljs-number">1</span>])&#123;<br>                nums[i] *= <span class="hljs-number">2</span>;<br>                nums[i+<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>, j=<span class="hljs-number">0</span>; i&lt;n; i++)<br>            <span class="hljs-keyword">if</span>(nums[i] != <span class="hljs-number">0</span>)<br>                ret[j++] = nums[i];<br><br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-03-02-2570-Merge-Two-2D-Arrays-by-Summing-Values"><a href="#2025-03-02-2570-Merge-Two-2D-Arrays-by-Summing-Values" class="headerlink" title="2025&#x2F;03&#x2F;02 2570. Merge Two 2D Arrays by Summing Values"></a>2025&#x2F;03&#x2F;02 <a href="https://leetcode.com/problems/merge-two-2d-arrays-by-summing-values/description/?envType=daily-question&envId=2025-03-02">2570. Merge Two 2D Arrays by Summing Values</a></h3><p>直接用 hash 存起來</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; <span class="hljs-built_in">mergeArrays</span>(vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; nums1, vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; nums2) &#123;<br>        map &lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:nums1) mp[i[<span class="hljs-number">0</span>]] = i[<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:nums2)&#123;<br>            <span class="hljs-keyword">if</span>(mp.<span class="hljs-built_in">find</span>(i[<span class="hljs-number">0</span>]) != mp.<span class="hljs-built_in">end</span>())<br>                mp[i[<span class="hljs-number">0</span>]] += i[<span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">else</span><br>                mp[i[<span class="hljs-number">0</span>]] = i[<span class="hljs-number">1</span>];<br>        &#125;<br>        vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; ret;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:mp)<br>            ret.<span class="hljs-built_in">push_back</span>(&#123;i.first, i.second&#125;);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>因為兩個 vector 都是根據 id sorted，所以可以直接用 <code>two pointer</code> 的方式來做</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; <span class="hljs-built_in">mergeArrays</span>(vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; nums1, vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; nums2) &#123;<br>        <span class="hljs-type">int</span> n = nums1.<span class="hljs-built_in">size</span>(), m = nums2.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-type">int</span> idx1 = <span class="hljs-number">0</span>, idx2 = <span class="hljs-number">0</span>;<br>        vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; ret;<br>        <span class="hljs-keyword">while</span>(idx1 &lt; n || idx2 &lt; m)&#123;<br>            <span class="hljs-keyword">if</span>(idx1 &lt; n &amp;&amp; idx2 &lt; m)&#123;<br>                <span class="hljs-keyword">if</span>(nums1[idx1][<span class="hljs-number">0</span>] &lt; nums2[idx2][<span class="hljs-number">0</span>])&#123;<br>                    ret.<span class="hljs-built_in">push_back</span>(nums1[idx1]);<br>                    idx1++;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums1[idx1][<span class="hljs-number">0</span>] &gt; nums2[idx2][<span class="hljs-number">0</span>])&#123;<br>                    ret.<span class="hljs-built_in">push_back</span>(nums2[idx2]);<br>                    idx2++;<br>                &#125; <span class="hljs-keyword">else</span>&#123;<br>                    ret.<span class="hljs-built_in">push_back</span>(&#123;nums1[idx1][<span class="hljs-number">0</span>], nums1[idx1][<span class="hljs-number">1</span>] + nums2[idx2][<span class="hljs-number">1</span>]&#125;);<br>                    idx1++; idx2++;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(idx1 &lt; n)&#123;<br>                ret.<span class="hljs-built_in">push_back</span>(nums1[idx1]);<br>                idx1++;<br>            &#125; <span class="hljs-keyword">else</span>&#123;<br>                ret.<span class="hljs-built_in">push_back</span>(nums2[idx2]);<br>                idx2++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-03-03-2161-Partition-Array-According-to-Given-Pivot"><a href="#2025-03-03-2161-Partition-Array-According-to-Given-Pivot" class="headerlink" title="2025&#x2F;03&#x2F;03 2161. Partition Array According to Given Pivot"></a>2025&#x2F;03&#x2F;03 <a href="https://leetcode.com/problems/partition-array-according-to-given-pivot/description/?envType=daily-question&envId=2025-03-03">2161. Partition Array According to Given Pivot</a></h3><p>用兩個 index 來記錄小於 pivot 和大於 pivot 的位置，最後再把剩下的補上</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">pivotArray</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> pivot)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">ret</span><span class="hljs-params">(n)</span></span>;<br>        <span class="hljs-type">int</span> cnt1 = <span class="hljs-number">0</span>, cnt2 = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &lt; pivot) cnt1++;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums[i] &gt; pivot) cnt2++;<br>        &#125;<br>        <span class="hljs-type">int</span> idx1 = <span class="hljs-number">0</span>, idx2 = n - cnt2;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=cnt1; i&lt;idx2; i++) ret[i] = pivot;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(nums[i] &lt; pivot) ret[idx1++] = nums[i];<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums[i] &gt; pivot) ret[idx2++] = nums[i];<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-03-04-1780-Check-if-Number-is-a-Sum-of-Powers-of-Three"><a href="#2025-03-04-1780-Check-if-Number-is-a-Sum-of-Powers-of-Three" class="headerlink" title="2025&#x2F;03&#x2F;04 1780. Check if Number is a Sum of Powers of Three"></a>2025&#x2F;03&#x2F;04 <a href="https://leetcode.com/problems/check-if-number-is-a-sum-of-powers-of-three/description/?envType=daily-question&envId=2025-03-04">1780. Check if Number is a Sum of Powers of Three</a></h3><p>最直覺的方法是直接 DFS 爆開，因為 <code>n</code> 最大只到 <code>10^7</code>，最多只會到 $3^15$</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    vector&lt;<span class="hljs-type">int</span>&gt; tmp&#123;<span class="hljs-number">1</span>&#125;;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">int</span> cur)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(cur &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span>(cur == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dfs</span>(idx+<span class="hljs-number">1</span>, cur-tmp[idx]) || <span class="hljs-built_in">dfs</span>(idx+<span class="hljs-number">1</span>, cur);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">checkPowersOfThree</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">15</span>; i++)<br>            tmp.<span class="hljs-built_in">push_back</span>(tmp.<span class="hljs-built_in">back</span>() * <span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dfs</span>(<span class="hljs-number">0</span>, n);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>討論區看到一個很猛的方法，直接把 <code>n</code> 看成 3 進位，每次檢查 LSB，如果有出現 <code>2</code> 就代表不是由 <code>3^x</code> 組成的</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">checkPowersOfThree</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">while</span>(n &gt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">if</span>(n % <span class="hljs-number">3</span> == <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            n /= <span class="hljs-number">3</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-03-05-2579-Count-Total-Number-of-Colored-Cells"><a href="#2025-03-05-2579-Count-Total-Number-of-Colored-Cells" class="headerlink" title="2025&#x2F;03&#x2F;05 2579. Count Total Number of Colored Cells"></a>2025&#x2F;03&#x2F;05 <a href="https://leetcode.com/problems/count-total-number-of-colored-cells/description/?envType=daily-question&envId=2025-03-05">2579. Count Total Number of Colored Cells</a></h3><p>直接算兩個三角形去掉重疊的部分</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">coloredCells</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)<span class="hljs-number">2</span>*n*n-(<span class="hljs-number">2</span>*n<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>也可以用遞迴</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">coloredCells</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(n == <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">return</span> (n<span class="hljs-number">-2</span>) * <span class="hljs-number">4</span> + <span class="hljs-number">4</span> + <span class="hljs-built_in">coloredCells</span>(n<span class="hljs-number">-1</span>);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2025-03-06-2965-Find-Missing-and-Repeated-Values"><a href="#2025-03-06-2965-Find-Missing-and-Repeated-Values" class="headerlink" title="2025&#x2F;03&#x2F;06 2965. Find Missing and Repeated Values"></a>2025&#x2F;03&#x2F;06 <a href="https://leetcode.com/problems/find-missing-and-repeated-values/description/?envType=daily-question&envId=2025-03-06">2965. Find Missing and Repeated Values</a></h3><p>略</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">findMissingAndRepeatedValues</span><span class="hljs-params">(vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; grid)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = grid.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">rec</span><span class="hljs-params">(n * n + <span class="hljs-number">1</span>)</span>, <span class="hljs-title">ans</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; v:grid)&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:v)<br>                rec[i]++;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;=n*n; i++)&#123;<br>            <span class="hljs-keyword">if</span>(rec[i] == <span class="hljs-number">0</span>) ans[<span class="hljs-number">1</span>] = i;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rec[i] == <span class="hljs-number">2</span>) ans[<span class="hljs-number">0</span>] = i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ans;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>不知道這會持續幾天的 leetcode</title>
    <link href="/notes/2025/01/31/leetcode/"/>
    <url>/notes/2025/01/31/leetcode/</url>
    
    <content type="html"><![CDATA[<h2 id="Arrays-Hashing"><a href="#Arrays-Hashing" class="headerlink" title="Arrays &amp; Hashing"></a>Arrays &amp; Hashing</h2><h3 id="217-Contains-Duplicate"><a href="#217-Contains-Duplicate" class="headerlink" title="217. Contains Duplicate"></a><a href="https://leetcode.com/problems/contains-duplicate/description/">217. Contains Duplicate</a></h3><ol><li>Hash map<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">containsDuplicate</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span>&amp; i:nums)&#123;<br>            <span class="hljs-keyword">if</span>(mp.<span class="hljs-built_in">count</span>(i) != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            mp[i]++;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>更簡短的寫法</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">containsDuplicate</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-function">unordered_set&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">st</span><span class="hljs-params">(nums.begin(), nums.end())</span></span>;<br>        <span class="hljs-keyword">return</span> st.<span class="hljs-built_in">size</span>() &lt; nums.<span class="hljs-built_in">size</span>();<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="242-Valid-Anagram"><a href="#242-Valid-Anagram" class="headerlink" title="242. Valid Anagram"></a><a href="https://leetcode.com/problems/valid-anagram/description/">242. Valid Anagram</a></h3><ul><li>算出兩者 a ~ z 的數量存到不同 vector，最後直接比較兩個 vector 是否一樣 (其實就 Hash map)<ul><li>Time Complexity $O(n + m)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isAnagram</span><span class="hljs-params">(string s, string t)</span> </span>&#123;<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">s_cnt</span><span class="hljs-params">(<span class="hljs-number">26</span>)</span>, <span class="hljs-title">t_cnt</span><span class="hljs-params">(<span class="hljs-number">26</span>)</span></span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">char</span>&amp; c:s) s_cnt[c - <span class="hljs-string">&#x27;a&#x27;</span>]++;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">char</span>&amp; c:t) t_cnt[c - <span class="hljs-string">&#x27;a&#x27;</span>]++;<br>        <span class="hljs-keyword">return</span> s_cnt == t_cnt;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="1-Two-Sum"><a href="#1-Two-Sum" class="headerlink" title="1. Two Sum"></a><a href="https://leetcode.com/problems/two-sum/description/">1. Two Sum</a></h3><ol><li>Hash map<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">twoSum</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> target)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;nums.<span class="hljs-built_in">size</span>(); i++)&#123;<br>            <span class="hljs-type">int</span> k = target - nums[i];<br>            <span class="hljs-keyword">if</span>(mp.<span class="hljs-built_in">count</span>(k))<br>                <span class="hljs-keyword">return</span> vector&lt;<span class="hljs-type">int</span>&gt;&#123;i, mp[k]&#125;;<br>            mp[nums[i]] = i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>更簡短的寫法<ul><li><code>vector&lt;int&gt;</code> 可以省略耶 (wow</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">twoSum</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> target)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;nums.<span class="hljs-built_in">size</span>(); i++)&#123;<br>            <span class="hljs-type">int</span> k = target - nums[i];<br>            <span class="hljs-keyword">if</span>(mp.<span class="hljs-built_in">count</span>(k))<br>                <span class="hljs-keyword">return</span> &#123;i, mp[k]&#125;;<br>            mp[nums[i]] = i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> &#123;&#125;;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="49-Group-Anagrams"><a href="#49-Group-Anagrams" class="headerlink" title="49. Group Anagrams"></a><a href="https://leetcode.com/problems/group-anagrams/description/">49. Group Anagrams</a></h3><ul><li>計算每個 string a ~ z 的數量，比較先前存的結果，沒有匹配的話就塞到新的 vector (超慢<ul><li>Time Complexity $O(n * m)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    vector&lt;vector&lt;string&gt;&gt; <span class="hljs-built_in">groupAnagrams</span>(vector&lt;string&gt;&amp; strs) &#123;<br>        vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; str_cnt;<br>        vector&lt;vector&lt;string&gt;&gt; ret;<br>        <span class="hljs-keyword">for</span>(string&amp; s:strs)&#123;<br>            <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">tmp_cnt</span><span class="hljs-params">(<span class="hljs-number">26</span>)</span></span>;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">char</span>&amp; c:s) tmp_cnt[c - <span class="hljs-string">&#x27;a&#x27;</span>]++;<br>            <span class="hljs-type">bool</span> v_same = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;str_cnt.<span class="hljs-built_in">size</span>(); i++)&#123;<br>                <span class="hljs-keyword">if</span>(str_cnt[i] == tmp_cnt)&#123;<br>                    ret[i].<span class="hljs-built_in">push_back</span>(s);<br>                    v_same = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(!v_same)&#123;<br>                str_cnt.<span class="hljs-built_in">push_back</span>(tmp_cnt);<br>                ret.<span class="hljs-built_in">push_back</span>(&#123;s&#125;);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>用 hash map，把 sort 過的 string 當作 key<ul><li>Time Complexity $O(n * \mlg(m))$</li><li>Space Complexity $O(n * m)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    vector&lt;vector&lt;string&gt;&gt; <span class="hljs-built_in">groupAnagrams</span>(vector&lt;string&gt;&amp; strs) &#123;<br>        vector&lt;vector&lt;string&gt;&gt; ret;<br>        unordered_map&lt;string, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(string s:strs)&#123;<br>            string sorted_s = s;<br>            <span class="hljs-built_in">sort</span>(sorted_s.<span class="hljs-built_in">begin</span>(), sorted_s.<span class="hljs-built_in">end</span>());<br>            <span class="hljs-keyword">if</span>(mp.<span class="hljs-built_in">count</span>(sorted_s))<br>                ret[mp[sorted_s]].<span class="hljs-built_in">push_back</span>(s);<br>            <span class="hljs-keyword">else</span>&#123;<br>                mp[sorted_s] = ret.<span class="hljs-built_in">size</span>();<br>                ret.<span class="hljs-built_in">push_back</span>(&#123;s&#125;);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="347-Top-K-Frequent-Elements"><a href="#347-Top-K-Frequent-Elements" class="headerlink" title="347. Top K Frequent Elements"></a><a href="https://leetcode.com/problems/top-k-frequent-elements/description/">347. Top K Frequent Elements</a></h3><ol><li>先存進 map ，再遍歷 map 的值，丟進 priority queue 裡面取出前 k 個 (快忘光 cmp 的語法了 qq，也可以直接用 greater<ul><li>Time Complexity $O(n\lg{n})$</li><li>Space Complexity $O(n)$</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">topKFrequent</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> k)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span>&amp; i:nums) mp[i]++;<br><br>        <span class="hljs-keyword">auto</span> cmp = [](pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&amp; a, pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&amp; b) &#123;<br>            <span class="hljs-keyword">return</span> a.second &lt; b.second;<br>        &#125;;<br>        priority_queue&lt;pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;, vector&lt;pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&gt;, <span class="hljs-keyword">decltype</span>(cmp)&gt; pq;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:mp)<br>            pq.<span class="hljs-built_in">push</span>(i);<br><br>        vector&lt;<span class="hljs-type">int</span>&gt; ret;<br>        <span class="hljs-keyword">while</span>(k--)&#123;<br>            ret.<span class="hljs-built_in">push_back</span>(pq.<span class="hljs-built_in">top</span>().first);<br>            pq.<span class="hljs-built_in">pop</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>heap 那邊可以做一些優化，可以從小排到大，然後確保每次操作 heap 裡面都只有 k 個<ul><li>Time Complexity $O(n\lg{k})$</li><li>Space Complexity $O(n)$</li></ul></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">topKFrequent</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> k)</span> </span>&#123;<br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; mp;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span>&amp; i:nums) mp[i]++;<br><br>        <span class="hljs-keyword">auto</span> cmp = [](pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&amp; a, pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&amp; b) &#123;<br>            <span class="hljs-keyword">return</span> a.second &gt; b.second;<br>        &#125;;<br>        priority_queue&lt;pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;, vector&lt;pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&gt;, <span class="hljs-keyword">decltype</span>(cmp)&gt; pq;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; i:mp)&#123;<br>            pq.<span class="hljs-built_in">push</span>(i);<br>            <span class="hljs-keyword">if</span>(pq.<span class="hljs-built_in">size</span>() &gt; k)<br>                pq.<span class="hljs-built_in">pop</span>();<br>        &#125;<br><br>        vector&lt;<span class="hljs-type">int</span>&gt; ret;<br>        <span class="hljs-keyword">while</span>(k--)&#123;<br>            ret.<span class="hljs-built_in">push_back</span>(pq.<span class="hljs-built_in">top</span>().first);<br>            pq.<span class="hljs-built_in">pop</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="238-Product-of-Array-Except-Self"><a href="#238-Product-of-Array-Except-Self" class="headerlink" title="238. Product of Array Except Self"></a><a href="https://leetcode.com/problems/product-of-array-except-self/description/">238. Product of Array Except Self</a></h3><ul><li>開兩個 vector 記錄左右兩邊一路乘過去的值，最後兩者相乘<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">productExceptSelf</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-type">int</span> n = nums.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">L</span><span class="hljs-params">(n+<span class="hljs-number">2</span>)</span>, <span class="hljs-title">R</span><span class="hljs-params">(n+<span class="hljs-number">2</span>)</span>, <span class="hljs-title">ret</span><span class="hljs-params">(n)</span></span>;<br>        L[<span class="hljs-number">0</span>] = L[<span class="hljs-number">1</span>] = R[n] = R[n+<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)&#123;<br>            L[i+<span class="hljs-number">2</span>] = L[i+<span class="hljs-number">1</span>] * nums[i];<br>            R[n<span class="hljs-number">-1</span>-i] = R[n-i] * nums[n<span class="hljs-number">-1</span>-i];<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;n; i++)<br>            ret[i] = L[i+<span class="hljs-number">1</span>] * R[i+<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="36-Valid-Sudoku"><a href="#36-Valid-Sudoku" class="headerlink" title="36. Valid Sudoku"></a><a href="https://leetcode.com/problems/valid-sudoku/description/">36. Valid Sudoku</a></h3><ul><li>檢查每個 row、column、九宮格的情況<ul><li>Time Complexity $O(1)$</li><li>Space Complexity $O(1)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isValidSudoku</span><span class="hljs-params">(vector&lt;vector&lt;<span class="hljs-type">char</span>&gt;&gt;&amp; board)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">9</span>; i++)&#123;<br>            <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">seen</span><span class="hljs-params">(<span class="hljs-number">9</span>)</span></span>;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">9</span>; j++)&#123;<br>                <span class="hljs-type">char</span> ch = board[i][j];<br>                <span class="hljs-keyword">if</span>(ch == <span class="hljs-string">&#x27;.&#x27;</span>) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span>(seen[ch-<span class="hljs-string">&#x27;1&#x27;</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                ++seen[ch-<span class="hljs-string">&#x27;1&#x27;</span>];<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">9</span>; i++)&#123;<br>            <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">seen</span><span class="hljs-params">(<span class="hljs-number">9</span>)</span></span>;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">9</span>; j++)&#123;<br>                <span class="hljs-type">char</span> ch = board[j][i];<br>                <span class="hljs-keyword">if</span>(ch == <span class="hljs-string">&#x27;.&#x27;</span>) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span>(seen[ch-<span class="hljs-string">&#x27;1&#x27;</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                ++seen[ch-<span class="hljs-string">&#x27;1&#x27;</span>];<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">9</span>; i++)&#123;<br>            <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">seen</span><span class="hljs-params">(<span class="hljs-number">9</span>)</span></span>;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">9</span>; j++)&#123;<br>                <span class="hljs-type">char</span> ch = board[i/<span class="hljs-number">3</span>*<span class="hljs-number">3</span>+j/<span class="hljs-number">3</span>][i%<span class="hljs-number">3</span>*<span class="hljs-number">3</span>+j%<span class="hljs-number">3</span>];<br>                <span class="hljs-keyword">if</span>(ch == <span class="hljs-string">&#x27;.&#x27;</span>) <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span>(seen[ch-<span class="hljs-string">&#x27;1&#x27;</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                ++seen[ch-<span class="hljs-string">&#x27;1&#x27;</span>];<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="128-Longest-Consecutive-Sequence"><a href="#128-Longest-Consecutive-Sequence" class="headerlink" title="128. Longest Consecutive Sequence"></a><a href="https://leetcode.com/problems/longest-consecutive-sequence/description/">128. Longest Consecutive Sequence</a></h3><ul><li>檢查每個數字左右兩邊連續數字的數量，檢查過的要刪掉避免重複檢查<ul><li>Time Complexity $O(n)$</li><li>Space Complexity $O(n)$</li></ul></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">longestConsecutive</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums)</span> </span>&#123;<br>        <span class="hljs-function">unordered_set&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">st</span><span class="hljs-params">(nums.begin(), nums.end())</span></span>;<br>        <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i:nums)&#123;<br>            <span class="hljs-keyword">if</span>(st.<span class="hljs-built_in">count</span>(i) == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-type">int</span> cnt = <span class="hljs-number">1</span>; <span class="hljs-type">int</span> cur = i;<br>            st.<span class="hljs-built_in">erase</span>(cur);<br>            <span class="hljs-type">int</span> temp = cur + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>(st.<span class="hljs-built_in">count</span>(temp))&#123;<br>                ++cnt;<br>                st.<span class="hljs-built_in">erase</span>(temp++);<br>            &#125;<br>            temp = cur - <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>(st.<span class="hljs-built_in">count</span>(temp))&#123;<br>                ++cnt;<br>                st.<span class="hljs-built_in">erase</span>(temp--);<br>            &#125;<br>            ret = <span class="hljs-built_in">max</span>(ret, cnt);<br>        &#125;<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="Two-Pointers"><a href="#Two-Pointers" class="headerlink" title="Two Pointers"></a>Two Pointers</h2><h3 id="125-Valid-Palindrome"><a href="#125-Valid-Palindrome" class="headerlink" title="125. Valid Palindrome"></a><a href="https://leetcode.com/problems/valid-palindrome/description/">125. Valid Palindrome</a></h3><ul><li>用左右兩個指針收縮，檢查是不是 Palindrome</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isPalindrome</span><span class="hljs-params">(string s)</span> </span>&#123;<br>        <span class="hljs-type">int</span> l = <span class="hljs-number">0</span>, r = s.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span>(l &lt; r)&#123;<br>            <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isalnum</span>(s[l]) &amp;&amp; l &lt; r) l++;<br>            <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isalnum</span>(s[r]) &amp;&amp; l &lt; r) r--;<br>            <span class="hljs-keyword">if</span>(l &lt; r &amp;&amp; <span class="hljs-built_in">tolower</span>(s[l++]) != <span class="hljs-built_in">tolower</span>(s[r--]))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Graphcis Programming and Application Lecture Program 解析 (2)</title>
    <link href="/notes/2024/11/11/gpa-lecture-program-2/"/>
    <url>/notes/2024/11/11/gpa-lecture-program-2/</url>
    
    <content type="html"><![CDATA[<h1 id="Grass"><a href="#Grass" class="headerlink" title="Grass"></a>Grass</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * grass_vs_source[] =<br>&#123;<br>    <span class="hljs-string">&quot;#version 410 core                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;in vec4 vVertex;                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;out vec4 color;                                                                                             \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;uniform mat4 mvpMatrix;                                                                                     \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;int random(int seed, int iterations)                                                                        \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;    int value = seed;                                                                                       \n&quot;</span><br>    <span class="hljs-string">&quot;    int n;                                                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    for (n = 0; n &lt; iterations; n++) &#123;                                                                      \n&quot;</span><br>    <span class="hljs-string">&quot;        value = ((value &gt;&gt; 7) ^ (value &lt;&lt; 9)) * 15485863;                                                   \n&quot;</span><br>    <span class="hljs-string">&quot;    &#125;                                                                                                       \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    return value;                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;vec4 random_vector(int seed)                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;    int r = random(gl_InstanceID, 4);                                                                       \n&quot;</span><br>    <span class="hljs-string">&quot;    int g = random(r, 2);                                                                                   \n&quot;</span><br>    <span class="hljs-string">&quot;    int b = random(g, 2);                                                                                   \n&quot;</span><br>    <span class="hljs-string">&quot;    int a = random(b, 2);                                                                                   \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    return vec4(float(r &amp; 0x3FF) / 1024.0,                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                float(g &amp; 0x3FF) / 1024.0,                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                float(b &amp; 0x3FF) / 1024.0,                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                float(a &amp; 0x3FF) / 1024.0);                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;mat4 construct_rotation_matrix(float angle)                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;    float st = sin(angle);                                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;    float ct = cos(angle);                                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    return mat4(vec4(ct, 0.0, st, 0.0),                                                                     \n&quot;</span><br>    <span class="hljs-string">&quot;                vec4(0.0, 1.0, 0.0, 0.0),                                                                   \n&quot;</span><br>    <span class="hljs-string">&quot;                vec4(-st, 0.0, ct, 0.0),                                                                    \n&quot;</span><br>    <span class="hljs-string">&quot;                vec4(0.0, 0.0, 0.0, 1.0));                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;void main(void)                                                                                             \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;    vec4 offset = vec4(float(gl_InstanceID &gt;&gt; 10) - 512.0,                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                       0.0f,                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;                       float(gl_InstanceID &amp; 0x3FF) - 512.0,                                                \n&quot;</span><br>    <span class="hljs-string">&quot;                       0.0f);                                                                               \n&quot;</span><br>    <span class="hljs-string">&quot;    int number1 = random(gl_InstanceID, 3);                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;    int number2 = random(number1, 2);                                                                       \n&quot;</span><br>    <span class="hljs-string">&quot;    offset += vec4(float(number1 &amp; 0xFF) / 256.0,                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                   0.0f,                                                                                    \n&quot;</span><br>    <span class="hljs-string">&quot;                   float(number2 &amp; 0xFF) / 256.0,                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                   0.0f);                                                                                   \n&quot;</span><br>    <span class="hljs-string">&quot;    float angle = float(random(number2, 2) &amp; 0x3FF) / 1024.0;                                               \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    vec2 texcoord = offset.xz / 1024.0 + vec2(0.5);                                                         \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    float bend_factor = float(random(number2, 7) &amp; 0x3FF) / 1024.0;                                         \n&quot;</span><br>    <span class="hljs-string">&quot;    float bend_amount = cos(vVertex.y);                                                                     \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    mat4 rot = construct_rotation_matrix(angle);                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    vec4 position = (rot * (vVertex + vec4(0.0, 0.0, bend_amount * bend_factor, 0.0))) + offset;            \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    position *= vec4(1.0, float(number1 &amp; 0xFF) / 256.0 * 0.9 + 0.3, 1.0, 1.0);                             \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    gl_Position = mvpMatrix * position;                                                                     \n&quot;</span><br>    <span class="hljs-string">&quot;    color = vec4(random_vector(gl_InstanceID).xyz * vec3(0.1, 0.5, 0.1) + vec3(0.1, 0.4, 0.1), 1.0);        \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                                                                           \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * grass_fs_source[] =<br>&#123;<br>    <span class="hljs-string">&quot;#version 410 core                \n&quot;</span><br>    <span class="hljs-string">&quot;                                 \n&quot;</span><br>    <span class="hljs-string">&quot;in vec4 color;                   \n&quot;</span><br>    <span class="hljs-string">&quot;                                 \n&quot;</span><br>    <span class="hljs-string">&quot;out vec4 output_color;           \n&quot;</span><br>    <span class="hljs-string">&quot;                                 \n&quot;</span><br>    <span class="hljs-string">&quot;void main(void)                  \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                \n&quot;</span><br>    <span class="hljs-string">&quot;    output_color = color;        \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                \n&quot;</span><br>&#125;;<br><br>GLuint grass_buffer;<br>GLuint grass_vao;<br>GLuint grass_program;<br><span class="hljs-function">mat4 <span class="hljs-title">proj_matrix</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><br><span class="hljs-keyword">struct</span><br>&#123;<br>GLint mvpMatrix;<br>&#125; uniforms;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat grass_blade[] =<br>    &#123;<br>        <span class="hljs-number">-0.3f</span>, <span class="hljs-number">0.0f</span>,<br>         <span class="hljs-number">0.3f</span>, <span class="hljs-number">0.0f</span>,<br>        <span class="hljs-number">-0.20f</span>, <span class="hljs-number">1.0f</span>,<br>         <span class="hljs-number">0.1f</span>, <span class="hljs-number">1.3f</span>,<br>        <span class="hljs-number">-0.05f</span>, <span class="hljs-number">2.3f</span>,<br>         <span class="hljs-number">0.0f</span>, <span class="hljs-number">3.3f</span><br>    &#125;;<br><br>    <span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;grass_buffer);<br>    <span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, grass_buffer);<br>    <span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(grass_blade), grass_blade, GL_STATIC_DRAW);<br><br>    <span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;grass_vao);<br>    <span class="hljs-built_in">glBindVertexArray</span>(grass_vao);<br><br>    <span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><br>    grass_program = <span class="hljs-built_in">glCreateProgram</span>();<br>    GLuint grass_vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br>    GLuint grass_fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><br>    <span class="hljs-built_in">glShaderSource</span>(grass_vs, <span class="hljs-number">1</span>, grass_vs_source, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">glShaderSource</span>(grass_fs, <span class="hljs-number">1</span>, grass_fs_source, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-built_in">glCompileShader</span>(grass_vs);<br>    <span class="hljs-built_in">glCompileShader</span>(grass_fs);<br><br>    <span class="hljs-built_in">glAttachShader</span>(grass_program, grass_vs);<br>    <span class="hljs-built_in">glAttachShader</span>(grass_program, grass_fs);<br><br>    <span class="hljs-built_in">glLinkProgram</span>(grass_program);<br>    <span class="hljs-built_in">glDeleteShader</span>(grass_fs);<br>    <span class="hljs-built_in">glDeleteShader</span>(grass_vs);<br><br>    uniforms.mvpMatrix = <span class="hljs-built_in">glGetUniformLocation</span>(grass_program, <span class="hljs-string">&quot;mvpMatrix&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">float</span> t = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME) * <span class="hljs-number">0.00002f</span>;<br>    <span class="hljs-type">float</span> r = <span class="hljs-number">550.0f</span>;<br><br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat black[] = &#123; <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> &#125;;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat one = <span class="hljs-number">1.0f</span>;<br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, black);<br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_DEPTH, <span class="hljs-number">0</span>, &amp;one);<br><br>    mat4 mv_matrix = <span class="hljs-built_in">lookAt</span>(<span class="hljs-built_in">vec3</span>(<span class="hljs-built_in">sinf</span>(t) * r, <span class="hljs-number">25.0f</span>, <span class="hljs-built_in">cosf</span>(t) * r),<br>                                            <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">-50.0f</span>, <span class="hljs-number">0.0f</span>),<br>                                            <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>));<br><br>    <span class="hljs-built_in">glUseProgram</span>(grass_program);<br>    <span class="hljs-built_in">glUniformMatrix4fv</span>(uniforms.mvpMatrix, <span class="hljs-number">1</span>, GL_FALSE, &amp;(proj_matrix * mv_matrix)[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br>    <span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>    <span class="hljs-built_in">glBindVertexArray</span>(grass_vao);<br><span class="hljs-comment">// void glDrawArraysInstanced(GLenum mode,</span><br><span class="hljs-comment">// GLint first,</span><br><span class="hljs-comment">// GLsizei count,</span><br><span class="hljs-comment">// GLsizei instancecount</span><br><span class="hljs-comment">// );</span><br><br>    <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLE_STRIP, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br><span class="hljs-type">float</span> viewportAspect = (<span class="hljs-type">float</span>)width / (<span class="hljs-type">float</span>)height;<br>proj_matrix = <span class="hljs-built_in">perspective</span>(<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">45.0f</span>), viewportAspect, <span class="hljs-number">0.1f</span>, <span class="hljs-number">1000.0f</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, val);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Instanced-Attributes"><a href="#Instanced-Attributes" class="headerlink" title="Instanced_Attributes"></a>Instanced_Attributes</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * square_vs_source[] =<br>&#123;<br>    <span class="hljs-string">&quot;#version 410 core                                                               \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;layout (location = 0) in vec4 position;                                         \n&quot;</span><br>    <span class="hljs-string">&quot;layout (location = 1) in vec4 instance_color;                                   \n&quot;</span><br>    <span class="hljs-string">&quot;layout (location = 2) in vec4 instance_position;                                \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;out Fragment                                                                    \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                               \n&quot;</span><br>    <span class="hljs-string">&quot;    vec4 color;                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;&#125; fragment;                                                                     \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;void main(void)                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                               \n&quot;</span><br>    <span class="hljs-string">&quot;    gl_Position = (position + instance_position) * vec4(0.25, 0.25, 1.0, 1.0);  \n&quot;</span><br>    <span class="hljs-string">&quot;    fragment.color = instance_color;                                            \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                                               \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * square_fs_source[] =<br>&#123;<br>    <span class="hljs-string">&quot;#version 410 core                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;precision highp float;                                                           \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;in Fragment                                                                      \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;    vec4 color;                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;&#125; fragment;                                                                      \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;out vec4 color;                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;                                                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;void main(void)                                                                  \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                                                \n&quot;</span><br>    <span class="hljs-string">&quot;    color = fragment.color;                                                      \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                                                \n&quot;</span><br>&#125;;<br><br>GLuint      square_buffer;<br>GLuint      square_vao;<br>GLuint      square_program;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat square_vertices[] =<br>    &#123;<br>        <span class="hljs-number">-1.0f</span>, <span class="hljs-number">-1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>,<br>            <span class="hljs-number">1.0f</span>, <span class="hljs-number">-1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>,<br>            <span class="hljs-number">1.0f</span>,  <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>,<br>        <span class="hljs-number">-1.0f</span>,  <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span><br>    &#125;;<br><br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat instance_colors[] =<br>    &#123;<br>        <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>,<br>        <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>,<br>        <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>,<br>        <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span><br>    &#125;;<br><br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat instance_positions[] =<br>    &#123;<br>        <span class="hljs-number">-2.0f</span>, <span class="hljs-number">-2.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>,<br>            <span class="hljs-number">2.0f</span>, <span class="hljs-number">-2.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>,<br>            <span class="hljs-number">2.0f</span>,  <span class="hljs-number">2.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>,<br>        <span class="hljs-number">-2.0f</span>,  <span class="hljs-number">2.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span><br>    &#125;;<br><br>    GLuint offset = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;square_vao);<br>    <span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;square_buffer);<br>    <span class="hljs-built_in">glBindVertexArray</span>(square_vao);<br>    <span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, square_buffer);<br>    <span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(square_vertices) + <span class="hljs-built_in">sizeof</span>(instance_colors) + <span class="hljs-built_in">sizeof</span>(instance_positions), <span class="hljs-literal">NULL</span>, GL_STATIC_DRAW);<br>    <span class="hljs-built_in">glBufferSubData</span>(GL_ARRAY_BUFFER, offset, <span class="hljs-built_in">sizeof</span>(square_vertices), square_vertices);<br>    offset += <span class="hljs-built_in">sizeof</span>(square_vertices);<br>    <span class="hljs-built_in">glBufferSubData</span>(GL_ARRAY_BUFFER, offset, <span class="hljs-built_in">sizeof</span>(instance_colors), instance_colors);<br>    offset += <span class="hljs-built_in">sizeof</span>(instance_colors);<br>    <span class="hljs-built_in">glBufferSubData</span>(GL_ARRAY_BUFFER, offset, <span class="hljs-built_in">sizeof</span>(instance_positions), instance_positions);<br>    offset += <span class="hljs-built_in">sizeof</span>(instance_positions);<br><br>    <span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, (GLvoid *)<span class="hljs-built_in">sizeof</span>(square_vertices));<br>    <span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, (GLvoid *)(<span class="hljs-built_in">sizeof</span>(square_vertices) + <span class="hljs-built_in">sizeof</span>(instance_colors)));<br><br>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">2</span>);<br><br>    <span class="hljs-built_in">glVertexAttribDivisor</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// position = 1 的那個頻率是 1，每個instance使用1次，2，如果是每兩個instance都用一樣的</span><br>    <span class="hljs-built_in">glVertexAttribDivisor</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>) ;<span class="hljs-comment">// position = 2 的那個頻率是 1，每個instance使用1次</span><br><br>    square_program = <span class="hljs-built_in">glCreateProgram</span>();<br><br>    GLuint square_vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br>    <span class="hljs-built_in">glShaderSource</span>(square_vs, <span class="hljs-number">1</span>, square_vs_source, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">glCompileShader</span>(square_vs);<br>    <span class="hljs-built_in">glAttachShader</span>(square_program, square_vs);<br>    GLuint square_fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br>    <span class="hljs-built_in">glShaderSource</span>(square_fs, <span class="hljs-number">1</span>, square_fs_source, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-built_in">glCompileShader</span>(square_fs);<br>    <span class="hljs-built_in">glAttachShader</span>(square_program, square_fs);<br><br>    <span class="hljs-built_in">glLinkProgram</span>(square_program);<br>    <span class="hljs-built_in">glDeleteShader</span>(square_vs);<br>    <span class="hljs-built_in">glDeleteShader</span>(square_fs);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat black[] = &#123; <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span> &#125;;<br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, black);<br><br>    <span class="hljs-built_in">glUseProgram</span>(square_program);<br>    <span class="hljs-built_in">glBindVertexArray</span>(square_vao);<br>    <span class="hljs-built_in">glDrawArraysInstanced</span>(GL_TRIANGLE_FAN, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>);<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Point-Sprite"><a href="#Point-Sprite" class="headerlink" title="Point Sprite"></a>Point Sprite</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_TIMER_START 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_TIMER_STOP 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_EXIT 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> M_PI = 3.14;</span><br><br>GLubyte timer_cnt = <span class="hljs-number">0</span>;<br><span class="hljs-type">bool</span> timer_enabled = <span class="hljs-literal">true</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timer_speed = <span class="hljs-number">16</span>;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-function">mat4 <span class="hljs-title">mvp</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br>GLint um4mvp;<br>GLuint m_texture;<br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seed = <span class="hljs-number">0x13371337</span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">float</span> <span class="hljs-title">random_float</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">float</span> res;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tmp;<br><br>seed *= <span class="hljs-number">16807</span>;<br><br>tmp = seed ^ (seed &gt;&gt; <span class="hljs-number">4</span>) ^ (seed &lt;&lt; <span class="hljs-number">15</span>);<br><br>*((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *) &amp;res) = (tmp &gt;&gt; <span class="hljs-number">9</span>) | <span class="hljs-number">0x3F800000</span>;<br><br><span class="hljs-keyword">return</span> (res - <span class="hljs-number">1.0f</span>);<br>&#125;<br><br><span class="hljs-keyword">enum</span><br>&#123;<br>NUM_STARS           = <span class="hljs-number">1000</span><br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 0) in vec4 position;                        \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 1) in vec4 color;                           \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;uniform float time;                                            \n&quot;</span><br><span class="hljs-string">&quot;uniform mat4 proj_matrix;                                      \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;flat out vec4 starColor;                                       \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                              \n&quot;</span><br><span class="hljs-string">&quot;    vec4 newVertex = position;                                 \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;    newVertex.z += time;                                       \n&quot;</span><br><span class="hljs-string">&quot;    newVertex.z = fract(newVertex.z);                          \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;    float size = (20.0 * newVertex.z * newVertex.z);           \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;    starColor = smoothstep(1.0, 7.0, size) * color;            \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;    newVertex.z = (999.9 * newVertex.z) - 1000.0;              \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = proj_matrix * newVertex;                     \n&quot;</span><br><span class="hljs-string">&quot;    gl_PointSize = size;                                       \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                              \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;        \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2D tex_star;\n&quot;</span><br><span class="hljs-string">&quot;flat in vec4 starColor;                                        \n&quot;</span><br><span class="hljs-string">&quot;                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                              \n&quot;</span><br><span class="hljs-string">&quot;    color = texture(tex_star,gl_PointCoord);    \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                              \n&quot;</span><br>&#125;;<br><br><br>GLuint          program;<br>GLuint          vao;<br>GLuintvertex_shader;<br>GLuintfragment_shader;<br>GLuint          buffer;<br>GLint           mv_location;<br>GLint           proj_location;<br>GLinttime_Loc;<br><br><span class="hljs-function">mat4 <span class="hljs-title">proj_matrix</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><span class="hljs-built_in">printGLShaderLog</span>(fs);<br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br><span class="hljs-built_in">glEnable</span>(GL_CULL_FACE);<br><span class="hljs-built_in">glFrontFace</span>(GL_CW);<br><br>proj_location = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;proj_matrix&quot;</span>);<br>time_Loc = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;time&quot;</span>);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">star_t</span><br>&#123;<br>vec3 position;<br>vec3 color;<br>&#125;;<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, NUM_STARS * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">star_t</span>), <span class="hljs-literal">NULL</span>, GL_STATIC_DRAW);<br><br><span class="hljs-comment">// void *glMapBufferRange(</span><br><span class="hljs-comment">//  GLenum target,</span><br><span class="hljs-comment">// GLintptr offset,</span><br><span class="hljs-comment">// GLsizeiptr length,</span><br><span class="hljs-comment">// GLbitfield access</span><br><span class="hljs-comment">//);</span><br><br><span class="hljs-type">star_t</span> * star = (<span class="hljs-type">star_t</span> *)<span class="hljs-built_in">glMapBufferRange</span>(GL_ARRAY_BUFFER, <span class="hljs-number">0</span>, NUM_STARS * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">star_t</span>), GL_MAP_WRITE_BIT | GL_MAP_INVALIDATE_BUFFER_BIT);<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++)<br>&#123;<br>star[i].position[<span class="hljs-number">0</span>] = (<span class="hljs-built_in">random_float</span>() * <span class="hljs-number">2.0f</span> - <span class="hljs-number">1.0f</span>) * <span class="hljs-number">100.0f</span>;<br>star[i].position[<span class="hljs-number">1</span>] = (<span class="hljs-built_in">random_float</span>() * <span class="hljs-number">2.0f</span> - <span class="hljs-number">1.0f</span>) * <span class="hljs-number">100.0f</span>;<br>star[i].position[<span class="hljs-number">2</span>] = <span class="hljs-built_in">random_float</span>();<br>star[i].color[<span class="hljs-number">0</span>] = <span class="hljs-number">0.8f</span> + <span class="hljs-built_in">random_float</span>() * <span class="hljs-number">0.2f</span>;<br>star[i].color[<span class="hljs-number">1</span>] = <span class="hljs-number">0.8f</span> + <span class="hljs-built_in">random_float</span>() * <span class="hljs-number">0.2f</span>;<br>star[i].color[<span class="hljs-number">2</span>] = <span class="hljs-number">0.8f</span> + <span class="hljs-built_in">random_float</span>() * <span class="hljs-number">0.2f</span>;<br>&#125;<br><br><br><br><span class="hljs-built_in">glUnmapBuffer</span>(GL_ARRAY_BUFFER);<br><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">star_t</span>), <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">star_t</span>), (<span class="hljs-type">void</span> *)<span class="hljs-built_in">sizeof</span>(vec3));<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">1</span>);<br><span class="hljs-built_in">glEnable</span>(GL_TEXTURE_2D);<br><span class="hljs-built_in">glActiveTexture</span>( GL_TEXTURE0 );<br><br><span class="hljs-built_in">glEnable</span>(GL_POINT_SPRITE); <span class="hljs-comment">//點精靈會根據視點自動調整其大小和方向，這樣在三維空間中，它們看起來更自然。</span><br>TextureData tdata = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/star.png&quot;</span>);<br><br><span class="hljs-built_in">glEnable</span>(GL_BLEND);<br><span class="hljs-built_in">glBlendFunc</span>(GL_ONE, GL_ONE);<br><span class="hljs-built_in">glGenTextures</span>( <span class="hljs-number">1</span>, &amp;m_texture );<br><span class="hljs-built_in">glBindTexture</span>( GL_TEXTURE_2D, m_texture);<br><span class="hljs-comment">//glTexImage2D(..., mipmap, texture format, ..., ..., 邊框, 來源格式, 通道, ...)</span><br><span class="hljs-built_in">glTexImage2D</span>( GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, tdata.width, tdata.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tdata.data );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE ); <span class="hljs-comment">//水平</span><br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST );;<br><br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat black[] = &#123; <span class="hljs-number">0.0f</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> &#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat one = <span class="hljs-number">1.0f</span>;<br><br><span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, black);<br><span class="hljs-built_in">glClearBufferfv</span>(GL_DEPTH, <span class="hljs-number">0</span>, &amp;one);<br><br><span class="hljs-built_in">glUseProgram</span>(program);<br><br><span class="hljs-type">float</span> f_timer_cnt = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME);<br><span class="hljs-type">float</span> currentTime = f_timer_cnt* <span class="hljs-number">0.001f</span>;<br><br>currentTime *= <span class="hljs-number">0.1f</span>;<br>currentTime -= <span class="hljs-built_in">floor</span>(currentTime);<br><br><span class="hljs-built_in">glUniform1f</span>(time_Loc, currentTime);<br><span class="hljs-built_in">glUniformMatrix4fv</span>(proj_location, <span class="hljs-number">1</span>, GL_FALSE, &amp;proj_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">glEnable</span>(GL_BLEND);<br><span class="hljs-built_in">glBlendFunc</span>(GL_ONE, GL_ONE);<br><br><span class="hljs-built_in">glActiveTexture</span>( GL_TEXTURE0 );<br><span class="hljs-built_in">glBindTexture</span>( GL_TEXTURE_2D, m_texture);<br><span class="hljs-built_in">glEnable</span>(GL_PROGRAM_POINT_SIZE);<span class="hljs-comment">//，OpenGL 會允許頂點著色器使用 gl_PointSize 變量來動態控制每個點的大小。</span><br><span class="hljs-built_in">glDrawArrays</span>(GL_POINTS, <span class="hljs-number">0</span>, NUM_STARS);<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br><br><span class="hljs-type">float</span> viewportAspect = (<span class="hljs-type">float</span>)width / (<span class="hljs-type">float</span>)height;<br><br>proj_matrix = <span class="hljs-built_in">perspective</span>(<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">50.0f</span>), viewportAspect, <span class="hljs-number">0.1f</span>, <span class="hljs-number">1000.0f</span>);<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>timer_cnt++;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-keyword">if</span>(timer_enabled)<br>&#123;<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, val);<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="GrayScale-Cube"><a href="#GrayScale-Cube" class="headerlink" title="GrayScale_Cube"></a>GrayScale_Cube</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GLM_SWIZZLE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_TIMER_START 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_TIMER_STOP 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_EXIT 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> M_PI = 3.14;</span><br><br>GLubyte timer_cnt = <span class="hljs-number">0</span>;<br><span class="hljs-type">bool</span> timer_enabled = <span class="hljs-literal">true</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timer_speed = <span class="hljs-number">16</span>;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-function">mat4 <span class="hljs-title">mvp</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br>GLint um4mvp;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;in vec4 position;                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;out VS_OUT                                                         \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    vec4 color;                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#125; vs_out;                                                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;uniform mat4 mv_matrix;                                            \n&quot;</span><br><span class="hljs-string">&quot;uniform mat4 proj_matrix;                                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = proj_matrix * mv_matrix * position;              \n&quot;</span><br><span class="hljs-string">&quot;    vs_out.color = position * 2.0 + vec4(0.5, 0.5, 0.5, 0.0);      \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                  \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;                                                    \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;in VS_OUT                                                          \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    vec4 color;                                                   \n&quot;</span><br><span class="hljs-string">&quot;&#125; fs_in;                                                           \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    color = fs_in.color;                                           \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                  \n&quot;</span><br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source2[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 0) in vec2 position;                            \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 1) in vec2 texcoord;                            \n&quot;</span><br><span class="hljs-string">&quot;out VS_OUT                                                         \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    vec2 texcoord;                                                 \n&quot;</span><br><span class="hljs-string">&quot;&#125; vs_out;                                                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = vec4(position,0.0,1.0);\n&quot;</span><br><span class="hljs-string">&quot;    vs_out.texcoord = texcoord;                                    \n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source2[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2D tex;                                                         \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;                                                                \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;in VS_OUT                                                                      \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                              \n&quot;</span><br><span class="hljs-string">&quot;    vec2 texcoord;                                                             \n&quot;</span><br><span class="hljs-string">&quot;&#125; fs_in;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                              \n&quot;</span><br><span class="hljs-string">&quot;    vec4 texture_color = texture(tex,fs_in.texcoord);\n&quot;</span><br><span class="hljs-string">&quot; float grayscale_color = 0.2126*texture_color.r+0.7152*texture_color.g+0.0722*texture_color.b; \n&quot;</span><br><span class="hljs-string">&quot;    color = vec4(grayscale_color,grayscale_color,grayscale_color,1.0);\n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                              \n&quot;</span><br>&#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat vertex_positions[] =<br>&#123;<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat window_positions[] =<br>&#123;<br><span class="hljs-number">1.0f</span>,<span class="hljs-number">-1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">0.0f</span>,<br><span class="hljs-number">-1.0f</span>,<span class="hljs-number">-1.0f</span>,<span class="hljs-number">0.0f</span>,<span class="hljs-number">0.0f</span>,<br><span class="hljs-number">-1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">0.0f</span>,<span class="hljs-number">1.0f</span>,<br><span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span><br>&#125;;<br><br>GLuint          program;<br>GLuintprogram2;<br>GLuint          vao;<br>GLuint          window_vao;<br>GLuintvertex_shader;<br>GLuintfragment_shader;<br>GLuint          buffer;<br>GLuintwindow_buffer;<br>GLint           mv_location;<br>GLint           proj_location;<br><br>GLuintFBO;<br>GLuintdepthRBO;<br>GLuintFBODataTexture;<br><br><span class="hljs-function">mat4 <span class="hljs-title">proj_matrix</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br>program2 = <span class="hljs-built_in">glCreateProgram</span>();<br><br>GLuint vs2 = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs2, <span class="hljs-number">1</span>, vs_source2, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs2);<br><span class="hljs-built_in">printGLShaderLog</span>(vs2);<br><br>GLuint fs2 = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs2, <span class="hljs-number">1</span>, fs_source2, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs2);<br><span class="hljs-built_in">printGLShaderLog</span>(fs2);<br><br><span class="hljs-built_in">glAttachShader</span>(program2, vs2);<br><span class="hljs-built_in">glAttachShader</span>(program2, fs2);<br><br><span class="hljs-built_in">glLinkProgram</span>(program2);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(vertex_positions), vertex_positions, GL_STATIC_DRAW);<br><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><br>mv_location = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;mv_matrix&quot;</span>);<br>proj_location = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;proj_matrix&quot;</span>);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;window_vao);<br><span class="hljs-built_in">glBindVertexArray</span>(window_vao);<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;window_buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, window_buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER,<span class="hljs-built_in">sizeof</span>(window_positions),window_positions,GL_STATIC_DRAW);<br><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-built_in">sizeof</span>(GL_FLOAT)*<span class="hljs-number">4</span>, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glVertexAttribPointer</span>( <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-built_in">sizeof</span>(GL_FLOAT)*<span class="hljs-number">4</span>, (<span class="hljs-type">const</span> GLvoid*)(<span class="hljs-built_in">sizeof</span>(GL_FLOAT)*<span class="hljs-number">2</span>));<br><br><span class="hljs-built_in">glEnableVertexAttribArray</span>( <span class="hljs-number">0</span> );<br><span class="hljs-built_in">glEnableVertexAttribArray</span>( <span class="hljs-number">1</span> );<br><br><span class="hljs-built_in">glGenFramebuffers</span>( <span class="hljs-number">1</span>, &amp;FBO );<br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">/////////Create RBO and Render Texture in Reshape Function////////////////</span><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////</span><br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glBindTexture</span>( GL_TEXTURE_2D, <span class="hljs-number">0</span> );<br><span class="hljs-built_in">glBindFramebuffer</span>( GL_DRAW_FRAMEBUFFER, FBO );<br><span class="hljs-built_in">glDrawBuffer</span>( GL_COLOR_ATTACHMENT0 );<br><br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat green[] = &#123; <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.25f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> &#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat one = <span class="hljs-number">1.0f</span>;<br><br><span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, green);<br><span class="hljs-built_in">glClearBufferfv</span>(GL_DEPTH, <span class="hljs-number">0</span>, &amp;one);<br><br><span class="hljs-built_in">glUseProgram</span>(program);<br><br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><span class="hljs-built_in">glUniformMatrix4fv</span>(proj_location, <span class="hljs-number">1</span>, GL_FALSE, &amp;proj_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br><span class="hljs-function">mat4 <span class="hljs-title">Identy_Init</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><br><span class="hljs-type">float</span> f_timer_cnt = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME);<br><span class="hljs-type">float</span> currentTime = f_timer_cnt* <span class="hljs-number">0.001f</span>;<br><span class="hljs-type">float</span> f = (<span class="hljs-type">float</span>)currentTime * <span class="hljs-number">0.3f</span>;<br><br>mat4 mv_matrix = <span class="hljs-built_in">translate</span>(Identy_Init, <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">-4.0f</span>));<br><br>mv_matrix = <span class="hljs-built_in">translate</span>(mv_matrix, <span class="hljs-built_in">vec3</span>(<span class="hljs-built_in">sinf</span>(<span class="hljs-number">2.1f</span> * f) * <span class="hljs-number">0.5f</span>,<span class="hljs-built_in">cosf</span>(<span class="hljs-number">1.7f</span> * f) * <span class="hljs-number">0.5f</span>,<span class="hljs-built_in">sinf</span>(<span class="hljs-number">1.3f</span> * f) * <span class="hljs-built_in">cosf</span>(<span class="hljs-number">1.5f</span> * f) * <span class="hljs-number">2.0f</span>));<br><br>mv_matrix = <span class="hljs-built_in">rotate</span>(mv_matrix,<span class="hljs-built_in">deg2rad</span>(currentTime*<span class="hljs-number">45.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>));<br>mv_matrix = <span class="hljs-built_in">rotate</span>(mv_matrix,<span class="hljs-built_in">deg2rad</span>(currentTime*<span class="hljs-number">81.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>));<br><br><span class="hljs-built_in">glUniformMatrix4fv</span>(mv_location, <span class="hljs-number">1</span>, GL_FALSE, &amp;mv_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">36</span>);<br><br><span class="hljs-built_in">glBindFramebuffer</span>( GL_DRAW_FRAMEBUFFER, <span class="hljs-number">0</span> );<br><br><span class="hljs-built_in">glClear</span>( GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT );<br><span class="hljs-built_in">glClearColor</span>( <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> );<br><br><span class="hljs-built_in">glActiveTexture</span>(GL_TEXTURE0);<br><span class="hljs-built_in">glBindTexture</span>( GL_TEXTURE_2D, FBODataTexture );<br><span class="hljs-built_in">glBindVertexArray</span>(window_vao);<br><span class="hljs-built_in">glUseProgram</span>(program2);<br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_FAN,<span class="hljs-number">0</span>,<span class="hljs-number">4</span> );<br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><span class="hljs-comment">// FRAMEBUFFER</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br><br><span class="hljs-type">float</span> viewportAspect = (<span class="hljs-type">float</span>)width / (<span class="hljs-type">float</span>)height;<br>proj_matrix = <span class="hljs-built_in">perspective</span>(<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">60.0f</span>), viewportAspect, <span class="hljs-number">0.1f</span>, <span class="hljs-number">1000.0f</span>);<br><br><span class="hljs-built_in">glDeleteRenderbuffers</span>(<span class="hljs-number">1</span>,&amp;depthRBO);<br><span class="hljs-built_in">glDeleteTextures</span>(<span class="hljs-number">1</span>,&amp;FBODataTexture);<br><span class="hljs-built_in">glGenRenderbuffers</span>( <span class="hljs-number">1</span>, &amp;depthRBO );<br><span class="hljs-built_in">glBindRenderbuffer</span>( GL_RENDERBUFFER, depthRBO );<br><span class="hljs-built_in">glRenderbufferStorage</span>( GL_RENDERBUFFER, GL_DEPTH_COMPONENT32, width, height );<br><br><span class="hljs-built_in">glGenTextures</span>( <span class="hljs-number">1</span>, &amp;FBODataTexture );<br><span class="hljs-built_in">glBindTexture</span>( GL_TEXTURE_2D, FBODataTexture);<br><br><span class="hljs-built_in">glTexImage2D</span>( GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, width, height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, <span class="hljs-literal">NULL</span> );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR );<br><br><span class="hljs-built_in">glBindFramebuffer</span>( GL_DRAW_FRAMEBUFFER, FBO );<br><span class="hljs-built_in">glFramebufferRenderbuffer</span>( GL_DRAW_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_RENDERBUFFER, depthRBO );<br><span class="hljs-comment">// void glFramebufferTexture2D(GLenum target,</span><br> <span class="hljs-comment">// GLenum attachment,</span><br> <span class="hljs-comment">// GLenum textarget,</span><br> <span class="hljs-comment">// GLuint texture,</span><br> <span class="hljs-comment">// GLint level);</span><br><span class="hljs-built_in">glFramebufferTexture2D</span>( GL_DRAW_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, FBODataTexture, <span class="hljs-number">0</span> );<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>timer_cnt++;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-keyword">if</span>(timer_enabled)<br>&#123;<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, val);<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Image-Processing"><a href="#Image-Processing" class="headerlink" title="Image Processing"></a>Image Processing</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_TIMER_START 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_TIMER_STOP 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MENU_EXIT 3</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> Shader_Blur 4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> Shader_Quantization 5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> Shader_DoG 6</span><br><br><span class="hljs-type">int</span> shader_now = <span class="hljs-number">0</span>;<br><br>GLubyte timer_cnt = <span class="hljs-number">0</span>;<br><span class="hljs-type">bool</span> timer_enabled = <span class="hljs-literal">true</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timer_speed = <span class="hljs-number">16</span>;<br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-function">mat4 <span class="hljs-title">mvp</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br>GLint um4mvp;<br><br>GLuint hawk_texture;<br>GLint Shader_now_Loc;<br><span class="hljs-type">int</span> defalut_w = <span class="hljs-number">800</span>;<br><span class="hljs-type">int</span> defalut_h = <span class="hljs-number">600</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 0) in vec2 position;                            \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 1) in vec2 texcoord;                            \n&quot;</span><br><span class="hljs-string">&quot;out VS_OUT                                                         \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    vec2 texcoord;                                                 \n&quot;</span><br><span class="hljs-string">&quot;&#125; vs_out;                                                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = vec4(position,0.0,1.0);\n&quot;</span><br><span class="hljs-string">&quot;    vs_out.texcoord = texcoord;                                    \n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410\n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2D tex; \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;\n&quot;</span><br><span class="hljs-string">&quot;uniform int shader_now ;\n&quot;</span><br><span class="hljs-string">&quot;in VS_OUT\n&quot;</span><br><span class="hljs-string">&quot;&#123;\n&quot;</span><br><span class="hljs-string">&quot;   vec2 texcoord;\n&quot;</span><br><span class="hljs-string">&quot;&#125; fs_in;\n&quot;</span><br><span class="hljs-string">&quot;float sigma_e = 2.0f;\n&quot;</span><br><span class="hljs-string">&quot;float sigma_r = 2.8f;\n&quot;</span><br><span class="hljs-string">&quot;float phi = 3.4f;\n&quot;</span><br><span class="hljs-string">&quot;float tau = 0.99f;\n&quot;</span><br><span class="hljs-string">&quot;float twoSigmaESquared = 2.0 * sigma_e * sigma_e;\n&quot;</span><br><span class="hljs-string">&quot;float twoSigmaRSquared = 2.0 * sigma_r * sigma_r;\n&quot;</span><br><span class="hljs-string">&quot;int halfWidth = int(ceil( 2.0 * sigma_r ));\n&quot;</span><br><span class="hljs-string">&quot;vec2 img_size = vec2(1024,768);\n&quot;</span><br><span class="hljs-string">&quot;int nbins = 8;\n&quot;</span><br><span class="hljs-string">&quot;void main(void)\n&quot;</span><br><span class="hljs-string">&quot;&#123;\n&quot;</span><br><span class="hljs-string">&quot; \n&quot;</span><br><span class="hljs-string">&quot;switch(shader_now)\n&quot;</span><br><span class="hljs-string">&quot;&#123;\n&quot;</span><br><span class="hljs-string">&quot;case(2):\n&quot;</span><br><span class="hljs-string">&quot;&#123;\n&quot;</span><br><span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-string">&quot;vec2 sum = vec2(0.0);\n&quot;</span><br><span class="hljs-string">&quot;vec2 norm = vec2(0.0);\n&quot;</span><br><span class="hljs-string">&quot;int kernel_count = 0;\n&quot;</span><br><span class="hljs-string">&quot;for ( int i = -halfWidth; i &lt;= halfWidth; ++i ) &#123;\n&quot;</span><br><span class="hljs-string">&quot;for ( int j = -halfWidth; j &lt;= halfWidth; ++j ) &#123;\n&quot;</span><br><span class="hljs-string">&quot;float d = length(vec2(i,j));\n&quot;</span><br><span class="hljs-string">&quot;vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), \n&quot;</span><br><span class="hljs-string">&quot;exp( -d * d / twoSigmaRSquared ));\n&quot;</span><br><span class="hljs-string">&quot;vec4 c = texture(tex, fs_in.texcoord + vec2(i,j) / img_size);\n&quot;</span><br><span class="hljs-string">&quot;vec2 L = vec2(0.299 * c.r + 0.587 * c.g + 0.114 * c.b);\n&quot;</span><br><span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-string">&quot;norm += 2.0 * kernel;\n&quot;</span><br><span class="hljs-string">&quot;sum += kernel * L;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;sum /= norm;\n&quot;</span><br><span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-string">&quot;float H = 100.0 * (sum.x - tau * sum.y);\n&quot;</span><br><span class="hljs-string">&quot;float edge = ( H &gt; 0.0 )? 1.0 : 2.0 * smoothstep(-2.0, 2.0, phi * H );\n&quot;</span><br><span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-string">&quot;   color = vec4(edge,edge,edge,1.0 );\n&quot;</span><br><span class="hljs-string">&quot;break;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;case(1):\n&quot;</span><br><span class="hljs-string">&quot;&#123;\n&quot;</span><br><span class="hljs-string">&quot;vec4 texture_color = texture(tex,fs_in.texcoord);\n&quot;</span><br><span class="hljs-string">&quot;   \n&quot;</span><br><span class="hljs-string">&quot;float r = floor(texture_color.r * float(nbins)) / float(nbins);\n&quot;</span><br><span class="hljs-string">&quot; float g = floor(texture_color.g * float(nbins)) / float(nbins);\n&quot;</span><br><span class="hljs-string">&quot;float b = floor(texture_color.b * float(nbins)) / float(nbins); \n&quot;</span><br><span class="hljs-string">&quot;color = vec4(r,g,b,texture_color.a);\n&quot;</span><br><span class="hljs-string">&quot;break;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;case(0):\n&quot;</span><br><span class="hljs-string">&quot;&#123;\n&quot;</span><br><span class="hljs-string">&quot;color = vec4(0);\n&quot;</span><br><span class="hljs-string">&quot;int n = 0;\n&quot;</span><br><span class="hljs-string">&quot;int half_size = 3;\n&quot;</span><br><span class="hljs-string">&quot;for ( int i = -half_size; i &lt;= half_size; ++i ) &#123;        \n&quot;</span><br><span class="hljs-string">&quot;for ( int j = -half_size; j &lt;= half_size; ++j ) &#123;\n&quot;</span><br><span class="hljs-string">&quot; vec4 c = texture(tex, fs_in.texcoord + vec2(i,j)/img_size); \n&quot;</span><br><span class="hljs-string">&quot; color+= c;\n&quot;</span><br><span class="hljs-string">&quot;     n++;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;color /=n;\n&quot;</span><br><span class="hljs-string">&quot;break;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><span class="hljs-string">&quot;&#125;\n&quot;</span><br><br>&#125;;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>GLuint program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint vertexShader = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br>GLuint fragmentShader = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><br><span class="hljs-built_in">glShaderSource</span>(vertexShader, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glShaderSource</span>(fragmentShader, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><br><span class="hljs-built_in">glCompileShader</span>(vertexShader);<br><span class="hljs-built_in">glCompileShader</span>(fragmentShader);<br><span class="hljs-built_in">printGLShaderLog</span>(vertexShader);<br><span class="hljs-built_in">printGLShaderLog</span>(fragmentShader);<br><span class="hljs-built_in">glAttachShader</span>(program, vertexShader);<br><span class="hljs-built_in">glAttachShader</span>(program, fragmentShader);<br><span class="hljs-built_in">glLinkProgram</span>(program);<br>um4mvp = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;um4mvp&quot;</span>);<br><span class="hljs-built_in">glUseProgram</span>(program);<br><br>Shader_now_Loc = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;shader_now&quot;</span>);<br><br>GLuint buffer;<br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, buffer);<br><br>GLuint vao;<br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) * <span class="hljs-number">4</span>, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) * <span class="hljs-number">4</span>, (<span class="hljs-type">void</span>*)(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) * <span class="hljs-number">2</span>));<br><br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">1</span>);<br><br><span class="hljs-type">float</span> data[] = &#123;<br><span class="hljs-number">1.0f</span>,<span class="hljs-number">-1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">0.0f</span>,<br><span class="hljs-number">-1.0f</span>,<span class="hljs-number">-1.0f</span>,<span class="hljs-number">0.0f</span>,<span class="hljs-number">0.0f</span>,<br><span class="hljs-number">-1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">0.0f</span>,<span class="hljs-number">1.0f</span>,<br><span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span><br>&#125;;<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(data), data, GL_STATIC_DRAW);<br><br>TextureData tdata = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/hawk.png&quot;</span>);<br><br><span class="hljs-built_in">glGenTextures</span>( <span class="hljs-number">1</span>, &amp;hawk_texture );<br><span class="hljs-built_in">glBindTexture</span>( GL_TEXTURE_2D, hawk_texture);<br><span class="hljs-built_in">glTexImage2D</span>( GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA32F, tdata.width, tdata.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tdata.data );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST );<br><span class="hljs-built_in">glTexParameteri</span>( GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST );<br><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nNote : Use Right Click Menu to switch Effect\n&quot;</span>);<br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////</span><br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><br><span class="hljs-type">float</span> f_timer_cnt = timer_cnt / <span class="hljs-number">255.0f</span>;<br><br><br><span class="hljs-built_in">glUniform1i</span>(Shader_now_Loc,shader_now);<br><span class="hljs-built_in">glUniformMatrix4fv</span>(um4mvp, <span class="hljs-number">1</span>, GL_FALSE, <span class="hljs-built_in">value_ptr</span>(mvp));<br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_FAN, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br><br><span class="hljs-type">float</span> viewportAspect = (<span class="hljs-type">float</span>)width / (<span class="hljs-type">float</span>)height;<br>mvp = <span class="hljs-built_in">ortho</span>(<span class="hljs-number">-1</span> * viewportAspect, <span class="hljs-number">1</span> * viewportAspect, <span class="hljs-number">-1.0f</span>, <span class="hljs-number">1.0f</span>);<br>mvp = mvp * <span class="hljs-built_in">lookAt</span>(<span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>timer_cnt++;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-keyword">if</span>(timer_enabled)<br>&#123;<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, val);<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Menu</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">switch</span>(id)<br>&#123;<br><span class="hljs-keyword">case</span> MENU_TIMER_START:<br><span class="hljs-keyword">if</span>(!timer_enabled)<br>&#123;<br>timer_enabled = <span class="hljs-literal">true</span>;<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> MENU_TIMER_STOP:<br>timer_enabled = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> MENU_EXIT:<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Shader_Blur:<br>shader_now = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Shader_Quantization:<br>shader_now = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> Shader_DoG:<br>shader_now = <span class="hljs-number">2</span>;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(defalut_w, defalut_h);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Create a menu and bind it to mouse right button.</span><br><span class="hljs-comment">////////////////////////////</span><br><span class="hljs-type">int</span> menu_main = <span class="hljs-built_in">glutCreateMenu</span>(My_Menu);<br><span class="hljs-type">int</span> menu_timer = <span class="hljs-built_in">glutCreateMenu</span>(My_Menu);<br><span class="hljs-type">int</span> shader = <span class="hljs-built_in">glutCreateMenu</span>(My_Menu);<br><br><span class="hljs-built_in">glutSetMenu</span>(menu_main);<br><span class="hljs-built_in">glutAddSubMenu</span>(<span class="hljs-string">&quot;Timer&quot;</span>, menu_timer);<br><span class="hljs-built_in">glutAddSubMenu</span>(<span class="hljs-string">&quot;Shader&quot;</span>, shader);<br><br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Exit&quot;</span>, MENU_EXIT);<br><br><span class="hljs-built_in">glutSetMenu</span>(menu_timer);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Start&quot;</span>, MENU_TIMER_START);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Stop&quot;</span>, MENU_TIMER_STOP);<br><br><span class="hljs-built_in">glutSetMenu</span>(shader);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Blur&quot;</span>, Shader_Blur);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Quantization&quot;</span>, Shader_Quantization);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;DoG&quot;</span>, Shader_DoG);<br><br><span class="hljs-built_in">glutSetMenu</span>(menu_main);<br><span class="hljs-built_in">glutAttachMenu</span>(GLUT_RIGHT_BUTTON);<br><span class="hljs-comment">////////////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutTimerFunc</span>(timer_speed, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>VLSI</title>
    <link href="/notes/2024/10/13/vlsi/"/>
    <url>/notes/2024/10/13/vlsi/</url>
    
    <content type="html"><![CDATA[<p>Assert-High Swtich: 輸入邏輯 1 電路會 close，導通<br>Assert-Low Swtich: 輸入邏輯 0 電路會 close，導通 </p><h1 id="MOSFET"><a href="#MOSFET" class="headerlink" title="MOSFET"></a>MOSFET</h1><p>Metal + Oxide-Semiconductor Field Effect Transitor</p><p>N channel MOSFET (nFET) 是 assert-high switch，也稱 N-MOS<br>P channel MOSFET (pFET) 是 assert-low switch，也稱 P-MOS</p><h3 id="電壓對應-Boolean-值"><a href="#電壓對應-Boolean-值" class="headerlink" title="電壓對應 Boolean 值"></a>電壓對應 Boolean 值</h3><p>當電壓大於某個值，一律判斷成邏輯 1，小於某個值判斷成邏輯 0，中間的區域叫做 noise margin。noise margin 越小越容易誤判</p><h3 id="P-N-Junctions"><a href="#P-N-Junctions" class="headerlink" title="P-N Junctions"></a>P-N Junctions</h3><p>p-type 半導體電洞多，n-type 半導體電子多。兩者接在一起會讓電子電洞傾向互相吸引，然而實際上受到電廠影響，僅有少數電子電洞相吸。</p><p>P-N Junctions 的特性是，施加外加電壓後，<strong>電流只能從 P 端流向 N 端</strong>。當給予 P 端正電、給予 N 端負電，N 端的電子會受到正電吸引、P 端的電動會受到負電吸引，兩者都往反方向衝，產生 <strong>P 流向 N 的電流</strong>。然而如果我們是給 P 端負電、N 端正電，就不會有電流產生。</p><h2 id="nFET-nMOS"><a href="#nFET-nMOS" class="headerlink" title="nFET (nMOS)"></a>nFET (nMOS)</h2><p>Source 接地，Drain 給高電壓 ($V_{DD}$)<br>Source 和 Drain 都接到一個帶很多電子 (n) 的東西，然後整個 body 是 p 型半導體<br>Strong Logic 0, Weak Logic 1</p><h2 id="pFET-pMOS"><a href="#pFET-pMOS" class="headerlink" title="pFET (pMOS)"></a>pFET (pMOS)</h2><p>都跟 nFET 相反</p><h2 id="Gate-Level"><a href="#Gate-Level" class="headerlink" title="Gate Level"></a>Gate Level</h2><h3 id="Not-Gate"><a href="#Not-Gate" class="headerlink" title="Not Gate"></a>Not Gate</h3><p><img src="https://i.sstatic.net/DULlo.png" alt="not gate"></p><h3 id="我可以先把-Nand、Nor-之類的-用-pMOS、nMOS-的作法做出，記熟一點"><a href="#我可以先把-Nand、Nor-之類的-用-pMOS、nMOS-的作法做出，記熟一點" class="headerlink" title="我可以先把 Nand、Nor 之類的 用 pMOS、nMOS 的作法做出，記熟一點"></a>我可以先把 Nand、Nor 之類的 用 pMOS、nMOS 的作法做出，記熟一點</h3><p>一端是串聯、一端並聯</p><h1 id="Physics-Structure"><a href="#Physics-Structure" class="headerlink" title="Physics Structure"></a>Physics Structure</h1><h2 id="Add-more-layers"><a href="#Add-more-layers" class="headerlink" title="Add more layers"></a>Add more layers</h2><p>先加 insulating glass<br>再 CMP (chemical-mechanical planarization)，磨平<br>最後加上金屬層</p><p>low-k: 電容很快就充滿<br>critical path: 最長的那條，會用 low-k 來加速</p><h2 id="絕緣層"><a href="#絕緣層" class="headerlink" title="絕緣層"></a>絕緣層</h2><p>t_ox 如果越小，代表絕緣層厚度越小，因此上下的吸引力會越大，導致電容變大<br>A_g: 面積，w * L<br>1:15:20 current voltage equation 推導</p><p>active contact: metal to drain&#x2F;source (鎢)<br>gate contact : metal to gate<br>via: metal to metal (銅)</p><h3 id="會考-IR-drop-是啥"><a href="#會考-IR-drop-是啥" class="headerlink" title="會考 IR drop 是啥"></a>會考 IR drop 是啥</h3><h3 id="會考-semantic-轉-layout、layout-轉-semantic"><a href="#會考-semantic-轉-layout、layout-轉-semantic" class="headerlink" title="會考 semantic 轉 layout、layout 轉 semantic"></a>會考 semantic 轉 layout、layout 轉 semantic</h3><p>要注意 n-well 的位置<br>先試試看畫出 inverter<br>Nor2 或 Nand2，然後要注意 3 個 input 版本的 <strong>並聯</strong> 部分<br>AOI</p><h3 id="要會看-stick-layout"><a href="#要會看-stick-layout" class="headerlink" title="要會看 stick layout"></a>要會看 stick layout</h3><h3 id="要看的懂-Euler-graph-WTFㄑ"><a href="#要看的懂-Euler-graph-WTFㄑ" class="headerlink" title="要看的懂 Euler graph (WTFㄑ"></a>要看的懂 Euler graph (WTFㄑ</h3><h1 id="Fabrication"><a href="#Fabrication" class="headerlink" title="Fabrication"></a>Fabrication</h1><p>把矽晶柱切成一片一片，然後 polish<br>產線會需要好幾個禮拜，沒辦法一次做完</p><h4 id="為什麼晶圓是圓的"><a href="#為什麼晶圓是圓的" class="headerlink" title="為什麼晶圓是圓的"></a>為什麼晶圓是圓的</h4><ol><li>方形的話邊邊角角會撞到，良率 (yeild) 降低</li><li>邊邊角角其實不太能用，之後會講</li></ol><h4 id="良率-Yeild"><a href="#良率-Yeild" class="headerlink" title="良率 Yeild"></a>良率 Yeild</h4><p>如果做出來完全不能用，直接丟掉<br>如果做出來不符合規格，可以以更低價錢賣出<br>為了提升良率，有時候會把導線之間做寬一點，提升容錯率，但會犧牲 Area 或 Power，讓整體面積更大</p><p>$Y &#x3D; e^{-\sqrt{DA}}$</p><ul><li>A: area，晶圓的面積</li><li>D: defect density，根據過往的統計資料</li></ul><h2 id="Silicon-Dioxide"><a href="#Silicon-Dioxide" class="headerlink" title="Silicon Dioxide"></a>Silicon Dioxide</h2><p>使用在 substrate 和 gate 之間</p><p>Thermal oxide，加熱讓 Si 和 O2 變成 SiO2，但會很花時間，還會吃掉原本的 Si<br>Wet oxidation Si + 2H2O -&gt; SiO2 + 2H2，比較快但也很花時間<br>Deposited on the top (CVD oxide)，省時間，並且是拿另外的 Si 來用，附著在 substrate 上<br>厚度不同</p><h2 id="Silicon-Nitride-氮"><a href="#Silicon-Nitride-氮" class="headerlink" title="Silicon Nitride (氮)"></a>Silicon Nitride (氮)</h2><p>用於 Final protective<br>光阻劑，避免蝕刻破壞<br>決定你下面對應的 active region 有多大</p><h2 id="Polysilicon"><a href="#Polysilicon" class="headerlink" title="Polysilicon"></a>Polysilicon</h2><p>結晶都是一塊一塊的，所以叫做 Polycrystal silicon 或 polysilicon<br>加入 Ti、Pt 降低 sheet resistance</p><h2 id="Metal"><a href="#Metal" class="headerlink" title="Metal"></a>Metal</h2><p>通常用 Aluminium，附著性很好且很好做 pattern<br>會有 electromigration (EM) 的問題，也就是 Wire 的老化</p><h3 id="EM"><a href="#EM" class="headerlink" title="EM"></a>EM</h3><p>因為電子不斷從同個方向往另一端流，導致電子離開那端的導線產生 voids，越來越細甚至斷掉，充飽所需的電量可能有差<br>另一端會產生 Hillocks，導線會變大，可能會碰到別的導線導致 short<br>要控制 Current density J 不能太大，因此導線寬度不能太小</p><p>後來大部分改用 Copper，比較不會有 EM 的問題</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Graphcis Programming and Application Lecture Program 解析</title>
    <link href="/notes/2024/10/06/gpa-lecture-program/"/>
    <url>/notes/2024/10/06/gpa-lecture-program/</url>
    
    <content type="html"><![CDATA[<h1 id="Alienrain"><a href="#Alienrain" class="headerlink" title="Alienrain"></a>Alienrain</h1><h2 id="前置作業和-Shaders"><a href="#前置作業和-Shaders" class="headerlink" title="前置作業和 Shaders"></a>前置作業和 Shaders</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">float</span> <span class="hljs-title">random_float</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">float</span> res;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tmp;<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> seed = <span class="hljs-number">0x13371337</span>;<br>seed *= <span class="hljs-number">16807</span>;<br><br>tmp = seed ^ (seed &gt;&gt; <span class="hljs-number">4</span>) ^ (seed &lt;&lt; <span class="hljs-number">15</span>);<br><br>*((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *) &amp;res) = (tmp &gt;&gt; <span class="hljs-number">9</span>) | <span class="hljs-number">0x3F800000</span>;<br><br><span class="hljs-keyword">return</span> (res - <span class="hljs-number">1.0f</span>);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                      \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 1) in int alien_index;                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;out VS_OUT                                                             \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    flat int alien;                                                    \n&quot;</span><br><span class="hljs-string">&quot;    vec2 tc;                                                           \n&quot;</span><br><span class="hljs-string">&quot;&#125; vs_out;                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;layout(std140) uniform droplets                                        \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    vec4 droplet[256];                                                 \n&quot;</span><br><span class="hljs-string">&quot;&#125;;                                                                     \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                        \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    const vec2[4] position = vec2[4](vec2(-0.5, -0.5),                 \n&quot;</span><br><span class="hljs-string">&quot;                                     vec2( 0.5, -0.5),                 \n&quot;</span><br><span class="hljs-string">&quot;                                     vec2(-0.5,  0.5),                 \n&quot;</span><br><span class="hljs-string">&quot;                                     vec2( 0.5,  0.5));                \n&quot;</span><br>    <span class="hljs-string">&quot;    const vec2[4] texcoord = vec2[4](vec2(0, 0),                       \n&quot;</span><br>    <span class="hljs-string">&quot;                                     vec2(1, 0),                       \n&quot;</span><br>    <span class="hljs-string">&quot;                                     vec2(0, 1),                       \n&quot;</span><br>    <span class="hljs-string">&quot;                                     vec2(1, 1));                      \n&quot;</span><br>    <span class="hljs-string">&quot;    vs_out.tc = texcoord[gl_VertexID];                                 \n&quot;</span><br><span class="hljs-string">&quot;    float co = cos(droplet[alien_index].z);                            \n&quot;</span><br><span class="hljs-string">&quot;    float so = sin(droplet[alien_index].z);                            \n&quot;</span><br><span class="hljs-string">&quot;    mat2 rot = mat2(vec2(co, so),                                      \n&quot;</span><br><span class="hljs-string">&quot;                    vec2(-so, co));                                    \n&quot;</span><br><span class="hljs-string">&quot;    vec2 pos = 0.25 * rot * position[gl_VertexID];                     \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = vec4(pos + droplet[alien_index].xy, 0.5, 1.0);       \n&quot;</span><br><span class="hljs-string">&quot;    vs_out.alien = int(mod(float(alien_index), 64.0));          \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                      \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                      \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 0) out vec4 color;                                  \n&quot;</span> <span class="hljs-comment">// 輸出顏色的名字是可以隨便取的，重點是要在 location = 0 (預設也是)</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;in VS_OUT                                                              \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    flat int alien;                                                    \n&quot;</span><br><span class="hljs-string">&quot;    vec2 tc;                                                           \n&quot;</span><br><span class="hljs-string">&quot;&#125; fs_in;                                                               \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2DArray tex_aliens;                                     \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                        \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    color = texture(tex_aliens, vec3(fs_in.tc, float(fs_in.alien)));   \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                      \n&quot;</span><br>&#125;;<br><br>GLuint          program;<br>GLuint          vao;<br>GLuint          tex_alien_array;<br>GLuint          rain_buffer;<br><br><span class="hljs-type">float</span>           droplet_x_offset[<span class="hljs-number">256</span>];<br><span class="hljs-type">float</span>           droplet_rot_speed[<span class="hljs-number">256</span>];<br><span class="hljs-type">float</span>           droplet_fall_speed[<span class="hljs-number">256</span>];<br><br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv); <span class="hljs-comment">// GLUT INIT，最一開始一定要</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER <span class="hljs-comment">// 微軟的預設編譯器 (MS: Microsoft，C: C 語言， VER: Version)</span></span><br>    <span class="hljs-comment">// 要使用 RGBA color mode、Dobule-buffered 的 Window，還要啟動 Depth Buffer 來進行深度測試</span><br><span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span> <span class="hljs-comment">// 如果是用其他編譯器</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH); <span class="hljs-comment">//先不管 應該差不多</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 視窗出現的位置</span><br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>); <span class="hljs-comment">// 視窗的長寬</span><br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// 視窗的名稱（一定要這行！不然不能跑）</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>(); <span class="hljs-comment">// glew init</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-built_in">printGLContextInfo</span>(); <span class="hljs-comment">// custom function</span><br><span class="hljs-built_in">My_Init</span>(); <span class="hljs-comment">// custom function</span><br><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display); <span class="hljs-comment">// GLUT 的 callback function，也就是視窗顯示的東西</span><br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape); <span class="hljs-comment">// 視窗 resize 會 call 的 function</span><br><br>    <span class="hljs-comment">// glutTimerFunc(msecs,(*func)(int value), int value);，</span><br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, <span class="hljs-number">0</span>); <span class="hljs-comment">// 計時器，16 毫秒後會 call MY_Timer</span><br><br><span class="hljs-built_in">glutMainLoop</span>(); <span class="hljs-comment">// 進入 GLUT loop</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>); <span class="hljs-comment">// 把視窗變成白色</span><br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST); <span class="hljs-comment">// 啟動深度測試</span><br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL); <span class="hljs-comment">// GL_LEQUAL: 如果新的片段的深度直 &lt;= 當前的片段深度值，那就可以蓋過去</span><br><br>program = <span class="hljs-built_in">glCreateProgram</span>(); <span class="hljs-comment">// 新增一個 shader program，回傳 GLuint ID</span><br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER); <span class="hljs-comment">// 宣告他是 Fragment Shader</span><br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// 寫入 shader 的內容</span><br><span class="hljs-built_in">glCompileShader</span>(fs); <span class="hljs-comment">// 把 shader 編譯成 GPU 可執行的程式</span><br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs); <span class="hljs-comment">// 綁定到 shader program</span><br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br>    <span class="hljs-built_in">printGLShaderLog</span>(vs); <span class="hljs-comment">// custom function，寫在 common.h 裡面</span><br>    <span class="hljs-built_in">printGLShaderLog</span>(fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program); <span class="hljs-comment">// link shader program</span><br><span class="hljs-built_in">glUseProgram</span>(program); <span class="hljs-comment">// 啟動這個 program</span><br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao); <span class="hljs-comment">// glGenVertexArrays( vao 數量, vao GLuint ID)，生成 vao</span><br><span class="hljs-built_in">glBindVertexArray</span>(vao); <span class="hljs-comment">// 綁定到 vao，這樣之後才能寫入 attribute，像是 glVertexAttribI1i(1, alien_index);</span><br><br>TextureData tex = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/aliens.png&quot;</span>); <span class="hljs-comment">// custom function，回傳 TextureData，包含高、寬、字元</span><br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;tex_alien_array); <span class="hljs-comment">// 生成 texture，寫 ID 到 text_alien_array</span><br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D_ARRAY, tex_alien_array); <span class="hljs-comment">// 綁定這個 ID，這邊用 GL_TEXTURE_2D_ARRAY，之後寫入宣告 GL_TEXTURE_2D_ARRAY 都會到對應的 ID</span><br><br>    <span class="hljs-comment">// glTexImage3D(target, mipnap level, internalformat, width, height, depth, border, format, type, * data);</span><br><span class="hljs-built_in">glTexImage3D</span>(GL_TEXTURE_2D_ARRAY, <span class="hljs-number">0</span>, GL_RGBA, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">64</span>, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex.data); <span class="hljs-comment">// 這邊 tex.data 是 256 * 16384，一次全 load 到 3D image 節省效能</span><br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D_ARRAY,GL_TEXTURE_MIN_FILTER,GL_LINEAR); <span class="hljs-comment">// 設定縮小時要用 線性內插 的方式生成</span><br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D_ARRAY,GL_TEXTURE_MAG_FILTER,GL_LINEAR); <span class="hljs-comment">// 放大時也用 線性內插</span><br><span class="hljs-keyword">delete</span>[] tex.data;<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;rain_buffer); <span class="hljs-comment">// 生成 buffer，綁到 rain_buffer 這個 ID</span><br><span class="hljs-built_in">glBindBuffer</span>(GL_UNIFORM_BUFFER, rain_buffer); <span class="hljs-comment">// 綁定 ID 是 GL_UNIFORM_BUFFER</span><br><br>    <span class="hljs-comment">// glBufferData(target, size, data, usage)</span><br><span class="hljs-built_in">glBufferData</span>(GL_UNIFORM_BUFFER, <span class="hljs-number">256</span> * <span class="hljs-built_in">sizeof</span>(vec4), <span class="hljs-literal">NULL</span>, GL_DYNAMIC_DRAW); <span class="hljs-comment">// 初始化這個 rain_buffer，</span><br><br>    <span class="hljs-comment">// glBindBufferBase(target,  index,  buffer);</span><br><span class="hljs-built_in">glBindBufferBase</span>(GL_UNIFORM_BUFFER, <span class="hljs-number">0</span>, rain_buffer); <span class="hljs-comment">// 連連看，buffer 連到 binding point index 0</span><br><br>    <span class="hljs-comment">// 初始化位置、旋轉、速度</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++)<br>&#123;<br>droplet_x_offset[i] = <span class="hljs-built_in">random_float</span>() * <span class="hljs-number">2.0f</span> - <span class="hljs-number">1.0f</span>;<br>droplet_rot_speed[i] = (<span class="hljs-built_in">random_float</span>() + <span class="hljs-number">0.5f</span>) * ((i &amp; <span class="hljs-number">1</span>) ? <span class="hljs-number">-3.0f</span> : <span class="hljs-number">3.0f</span>);<br>droplet_fall_speed[i] = <span class="hljs-built_in">random_float</span>() + <span class="hljs-number">0.2f</span>;<br>&#125;<br><br><span class="hljs-built_in">glEnable</span>(GL_BLEND); <span class="hljs-comment">// 啟用混合功能，可以加入透明度</span><br><span class="hljs-built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA); <span class="hljs-comment">//如何混合的，源顏色的值 * alpha，目標顏色的值 * (1- 源顏色 alpha)</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT); <span class="hljs-comment">// 清除顏色、深度</span><br><br><span class="hljs-type">float</span> currentTime = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME) * <span class="hljs-number">0.001f</span>; <span class="hljs-comment">// glutGet(GLUT_ELAPSED_TIME) 可以得到程式從開始到現在的時間 (毫秒</span><br><br>    <span class="hljs-comment">// glMapBufferRange(target, offset, length, access)</span><br>    <span class="hljs-comment">// 這裡的 GL_UNIFORM_BUFFER 就是對應到前面寫的 rain_buffer</span><br>    <span class="hljs-comment">// GL_MAP_WRITE_BIT: 允許寫入 map 到的 memory</span><br>    <span class="hljs-comment">// GL_MAP_INVALIDATE_BUFFER_BIT: map 前的內容可以被捨棄</span><br>vec4 * droplet = (vec4 *)<span class="hljs-built_in">glMapBufferRange</span>(GL_UNIFORM_BUFFER, <span class="hljs-number">0</span>, <span class="hljs-number">256</span> * <span class="hljs-built_in">sizeof</span>(vec4), GL_MAP_WRITE_BIT | GL_MAP_INVALIDATE_BUFFER_BIT);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++)<br>&#123;<br>droplet[i][<span class="hljs-number">0</span>] = droplet_x_offset[i];<br>        droplet[i][<span class="hljs-number">1</span>] = <span class="hljs-number">2.0f</span> - <span class="hljs-built_in">fmodf</span>((currentTime + <span class="hljs-built_in">float</span>(i)) * droplet_fall_speed[i], <span class="hljs-number">4.31f</span>);<br>        droplet[i][<span class="hljs-number">2</span>] = currentTime * droplet_rot_speed[i];<br>droplet[i][<span class="hljs-number">3</span>] = <span class="hljs-number">0.0f</span>; <span class="hljs-comment">// padding</span><br>&#125;<br><span class="hljs-built_in">glUnmapBuffer</span>(GL_UNIFORM_BUFFER); <span class="hljs-comment">// 提交到 GPU</span><br><br><span class="hljs-type">int</span> alien_index;<br><span class="hljs-keyword">for</span> (alien_index = <span class="hljs-number">0</span>; alien_index &lt; <span class="hljs-number">256</span>; alien_index++)<br>&#123;<br><span class="hljs-built_in">glVertexAttribI1i</span>(<span class="hljs-number">1</span>, alien_index); <span class="hljs-comment">// location = 1,</span><br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_STRIP, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// 從 0 開始畫四個 vertex</span><br>&#125;<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glutPostRedisplay</span>(); <span class="hljs-comment">// 重畫</span><br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, val);<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="Simple-Texture-Coords"><a href="#Simple-Texture-Coords" class="headerlink" title="Simple_Texture_Coords"></a>Simple_Texture_Coords</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br>GLuint          program;<br>GLuint          tex_object[<span class="hljs-number">2</span>];<br>GLuint          tex_index;<br><span class="hljs-type">int</span> index_count;<br><span class="hljs-type">int</span> vertex_count;<br><span class="hljs-keyword">struct</span><br>&#123;<br>    GLint       mv_matrix;<br>    GLint       proj_matrix;<br>&#125; uniforms;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *render_fs_glsl[] =<br>&#123;<br>    <span class="hljs-string">&quot;#version 410 core                                            \n&quot;</span><br>    <span class="hljs-string">&quot;                                                             \n&quot;</span><br>    <span class="hljs-string">&quot;uniform sampler2D tex_object;                                \n&quot;</span><br>    <span class="hljs-string">&quot;                                                             \n&quot;</span><br>    <span class="hljs-string">&quot;in VS_OUT                                                    \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    vec2 tc;                                                 \n&quot;</span><br>    <span class="hljs-string">&quot;&#125; fs_in;                                                     \n&quot;</span><br>    <span class="hljs-string">&quot;                                                             \n&quot;</span><br>    <span class="hljs-string">&quot;out vec4 color;                                              \n&quot;</span><br>    <span class="hljs-string">&quot;                                                             \n&quot;</span><br>    <span class="hljs-string">&quot;void main(void)                                              \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    color = texture(tex_object, fs_in.tc * vec2(3.0, 1.0));  \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                                            \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *render_vs_glsl[] =<br>&#123;<br>    <span class="hljs-string">&quot;#version 410 core                            \n&quot;</span><br>    <span class="hljs-string">&quot;                                             \n&quot;</span><br>    <span class="hljs-string">&quot;uniform mat4 mv_matrix;                      \n&quot;</span><br>    <span class="hljs-string">&quot;uniform mat4 proj_matrix;                    \n&quot;</span><br>    <span class="hljs-string">&quot;                                             \n&quot;</span><br>    <span class="hljs-string">&quot;layout (location = 0) in vec3 position;      \n&quot;</span><br>    <span class="hljs-string">&quot;layout (location = 1) in vec2 tc;            \n&quot;</span><br>    <span class="hljs-string">&quot;                                             \n&quot;</span><br>    <span class="hljs-string">&quot;out VS_OUT                                   \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    vec2 tc;                                 \n&quot;</span><br>    <span class="hljs-string">&quot;&#125; vs_out;                                    \n&quot;</span><br>    <span class="hljs-string">&quot;                                             \n&quot;</span><br>    <span class="hljs-string">&quot;void main(void)                              \n&quot;</span><br>    <span class="hljs-string">&quot;&#123;                                            \n&quot;</span><br>    <span class="hljs-string">&quot;    vec4 pos_vs = mv_matrix * vec4(position, 1.0);      \n&quot;</span><br>    <span class="hljs-string">&quot;                                             \n&quot;</span><br>    <span class="hljs-string">&quot;    vs_out.tc = tc;                          \n&quot;</span><br>    <span class="hljs-string">&quot;                                             \n&quot;</span><br>    <span class="hljs-string">&quot;    gl_Position = proj_matrix * pos_vs;      \n&quot;</span><br>    <span class="hljs-string">&quot;&#125;                                            \n&quot;</span><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, render_fs_glsl, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, render_vs_glsl, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><span class="hljs-built_in">printGLShaderLog</span>(vs);<br><span class="hljs-built_in">printGLShaderLog</span>(fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><span class="hljs-built_in">glUseProgram</span>(program);<br><br>    uniforms.mv_matrix = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;mv_matrix&quot;</span>);<br>    uniforms.proj_matrix = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;proj_matrix&quot;</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> B 0x00, 0x00, 0x00, 0x00</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> W 0xFF, 0xFF, 0xFF, 0xFF</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLubyte tex_data[] =<br>    &#123;<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>        B, W, B, W, B, W, B, W, B, W, B, W, B, W, B, W,<br>        W, B, W, B, W, B, W, B, W, B, W, B, W, B, W, B,<br>    &#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> B</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> W</span><br><br>    <span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;tex_object[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, tex_object[<span class="hljs-number">0</span>]);<br><br><span class="hljs-comment">// void glTexImage2D(</span><br><span class="hljs-comment">//  GLenum target,</span><br><span class="hljs-comment">// GLint level,</span><br><span class="hljs-comment">// GLint internalformat,</span><br><span class="hljs-comment">// GLsizei width,</span><br><span class="hljs-comment">// GLsizei height,</span><br><span class="hljs-comment">// GLint border,</span><br><span class="hljs-comment">// GLenum format,</span><br><span class="hljs-comment">// GLenum type,</span><br><span class="hljs-comment">// const void * data</span><br><span class="hljs-comment">//);</span><br>    <span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGB, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">glTexSubImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex_data);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);<br><br><span class="hljs-comment">// load</span><br>    TextureData tex = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/pattern1.png&quot;</span>);<br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;tex_object[<span class="hljs-number">1</span>]);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, tex_object[<span class="hljs-number">1</span>]);<br><span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, tex.width, tex.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex.data);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);<br><br><span class="hljs-comment">//  // (1) nearest-neighbor filtering</span><br><span class="hljs-comment">//  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);</span><br><span class="hljs-comment">//  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);</span><br><span class="hljs-comment">//  // (2) or bilinear filtering</span><br><span class="hljs-comment">//  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="hljs-comment">//  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</span><br><span class="hljs-comment">//  // (3) or bilinear filtering with mipmapping</span><br><span class="hljs-comment">//  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</span><br><span class="hljs-comment">//  glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);</span><br><span class="hljs-comment">//  glGenerateMipmap(GL_TEXTURE_2D);</span><br><br>vector&lt;MeshData&gt; meshes;<br>meshes = <span class="hljs-built_in">loadObj</span>(<span class="hljs-string">&quot;../../Media/Objects/torus_nrms_tc.obj&quot;</span>);<br><br>GLuint vao;<br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br>GLuint position_buffer;<br>GLuint texcoord_buffer;<br>GLuint index_buffer;<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;position_buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, position_buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, meshes[<span class="hljs-number">0</span>].positions.<span class="hljs-built_in">size</span>() * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>), meshes[<span class="hljs-number">0</span>].positions.<span class="hljs-built_in">data</span>(), GL_STATIC_DRAW);<br><br><br><span class="hljs-comment">// glVertexAttribPointer(GLuint index, GLint size, GLenum type, GLboolean normalized, GLsizei stride, const void * pointer);</span><br><span class="hljs-comment">// index: attribute 位置 (location = 0)</span><br><span class="hljs-comment">// size: vec3</span><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 啟動</span><br><br>vertex_count = meshes[<span class="hljs-number">0</span>].positions.<span class="hljs-built_in">size</span>() / <span class="hljs-number">3</span>;<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;texcoord_buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, texcoord_buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, meshes[<span class="hljs-number">0</span>].texcoords.<span class="hljs-built_in">size</span>() * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>), meshes[<span class="hljs-number">0</span>].texcoords.<span class="hljs-built_in">data</span>(), GL_STATIC_DRAW);<br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">1</span>);<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;index_buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ELEMENT_ARRAY_BUFFER, index_buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ELEMENT_ARRAY_BUFFER, meshes[<span class="hljs-number">0</span>].indices.<span class="hljs-built_in">size</span>() * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>), meshes[<span class="hljs-number">0</span>].indices.<span class="hljs-built_in">data</span>(), GL_STATIC_DRAW);<br>index_count = meshes[<span class="hljs-number">0</span>].indices.<span class="hljs-built_in">size</span>();<br><br>    <span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br>    <span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat gray[] = &#123; <span class="hljs-number">0.2f</span>, <span class="hljs-number">0.2f</span>, <span class="hljs-number">0.2f</span>, <span class="hljs-number">1.0f</span> &#125;;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat ones[] = &#123; <span class="hljs-number">1.0f</span> &#125;;<br><br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, gray);<br>    <span class="hljs-built_in">glClearBufferfv</span>(GL_DEPTH, <span class="hljs-number">0</span>, ones);<br><br><span class="hljs-type">float</span> currentTime = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME) * <span class="hljs-number">0.001f</span>;<br><br>    <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, tex_object[tex_index]);<br><br>    <span class="hljs-built_in">glUseProgram</span>(program);<br><br>    mat4 proj_matrix = <span class="hljs-built_in">perspective</span>(<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">60.0f</span>), <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.1f</span>, <span class="hljs-number">1000.0f</span>);<br>    mat4 mv_matrix = <span class="hljs-built_in">translate</span>(<span class="hljs-built_in">mat4</span>(<span class="hljs-number">1.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">-3.0f</span>)) *<br>                            <span class="hljs-built_in">rotate</span>(<span class="hljs-built_in">mat4</span>(<span class="hljs-number">1.0f</span>), <span class="hljs-built_in">deg2rad</span>((<span class="hljs-type">float</span>)currentTime * <span class="hljs-number">19.3f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>)) *<br>                            <span class="hljs-built_in">rotate</span>(<span class="hljs-built_in">mat4</span>(<span class="hljs-number">1.0f</span>), <span class="hljs-built_in">deg2rad</span>((<span class="hljs-type">float</span>)currentTime * <span class="hljs-number">21.1f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>));<br><br>    <span class="hljs-built_in">glUniformMatrix4fv</span>(uniforms.mv_matrix, <span class="hljs-number">1</span>, GL_FALSE, &amp;mv_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">glUniformMatrix4fv</span>(uniforms.proj_matrix, <span class="hljs-number">1</span>, GL_FALSE, &amp;proj_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br><span class="hljs-comment">// glDrawArrays or glDrawElements</span><br><span class="hljs-comment">// glDrawArrays(GL_TRIANGLES, 0, vertex_count);</span><br><span class="hljs-comment">// void glDrawElements(GLenum mode, GLsizei count, GLenum type, const void * indices);</span><br><span class="hljs-comment">// 告訴 shader 要抓哪些點組成三角形，index_count 每三個會一組</span><br><span class="hljs-comment">// 啊這裡前面已經綁定了 ELEMENT</span><br>    <span class="hljs-built_in">glDrawElements</span>(GL_TRIANGLES, index_count, GL_UNSIGNED_INT, <span class="hljs-number">0</span>);<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Keyboard</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> key, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">switch</span> (key)<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;T&#x27;</span>:<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;t&#x27;</span>:<br>            tex_index++;<br>            <span class="hljs-keyword">if</span> (tex_index &gt; <span class="hljs-number">1</span>)<br>                tex_index = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, val);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutKeyboardFunc</span>(My_Keyboard);<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Simple-Texture"><a href="#Simple-Texture" class="headerlink" title="Simple Texture"></a>Simple Texture</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                              \n&quot;</span><br><span class="hljs-string">&quot;    const vec4 vertices[] = vec4[](vec4( 0.75, -0.75, 0.5, 1.0),               \n&quot;</span><br><span class="hljs-string">&quot;                                   vec4(-0.75, -0.75, 0.5, 1.0),               \n&quot;</span><br><span class="hljs-string">&quot;                                   vec4( 0.75,  0.75, 0.5, 1.0));              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = vertices[gl_VertexID];                                       \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                              \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2D s;                                                           \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;                                                                \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                              \n&quot;</span><br><span class="hljs-string">&quot;    color = texelFetch(s, ivec2(gl_FragCoord.xy) - ivec2(75, 75), 0);          \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                              \n&quot;</span><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">generate_texture</span><span class="hljs-params">(<span class="hljs-type">float</span> * data, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">int</span> x, y;<br><br><span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; height; y++)<br>&#123;<br><span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; width; x++)<br>&#123;<br>data[(y * width + x) * <span class="hljs-number">4</span> + <span class="hljs-number">0</span>] = (<span class="hljs-type">float</span>)((x &amp; y) &amp; <span class="hljs-number">0xFF</span>) / <span class="hljs-number">255.0f</span>;<br>data[(y * width + x) * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] = (<span class="hljs-type">float</span>)((x | y) &amp; <span class="hljs-number">0xFF</span>) / <span class="hljs-number">255.0f</span>;<br>data[(y * width + x) * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] = (<span class="hljs-type">float</span>)((x ^ y) &amp; <span class="hljs-number">0xFF</span>) / <span class="hljs-number">255.0f</span>;<br>data[(y * width + x) * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] = <span class="hljs-number">1.0f</span>;<br>&#125;<br>&#125;<br>&#125;<br><br>GLuint          program;<br>GLuint          vao;<br>GLuinttexture;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br><span class="hljs-comment">// Generate a name for the texture</span><br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;texture);<br><br><span class="hljs-comment">// Now bind it to the context using the GL_TEXTURE_2D binding point</span><br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, texture);<br><br><span class="hljs-comment">// Define some data to upload into the texture</span><br><span class="hljs-type">float</span> * data = <span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[<span class="hljs-number">450</span> * <span class="hljs-number">450</span> * <span class="hljs-number">4</span>];<br><br><span class="hljs-comment">// generate_texture() is a function that fills memory with image data</span><br><span class="hljs-built_in">generate_texture</span>(data, <span class="hljs-number">450</span>, <span class="hljs-number">450</span>);<br><br><span class="hljs-comment">// Assume the texture is already bound to the GL_TEXTURE_2D target</span><br><span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D,  <span class="hljs-comment">// 2D texture</span><br><span class="hljs-number">0</span>,              <span class="hljs-comment">// Level 0</span><br>GL_RGBA,<br><span class="hljs-number">450</span>, <span class="hljs-number">450</span>,       <span class="hljs-comment">// 450 x 450 texels, replace entire image</span><br>        <span class="hljs-number">0</span>,<br>GL_RGBA,        <span class="hljs-comment">// Four channel data</span><br>GL_FLOAT,       <span class="hljs-comment">// Floating point data</span><br>data);          <span class="hljs-comment">// Pointer to data</span><br><br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br>    <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br><br><span class="hljs-comment">// Free the memory we allocated before - \GL now has our data</span><br><span class="hljs-keyword">delete</span> [] data;<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br>    <span class="hljs-built_in">printGLShaderLog</span>(vs);<br>    <span class="hljs-built_in">printGLShaderLog</span>(fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat green[] = &#123; <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.25f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> &#125;;<br><span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, green);<br><span class="hljs-built_in">glUseProgram</span>(program);<br><br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>);<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Single-Triangle-Buffer"><a href="#Single-Triangle-Buffer" class="headerlink" title="Single Triangle Buffer"></a>Single Triangle Buffer</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410                                                   \n&quot;</span><br><span class="hljs-string">&quot;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;layout(location = 0) in vec3 iv3vertex;                           \n&quot;</span><br><span class="hljs-string">&quot;layout(location = 1) in vec3 iv3color;                            \n&quot;</span><br><span class="hljs-string">&quot;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;out vec3 vv3color;                                                \n&quot;</span><br><span class="hljs-string">&quot;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                   \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                 \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = vec4(iv3vertex, 1.0);                           \n&quot;</span><br><span class="hljs-string">&quot;    vv3color = iv3color;                                          \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                 \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410                                               \n&quot;</span><br><span class="hljs-string">&quot;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;in vec3 vv3color;                                                 \n&quot;</span><br><span class="hljs-string">&quot;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;layout(location = 0) out vec4 fragColor;                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                   \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                 \n&quot;</span><br><span class="hljs-string">&quot;    fragColor = vec4(vv3color, 1.0);                              \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                 \n&quot;</span><br>&#125;;<br><br>GLuint program;<br>GLuint vao;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br>    GLuint buffer;<br>    <span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;buffer);<br>    <span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, buffer);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> data[<span class="hljs-number">18</span>] =<br>&#123;<br><span class="hljs-number">-0.5f</span>, <span class="hljs-number">-0.4f</span>, <span class="hljs-number">0.0f</span>,<span class="hljs-comment">//Position</span><br> <span class="hljs-number">0.5f</span>, <span class="hljs-number">-0.4f</span>, <span class="hljs-number">0.0f</span>,<br> <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0.6f</span>, <span class="hljs-number">0.0f</span>,<br><br> <span class="hljs-number">1.0f</span>,  <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>,<span class="hljs-comment">//Color</span><br> <span class="hljs-number">0.0f</span>,  <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>,<br> <span class="hljs-number">0.0f</span>,  <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span><br>&#125;;<br><br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(data), data, GL_STATIC_DRAW);<br><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, (<span class="hljs-type">void</span>*)(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) * <span class="hljs-number">9</span>));<span class="hljs-comment">//offset</span><br><br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><span class="hljs-built_in">glUseProgram</span>(program);<br>    <span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Spinning-Cube"><a href="#Spinning-Cube" class="headerlink" title="Spinning Cube"></a>Spinning Cube</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;in vec4 position;                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;out VS_OUT                                                         \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    vec4 color;                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#125; vs_out;                                                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;uniform mat4 mv_matrix;                                            \n&quot;</span><br><span class="hljs-string">&quot;uniform mat4 proj_matrix;                                          \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = proj_matrix * mv_matrix * position;              \n&quot;</span><br><span class="hljs-string">&quot;    vs_out.color = position * 2.0 + vec4(0.5, 0.5, 0.5, 0.0);      \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                  \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;                                                    \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;in VS_OUT                                                          \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    vec4 color;                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#125; fs_in;                                                           \n&quot;</span><br><span class="hljs-string">&quot;                                                                   \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                    \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                  \n&quot;</span><br><span class="hljs-string">&quot;    color = fs_in.color;                                           \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                  \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat vertex_positions[] =<br>&#123;<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><br><span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">-0.25f</span>, <span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span>,<br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><br><span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>,  <span class="hljs-number">0.25f</span>,<br><span class="hljs-number">-0.25f</span>,  <span class="hljs-number">0.25f</span>, <span class="hljs-number">-0.25f</span><br>&#125;;<br><br>GLuint          program;<br>GLuint          vao;<br>GLuint          buffer;<br>GLint           mv_location;<br>GLint           proj_location;<br><span class="hljs-function">mat4 <span class="hljs-title">proj_matrix</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br><span class="hljs-built_in">glGenBuffers</span>(<span class="hljs-number">1</span>, &amp;buffer);<br><span class="hljs-built_in">glBindBuffer</span>(GL_ARRAY_BUFFER, buffer);<br><span class="hljs-built_in">glBufferData</span>(GL_ARRAY_BUFFER, <span class="hljs-built_in">sizeof</span>(vertex_positions), vertex_positions, GL_STATIC_DRAW);<br><br><span class="hljs-built_in">glVertexAttribPointer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, GL_FLOAT, GL_FALSE, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glEnableVertexAttribArray</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-built_in">glEnable</span>(GL_CULL_FACE);<br><span class="hljs-built_in">glFrontFace</span>(GL_CW);<br><br>mv_location = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;mv_matrix&quot;</span>);<br>proj_location = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;proj_matrix&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat green[] = &#123; <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.25f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> &#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat one = <span class="hljs-number">1.0f</span>;<br><span class="hljs-built_in">glClearBufferfv</span>(GL_COLOR, <span class="hljs-number">0</span>, green);<br><span class="hljs-built_in">glClearBufferfv</span>(GL_DEPTH, <span class="hljs-number">0</span>, &amp;one);<br><br><span class="hljs-built_in">glUseProgram</span>(program);<br><br><span class="hljs-built_in">glUniformMatrix4fv</span>(proj_location, <span class="hljs-number">1</span>, GL_FALSE, &amp;proj_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br><span class="hljs-function">mat4 <span class="hljs-title">Identy_Init</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><span class="hljs-type">float</span> currentTime = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME) * <span class="hljs-number">0.001f</span>;<br>mat4 mv_matrix = <span class="hljs-built_in">translate</span>(Identy_Init, <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">-4.0f</span>));<br>    mv_matrix = <span class="hljs-built_in">translate</span>(mv_matrix, <span class="hljs-built_in">vec3</span>(<span class="hljs-built_in">sinf</span>(<span class="hljs-number">2.1f</span> * currentTime) * <span class="hljs-number">0.5f</span>, <span class="hljs-built_in">cosf</span>(<span class="hljs-number">1.7f</span> * currentTime) * <span class="hljs-number">0.5f</span>,<span class="hljs-built_in">sinf</span>(<span class="hljs-number">1.3f</span> * currentTime) * <span class="hljs-built_in">cosf</span>(<span class="hljs-number">1.5f</span> * currentTime) * <span class="hljs-number">2.0f</span>));<br>mv_matrix = <span class="hljs-built_in">rotate</span>(mv_matrix, <span class="hljs-built_in">deg2rad</span>(currentTime * <span class="hljs-number">45.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>));<br>mv_matrix = <span class="hljs-built_in">rotate</span>(mv_matrix, <span class="hljs-built_in">deg2rad</span>(currentTime * <span class="hljs-number">81.0f</span>), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>));<br><span class="hljs-built_in">glUniformMatrix4fv</span>(mv_location, <span class="hljs-number">1</span>, GL_FALSE, &amp;mv_matrix[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLES, <span class="hljs-number">0</span>, <span class="hljs-number">36</span>);<br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br><br><span class="hljs-type">float</span> viewportAspect = (<span class="hljs-type">float</span>)width / (<span class="hljs-type">float</span>)height;<br>proj_matrix = <span class="hljs-built_in">perspective</span>(<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">50.0f</span>), viewportAspect, <span class="hljs-number">0.1f</span>, <span class="hljs-number">100.0f</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, val);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Tunnel"><a href="#Tunnel" class="headerlink" title="Tunnel"></a>Tunnel</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> glm;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                      \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;out VS_OUT                                                             \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    vec2 tc;                                                           \n&quot;</span><br><span class="hljs-string">&quot;&#125; vs_out;                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;uniform mat4 mvp;                                                      \n&quot;</span><br><span class="hljs-string">&quot;uniform float offset;                                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                        \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    const vec2[4] position = vec2[4](vec2(-0.75, -0.75),               \n&quot;</span><br><span class="hljs-string">&quot;                                     vec2( 0.75, -0.75),               \n&quot;</span><br><span class="hljs-string">&quot;                                     vec2(-0.75,  0.75),               \n&quot;</span><br><span class="hljs-string">&quot;                                     vec2( 0.75,  0.75));              \n&quot;</span><br><span class="hljs-string">&quot;    vs_out.tc = (position[gl_VertexID].xy + vec2(offset, 0.5)) *       \n&quot;</span><br><span class="hljs-string">&quot;                vec2(30.0, 1.0);                                       \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = mvp * vec4(position[gl_VertexID], 0.0, 1.0);         \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                      \n&quot;</span><br><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                      \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;layout (location = 0) out vec4 color;                                  \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;in VS_OUT                                                              \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    vec2 tc;                                                           \n&quot;</span><br><span class="hljs-string">&quot;&#125; fs_in;                                                               \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2D tex;                                                 \n&quot;</span><br><span class="hljs-string">&quot;                                                                       \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                        \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                      \n&quot;</span><br><span class="hljs-string">&quot;    color = texture(tex, fs_in.tc);                                    \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                      \n&quot;</span><br>&#125;;<br><br>GLuint          program;<br>GLuint          vao;<br><span class="hljs-function">mat4  <span class="hljs-title">proj_matrix</span><span class="hljs-params">(<span class="hljs-number">1.0f</span>)</span></span>;<br><br><span class="hljs-keyword">struct</span><br>&#123;<br>GLint       mvp;<br>GLint       offset;<br>&#125; uniforms;<br><br>GLuint          tex_wall;<br>GLuint          tex_ceiling;<br>GLuint          tex_floor;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">FilterTypes</span><br>&#123;<br>NEAREST = <span class="hljs-number">1</span>,<br>LINEAR,<br>LINEAR_MIPMAP,<br>ANISOTROPIC<br>&#125;;<br><br><span class="hljs-type">float</span> maxAniso = <span class="hljs-number">1.0f</span>;<br><span class="hljs-type">bool</span> anisoSupport = <span class="hljs-literal">false</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (GL_EXT_texture_filter_anisotropic)<br>        anisoSupport = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// anisoSupport = glewIsSupported(&quot;GL_EXT_texture_filter_anisotropic&quot;);</span><br><span class="hljs-keyword">if</span>(anisoSupport)<br>&#123;<br><span class="hljs-built_in">glGetFloatv</span>(GL_MAX_TEXTURE_MAX_ANISOTROPY_EXT, &amp;maxAniso);<br>&#125;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Anisotropic Filtering is %ssupported\n&quot;</span>, anisoSupport ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;not &quot;</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Max Anisotropy: %.1f\n&quot;</span>, maxAniso);<br><br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br>uniforms.mvp = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;mvp&quot;</span>);<br>uniforms.offset = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;offset&quot;</span>);<br><br>TextureData tex = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/brick.png&quot;</span>);<br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;tex_wall);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, tex_wall);<br><span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, tex.width, tex.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex.data);<br><span class="hljs-built_in">glGenerateMipmap</span>(GL_TEXTURE_2D);<br><span class="hljs-keyword">delete</span>[] tex.data;<br><br>tex = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/ceiling.png&quot;</span>);<br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;tex_ceiling);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, tex_ceiling);<br><span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, tex.width, tex.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex.data);<br><span class="hljs-built_in">glGenerateMipmap</span>(GL_TEXTURE_2D);<br><span class="hljs-keyword">delete</span>[] tex.data;<br><br>tex = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/floor.png&quot;</span>);<br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;tex_floor);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, tex_floor);<br><span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, tex.width, tex.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex.data);<br><span class="hljs-built_in">glGenerateMipmap</span>(GL_TEXTURE_2D);<br><span class="hljs-keyword">delete</span>[] tex.data;<br><br><span class="hljs-type">int</span> i;<br>GLuint textures[] = &#123; tex_floor, tex_wall, tex_ceiling &#125;;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>&#123;<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><br><span class="hljs-type">float</span> currentTime = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME) * <span class="hljs-number">0.001f</span>;<br><br><span class="hljs-built_in">glUseProgram</span>(program);<br><br><span class="hljs-built_in">glUniform1f</span>(uniforms.offset, currentTime * <span class="hljs-number">0.003f</span>);<br><span class="hljs-function">mat4 <span class="hljs-title">Identy_Init</span><span class="hljs-params">(<span class="hljs-number">1.0</span>)</span></span>;<br><span class="hljs-type">int</span> i;<br>GLuint textures[] = &#123; tex_wall, tex_floor, tex_wall, tex_ceiling &#125;;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>&#123;<br>mat4 mv_matrix = <span class="hljs-built_in">rotate</span>(Identy_Init,<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">90.0f</span> * (<span class="hljs-type">float</span>)i), <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>));<br>mv_matrix = <span class="hljs-built_in">translate</span>(mv_matrix,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">-0.5f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">-10.0f</span>));<br>mv_matrix = <span class="hljs-built_in">rotate</span>(mv_matrix,<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">90.0f</span>),<span class="hljs-built_in">vec3</span>( <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">0.0f</span>));<br>mv_matrix = <span class="hljs-built_in">scale</span>(mv_matrix,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">50.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>));<br>mat4 mvp = proj_matrix * mv_matrix;<br><br><span class="hljs-built_in">glUniformMatrix4fv</span>(uniforms.mvp, <span class="hljs-number">1</span>, GL_FALSE, &amp;mvp[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]);<br><br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_STRIP, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>&#125;<br><br><span class="hljs-comment">//glDrawArrays(GL_TRIANGLES, 0, 3);</span><br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br><br><span class="hljs-type">float</span> viewportAspect = (<span class="hljs-type">float</span>)width / (<span class="hljs-type">float</span>)height;<br><br>proj_matrix = <span class="hljs-built_in">perspective</span>(<span class="hljs-built_in">deg2rad</span>(<span class="hljs-number">60.0f</span>), viewportAspect, <span class="hljs-number">0.1f</span>, <span class="hljs-number">1000.0f</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Timer</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glutPostRedisplay</span>();<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, val);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Menu</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>GLuint textures[] = &#123; tex_floor, tex_wall, tex_ceiling &#125;;<br><br><span class="hljs-keyword">if</span>(anisoSupport)<br>&#123;<br><span class="hljs-comment">// Reset to default 1.0</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>&#123;<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MAX_ANISOTROPY_EXT, <span class="hljs-number">1.0f</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(val == NEAREST)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>&#123;<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val == LINEAR)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>&#123;<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val == LINEAR_MIPMAP)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>&#123;<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val == ANISOTROPIC &amp;&amp; anisoSupport)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>&#123;<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, textures[i]);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);<br><span class="hljs-built_in">glTexParameterf</span>(GL_TEXTURE_2D, GL_TEXTURE_MAX_ANISOTROPY_EXT, maxAniso);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Create GLUT menu.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutCreateMenu</span>(My_Menu);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Nearest&quot;</span>, NEAREST);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Linear&quot;</span>, LINEAR);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Linear Mipmap&quot;</span>, LINEAR_MIPMAP);<br><span class="hljs-built_in">glutAddMenuEntry</span>(<span class="hljs-string">&quot;Anisotropic&quot;</span>, ANISOTROPIC);<br><span class="hljs-built_in">glutAttachMenu</span>(GLUT_RIGHT_BUTTON);<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-built_in">glutTimerFunc</span>(<span class="hljs-number">16</span>, My_Timer, <span class="hljs-number">0</span>);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Wrapmode"><a href="#Wrapmode" class="headerlink" title="Wrapmode"></a>Wrapmode</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../Include/Common.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * vs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;uniform vec2 offset;                                                           \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;out vec2 tex_coord;                                                            \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                              \n&quot;</span><br><span class="hljs-string">&quot;    const vec4 vertices[] = vec4[](vec4(-0.45, -0.45, 0.0, 1.0),               \n&quot;</span><br><span class="hljs-string">&quot;                                   vec4( 0.45, -0.45, 0.0, 1.0),               \n&quot;</span><br><span class="hljs-string">&quot;                                   vec4(-0.45,  0.45, 0.0, 1.0),               \n&quot;</span><br><span class="hljs-string">&quot;                                   vec4( 0.45,  0.45, 0.0, 1.0));              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;    gl_Position = vertices[gl_VertexID] + vec4(offset, 0.0, 0.0);              \n&quot;</span><br><span class="hljs-string">&quot;    tex_coord = vertices[gl_VertexID].xy * 3.0 + vec2(0.45 * 3);               \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                              \n&quot;</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> * fs_source[] =<br>&#123;<br><span class="hljs-string">&quot;#version 410 core                                                              \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;uniform sampler2D s;                                                           \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;out vec4 color;                                                                \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;in vec2 tex_coord;                                                             \n&quot;</span><br><span class="hljs-string">&quot;                                                                               \n&quot;</span><br><span class="hljs-string">&quot;void main(void)                                                                \n&quot;</span><br><span class="hljs-string">&quot;&#123;                                                                              \n&quot;</span><br><span class="hljs-string">&quot;    color = texture(s, tex_coord);                                             \n&quot;</span><br><span class="hljs-string">&quot;&#125;                                                                              \n&quot;</span><br>&#125;;<br><br>GLuint          program;<br>GLuint          vao;<br>GLuint          texture;<br><br><span class="hljs-keyword">struct</span><br>&#123;<br>GLint       mvp;<br>GLint       offset;<br>&#125; uniforms;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClearColor</span>(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<br><span class="hljs-built_in">glEnable</span>(GL_DEPTH_TEST);<br><span class="hljs-built_in">glDepthFunc</span>(GL_LEQUAL);<br><br>program = <span class="hljs-built_in">glCreateProgram</span>();<br>GLuint fs = <span class="hljs-built_in">glCreateShader</span>(GL_FRAGMENT_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(fs, <span class="hljs-number">1</span>, fs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(fs);<br><br>GLuint vs = <span class="hljs-built_in">glCreateShader</span>(GL_VERTEX_SHADER);<br><span class="hljs-built_in">glShaderSource</span>(vs, <span class="hljs-number">1</span>, vs_source, <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">glCompileShader</span>(vs);<br><br><span class="hljs-built_in">glAttachShader</span>(program, vs);<br><span class="hljs-built_in">glAttachShader</span>(program, fs);<br><br><span class="hljs-built_in">glLinkProgram</span>(program);<br><br><span class="hljs-built_in">glGenVertexArrays</span>(<span class="hljs-number">1</span>, &amp;vao);<br><span class="hljs-built_in">glBindVertexArray</span>(vao);<br><br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;texture);<br><br><span class="hljs-comment">// Load texture from file</span><br>TextureData tex = <span class="hljs-built_in">loadImg</span>(<span class="hljs-string">&quot;../../Media/Textures/rightarrows.png&quot;</span>);<br><span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;texture);<br><span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_2D, texture);<br><span class="hljs-built_in">glTexImage2D</span>(GL_TEXTURE_2D, <span class="hljs-number">0</span>, GL_RGBA, tex.width, tex.height, <span class="hljs-number">0</span>, GL_RGBA, GL_UNSIGNED_BYTE, tex.data);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);<br><span class="hljs-keyword">delete</span>[] tex.data;<br><br><span class="hljs-built_in">glEnable</span>(GL_BLEND);<br><span class="hljs-built_in">glBlendFunc</span>(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);<br>&#125;<br><br><span class="hljs-comment">// GLUT callback. Called to draw the scene.</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Display</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glClear</span>(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLenum wrapmodes[] = &#123; GL_CLAMP_TO_EDGE, GL_REPEAT, GL_CLAMP_TO_BORDER, GL_MIRRORED_REPEAT &#125;;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> GLfloat yellow[] = &#123; <span class="hljs-number">0.4f</span>, <span class="hljs-number">0.4f</span>, <span class="hljs-number">0.0f</span>, <span class="hljs-number">1.0f</span> &#125;;<br><br><span class="hljs-type">float</span> currentTime = <span class="hljs-built_in">glutGet</span>(GLUT_ELAPSED_TIME) * <span class="hljs-number">0.001f</span>;<br><br><span class="hljs-built_in">glUseProgram</span>(program);<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">float</span> offsets[] =<br>&#123;<br><span class="hljs-number">-0.5f</span>, <span class="hljs-number">-0.5f</span>,<br> <span class="hljs-number">0.5f</span>, <span class="hljs-number">-0.5f</span>,<br><span class="hljs-number">-0.5f</span>,  <span class="hljs-number">0.5f</span>,<br> <span class="hljs-number">0.5f</span>,  <span class="hljs-number">0.5f</span><br>&#125;;<br><br>GLint loc_offset;<br>loc_offset = <span class="hljs-built_in">glGetUniformLocation</span>(program, <span class="hljs-string">&quot;offset&quot;</span>);<br><br><span class="hljs-built_in">glTexParameterfv</span>(GL_TEXTURE_2D, GL_TEXTURE_BORDER_COLOR, yellow);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>&#123;<br><span class="hljs-built_in">glUniform2fv</span>(loc_offset, <span class="hljs-number">1</span>, &amp;offsets[i * <span class="hljs-number">2</span>]);<br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, wrapmodes[i]); <span class="hljs-comment">// 水平</span><br><span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, wrapmodes[i]); <span class="hljs-comment">// 垂直</span><br><br><span class="hljs-built_in">glDrawArrays</span>(GL_TRIANGLE_STRIP, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>&#125;<br><br><span class="hljs-built_in">glutSwapBuffers</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">My_Reshape</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">glViewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Change working directory to source code path</span><br>    <span class="hljs-built_in">chdir</span>(__FILEPATH__);<br><span class="hljs-comment">// Initialize GLUT and GLEW, then create a window.</span><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-built_in">glutInit</span>(&amp;argc, argv);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-built_in">glutInitDisplayMode</span>(GLUT_3_2_CORE_PROFILE | GLUT_RGBA | GLUT_DOUBLE | GLUT_DEPTH);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">glutInitWindowPosition</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);<br><span class="hljs-built_in">glutInitWindowSize</span>(<span class="hljs-number">600</span>, <span class="hljs-number">600</span>);<br><span class="hljs-built_in">glutCreateWindow</span>(__FILENAME__); <span class="hljs-comment">// You cannot use OpenGL functions before this line; The OpenGL context must be created first by glutCreateWindow()!</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _MSC_VER</span><br><span class="hljs-built_in">glewInit</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-built_in">printGLContextInfo</span>();<br><span class="hljs-built_in">My_Init</span>();<br><span class="hljs-comment">////////////////////</span><br><br><span class="hljs-comment">// Register GLUT callback functions.</span><br><span class="hljs-comment">///////////////////////////////</span><br><span class="hljs-built_in">glutDisplayFunc</span>(My_Display);<br><span class="hljs-built_in">glutReshapeFunc</span>(My_Reshape);<br><span class="hljs-comment">///////////////////////////////</span><br><br><span class="hljs-comment">// Enter main event loop.</span><br><span class="hljs-comment">//////////////</span><br><span class="hljs-built_in">glutMainLoop</span>();<br><span class="hljs-comment">//////////////</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NVDIA Night Systems</title>
    <link href="/notes/2024/10/02/nvdia-night-systems/"/>
    <url>/notes/2024/10/02/nvdia-night-systems/</url>
    
    <content type="html"><![CDATA[<h1 id="NVDIA-Night-Systems"><a href="#NVDIA-Night-Systems" class="headerlink" title="NVDIA Night Systems"></a>NVDIA Night Systems</h1><ul><li><p>主要用來分析 GPU 的 Performance</p></li><li><p>因為有直覺得 Timeline，可以看某個程式在哪個時間點再做什麼，所以也可以看 CPU 執行的程式</p></li><li><p>Single thread&#x2F; Multi-thread (pthread&#x2F;OpenMP)</p><ul><li><code>srun -n1 -cX nsys profile &lt;nsys options&gt; ./your_program &lt;program args&gt;</code></li></ul></li><li><p>MPI<br><code>srun -nX ./wrapper.sh ./your_program &lt;program args&gt;</code></p></li><li><p>wrapper.sh</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#! /bin/bash</span><br><br><span class="hljs-built_in">mkdir</span> -p nsys_reports<br><br><span class="hljs-comment"># Output to ./nsys_reports/rank_$N.nsys-rep</span><br>nsys profile \<br>-o <span class="hljs-string">&quot;./nsys_reports/rank_<span class="hljs-variable">$PMI_RANK</span>.nsys-rep&quot;</span> \<br>--mpi-impl openmpi \<br>--trace mpi,ucx,osrt \<br><span class="hljs-variable">$@</span><br></code></pre></td></tr></table></figure><p>讓每個 Process 輸出到不同名稱的檔案，裡面的 PMI_RANK 就會自動填入對應的 rank</p><p>–trace <events>: cuda, mpi, ucs, nvtx, …<br>–start-later X: X 秒之後再開始 profile，因為像是 initialization 就不重要，且通常只要監測幾秒就好，不用全看<br>–duration Y: profile 跑幾秒<br>–mpi-impl: openmpi (for OpenMPI)&#x2F; mpich (for Intel MPI)</p><h1 id="NVTX"><a href="#NVTX" class="headerlink" title="NVTX"></a>NVTX</h1><p>可以結合 Nsystem，插偵來更好的監測結果，不過會有一些 Profile Overhead</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Graphcis Programming and Application</title>
    <link href="/notes/2024/09/08/graphics-programming-and-applications/"/>
    <url>/notes/2024/09/08/graphics-programming-and-applications/</url>
    
    <content type="html"><![CDATA[<h2 id="OpenGL"><a href="#OpenGL" class="headerlink" title="OpenGL"></a>OpenGL</h2><ul><li>Application Programming Interface (API)</li><li>寫指令與底層顯卡溝通，把資料餵到 Render Pipeline 裡面，繪出結果</li><li>Primitive-based Rendering<ul><li>用最小單元，點、線、面組成</li></ul></li></ul><h2 id="Rasterization-Rendering-Pipeline"><a href="#Rasterization-Rendering-Pipeline" class="headerlink" title="Rasterization Rendering Pipeline"></a>Rasterization Rendering Pipeline</h2><ul><li>有很多 Stage，一路從 CPU 流到 GPU，有些專門處理頂點，有些專門處理三角片，有些處理 Pixel…</li><li>早期的 Rendering Pipeline 是 Fiexed Function，Stage 裡面大部分的邏輯是寫死的<ul><li>只能傳一些自己的參數進去，不能改變裡面的運行邏輯</li></ul></li><li>現在是 Programmable shader，可以自己寫一些東西進去，更為靈活<ul><li>在 OpenGL 3.0 成為正式的核心，捨去 Fixed Function Pipeline</li><li>在 OpenGL 裡面使用 GLSL 撰寫<br><img src="https://www.khronos.org/opengl/wiki_opengl/images/RenderingPipeline.png" alt="Rasterization Rendering Pipeline"></li></ul></li></ul><h1 id="Projection-Transformation"><a href="#Projection-Transformation" class="headerlink" title="Projection &amp; Transformation"></a>Projection &amp; Transformation</h1><ul><li>Modeling Transformation<br>World Coordinate</li><li>Viewing Transformation<br>Camera Coordinate</li><li>Projection Transformation<br>Window Coordinate</li><li>Viewport Transformation<br>Screen Coordinate</li></ul><h2 id="Coordinate-System"><a href="#Coordinate-System" class="headerlink" title="Coordinate System"></a>Coordinate System</h2><p><img src="https://i.sstatic.net/w7bKr.jpg" alt="Coordinate System"></p><h3 id="Homogeneous-Coordinates"><a href="#Homogeneous-Coordinates" class="headerlink" title="Homogeneous Coordinates"></a>Homogeneous Coordinates</h3><ul><li>用四維 vector (x, y, z, w) 來描述，能夠區分它是 <strong>點</strong> 還是 <strong>向量</strong><ul><li>w &#x3D; 0: 向量</li><li>w &#x3D; 1: 點</li></ul></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Circuits &amp; Electronics - Semiconductor Material &amp; Diode</title>
    <link href="/notes/2024/09/07/circuits-and-electronics-1/"/>
    <url>/notes/2024/09/07/circuits-and-electronics-1/</url>
    
    <content type="html"><![CDATA[<h1 id="半導體-Semiconductor"><a href="#半導體-Semiconductor" class="headerlink" title="半導體 Semiconductor"></a>半導體 Semiconductor</h1><ul><li>自由電子數量介於 <strong>導體(Conductor)</strong> 與 <strong>絕緣體(Insulator)</strong> 之間</li></ul><h3 id="導體-Conductor"><a href="#導體-Conductor" class="headerlink" title="導體 Conductor"></a>導體 Conductor</h3><ul><li>材料上有許多自由電子 (free electron)</li><li>給予外加電壓後，產生電場，自由電子開始移動</li><li>自由電子移動，且數量夠多時，量測的到電流，我們稱它為導體</li><li>在室溫下，自由電子濃度大概是 $10^22 &#x2F; cm^3$</li></ul><h3 id="絕緣體-Insulator"><a href="#絕緣體-Insulator" class="headerlink" title="絕緣體 (Insulator)"></a>絕緣體 (Insulator)</h3><ul><li>每個原子幾乎都沒辦法貢獻自由電子，因此自由電子數量極少，沒辦法導電</li><li>在室溫下，自由電子濃度大概是 $10^1 &#x2F; cm^3$</li></ul><h2 id="半導體有哪些種類？"><a href="#半導體有哪些種類？" class="headerlink" title="半導體有哪些種類？"></a>半導體有哪些種類？</h2><ul><li>通常在元素週期表上的第四族，像是矽(Si)、鍺(Ge) 又稱為 <strong>元素半導體 (elemental semi)</strong></li><li>有時候會是一個 <strong>第三族</strong> 和 <strong>第五族</strong> 元素混合形成化合物，像是砷化鎵 (GaAs)，又稱 <strong>化合物半導體 (compound semi)</strong></li></ul><h4 id="矽-Si"><a href="#矽-Si" class="headerlink" title="矽 Si"></a>矽 Si</h4><ul><li>礦產佔地球比例 1&#x2F;4</li><li>跟 Ge 比起來比較穩定</li></ul><h2 id="本質半導體-Intrinsic-Semi"><a href="#本質半導體-Intrinsic-Semi" class="headerlink" title="本質半導體 (Intrinsic Semi)"></a>本質半導體 (Intrinsic Semi)</h2><ul><li>第四族的所有元素，<strong>價電子 (valence electron)</strong> 數量都是 4 個<ul><li>價電子：原子最外的電子層中的電子</li><li>其中 C 是絕緣體，Si、Ge 是半導體，Sn、Pb 是導體</li></ul></li><li>Si 會與鄰近的其他 Si 形成 <strong>共價鍵 (covalence bond)</strong><ul><li>在室溫下，自由電子濃度大概是 $10^10 &#x2F; cm^3$</li><li>外界給予能量時 (ex: 溫度上升)，價電子會脫離共價鍵<ul><li>價電子脫離共價鍵結構所需的最小能量稱為 <strong>Bandgap Energy (Eg)</strong></li><li>$e^-$ 脫離後會產生電洞 $h^+$，又稱為 Generate $e^-$ $h^+$ 對，與之相反的是 Recomine</li></ul></li><li>在溫度上升的過程中，Generation 速率會比 Recombination 速率快</li><li>當熱平衡 (Thermal Equilibrium) 時，Generation 速率跟 Recombination 速率一樣快，$e^-$、$h^+$ 數量不再改變</li></ul></li></ul><h3 id="電子濃度公式"><a href="#電子濃度公式" class="headerlink" title="電子濃度公式"></a>電子濃度公式</h3><ul><li>$ n_i(T) &#x3D; BT^{3&#x2F;2} e^{(-Eg&#x2F;2kT)}$<ul><li>i: intrinsic</li><li>B: Semi Constant for Si, B &#x3D; 5.23 * $10^{15}$</li><li>Eg: Bandgap energy (eV) for Si, Eg &#x3D; 1.1 eV</li><li>T: 絕對溫度 (K), K &#x3D; 273.15 + $^\circ C$</li><li>k: Boltzmann’s Constant, k &#x3D; 86 * $10^{-6}$ eV&#x2F;K</li></ul></li><li>可以發現本質載子濃度對於溫度 T 非常敏感</li></ul><h2 id="外質半導體-Extrinsic-Semi"><a href="#外質半導體-Extrinsic-Semi" class="headerlink" title="外質半導體 (Extrinsic Semi)"></a>外質半導體 (Extrinsic Semi)</h2><ul><li>摻少量 (比例大約 1&#x2F;10000000) 雜質到本質半導體 (Si)，導電性上升</li></ul><h3 id="N-型半導體"><a href="#N-型半導體" class="headerlink" title="N 型半導體"></a>N 型半導體</h3><ul><li>這邊以摻雜五價元素為例，稱為 <strong>N 型半導體</strong><ul><li>原先 Si 濃度是 5 * $10^22$ 原子&#x2F;$cm^3$</li><li>摻雜的 P 濃度是 5 * $10^15$ 原子&#x2F;$cn^3$</li><li>摻雜過後的 Si 濃度是 5 _ $10^22$ - 5 _ $10^15$，還是 5 * $10^22$ 原子&#x2F;$cm^3$<ul><li>可以發現 Si 濃度幾乎沒有改變，因此熔點等物理特性、化學特性不會變，但是 <strong>導電性</strong> 會改變</li></ul></li></ul></li><li>摻雜元素要是均勻分布的</li><li>摻雜後，每個雜質都多貢獻一個自由電子，稱其為 <strong>施體或施子 (donor)</strong><ul><li>原先電子濃度是 $10^10$</li><li>摻雜後的電子濃度是 $10^10$ + $10^15$ &#x3D; $10^15$，因此電子濃度是由 donor 濃度決定，稱其為 $N_d$</li></ul></li></ul><h3 id="P-型半導體"><a href="#P-型半導體" class="headerlink" title="P 型半導體"></a>P 型半導體</h3><ul><li>摻雜三價元素 (B)，原理跟 N 型半導體 差不多</li><li>電洞變成多數載子 (Majority Carriers)，電子變成少數載子 (Minority Carriers)</li><li>上述的 donor 變成 acceptor (受體、受子)，因此 $N_d$ 也變成 $N_a$</li></ul><h3 id="質量作用定律-mass-action-law"><a href="#質量作用定律-mass-action-law" class="headerlink" title="質量作用定律 (mass-action law)"></a>質量作用定律 (mass-action law)</h3><ul><li>$ n p &#x3D; n_i^2$<ul><li>n: 電子濃度</li><li>p: 電洞濃度</li><li>n_i: 本質載子濃度</li></ul></li><li>電子濃度和電動濃度乘積固定，當電子濃度上升後，電洞濃度會下降</li><li>在 N 型半導體裡面，n 替換成 $n_{n0}$，p 替換成 $p_{n0}$</li><li>在 P 型半導體裡面，n 替換成 $n_{p0}$，p 替換成 $p_{p0}$</li></ul><h2 id="飄移與擴散-Drift-and-Diffusion"><a href="#飄移與擴散-Drift-and-Diffusion" class="headerlink" title="飄移與擴散 Drift and Diffusion"></a>飄移與擴散 Drift and Diffusion</h2><h3 id="飄移"><a href="#飄移" class="headerlink" title="飄移"></a>飄移</h3><ul><li>外力，像是施予電壓產生電場</li><li>電場產生力給載子，移動裡面的電子與電洞<ul><li>雖然電子與電洞方向不同，但他們貢獻的方向是相同的，不會抵銷</li><li>所有載子的平均速度，就是 <strong>飄移速度</strong>，會隨著電壓變大而變快<ul><li>當飄移速度變快時，電流也會越大</li><li>可以發現跟歐姆定律很像，但是在半導體中要多考慮 <strong>電洞</strong></li></ul></li></ul></li><li>雖然電場與飄移速度成正相關，但是當電場大到一定程度 ($10^4$)，飄移速度幾乎不會再增加<ul><li>電子: $v_{dn}$ &#x3D; - $\mu_n$ E</li><li>電洞: $v_{dp}$ &#x3D; + $\mu_p$ E<ul><li>$\mu$: 移動率，mobility</li><li>$v_d$: 飄移速度</li><li>E: 電場</li><li>電子多個負號，因為它與電場方向相反</li><li>$\mu_n$ 大約是 1350，$\mu_p$ 大約是 480 $\frac{cm^3}{V \cdot s}$</li></ul></li></ul></li></ul><h3 id="半導體電流公式"><a href="#半導體電流公式" class="headerlink" title="半導體電流公式"></a>半導體電流公式</h3><p><img src="/notes/./images/circuits-and-electronics-1/SemiconductorCurrentEquation.png" alt="Semiconductor Current Equation"></p><h4 id="電子-n"><a href="#電子-n" class="headerlink" title="電子 n"></a>電子 n</h4><p>我們有 $I_n$ &#x3D; $\frac{N \cdot q}{t}$ 、 $V_{dn}$ &#x3D; $\frac{-L}{t}$ (- 為方向)，因此 $I_n &#x3D; qN \cdot \frac{(-V_{dn})}{L}$<br>電流密度 $J_n &#x3D; \frac{I_n}{A} &#x3D; \frac{qN \dot (-V_{dn})}{L\cdot A}$ &#x3D; $q \cdot n (-V_{dn})$ (n 為電子濃度)<br>結合前面的飄移速度公式，可以得到 $J_n &#x3D; q \cdot n \cdot (-V_{dn}) &#x3D;  q \cdot n \cdot (-) (-\mu_n) \cdot E &#x3D; q \cdot n \mu_n \cdot E$</p><h4 id="電洞-p"><a href="#電洞-p" class="headerlink" title="電洞 p"></a>電洞 p</h4><p>基本上跟電子類似，可以得到 $J_p &#x3D; q \cdot p \mu_p \cdot E$</p><p>可以知道 <strong>半導體的電流密度</strong> $J &#x3D; J_n + J_p &#x3D; (q \cdot n \mu_n + q \cdot p \mu_p) \cdot E$</p><h4 id="導電係數-sigma"><a href="#導電係數-sigma" class="headerlink" title="導電係數 $\sigma$"></a>導電係數 $\sigma$</h4><p>半導體的電流密度 中的 $(q \cdot n \mu_n + q \cdot p \mu_p)$ 又稱為 <strong>導電係數 conductivity</strong></p><p>在探討 <strong>歐姆定律 (Ohm’s laws)</strong> 時，我們有 $I &#x3D; \frac{V}{R} &#x3D; \frac{V \cdot A}{\rho \cdot L} &#x3D; J \cdot A$</p><ul><li>$\rho$ 為 <strong>電阻係數</strong></li><li>$L$ 為長度</li><li>$A$ 為截面積</li></ul><p>可以發現 $J &#x3D; \frac{1}{\rho} \cdot \frac{V}{L} &#x3D; (\frac{1}{\rho}) \cdot E$ 且 $J &#x3D; \sigma \cdot E$<br>所以 $\sigma &#x3D; \frac{1}{\rho}$</p><h5 id="例題"><a href="#例題" class="headerlink" title="例題"></a>例題</h5><p>本質半導體 Si 在 300 K 的溫度下， $\mu_n &#x3D; 1350 \frac{cm^3}{V \cdot s}$，$\mu_p &#x3D; 480 \frac{cm^3}{V \cdot s}$，$N_d &#x3D; 1 \cdot 10^{16} 1&#x2F;cm^3$，求導電係數 $\sigma$？</p><p>$n &#x3D; N_d &#x3D; 1 \cdot 10^{16}$<br>$p &#x3D; \frac{n_i^2}{N_d} &#x3D; \frac{(1.5 \cdot 10^{10})^2}{10^{16}} &#x3D; 2.25 \cdot 10^4$<br>可以發現 $q \cdot p \cdot \mu_p$ 跟 $q \cdot n \cdot \mu_n$ 比起來極小，可以省略<br>因此 $J &#x3D; q \cdot n \cdot \mu_n &#x3D; 1.6 \cdot 10^{-19} \cdot 10^{16} \cdot 1350 &#x3D; 2.16$</p><ul><li>可以觀察到，如果沒有參雜雜質，$p$ 或 $n$ 都遠不及有參雜雜質的，因此 <strong>導電性</strong> 會差很多倍</li></ul><h3 id="導電係數之溫度係數"><a href="#導電係數之溫度係數" class="headerlink" title="導電係數之溫度係數"></a>導電係數之溫度係數</h3><p><img src="https://i.sstatic.net/BO3H1.png" alt="Impurity Scattering &amp; Lattice Scattering"></p><h4 id="Impurity-Scattering"><a href="#Impurity-Scattering" class="headerlink" title="Impurity Scattering"></a>Impurity Scattering</h4><p>溫度上升，電子能有更多能量，移動速度較快，電子移動過程中更難受質子影響 (吸引)<br>因此，$T$ 上升，$\mu$ 上升</p><h4 id="Lattice-Scattering"><a href="#Lattice-Scattering" class="headerlink" title="Lattice Scattering"></a>Lattice Scattering</h4><p>溫度上升，離子更容易震動，離子的 <strong>有效面積</strong> 上升，電子移動過程中更容易撞到離子<br>因此，$T$ 上升，$\mu$ 下降</p><p>一般而言，我們討論的室溫 (300 K)，大概都在 <strong>Lattice Scattering</strong> 的範圍內</p><h5 id="本質半導體"><a href="#本質半導體" class="headerlink" title="本質半導體"></a>本質半導體</h5><p>在本質半導體中，$\sigma &#x3D; (q \cdot n \mu_n + q \cdot p \mu_p)$，其中 $n &#x3D; p &#x3D; n_i$，因此 $\sigma &#x3D; q \cdot n_i \cdot (\mu_n + p \mu_p)$<br>前面有提到，<strong>本質載子濃度</strong> $n_i$ 對於溫度非常敏感，因此當溫度上升時，雖然 $(\mu_n + p \mu_p)$ 下降，但是遠不及 $n_i$ 的上升程度，所以 $\sigma$ 還是上升</p><h5 id="N-型半島體"><a href="#N-型半島體" class="headerlink" title="N 型半島體"></a>N 型半島體</h5><p>$\sigma &#x3D; q \cdot N_d \cdot \mu_n$<br>溫度上升，$N_d$ 不變，$\mu_n$ 下降，所以 $\sigma$ 下降，P 型半導體同理</p><h3 id="擴散"><a href="#擴散" class="headerlink" title="擴散"></a>擴散</h3><ul><li>透過濃度的差異，自然的流動，不需要外力</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>作業系統筆記 Processes Conecpt</title>
    <link href="/notes/2024/07/26/os-chapter3/"/>
    <url>/notes/2024/07/26/os-chapter3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>周志遠教授作業系統開放式課程</p></blockquote><h1 id="Process-Concept"><a href="#Process-Concept" class="headerlink" title="Process Concept"></a>Process Concept</h1><h3 id="Program"><a href="#Program" class="headerlink" title="Program"></a>Program</h3><ul><li>被動、Binary 的 File 存在硬碟裡面</li></ul><h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><ul><li><p>主動、正在記憶體裡面執行的程式</p></li><li><p>一個 Process 裡面包含：</p><ul><li>Code Segment (text section)</li><li>Data Section (global variables)</li><li>Stack (暫時的 local variables 和 functions)</li><li>Heap (動態分配的 variables 或 classes)</li><li>記錄現在的資料 (<strong>program counter</strong>、register contents)</li><li>其他相關的資源 (OS resources, e.g. open file handlers)</li></ul></li></ul><p><img src="/notes/" alt="Process In Memory"></p><h3 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h3><ul><li><p>A.K.A <strong>lightweight process</strong></p><ul><li>跟 Process 長的一樣，不過有些 Threads 可以共用 Memory 空間</li><li>是 Basic unit of CPU utilization</li></ul></li><li><p>在同一個 Process 底下的 Threads 會共用</p><ul><li>Code Section</li><li>Data Section</li><li>OS resources</li></ul></li><li><p>每個 Thread 有自己的</p><ul><li>Thread ID</li><li>Program Counter</li><li>Register Set</li><li>Stack</li></ul></li></ul><p>因此，在寫 Multi-Thread 的時候可以用 Global Variables (Data Section) 來做溝通</p><p><img src="/notes/" alt="Threads"></p><h2 id="Process-States"><a href="#Process-States" class="headerlink" title="Process States"></a>Process States</h2><ul><li>States<ul><li><p>New: 這個 Process 剛被創造出來</p><ul><li>Program Load 到 Memory，並初始化前面提到的那些 (Code Section、Data Section…)</li><li>分配要分配多少給 Process</li></ul></li><li><p>Ready: Process 要競爭的資源是 CPU，會有一個 Queue 存放這些 Process，等待 CPU 排程</p></li><li><p>Running: 在 Ready 中被選到了，可以開始執行程式</p><ul><li>有時候 Running State 會直接回到 Ready State，通常是因為 Timer 到了，送出 Interrupt，而不是因為 IO</li></ul></li><li><p>Waiting: 在做 IO 的時候不需要 CPU 參與，等到完成後會回到 Ready</p><ul><li>也有一個 Queue 來儲存</li></ul></li><li><p>Terminated: 釋放所有分配給這 Process 的資源</p></li></ul></li></ul><p><img src="/notes/" alt="Diagram of Process State"></p><h2 id="Process-Control-Block-PCB"><a href="#Process-Control-Block-PCB" class="headerlink" title="Process Control Block (PCB)"></a>Process Control Block (PCB)</h2><ul><li>OS 要能掌握每個 Process 的邏輯來管理，所以每一個 Process 會有一個 Process Control Block</li><li>像是前面說的把 Process 放進 Queue 其實是一個抽象的概念，實際上是放進 PCB，然後裡面的</li><li>PCB 裡面包含<ul><li>Process State (Ready、Waiting…)</li><li>Program Counter</li><li>CPU Registers</li><li>CPU Scheduling Information (這個 Process 的 Priority)</li><li>Memory-Management Information (Base&#x2F; Limit Register)</li><li>I&#x2F;O Status Information (正在做哪個 IO Device 的 IO)</li><li>Accounting Information (你開了幾個檔案)</li></ul></li></ul><p><img src="/notes/" alt="Process Control Block"></p><h2 id="Context-Switch"><a href="#Context-Switch" class="headerlink" title="Context Switch"></a>Context Switch</h2><ul><li><p>藉由 Interrupt，把原來的 Process 替換成另一個 Process</p><ul><li>會把舊 Process 的資料存到 PCB 裡，把新 Process 的資料 Load 到 PCB 裡</li></ul></li><li><p>Context Switch 所花的時間就是 Overhead，在這期間兩個 Process 都在 Idle，為了 Time-Sharing 這是無法避免的</p></li><li><p>Context Switch Time 基於</p><ul><li>Memory Speed</li><li>Register 數量</li><li>用特殊的 Instruction，像是某個 Instruction 可以一次 Load 所有 Register</li><li>Hardware Support: CPU 包含很多 Sets of Registers，一次去記很多程式的狀態，在 Context Switch 得時候就不用寫到 Memory</li></ul></li></ul><p><img src="/notes/" alt="Context Switch"></p><h1 id="Process-Scheduling"><a href="#Process-Scheduling" class="headerlink" title="Process Scheduling"></a>Process Scheduling</h1><ul><li>為了實現 Multiprogramming 和 Time Sharing</li></ul><h3 id="Queues"><a href="#Queues" class="headerlink" title="Queues"></a>Queues</h3><ul><li>Job Queue (New State): 哪些 Process 可以 Load 到 Memory</li><li>Ready Queue (Ready State)</li><li>Device Queue (Wait State)</li></ul><p><img src="/notes/" alt="Process Scheduling Queues"></p><p><img src="/notes/" alt="Process Scheduling Diagram"></p><h2 id="Scheculers"><a href="#Scheculers" class="headerlink" title="Scheculers"></a>Scheculers</h2><h1 id="Operations-on-Processes"><a href="#Operations-on-Processes" class="headerlink" title="Operations on Processes"></a>Operations on Processes</h1><h1 id="Interprocess-Communication"><a href="#Interprocess-Communication" class="headerlink" title="Interprocess Communication"></a>Interprocess Communication</h1>]]></content>
    
    
    
    <tags>
      
      <tag>OS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javascript Note</title>
    <link href="/notes/2024/07/23/js-note/"/>
    <url>/notes/2024/07/23/js-note/</url>
    
    <content type="html"><![CDATA[<h2 id="let、const、var-的差別"><a href="#let、const、var-的差別" class="headerlink" title="let、const、var 的差別"></a>let、const、var 的差別</h2><iframe width = "100%" height = "400" src="//www.youtube.com/embed/Pychc22EG4Q" frameborder="0" allowfullscreen></iframe><h3 id="var"><a href="#var" class="headerlink" title="var"></a>var</h3><p>var 是 function-scoped 的變數，作用域為整個 function</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">exampleVar</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> x = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-keyword">var</span> x = <span class="hljs-number">2</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 2</span><br>    &#125;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 2</span><br>&#125;<br></code></pre></td></tr></table></figure><p>因此上面這個例子，整個 function 的 x 是一樣的</p><h3 id="比較"><a href="#比較" class="headerlink" title="比較"></a>比較</h3><table><thead><tr><th align="center"></th><th align="center">var</th><th align="center">let</th><th align="center">const</th></tr></thead><tbody><tr><td align="center">範圍</td><td align="center">function-scoped</td><td align="center">block-scpoed</td><td align="center">block-scoped</td></tr><tr><td align="center">可重複定義</td><td align="center">O</td><td align="center">X</td><td align="center">X</td></tr><tr><td align="center">可修改</td><td align="center">O</td><td align="center">O</td><td align="center">X</td></tr><tr><td align="center">hoisting</td><td align="center">O</td><td align="center">X</td><td align="center">X</td></tr></tbody></table><h3 id="進階範例"><a href="#進階範例" class="headerlink" title="進階範例"></a>進階範例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 3, 3, 3</span><br>    &#125;, <span class="hljs-number">100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>因為 var， i 只有一個，所以每次生成的 closure 捕捉到的 i 會是一樣的</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 0, 1, 2</span><br>    &#125;, <span class="hljs-number">100</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Javascript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>javascript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>作業系統筆記 OS Structure</title>
    <link href="/notes/2024/07/18/os-chapter2/"/>
    <url>/notes/2024/07/18/os-chapter2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>周志遠教授作業系統開放式課程</p></blockquote><h1 id="OS-Services"><a href="#OS-Services" class="headerlink" title="OS Services"></a>OS Services</h1><h2 id="User-Interface"><a href="#User-Interface" class="headerlink" title="User Interface"></a>User Interface</h2><h3 id="CLI-Command-Line-Interface"><a href="#CLI-Command-Line-Interface" class="headerlink" title="CLI (Command Line Interface)"></a>CLI (Command Line Interface)</h3><ul><li>GUI 是 based on CLI，所以 GUI 能做到的是 CLI 一定可以</li><li><strong>Shell</strong>: Command-line Interpreter (CSHELL, BASH)<ul><li>不屬於 OS，你打的指令不是直接交給 OS，是交給 Shell，方便使用者使用指令</li><li>一台電腦可能有很多使用者，每個使用者的喜好不同，介面、顏色、指令等等，可以做一些客製化的調整</li></ul></li></ul><h3 id="GUI-Graphic-User-Interface"><a href="#GUI-Graphic-User-Interface" class="headerlink" title="GUI (Graphic User Interface)"></a>GUI (Graphic User Interface)</h3><ul><li>Microsoft 崛起的原因</li></ul><h2 id="Communication"><a href="#Communication" class="headerlink" title="Communication"></a>Communication</h2><ul><li>不是單指跨電腦的網路，也可以是 Multi-thread、Multi-processor 等同一台電腦內部的溝通</li></ul><h3 id="Message-Passing"><a href="#Message-Passing" class="headerlink" title="Message Passing"></a>Message Passing</h3><ul><li>為了先前提到的 Protection (Base register、Limit register)，程式之間不能直接互相影響，會先把資料複製到 OS，再從 OS 複製到另一支程式</li><li>會比較慢</li></ul><h3 id="Shared-Memory"><a href="#Shared-Memory" class="headerlink" title="Shared Memory"></a>Shared Memory</h3><ul><li>也需要透過 System Call 去建立這塊 Shared Memory，不過像是 Multi-thread 預設就有</li><li>會有 Synchronization 的問題</li></ul><p><img src="/notes/./images/os-chapter2/Communication.png" alt="Communication"></p><p>OS Service 除了 User interface 和 Communication 以外，還有</p><ul><li>Program Execution</li><li>I&#x2F;O operations</li><li>File-system manipulation</li><li>Error detection</li><li>Resource allocation</li><li>Accounting</li><li>Protection and security</li></ul><h1 id="OS-Application-Interface"><a href="#OS-Application-Interface" class="headerlink" title="OS-Application Interface"></a>OS-Application Interface</h1><h2 id="System-Calls"><a href="#System-Calls" class="headerlink" title="System Calls"></a>System Calls</h2><ul><li>OS 提供很多 Services，要使用這些 Service 都會需要透過 System Call，所以 System Call 就是 OS 的 Interface</li><li>也是一種 Software Interrupt，這樣才能去改變 Mode</li><li>為了效能，是使用 Assembly Language 撰寫</li></ul><h2 id="API-Application-Program-Interface"><a href="#API-Application-Program-Interface" class="headerlink" title="API (Application Program Interface)"></a>API (Application Program Interface)</h2><ul><li><p>直接使用 System Call 是一件很麻煩的事情，所以 User 的程式通常是使用 API 來做到這件事，而不是直接 Call System Call。大部分的 API 都是使用 C 語言做成的 Library</p></li><li><p>API 有可能包含很多 System Call，也有可能完全沒有 System Call</p><ul><li>沒有 System Call: 方便使用者使用，像是一些數學的計算</li></ul></li><li><p>一些常見的 API</p><ul><li><p><strong>Win32</strong> API for <strong>Windows</strong></p></li><li><p><strong>POSIX</strong> API for <strong>POSIX-based Systems</strong> (UNIX、 Linux、Mac OS)</p><ul><li>POSIX: (Portable Operating System Interface for Unix)</li><li>我在 Linux 上寫一個程式可以執行，直接拿到 Mac 上一定也可以跑，因為 Interface 的定義完全一樣 (Library 可能不一樣)</li></ul></li><li><p><strong>Java</strong> API for <strong>Java Virtual Machine</strong> (JVM)</p></li></ul></li></ul><p><img src="/notes/./images/os-chapter2/OSInterface.png" alt="OS Interface"></p><h1 id="OS-Structure"><a href="#OS-Structure" class="headerlink" title="OS Structure"></a>OS Structure</h1><h2 id="Simple-OS-Architecture"><a href="#Simple-OS-Architecture" class="headerlink" title="Simple OS Architecture"></a>Simple OS Architecture</h2><ul><li>開發很快，但是系統裡面的架構全部混在一起</li><li>定義不清楚，非常不安全，也不好維護</li></ul><p><img src="/notes/./images/os-chapter2/SimpleOSArchitecture.png" alt="Simple OS Architecture"></p><h2 id="Layered-OS-Architecture"><a href="#Layered-OS-Architecture" class="headerlink" title="Layered OS Architecture"></a>Layered OS Architecture</h2><ul><li>功能分割得很清楚，上層可以 Call 下層，下層無法 Call 上層</li><li>很好 Debug、維護</li><li>因為是 Layerd，可能涉及到許多 Memory Copy，效能不好</li></ul><p><img src="/notes/./images/os-chapter2/LayeredOSArchitecture.png" alt="Layered OS Architecture"></p><h2 id="Microkernel-OS"><a href="#Microkernel-OS" class="headerlink" title="Microkernel OS"></a>Microkernel OS</h2><ul><li><p>Kernel 的程式碼越少越好，比較 Reliable，不要有 bug 就好</p></li><li><p>Modularize 的概念，Kernel 只負責溝通不同 Module，Kernel 以外的全部在 User Space</p></li><li><p>效能比 Layered 還要更糟糕</p><ul><li>User Space 的東西之間要溝通，都需要 <strong>System Call</strong></li><li>為了避免 Synchronization 的問題，都是透過 <strong>Message Passing</strong></li></ul></li></ul><p><img src="/notes/./images/os-chapter2/MicrokernelOS.png" alt="Microkernel OS"></p><h2 id="Modular-OS-Architecture"><a href="#Modular-OS-Architecture" class="headerlink" title="Modular OS Architecture"></a>Modular OS Architecture</h2><ul><li>很常見，現在大多是使用這種架構</li><li>跟 Microkernel OS 的差別在，都是在 Kernel Space，方便 Module 之間溝通，跑起來更有效率</li></ul><p><img src="/notes/./images/os-chapter2/ModularOSArchitecture.png" alt="Modular OS Architecture"></p><h2 id="Virtual-Machine"><a href="#Virtual-Machine" class="headerlink" title="Virtual Machine"></a>Virtual Machine</h2><ul><li>一台電腦有很多使用者，每個人可能會需要自己的 OS</li><li>VM 能夠做一個硬體抽象層，映射到原本電腦的硬體，讓 VM 使用</li></ul><p><img src="/notes/./images/os-chapter2/VirtualMachine.png" alt="Virtual Machine"></p><h3 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h3><ul><li><p>VM 全部都是跑在 User Space，無法直接執行 Privileged Instruction</p><ul><li>需要送出一個 Intrucupt 到原本的 OS (Kernel Space)，然後原本的 OS 再幫它重複執行一次，才在 User Space 做 Kernel Space 的事情</li><li>有些 CPU 會特別支援 Hardware Support，也就是多一個 bit 去記錄 User Mode、Kernel Mode 以及 Virtual Machine Mode，就可以直接執行 Privileged Instruction</li></ul></li><li><p>Critical Instruction</p><ul><li>User Space 可以執行，但是執行結果和在 Kernel Space 的執行結果不一樣</li></ul></li></ul><h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><ul><li>提供完全的 Protection，使用者不會互相影響，一個 OS 被 Hack 其它 OS 也沒事</li><li>提供特定的執行環境</li><li>測試開發 OS，避免整台電腦 Crash</li><li>實現資源管理，像是有些雲端計算會用到 VM</li></ul><h3 id="Full-Virtualization"><a href="#Full-Virtualization" class="headerlink" title="Full Virtualization"></a>Full Virtualization</h3><ul><li>Guest OS 的程式碼完全不用動，可以直接裝在原本的 OS 上</li><li>Vmware</li></ul><p><img src="/notes/./images/os-chapter2/FullVirtualization.png" alt="Full Virtualization"></p><h3 id="Para-virtualization"><a href="#Para-virtualization" class="headerlink" title="Para-virtualization"></a>Para-virtualization</h3><ul><li>Guest OS 會需要修改</li><li>有一個 Manager 去管理所有 Guest OS</li><li>Xen</li></ul><p><img src="/notes/./images/os-chapter2/Para-virtualization.png" alt="Para-virtualization"></p><h3 id="Java-Virtual-Machine"><a href="#Java-Virtual-Machine" class="headerlink" title="Java Virtual Machine"></a>Java Virtual Machine</h3><ul><li>Java 執行的方式就像跑在一個 Virual Machine 上</li><li>跟 Nachos 很像，只做 Instruction 的轉換，把 Java Machine 上 Compile 出的 Bytecodes 轉換成其它的</li><li>有一些 Translation 上的優化，像是 **Just-In-Time (JIT)**，記錄 Translation 過的 Instruction</li></ul><p><img src="/notes/./images/os-chapter2/JavaVirtualMachine.png" alt="Java Virtual Machine"></p>]]></content>
    
    
    
    <tags>
      
      <tag>OS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux Design Homework</title>
    <link href="/notes/2024/07/17/linux-design-homework/"/>
    <url>/notes/2024/07/17/linux-design-homework/</url>
    
    <content type="html"><![CDATA[<blockquote><p><a href="https://wiki.csie.ncku.edu.tw/linux/schedule">https://wiki.csie.ncku.edu.tw/linux/schedule</a></p></blockquote><h2 id="2018q1-Homework-quiz4"><a href="#2018q1-Homework-quiz4" class="headerlink" title="2018q1 Homework (quiz4)"></a><a href="https://hackmd.io/@sysprog/linked-list-quiz">2018q1 Homework (quiz4)</a></h2><h3 id="Quiz-1"><a href="#Quiz-1" class="headerlink" title="Quiz 1"></a>Quiz 1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span> <span class="hljs-type">int</span> data; <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">next</span>, *<span class="hljs-title">prev</span>;</span> &#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">FuncA</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node **start, <span class="hljs-type">int</span> value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!*start) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>        new_node-&gt;data = value;<br>        new_node-&gt;next = new_node-&gt;prev = new_node;<br>        *start = new_node;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">last</span> =</span> (*start)-&gt;prev;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    new_node-&gt;data = value;<br>    new_node-&gt;next = *start;<br>    (*start)-&gt;prev = new_node;<br>    new_node-&gt;prev = last;<br>    last-&gt;next = new_node;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">FuncB</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node **start, <span class="hljs-type">int</span> value)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">last</span> =</span> (*start)-&gt;prev;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    new_node-&gt;data = value;<br>    new_node-&gt;next = *start;<br>    new_node-&gt;prev = last;<br>    last-&gt;next = (*start)-&gt;prev = new_node;<br>    *start = new_node;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">FuncC</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node **start, <span class="hljs-type">int</span> value1, <span class="hljs-type">int</span> value2)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    new_node-&gt;data = value1;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">temp</span> =</span> *start;<br>    <span class="hljs-keyword">while</span> (temp-&gt;data != value2)<br>        temp = temp-&gt;next;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">next</span> =</span> temp-&gt;next;<br>    temp-&gt;next = new_node;<br>    new_node-&gt;prev = temp;<br>    new_node-&gt;next = next;<br>    next-&gt;prev = new_node;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node *start)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">temp</span> =</span> start;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Traversal in forward direction \n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (; temp-&gt;next != start; temp = temp-&gt;next)<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, temp-&gt;data);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, temp-&gt;data);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nTraversal in reverse direction \n&quot;</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">last</span> =</span> start-&gt;prev;<br>    <span class="hljs-keyword">for</span> (temp = last; temp-&gt;prev != last; temp = temp-&gt;prev)<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, temp-&gt;data);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, temp-&gt;data);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">start</span> =</span> <span class="hljs-literal">NULL</span>;<br>    FuncA(&amp;start, <span class="hljs-number">51</span>); FuncB(&amp;start, <span class="hljs-number">48</span>);<br>    FuncA(&amp;start, <span class="hljs-number">72</span>); FuncA(&amp;start, <span class="hljs-number">86</span>);<br>    FuncC(&amp;start, <span class="hljs-number">63</span>, <span class="hljs-number">51</span>);<br>    display(start);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FuncA-的作用是"><a href="#FuncA-的作用是" class="headerlink" title="FuncA 的作用是"></a>FuncA 的作用是</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">FuncA</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node **start, <span class="hljs-type">int</span> value)</span> &#123;<br>    <span class="hljs-comment">// 這是 circular 的 link list</span><br>    <span class="hljs-keyword">if</span> (!*start) &#123;<br>        <span class="hljs-comment">// 初始 node，prev、next 都指向自己</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>        new_node-&gt;data = value;<br>        new_node-&gt;next = new_node-&gt;prev = new_node;<br>        *start = new_node;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">last</span> =</span> (*start)-&gt;prev; <span class="hljs-comment">// 因為是 circular，start 的 prev 就是最後一個 node</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    new_node-&gt;data = value;<br>    new_node-&gt;next = *start; <span class="hljs-comment">// 這裡可以發現新 node 的 next 是 start，所以是新加在 link list 的最後面</span><br>    (*start)-&gt;prev = new_node; <br>    new_node-&gt;prev = last;<br>    last-&gt;next = new_node;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Ans"><a href="#Ans" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">(e) 建立新節點，內容是 value，並安插在結尾</code></pre><h4 id="FuncB-的作用是"><a href="#FuncB-的作用是" class="headerlink" title="FuncB 的作用是"></a>FuncB 的作用是</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">FuncB</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node **start, <span class="hljs-type">int</span> value)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">last</span> =</span> (*start)-&gt;prev;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    new_node-&gt;data = value;<br>    new_node-&gt;next = *start;<br>    new_node-&gt;prev = last; <br>    last-&gt;next = (*start)-&gt;prev = new_node; <span class="hljs-comment">// 到這邊是新加一個 node start 的 prev，last 的 next</span><br>    *start = new_node; <span class="hljs-comment">// 更新 start，可以得知新 node 是新的 start，所以變成是加在 list 最前面</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Ans-1"><a href="#Ans-1" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">(d) 建立新節點，內容是 value，並安插在開頭</code></pre><h4 id="FuncC-的作用是"><a href="#FuncC-的作用是" class="headerlink" title="FuncC 的作用是"></a>FuncC 的作用是</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">FuncC</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node **start, <span class="hljs-type">int</span> value1, <span class="hljs-type">int</span> value2)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">new_node</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    new_node-&gt;data = value1;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">temp</span> =</span> *start;<br>    <span class="hljs-keyword">while</span> (temp-&gt;data != value2) <span class="hljs-comment">// 找到 value 為 value2 的 node</span><br>        temp = temp-&gt;next;<br>    <span class="hljs-comment">// 把新加的 value1 的 node 加在 value2 的 node 後面</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">next</span> =</span> temp-&gt;next;<br>    temp-&gt;next = new_node;<br>    new_node-&gt;prev = temp;<br>    new_node-&gt;next = next;<br>    next-&gt;prev = new_node;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Ans-2"><a href="#Ans-2" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">(e) 找到節點內容為 value2 的節點，並在之後插入新節點，內容為 value1</code></pre><h4 id="在程式輸出中，訊息-Traversal-in-forward-direction-後依序印出哪幾個數字呢？"><a href="#在程式輸出中，訊息-Traversal-in-forward-direction-後依序印出哪幾個數字呢？" class="headerlink" title="在程式輸出中，訊息 Traversal in forward direction 後依序印出哪幾個數字呢？"></a>在程式輸出中，訊息 Traversal in forward direction 後依序印出哪幾個數字呢？</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">start</span> =</span> <span class="hljs-literal">NULL</span>;<br>    FuncA(&amp;start, <span class="hljs-number">51</span>); <span class="hljs-comment">// 51</span><br>    FuncB(&amp;start, <span class="hljs-number">48</span>); <span class="hljs-comment">// 48 -&gt; 51 </span><br>    FuncA(&amp;start, <span class="hljs-number">72</span>); <span class="hljs-comment">// 48 -&gt; 51 -&gt; 72</span><br>    FuncA(&amp;start, <span class="hljs-number">86</span>); <span class="hljs-comment">// 48 -&gt; 51 -&gt; 72 -&gt; 86</span><br>    FuncC(&amp;start, <span class="hljs-number">63</span>, <span class="hljs-number">51</span>); <span class="hljs-comment">// 48 -&gt; 51 -&gt; 63 -&gt; 72 -&gt; 86</span><br>    display(start);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Ans-3"><a href="#Ans-3" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">48 -&gt; 51 -&gt; 63 -&gt; 72 -&gt; 86</code></pre><h4 id="在程式輸出中，訊息-Traversal-in-reverse-direction-後依序印出哪幾個數字呢？"><a href="#在程式輸出中，訊息-Traversal-in-reverse-direction-後依序印出哪幾個數字呢？" class="headerlink" title="在程式輸出中，訊息 Traversal in reverse direction 後依序印出哪幾個數字呢？"></a>在程式輸出中，訊息 Traversal in reverse direction 後依序印出哪幾個數字呢？</h4><h5 id="Ans-4"><a href="#Ans-4" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">86 -&gt; 72 -&gt; 63 -&gt; 51 -&gt; 48</code></pre><h3 id="Quiz-2"><a href="#Quiz-2" class="headerlink" title="Quiz 2"></a>Quiz 2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-comment">/* Link list node */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span> <span class="hljs-type">int</span> data; <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">next</span>;</span> &#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">FuncX</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node *head, <span class="hljs-type">int</span> *data)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">node</span>;</span><br>    <span class="hljs-keyword">for</span> (node = head-&gt;next; node &amp;&amp; node != head; node = node-&gt;next)<br>        data++;<br>    <span class="hljs-keyword">return</span> node - head;<br>&#125;<br><br><span class="hljs-keyword">struct</span> node *<span class="hljs-title function_">node_new</span><span class="hljs-params">(<span class="hljs-type">int</span> data)</span> &#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">temp</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node));<br>    temp-&gt;data = data; temp-&gt;next = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">return</span> temp;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">head</span> =</span> node_new(<span class="hljs-number">0</span>);<br>    head-&gt;next = node_new(<span class="hljs-number">1</span>);<br>    head-&gt;next-&gt;next = node_new(<span class="hljs-number">2</span>);<br>    head-&gt;next-&gt;next-&gt;next = node_new(<span class="hljs-number">3</span>);<br>    head-&gt;next-&gt;next-&gt;next-&gt;next = node_new(<span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K1 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>);<br>    head-&gt;next-&gt;next-&gt;next-&gt;next = head;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K2 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>);<br>    head-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next = head-&gt;next;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K3 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>);<br>    head-&gt;next = head-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K4 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K5 &gt;&gt; %d\n&quot;</span>, head-&gt;next-&gt;data);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;count &gt;&gt; %d\n&quot;</span>, count);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FuncX-的作用是-涵蓋程式執行行為的正確描述最多者"><a href="#FuncX-的作用是-涵蓋程式執行行為的正確描述最多者" class="headerlink" title="FuncX 的作用是 (涵蓋程式執行行為的正確描述最多者)"></a>FuncX 的作用是 (涵蓋程式執行行為的正確描述最多者)</h4><h5 id="Ans-5"><a href="#Ans-5" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">(f) 判斷是否為 circular linked list，若為 circular 則回傳 0，其他非零值，過程中計算走訪的節點總數</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">head</span> =</span> node_new(<span class="hljs-number">0</span>); <span class="hljs-comment">// 0</span><br>    head-&gt;next = node_new(<span class="hljs-number">1</span>); <span class="hljs-comment">// 0 -&gt; 1</span><br>    head-&gt;next-&gt;next = node_new(<span class="hljs-number">2</span>); <span class="hljs-comment">// 0 -&gt; 1 -&gt; 2</span><br>    head-&gt;next-&gt;next-&gt;next = node_new(<span class="hljs-number">3</span>); <span class="hljs-comment">// 0 -&gt; 1 -&gt; 2 -&gt; 3</span><br>    head-&gt;next-&gt;next-&gt;next-&gt;next = node_new(<span class="hljs-number">4</span>); <span class="hljs-comment">// 0 -&gt; 1 -&gt; 2 -&gt; 3 -&gt; 4</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K1 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>); <span class="hljs-comment">// Yes</span><br>    head-&gt;next-&gt;next-&gt;next-&gt;next = head; <span class="hljs-comment">// 0 -&gt; 1 -&gt; 2 -&gt; 3 -&gt; 0 -&gt; ...</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K2 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>); <span class="hljs-comment">// No</span><br>    head-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next = head-&gt;next; <span class="hljs-comment">// 0 -&gt; 1 -&gt; 2 -&gt; 3 -&gt; 0 -&gt; ...</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K3 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>); <span class="hljs-comment">// No</span><br>    head-&gt;next = head-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next-&gt;next; <span class="hljs-comment">// 0 -&gt; 0 -&gt; ...</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K4 &gt;&gt; %s\n&quot;</span>, FuncX(head, &amp;count) ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>); <span class="hljs-comment">// No</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;K5 &gt;&gt; %d\n&quot;</span>, head-&gt;next-&gt;data); <span class="hljs-comment">// 0</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;count &gt;&gt; %d\n&quot;</span>, count); <span class="hljs-comment">// 10</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="K1-後面接的輸出為何"><a href="#K1-後面接的輸出為何" class="headerlink" title="K1 &gt;&gt; 後面接的輸出為何"></a>K1 &gt;&gt; 後面接的輸出為何</h4><h5 id="Ans-6"><a href="#Ans-6" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">Yes</code></pre><h4 id="K2-後面接的輸出為何"><a href="#K2-後面接的輸出為何" class="headerlink" title="K2 &gt;&gt; 後面接的輸出為何"></a>K2 &gt;&gt; 後面接的輸出為何</h4><h5 id="Ans-7"><a href="#Ans-7" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">No</code></pre><h4 id="K3-後面接的輸出為何"><a href="#K3-後面接的輸出為何" class="headerlink" title="K3 &gt;&gt; 後面接的輸出為何"></a>K3 &gt;&gt; 後面接的輸出為何</h4><h5 id="Ans-8"><a href="#Ans-8" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">No</code></pre><h4 id="K4-後面接的輸出為何"><a href="#K4-後面接的輸出為何" class="headerlink" title="K4 &gt;&gt; 後面接的輸出為何"></a>K4 &gt;&gt; 後面接的輸出為何</h4><h5 id="Ans-9"><a href="#Ans-9" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">No</code></pre><h4 id="K5-後面接的輸出為何"><a href="#K5-後面接的輸出為何" class="headerlink" title="K5 &gt;&gt; 後面接的輸出為何"></a>K5 &gt;&gt; 後面接的輸出為何</h4><h5 id="Ans-10"><a href="#Ans-10" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">0</code></pre><h4 id="count-後面接的輸出為何"><a href="#count-後面接的輸出為何" class="headerlink" title="count &gt;&gt; 後面接的輸出為何"></a>count &gt;&gt; 後面接的輸出為何</h4><h5 id="Ans-11"><a href="#Ans-11" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">10</code></pre><h3 id="訂正"><a href="#訂正" class="headerlink" title="訂正"></a>訂正</h3><p>FuncX 的作用應為 <code>(e) 判斷是否為 circular linked list，若為 circular 則回傳 0，其他非零值</code>，沒辦法計算結點總數，因為它傳入的是 count 的 pointer，且在 FuncX 裡面是用 <code>data++</code> 而非 <code>(*data)++</code>，所以 main() 裡面的 count 應為 0</p><h2 id="2020q1-第-1-週測驗題"><a href="#2020q1-第-1-週測驗題" class="headerlink" title="2020q1 第 1 週測驗題"></a><a href="https://hackmd.io/@sysprog/linux2020-quiz1">2020q1 第 1 週測驗題</a></h2><h3 id="Quiz-1-1"><a href="#Quiz-1-1" class="headerlink" title="Quiz 1"></a>Quiz 1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">list</span> &#123;</span><br>    <span class="hljs-type">int</span> data;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">list</span> *<span class="hljs-title">next</span>;</span><br>&#125; <span class="hljs-built_in">list</span>;<br><br><span class="hljs-comment">// 在不存在環狀結構的狀況下，以下函式能夠對 linked list 元素從小到大排序:</span><br><span class="hljs-built_in">list</span> *<span class="hljs-title function_">sort</span><span class="hljs-params">(<span class="hljs-built_in">list</span> *start)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!start || !start-&gt;next)<br>        <span class="hljs-keyword">return</span> start;<br>    <span class="hljs-built_in">list</span> *left = start;<br>    <span class="hljs-built_in">list</span> *right = left-&gt;next;<br>    LL0;<br><br>    left = sort(left);<br>    right = sort(right);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">list</span> *merge = <span class="hljs-literal">NULL</span>; left || right; ) &#123;<br>        <span class="hljs-keyword">if</span> (!right || (left &amp;&amp; left-&gt;data &lt; right-&gt;data)) &#123;<br>            <span class="hljs-keyword">if</span> (!merge) &#123;<br>                LL1;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                LL2;<br>                merge = merge-&gt;next;<br>            &#125;<br>            LL3;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!merge) &#123;<br>                LL4;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                LL5;<br>                merge = merge-&gt;next;<br>            &#125;<br>            LL6;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> start;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="LL0"><a href="#LL0" class="headerlink" title="LL0 &#x3D; ?"></a>LL0 &#x3D; ?</h4><h5 id="Ans-12"><a href="#Ans-12" class="headerlink" title="Ans:"></a>Ans:</h5><pre><code class="hljs">(a) left-&gt;next = NULL</code></pre><h4 id="LL1"><a href="#LL1" class="headerlink" title="LL1 &#x3D; ?"></a>LL1 &#x3D; ?</h4><pre><code class="hljs">start = merge = left</code></pre><h4 id="LL2"><a href="#LL2" class="headerlink" title="LL2 &#x3D; ?"></a>LL2 &#x3D; ?</h4><pre><code class="hljs">merge-&gt;next = left</code></pre><h4 id="LL3"><a href="#LL3" class="headerlink" title="LL3 &#x3D; ?"></a>LL3 &#x3D; ?</h4><pre><code class="hljs">left = left-&gt;next</code></pre><h4 id="LL4"><a href="#LL4" class="headerlink" title="LL4 &#x3D; ?"></a>LL4 &#x3D; ?</h4><pre><code class="hljs">start = merge = right</code></pre><h4 id="LL5"><a href="#LL5" class="headerlink" title="LL5 &#x3D; ?"></a>LL5 &#x3D; ?</h4><pre><code class="hljs">merge-&gt;next = right</code></pre><h4 id="LL6"><a href="#LL6" class="headerlink" title="LL6 &#x3D; ?"></a>LL6 &#x3D; ?</h4><pre><code class="hljs">right = right-&gt;next</code></pre><ul><li><h3 id="解釋上述程式運作原理"><a href="#解釋上述程式運作原理" class="headerlink" title="解釋上述程式運作原理"></a>解釋上述程式運作原理</h3><p>  顯然這份程式碼是在做遞迴版的 Link list 的 <code>Insertion Sort</code>。</p><p>  當它分割成 left 和 right 兩份時，在運行最下方的 for loop 時 left 那份不能碰到 right 那份，兩者不應該重疊，因此可以合理推測 LL0 是 <code>left-&gt;next = NULL</code>。</p><p>  至於 for loop 做的事情只是單純一個一個 node 比大小而已，因此像是 <code>right 為空</code>或 <code>left 值 &lt; right 值</code>時，就更新 merge-&gt;next 的值為 left，然後由於最後是 return start node，因此當 merge 為空時 (第一個比較的出來的 node)，也要設定 start node，所以 LL1 是 <code>start = merge = left</code>。</p></li><li><h3 id="指出程式改進空間，特別是考慮到-Optimizing-merge-sort"><a href="#指出程式改進空間，特別是考慮到-Optimizing-merge-sort" class="headerlink" title="指出程式改進空間，特別是考慮到 Optimizing merge sort"></a>指出程式改進空間，特別是考慮到 <a href="https://en.wikipedia.org/wiki/Merge_sort#Optimizing_merge_sort">Optimizing merge sort</a></h3><p>  由於是在這份程式碼中， left 永遠只會有一個 node，並將其插入 right 中的 list。但是 Insertion Sort 的時間複雜度為 $\Theta(n^2)$。</p><p>  最好優化的方式自然會聯想到 <code>Merge Sort</code>，其時間複雜度為 $\Theta(n log(n))$，只要在這邊去尋找 list 的中點，將其設為 right，也就是讓 left 和 right 的長度相近，一人一半。</p></li><li><h3 id="將上述-singly-linked-list-擴充為-circular-doubly-linked-list-並重新實作對應的-sort"><a href="#將上述-singly-linked-list-擴充為-circular-doubly-linked-list-並重新實作對應的-sort" class="headerlink" title="將上述 singly-linked list 擴充為 circular doubly-linked list 並重新實作對應的 sort"></a>將上述 singly-linked list 擴充為 circular doubly-linked list 並重新實作對應的 sort</h3></li><li><h3 id="依循-Linux-核心-include-linux-list-h-程式碼的方式，改寫上述排序程式"><a href="#依循-Linux-核心-include-linux-list-h-程式碼的方式，改寫上述排序程式" class="headerlink" title="依循 Linux 核心 include&#x2F;linux&#x2F;list.h 程式碼的方式，改寫上述排序程式"></a>依循 Linux 核心 include&#x2F;linux&#x2F;list.h 程式碼的方式，改寫上述排序程式</h3></li><li><h3 id="嘗試將原本遞迴的程式改寫為-iterative-版本"><a href="#嘗試將原本遞迴的程式改寫為-iterative-版本" class="headerlink" title="嘗試將原本遞迴的程式改寫為 iterative 版本"></a>嘗試將原本遞迴的程式改寫為 iterative 版本</h3></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>作業系統筆記 Introduction</title>
    <link href="/notes/2024/07/09/os-chapter1/"/>
    <url>/notes/2024/07/09/os-chapter1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>周志遠教授作業系統開放式課程</p></blockquote><h1 id="Computer-System"><a href="#Computer-System" class="headerlink" title="Computer System"></a>Computer System</h1><ul><li>由 Hardware、OS、Application、User 組成<ul><li>User：people、machines</li><li>Application：使用 system resources 來解決問題的方式，像是各種軟體</li><li>Operation System：<strong>controls</strong> 與 <strong>coordinates</strong> 資源的使用</li><li>Hardware：提供基本的計算資源（CPU、memory、IO devices）</li></ul></li></ul><h1 id="What-is-an-Operation-System"><a href="#What-is-an-Operation-System" class="headerlink" title="What is an Operation System"></a>What is an Operation System</h1><ul><li><strong>Permanent</strong> Software<ul><li>電腦啟動後永遠存在，沒有它電腦就不會運作</li></ul></li><li><strong>Abstracts</strong> 硬體資源給使用者使用<ul><li>把底層的各種資源變成一堆 API，給使用者方便使用，virtual 的概念</li></ul></li></ul><h2 id="General-Purpose-Operating-Systems"><a href="#General-Purpose-Operating-Systems" class="headerlink" title="General-Purpose Operating Systems"></a>General-Purpose Operating Systems</h2><ul><li>Linker 會 link System Library，裡面有一堆 System call 的 API</li><li>使用 printf 的時候要印到螢幕，是 OS 負責的，所以要 system call<ul><li>user 呼叫 printf -&gt; printf 呼叫 system call -&gt; system call 呼叫 driver…</li></ul></li><li>Device drivers 是 OS 的一部分</li></ul><p><img src="/notes/./images/os-chapter1/GeneralPurposeOperatingSystems.png" alt="General-Purpose Operating Systems"></p><h2 id="OS-的定義"><a href="#OS-的定義" class="headerlink" title="OS 的定義"></a>OS 的定義</h2><ul><li>Resource allocator<ul><li><strong>manages</strong> 和 <strong>allocates resources</strong> 來確保公平性和效率</li></ul></li><li>Control program<ul><li><strong>controls</strong> 程式的執行 (driver) 和 IO devices 的操作</li></ul></li><li>Kernel<ul><li>OS 又稱為 Kernel</li></ul></li></ul><h2 id="OS-的目的"><a href="#OS-的目的" class="headerlink" title="OS 的目的"></a>OS 的目的</h2><ul><li>方便性 (convenience)<ul><li>像是 windows 的崛起，也就是發展出圖形介面，讓使用者更方便操作</li></ul></li><li>效率 (Efficiency)<ul><li>更有效率的使用資源，當問題很複雜時，Efficiency 是最後追求的東西</li><li>像是很多人用 Linux，是因為圖形介面也會吃資源，但那不是必要的</li></ul></li><li>兩者衝突，追求方便性效率就下降，追求效率方面性就下降</li></ul><h2 id="OS-的重要性"><a href="#OS-的重要性" class="headerlink" title="OS 的重要性"></a>OS 的重要性</h2><ul><li>OS 是 user program 和 hardware 之間 <strong>唯一</strong> 的 interface，一定需要經過它</li><li>OS 絕對不能有 bug，一旦 crash 掉整台電腦就掛了</li><li>OS 和電腦的架構息息相關，因此隨著需求不同，也發展出形形色色的 OS</li></ul><h1 id="Computer-System-Organization"><a href="#Computer-System-Organization" class="headerlink" title="Computer-System Organization"></a>Computer-System Organization</h1><ul><li>由一個 Bus 連接 CPU、Memory、IO Device 等，作業系統就負責 <strong>Control</strong> 和 <strong>Coordinate</strong></li></ul><p><img src="/notes/./images/os-chapter1/ComputerSystemOrganization.png" alt="Computer-System Organization"></p><h2 id="Device-Controller-Hardware"><a href="#Device-Controller-Hardware" class="headerlink" title="Device Controller (Hardware)"></a>Device Controller (Hardware)</h2><ul><li>負責控制最 low level 的硬體，每個 Device 會有一個 Device Controller 來做溝通</li><li>Status reg 用來記錄現在 device controller 是 busy 還是 idle</li><li>Data reg 和 buffer 都是用來存資料，會先寫到 reg 再寫到 buffer</li><li>CPU 下指令後，Device controller 就能夠去 access disk 資料到自己的 local buffer</li><li>Memory 是 CPU 在用的，所以 CPU 負責 移入&#x2F; 移出 memory 的資料到 Device Controller 上的 local buffer</li></ul><p><img src="/notes/./images/os-chapter1/DeviceController.png" alt="Device Controller"></p><p>由於 Device Controller 上的 Buffer 空間是有限的，因此會需要用一些技巧來解決，像是 Busy&#x2F; wait、Interrupt</p><h2 id="Busy-wait-output"><a href="#Busy-wait-output" class="headerlink" title="Busy&#x2F;wait output"></a>Busy&#x2F;wait output</h2><ul><li>最簡單暴力的運行方式，但是很浪費 CPU，CPU 變成用來監控 Buffer</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> OUT_CHAR 0x1000 <span class="hljs-comment">// device data register</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OUT_STATUS 0x1001 <span class="hljs-comment">// device status register</span></span><br><br>current_char = mystring;<br><span class="hljs-keyword">while</span> (*current_char != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;<br>  <span class="hljs-built_in">poke</span>(OUT_CHAR,*current_char); <span class="hljs-comment">// 寫到 device controller 的 buffer</span><br>  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">peek</span>(OUT_STATUS) != <span class="hljs-number">0</span>); <span class="hljs-comment">// busy waiting</span><br>  current_char++;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Interrupt-I-O"><a href="#Interrupt-I-O" class="headerlink" title="Interrupt I&#x2F;O"></a>Interrupt I&#x2F;O</h2><ul><li>原本 CPU 在執行某程式碼，Interrupt 可以打斷這件事情，要求 CPU 先做其他事情，做完之後再回去執行原本的程式碼</li><li>現在的作業系統都是這種形式</li></ul><p><img src="/notes/./images/os-chapter1/InterruptDrivenIO.png" alt="Interrupt-Driven I/O"></p><p>又可以分成 Hardware 和 Software</p><h3 id="Hardware-Interrupt"><a href="#Hardware-Interrupt" class="headerlink" title="Hardware Interrupt"></a>Hardware Interrupt</h3><ul><li>又稱為 Signal</li></ul><h4 id="Interrupt-Service-Routine"><a href="#Interrupt-Service-Routine" class="headerlink" title="Interrupt Service Routine"></a>Interrupt Service Routine</h4><ul><li>interrupt vector 是 array of function pointers，array 大小是固定的<ul><li>因為每個 function 的程式碼大小不同，所以這邊用指標來儲存，每個欄位是 4 bytes</li></ul></li><li>signal 都會有一個 singal number，根據這個 number 去找 vector 上的欄位</li><li>每個 port 的 hardware 有燒死的 singal number， 裝 driver 的時候會 overwrite 那個欄位的 fucntion pointer 的位置，去執行你要處理的程式碼</li></ul><p><img src="/notes/./images/os-chapter1/Hardwareinterrupt.png" alt="Hardware interrupt"></p><h3 id="Softwarae-Interrupt"><a href="#Softwarae-Interrupt" class="headerlink" title="Softwarae Interrupt"></a>Softwarae Interrupt</h3><ul><li>又稱為 Trap</li></ul><h4 id="Interrupt-Service-Routine-1"><a href="#Interrupt-Service-Routine-1" class="headerlink" title="Interrupt Service Routine"></a>Interrupt Service Routine</h4><ul><li>是用 switch case 而不是 array，因為軟體有無限的可能性，可以任意定義各種不同的 system call</li><li>流程跟 hardware interrupt 差不多，根據 system call 的 number 來去找尋對應的 function call</li><li>通常是使用者的程式去 Trigger 的，又可以分成主動和被動<ul><li>主動，也就是去 call <strong>System Call</strong></li><li>被動像是出現 Error 的時候要處理</li></ul></li></ul><p><img src="/notes/./images/os-chapter1/Softwareinterrupt.png" alt="Software interrupt"></p><p>不管是 Hardware Interrupt 或是 Software Interrupt，Interrupt 的時候必須記得被打斷的程式的 Instruction Address，才能再處理完 Interrupt 回去繼續執行。</p><p>有時候 Interrupt 還會有 Hierachy，像是有時候動滑鼠會沒有反應，是因為它卡在某 Interrupt routine 裡面，所以沒有處理到滑鼠的 Interrupt</p><h1 id="Storage-Device-Hierarchy"><a href="#Storage-Device-Hierarchy" class="headerlink" title="Storage-Device Hierarchy"></a>Storage-Device Hierarchy</h1><p><img src="/notes/./images/os-chapter1/StorageDeviceHierarchy.png" alt="Storage-Device Hierarchy"></p><ul><li>真正的大型的系統最後還是用 tapes，因為非常 reliable，不太容易壞，而且很便宜</li><li>這是最傳統的架構，現在有很多其他的 storage device 會插在中間</li><li>要考量的點<ul><li>speed, cost, <strong>volatility</strong></li><li>volatile 關掉會遺失，memory 以上的全部都是 volatile</li></ul></li><li><strong>Main memory</strong> 是 CPU 能夠直接 access 的唯一大型的 storage</li><li>Secondary storage<ul><li>memory 以下都叫做 secondary storage，代表 CPU 沒辦法直接讀取</li><li><strong>是大型的 non-volatile 的 storage</strong></li></ul></li></ul><h3 id="Random-Access-Memory"><a href="#Random-Access-Memory" class="headerlink" title="Random-Access Memory"></a>Random-Access Memory</h3><ul><li><p>DRAM (Dynamic RAM)</p><ul><li>one transistor</li><li>less power</li><li>must be periodically refreshed</li><li>體積小，速度比較慢</li><li>因為 CPU 有很多 core， RAM 的速度其實就那樣，channel 的 bus 其實才是真正的 bottleneck</li><li>Main Memory</li></ul></li><li><p>SRAM (Static RAM)</p><ul><li>six transistors</li><li>more power</li><li>Cache Memory</li></ul></li></ul><p>Random Access 重要的地方是，你讀取任何位置的資料，時間都是一樣的，才能確保每次執行的結果相同，如果不一樣的話使用者會很難控制電腦</p><h3 id="Disk-Mechanism"><a href="#Disk-Mechanism" class="headerlink" title="Disk Mechanism"></a>Disk Mechanism</h3><ul><li>讀取的時間跟資料的位置有關係</li><li>速度計算<ul><li>Transfer Time &#x3D; data size &#x2F; transfer rate</li><li>Positioning Time &#x3D; Seek Time (Cylinder) + Rotational Latency (Sector)</li></ul></li><li>如果是連續資料的讀取，其實 Hard Drive 並不會輸 SSD</li></ul><p><img src="/notes/./images/os-chapter1/PerformanceOfVariousStorage.png" alt="Performance Of Various Storage"></p><h3 id="Caching"><a href="#Caching" class="headerlink" title="Caching"></a>Caching</h3><ul><li>把速度比較慢的 Storage 複製到速度比較快的 Storage</li><li>如果這層找不到資料，會一層一層往下檢查，直到找到，所以有時候會比沒有 Caching 還慢</li></ul><p><img src="/notes/./images/os-chapter1/Caching.png" alt="Caching"></p><h4 id="Coherency-and-Consistency-Issue"><a href="#Coherency-and-Consistency-Issue" class="headerlink" title="Coherency and Consistency Issue"></a>Coherency and Consistency Issue</h4><ul><li><p>對資料做修改時，如果 Cache 修改資料時沒有更新到 Memory，其他程式在讀取時，會發生這種問題。像是 Multi-Core Processor 就會需要去處理，因為大家的 L1 Cache 是不同的，但是 L2、L3 相同</p></li><li><p>Single task accessing</p><ul><li>基本上沒問題，只會用到最上層的</li></ul></li><li><p>Multi-task Accessing</p><ul><li>要處理大量這類的問題</li></ul></li><li><p>Distributed System</p><ul><li>更加複雜，還要考慮到網路的問題</li></ul></li></ul><h1 id="Hardware-Protection"><a href="#Hardware-Protection" class="headerlink" title="Hardware Protection"></a>Hardware Protection</h1><p>不是指 Security (網路攻擊、惡意攻擊)，指的是很多程式在執行，或是很多使用者在執行時，不會影響彼此，像是 Memory 的內容只有我自己能夠讀取，其他使用者無法讀取</p><h2 id="Dual-Mode"><a href="#Dual-Mode" class="headerlink" title="Dual-Mode"></a>Dual-Mode</h2><ul><li>藉由 <strong>Hardware Support</strong> 來做最基本的 Protection，其他軟體會基於 Hardware 來實現 Protection<ul><li>User Mode - 來自使用者執行的程式</li><li>Monitor Mode (Kernel Mode) - 來自 OS 執行使用者的程式</li></ul></li><li>Call Interrupt 時，它知道你正在用 System Call，所以它會把 Mode bit 變成 0 (Kernel Mode)，沒有的話就是 1 (User Mode)</li></ul><h3 id="Priviledge-Instructions"><a href="#Priviledge-Instructions" class="headerlink" title="Priviledge Instructions"></a>Priviledge Instructions</h3><ul><li>必須在 Kernel Mode 才能執行的 Instruction，如果他發現 Mode bit 是 1，它會告訴 OS，送給你一個 fault</li><li>保護電腦，不然使用者隨便寫個 Instruction 送到 CPU 就可以控制硬體</li></ul><h2 id="I-O-Protection"><a href="#I-O-Protection" class="headerlink" title="I&#x2F;O Protection"></a>I&#x2F;O Protection</h2><ul><li>每個 I&#x2F;O Instructions 都是 <strong>Previledge Instructions</strong>，都要透過 OS</li><li>早期有個 Bypass Hack 的方式，也就是去改寫 Interrupt Vector 裡面的值，所以 OS 就能去執行我自己想要的程式碼</li></ul><h2 id="Memory-Protection"><a href="#Memory-Protection" class="headerlink" title="Memory Protection"></a>Memory Protection</h2><ul><li>Protect<ul><li>要保護 Interrupt Vector、Interrupt Service Routines</li><li>不能 Overwrite 別人的程式碼</li></ul></li><li>Haredware Support: 使用兩個 register 來記錄能夠讀取的記憶體區間<ul><li>Base register: 開始的位址</li><li>Limit register: 這段佔記憶體多長</li><li>超過這段空間就會有 <strong>Segmentation Fault</strong></li><li>修改 Base register 和 Limit register 都是 Priviledge Instructions</li></ul></li></ul><p><img src="/notes/./images/os-chapter1/UseofBaseandLimitRegister.png" alt="Use of Base and Limit Register"><br><img src="/notes/./images/os-chapter1/HardwareAddressProtection.png" alt="Hardware Address Protection"></p><h2 id="CPU-Protection"><a href="#CPU-Protection" class="headerlink" title="CPU Protection"></a>CPU Protection</h2><ul><li>阻止某隻程式霸佔 CPU，像是無窮迴圈</li><li>Hardware Support: <strong>Timer</strong><ul><li>Timer 是慢慢減少，當變成 0 時，會送出 Interrupt</li><li>Timer 通常用來實現 Time Sharing</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>OS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>作業系統筆記 Historical Prospective</title>
    <link href="/notes/2024/07/02/os-chapter0/"/>
    <url>/notes/2024/07/02/os-chapter0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>周志遠教授作業系統開放式課程</p></blockquote><p>作業系統介於硬體和軟體之間，是不可或缺的</p><h1 id="Mainframe-Systems"><a href="#Mainframe-Systems" class="headerlink" title="Mainframe Systems"></a>Mainframe Systems</h1><ul><li>最早的電腦，體積很大</li><li>IO 很慢，做的事情非常單一</li><li>演化順序：Batch -&gt; Multi-programming -&gt; Time-shared</li><li>現在仍然存在，意旨專門處理一件事情的機器，很多伺服器在用，負責大量資料的處理</li></ul><h2 id="Batch"><a href="#Batch" class="headerlink" title="Batch"></a>Batch</h2><ul><li>電腦管理者要親自決定執行順序，決定哪個程式要先執行</li><li>工作很單純，所以 OS 不需要做甚麼特別的事情，除了基本工作以外，只需要把一項工作切換到下一個</li><li>缺點<ul><li>一次只能處理一個程式</li><li>沒有 <strong>interaction</strong>，在執行一個工作的過程中，使用者完全沒辦法做任何改變</li><li>IO 非常慢，導致 CPU 常常掛機，浪費資源<ul><li>IO 速度遠比 CPU 速度慢</li></ul></li></ul></li></ul><p><img src="/notes/./images/os-chapter0/BatchSystem.png" alt="Batch System"></p><h2 id="Multi-programming"><a href="#Multi-programming" class="headerlink" title="Multi-programming"></a>Multi-programming</h2><ul><li>讓系統裡面放多個程式<ul><li>當一個程式在做 IO 時，就可以切換到別的程式，overlap CPU 和 IO 的計算，保證 CPU 持續工作</li></ul></li><li>Spooling (Simutaneous Peripheral Operation On-Line)<ul><li>不用 CPU 干預就可以完成 I&#x2F;O 的工作</li><li>CPU 只需要在 IO 做完的時候被通知就好</li></ul></li><li>CPU 在執行的時候只能讀取 memory，所以我們把多個程式同時 load 到 main memory<ul><li>要 load disk 的哪些程式到 memory？-&gt; <strong>Job Scheduling</strong></li><li>要 load memory 的哪些程式到 CPU？-&gt; <strong>CPU Scheduling</strong></li></ul></li><li>在其中，OS 的工作包含：<ul><li>Memory management，要分配多少記憶體給這些程式</li><li>CPU Scheduling，CPU 要執行 memory 的哪些程式</li><li>IO system，如何透過 interrupt，實現 Spooling</li></ul></li></ul><h2 id="Time-Sharing-System-Multi-tasking"><a href="#Time-Sharing-System-Multi-tasking" class="headerlink" title="Time-Sharing System (Multi-tasking)"></a>Time-Sharing System (Multi-tasking)</h2><ul><li>Multi-programming 讓 CPU 的使用率變高，但是對於單一程式而言，可能會執行更慢</li><li>使用者想要隨時與程式做互動，也希望可以很多使用者同時使用電腦</li><li>用時間的觀念去切割資源，讓所有程式一起執行</li><li>很頻繁切換 CPU 和 IO，就可以偵測使用者的 input，就有互動的感覺</li><li>不是一次做完一個程式的計算，而是每個程式只計算幾毫秒，就切換到下一個程式，讓使用者以為所有程式同時在執行</li><li>在其中，OS 的工作包含<ul><li>Virtual memory，把 disk 當作 memory，因為我想要塞更多程式到 memory，但是 memory 不夠大</li><li>File system 和 disk management，有了 interactive，使用者就可以直接管理檔案</li><li>Process synchronization 和 deadlock，程式和程式之間可以溝通，當他們同時修改 memory 的內容時就會有問題</li></ul></li></ul><p><img src="/notes/./images/os-chapter0/MainframeSystemSummary.png" alt="Mainframe System Summary"></p><h1 id="Computer-system-architecture"><a href="#Computer-system-architecture" class="headerlink" title="Computer-system architecture"></a>Computer-system architecture</h1><h2 id="Desktop-Systems-single-processor"><a href="#Desktop-Systems-single-processor" class="headerlink" title="Desktop Systems: single processor"></a>Desktop Systems: single processor</h2><ul><li>PC (Personal Computers)，只給一位 user 使用</li><li>GUI (User <strong>convenience</strong> and <strong>responsiveness</strong>)</li><li>I&#x2F;O devices</li><li>Windows, MacOS, Unix, Linux</li></ul><h2 id="Parallel-Systems-tightly-coupled"><a href="#Parallel-Systems-tightly-coupled" class="headerlink" title="Parallel Systems: tightly coupled"></a>Parallel Systems: tightly coupled</h2><ul><li>又稱為 <strong>Multiprocessor</strong> or <strong>tightly coupled system</strong></li><li>很多 CPU 緊密在一起</li><li>這些 CPU 用同個 <strong>shared memory</strong></li><li>Purposes<ul><li>Throughput<ul><li>計算量增加</li></ul></li><li>Economical<ul><li>很多東西可以共用，memory、CPU、IO device、主機板…</li></ul></li><li>Reliability<ul><li>一個 CPU 掛了，其他還能繼續工作</li></ul></li></ul></li><li>現今所有系統都是這種系統</li></ul><p><img src="/notes/./images/os-chapter0/ParallelSystems.png" alt="Parallel Systems"></p><h3 id="SMP-Symmetric-multiprocessor-system"><a href="#SMP-Symmetric-multiprocessor-system" class="headerlink" title="SMP (Symmetric multiprocessor system)"></a>SMP (Symmetric multiprocessor system)</h3><ul><li>每個 CPU 的角色相同，都由 OS 控制，沒有 Master</li><li>比較簡單，所以比較普及，我們手上有的系統幾乎都是這類</li><li>需要 <strong>synchronization</strong>，增加 overhead</li><li>Master CPU 無法用來計算，只能用來管理</li></ul><h3 id="AMP-Asymmetric-multiprocessor-system"><a href="#AMP-Asymmetric-multiprocessor-system" class="headerlink" title="AMP (Asymmetric multiprocessor system)"></a>AMP (Asymmetric multiprocessor system)</h3><ul><li>超級電腦等需要大量計算的會用這類</li><li>有一個 Master CPU，只用來管理其他 CPU ，所以 core 可以比較多</li></ul><h3 id="Multi-Core-Processor"><a href="#Multi-Core-Processor" class="headerlink" title="Multi-Core Processor"></a>Multi-Core Processor</h3><ul><li>一個 CPU 裡面有很多 Core</li></ul><p><img src="/notes/./images/os-chapter0/MultiCoreProcessor.png" alt="Multi-Core Processor"></p><h3 id="Many-Core-Processor"><a href="#Many-Core-Processor" class="headerlink" title="Many-Core Processor"></a>Many-Core Processor</h3><ul><li>GPGPU<ul><li>Single Instruction Multiple Data (SIMD) 的操作</li><li>上千個 core</li></ul></li><li>Intel Xeon Phi</li><li>TILE64</li></ul><h3 id="Memory-Access-Architecture"><a href="#Memory-Access-Architecture" class="headerlink" title="Memory Access Architecture"></a>Memory Access Architecture</h3><h4 id="Uniform-Memory-Access-UMA"><a href="#Uniform-Memory-Access-UMA" class="headerlink" title="Uniform Memory Access (UMA)"></a>Uniform Memory Access (UMA)</h4><ul><li>每個 CPU access memory 的速度相同，使用者不用在乎現在是在哪個 CPU 上執行</li><li>CPU 增加時，memory 可能開始有 bottleneck</li></ul><p><img src="/notes/./images/os-chapter0/UMA.png" alt="UMA"></p><h4 id="Non-Uniform-Memory-Access-NUMA"><a href="#Non-Uniform-Memory-Access-NUMA" class="headerlink" title="Non-Uniform Memory Access (NUMA)"></a>Non-Uniform Memory Access (NUMA)</h4><ul><li>每個 CPU 的 access time 變得不同</li><li>hierarchy 的架構，可以建構更大的電腦</li><li>高效能計算系統都是 NUMA</li></ul><p><img src="/notes/./images/os-chapter0/NUMA.png" alt="NUMA"></p><h2 id="Distributed-Systems-loosely-coupled"><a href="#Distributed-Systems-loosely-coupled" class="headerlink" title="Distributed Systems: loosely coupled"></a>Distributed Systems: loosely coupled</h2><ul><li>每個 processor 有 local memory，不會 share</li><li>很好擴展更多裝置</li><li>Purposes<ul><li>Resource sharing</li><li>Load sharing<ul><li>某電腦工作量太大可以分給別台做</li></ul></li><li>Reliability<ul><li>一台電腦壞掉不會影響其他台</li></ul></li></ul></li></ul><h3 id="Client-Server"><a href="#Client-Server" class="headerlink" title="Client-Server"></a>Client-Server</h3><ul><li>很好管理與控制資源</li><li>Server 可能會變成 bottleneck 或是 single failure point</li><li>FTP</li></ul><h3 id="Peer-to-Peer"><a href="#Peer-to-Peer" class="headerlink" title="Peer-to-Peer"></a>Peer-to-Peer</h3><ul><li>Decentralized，每個系統的角色是一樣的</li><li>ppStream, bitTorrent, Internet</li></ul><h3 id="Clustered-Systems"><a href="#Clustered-Systems" class="headerlink" title="Clustered Systems"></a>Clustered Systems</h3><ul><li>Share Storage</li><li>通常用 Local Area Network (LAN)，在同個區域，所以會更快</li><li>Asymmetric clustering, Symmetric clustering</li></ul><p><img src="/notes/./images/os-chapter0/SystemArchitecture.png" alt="System Architecture"></p><h1 id="Special-purpose-Systems"><a href="#Special-purpose-Systems" class="headerlink" title="Special-purpose Systems"></a>Special-purpose Systems</h1><h2 id="Real-Time-Operating-Systems"><a href="#Real-Time-Operating-Systems" class="headerlink" title="Real-Time Operating Systems"></a>Real-Time Operating Systems</h2><ul><li>Well-defined <strong>fixed-time contraints</strong><ul><li>Real-time 代表會在 deadlines 之前做完，跟做得速度沒關係</li></ul></li></ul><h3 id="Soft-real-time"><a href="#Soft-real-time" class="headerlink" title="Soft real-time"></a>Soft real-time</h3><ul><li>盡量完成，沒完成也不會有什麼損失</li><li>會有 priority，比較重要的會先做</li><li>Ex: multimedia streaming<ul><li>畫面不是馬上畫出來，可能會先出現線條，然後顏色，最後高解析度</li></ul></li><li></li></ul><h3 id="Hard-real-time"><a href="#Hard-real-time" class="headerlink" title="Hard real-time"></a>Hard real-time</h3><ul><li>沒有在 deadline 完成，會造成嚴重的後果</li><li>Secondary storage limited or absent<ul><li>沒有 disk，因為讀取太慢，而且讀取時間不好掌握</li></ul></li><li>Ex: nuclear power plant controller</li></ul><h2 id="Multimedia-Systems"><a href="#Multimedia-Systems" class="headerlink" title="Multimedia Systems"></a>Multimedia Systems</h2><ul><li>A wide range of applications including audio and video files</li><li>Issues<ul><li>Timing contraints，屬於 soft real-time</li><li>On-demand&#x2F;live streaming</li><li>Compression，有各種壓縮技術</li></ul></li></ul><h2 id="Handheld-Embedded-Systems"><a href="#Handheld-Embedded-Systems" class="headerlink" title="Handheld&#x2F;Embedded Systems"></a>Handheld&#x2F;Embedded Systems</h2><ul><li>Hardware specialized OS</li><li>Issues<ul><li>Limited memory</li><li>Slow processors</li><li>Battery consumption</li><li>Samll display screens</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>OS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity Compute Shader</title>
    <link href="/notes/2024/06/12/unity-render-1/"/>
    <url>/notes/2024/06/12/unity-render-1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>3D 虛擬影像即時互動 期末報告</p></blockquote><p>相信大家在遊戲中都有看過一些很複雜炫泡的特效，一定會很好奇為什麼這樣做不會 Lag，像是各種複雜的粒子效果、大量物體同時移動、物理模擬等等。</p><p><img src="/notes/./images/unity-render-1/ComputeShaderDemo.gif" alt="Compute Shader Demo"></p><p><img src="/notes/./images/unity-render-1/ComputeShaderDemo1.gif" alt="Compute Shader Demo"></p><p>這些酷酷特效的背後到底做了哪些工作呢？這篇文章將來探討如何在 Unity 使用 Compute Shader 加速計算，還會提及一些比較常見的優化遊戲效能的技術。</p><p>本文有點長，而且內容有點 Hardcore，涉及到 CPU 和 GPU 的協作、Shader 的應用、HLSL 等等，可能需要一些圖學的背景知識會比較好理解，算是比較進階的教學。</p><h2 id="CPU、GPU-基本介紹"><a href="#CPU、GPU-基本介紹" class="headerlink" title="CPU、GPU 基本介紹"></a>CPU、GPU 基本介紹</h2><p>大家都知道，GPU (顯示卡) 是用來處理各種圖形渲染的工作，想要暢玩 3A 大作必定要先升級你的顯卡。那麼 GPU 為什麼有能力處理遊戲渲染呢？只用 CPU 不行嗎？</p><p>事實上是可以的 XD，只是非常非常慢，下面這個影片就沒有用 GPU，單純用最猛的 CPU 去跑 GTA-5，結果是跑得動的，但是 FPS 低到不行，根本玩不下去</p><iframe width = "100%" height = "315" src="//www.youtube.com/embed/oDIaHj-CGSI" frameborder="0" allowfullscreen></iframe><br><br><p>至於為什麼會這樣，就要先了解兩者的工作差異，這邊就拿最近最紅的 NVDIA Demo 的範例來介紹</p><p><img src="https://j.gifs.com/mL45Op.gif" alt="NVDIA CPU Example"></p><p>CPU 就像是一個天才，什麼都會、什麼都能做，能夠精確地完成任務，但是只能一項一項做。</p><p>在你的電腦中，CPU 扮演著大腦的角色，負責處理各種複雜的工作，處理作業系統和應用程式的所有運算任務，像是不斷切換正在執行的程式，讓它們看起來好像在同時執行一樣，或是處理你滑鼠點擊、鍵盤輸入等等，最底層的硬體都是由 CPU 負責的。</p><p><img src="https://miro.medium.com/v2/resize:fit:924/1*aQQcuLKQgFKEECPhkEKTqQ.gif" alt="NVDIA GPU Example"></p><p>而 GPU 就像是一堆普通人，每個人只會做相同類型的普通計算，人與人之間的工作沒有關聯，不會影響彼此。這些人沒辦法做複雜的工作，但是它們可以<strong>同時工作</strong>，完成大量計算的任務。</p><p>在圖形渲染中，以最簡單的例子來講，我們會需要去處理每個 Vertex 的 Transformation，把模型的每個 vertex 投影到螢幕上 (每個 vertex 要乘上相同的變換矩陣)。我們還要處理每個 Pixel 的 Lighting (每個 Pixel 要乘上相同的光照計算公式)…</p><p>可以看到，每個 vertex、pixel 都要做相同的工作 (乘上相同的某某東西)，這時候就可以利用 GPU 強大的平行計算能力，快速處理這些<strong>龐大且相同的工作</strong>。</p><p><img src="https://angus945.github.io/learn/compute-shader/compute-shader-basis/cpu-vs-gpu.gif" alt="CPU vs GPU"></p><p>事實上，現代 CPU 通常都有 4 核、8 核等等，也擁有平行計算的能力，但是跟 GPU 的上百、上千核來比還是相形見絀，當然這邊不是說 CPU 就比不上 GPU，只是說兩者擅長的工作不同。</p><h2 id="GPGPU-General-Purpose-GPU-computing"><a href="#GPGPU-General-Purpose-GPU-computing" class="headerlink" title="GPGPU (General-Purpose GPU computing)"></a>GPGPU (General-Purpose GPU computing)</h2><p>最近幾年 NVDIA 的市值蒸蒸日上，全因為 NVDIA 在十幾年前下的一步棋，也就是推出 CUDA (NVDIA 對 GPGPU 的正式名稱)。當時 NVDIA 投入了大量的資金成本在研發 CUDA，外界卻是質疑一片，完全沒人看好這個操作，誰知道在 2024 年的現在，這成為自駕車發展、加密貨幣挖礦、AI 時代的關鍵。</p><p><img src="https://blogs.nvidia.com/wp-content/uploads/2018/05/AI-Revolution-Moores-Law.png" alt="CUDA"></p><p>那麼 GPGPU 到底是什麼？簡單來說，在早期 GPU 主要用於圖形處理，用於加速電腦圖形渲染。後來人們開始意識到 GPU 具有強大的平行運算潛力，不應該僅僅局限於圖形處理。黃仁勳看準這點，於是 NVIDIA 於 2006 年推出了 CUDA 平台，開啟了 GPU 通用計算的大門。CUDA 允許開發者使用類 C 語言（CUDA C&#x2F;C++）編寫程式來利用 GPU 的平行運算能力，加速各種類型的應用程式。</p><p>以前 GPU 都只拿來做圖形處理，要算數學都只能靠 CPU。現在，我們能夠把大量的數學丟給 GPU 做，利用他強大的平行計算能力快速出結果，不再侷限於圖形處理，這也是為什麼它叫做 GPGPU (圖形處理器通用計算)。</p><p>介紹了那麼多背景知識，終於可以進入 Unity 的部分了</p><h2 id="Compute-Shader"><a href="#Compute-Shader" class="headerlink" title="Compute Shader"></a>Compute Shader</h2><p>現在你已經了解 GPGPU 是什麼東西，而 Compute Shader 就是在 Unity 中實現 GPGPU 技術之一，我們可以自己寫一些程式到 GPU 上面跑，也就是前面說的，<strong>我們能夠把大量的數學丟給 GPU 做，利用他強大的平行計算能力快速出結果</strong>，在 Unity 中我們就可以利用 Compute Shader，減少 CPU 的 loading，增加遊戲的效能。</p><p>想像一下現在有個場景長這樣</p><p><img src="/notes/./images/unity-render-1/ComputeShaderDemo2.gif" alt="Compute Shader Demo"></p><p>場景共有 1000000 個粒子，如果把這些全部都塞在 Update() (CPU 端) 裡面去算會是多可怕的事情，因此我們勢必要直接丟給 GPU 去計算並直接渲染出來，這時候就可以用 Compute Shader 來達成這件事情，CPU 做的事情就只有準備 Data (記憶體要給多少之類的) 以及啟動 Compute Shader。</p><h3 id="建立-Compute-Shader"><a href="#建立-Compute-Shader" class="headerlink" title="建立 Compute Shader"></a>建立 Compute Shader</h3><p>在 Unity 新增 Compute Shader，點擊右鍵就可以直接新增 .compute 檔案<br><img src="/notes/./images/unity-render-1/AddComputeShader.png" alt="Add Compute Shader"></p><p>這邊順便新增等等會用到的檔案</p><p><img src="/notes/./images/unity-render-1/Assets.png" alt="Assets"></p><h3 id="執行-Compute-Shader"><a href="#執行-Compute-Shader" class="headerlink" title="執行 Compute Shader"></a>執行 Compute Shader</h3><h4 id="Shader-端"><a href="#Shader-端" class="headerlink" title="Shader 端"></a>Shader 端</h4><p>Unity 的 Compute Shader 的語言是 HLSL，打開檔案可以看到下面的內容</p><p><img src="/notes/./images/unity-render-1/ComputeShaderStart.png" alt="Compute Shader Start Example"></p><ul><li><code>#pragma kernel CSMain</code> 代表的是 compute kernel，這個 kernel 會對應到檔案中的一個函式名稱。一個檔案可以定義多個 kernel，也就是多個 <code>#pragma kernel 函式名稱</code>，這樣你可以全部塞同個檔案，之後要用的時候就在 C# call <code>shader.FindKernel(函式名稱)</code> 就好。</li><li><code>RWTexture2D&lt;float4&gt; Result;</code> 是一個可以讀寫的 Texture，GPU 可以把算好的資料存進去，之後拿來用</li><li><code>[numthreads(8,8,1)]</code> 是你宣告一個 Thread Group 中有幾個 Thread，等等會詳細介紹</li><li><code>void CSMain (uint3 id : SV_DispatchThreadID)</code><ul><li>CSMain 是你函式的名稱，也就是前面 <code>#pragma kernel</code> 對應到的函式</li><li><code>SV_DispatchThreadID</code> 是你當前 Thread 的 ID，這樣 GPU 才知道現在在算哪一個 Thread 的內容</li></ul></li><li><code>Result[id.xy] = float4(id.x &amp; id.y, (id.x &amp; 15)/15.0, (id.y &amp; 15)/15.0, 0.0);</code> 是你在這個 Thread 會寫進 Texture 的內容，可以看到這邊藉由 SV_DispatchThreadID 來判斷要寫進 Texture 的哪個位置</li></ul><h4 id="C-端"><a href="#C-端" class="headerlink" title="C# 端"></a>C# 端</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestComputeShader</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    [<span class="hljs-meta">SerializeField</span>] ComputeShader computeShader;<br>    [<span class="hljs-meta">SerializeField</span>] RenderTexture renderTexture;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _kernelIndex;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        _kernelIndex = computeShader.FindKernel(<span class="hljs-string">&quot;CSMain&quot;</span>);<br><br>        computeShader.SetTexture(_kernelIndex, <span class="hljs-string">&quot;Result&quot;</span>, renderTexture);<br>        computeShader.Dispatch(_kernelIndex, renderTexture.width / <span class="hljs-number">8</span>, renderTexture.height / <span class="hljs-number">8</span>, <span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在這邊，我會傳入先前建立的 Compute Shader 和 RenderTexture。</p><ul><li><code>computeShader.FindKernel(&quot;CSMain&quot;);</code> 能夠去尋找對應的 kernel，並回傳一個 kernel index 之後做使用</li><li><code>computeShader.SetTexture(_kernelIndex, &quot;Result&quot;, renderTexture);</code> 綁定計算的資源。這邊的 “Result” 是對應到 Compute Shader 檔案裡的 <code>RWTexture2D&lt;float4&gt; Result;</code>。這邊在做的事情就是把 Result 的資料 Bind 到我自己的 Render Texture 上面，也就是說我更新 Result 等同於更新我的 Render Texture。</li><li><code>computeShader.Dispatch(_kernelIndex, renderTexture.width / 8, renderTexture.height / 8, 1);</code> 這個就是去啟動 Compute Shader，並宣告要有幾個 Thread Group，之後會詳細介紹。</li></ul><p>到目前為止，程式碼的部分已經完成，剩下一些步驟</p><p><img src="/notes/./images/unity-render-1/RenderTexture.png" alt="Render Texture"></p><p>記得要勾選 Random Write，這樣這個 Texture 才能支援 <a href="https://zh.wikipedia.org/zh-tw/%E9%9A%A8%E6%A9%9F%E5%AD%98%E5%8F%96">Random Access</a></p><p><img src="/notes/./images/unity-render-1/TestComputeShader.png" alt="Test Compute Shader"></p><p>隨便個物件，塞入我們剛剛建立好的 assets，並執行它</p><p><img src="/notes/./images/unity-render-1/TestComputeShaderResult.png" alt="Test Compute Shader Result"></p><p>遊戲開始的時候可以看到我們的 Render Texture 長相變了！上面的顏色就是你 Texture 上每個 Texel 的 RGB 值，也就是 Unity 預設的 <code>Result[id.xy] = float4(id.x &amp; id.y, (id.x &amp; 15)/15.0, (id.y &amp; 15)/15.0, 0.0);</code>，float4 的四個參數就是 RGBA。這樣的結果代表你的 Compute Shader 確實有執行，並且成功把結果寫進你的 Texture 裡面。</p><h3 id="Thread-執行緒"><a href="#Thread-執行緒" class="headerlink" title="Thread 執行緒"></a>Thread 執行緒</h3><p>先來補一下剛剛挖的坑，也就是 <code>numthreads(8,8,1)</code> 和 <code>computeShader.Dispatch(_kernelIndex, renderTexture.width / 8, renderTexture.height / 8, 1)</code> 到底在做什麼</p><p>我們知道 GPU 具有強大的平行計算能力，那是因為 GPU 含有成千上萬個 Thread，每個 Thread 都能執行一個小程式。在 Compute Shader 中，一個 Kernel 會被分配到一堆 Thread 上面去執行 (像是剛剛的 CSMain)，因此我們要告訴 GPU 現在需要幾個 Thread。</p><p><img src="http://img.frankorz.com/dx-grid-of-thread-group.png" alt="Thread Group and Thread"></p><p>而在 GPU 中，一群 Thread 可以組成 Thread Group，一群 Thread Group 可以組成 Grid，且 Thread Group 和 Grid 都是三維的架構。因此</p><ul><li><code>numthreads(8,8,1)</code> 就是告訴 GPU 這個 Thread Group 的 XYZ 軸分別有幾個 Thread。</li><li><code>computeShader.Dispatch(_kernelIndex, renderTexture.width / 8, renderTexture.height / 8, 1)</code> 就是告訴 GPU 這個 Grid 的 XYZ 軸分別有幾個 Thread Group</li></ul><p>這樣的架構能讓我們更方便管理和使用計算的資源，所以這邊我就根據我的 Render Texture 解析度，來去分配 Thread 的數量</p><hr><h3 id="Uniform-Data"><a href="#Uniform-Data" class="headerlink" title="Uniform Data"></a>Uniform Data</h3><p>在 CPU 端除了綁定資源以外 (buffer、texture)，你也可以傳入一些 Uniform Data，這些 Data 在這次計算的時候是不會改變的，作為一個 Constant 來使用。</p><p>舉個例子，我現在想讓 GPU 有 <code>float Time</code> 可以使用，我想讓 Texture 的 G 值隨著時間去做改變</p><h4 id="Shader-端-1"><a href="#Shader-端-1" class="headerlink" title="Shader 端"></a>Shader 端</h4><p><img src="/notes/./images/unity-render-1/ComputeShaderExampleTime.png" alt="Compute Shader Example Time"></p><h4 id="C-端-1"><a href="#C-端-1" class="headerlink" title="C# 端"></a>C# 端</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">using</span> UnityEngine;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestComputeShader</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>    [<span class="hljs-meta">SerializeField</span>] ComputeShader computeShader;<br>    [<span class="hljs-meta">SerializeField</span>] RenderTexture renderTexture;<br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _kernelIndex;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>    &#123;<br>        _kernelIndex = computeShader.FindKernel(<span class="hljs-string">&quot;CSMain&quot;</span>);<br><br>        computeShader.SetTexture(_kernelIndex, <span class="hljs-string">&quot;Result&quot;</span>, renderTexture);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>    &#123;<br>        computeShader.SetFloat(<span class="hljs-string">&quot;_Time&quot;</span>, Time.time);<br>        computeShader.Dispatch(_kernelIndex, renderTexture.width / <span class="hljs-number">8</span>, renderTexture.height / <span class="hljs-number">8</span>, <span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h4><p><img src="/notes/./images/unity-render-1/ComputeShaderDemo3.gif" alt="Compute Shader Demo"></p><p>現在你已經知道怎麼在 Unity 中建立並啟動 Compute Shader，並輸出一個簡單的結果，你也可以試著改改看 Compute Shader 的內容，輸出各種不同的結果</p><p><img src="/notes/./images/unity-render-1/MoreComputeShaderExample.gif" alt="More Compute Shader Example"></p><p>以上這些都是透過 GPU 去計算出來的結果，更多範例可以參考 <a href="https://www.shadertoy.com/">Shader Toy</a>，不過要注意的是這網站使用的語言是 <strong>GLSL</strong>，而且是寫在 <strong>Fragment Shader</strong> 上面，這裡提供的例子使用的語言是 <strong>HLSL</strong>，而且是寫在<strong>Compute Shader</strong>上面。接下來會介紹更多 Compute Shader 的應用方式</p><h2 id="移動大量物體"><a href="#移動大量物體" class="headerlink" title="移動大量物體"></a>移動大量物體</h2><p>現在，先定個目標：我希望在場景中渲染 16384 個物件，並同時移動它們，某物件的下一個位置是根據當前位置去計算的，因此彼此之間不會互相影響。</p><p>這裡我提供四種不同的方法，逐漸優化遊戲的效能。</p><h3 id="一般寫法"><a href="#一般寫法" class="headerlink" title="一般寫法"></a>一般寫法</h3><p>最一般的寫法很直覺，直接在 Start() 建立 16384 個物件並儲存起來。接著，在 Update() 中開個 for 迴圈遍歷所有物件，根據當前位置去改變物件下一偵的位置</p><h4 id="C-端-2"><a href="#C-端-2" class="headerlink" title="C# 端"></a>C# 端</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">private</span> GameObject[] _Cubes;<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Instances = <span class="hljs-number">16384</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitCubes</span>()</span><br>&#123;<br>    _Cubes = <span class="hljs-keyword">new</span> GameObject[Instances];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; _Cubes.Length; i++)<br>    &#123;<br>        _Cubes[i] = GameObject.CreatePrimitive(PrimitiveType.Cube);<br>        _Cubes[i].transform.localScale = <span class="hljs-keyword">new</span> Vector3(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);<br>        _Cubes[i].transform.position = <span class="hljs-keyword">new</span> Vector3(i * <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, transform.position.z);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>&#123;<br>    InitCubes();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; _Cubes.Length; i++)<br>    &#123;<br>        <span class="hljs-built_in">float</span> x = _Cubes[i].transform.position.x;<br>        <span class="hljs-built_in">float</span> y = _Cubes[i].transform.position.y;<br>        <span class="hljs-built_in">float</span> z = _Cubes[i].transform.position.z;<br><br>        <span class="hljs-comment">// 我隨便亂寫的位置移動公式</span><br>        Vector3 newPos = <span class="hljs-keyword">new</span> Vector3(<br>                (<span class="hljs-built_in">float</span>)x,<br>                (<span class="hljs-built_in">float</span>)(Math.Tan(x / <span class="hljs-number">500</span> + Time.time) - Math.Cos(x / <span class="hljs-number">10</span> + z / <span class="hljs-number">200</span> + Time.time)) * <span class="hljs-number">100</span>,<br>                (<span class="hljs-built_in">float</span>)Math.Sin(x / <span class="hljs-number">10</span> + y / <span class="hljs-number">200</span> - Time.time) * <span class="hljs-number">200</span><br>            );<br>        _Cubes[i].transform.position = newPos;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p><img src="/notes/./images/unity-render-1/Naive.gif" alt="Naive"></p><p>可以發現這種直白作法的 FPS 差不多是 24 FPS，代表一秒只能畫 24 張，最主要原因就是 CPU loading 太大，拖累了進度</p><h3 id="比較好的做法-Compute-Shader-CPU-Read-Back"><a href="#比較好的做法-Compute-Shader-CPU-Read-Back" class="headerlink" title="比較好的做法 (Compute Shader + CPU Read Back)"></a>比較好的做法 (Compute Shader + CPU Read Back)</h3><p>第二種做法是把計算所有物件位置的任務丟給 GPU 去算，算出每個物件下一個位置的資料，最後 CPU 只要負責等待結果回傳，根據 GPU 算好的資料去更新物件的位置</p><h4 id="Shader-端-2"><a href="#Shader-端-2" class="headerlink" title="Shader 端"></a>Shader 端</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> kernel CSMain</span><br><br>RWStructuredBuffer&lt;float3&gt; CubeBuffer;<br><span class="hljs-type">float</span> Time;<br><br>[numthreads(<span class="hljs-number">1024</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)]<br><span class="hljs-type">void</span> <span class="hljs-title function_">CSMain</span> <span class="hljs-params">(uint3 id : SV_DispatchThreadID)</span><br>&#123;<br>    <span class="hljs-type">float</span> x = CubeBuffer[id.x].x;<br>    <span class="hljs-type">float</span> y = CubeBuffer[id.x].y;<br>    <span class="hljs-type">float</span> z = CubeBuffer[id.x].z;<br><br>    <span class="hljs-comment">// 我亂寫的計算位置的公式</span><br>    CubeBuffer[id.x] = float3(<br>            x,<br>            (<span class="hljs-built_in">tan</span>(x/<span class="hljs-number">500</span>+ Time) - <span class="hljs-built_in">cos</span>(x/<span class="hljs-number">10</span>+z/<span class="hljs-number">200</span> + Time))*<span class="hljs-number">100</span>,<br>            <span class="hljs-built_in">sin</span>(x/<span class="hljs-number">10</span>+y/<span class="hljs-number">200</span> - Time)*<span class="hljs-number">200</span><br>        );<br>&#125;<br></code></pre></td></tr></table></figure><p>這邊有一個 Buffer，內容包含所有物件的位置，接著根據當前位置去計算下一個位置，再存回 Buffer 即可。</p><h4 id="C-端-3"><a href="#C-端-3" class="headerlink" title="C# 端"></a>C# 端</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> ComputeShader computeShader;<br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _kernelIndex;<br><span class="hljs-keyword">private</span> ComputeBuffer _CubeBuffer;<br><span class="hljs-keyword">private</span> Vector3[] _CubeArray;<br><span class="hljs-keyword">private</span> GameObject[] _Cubes;<br><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Instances = <span class="hljs-number">16384</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitCubes</span>()</span><br>&#123;<br>    _Cubes = <span class="hljs-keyword">new</span> GameObject[Instances];<br>    _CubeArray = <span class="hljs-keyword">new</span> Vector3[Instances];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; _CubeArray.Length; i++)<br>    &#123;<br>        _Cubes[i] = GameObject.CreatePrimitive(PrimitiveType.Cube);<br>        _Cubes[i].transform.localScale = <span class="hljs-keyword">new</span> Vector3(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);<br>        _Cubes[i].transform.position = <span class="hljs-keyword">new</span> Vector3(i * <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, transform.position.z);<br>        _CubeArray[i] = _Cubes[i].transform.position;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitShader</span>()</span><br>&#123;<br>    _kernelIndex = computeShader.FindKernel(<span class="hljs-string">&quot;CSMain&quot;</span>);<br>    _CubeBuffer = <span class="hljs-keyword">new</span> ComputeBuffer(_CubeArray.Length, <span class="hljs-number">3</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">float</span>));<br>    _CubeBuffer.SetData(_CubeArray);<br>    computeShader.SetBuffer(_kernelIndex, <span class="hljs-string">&quot;CubeBuffer&quot;</span>, _CubeBuffer);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>&#123;<br>    InitCubes();<br>    InitShader();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>&#123;<br>    computeShader.SetFloat(<span class="hljs-string">&quot;Time&quot;</span>, Time.time);<br>    computeShader.Dispatch(_kernelIndex, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// 等待結果回傳</span><br>    _CubeBuffer.GetData(_CubeArray);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; _CubeArray.Length; i++)<br>    &#123;<br>        _Cubes[i].transform.position = _CubeArray[i];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我們在 Start() 的地方宣告一個 Buffer，內容包含剛開始所有物件的位置，接著就是傳入資料，啟動 Compute Shader。在 Update() 裡面的 <code>GetData()</code> 可以 Block 下面的程式碼，也就是直到 GPU 算好後才繼續往下執行操作，避免發生 GPU 還沒算好 CPU 就讀取的情況。</p><p>注意，這裡我宣告 16 個 Thread Group，每個 Thread Group 有 1024 個 Thread，一共有 16 * 1024 &#x3D; 16384 個 Thread，剛剛好等於我們擁有的物件數量，也就是說每個 Thread 就負責處理一個物件的位置。</p><p>只要最後數量對就好，有幾個 Thread Group、每個 Thread Group 有幾個 Thread 不是很重要。為了方便，我只宣告在 X 象限，這樣讀取 Buffer 的時候可以直接用 <code>CubeBuffer[id.x]</code> 就好，不用管 id.y、id.z</p><h4 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h4><p><img src="/notes/./images/unity-render-1/CPUReadBack.gif" alt="CPU Read Back"></p><p>可以發現這種作法的 FPS 有些許上升，來到了 32，代表一秒可以畫 32 張，但是上升的很不明顯，最主要就是因為 CPU 在等 GPU 算完才繼續執行，白白浪費時間在那邊掛機。雖然 GPU 確實算很快，但這作法不能完全發揮 Compute Shader 的功力</p><h3 id="GPU-Instancing"><a href="#GPU-Instancing" class="headerlink" title="GPU Instancing"></a>GPU Instancing</h3><p>這邊先介紹一個跟 Compute Shader 比較沒關的優化方法，也就是 GPU Instancing。當我們想繪製大量且相同的 Mesh 時，可以用這種方法。</p><h4 id="Draw-call"><a href="#Draw-call" class="headerlink" title="Draw call"></a>Draw call</h4><p>在 Unity 中，CPU 命令 GPU 去繪製 Mesh + Material 的步驟就是 <strong>Draw Call</strong>，當場景中有大量物件時，意味這我們會有很多 CPU 命令 GPU 做事的步驟，但是這是一件非常花時間的事情</p><p><img src="/notes/./images/unity-render-1/Bottleneck.png" alt="CPU Bottleneck"></p><p>既然我們要畫 Mesh 和 Material 都一樣，為什麼不畫一次就好？GPU instancing 的概念就像是告訴 GPU 說：「嘿，這些方塊都長得一樣，你只要畫一次，然後把它們放到對的地方就好。」，這樣就不需要重複告訴 GPU 如何畫每個方塊，而是告訴 GPU 如何畫一個方塊，然後告訴它在哪裡重複使用這個畫好的方塊。這種做法可以大幅提高效能。</p><h4 id="Shader-端-3"><a href="#Shader-端-3" class="headerlink" title="Shader 端"></a>Shader 端</h4><p>跟這邊沒關係，所以跟第二個做法一樣，不用改</p><h4 id="C-端-4"><a href="#C-端-4" class="headerlink" title="C# 端"></a>C# 端</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> ComputeShader computeShader;<br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _kernelIndex;<br><span class="hljs-keyword">private</span> ComputeBuffer _CubeBuffer;<br><span class="hljs-keyword">private</span> Vector3[] _CubeArray;<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Instances = <span class="hljs-number">16384</span>;<br><span class="hljs-keyword">public</span> Mesh mesh;<br><span class="hljs-keyword">public</span> Material material;<br><span class="hljs-keyword">private</span> List&lt;List&lt;Matrix4x4&gt;&gt; batches = <span class="hljs-keyword">new</span> List&lt;List&lt;Matrix4x4&gt;&gt;();<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitCubes</span>()</span><br>&#123;<br>    <span class="hljs-built_in">int</span> AddedMatrices = <span class="hljs-number">0</span>;<br>    _CubeArray = <span class="hljs-keyword">new</span> Vector3[Instances];<br>    batches.Add(<span class="hljs-keyword">new</span> List&lt;Matrix4x4&gt;());<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; Instances; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (AddedMatrices &gt;= <span class="hljs-number">1000</span>)<br>        &#123;<br>            AddedMatrices = <span class="hljs-number">0</span>;<br>            batches.Add(<span class="hljs-keyword">new</span> List&lt;Matrix4x4&gt;());<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            AddedMatrices++;<br>            Vector3 position = <span class="hljs-keyword">new</span> Vector3(i * <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, transform.position.z);<br>            batches[batches.Count - <span class="hljs-number">1</span>].Add(Matrix4x4.TRS(Vector3.zero, Quaternion.identity, Vector3.one * <span class="hljs-number">10f</span>));<br>            _CubeArray[i] = position;<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitShader</span>()</span><br>&#123;<br>    _kernelIndex = computeShader.FindKernel(<span class="hljs-string">&quot;CSMain&quot;</span>);<br>    _CubeBuffer = <span class="hljs-keyword">new</span> ComputeBuffer(_CubeArray.Length, <span class="hljs-number">3</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">float</span>));<br>    _CubeBuffer.SetData(_CubeArray);<br>    computeShader.SetBuffer(_kernelIndex, <span class="hljs-string">&quot;CubeBuffer&quot;</span>, _CubeBuffer);<br>    material.SetBuffer(<span class="hljs-string">&quot;CubeBuffer&quot;</span>, _CubeBuffer);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>&#123;<br>    InitCubes();<br>    InitShader();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>&#123;<br>    computeShader.SetFloat(<span class="hljs-string">&quot;Time&quot;</span>, Time.time);<br>    material.SetFloat(<span class="hljs-string">&quot;Time&quot;</span>, Time.time);<br>    computeShader.Dispatch(_kernelIndex, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>    _CubeBuffer.GetData(_CubeArray);<br>    <span class="hljs-built_in">int</span> batchIndex = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; batches.Count; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>; j &lt; batches[i].Count; j++)<br>        &#123;<br>            batches[i][j] = Matrix4x4.TRS(<br>                _CubeArray[batchIndex],<br>                Quaternion.identity,<br>                Vector3.one * <span class="hljs-number">10f</span><br>            );<br>            batchIndex++;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; batches.Count; i++)<br>    &#123;<br>        Graphics.DrawMeshInstanced(mesh, <span class="hljs-number">0</span>, material, batches[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>這邊就不詳細介紹程式碼，有興趣可以去看 <a href="https://www.youtube.com/watch?v=eyaxqo9JV4w">Unity GPU Instancing in less than 7 minutes!</a> 的教學。</p><p>簡單來說就是把一些物件打包成一個個 Batch（<code>DrawMeshInstanced</code>一個 batch 只能塞 1023 個東西，所以這邊讓他超過 1000 的話就裝進下個 batch）。然後把每個物件的 Transform Matrix 算好，之後就傳給 GPU 去移動位置。</p><h4 id="效果-2"><a href="#效果-2" class="headerlink" title="效果"></a>效果</h4><p><img src="/notes/./images/unity-render-1/GPUInstancing.gif" alt="GPU Instancing"></p><p>可以發現這種作法大幅提升了效能，FPS 竟然能上升到 110 左右，可見 Draw Call 是多可怕的東西，這也叫做 CPU Bottleneck。另外，上圖中的 Batches 就是 Draw Call 的數量，從原本的 1000 多減少到 67。</p><p>然而，我們還沒發會 Compute Shader 真正的功用，這不是最快的，我們要更快，還要再快<br><img src="https://memes.tw/download-image?name=4a039a33933c7902c7bfbba3b62993dc.png" alt="Faster Faster Faster"></p><h3 id="Indirect-Rendering"><a href="#Indirect-Rendering" class="headerlink" title="Indirect Rendering"></a>Indirect Rendering</h3><p>仔細想想，我們第三種作法的流程是</p><ol><li>CPU 宣告 Buffer，傳給 GPU (Compute Shader)</li><li>GPU (Compute Shader) 算好新的位置，傳給 CPU</li><li>CPU 掛機耍廢，直到 GPU 算好回傳 CPU 才接收新位置的資料</li><li>CPU 把剛接收的資料傳給 GPU 去渲染</li></ol><p>有沒有覺得哪裡怪怪的？CPU 耍廢到接收資料，剛收到又傳回 GPU？？為什麼不直接全部交給 GPU 做就好，可以減少 CPU 和 GPU 之間的溝通成本，還可以讓 CPU 去忙其他事情，Indirect Rendering 就是這種概念。</p><p>為了讓 GPU 直接讀取新位置資料，去更新當前位置，我們會需要自己寫 Vertex Shader。Vertex Shader 就是運行在 GPU 上，用來控制每個 Vertex 的相關訊息。想法就是，Compute Shader 算好後存在 Buffer 中（Buffer 就是一段記憶體），接著我們讓 Vertex Shader 直接去讀取這段記憶體位置，直接取得 Buffer 裡面的內容，更新 Vertex 的位置，省略掉 CPU 等待、回傳的步驟，全程都在 GPU 上面執行。</p><h4 id="Compute-Shader-端"><a href="#Compute-Shader-端" class="headerlink" title="Compute Shader 端"></a>Compute Shader 端</h4><p>不用改</p><h4 id="Vertex-Shader-端"><a href="#Vertex-Shader-端" class="headerlink" title="Vertex Shader 端"></a>Vertex Shader 端</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">uniform float4x4 _ObjectToWorld;<br>StructuredBuffer&lt;float3&gt; CubeBuffer;<br><br>v2f <span class="hljs-title function_">vert</span> <span class="hljs-params">(appdata v, uint instanceID : SV_InstanceID)</span><br>&#123;<br>    v2f o;<br>    float4 bufferData = float4(CubeBuffer[instanceID], <span class="hljs-number">0</span>);<br>    float4x4 translationMatrix = float4x4(<br>        <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, bufferData.x,<br>        <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, bufferData.y,<br>        <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, bufferData.z,<br>        <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span><br>    );<br><br>    float4 worldPos = mul(translationMatrix, mul(_ObjectToWorld, v.vertex));<br>    o.vertex = UnityObjectToClipPos(worldPos);<br>    <span class="hljs-keyword">return</span> o;<br>&#125;<br></code></pre></td></tr></table></figure><p>這裡就不介紹 Vertex Shader 怎麼寫了，因此省略掉很多程式碼，只是想表達我讀取 Buffer，並做成 Transform Matrix 去更新頂點位置的過程</p><h4 id="C-端-5"><a href="#C-端-5" class="headerlink" title="C# 端"></a>C# 端</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> ComputeShader computeShader;<br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _kernelIndex;<br><span class="hljs-keyword">private</span> ComputeBuffer _CubeBuffer;<br><span class="hljs-keyword">private</span> Vector3[] _CubeArray;<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Instances = <span class="hljs-number">16384</span>;<br><span class="hljs-keyword">public</span> Mesh mesh;<br><span class="hljs-keyword">public</span> Material material;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitCubes</span>()</span><br>&#123;<br>    _CubeArray = <span class="hljs-keyword">new</span> Vector3[Instances];<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; Instances; i++)<br>    &#123;<br>        Vector3 position = <span class="hljs-keyword">new</span> Vector3(i * <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, transform.position.z);<br>        _CubeArray[i] = position;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InitShader</span>()</span><br>&#123;<br>    _kernelIndex = computeShader.FindKernel(<span class="hljs-string">&quot;CSMain&quot;</span>);<br>    _CubeBuffer = <span class="hljs-keyword">new</span> ComputeBuffer(_CubeArray.Length, <span class="hljs-number">3</span> * <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">float</span>));<br>    _CubeBuffer.SetData(_CubeArray);<br>    computeShader.SetBuffer(_kernelIndex, <span class="hljs-string">&quot;CubeBuffer&quot;</span>, _CubeBuffer);<br>    material.SetBuffer(<span class="hljs-string">&quot;CubeBuffer&quot;</span>, _CubeBuffer);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>&#123;<br>    InitCubes();<br>    InitShader();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>&#123;<br>    computeShader.SetFloat(<span class="hljs-string">&quot;Time&quot;</span>, Time.time);<br>    computeShader.Dispatch(_kernelIndex, <span class="hljs-number">16</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><br>    RenderParams rp = <span class="hljs-keyword">new</span> RenderParams(material);<br>    rp.matProps = <span class="hljs-keyword">new</span> MaterialPropertyBlock();<br>    rp.matProps.SetMatrix(<span class="hljs-string">&quot;_ObjectToWorld&quot;</span>, Matrix4x4.TRS(Vector3.zero, Quaternion.identity, Vector3.one * <span class="hljs-number">10f</span>));<br>    Graphics.RenderMeshPrimitives(rp, mesh, <span class="hljs-number">0</span>, Instances);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟第三種作法不同的地方是，我的 GPU instancing 換成 <code>RenderMeshPrimitives</code>，因為我要自己寫移動 Vertex Shader 的程式碼，而且 <code>RenderMeshPrimitives</code> 沒有 Batch Size 的限制，會是更好的選擇。</p><h4 id="效果-3"><a href="#效果-3" class="headerlink" title="效果"></a>效果</h4><p><img src="/notes/./images/unity-render-1/IndirectRendering.gif" alt="Indirect Rendering"></p><p>透過這種作法，可以看到我的 FPS 上升到 400 左右，畫面順到不行，不說我還以為我的 CPU 特別猛（GIF 看起來會比較卡，最後有附上影片）</p><p>不過這種作法也有缺點，就是不能辨別碰撞、Culling 等等，因為<strong>實際上物體並沒有移動，只有物體的頂點移動而已</strong>，不過這也可以透過其他方式解決，只是原本 CPU 會幫你弄好，現在要自己寫比較麻煩而已，但是效能會好上許多。</p><p><img src="/notes/./images/unity-render-1/Culling.gif" alt="Culling"></p><p>像上面這個例子，物體原本的位置沒有移動，只有頂點在移動，因此當原本的位置跑到鏡頭外面，會直接被 Culling 掉，只能自己寫判斷了。</p><hr><p>以上是本篇教學，花費我許多時間，不過我也因此學到很多東西。</p><p>我認為 Computer Shader 真的是一項值得深入探討的技術，像是<strong>原神</strong>渲染技術分享中就有提到，有超過一半的 Feature 都有使用到 Compute Shader 優化。了解遊戲背後的技術是一件很有趣的事情，這樣玩遊戲跑圖的時候都可以想到一些有的沒的，偷偷思考場景看到的特效背後的原理</p><p>後來發現上面的例子可能沒有真的到 16384 個物件，有些太遠的都被 Culling 掉了 qq，感謝你看到這邊</p><ul><li>專案 Github: <a href="https://github.com/933yee/Unity-Compute-Shader">https://github.com/933yee/Unity-Compute-Shader</a></li></ul><iframe width = "100%" height = "400" src="//www.youtube.com/embed/6tuy4PYs7Rc" frameborder="0" allowfullscreen></iframe><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul><li><a href="https://frankorz.com/2021/04/17/compute-shader/">Compute Shader 简介</a> 大推這篇文章</li><li><a href="https://home.gamer.com.tw/creationDetail.php?sn=5476357">[達人專欄] 【筆記】初學指南，計算著色器</a></li><li><a href="https://www.youtube.com/watch?v=7lp8O53VDOo">Unity compute shader for vertices deform</a></li><li><a href="https://www.youtube.com/watch?v=ap6fdCmE1JA">https://www.youtube.com/watch?v=ap6fdCmE1JA</a></li><li><a href="https://www.youtube.com/watch?v=s-cDYtNfsl4">Real-time fluid simulation in Unity</a></li><li><a href="https://www.youtube.com/watch?v=IrYPkSIvpIw">Unity Performance Tips: Draw Calls</a></li><li><a href="https://www.youtube.com/watch?v=eyaxqo9JV4w">Unity GPU Instancing in less than 7 minutes!</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Compiler 筆記 (4)</title>
    <link href="/notes/2024/05/16/compiler-4/"/>
    <url>/notes/2024/05/16/compiler-4/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考 清華大學 李政崑老師 編譯器設計講義</p></blockquote><h2 id="leftmost-and-rightmost-derivations"><a href="#leftmost-and-rightmost-derivations" class="headerlink" title="leftmost and rightmost derivations"></a>leftmost and rightmost derivations</h2><p><a href="https://www.youtube.com/watch?v=K_aMajzrKF4">leftmost and rightmost derivations</a></p><ul><li><p>介紹 leftmost 和 rightmost derivations</p></li><li><p>A left-recursive grammar might cause a recursive-decent parser, even one with back-tracking, into an infinite loop.</p><ul><li>That is, when we try to expand A, we may eventually find ourselves again trying to expand A without having consumed any input.</li></ul></li></ul><h2 id="Push-Down-Automata"><a href="#Push-Down-Automata" class="headerlink" title="Push Down Automata"></a>Push Down Automata</h2><p><a href="https://www.youtube.com/watch?app=desktop&v=4ejIAmp_Atw">Pushdown Automata (Introduction)</a></p><ul><li>PDA &#x3D; Finite State Machine + A Stack</li><li>PDA &#x3D; A input tape + A finite control unit + A stack with infinite size</li></ul><p><a href="https://www.youtube.com/watch?v=JtRyd7Svlew">Pushdown Automata (Formal Definition)</a></p><ul><li>介紹 $M &#x3D; (Q, \Sigma, \Gamma, \delta, q_0, Z_0, F)$</li><li>介紹 $\delta$ 的 input 和 output</li></ul><p><a href="https://www.youtube.com/watch?v=eY7fwj5jvC4">Pushdown Automata (Graphical Notation)</a></p><ul><li>介紹 PDA 的 Graph </li><li>介紹簡單範例: L &#x3D; {$0^n 1^n$ | n $\ge$ 0}</li><li>一個 language 會被 accept 一旦它能達到 final state 或讓 stack 變空</li></ul><p><a href="https://www.youtube.com/watch?v=TEQcJybMMFU">Pushdown Automata Example (Even Palindrome) PART-1</a></p><ul><li>介紹 Palindrome 的範例</li></ul><p><a href="https://www.youtube.com/watch?v=BxA-aI2dyRo">Pushdown Automata Example (Even Palindrome) PART-2</a></p><ul><li>繼續上一部的 Palindrome 範例，詳細介紹 epsilon 是怎麼運作的</li></ul><h2 id="Parsers"><a href="#Parsers" class="headerlink" title="Parsers"></a>Parsers</h2><p><a href="https://www.youtube.com/watch?v=OIKL6wFjFOo">Introduction to Parsers</a></p><ul><li>介紹 Bottom-up Parser vs. Top-Down Parser</li><li>整個 Parser 的生態結構</li></ul><h3 id="Top-Down-Parsers"><a href="#Top-Down-Parsers" class="headerlink" title="Top Down Parsers"></a>Top Down Parsers</h3><p><a href="https://www.youtube.com/watch?v=iddRD8tJi44">Top Down Parsers - Recursive Descent Parsers</a></p><ul><li>介紹 Recursive Descent Parsers</li></ul><p><a href="https://www.youtube.com/watch?v=v_wvcuJ6mGY">Top Down Parsers - LL(1) Parsers</a></p><ul><li>介紹 Recursive Descent Parsers 的名稱由來</li><li>介紹 LL(1) 的名稱由來</li><li>簡單介紹 FIRST() 和 FOLLOW()</li></ul><p><a href="https://www.youtube.com/watch?v=oOCromcWnfc">FIRST() and FOLLOW() Functions</a></p><ul><li>非常重要的影片，多看幾次</li><li>計算 FIRST() 從下往上，計算 FOLLOW() 從上往下</li><li>FISRT() 要包含 epsilon，FOLLOW() 不用</li><li>計算 FOLLOW() 前最好把 FIRST() 都列好，比較好算</li><li>FOLLOW() 大概可以分成三種 case，就算遇到 epsilon 也一樣方法：<ol><li>The <strong>following terminal symbol</strong> will be selected as FOLLOW</li><li>The <strong>FIRST of the following non-terminal</strong> will be selected as FOLLOW</li><li>If it is the right most in the RHS, the <strong>FOLLOW of the LHS</strong> will be selected</li></ol></li></ul><p><a href="https://www.youtube.com/watch?v=jv4dwxukVvU">FIRST() and FOLLOW() Functions – Solved Problems (Set 1)</a></p><ul><li>更多 FIRST FOLLOW 的範例</li><li>不確定 Q2 Q3 的 FIRST(S) 要不要有 epsilon<ul><li>不用，如果全部產生的 non-terminals FIRST 都有 epsilon 才要</li></ul></li></ul><p><a href="https://www.youtube.com/watch?v=Wo4bafMawFA">FIRST() and FOLLOW() Functions – Solved Problems (Set 2)</a></p><ul><li>更多 FIRST FOLLOW 的範例</li></ul><p><a href="https://www.youtube.com/watch?v=DT-cbznw9aY">LL(1) Parsing Table</a></p><p><a href="https://www.youtube.com/watch?v=clkHOgZUGWU">LL(1) Parsing</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Compilier</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flutter 筆記</title>
    <link href="/notes/2024/05/03/flutter-notes/"/>
    <url>/notes/2024/05/03/flutter-notes/</url>
    
    <content type="html"><![CDATA[<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/material.dart&#x27;</span>;<br><br><span class="hljs-keyword">void</span> main() &#123;<br>  runApp(<span class="hljs-keyword">const</span> MyApp());<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>      home: Scaffold(<br>          backgroundColor: Colors.deepPurple[<span class="hljs-number">200</span>],<br>          appBar: AppBar(<br>              title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&quot;Hello World&quot;</span>),<br>              backgroundColor: Colors.deepPurple[<span class="hljs-number">400</span>],<br>              elevation: <span class="hljs-number">0</span>,<br>              leading: IconButton(<br>                icon: <span class="hljs-keyword">const</span> Icon(Icons.menu),<br>                onPressed: () &#123;&#125;,<br>              )),<br>          body: Center(<br>              child: Container(<br>            height: <span class="hljs-number">500</span>,<br>            width: <span class="hljs-number">300</span>,<br>            decoration: BoxDecoration(<br>              color: Colors.deepPurple,<br>              borderRadius: BorderRadius.circular(<span class="hljs-number">20</span>),<br>            ),<br>            padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">20</span>),<br>            child: Column(<br>              mainAxisAlignment: MainAxisAlignment.spaceEvenly,<br>              children: [<br>                <span class="hljs-keyword">const</span> Text(<br>                  <span class="hljs-string">&quot;Hello World&quot;</span>,<br>                  style: TextStyle(<br>                    color: Colors.white,<br>                    fontSize: <span class="hljs-number">30</span>,<br>                  ),<br>                ),<br>                Expanded(<br>                  child: Container(<br>                    color: Colors.deepPurple[<span class="hljs-number">100</span>],<br>                  ),<br>                ),<br>                Expanded(<br>                  flex: <span class="hljs-number">2</span>,<br>                  child: Container(<br>                    color: Colors.deepPurple[<span class="hljs-number">200</span>],<br>                  ),<br>                ),<br>                Expanded(<br>                  child: Container(<br>                    color: Colors.deepPurple[<span class="hljs-number">300</span>],<br>                  ),<br>                )<br>              ],<br>            ),<br>          ))),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/flutter-notes/demo1.png" alt="demo 1"></p><h3 id="ListView-and-GridView"><a href="#ListView-and-GridView" class="headerlink" title="ListView and GridView"></a>ListView and GridView</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br>  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span> names = [<br>    <span class="hljs-string">&#x27;John&#x27;</span>,<br>    <span class="hljs-string">&#x27;Doe&#x27;</span>,<br>    <span class="hljs-string">&#x27;Smith&#x27;</span>,<br>    <span class="hljs-string">&#x27;Alex&#x27;</span>,<br>    <span class="hljs-string">&#x27;James&#x27;</span>,<br>    <span class="hljs-string">&#x27;Robert&#x27;</span>,<br>    <span class="hljs-string">&#x27;William&#x27;</span>,<br>    <span class="hljs-string">&#x27;David&#x27;</span>,<br>    <span class="hljs-string">&#x27;Richard&#x27;</span>,<br>    <span class="hljs-string">&#x27;Joseph&#x27;</span><br>  ];<br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>        debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>        home: Scaffold(<br>            body: Column(<br>          children: [<br>            Expanded(<br>              child: ListView.builder(<br>                  itemCount: <span class="hljs-number">10</span>,<br>                  itemBuilder: (context, index) =&gt; ListTile(<br>                        title: Text(<span class="hljs-string">&#x27;Item <span class="hljs-subst">$index</span>&#x27;</span>),<br>                      )),<br>            ),<br>            Expanded(<br>              flex: <span class="hljs-number">2</span>,<br>              child: GridView.builder(<br>                itemCount: <span class="hljs-number">64</span>,<br>                gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(<br>                    crossAxisCount: <span class="hljs-number">8</span>),<br>                itemBuilder: (count, index) =&gt; Container(<br>                    color: Colors.deepPurple, margin: EdgeInsets.all(<span class="hljs-number">2</span>)),<br>              ),<br>            ),<br>            Expanded(<br>              child: ListView.builder(<br>                  itemCount: names.length,<br>                  itemBuilder: (context, index) =&gt;<br>                      ListTile(title: Text(names[index]))),<br>            ),<br>          ],<br>        )));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/flutter-notes/demo2.png" alt="demo 2"></p><h3 id="Stack-and-GestureDetector"><a href="#Stack-and-GestureDetector" class="headerlink" title="Stack and GestureDetector"></a>Stack and GestureDetector</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-keyword">void</span> userTapped() &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;User tapped the container&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>        debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>        home: Scaffold(<br>          body: Center(<br>            child: Stack(<br>              alignment: Alignment.center,<br>              children: [<br>                Container(<br>                  height: <span class="hljs-number">300</span>,<br>                  width: <span class="hljs-number">300</span>,<br>                  color: Colors.deepPurple,<br>                ),<br>                Container(<br>                  height: <span class="hljs-number">200</span>,<br>                  width: <span class="hljs-number">200</span>,<br>                  color: Colors.deepPurple[<span class="hljs-number">400</span>],<br>                ),<br>                GestureDetector(<br>                  onTap: userTapped,<br>                  child: Container(<br>                    height: <span class="hljs-number">100</span>,<br>                    width: <span class="hljs-number">100</span>,<br>                    color: Colors.deepPurple[<span class="hljs-number">200</span>],<br>                    child: Center(child: Text(<span class="hljs-string">&quot;Tap me!&quot;</span>)),<br>                  ),<br>                )<br>              ],<br>            ),<br>          ),<br>        ));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/flutter-notes/demo3.png" alt="demo 3"></p><h3 id="Navigation"><a href="#Navigation" class="headerlink" title="Navigation"></a>Navigation</h3><h4 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  runApp(MyApp());<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>      home: FirstPage(),<br>      routes: &#123;<br>        <span class="hljs-string">&#x27;/second&#x27;</span>: (context) =&gt; <span class="hljs-keyword">const</span> SecondPage(),<br>      &#125;,<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="First-Page"><a href="#First-Page" class="headerlink" title="First Page"></a>First Page</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FirstPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> FirstPage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;First Page&#x27;</span>)),<br>      body: Center(<br>          child: ElevatedButton(<br>        child: Text(<span class="hljs-string">&quot;Go to Second Page&quot;</span>),<br>        onPressed: () &#123;<br>          Navigator.pushNamed(context, <span class="hljs-string">&#x27;/second&#x27;</span>);<br>        &#125;,<br>      )),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Second-Page"><a href="#Second-Page" class="headerlink" title="Second Page"></a>Second Page</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecondPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> SecondPage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;Second Page&#x27;</span>)),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Drawer-And-Navigation"><a href="#Drawer-And-Navigation" class="headerlink" title="Drawer And Navigation"></a>Drawer And Navigation</h3><h4 id="Main-1"><a href="#Main-1" class="headerlink" title="Main"></a>Main</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  runApp(MyApp());<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>      home: FirstPage(),<br>      routes: &#123;<br>        <span class="hljs-string">&#x27;/firstpage&#x27;</span>: (context) =&gt; FirstPage(),<br>        <span class="hljs-string">&#x27;/homepage&#x27;</span>: (context) =&gt; HomePage(),<br>        <span class="hljs-string">&#x27;/settingspage&#x27;</span>: (context) =&gt; SettingsPage(),<br>      &#125;,<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="First-Page-1"><a href="#First-Page-1" class="headerlink" title="First Page"></a>First Page</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FirstPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> FirstPage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;First Page&#x27;</span>)),<br>      drawer: Drawer(<br>          backgroundColor: Colors.deepPurple[<span class="hljs-number">100</span>],<br>          child: Column(<br>            children: [<br>              DrawerHeader(<br>                  child: Icon(<br>                Icons.favorite,<br>                size: <span class="hljs-number">48</span>,<br>              )),<br>              ListTile(<br>                leading: Icon(Icons.home),<br>                title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;Home&#x27;</span>),<br>                onTap: () &#123;<br>                  Navigator.pop(context);<br>                  Navigator.pushNamed(context, <span class="hljs-string">&#x27;/homepage&#x27;</span>);<br>                &#125;,<br>              ),<br>              ListTile(<br>                leading: Icon(Icons.settings),<br>                title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;Settings&#x27;</span>),<br>                onTap: () &#123;<br>                  Navigator.pop(context);<br>                  Navigator.pushNamed(context, <span class="hljs-string">&#x27;/settingspage&#x27;</span>);<br>                &#125;,<br>              ),<br>            ],<br>          )),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Home"><a href="#Home" class="headerlink" title="Home"></a>Home</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> HomePage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;Home Page&#x27;</span>)),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/flutter-notes/demo4.png" alt="demo 4"></p><h3 id="Bottom-Navigation"><a href="#Bottom-Navigation" class="headerlink" title="Bottom Navigation"></a>Bottom Navigation</h3><h4 id="Main-2"><a href="#Main-2" class="headerlink" title="Main"></a>Main</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  runApp(MyApp());<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="hljs-keyword">super</span>(key: key);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>      home: FirstPage(),<br>      routes: &#123;<br>        <span class="hljs-string">&#x27;/firstpage&#x27;</span>: (context) =&gt; FirstPage(),<br>        <span class="hljs-string">&#x27;/homepage&#x27;</span>: (context) =&gt; HomePage(),<br>        <span class="hljs-string">&#x27;/settingspage&#x27;</span>: (context) =&gt; SettingsPage(),<br>      &#125;,<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="First-Page-StateFul"><a href="#First-Page-StateFul" class="headerlink" title="First Page (StateFul)"></a>First Page (StateFul)</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FirstPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>&#123;<br>  FirstPage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  State&lt;FirstPage&gt; createState() =&gt; _FirstPageState();<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_FirstPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">FirstPage</span>&gt; </span>&#123;<br>  <span class="hljs-built_in">int</span> _selectedIndex = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">void</span> _navigateBottomBar(<span class="hljs-built_in">int</span> index) &#123;<br>    setState(() &#123;<br>      _selectedIndex = index;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span> _pages = [<br>    HomePage(),<br>    ProfilePage(),<br>    SettingsPage(),<br>  ];<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;First Page&#x27;</span>)),<br>      body: _pages[_selectedIndex],<br>      bottomNavigationBar: BottomNavigationBar(<br>        currentIndex: _selectedIndex,<br>        onTap: _navigateBottomBar,<br>        items: [<br>          BottomNavigationBarItem(icon: Icon(Icons.home), label: <span class="hljs-string">&#x27;Home&#x27;</span>),<br>          BottomNavigationBarItem(icon: Icon(Icons.person), label: <span class="hljs-string">&#x27;Profile&#x27;</span>),<br>          BottomNavigationBarItem(<br>              icon: Icon(Icons.settings), label: <span class="hljs-string">&#x27;Settings&#x27;</span>),<br>        ],<br>      ),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Hone"><a href="#Hone" class="headerlink" title="Hone"></a>Hone</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> HomePage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      body: Center(child: Text(<span class="hljs-string">&#x27;Home Page&#x27;</span>)),<br>      backgroundColor: Colors.amber[<span class="hljs-number">100</span>],<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/flutter-notes/demo5.png" alt="demo 5"></p><h3 id="Counter-App"><a href="#Counter-App" class="headerlink" title="Counter App"></a>Counter App</h3><h4 id="Main-3"><a href="#Main-3" class="headerlink" title="Main"></a>Main</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  runApp(<span class="hljs-keyword">const</span> MyApp());<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>      home: CounterPage(),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Counter-Page"><a href="#Counter-Page" class="headerlink" title="Counter Page"></a>Counter Page</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> CounterPage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  State&lt;CounterPage&gt; createState() =&gt; _CounterPageState();<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CounterPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CounterPage</span>&gt; </span>&#123;<br>  <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">void</span> _incrementCounter() &#123;<br>    setState(() &#123;<br>      _counter++;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      body: Center(<br>        child: Column(<br>          mainAxisAlignment: MainAxisAlignment.center,<br>          children: [<br>            Text(<span class="hljs-string">&quot;You pushed the button this many times:&quot;</span>),<br>            Text(<br>              <span class="hljs-string">&#x27;<span class="hljs-subst">$_counter</span>&#x27;</span>,<br>              style: TextStyle(fontSize: <span class="hljs-number">40</span>),<br>            ),<br>            ElevatedButton(<br>                onPressed: _incrementCounter, child: Text(<span class="hljs-string">&quot;Increment&quot;</span>))<br>          ],<br>        ),<br>      ),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="TextField"><a href="#TextField" class="headerlink" title="TextField"></a>TextField</h3><h4 id="Main-4"><a href="#Main-4" class="headerlink" title="Main"></a>Main</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">void</span> main() &#123;<br>  runApp(<span class="hljs-keyword">const</span> MyApp());<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> MyApp(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,<br>      home: ToDoPage(),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ToDoPage"><a href="#ToDoPage" class="headerlink" title="ToDoPage"></a>ToDoPage</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ToDoPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> ToDoPage(&#123;<span class="hljs-keyword">super</span>.key&#125;);<br><br>  <span class="hljs-meta">@override</span><br>  State&lt;ToDoPage&gt; createState() =&gt; _ToDoPageState();<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ToDoPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ToDoPage</span>&gt; </span>&#123;<br>  TextEditingController myController = TextEditingController();<br>  <span class="hljs-built_in">String</span> greetingMessage = <span class="hljs-string">&quot;&quot;</span>;<br><br>  <span class="hljs-keyword">void</span> greetUser() &#123;<br>    setState(() &#123;<br>      greetingMessage = <span class="hljs-string">&quot;Hello, <span class="hljs-subst">$&#123;myController.text&#125;</span>&quot;</span>;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">return</span> Scaffold(<br>      body: Center(<br>        child: Padding(<br>          padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">25.0</span>),<br>          child: Column(<br>            mainAxisAlignment: MainAxisAlignment.center,<br>            children: [<br>              Text(greetingMessage),<br>              TextField(<br>                controller: myController,<br>                decoration: InputDecoration(<br>                  border: OutlineInputBorder(),<br>                  labelText: <span class="hljs-string">&quot;Enter your name&quot;</span>,<br>                ),<br>              ),<br>              ElevatedButton(onPressed: greetUser, child: Text(<span class="hljs-string">&quot;Tap&quot;</span>))<br>            ],<br>          ),<br>        ),<br>      ),<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/flutter-notes/demo6.png" alt="demo 6"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Flutter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>專題</title>
    <link href="/notes/2024/04/27/%E5%B0%88%E9%A1%8C/"/>
    <url>/notes/2024/04/27/%E5%B0%88%E9%A1%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="還沒看完"><a href="#還沒看完" class="headerlink" title="還沒看完"></a>還沒看完</h1><ul><li><p><a href="https://gamedevelopment.tutsplus.com/forward-rendering-vs-deferred-rendering--gamedev-12342a">Forward Rendering vs. Deferred Rendering</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/447161601">UE4笔记-自定义一个UPrimitiveComponent-0</a><br>比較粗略的教學</p></li><li><p><a href="https://www.bilibili.com/read/cv27302584/?jump_opus=1">UE5自定义MeshComponent解析</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/580731018">虚幻引擎 自定义VertexFactory（一）</a></p></li><li><p><a href="https://medium.com/@lordned/unreal-engine-4-rendering-overview-part-1-c47f2da65346">Unreal Engine 4 Rendering Part 1: Introduction</a></p></li><li><p><a href="https://unreal.shadeup.dev/docs/instancing">Indirect Instancing in UE5</a><br>只有 project，沒有介紹，有點難懂</p></li><li><p><a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/designing-visuals-rendering-and-graphics-with-unreal-engine">Designing Visuals, Rendering, and Graphics</a><br>UE5 官方文件</p></li><li><p><a href="https://www.cnblogs.com/timlly/p/14588598.html#322-%E4%BB%8Efprimitivesceneproxy%E5%88%B0fmeshbatch">剖析虚幻渲染体系（03）- 渲染机制</a><br>大佬寫的，看不完</p></li></ul><h1 id="看完的"><a href="#看完的" class="headerlink" title="看完的"></a>看完的</h1><h2 id="Creating-a-Custom-Mesh-Component-in-UE4"><a href="#Creating-a-Custom-Mesh-Component-in-UE4" class="headerlink" title="Creating a Custom Mesh Component in UE4"></a>Creating a Custom Mesh Component in UE4</h2><p>教你怎麼在 UE4 寫自己的 Mesh Component，內容包含 Custom Mesh Component、Scene Proxy、Vertex Factory、Vertex Shader 等介紹，還有附 Project Github，可惜介紹沒有寫完，且不會再更新了<br><a href="https://medium.com/realities-io/creating-a-custom-mesh-component-in-ue4-part-0-intro-2c762c5f0cd6">Creating a Custom Mesh Component in UE4 | Part 0: Intro</a><br><a href="https://medium.com/realities-io/creating-a-custom-mesh-component-in-ue4-part-1-an-in-depth-explanation-of-vertex-factories-4a6fd9fd58f2">Creating a Custom Mesh Component in UE4 | Part 1: An In-depth Explanation of Vertex Factories</a><br><a href="https://medium.com/realities-io/creating-a-custom-mesh-component-in-ue4-part-2-implementing-the-vertex-factory-4e21e51a1e10">Creating a Custom Mesh Component in UE4 | Part 2: Implementing the Vertex Factory</a><br><a href="https://medium.com/realities-io/creating-a-custom-mesh-component-in-ue4-part-3-the-mesh-components-scene-proxy-6965a3ea4cc9">Creating a Custom Mesh Component in UE4 | Part 3: The Mesh Component’s Scene Proxy</a></p><p>翻譯版<br><a href="https://zhuanlan.zhihu.com/p/361322348">创建虚幻自定义Mesh组件 | Part 1: 深度解释顶点工厂（Vertex Factory）</a><br><a href="https://zhuanlan.zhihu.com/p/361601866">创建虚幻自定义Mesh组件 | Part 2: 顶点工厂的实现</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>計算機圖學 筆記</title>
    <link href="/notes/2024/04/12/computer-graphics/"/>
    <url>/notes/2024/04/12/computer-graphics/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考 清華大學 李潤容老師 計算機圖學講義</p></blockquote><h1 id="Introduction-to-Computer-Graphics"><a href="#Introduction-to-Computer-Graphics" class="headerlink" title="Introduction to Computer Graphics"></a>Introduction to Computer Graphics</h1><h2 id="What-is-Computer-Graphics"><a href="#What-is-Computer-Graphics" class="headerlink" title="What is Computer Graphics"></a>What is Computer Graphics</h2><table><thead><tr><th align="center">Input</th><th align="center">Output</th><th align="center">Category</th></tr></thead><tbody><tr><td align="center">Image</td><td align="center">Image</td><td align="center">Image Processing</td></tr><tr><td align="center">Description Images</td><td align="center">Description</td><td align="center">Computer Vision&#x2F; Pattern Recognition</td></tr><tr><td align="center">Description</td><td align="center">Image</td><td align="center">Computer Graphics</td></tr></tbody></table><h3 id="Image-Processing"><a href="#Image-Processing" class="headerlink" title="Image Processing"></a>Image Processing</h3><ul><li>Performing various types of operations on an input image, and output an image with some useful information</li><li>Ex: Edge Detection, Image Compression</li></ul><h3 id="Computer-Vision-Pattern-Recognition"><a href="#Computer-Vision-Pattern-Recognition" class="headerlink" title="Computer Vision &#x2F; Pattern Recognition"></a>Computer Vision &#x2F; Pattern Recognition</h3><ul><li>Computer Vision<ul><li>Building a artificial system that obtain information from images</li></ul></li><li>Pattern Recognition<ul><li>Classify data based on either prior knowledge or on statistical information extracted from the patterns</li></ul></li><li>Ex: Object Detection, Tracking, Classification, Recognition</li></ul><h3 id="Computer-Graphics"><a href="#Computer-Graphics" class="headerlink" title="Computer Graphics"></a>Computer Graphics</h3><ul><li>Concern the pictorial synthesis of real or imaginary objects from their computer-based models</li><li>2D graphics<ul><li>Ex: Texts, 2D lines&#x2F; polygons&#x2F; images…</li></ul></li><li>3D graphics<ul><li>Project the objects onto 2D projection plane and render</li></ul></li><li>Types<ul><li>Passive Stereo<ul><li>The 3D effect is achieved by presenting slightly different images to each eye using techniques such as polarization or color filtering.</li><li>Ex:Anaglyphic 3D glasses (紅藍 3D 眼鏡)、Polarization 3D glasses (偏光 3D 眼鏡)</li></ul></li><li>Active Stereo<ul><li>Involve synchronizing shutter glasses or alternate-frame sequencing with the display to present different images to each eye at high speed.</li><li>Ex: Shutter Glasses、VR display</li></ul></li></ul></li></ul><h1 id="Graphics-Hardware-System"><a href="#Graphics-Hardware-System" class="headerlink" title="Graphics Hardware System"></a>Graphics Hardware System</h1><h2 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h2><ul><li>Graphics Processing Unit</li><li>Very high complexity with massively parallelism</li></ul><h2 id="Frame-Buffer"><a href="#Frame-Buffer" class="headerlink" title="Frame Buffer"></a>Frame Buffer</h2><ul><li>Memory location for storing display data during processing<ul><li>Front buffer (Current display buffer)</li><li>Back buffer (Nexy display buffer)</li></ul></li></ul><h3 id="Screen-Display-Refresh"><a href="#Screen-Display-Refresh" class="headerlink" title="Screen&#x2F; Display Refresh"></a>Screen&#x2F; Display Refresh</h3><ul><li>Retrieve <strong>front buffer</strong> pixels for displaying pixel colors on screen</li><li>Constant refresh rate</li><li>Scan-line based display<ul><li>從左上往右，一行一行往下顯示</li></ul></li></ul><h3 id="Single-Buffering"><a href="#Single-Buffering" class="headerlink" title="Single Buffering"></a>Single Buffering</h3><ul><li>Display after rendering complete<ul><li>cannot render during display</li></ul></li><li>Rendering during displaying<ul><li>Display incomplete result</li><li>畫面可能會有黑黑的</li></ul></li></ul><p><img src="/notes/./images/computer-graphics/SingleBuffering.png" alt="Single Buffering"></p><h3 id="Double-Buffering"><a href="#Double-Buffering" class="headerlink" title="Double Buffering"></a>Double Buffering</h3><ul><li>A techinique to prevent from displaying incomplete frame</li></ul><p><img src="/notes/./images/computer-graphics/DoubleBuffering.png" alt="Double Buffering"></p><h3 id="Full-Screen-Display"><a href="#Full-Screen-Display" class="headerlink" title="Full Screen Display"></a>Full Screen Display</h3><ul><li>Uses Double Buffering or Triple Buffering</li><li>Flip display by changing <strong>display base address</strong> to corresponding buffer</li></ul><h3 id="Window-Mode-Display"><a href="#Window-Mode-Display" class="headerlink" title="Window Mode Display"></a>Window Mode Display</h3><ul><li>Uses Double Buffering or Triple Buffering</li><li>Flip display by using 2D bitblt to move <strong>back buffer</strong> frame on to <strong>front buffer</strong> display</li></ul><h1 id="3D-Graphics-Pipeline"><a href="#3D-Graphics-Pipeline" class="headerlink" title="3D Graphics Pipeline"></a>3D Graphics Pipeline</h1><ul><li>Almost everything you see on the display is processed by the graphics pipeline<ul><li>Windows UI、Video Games 等</li><li>不過像播影片就不算，它是直接寫到 frame buffer，沒有經過 graphics pipeline</li></ul></li><li>It is realized by graphics hardware (GPU) or by software (CPU)<ul><li>用 hardware 可以比較快，但如果沒有 GPU 加速，用 software (CPU) 也可以算</li></ul></li></ul><h2 id="Graphics-Rendering-Process"><a href="#Graphics-Rendering-Process" class="headerlink" title="Graphics Rendering Process"></a>Graphics Rendering Process</h2><p><img src="/notes/./images/computer-graphics/GraphicsRenderingProcess.png" alt="Graphics Rendering Process"></p><h3 id="3D-Graphics-Engine"><a href="#3D-Graphics-Engine" class="headerlink" title="3D Graphics Engine"></a>3D Graphics Engine</h3><ul><li>屬於硬體，Graphics pipeline 就在這邊</li></ul><h3 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h3><ul><li>不是所有的硬體可以解決所有問題，有些事情你會以為硬體幫你做，其實是 Driver 在做。有時候有 Bug，它會幫你用 Driver (software) 的方式繞過去，看起來是硬體修復了</li><li>做 Hardware 的人通常也負責做 Driver，雖然它算是軟體</li></ul><h2 id="Inside-a-3D-Graphics-Pipeline"><a href="#Inside-a-3D-Graphics-Pipeline" class="headerlink" title="Inside a 3D Graphics Pipeline"></a>Inside a 3D Graphics Pipeline</h2><h3 id="Fixed-Function-Pipeline"><a href="#Fixed-Function-Pipeline" class="headerlink" title="Fixed Function Pipeline"></a>Fixed Function Pipeline</h3><p>每個 Stage 功能都是寫死的，像是 Transform and Lighting，所以效果都看起來差不多，現在很少用</p><p><img src="https://cg2010studio.files.wordpress.com/2011/09/opengles_1x_pipeline.gif" alt="OpenGL ESv1.1"></p><h3 id="Programmable-Pipeline"><a href="#Programmable-Pipeline" class="headerlink" title="Programmable Pipeline"></a>Programmable Pipeline</h3><p>把 Fixed Function Pipeline 其中某幾個功能包裝成 Shader，讓 programmer 可以自己改，像是多了 Vertex Shader 來取代原本的 Transform and Lighting</p><p><img src="https://cg2010studio.com/wp-content/uploads/2011/09/opengles_2x_pipeline.gif" alt="OpenGL ESv2.0"></p><p><img src="/notes/./images/computer-graphics/Overviewofa3DGraphicsPipeline.png" alt="Overview of a 3D Graphics Pipeline"></p><h4 id="Modeling"><a href="#Modeling" class="headerlink" title="Modeling"></a>Modeling</h4><p><img src="/notes/./images/computer-graphics/Modeling.png" alt="Modeling"></p><h4 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h4><p>放大、縮小、平移、旋轉</p><ol><li>Geometrical Transformation (Model Transformation)</li></ol><ul><li>From <strong>Object Space</strong> to <strong>World Space</strong><ul><li>每個物體有自己的座標系</li></ul></li></ul><p><img src="/notes/./images/computer-graphics/GeometricalTransformation.png" alt="Geometrical Transformation"></p><ol start="2"><li>Viewing Transformation</li></ol><ul><li>From <strong>World Space</strong> to <strong>View Space</strong></li></ul><p><img src="/notes/./images/computer-graphics/ViewingTransformation.png" alt="Viewing Transformation"></p><ol start="3"><li>Projection Transformation</li></ol><ul><li>From <strong>View Space</strong> to <strong>Screen Space</strong></li></ul><p><img src="/notes/./images/computer-graphics/ProjectionTransformation.png" alt="Projection Transformation"></p><h4 id="Lighting"><a href="#Lighting" class="headerlink" title="Lighting"></a>Lighting</h4><p>Simulate the Effect of Light-Object Interaction</p><ul><li>簡化成 Ambient(環境光) + Diffuse(漫反射光) + Specular Reflection(鏡面光)</li></ul><p><img src="http://learnopengl.com/img/lighting/basic_lighting_phong.png" alt="Lighting"></p><ul><li><a href="https://learnopengl-cn.readthedocs.io/zh/latest/02%20Lighting/02%20Basic%20Lighting/">光照基础 - LearnOpenGL-CN</a></li></ul><h4 id="Triangle-Setup"><a href="#Triangle-Setup" class="headerlink" title="Triangle Setup"></a>Triangle Setup</h4><p>對於一個三角形，算出每邊的斜率，三個頂點的座標不一定是整數，但是畫的點座標必須是整數，所以要得到三角形內部的所有整數座標</p><p><img src="/notes/./images/computer-graphics/TriangleSetup.png" alt="Triangle Setup"></p><h4 id="Rasterization"><a href="#Rasterization" class="headerlink" title="Rasterization"></a>Rasterization</h4><ul><li>根據頂點的顏色，用內插法算出三角形內部的顏色</li></ul><p><img src="/notes/./images/computer-graphics/TriangleRasterization.png" alt="Triangle Rasterization"></p><ul><li>Line Rasterization</li></ul><p><img src="/notes/./images/computer-graphics/LineRasterization.png" alt="Line Rasterization"></p><h4 id="Hidden-Surface-Removal"><a href="#Hidden-Surface-Removal" class="headerlink" title="Hidden Surface Removal"></a>Hidden Surface Removal</h4><p>移除被擋住、看不到的地方</p><p><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQtEhHXHQSecUmH7ZSasawmMxaeKglIcD1yOQ&usqp=CAU" alt="Hidden Surface Removal"></p><h4 id="Texture-Mapping"><a href="#Texture-Mapping" class="headerlink" title="Texture Mapping"></a>Texture Mapping</h4><p><img src="https://glasnost.itcarlow.ie/~powerk/GeneralGraphicsNotes/texturemapping/texture_mapping.jpg" alt="Texture Mapping"></p><h4 id="Rendering"><a href="#Rendering" class="headerlink" title="Rendering"></a>Rendering</h4><h5 id="Color-Composition"><a href="#Color-Composition" class="headerlink" title="Color Composition"></a>Color Composition</h5><p>Render with lighting and texturing<br><img src="/notes/./images/computer-graphics/ColorComposition.png" alt="Color Composition"></p><h5 id="Blending"><a href="#Blending" class="headerlink" title="Blending"></a>Blending</h5><p>Translucent Effect<br><img src="/notes/./images/computer-graphics/Blending.png" alt="Blending"><br>物體透明度和桌子透明度都變 50%，然後混合</p><h4 id="Advanced-Features"><a href="#Advanced-Features" class="headerlink" title="Advanced Features"></a>Advanced Features</h4><h5 id="Shadow"><a href="#Shadow" class="headerlink" title="Shadow"></a>Shadow</h5><ul><li>Hard Shadow</li><li>Soft Shadow</li></ul><p><img src="https://www.peachpit.com/content/images/chap3_0321316312/elementLinks/dir2_03_22.jpg" alt="Shadow"></p><h5 id="Anti-Aliasing"><a href="#Anti-Aliasing" class="headerlink" title="Anti-Aliasing"></a>Anti-Aliasing</h5><p>Smooth out the Jaggy Edges<br><img src="https://camo.githubusercontent.com/d02e9089abb4f56ece4a30705261fd7d9554947a8dc2f4e3006b358bb5700ca1/68747470733a2f2f686172647a6f6e652e65732f6170702f75706c6f6164732d686172647a6f6e652e65732f323032302f30342f416e74692d416c696173696e672d312e6a7067" alt="Anti-Aliasing"></p><h5 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h5><p><img src="/notes/./images/computer-graphics/Shader.png" alt="Shader"></p><h6 id="Vertex-Shader"><a href="#Vertex-Shader" class="headerlink" title="Vertex Shader"></a>Vertex Shader</h6><ul><li>Process vertices<ul><li>Transformation</li><li>Lighting</li><li>Displacement</li></ul></li><li>Operate on a single input vertex and produce a single output vertex</li></ul><h6 id="Tessellation-Geometry-Shader"><a href="#Tessellation-Geometry-Shader" class="headerlink" title="Tessellation&#x2F;Geometry Shader"></a>Tessellation&#x2F;Geometry Shader</h6><ul><li>近的時候可以切成很多小三角形，遠的時候切比較大</li><li>Process priitives<ul><li>Point sprite tessellation</li><li>Wide line tessellation</li><li>Shadow volume generation</li><li>Surface subdivision</li></ul></li><li>Inputs one primitive and outputs can be more than one primitives</li></ul><h6 id="Pixel-Shader"><a href="#Pixel-Shader" class="headerlink" title="Pixel Shader"></a>Pixel Shader</h6><ul><li>Process pixels<ul><li>Texture mapping</li><li>Color combine</li><li>Per-pixel lighting</li><li>…</li></ul></li><li>Inputs one pixel and outputs one pixel at same position, or no pixel at all</li></ul><h1 id="Introduction-to-OpenGL"><a href="#Introduction-to-OpenGL" class="headerlink" title="Introduction to OpenGL"></a>Introduction to OpenGL</h1><h2 id="What-is-OpenGL"><a href="#What-is-OpenGL" class="headerlink" title="What is OpenGL"></a>What is OpenGL</h2><ul><li>Open Graphics Library (OpenGL) is an open standard for <strong>cross-language</strong>, <strong>cross-platform</strong> API specification</li><li>OpenGL is a set of <strong>APIs</strong> used to write 2D&#x2F;3D graphics applications</li><li>OpenGL defines the function specification of each API and leaves the implementation to the vendors themselves<ul><li>OpenGL 只有定 SPEC，具體怎麼做留給硬體廠商</li><li>每個硬體可能執行運算的方式不太一樣，像是做加法時，可能精度不一樣</li></ul></li></ul><h2 id="Other-Graphics-APIs"><a href="#Other-Graphics-APIs" class="headerlink" title="Other Graphics APIs"></a>Other Graphics APIs</h2><ul><li>Direct3D<ul><li><strong>Proprietary</strong> Microsoft Windows 3D graphics API</li></ul></li><li>Vulkan</li><li>OpenGL ES<ul><li>OpenGL for Emnedded Systems</li></ul></li><li>Web-based OpenGL</li><li>Metal</li><li>Mantle</li></ul><h2 id="OpenGL-vs-Direct3D"><a href="#OpenGL-vs-Direct3D" class="headerlink" title="OpenGL vs. Direct3D"></a>OpenGL vs. Direct3D</h2><p><img src="/notes/./images/computer-graphics/OpenGLvsDirect3D.png" alt="OpenGL vs. Direct3D"></p><h2 id="OpenGL-Extension"><a href="#OpenGL-Extension" class="headerlink" title="OpenGL Extension"></a>OpenGL Extension</h2><p>硬體廠商可以寫自己的 OpenGL Extension，像是 AMD、NVDIA…</p><ul><li>Advantages<ul><li>Develop new functionality before new API spec is released</li><li>Hardware vendors can expose their new hardware features via extension first</li><li>Extension becomes core function (or extension) after being approved by ARB(Architecture Review Board)</li></ul></li><li>Disadvantages<ul><li>It is vendor specific before approved by ARB</li><li>Compatibility</li></ul></li><li>GLEW&#x2F;GLAD can help in querying and loading OpenGL extensions</li></ul><h2 id="Why-OpenGL"><a href="#Why-OpenGL" class="headerlink" title="Why OpenGL"></a>Why OpenGL</h2><ul><li>Cross-platform<ul><li>Windows Mac OSX, Linux</li></ul></li><li>Better backward compatibility<ul><li>舊的 OpenGL code 通常還是可以跑</li></ul></li><li>Run on various hardware platforms<ul><li>OpenGL, OpenGL ES, WebGL</li></ul></li></ul><h2 id="Convention-of-an-OpenGL-API"><a href="#Convention-of-an-OpenGL-API" class="headerlink" title="Convention of an OpenGL API"></a>Convention of an OpenGL API</h2><p><img src="/notes/./images/computer-graphics/ConventionofanOpenGLAPI.png" alt="Convention of an OpenGL API"></p><h3 id="Data-Types"><a href="#Data-Types" class="headerlink" title="Data Types"></a>Data Types</h3><p>C++ data types 和 OpenGL data types 大部分一樣，但還是有些許不同<br><img src="/notes/./images/computer-graphics/OpenGLDataTypes.png" alt="OpenGL Data Types"></p><h2 id="OpenGL-Pipeline"><a href="#OpenGL-Pipeline" class="headerlink" title="OpenGL Pipeline"></a>OpenGL Pipeline</h2><p><img src="/notes/./images/computer-graphics/OpenGLPipeline.png" alt="OpenGL Pipeline"><br><a href="http://romain.vergne.free.fr/teaching/IS/SI03-pipeline.html">Image synthesis and OpenGL: graphics pipeline</a></p><p><img src="/notes/./images/computer-graphics/OpenGLPipeline2.png" alt="OpenGL Pipeline"></p><ul><li>紅色代表 programmable，虛線代表可以不需要，但還是建議要寫 fragment shader 比較好</li></ul><h2 id="OpenGL-Shading-Language"><a href="#OpenGL-Shading-Language" class="headerlink" title="OpenGL Shading Language"></a>OpenGL Shading Language</h2><ul><li>High-Level shading language based on C programming language</li><li>DirectX + HLSL vs. OpenGL + GLSL</li><li>Hardware vendors will provide shader compiler to optimize the shader codes for deriving best performance running on their hardware architecture</li></ul><h2 id="OpenGL-工具"><a href="#OpenGL-工具" class="headerlink" title="OpenGL 工具"></a>OpenGL 工具</h2><h3 id="OpenGL-Context-Window-Creation"><a href="#OpenGL-Context-Window-Creation" class="headerlink" title="OpenGL Context&#x2F;Window Creation"></a>OpenGL Context&#x2F;Window Creation</h3><ul><li><strong>context</strong> stores all the states associated with the instance of OpenGL rendering</li><li><strong>window</strong> is the window where your rendering result displayed</li><li><strong>event handlings</strong> process different kinds of input such as keyboard and mouse</li></ul><p>A cross-platform toolkit for writing OpenGL programs</p><ul><li>Support application frameworks to control the platform’s <strong>window system</strong> and <strong>event handling</strong></li></ul><h5 id="GLUT"><a href="#GLUT" class="headerlink" title="GLUT"></a>GLUT</h5><ul><li>Pretty old and no longer maintained</li></ul><h4 id="Freeglut"><a href="#Freeglut" class="headerlink" title="Freeglut"></a>Freeglut</h4><ul><li>An alternative to GLUT</li><li><a href="https://freeglut.sourceforge.net/">https://freeglut.sourceforge.net/</a></li></ul><h5 id="GLFW"><a href="#GLFW" class="headerlink" title="GLFW"></a>GLFW</h5><ul><li><a href="https://www.glfw.org/">https://www.glfw.org/</a></li></ul><h3 id="OpenGL-Loading-Libraries"><a href="#OpenGL-Loading-Libraries" class="headerlink" title="OpenGL Loading Libraries"></a>OpenGL Loading Libraries</h3><p>OpenGL loader checks the graphics driver for which OpenGL version profile is supported and gets all the function pointers as well as the supported extensions</p><h5 id="GLEW"><a href="#GLEW" class="headerlink" title="GLEW"></a>GLEW</h5><p>The OpenGL Extension Wrangler Library</p><ul><li>A cross-platform open-source C&#x2F;C++ extension loading library</li><li>Provides efficient run-time mechanisms for determining which OpenGL extensions are supported on the target platform</li><li><a href="http://glew.sourceforge.net/">http://glew.sourceforge.net/</a></li></ul><h5 id="GLAD"><a href="#GLAD" class="headerlink" title="GLAD"></a>GLAD</h5><p>Multi-Language GL&#x2F;GLES&#x2F;EGL&#x2F;GLX&#x2F;WGL Loader-Generator based on the official specs</p><ul><li>An tool (with a web-service) for generating OpenGL, OpenGL ES, EGL, GLX and WGL headers (and loaders) based on the official XML specifications</li><li>You can customized to the version you like without including those deprecated or legacy functions</li><li><a href="https://glad.dav1d.de/">https://glad.dav1d.de/</a></li></ul><h3 id="Other-OpenGL-Useful-Utilities"><a href="#Other-OpenGL-Useful-Utilities" class="headerlink" title="Other OpenGL Useful Utilities"></a>Other OpenGL Useful Utilities</h3><h5 id="GLM"><a href="#GLM" class="headerlink" title="GLM"></a>GLM</h5><p>OpenGL mathematics libraries</p><ul><li>A header only C++ mathematics library for graphics software based on the OpenGL Shading Language (GLSL) specifications</li><li><a href="https://glm.g-truc.net/0.9.9/index.html">https://glm.g-truc.net/0.9.9/index.html</a></li></ul><h5 id="stb-image-h"><a href="#stb-image-h" class="headerlink" title="stb_image.h"></a>stb_image.h</h5><p>Image and texture</p><ul><li>An image-loading library that supports several popular formats</li><li><a href="https://github.com/nothings/stb/blob/master/stb_imag">https://github.com/nothings/stb/blob/master/stb_imag</a></li></ul><h4 id="Asset-Model-loader"><a href="#Asset-Model-loader" class="headerlink" title="Asset&#x2F;Model loader"></a>Asset&#x2F;Model loader</h4><h5 id="Open-Asset-Import"><a href="#Open-Asset-Import" class="headerlink" title="Open Asset Import"></a>Open Asset Import</h5><ul><li>A loader with support to a variety of 3D file formats</li><li><a href="http://www.assimp.org/">http://www.assimp.org/</a></li></ul><h5 id="TinyOBJ-loader"><a href="#TinyOBJ-loader" class="headerlink" title="TinyOBJ loader"></a>TinyOBJ loader</h5><ul><li>A simple wavefront boj file loader</li><li><a href="https://github.com/tinyobjloader/tinyobjloader">https://github.com/tinyobjloader/tinyobjloader</a></li></ul><h5 id="glm"><a href="#glm" class="headerlink" title="glm"></a>glm</h5><ul><li>A simple wavefront obj file loader</li><li>Not the OpenGL Mathematics Library</li><li><a href="http://devernay.free.fr/hacks/glm/">http://devernay.free.fr/hacks/glm/</a></li></ul><h2 id="OpenGL-Application-Framework"><a href="#OpenGL-Application-Framework" class="headerlink" title="OpenGL Application Framework"></a>OpenGL Application Framework</h2><p>[P42]</p>]]></content>
    
    
    
    <tags>
      
      <tag>CG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity 新手教學 - 導入物件</title>
    <link href="/notes/2024/04/10/unity-tutorial-3/"/>
    <url>/notes/2024/04/10/unity-tutorial-3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>3D 虛擬影像即時互動 期中報告</p></blockquote><p>在這次教學中，我們將學習如何導入自己的圖片、音樂，或是將來自 Sketchfab 和 Unity Asset Store 的酷炫 3D 物件導入到你的 Unity 專案中</p><h2 id="導入自己的資源"><a href="#導入自己的資源" class="headerlink" title="導入自己的資源"></a>導入自己的資源</h2><p>導入自己的物件非常簡單，可以在 Project View 空白處點擊右鍵，Import New Asset，然後選擇要導入的物件即可</p><p><img src="/notes/./images/unity-tutorial-3/ImportNewAsset.png" alt="Import New Asset"></p><p>還有另一個方法，可以直接把那個東西拉進來就好（我都這樣，因為我很懶 XD</p><p><img src="/notes/./images/unity-tutorial-3/ImportDemo.gif" alt="Import Demo"></p><h3 id="導入圖片"><a href="#導入圖片" class="headerlink" title="導入圖片"></a>導入圖片</h3><p>值得一提的是，導入的圖片會自動變成 Texture，所以可以直接用在 3D 模型、UI 元素、粒子效果上面<br><img src="/notes/./images/unity-tutorial-3/Texture.png" alt="Texture"></p><h2 id="Unity-Asset-Store"><a href="#Unity-Asset-Store" class="headerlink" title="Unity Asset Store"></a>Unity Asset Store</h2><h3 id="什麼是-Unity-Asset-Store？"><a href="#什麼是-Unity-Asset-Store？" class="headerlink" title="什麼是 Unity Asset Store？"></a>什麼是 Unity Asset Store？</h3><p><a href="https://assetstore.unity.com/zh-CN">Unity Asset Store</a> 是 Unity 官方提供的一個平台，類似於 APP store，但是專注於 Unity 開發的資源。這裡有各種各樣的資源，包括 2D pixel art、3D 模型、材質、音效、程式碼，甚至是完整的專案模板、各種輔助型的工具。無論你是需要一個小工具還是一個完整的遊戲框架，Unity Asset Store 都能滿足你的需求。</p><h3 id="如何使用？"><a href="#如何使用？" class="headerlink" title="如何使用？"></a>如何使用？</h3><p>我這邊隨便選擇一個 <a href="https://assetstore.unity.com/packages/3d/environments/landscapes/mars-landscape-3d-175814">Mars Landscape 3D</a> 的 Package，確認右邊的 <strong>Original Unity version</strong> 符合當前版本後，點擊右邊的 <strong>Add to My Assets</strong>，它應該會叫你先登入帳號</p><p><img src="/notes/./images/unity-tutorial-3/AddNewAsset.png" alt="Add New Asset"></p><p>登入並 <strong>Add to My Assets</strong> 後，就成功加入了到你帳號的 Assets 裡面了</p><p><img src="/notes/./images/unity-tutorial-3/AddNewAsset2.png" alt="Add New Asset"></p><p>接著點擊 <strong>Open In Unity</strong>，它會自動幫你打開 Unity 裡面的 Package Manager</p><p><img src="/notes/./images/unity-tutorial-3/PackageManager.png" alt="Package Manager"></p><p>Package Manager 會有你所有的 Assets，之後你想要檢視 Package Manager 的話，也可以從上方的 Windows 裡面打開</p><p><img src="/notes/./images/unity-tutorial-3/PackageManager2.png" alt="Package Manager"></p><p>點擊右上方的 <strong>Download</strong>，下載完後再點 <strong>Import</strong>，然後繼續點 <strong>Import</strong></p><p><img src="/notes/./images/unity-tutorial-3/PackageManager3.png" alt="Package Manager"></p><p>現在這個 Unity Asset Store 的 Package 就成功導入到你的專案中了！</p><p><img src="/notes/./images/unity-tutorial-3/ProjectView.png" alt="Project View"></p><p><img src="/notes/./images/unity-tutorial-3/DemoScene.png" alt="Demo Scene"></p><p>不喜歡這個場景中的天空？沒問題！這邊再導入另一個在 Unity Asset Store 上的 Package - <a href="https://assetstore.unity.com/packages/2d/textures-materials/sky/skybox-series-free-103633">Skybox Series Free</a>，這 Package 提供許多精緻好看的 Skybox Material</p><p><img src="/notes/./images/unity-tutorial-3/SkyboxUnityAssetStore.png" alt="Skybox Unity Asset Store"></p><h4 id="Skybox"><a href="#Skybox" class="headerlink" title="Skybox"></a>Skybox</h4><p>Unity Skybox 是一種用於創建場景背景的特殊 Material，Unity 提供了幾種預設的 Skybox Shader，像是 6 Sided、Cubemap、Procedural 等，想要有更多動態效果，也可以自定義 Skybox Shader，不過這會比較進階一點</p><h5 id="6-Sided"><a href="#6-Sided" class="headerlink" title="6 Sided"></a>6 Sided</h5><p>我們可以在 Assets 中新增一個 Material</p><p><img src="/notes/./images/unity-tutorial-3/NewMaterial.png" alt="New Material"></p><p>在這個材質的 Inspector 中，把上方的 Shader 改成 6 Sided</p><p><img src="/notes/./images/unity-tutorial-3/SixSided.png" alt="Six Sided"><br><img src="/notes/./images/unity-tutorial-3/MaterialInspector.png" alt="Material Inspector"></p><p>可以看到它要我們放六張 Texture 進去，分別對應到正方體的六個面，就可以做出一個 Skybox</p><p><img src="https://opengameart.org/sites/default/files/Sorsele.jpg" alt="Skybox"></p><p>這邊我就直接拿導入的 Skybox Material 來演示怎麼改變場景中的天空</p><h5 id="全域改變"><a href="#全域改變" class="headerlink" title="全域改變"></a>全域改變</h5><p><img src="/notes/./images/unity-tutorial-3/Lighting.png" alt="Lighting"></p><p>在上方 Window 裡面的 Rendering 中可以找到 Lighting，點選後會跳出一個視窗</p><p><img src="/notes/./images/unity-tutorial-3/LightingInspector.png" alt="Lighting Inspector"></p><p>在這個視窗上方的 Environment 中會找到一個 <strong>Skybox Material</strong>，可以直接把剛剛導入的 Package 中的 Material 拖曳進去，或是直接拖曳到場景中也可以，都是做全域的改變，會影響所有場景的 Camera 的 Skybox</p><p><img src="/notes/./images/unity-tutorial-3/GlobalSkybox.gif" alt="Global Skybox"></p><h5 id="局部改變"><a href="#局部改變" class="headerlink" title="局部改變"></a>局部改變</h5><p>比較好的做法是在 Camera 裡面新增一個 Skybox Component</p><p><img src="/notes/./images/unity-tutorial-3/CameraInspector.png" alt="Camera Inspector"></p><p>一樣把想要的 Skybox Material 拖曳進去，這樣只會影響這個 Camera，且會 Override Lighting Tab 的設定</p><p><img src="/notes/./images/unity-tutorial-3/LocalSkybox.gif" alt="Local Skybox"></p><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>每次 Import Package 後，可以先去找這個 Package 所提供的 Demo Scene，執行看看有沒有問題，確保這個 Package 是和你現在的 Unity 專案相容的，避免未來出現問題卻找不到問題點在哪</p><h2 id="Sketchfab"><a href="#Sketchfab" class="headerlink" title="Sketchfab"></a>Sketchfab</h2><h3 id="什麼是-Sketchfab？"><a href="#什麼是-Sketchfab？" class="headerlink" title="什麼是 Sketchfab？"></a>什麼是 Sketchfab？</h3><p><a href="https://sketchfab.com/">Sketchfab</a> 是一個線上的平台，提供大量的 3D 模型資源，從建築到角色、動物等各種類型的物件都可以在這裡取得。這些模型通常由社群或專業的模型師製作，你可以在 Sketchfab 上瀏覽、分享，甚至購買這些模型來使用在你的專案中。</p><h3 id="如何使用？-1"><a href="#如何使用？-1" class="headerlink" title="如何使用？"></a>如何使用？</h3><p>這邊隨便選擇一個 Pop cat 的 3D 模型，右上角兩個符號代表這模型有動畫，且是可以下載的</p><p><img src="/notes/./images/unity-tutorial-3/SketchfabModel.png" alt="Sketchfab Model"></p><p><img src="/notes/./images/unity-tutorial-3/SketchfabModel2.png" alt="Sketchfab Model"></p><p><img src="/notes/./images/unity-tutorial-3/SketchfabModel3.png" alt="Sketchfab Model"></p><p>可以看到這邊沒有 Unity 支援的 .fbx、.dae (Collada)、.dxf 和 .obj. 等格式，不過有提供 .blend，所以我們可以自己開 blender 轉換成 .fbx</p><p><img src="/notes/./images/unity-tutorial-3/Blender.png" alt="Blender"></p><p>導出成 .fbx 的時候，記得把右上角的 Path Mode 改成 Copy，並點擊右邊的 Embed Textures，之後導入進 Unity 中才能生成對應的 Texture</p><p><img src="/notes/./images/unity-tutorial-3/Blender2.png" alt="Blender"></p><p>按照先前說的方式導入模型進 Unity 後，你會發現它沒有 Texture</p><p><img src="/notes/./images/unity-tutorial-3/CatModel.png" alt="Cat Model"></p><p>這時候只要點選剛剛導入進 Assets 的模型，在右邊 Inspector 中的 Materials 裡面點擊 Extract Textures…，就可以順利加上 Texture 了</p><p><img src="/notes/./images/unity-tutorial-3/CatInspector.png" alt="Cat Model"></p><p>這樣就模型就有 Texture 了！</p><p><img src="/notes/./images/unity-tutorial-3/CatModelTexture.png" alt="Cat Model Texture"></p><h2 id="Prefab"><a href="#Prefab" class="headerlink" title="Prefab"></a>Prefab</h2><h3 id="什麼是-Prefab？"><a href="#什麼是-Prefab？" class="headerlink" title="什麼是 Prefab？"></a>什麼是 Prefab？</h3><p>你可能有注意到，當你從 Unity Asset Store 或 Sketchfab 導入模型後，在 Hierarchy View 中看到一些藍色的物件。這些藍色物件被稱為 Prefab（預製配件）。Prefab 是 Unity 中的一種特殊、可以重複使用的物件。</p><p><img src="/notes/./images/unity-tutorial-3/Prefab.png" alt="Prefab"></p><p>舉個例子，假如你在場景中有大量一樣的石頭，這時候你就可以把石頭做成一個 Prefab，這就有點像是這顆石頭的 <strong>藍圖</strong>，你可以根據這個藍圖去建立一大堆石頭。當你想要一次修改時，就可以改這個藍圖就好，不用每一顆慢慢去修改。</p><p><img src="/notes/./images/unity-tutorial-3/CatArmy.png" alt="Cat Army"></p><p><img src="/notes/./images/unity-tutorial-3/ModifyPrefab.gif" alt="Modify Prefab"></p><p>這邊我想要更改 Cat 模型的 Scale，只需要更改藍圖就好，這樣場景中所有根據這個 Prefab 建立的物件就會一起更新。</p><h3 id="如何建立-Prefab？"><a href="#如何建立-Prefab？" class="headerlink" title="如何建立 Prefab？"></a>如何建立 Prefab？</h3><p>非常簡單，只要把你 Hierarchy View 中的物件拉進你的 Project View 裡面就好。像是我這邊建立一個 Cube 到場景中，把它拉進下方就成功囉～</p><p><img src="/notes/./images/unity-tutorial-3/CreatePrefab.gif" alt="Create Prefab"></p><hr><p>到目前為止，你應該大致了 Prefab 作用及應用，也知道怎麼導入其它人準備好的各種素材。善用 Unity Asset Store 的各種資源，就算對美術一竅不通，也能夠打造出精緻的遊戲！</p><p>下次再見～</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity 新手教學 - 介面介紹和基本操作</title>
    <link href="/notes/2024/04/10/unity-tutorial-2/"/>
    <url>/notes/2024/04/10/unity-tutorial-2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>3D 虛擬影像即時互動 期中報告</p></blockquote><p>在這次教學中，我們將學習了解 Unity 的開發者介面，以及如何新增物件還有編輯的快捷鍵。</p><h2 id="Unity-介面介紹"><a href="#Unity-介面介紹" class="headerlink" title="Unity 介面介紹"></a>Unity 介面介紹</h2><p>在 Unity Editor 中，開發者的介面分割得非常明確，大致可以將畫面分成幾個區塊，每個區塊都有特定的功能</p><p><img src="/notes/./images/unity-tutorial-2/UnityEditor.png" alt="Unity Editor"></p><h3 id="Hierarchy-View"><a href="#Hierarchy-View" class="headerlink" title="Hierarchy View"></a>Hierarchy View</h3><p>預設位於介面的左上方，這裡顯示了場景中的所有物體的層次結構。你可以在這裡看到物體之間的父子關係，還有它們的名稱。</p><p>在預設場景中，Unity 會幫你新增兩個物件，Main Camera 和 Direction Light。Camera 可以想像成有人扛著攝影機負責轉播現在遊戲的情況，所以玩家看到的遊戲畫面都至少有一個 Camera 負責。Direction Light 則負責場景中的光照。</p><h4 id="補充"><a href="#補充" class="headerlink" title="補充"></a>補充</h4><ul><li>請記得把所有物件都以英文命名，不然在程式碼中尋找中文名稱的物件時，極有可能發生找不到的問題</li><li>請把所有物件的名稱都命名的淺顯易懂，最好是一看到名字就知道這個東西在幹嘛，不然日後會被自己害死… (親身經驗</li></ul><h3 id="Scene-View"><a href="#Scene-View" class="headerlink" title="Scene View"></a>Scene View</h3><p>預設位於介面的中間，這是遊戲的可視化界面，可以在這裡編輯和調整場景中的物體</p><h3 id="Game-View"><a href="#Game-View" class="headerlink" title="Game View"></a>Game View</h3><p>預設位於介面的中間，這裡顯示遊戲的運行結果，也就是你在 Scene View 更改的結果，可以在這邊做簡單的 Demo，看一下目前遊戲長什麼樣子</p><h3 id="Inspector-View"><a href="#Inspector-View" class="headerlink" title="Inspector View"></a>Inspector View</h3><p>預設位於介面的右邊，這裡顯示的是點選的物體或資源的屬性，對於物體而言，可能會有位置、旋轉、碰撞器或是腳本等屬性，都在這邊可以做修改它們的設定</p><h3 id="Project-View"><a href="#Project-View" class="headerlink" title="Project View"></a>Project View</h3><p>預設位於介面的下方，這邊包含遊戲會用到的所有資源。在 Project View 裡面可以看到有兩個資料夾，Assets 和 Packages，Packages 存放的是許多 Unity 內建既有的東西，我們可以不用理它。我們所新加入的任何資源都會在 Assets 裡面，像是 Material、Script、Shader、Prefab、音效、圖片以及導入的 Package 等等</p><p>現在我們就我們開始在場景中新增物件吧～</p><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><h3 id="新增物件"><a href="#新增物件" class="headerlink" title="新增物件"></a>新增物件</h3><p><img src="/notes/./images/unity-tutorial-2/AddGameObject.png" alt="Add Game Object"><br>在左邊的 Hierarchy View 中點擊滑鼠右鍵，選擇 <strong>3D OBject</strong> 可以看到許多選擇，像是正方體、球體、膠囊體(?、圓柱體等等，這邊先選擇正方體</p><p><img src="/notes/./images/unity-tutorial-2/AddGameObject2.png" alt="Add Game Object"></p><p>新增好後 Hierarchy View 就多了一個名為 Cube 的 Cube，Scene View 和 Game View 也可以看到這個正方體。點選這個正方體，右邊的 Inspector View 就會顯示這個正方體的詳細資訊。</p><h3 id="快捷鍵"><a href="#快捷鍵" class="headerlink" title="快捷鍵"></a>快捷鍵</h3><p>想要快速編輯遊戲場景，勢必要熟悉 Unity 的一些操作，這邊簡單介紹一下我經常使用的快捷鍵</p><h4 id="滑鼠滾輪"><a href="#滑鼠滾輪" class="headerlink" title="滑鼠滾輪"></a>滑鼠滾輪</h4><p>放大和縮小當前的畫面<br><img src="/notes/./images/unity-tutorial-2/MouseScroll.gif" alt="Mouse Scroll"></p><h4 id="ALT"><a href="#ALT" class="headerlink" title="ALT"></a>ALT</h4><p>能夠改變當前的視角角度<br><img src="/notes/./images/unity-tutorial-2/ALT.gif" alt="ALT"></p><h4 id="Q"><a href="#Q" class="headerlink" title="Q"></a>Q</h4><p>快速切換成 View Tool，可以在 Scene View 中自由移動<br><img src="/notes/./images/unity-tutorial-2/Q.gif" alt="Q"></p><h4 id="W"><a href="#W" class="headerlink" title="W"></a>W</h4><p>快速切換成 Move Tool，可以移動物體的位置<br><img src="/notes/./images/unity-tutorial-2/W.gif" alt="W"></p><h4 id="E"><a href="#E" class="headerlink" title="E"></a>E</h4><p>快速切換成 Rotate Tool，可以旋轉物體<br><img src="/notes/./images/unity-tutorial-2/E.gif" alt="E"></p><h4 id="R"><a href="#R" class="headerlink" title="R"></a>R</h4><p>快速切換成 Scale Tool，可以改變物體的大小<br><img src="/notes/./images/unity-tutorial-2/R.gif" alt="R"></p><p>事實上，上面提到的 QWER 也可以直接用滑鼠點 Scene View 左上角的 Tools 來使用，不過直接用快捷鍵會在日後方便許多，建議可以多熟悉使用快捷鍵來編輯。</p><p>除此之外，在移動物體、旋轉物體和縮放物體的時候，可以看到右上角 Inspector 中的 Transform 也會隨之改變，前面有提到 Inspector View 可以檢視當前物體的屬性，且物體的位置、旋轉角度和大小都存在於 <strong>Transform 屬性</strong> 裡面，所以其實也可以直接在這邊輸入數字去做修改，和在 Scene View 去編輯是沒有差別的。</p><p><img src="/notes/./images/unity-tutorial-2/InspectorView.gif" alt="Inspector View"></p><h4 id="按住右鍵-W-A-S-D-Q-E-滾輪"><a href="#按住右鍵-W-A-S-D-Q-E-滾輪" class="headerlink" title="按住右鍵 + W&#x2F;A&#x2F;S&#x2F;D&#x2F;Q&#x2F;E&#x2F;滾輪"></a>按住右鍵 + W&#x2F;A&#x2F;S&#x2F;D&#x2F;Q&#x2F;E&#x2F;滾輪</h4><p>按住右鍵加上 W (前進)、A (往左)、S (後退)、D (往右)、 Q (往下)、E (往上)、滾輪 (調整移動速度)，可以快速在 Scene View 裡面移動，就跟你正在以第一人稱在遊戲場景中移動一樣，非常方便</p><p><img src="/notes/./images/unity-tutorial-2/Combo.gif" alt="Combo"></p><h4 id="F"><a href="#F" class="headerlink" title="F"></a>F</h4><p>快速在場景中找到某物件。在 Hierarchy View 裡面找到目標物件，點擊 F 可以瞬間到它旁邊。當遊戲場景很大的時候，這個功能會變得很好用，不用在場景中慢慢自己找。用滑鼠點兩下也可以<br><img src="/notes/./images/unity-tutorial-2/F.gif" alt="R"></p><h4 id="Ctrl-Z-Ctrl-Y"><a href="#Ctrl-Z-Ctrl-Y" class="headerlink" title="Ctrl + Z &#x2F; Ctrl + Y"></a>Ctrl + Z &#x2F; Ctrl + Y</h4><p>Undo 和 Redo，這應該不用多說什麼</p><h4 id="Ctrl-S"><a href="#Ctrl-S" class="headerlink" title="Ctrl + S"></a>Ctrl + S</h4><p>儲存檔案。請<strong>務必</strong>養成做完任何改動都點一下 Ctrl + S 的習慣，Unity 並不會自動幫你儲存。有時候做完大幅度的改動後 Unity 突然崩潰，所有努力直接化為泡影，當下真的欲哭無淚 QAQ</p><p><img src="/notes/./images/unity-tutorial-2/UnityCrash.png" alt="Unity Crash"><br>每次看到這畫面心都會抖一下…</p><hr><p>到目前為止，你應該已經知道怎麼在遊戲中新增物件，還有怎麼改變物體在場景的位置、大小等，記得多多使用快捷鍵來提高效率！還有記住有事沒事就點一下 Ctrl + S，日後一定會感謝自己。</p><p>下一篇會介紹怎麼使用 Unity Asset Store、Sketchfab 導入 3D 場景和物件，或是導入自己的素材，下次再見～<a href="https://933yee.github.io/notes/2024/04/10/unity-tutorial-3/">Unity 新手教學 - 導入物件</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unity 新手教學 - WHY and HOW</title>
    <link href="/notes/2024/04/10/unity-tutorial/"/>
    <url>/notes/2024/04/10/unity-tutorial/</url>
    
    <content type="html"><![CDATA[<blockquote><p>3D 虛擬影像即時互動 期中報告</p></blockquote><p>在這次教學中，我們將學習 Unity 相較於 Unreal Engine 有哪些優勢，以及如何下載和建立一個新的 Unity 專案</p><h2 id="為什麼要用-Unity？"><a href="#為什麼要用-Unity？" class="headerlink" title="為什麼要用 Unity？"></a>為什麼要用 Unity？</h2><p>在遊戲開發的世界裡，Unity 是一個非常受歡迎的遊戲引擎，擁有許多獨特的優勢使它成為許多開發者的首選。儘管 Epic Games 開發的 Unreal Engine 因 Fortnite 的成功而聲名大噪，使他成為當今最熱門的遊戲引擎之一，許多 3A 大作也都是出自於 Unreal</p><p>說了那麼多，為什麼我們還要考慮使用 Unity 呢？讓我們來看看 Unity 有哪些 Unreal 沒有的優勢：</p><ol><li><p><strong>簡單好上手</strong><br>對於新手來說，Unity 提供了一個相對輕鬆的入門門檻。它的介面設計和操作方式相對更直觀，學習曲線也比 Unreal 穩定許多。此外，個人覺得 C# 會比 C++ 更好上手，不用處理一堆指標的問題，會更適合新手去學習，不過 C++ 能夠壓榨出更多硬體效能就是了～</p></li><li><p><strong>適合獨立遊戲製作</strong><br>Unreal Engine 通常被用於開發大型、高品質的遊戲，開發時間、成本會比較高，Unity 則更適用於快速開發、跨平台部署和較小規模的專案。如果你是一個獨立開發者或是想要快速將遊戲推向市場的團隊，Unity 可能會更適合你。（這也是為什麼 Unity 收費事件會被炎上，新的收費方案將會扼殺許多獨立遊戲工作室，我最期待的 Silksong 可能要再多等五年，好險後來 CEO 下台了（X</p></li><li><p><strong>龐大的開發者社群</strong><br>當你在用 Unity 的時候遇到問題，唯一需要做的就是去 Google 一下。不管是 Bug 訊息還是你想做的事情，幾乎都能找到別人分享的程式碼或影片教學。而且，Unity 的<a href="https://docs.unity3d.com/Manual/index.html">官方文件</a>也極其有好，裡面涵蓋了各種用法的詳細使用說明。相比之下，我個人覺得 Unreal Engine 的教學文件就…好像沒什麼用，常常看了還是搞不清楚在說啥，這也是被人詬病的地方。</p></li></ol><p>其他還有像是豐富的資源庫、跨平台性等優勢，這裡就先不贅述了。</p><h2 id="下載-Unity"><a href="#下載-Unity" class="headerlink" title="下載 Unity"></a>下載 Unity</h2><p>在使用 Unity 之前，我們會需要去下載 <a href="https://unity.com/download">Unity Hub</a>。</p><h3 id="Unity-Hub"><a href="#Unity-Hub" class="headerlink" title="Unity Hub"></a>Unity Hub</h3><p>Unity Hub 是 Unity 的一個管理工具，能夠讓你輕鬆管理和更新 Unity 的各種版本，也能夠在需要時隨時切換。</p><p><img src="/notes/./images/unity-tutorial/UnityDownload.png" alt="Unity Download"></p><h3 id="Unity-Editor"><a href="#Unity-Editor" class="headerlink" title="Unity Editor"></a>Unity Editor</h3><p>Unity Editor 版本就相當於你的 Unity 版本，不同版本之間使用上會有差異，不同 Package 能夠支援的版本也不一樣，所以在建立專案前，我們會需要決定這個專案要使用的 Unity 版本是什麼。</p><p>下載好 Unity Hub 後，我們可以看到這個畫面，下面的那兩個專案是我之前建立的</p><p><img src="/notes/./images/unity-tutorial/UnityHub.png" alt="Unity Hub"></p><p>這邊點選左邊的<strong>安裝</strong>，下面的那兩個 Unity Editor 版本也是我之前下載的</p><p><img src="/notes/./images/unity-tutorial/UnityHub2.png" alt="Unity Hub"></p><p>在這邊可以新增你想要的 Unity Editor 版本，也可以管理你已經擁有的版本</p><h3 id="管理授權"><a href="#管理授權" class="headerlink" title="管理授權"></a>管理授權</h3><p>在新增專案之前，可以看到上面會跟你說 <em><code>沒有可用授權 要建立並開啟專案，您需要有一個有效的授權</code></em></p><p><img src="/notes/./images/unity-tutorial/UnityHub3.png" alt="Unity Hub"></p><p>這時候可以點選右上角的<strong>管理授權</strong></p><p><img src="/notes/./images/unity-tutorial/UnityHub4.png" alt="Unity Hub"></p><p>然後點選<strong>新增授權</strong></p><p><img src="/notes/./images/unity-tutorial/UnityHub5.png" alt="Unity Hub"></p><p>這邊選擇<strong>取得免費的個人版授權</strong>就好</p><p><img src="/notes/./images/unity-tutorial/UnityHub6.png" alt="Unity Hub"></p><p>重開後會發現現在已經有授權了～不過這授權是有時效的，過期後再做一遍剛剛做的事就好，現在就可以開始建立專案了。</p><h2 id="建立專案"><a href="#建立專案" class="headerlink" title="建立專案"></a>建立專案</h2><p>授權好後，現在我們來建立一個自己的專案</p><p><img src="/notes/./images/unity-tutorial/UnityHub7.png" alt="Unity Hub"></p><p>這邊點選右上角的 <strong>新專案</strong></p><p><img src="/notes/./images/unity-tutorial/UnityHub8.png" alt="Unity Hub"></p><p>可以看到一個專案也有各種不同的範本，像是 2D、3D、2D Mobile、3D Mobile…，這邊我們先選擇 3D (Built-in)，最上方可以選擇 Unity 的版本，右邊可以命名專案的名稱和專案存放的位置</p><p><img src="/notes/./images/unity-tutorial/UnityHub9.png" alt="Unity Hub"></p><p>建立好後，能夠看到這個預設畫面，現在就可以開始製作自己的遊戲了～</p><p><img src="/notes/./images/unity-tutorial/UnityEditor.png" alt="Unity Editor"></p><hr><p>到目前為止，你應該大致理解 Unity 有哪些好處，還有 Unity 下載的流程是什麼。</p><p>下一篇教學會介紹如何在 3D 場景中執行一些操作，下次再見～<a href="https://933yee.github.io/notes/2024/04/10/unity-tutorial-2/">Unity 新手教學 - 介面介紹和基本操作</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Unity</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Compiler 筆記 (3)</title>
    <link href="/notes/2024/03/27/compiler-3/"/>
    <url>/notes/2024/03/27/compiler-3/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考 清華大學 李政崑老師 編譯器設計講義</p></blockquote><p><img src="/notes/./images/compiler-3/Relation.png" alt="Relations"></p><h2 id="Regular-Expression"><a href="#Regular-Expression" class="headerlink" title="Regular Expression"></a>Regular Expression</h2><ul><li>A Language is a set of strings that can be formed from the given alphabet</li><li>Grammar defines a Language</li></ul><h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h3><ul><li>a | b denotes {a, b}</li><li>(a | b)(a | b) denotes {ab, aa, ba, bb}</li><li>a* &#x3D; {$\epsilon$, a, aa, aaa, …}</li><li>a$^+$ &#x3D; {a, aa, aaa, …}</li><li>(a | b) &#x3D; {a, b}</li><li>a | a* b &#x3D; {a, b, ab, aab, aaab, …}</li></ul><h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h3><h4 id="11-0-00-1"><a href="#11-0-00-1" class="headerlink" title="(11 + 0)_ (00 + 1)_"></a>(11 + 0)_ (00 + 1)_</h4><p>不能奇數個 1 出現在奇數個 0 前面，像是 01010 就不可能</p><h3 id="Example-3"><a href="#Example-3" class="headerlink" title="Example 3"></a>Example 3</h3><h4 id="1-01-001-epsilon-0-00"><a href="#1-01-001-epsilon-0-00" class="headerlink" title="(1 + 01 + 001)_ ($\epsilon$ + 0 + 00)_"></a>(1 + 01 + 001)_ ($\epsilon$ + 0 + 00)_</h4><p>不能連續三個 0，像是 000</p><h3 id="Example-4"><a href="#Example-4" class="headerlink" title="Example 4"></a>Example 4</h3><h4 id="D-D-D-D"><a href="#D-D-D-D" class="headerlink" title="(D*.D | D.D*)"></a>(D*.D | D.D*)</h4><p>D &#x3D; [0 ~ 9]<br>0.5, .5, 123.6, 9.2, 9.237, 9.</p><h2 id="Finite-State-Automata-FSA"><a href="#Finite-State-Automata-FSA" class="headerlink" title="Finite State Automata (FSA)"></a>Finite State Automata (FSA)</h2><ul><li>FSA is a 5-tuple (Q, $\Sigma$, $\delta$, $q_0$, F)</li><li>Q is a set of states</li><li>$\Sigma$ is an input alphabet, symbol</li><li>$\delta$ is a transition function</li><li>$q_0$ is the initial state</li><li>F is a set of final states</li></ul><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><h4 id="Vending-Machine"><a href="#Vending-Machine" class="headerlink" title="Vending Machine"></a>Vending Machine</h4><p><img src="/notes/./images/compiler-3/VendingMachine.png" alt="Vending Machine"></p><ul><li>M &#x3D; (Q, $\Sigma$, $\delta$, $q_{0}$, F)</li><li>Q &#x3D; {$q_{0}, q_{5}, q_{10}, q_{15}, q_{20}$}</li><li>$\Sigma$ &#x3D; {5, 10}</li><li>F &#x3D; {$q_{20}$}</li><li>$\delta$($q_{0}$, 5) &#x3D; $q_{5}$, $\delta$($q_{5}$, 5) &#x3D; $q_{10}$</li><li>$\delta$($q_{10}$, 5) &#x3D; $q_{15}$, $\delta$($q_{15}$, 5) &#x3D; $q_{20}$</li><li>$\delta$($q_{0}$, 10) &#x3D; $q_{10}$, $\delta$($q_{10}$, 10) &#x3D; $q_{20}$</li></ul><h3 id="NFA-non-deterministic-Finite-State-Automata"><a href="#NFA-non-deterministic-Finite-State-Automata" class="headerlink" title="NFA (non-deterministic Finite State Automata)"></a>NFA (non-deterministic Finite State Automata)</h3><ul><li>可能有多個 Next State</li><li>NFA with empty string move ($\epsilon$)<ul><li>$\epsilon$ 允許到新狀態的變換不消耗任何輸入符號。例如，如果它處於狀態 1，下一個輸入符號是 a，它可以移動到狀態 2 而不消耗任何輸入符號，因此就有了歧義：在消耗字母 a 之前系統是處於狀態 1 還是狀態 2 呢 ? 由於這種歧義性，可以更加方便的談論系統可以處在的可能狀態的集合。因此在消耗字母 a 之前，NFA-ε 可以處於集合 {1,2} 內的狀態中的任何一個。等價的說，你可以想像這個 NFA 同時處於狀態 1 和狀態 2: 這給出了對冪集構造的非正式提示：等價於這個 NFA 的 DFA 被定義為此時處於狀態 q&#x3D;{1,2} 中<ul><li><a href="https://zh.wikipedia.org/zh-tw/%E9%9D%9E%E7%A1%AE%E5%AE%9A%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E8%87%AA%E5%8A%A8%E6%9C%BA">非確定有限狀態自動機</a></li></ul></li></ul></li><li>NFA without empty string move</li></ul><h3 id="DFA-Deterministic-Finite-State-Automata"><a href="#DFA-Deterministic-Finite-State-Automata" class="headerlink" title="DFA (Deterministic Finite State Automata)"></a>DFA (Deterministic Finite State Automata)</h3><ul><li>只有一個 Next State</li></ul><p><img src="https://www.researchgate.net/publication/2659477/figure/fig1/AS:647496795713537@1531386674269/NFA-and-DFA-for-Pattern-Matching-of-any-counterexample-Angluin-and-Kharitonov-1991.png" alt="NFA vs DFA"></p><h4 id="Example-of-NFA"><a href="#Example-of-NFA" class="headerlink" title="Example of NFA"></a>Example of NFA</h4><p><img src="https://i.stack.imgur.com/hXhcF.png" alt="Example of NFA"></p><h4 id="epsilon-and-phi"><a href="#epsilon-and-phi" class="headerlink" title="$\epsilon$ and $\phi$"></a>$\epsilon$ and $\phi$</h4><ul><li>$\epsilon$ is a 0 length string</li><li>$\phi$ is a null, i.e. no string.</li></ul><h5 id="r-epsilon"><a href="#r-epsilon" class="headerlink" title="r &#x3D; $\epsilon$"></a>r &#x3D; $\epsilon$</h5><ul><li>You can insert any number of epsilons between two alphabets of input string</li><li>Ex: <code>aeeeeeeeeeb</code>, it won’t make any difference</li><li>If we want to denote a null move, I.e.. one state going to other state without any input symbol, then epsilon is used<ul><li><a href="https://www.quora.com/What-is-the-difference-between-epsilon-and-phi-in-Automata">What is the difference between epsilon and phi in Automata?</a></li></ul></li></ul><p><img src="/notes/./images/compiler-3/epsilon.png" alt="epsilon"></p><h5 id="r-phi"><a href="#r-phi" class="headerlink" title="r &#x3D; $\phi$"></a>r &#x3D; $\phi$</h5><ul><li>Denotes empty i.e. no input string exists.</li></ul><p><img src="/notes/./images/compiler-3/phi.png" alt="phi"></p><h3 id="Conversion-of-NFA-without-epsilon-transition-to-DFA"><a href="#Conversion-of-NFA-without-epsilon-transition-to-DFA" class="headerlink" title="Conversion of NFA without $\epsilon$-transition to DFA"></a>Conversion of NFA without $\epsilon$-transition to DFA</h3><ul><li><p>Every DFA is an NFA, but not vice versa</p></li><li><p>There is an equivalent DFA for every NFA</p></li><li><p>M &#x3D; (Q, $\Sigma$, $\delta$, $q_0$, F)</p></li><li><p>M’ &#x3D; (Q’, $\Sigma$, $\delta$’, $q_0’$, F’)</p><ul><li>Q’ &#x3D; $2^Q$</li><li>The state of M’ are all the <strong>subset</strong> of the set of states of M</li><li>F’ is the set of all states in Q’ constructing a <strong>final states of M</strong></li><li>$\delta$’([$q_1$, $q_2$, …, $q_i$], a) &#x3D; [$p_1$, $p_2$, …, $p_j$] iff $\delta$({$q_1$, $q_2$, …, $q_i$}, a) &#x3D; {$p_1$, $p_2$, …, $p_j$}</li><li>Note: $2^Q$ is <strong>Power Set</strong>, meaning that the set of all subsets of Q<ul><li>Q &#x3D; {a, b, c}</li><li>$2^Q$ &#x3D; {$\phi$, {a}, {b}, {c}, {a, b}, {b, c}, {a, c}, {a, b, c}}</li></ul></li></ul></li><li><p><a href="https://www.youtube.com/watch?v=i-fk9o46oVY">Conversion of NFA to DFA (Example 2)</a></p></li></ul><h3 id="Convert-NFA-with-epsilon-transition-to-NFA-without-epsilon-transition"><a href="#Convert-NFA-with-epsilon-transition-to-NFA-without-epsilon-transition" class="headerlink" title="Convert NFA with $\epsilon$-transition to NFA without $\epsilon$-transition"></a>Convert NFA with $\epsilon$-transition to NFA without $\epsilon$-transition</h3><ul><li>$\delta$’(q, a) &#x3D; $\epsilon$-closure($\delta$($\epsilon$-closure (q), a))</li></ul><h4 id="epsilon-closure"><a href="#epsilon-closure" class="headerlink" title="$\epsilon$-closure"></a>$\epsilon$-closure</h4><ul><li>The set of states that can be reachable by making $\epsilon$-transitions from a given set of start states is called a $\epsilon$-closure</li></ul><h5 id="Epsilon-closure-Example"><a href="#Epsilon-closure-Example" class="headerlink" title="Epsilon-closure Example"></a>Epsilon-closure Example</h5><ul><li>$\epsilon$-closure($q_0$) &#x3D; {$q_0, q_1, q_2, q_4, q_7$}</li><li>$\epsilon$-closure($q_1$) &#x3D; {$q_1, q_2, q_4$}</li><li>$\epsilon$-closure($q_2$) &#x3D; {$q_2$}</li><li>$\epsilon$-closure($q_3$) &#x3D; {$q_1, q_2, q_3, q_4, q_6, q_7$}</li><li>$\epsilon$-closure($q_4$) &#x3D; {$q_4$}</li><li>$\epsilon$-closure($q_5$) &#x3D; {$q_1, q_2, q_3, q_4, q_5, q_6, q_7$}</li><li>$\epsilon$-closure($q_6$) &#x3D; {$q_1, q_2, q_4, q_6, q_7$}</li><li>$\epsilon$-closure($q_7$) &#x3D; {$q_7$}</li><li>$\epsilon$-closure($q_8$) &#x3D; {$q_8$}</li><li>$\epsilon$-closure($q_9$) &#x3D; {$q_9$}</li><li>$\epsilon$-closure($q_10$) &#x3D; {$q_10$}</li></ul><p><img src="/notes/./images/compiler-3/EpsilonClosureExample.png" alt="Epsilon-Closure Example"></p><h4 id="Conversion-Example"><a href="#Conversion-Example" class="headerlink" title="Conversion Example"></a>Conversion Example</h4><p><img src="/notes/./images/compiler-3/Epsilon-closureConversion.png" alt="Epsilon-closure Conversion"></p><ul><li>$\epsilon$-closure($q_0$) &#x3D; {$q_0, q_1, q_2$}</li><li>$\delta$($q_0$, 0) &#x3D; $\epsilon$-closure($\delta$($\epsilon$-closure($q_0$), 0))</li></ul><p>$$<br>  \begin{align}<br>    \epsilon\text{-closure}(q_0) &amp;&#x3D; {q_0, q_1, q_2} \newline<br>    \delta(q_0, 0) &amp;&#x3D; \epsilon\text{-closure}(\delta(\epsilon\text{-closure}(q_0), 0)) \newline<br>    &amp;&#x3D; \epsilon\text{-closure}(\delta({q_0, q_1, q_2}, 0)) \newline<br>    &amp;&#x3D; \epsilon\text{-closure}({q_0}) \newline<br>    &amp;&#x3D; {q_0, q_1, q_2}<br>  \end{align}<br>$$</p><ul><li>對每個 State 都做一次上面的操作</li></ul><p><img src="/notes/./images/compiler-3/Epsilon-closureConversion2.png" alt="Epsilon-closure Conversion"></p><h3 id="Minimizing-the-number-of-states-of-a-DFA"><a href="#Minimizing-the-number-of-states-of-a-DFA" class="headerlink" title="Minimizing the number of states of a DFA"></a>Minimizing the number of states of a DFA</h3><ul><li>一開始把 Final states 和不是 Final states 的 state 分成兩組<ul><li>ex: {A, B, C}, {D, E}</li></ul></li><li>每次比較同組的兩個 state，比較所有 inpts 的 next state 是否在同組，不同的話就分開<ul><li>ex: A 輸入 a 變成 C (C 在第一組)、B 輸入 a 變成 D (D 在第二組)，C 和 D 在上一次操作中位於不同組別，所以要把 A、B 分成不同組，變成 {A, C}, {B}, {D, E}</li><li>接著就持續比 AC、DE</li></ul></li><li>持續執行上述操作，直到沒有改變</li></ul><p><a href="https://www.youtube.com/watch?v=0XaGAkY09Wc">Minimization of DFA (Example 1)</a></p><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>Relation</p><ul><li><p>Reflexive<br>if (a, b) &#x2F;belongs R for every a &#x2F;belongs A<br>aRa</p></li><li><p>Symmetry<br>aRb &#x3D; bRa</p></li><li><p>transitinity<br>aRb, bRc -&gt; aRc</p></li></ul><p>Back tracking is not that powerful<br>Parsar with no back tracking<br>(frist set, follow set, selection set)</p><p><a href="https://www.google.com/url?sa=i&url=https://www.geeksforgeeks.org/ambiguous-grammar/&psig=AOvVaw16puthtwLbOpQ45_NJxyBy&ust=1711547242637000&source=images&cd=vfe&opi=89978449&ved=0CBIQjRxqFwoTCKCr_LyIkoUDFQAAAAAdAAAAABAE">Ambiguous Grammar</a></p><h3 id="會考的"><a href="#會考的" class="headerlink" title="會考的"></a>會考的</h3><ul><li>bindings</li><li>First class object<ul><li>可以 assign 到 variable</li><li>AMP</li><li>lambda</li></ul></li><li>call-by-reference, call-by-name, call-by-text, call-by-need (lazy binding)</li></ul><h3 id="Finite-State-Machine-vs-Push-Down-Automata"><a href="#Finite-State-Machine-vs-Push-Down-Automata" class="headerlink" title="Finite State Machine vs Push Down Automata"></a>Finite State Machine vs Push Down Automata</h3><h4 id="FSM"><a href="#FSM" class="headerlink" title="FSM"></a>FSM</h4><ul><li>$M &#x3D; (Q, \Sigma, \delta, g_0, F)$</li><li>$\delta(q_0, a) &#x3D; q_2$</li></ul><h4 id="PDA"><a href="#PDA" class="headerlink" title="PDA"></a>PDA</h4><ul><li>$M &#x3D; (Q, \Sigma, \Gamma, \delta, q_0, Z_0, F)$<ul><li>$Z_0$: initial</li><li>$\Gamma$: all the state of symbols</li></ul></li><li>$\delta(q_0, Z_a, a) &#x3D; q_1$, (push, pop, e)</li></ul><h5 id="Example-2-1"><a href="#Example-2-1" class="headerlink" title="Example 2"></a>Example 2</h5><p>丟進 stack<br>b<br>b<br>b<br>a<br>a<br>a</p><p>丟進 c 消光 b<br>丟進 d 消光 a</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4>]]></content>
    
    
    
    <tags>
      
      <tag>Compilier</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Compiler 筆記 (2)</title>
    <link href="/notes/2024/03/26/compiler-2/"/>
    <url>/notes/2024/03/26/compiler-2/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考 清華大學 李政崑老師 編譯器設計講義</p></blockquote><h2 id="Terminlogy"><a href="#Terminlogy" class="headerlink" title="Terminlogy"></a>Terminlogy</h2><ul><li>Gramma<ul><li>$X \in G $ iff $ G \rightarrow X$</li></ul></li><li>Language<ul><li>$L(G) &#x3D; $ { $X | X \in G$ }</li></ul></li><li>Alphabet<ul><li>$\Sigma$ &#x3D; {0, 1}</li><li>$L$ over $\Sigma$</li></ul></li></ul><h2 id="Context-Free-Grammar-CFG"><a href="#Context-Free-Grammar-CFG" class="headerlink" title="Context-Free Grammar (CFG)"></a>Context-Free Grammar (CFG)</h2><h4 id="Grammar-G-V-T-P-S"><a href="#Grammar-G-V-T-P-S" class="headerlink" title="Grammar G &#x3D; (V, T, P, S)"></a>Grammar G &#x3D; (V, T, P, S)</h4><ul><li><strong>V</strong>: A set of non-terminals (variables)</li><li><strong>T</strong>: A set of terminals</li><li><strong>P</strong>: A set of production rules</li><li><strong>S</strong>: Starting symbol</li></ul><h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1:"></a>Example 1:</h4><p>Write a grammar to represent L &#x3D; { $a^{n}b^{n}$ | $n\ge0$}</p><ul><li>G &#x3D; (V, T, P, S)</li><li>V &#x3D; {S}</li><li>T &#x3D; {a, b}</li><li>P &#x3D; {S $\rightarrow$ aSb | $\epsilon$}</li></ul><h4 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h4><p>Write a grammar representing a balanced expression with ‘(‘ and ‘)’</p><ul><li>G &#x3D; (V, T, P, S)</li><li>V &#x3D; {S}</li><li>T &#x3D; {(, )}</li><li>P &#x3D; {S $\rightarrow$ (S) | SS | $\epsilon$}</li></ul><h4 id="Example-3"><a href="#Example-3" class="headerlink" title="Example 3"></a>Example 3</h4><p>Write a grammar for palindrome, L &#x3D; { $W W^{T}$ | $W \in (a, b)^{*}$ }</p><ul><li>G &#x3D; (V, T, P, S)</li><li>V &#x3D; {S}</li><li>T &#x3D; {a, b}</li><li>P &#x3D; {S $\rightarrow$ aSa | bSb | a | b | $\epsilon$}</li></ul><h4 id="Example-4"><a href="#Example-4" class="headerlink" title="Example 4"></a>Example 4</h4><p>L &#x3D; { $WcW^T$ | $W \in (a, b)^{*}$}</p><ul><li>G &#x3D; (V, T, P, S)</li><li>V &#x3D; {S}</li><li>T &#x3D; {a, b, c}</li><li>P &#x3D; {S $\rightarrow$ aSa | bSb | c}</li></ul><h4 id="Example-5"><a href="#Example-5" class="headerlink" title="Example 5"></a>Example 5</h4><p>Write a grammar representing an expression with equal number of a, b</p><ul><li>G &#x3D; (V, T, P, S)</li><li>V &#x3D; {S}</li><li>T &#x3D; {a, b}</li><li>P &#x3D; {S $\rightarrow$ aSb | bSa | SS | $\epsilon$}</li></ul><h3 id="Ambiguous-Grammar"><a href="#Ambiguous-Grammar" class="headerlink" title="Ambiguous Grammar"></a>Ambiguous Grammar</h3><ul><li>一個 sentence 可以由某文法推導出兩個或兩個以上的剖析樹 (parse tree)</li></ul><h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>$$<br>  \begin{align}<br>    E &amp;\rightarrow E + E \newline<br>    &amp;\rightarrow E * E \newline<br>    &amp;\rightarrow \text{ID} \newline<br>    &amp;\rightarrow \text{number} \newline<br>    &amp;\rightarrow (E)<br>  \end{align}<br>$$<br>  Target: 2 + 3 + 2</p><h3 id="Un-Ambiguous-Grammar"><a href="#Un-Ambiguous-Grammar" class="headerlink" title="Un-Ambiguous Grammar"></a>Un-Ambiguous Grammar</h3><h4 id="Example-1-1"><a href="#Example-1-1" class="headerlink" title="Example 1"></a>Example 1</h4><ul><li>乘法在 lower level，因為 priority 比加法高</li><li>加法和乘法都是 left associative<br>$$<br>\begin{align}<br>  E &amp;\rightarrow E + \text{term} \newline<br>  &amp;\rightarrow \text{term} \newline\newline<br>  \text{term} &amp;\rightarrow \text{term} * \text{factor} \newline<br>  &amp;\rightarrow \text{factor} \newline\newline<br>  \text{factor} &amp;\rightarrow \text{number} \newline<br>  &amp;\rightarrow (E)<br>\end{align}<br>$$</li></ul><h4 id="Example-2-1"><a href="#Example-2-1" class="headerlink" title="Example 2"></a>Example 2</h4><ul><li>exponent 在 lower level，因為 priority 比加法和乘法高</li><li>exponent 是 right associative<br>$$<br>\begin{align}<br>  E &amp;\rightarrow E + \text{term} \newline<br>  &amp;\rightarrow \text{term} \newline\newline<br>  \text{term} &amp;\rightarrow \text{term} * \text{expo} \newline<br>  &amp;\rightarrow \text{expo} \newline\newline<br>  \text{expo} &amp;\rightarrow \text{factor} ^ \text{expo} \newline<br>  &amp;\rightarrow \text{factor} \newline\newline<br>  \text{factor} &amp;\rightarrow \text{number} \newline<br>  &amp;\rightarrow (E)<br>\end{align}<br>$$</li></ul><h2 id="Recursion"><a href="#Recursion" class="headerlink" title="Recursion"></a>Recursion</h2><ul><li><strong>任何left recursion都可以用數學轉換成right recursion</strong></li><li>With right recursion, no reduction takes place until the entire list of elements has been read; with left recursion, a reduction takes place as each new list element is encountered. Left recursion can therefore save a lot of stack space.<ul><li><a href="https://www.ibm.com/docs/en/zvm/7.2?topic=topics-right-recursion-versus-left-recursion">Right Recursion versus Left Recursion</a></li></ul></li><li>With a left-recursive grammar, the top-down parser can expand the frontier indefinitely without generating a leading terminal symbol that the parser can either match or reject. To fix this problem, a compiler writer can convert the left-recursive grammar so that it uses only right-recursion.<ul><li><a href="https://www.sciencedirect.com/topics/computer-science/left-recursion">Left-Recursion</a></li></ul></li></ul><h3 id="Example-1-2"><a href="#Example-1-2" class="headerlink" title="Example 1"></a>Example 1</h3><h4 id="Left-Recursion"><a href="#Left-Recursion" class="headerlink" title="Left-Recursion"></a>Left-Recursion</h4><p>$$<br>  \begin{align}<br>    S &amp;\rightarrow S\alpha | \beta<br>  \end{align}<br>$$</p><h4 id="Right-Recursion"><a href="#Right-Recursion" class="headerlink" title="Right-Recursion"></a>Right-Recursion</h4><p>$$<br>  \begin{align}<br>    S &amp;\rightarrow \beta S’ \newline<br>    S’ &amp;\rightarrow \alpha S’ | \epsilon<br>  \end{align}<br>$$</p><h3 id="Example-2-2"><a href="#Example-2-2" class="headerlink" title="Example 2"></a>Example 2</h3><h4 id="Left-Recursion-1"><a href="#Left-Recursion-1" class="headerlink" title="Left-Recursion"></a>Left-Recursion</h4><p>$$<br>  \begin{align}<br>    E &amp;\rightarrow E + \text{term} \newline<br>    &amp;\rightarrow \text{term} \newline\newline<br>    \text{term} &amp;\rightarrow \text{term} * \text{factor} \newline<br>    &amp;\rightarrow \text{factor} \newline\newline<br>    \text{factor} &amp;\rightarrow \text{number} \newline<br>    &amp;\rightarrow (E)<br>  \end{align}<br>$$</p><h4 id="Right-Recursion-1"><a href="#Right-Recursion-1" class="headerlink" title="Right-Recursion"></a>Right-Recursion</h4><p>$$<br>  \begin{align}<br>    E &amp;\rightarrow TE’ \newline<br>    E’ &amp;\rightarrow +TE’ | \epsilon \newline<br>    T &amp;\rightarrow FT’ \newline<br>    T’ &amp;\rightarrow *FT’ | \epsilon \newline<br>    F &amp;\rightarrow (E) | id<br>  \end{align}<br>$$</p><h3 id="Example-3-1"><a href="#Example-3-1" class="headerlink" title="Example 3"></a>Example 3</h3><h4 id="Left-Recursion-2"><a href="#Left-Recursion-2" class="headerlink" title="Left-Recursion"></a>Left-Recursion</h4><p>$$<br>  \begin{align}<br>    E &amp;\rightarrow E + T \newline<br>    &amp;\rightarrow T \newline<br>    T &amp;\rightarrow T * P \newline<br>    &amp;\rightarrow P \newline<br>    P &amp;\rightarrow F ^ P\newline<br>    &amp;\rightarrow F \newline<br>    F &amp;\rightarrow id \newline<br>    &amp;\rightarrow (E)<br>  \end{align}<br>$$</p><h4 id="Right-Recursion-2"><a href="#Right-Recursion-2" class="headerlink" title="Right-Recursion"></a>Right-Recursion</h4><p>$$<br>  \begin{align}<br>    E &amp;\rightarrow TE’ \newline<br>    E’ &amp;\rightarrow +TE’ | \epsilon \newline<br>    T &amp;\rightarrow PT’ \newline<br>    T’ &amp;\rightarrow *PT’ | \epsilon \newline<br>    P &amp;\rightarrow F ^ P \newline<br>    &amp;\rightarrow F \newline<br>    F &amp;\rightarrow (E) | id<br>  \end{align}<br>$$</p><p><a href="https://www.youtube.com/watch?v=IO5ie7GbJGI">Problem of Left Recursion and Solution in CFGs</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Compilier</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hardware Security</title>
    <link href="/notes/2024/03/15/hardware-security/"/>
    <url>/notes/2024/03/15/hardware-security/</url>
    
    <content type="html"><![CDATA[<h2 id="Reliable-IC-Design-and-Fabrication-withGlobal-Electronics-Supply-Chain"><a href="#Reliable-IC-Design-and-Fabrication-withGlobal-Electronics-Supply-Chain" class="headerlink" title="Reliable IC Design and Fabrication withGlobal Electronics Supply Chain"></a>Reliable IC Design and Fabrication withGlobal Electronics Supply Chain</h2><ul><li><p><strong>Hardware security issues</strong> arise from</p><ul><li>硬體內部的漏洞，不管是 Gate Layer、Transistor Layer 或是 Voltage 和 Current</li><li>缺乏內建的安全機制來保護軟體與系統</li></ul><p>用旁路攻擊或軟體利用硬體漏洞進行攻擊，導致密碼學被破解、記憶體可以任意 Access、竊取物理資訊等</p></li><li><p><strong>Hardware Trust Issues</strong> arise from</p><ul><li>硬體開發過程涉及不可信任的第三方（IP 供應商、EDA 工具、製造商、測試或銷售商）</li></ul><p>在 IC Design Flow 中，IC Design、Fab、Test、Assembly、Package &amp; Testing、PCB &amp; Synthesis 都有風險，導致被 DoS 之類的問題，還可能減少 Performance、增加功耗</p></li></ul><p>兩個差別在：前者是 <strong>硬體本身的漏洞導致被攻擊</strong>，後者是 <strong>硬體開發與生產過程中不受信任的實體</strong></p><h4 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h4><p><strong>IP</strong> 是一個 Predeifined、Designed、Verified、Resuable 的 Building Block，可以直接放在 SoC 裡面<br>可能是一段 Verilog Code、做好的 Gate Level Netlist 或是做好的 Layout</p><ul><li><strong>Soft IP</strong> 後續可以做調整</li><li><strong>Hard IP</strong> 一個黑盒子，不可以做調整</li></ul><p>根據層級小到大可以分成</p><ul><li>Foundation IP：基本的元件，像是 Cell Library、Gate Array</li><li>Standard IP：有特定的功能，像是 JPEG、USB、PCI</li><li>Star IP：複雜的元件，可以做很多功能，像是 ARM、MIPS</li></ul><p>但是因為 IP 來自各種不同的地方，要考慮到 IP 的可信度</p><h3 id="Hardware-Threats-on-IC-Supply-Chain"><a href="#Hardware-Threats-on-IC-Supply-Chain" class="headerlink" title="Hardware Threats on IC Supply Chain"></a>Hardware Threats on IC Supply Chain</h3><ul><li><p>Piracy: 剽竊裡面的設計</p></li><li><p>IP Overuse: 使用超過授權的次數</p></li><li><p>Reverse Engineering: 逆向工程，找出裡面的設計</p></li><li><p>Malicious Modification: Trojan</p></li><li><p>Trojan</p><ul><li>不能太常發生，不然 verification 會發現 (functional test)</li><li>payload 不能太大，不然會被發現</li><li>payload 也有分 combinational 和 sequential，sequential 可以延遲幾個 cycle 再發動攻擊</li></ul></li></ul><p><img src="/notes/./images/hardware-security/untrusted-entities.png" alt="Untrusted Entities"></p><ul><li>Side Channel Attack: 透過量測 Voltage、Thermal 來猜測裡面的資訊</li><li>Scan Based Attack: 透過 Scan Chain 來改變裡面的資訊<ul><li>Scan Chain: 在 Design for Testability 中，每個 FF 後面接一個 MUX，可以藉由控制 MUX 來監測 FF 的值。像如果某個 Combinational Circuit 是加密的計算，可以透過 Scan Chain 來看裡面的值</li></ul></li><li>IC Counterfeit: 我知道這個 IC 的功能在幹嘛，仿造一個一模一樣的 IC，但裡面參雜一些惡意的電路 (案例比較少</li><li>Watermarking: 在 IC 裡面放一些特定的電路 (個人訊息)，可以用來證明這個 IC 是我的設計</li><li>Hardware Obfuscation: 多花一些額外的 Cost，把電路設計變得很複雜，讓別人不容易看懂</li><li>Side Channel Resistant Design: 加入 Noise、Random Delay、Randomize Power Consumption，讓別人不容易透過 Side Channel Attack 來猜測裡面的資訊</li><li>Secure Scan Chain: 避免在 Operation Mode 的時候被使用 Scan Chain，只有在 Test Mode 的時候才能被使用</li></ul>]]></content>
    
    
    <categories>
      
      <category>hardware</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hardware</tag>
      
      <tag>security</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Compiler 筆記 (1)</title>
    <link href="/notes/2024/03/07/compiler-1/"/>
    <url>/notes/2024/03/07/compiler-1/</url>
    
    <content type="html"><![CDATA[<blockquote><p>參考 清華大學 李政崑老師 編譯器設計講義</p></blockquote><h2 id="compilers-and-Assemblers"><a href="#compilers-and-Assemblers" class="headerlink" title="compilers and Assemblers"></a>compilers and Assemblers</h2><p>High-level language program (C)<br>⇒ C compiler<br>⇒ Assembly language program (for MIPS)<br>⇒ Assembler<br>⇒ Binary machine language program (for MIPS)</p><h2 id="Analysis-Synthesis-Model"><a href="#Analysis-Synthesis-Model" class="headerlink" title="Analysis-Synthesis Model"></a>Analysis-Synthesis Model</h2><p>Compilation 可以分成兩個部分</p><ul><li>Analysis (front end)<ul><li>Breaks up the source program into constituent pieces</li><li>Creates an Intermediate Representation (IR)</li></ul></li><li>Synthesis (back end)<ul><li>Constructs the desired target program from the IR</li><li>(Optionally) performs optimizations</li></ul></li></ul><p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjy5NjmBdRfsrfg96b3KYpevQqRBAygBtuvsszgZpXmPhyy7M9VH81zkvqd-uhdJBBtWL_u0_iaHC8nhSWK1gW7_0DNHxSofoPpj5CD76mp5wCRN7fSz5cDkzZmns_HZ12pRbBD37q9jYY/s1600/aandSmodel.bmp" alt="Analysis-Synthesis Model"></p><h2 id="Phase-of-a-Compiler"><a href="#Phase-of-a-Compiler" class="headerlink" title="Phase of a Compiler"></a>Phase of a Compiler</h2><p><img src="https://cdn1.byjus.com/wp-content/uploads/2022/03/phase-of-compiler.png" alt="Phase of a compiler"></p><h3 id="Symbol-Table-Management"><a href="#Symbol-Table-Management" class="headerlink" title="Symbol-Table Management"></a>Symbol-Table Management</h3><ul><li>Essential function of a compiler<ul><li>To <strong>record the identifier</strong> used in the source program and collect information about various attributes of each identifier<ul><li>allocate storage, type, scope, etc</li></ul></li></ul></li><li>Symbol Table<ul><li>A data structure containing a record for each identifiers, with fields for the attributes</li><li>When a identifier is detected by the <strong>lexical analysis(詞法分析)</strong> , it is entered into the symbol table</li><li>The attributes are determined during <strong>syntax analysis(語法分析)</strong> and <strong>semanic analysis(語義分析)</strong></li></ul></li></ul><h3 id="Analysis-Phases"><a href="#Analysis-Phases" class="headerlink" title="Analysis Phases"></a>Analysis Phases</h3><ul><li>Lexical Analysis</li><li>Syntax Analysis</li><li>Semantic Analysis</li></ul><p><img src="/notes/./images/compiler-1/AnalysisPhasesExample.png" alt="Analysis Phases Example"></p><h3 id="Intermediate-Code-Generation"><a href="#Intermediate-Code-Generation" class="headerlink" title="Intermediate Code Generation"></a>Intermediate Code Generation</h3><ul><li>Two properties<ul><li>Easy to produce</li><li>Easy to translate into the target program</li></ul></li><li>Examples<ul><li>Graph representations</li><li>Postfix notation</li><li>Three-address code<ul><li>每條指令最多有三個 operands</li></ul></li></ul></li></ul><p><img src="/notes/./images/compiler-1/IntermediateCodeGenerationExample.png" alt="Intermediate Code Generation Example"></p><h3 id="Code-Optimization"><a href="#Code-Optimization" class="headerlink" title="Code Optimization"></a>Code Optimization</h3><ul><li>Attempts to improve the intermediate code<ul><li>So the faster-running machine code will result</li></ul></li></ul><p><img src="/notes/./images/compiler-1/CodeOptimizationExample.png" alt="Code Optimization Example"></p><h3 id="Code-Generation"><a href="#Code-Generation" class="headerlink" title="Code Generation"></a>Code Generation</h3><ul><li>Generates target code<ul><li>Consisting of reocatable machine code or assembly code</li></ul></li></ul><p><img src="/notes/./images/compiler-1/CodeGenerationExample.png" alt="Code Generation Example"></p><h3 id="Counsins-of-the-compiler"><a href="#Counsins-of-the-compiler" class="headerlink" title="Counsins of the compiler"></a>Counsins of the compiler</h3><ul><li>Preprocessors<ul><li>Produce input to compilers</li><li>Macro processing</li><li>File inclusion</li></ul></li><li>Assemblers</li><li>Loaders and Link-Editors</li></ul><h2 id="Evolution-of-Programming-Languages"><a href="#Evolution-of-Programming-Languages" class="headerlink" title="Evolution of Programming Languages"></a>Evolution of Programming Languages</h2><h3 id="Imperative-language"><a href="#Imperative-language" class="headerlink" title="Imperative language"></a>Imperative language</h3><ul><li>命令式語言</li><li>指定程式該執行的確切操作</li><li>Ex: C, C++, Java, Python</li></ul><h3 id="Declarative-language"><a href="#Declarative-language" class="headerlink" title="Declarative language"></a>Declarative language</h3><ul><li>宣告式語言</li><li>只要所需的結果，而不是詳細指定要執行的步驟</li><li>Ex: SQL, HTML, CSS, Prolog</li></ul><h3 id="Von-Neumann-language"><a href="#Von-Neumann-language" class="headerlink" title="Von Neumann language"></a>Von Neumann language</h3><ul><li><p>基於 Von Neumann 電腦架構</p></li><li><p>Many widely used programming languages such as C, C++ and Java have <strong>ceased</strong> to be strictly von Neumann by adding support for parallel processing, in the form of threads.</p></li><li><p>Before C++ 11 added threads, C++ was strictly a Von Neumann language</p></li><li><p><a href="https://stackoverflow.com/questions/58312638/is-c-considered-a-von-neumann-programming-language">Is C++ considered a Von Neumann programming language?</a></p></li><li><p><a href="https://ictjournal.itri.org.tw/xcdoc/cont?xsmsid=0M236556470056558161&sid=0M250379986616668141">高效能需求應用興起記憶體內運算的新戰場</a></p></li></ul><h3 id="Object-oriented-language"><a href="#Object-oriented-language" class="headerlink" title="Object-oriented language"></a>Object-oriented language</h3><ul><li>繼承、封裝、多型</li><li>Ex: Java, C++</li></ul><h3 id="Functional-language"><a href="#Functional-language" class="headerlink" title="Functional language"></a>Functional language</h3><ul><li>在一般常見的命令式語言中，要執行操作的話是給電腦一組命令，而狀態會隨著命令的執行而改變。例如你指派變數 a 的值為 5，而隨後做了其它一些事情之後 a 就可能變成的其它值。有控制流程 (control flow)，你就可以重複執行操作</li><li>然而在純粹函數式程式語言中，你不是像命令式語言那樣命令電腦「要做什麼」，而是通過用函數來描述出問題「是什麼」，如「階乘是指從 1 到某個數的乘積」，「一個串列中數字的和」是指把第一個數字跟剩餘數字的和相加。你用宣告函數是什麼的形式來寫程式</li><li>另外，變數 (variable) 一旦被指定，就不可以更改了，你已經說了 a 就是 5，就不能再說 a 是別的什麼數</li><li>Ex: Haskell、Scala、Clojure</li></ul><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Haskell"><span class="hljs-title">add</span> x y = x + y<br><span class="hljs-title">result</span> = add <span class="hljs-number">5</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><ul><li><a href="https://learnyouahaskell.mno2.org/zh-tw/ch01/introduction">Haskell 趣學指南</a></li></ul><h3 id="Assignment-oriented-language"><a href="#Assignment-oriented-language" class="headerlink" title="Assignment-oriented language"></a>Assignment-oriented language</h3><ul><li>賦值操作來實現程式邏輯的語言</li><li>Ex: C, Java,</li><li>反例: Haskell</li></ul><h3 id="Third-generation-language"><a href="#Third-generation-language" class="headerlink" title="Third-generation language"></a>Third-generation language</h3><ul><li>相對於機器語言和組合語言而言的高階程式語言</li><li>Ex: C, Java, Python</li></ul><h3 id="Fourth-generation-language"><a href="#Fourth-generation-language" class="headerlink" title="Fourth-generation language"></a>Fourth-generation language</h3><ul><li>更高級、更抽象的程式語言，旨在簡化特定領域的應用程式開發</li><li>提供了更高程度的自動化和巨集</li><li>Ex: SQL, MATLAB</li></ul><h3 id="Scripting-language"><a href="#Scripting-language" class="headerlink" title="Scripting language"></a>Scripting language</h3><ul><li>一個指令碼通常是直譯執行而非編譯</li><li>Ex: JavaScript、Perl、PHP、Python、Ruby 和 Tcl，</li></ul><h3 id="補充"><a href="#補充" class="headerlink" title="補充"></a>補充</h3><p>如果是說 imperative programming 和 declarative programming，我查到的都是程式碼的寫法</p><ul><li>Imperative language<ul><li>命令式編程</li><li>著重在 <strong>HOW</strong>，具體表達程式碼該做什麼才能達到目標，程式一步一步按著順序照著你給他指示執行。</li><li>Imperative 比較常運用 Statement ，像是是 if, while, for, switch 等。</li><li>You tell the compiler what you want to happen, step by step.</li></ul></li><li>Delcarative language<ul><li>宣告式編程</li><li>著重在該做什麼 <strong>WHAT</strong> ，採取抽象化流程。Declarative 比較常運用表達式 expression，</li><li>Delcarative 特色是單純運算並一定會有返回值</li></ul></li></ul><p>Example: choose the odd numbers</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cs">List&lt;<span class="hljs-built_in">int</span>&gt; collection = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; &#123; <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> &#125;;<br></code></pre></td></tr></table></figure><p>With <strong>imperative programming</strong>, we’d step through this, and decide what we want:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cs">List&lt;<span class="hljs-built_in">int</span>&gt; results = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();<br><span class="hljs-keyword">foreach</span>(<span class="hljs-keyword">var</span> num <span class="hljs-keyword">in</span> collection)<br>&#123;<br>    <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>)<br>          results.Add(num);<br>&#125;<br></code></pre></td></tr></table></figure><p>With <strong>declarative programming</strong>, on the other hand, you declare your desired results, but not the step-by-step:</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cs"><span class="hljs-keyword">var</span> results = collection.Where( num =&gt; num % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>Source</p><ul><li><a href="https://ithelp.ithome.com.tw/articles/10233761">Buzz Word 1 : Declarative vs. Imperative</a></li><li><a href="https://stackoverflow.com/questions/1784664/what-is-the-difference-between-declarative-and-imperative-paradigm-in-programmin">What is the difference between declarative and imperative paradigm in programming?</a></li></ul><h2 id="Lambda-Parameters"><a href="#Lambda-Parameters" class="headerlink" title="Lambda Parameters"></a>Lambda Parameters</h2><p>C++ 中，Lambda 架構是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">[capture clause](parameters) -&gt; return_type &#123; body &#125;<br></code></pre></td></tr></table></figure><p><strong>[ ]</strong> 空的捕獲列表，表示不捕獲任何外部變數</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">[]() &#123; <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; &#125;<br></code></pre></td></tr></table></figure><p><strong>[&amp;]</strong> 按引用捕獲所有外部變數</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;<br>[&amp;]() &#123; x++; &#125; <span class="hljs-comment">// 修改外部變數 x</span><br></code></pre></td></tr></table></figure><p><strong>[&#x3D;]</strong> 按值捕獲所有外部變數</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;<br>[=]() &#123; <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>; &#125; <span class="hljs-comment">// 訪問但不修改外部變數 x</span><br></code></pre></td></tr></table></figure><p><strong>[&#x3D;, &amp;foo]</strong> 按值捕獲所有外部變數，但特別引用了 foo 變數</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;<br><span class="hljs-type">int</span> foo = <span class="hljs-number">20</span>;<br>[=, &amp;foo]() &#123; <span class="hljs-keyword">return</span> x + foo; &#125; <span class="hljs-comment">// 訪問 x 按值，訪問 foo 按引用</span><br></code></pre></td></tr></table></figure><p><strong>[bar]</strong> 按值捕獲 bar 變數</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> bar = <span class="hljs-number">30</span>;<br>[bar]() &#123; <span class="hljs-keyword">return</span> bar * <span class="hljs-number">3</span>; &#125;<br></code></pre></td></tr></table></figure><p><strong>[this]</strong> 按值捕獲當前物件的指標（常用於 lambda 在 class 內部的情況）</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">MyClass</span>(<span class="hljs-type">int</span> value) : <span class="hljs-built_in">value</span>(value) &#123;&#125;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printValue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// Lambda 捕獲當前物件的指標，可以使用內部的變數和函式</span><br>        <span class="hljs-keyword">auto</span> lambda = [<span class="hljs-keyword">this</span>]() &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;Value inside lambda: &quot;</span> &lt;&lt; value &lt;&lt; std::endl; <span class="hljs-comment">// 訪問物件變數</span><br>            <span class="hljs-built_in">someMethod</span>(); <span class="hljs-comment">// 呼叫物件函式</span><br>        &#125;;<br><br>        <span class="hljs-built_in">lambda</span>();<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> value;<br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">someMethod</span><span class="hljs-params">()</span> </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;Inside someMethod&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="First-Class-Object"><a href="#First-Class-Object" class="headerlink" title="First Class Object"></a>First Class Object</h2><ul><li>Entity can be stored into a variable</li><li>Something can be passed around as parameters</li><li>In C language, structure and function are consider first class objects</li></ul><h2 id="Bindings"><a href="#Bindings" class="headerlink" title="Bindings"></a>Bindings</h2><h3 id="Static-Binding"><a href="#Static-Binding" class="headerlink" title="Static Binding"></a>Static Binding</h3><ul><li>在編譯時期或者早期階段就確定呼叫哪個方法或函式</li><li>Ex: C 的函式呼叫，它在編譯時期就將函式內容綁定到識別符上，而無法在執行時期變更。</li></ul><h3 id="Dynamic-Binding"><a href="#Dynamic-Binding" class="headerlink" title="Dynamic Binding"></a>Dynamic Binding</h3><ul><li>綁定發生在 runtime，而不是在編譯時</li><li>Ex: C++ 的虛擬方法呼叫，由於多型的機制，物件的型別無法在編譯時期得知，所以綁定會在執行時期處理。</li></ul><h3 id="Fluid-Binding"><a href="#Fluid-Binding" class="headerlink" title="Fluid Binding"></a>Fluid Binding</h3><ul><li>AKA dynamic assignment</li><li>Assignments with dynamic extent to bindings that have lexical scope</li><li>Syntax<ul><li>var :&#x3D; expr during stmt-body</li></ul></li></ul><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs scheme">(<span class="hljs-name"><span class="hljs-built_in">define</span></span> x <span class="hljs-number">10</span>)  <span class="hljs-comment">; 定義變數 x，並賦值為 10</span><br><br>(<span class="hljs-name">displayln</span> <span class="hljs-string">&quot;在動態賦值之前：&quot;</span>)<br>(<span class="hljs-name">displayln</span> x)  <span class="hljs-comment">; 輸出當前變數 x 的值</span><br><br><span class="hljs-comment">; 在這個程式碼塊內，我們動態地改變變數 x 的值</span><br>(<span class="hljs-name"><span class="hljs-built_in">let</span></span> ((<span class="hljs-name">x</span> := <span class="hljs-number">20</span> during<br>       (<span class="hljs-name"><span class="hljs-built_in">begin</span></span><br>         (<span class="hljs-name">displayln</span> <span class="hljs-string">&quot;在動態賦值內部：&quot;</span>)<br>         (<span class="hljs-name">displayln</span> x)  <span class="hljs-comment">; 輸出改變後的 x 的值</span><br>         (<span class="hljs-name"><span class="hljs-built_in">set!</span></span> x (<span class="hljs-name"><span class="hljs-built_in">*</span></span> x <span class="hljs-number">2</span>))  <span class="hljs-comment">; 修改 x 的值</span><br>         (<span class="hljs-name">displayln</span> <span class="hljs-string">&quot;在動態賦值內部修改後：&quot;</span>)<br>         (<span class="hljs-name">displayln</span> x)  <span class="hljs-comment">; 輸出修改後的 x 的值</span><br>       )))<br>  <span class="hljs-comment">; 這裡的 x 仍然是原始值</span><br>  (<span class="hljs-name">displayln</span> <span class="hljs-string">&quot;在動態賦值之後：&quot;</span>)<br>  (<span class="hljs-name">displayln</span> x)  <span class="hljs-comment">; 輸出原始值</span><br>)<br></code></pre></td></tr></table></figure><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs delphi"><span class="hljs-keyword">program</span> parameter-passing;<br>  <span class="hljs-keyword">var</span> i: integer;<br>  a: <span class="hljs-keyword">array</span> [<span class="hljs-number">1</span>..<span class="hljs-number">3</span>] <span class="hljs-keyword">of</span> integer;<br><br>  <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">mess</span>;</span><br>    <span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">var</span> y: integer;<br>      y = a[i] + <span class="hljs-number">5</span>;<br>      writeln(<span class="hljs-string">&#x27;y=&#x27;</span>, y);<br>    <span class="hljs-keyword">end</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">sub1</span>;</span><br>    <span class="hljs-keyword">var</span> i: integer;<br>    a: <span class="hljs-keyword">array</span> [<span class="hljs-number">1</span>..<span class="hljs-number">3</span>] <span class="hljs-keyword">of</span> integer;<br>    <span class="hljs-keyword">begin</span><br>      i := <span class="hljs-number">2</span>;<br>      a[<span class="hljs-number">1</span>] := <span class="hljs-number">5</span> ; a[<span class="hljs-number">2</span>] := <span class="hljs-number">7</span>; a[<span class="hljs-number">3</span>] := <span class="hljs-number">9</span>;<br>    mess;<br>  <span class="hljs-keyword">end</span>;<br><br>  <span class="hljs-keyword">begin</span><br>    i := <span class="hljs-number">1</span>;<br>    a[<span class="hljs-number">1</span>] :=<span class="hljs-number">1</span> ; a[<span class="hljs-number">2</span>] := <span class="hljs-number">4</span>; a[<span class="hljs-number">3</span>] :=<span class="hljs-number">8</span> ;<br>    sub1;<br>  <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><ul><li><p>Suppose static binding (also known as lexical binding) is used for variable scopes. What’s the printout value of y?</p><blockquote><p>我猜 mess 裡面 i 是 1、a[i] 是 1，所以 y &#x3D; 1 + 5 &#x3D; 6</p></blockquote></li><li><p>Suppose dynamic binding is used for variable scopes. What’s the printout value of y?</p><blockquote><p>我猜 mess 裡面 i 是 2、a[i] 是 7，所以 y &#x3D; 7 + 5 &#x3D; 12</p></blockquote></li></ul><h2 id="Parameter-Passing-Schemes"><a href="#Parameter-Passing-Schemes" class="headerlink" title="Parameter Passing Schemes"></a>Parameter Passing Schemes</h2><h3 id="Call-by-reference"><a href="#Call-by-reference" class="headerlink" title="Call-by-reference"></a>Call-by-reference</h3><ul><li>Call 的瞬間就看 caller</li><li>在呼叫 function 的當下就已經決定好 parameter 的值</li></ul><h3 id="Call-by-name"><a href="#Call-by-name" class="headerlink" title="Call-by-name"></a>Call-by-name</h3><ul><li>用的時候重新看 caller</li><li>在呼叫的 function 當中每次使用到 parameter 就重新去檢查 caller 當中當下的值</li></ul><h3 id="Call-by-need"><a href="#Call-by-need" class="headerlink" title="Call-by-need"></a>Call-by-need</h3><ul><li>跟 call by name 很像，一樣去算 caller 的，但是第一次算完就存起來，不用每次都算</li><li>第一次使用時重新看 caller</li><li>在呼叫的 function 當中第一次使用到 parameter 的時候才去決定後續的值</li></ul><h3 id="Call-by-text"><a href="#Call-by-text" class="headerlink" title="Call-by-text"></a>Call-by-text</h3><ul><li>用的時候重新看 callee</li><li>在呼叫的 function 當中每次使用到 parameter 就重新去檢查 callee 當中當下的值</li><li>更好的理解方式是從名稱 “call by text”，意即 parameter 會以 text 的型態傳遞，因此需要把所有的 parameter 都視為傳遞前的原貌</li><li>例如定義 <code>f(v: integer)</code> ，呼叫 <code>f(a[i])</code> ，則 <code>f</code> 當中的每個 <code>v</code> 都需要替換成 <code>a[i]</code></li></ul><h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs css">program parameter-passing;<br>  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>: integer;<br>  <span class="hljs-selector-tag">a</span>: array [<span class="hljs-number">1</span>..<span class="hljs-number">3</span>] of integer;<br><br>  procedure mess(v : integer);<br>    begin<br>      v := v + <span class="hljs-number">1</span>;<br>      <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[i]</span> := <span class="hljs-number">5</span>;<br>      <span class="hljs-selector-tag">i</span> := <span class="hljs-number">3</span>;<br>      v := v + <span class="hljs-number">1</span>;<br>    end;<br><br>  begin<br>    for <span class="hljs-selector-tag">i</span>:= <span class="hljs-number">1</span> to <span class="hljs-number">3</span> do a[i] := <span class="hljs-number">0</span>;<br>    <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span> := <span class="hljs-number">10</span>;<br>    <span class="hljs-selector-tag">i</span> := <span class="hljs-number">2</span>;<br>    mess(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[i]</span>);<br>  end<br></code></pre></td></tr></table></figure><ul><li>If by assuming <strong>Call-by-Text</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">0</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">a[i] (a[2])</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">0</td><td align="center">5</td><td align="center">0</td><td align="center">2</td><td align="center">a[i] (a[2])</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">0</td><td align="center">5</td><td align="center">0</td><td align="center">3</td><td align="center">a[i] (a[3])</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">0</td><td align="center">5</td><td align="center">1</td><td align="center">3</td><td align="center">a[i] (a[3])</td></tr><tr><td align="center">observation point</td><td align="center">0</td><td align="center">5</td><td align="center">1</td><td align="center">3</td><td align="center">-</td></tr></tbody></table><ul><li>If by assuming <strong>Call-by-Reference</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">0</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">a[2]</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">0</td><td align="center">5</td><td align="center">0</td><td align="center">2</td><td align="center">a[2]</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">0</td><td align="center">5</td><td align="center">0</td><td align="center">3</td><td align="center">a[2]</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">0</td><td align="center">6</td><td align="center">0</td><td align="center">3</td><td align="center">a[2]</td></tr><tr><td align="center">observation point</td><td align="center">0</td><td align="center">6</td><td align="center">0</td><td align="center">3</td><td align="center">-</td></tr></tbody></table><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs css">program parameter-passing;<br>  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>: integer;<br>  <span class="hljs-selector-tag">a</span>: array [<span class="hljs-number">1</span>..<span class="hljs-number">3</span>] of integer;<br><br>  procedure mess(v : integer);<br>    <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>: integer;<br>    begin<br>      <span class="hljs-selector-tag">i</span> := <span class="hljs-number">1</span>;<br>      v := v + <span class="hljs-number">1</span>;<br>      <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[i]</span> := <span class="hljs-number">5</span>;<br>      <span class="hljs-selector-tag">i</span> := <span class="hljs-number">3</span>;<br>      v := v + <span class="hljs-number">1</span>;<br>    end;<br><br>  begin<br>    for <span class="hljs-selector-tag">i</span>:= <span class="hljs-number">1</span> to <span class="hljs-number">3</span> do a[i] := <span class="hljs-number">0</span>;<br>    <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span> := <span class="hljs-number">10</span>;<br>    <span class="hljs-selector-tag">i</span> := <span class="hljs-number">2</span>;<br>    mess(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[i]</span>);<br>  end<br></code></pre></td></tr></table></figure><ul><li>If by assuming <strong>Call-by-Name</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i (caller)</th><th align="center">i (callee)</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="center">i :&#x3D; 1</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[2]</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">0</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[2]</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">5</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[2]</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">5</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">3</td><td align="center">a[2]</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">5</td><td align="center">12</td><td align="center">0</td><td align="center">2</td><td align="center">3</td><td align="center">a[2]</td></tr><tr><td align="center">observation point</td><td align="center">5</td><td align="center">12</td><td align="center">0</td><td align="center">2</td><td align="center">-</td><td align="center">-</td></tr></tbody></table><ul><li>If by assuming <strong>Call-by-Text</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i (caller)</th><th align="center">i (callee)</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="center">i :&#x3D; 1</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[i(callee)] (a[1])</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">1</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[i(callee)] (a[1])</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">5</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[i(callee)] (a[1])</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">5</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">3</td><td align="center">a[i(callee)] (a[3])</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">5</td><td align="center">10</td><td align="center">1</td><td align="center">2</td><td align="center">3</td><td align="center">a[i(callee)] (a[3])</td></tr><tr><td align="center">observation point</td><td align="center">5</td><td align="center">10</td><td align="center">1</td><td align="center">2</td><td align="center">-</td><td align="center">-</td></tr></tbody></table><ul><li>If by assuming <strong>Call-by-Need</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i (caller)</th><th align="center">i (callee)</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td><td align="center">-</td></tr><tr><td align="center">i :&#x3D; 1</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">-</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">0</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[i(caller)] (a[2])</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">5</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">1</td><td align="center">a[2]</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">5</td><td align="center">11</td><td align="center">0</td><td align="center">2</td><td align="center">3</td><td align="center">a[2]</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">5</td><td align="center">12</td><td align="center">0</td><td align="center">2</td><td align="center">3</td><td align="center">a[2]</td></tr><tr><td align="center">observation point</td><td align="center">5</td><td align="center">12</td><td align="center">0</td><td align="center">2</td><td align="center">-</td><td align="center">-</td></tr></tbody></table><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs css">program parameter-passing;<br>  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>: integer;<br>  <span class="hljs-selector-tag">a</span>: array [<span class="hljs-number">1</span>..<span class="hljs-number">3</span>] of integer;<br><br>  procedure mess(v : integer);<br>    begin<br>      <span class="hljs-selector-tag">i</span> := <span class="hljs-number">1</span>;<br>      v := v + <span class="hljs-number">1</span>;<br>      <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[i]</span> := <span class="hljs-number">5</span>;<br>      <span class="hljs-selector-tag">i</span> := <span class="hljs-number">3</span>;<br>      v := v + <span class="hljs-number">1</span>;<br>    end;<br><br>  begin<br>    for <span class="hljs-selector-tag">i</span>:= <span class="hljs-number">1</span> to <span class="hljs-number">3</span> do a[i] := <span class="hljs-number">0</span>;<br>    <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span> := <span class="hljs-number">10</span>;<br>    <span class="hljs-selector-tag">i</span> := <span class="hljs-number">2</span>;<br>    mess(<span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[i]</span>);<br>  end<br></code></pre></td></tr></table></figure><ul><li>If by assuming <strong>Call-by-Name</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td></tr><tr><td align="center">i :&#x3D; 1</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">1</td><td align="center">-</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">1</td><td align="center">10</td><td align="center">0</td><td align="center">1</td><td align="center">a[i] (a[1])</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">5</td><td align="center">10</td><td align="center">0</td><td align="center">1</td><td align="center">a[i] (a[1])</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">5</td><td align="center">10</td><td align="center">0</td><td align="center">3</td><td align="center">a[i] (a[3])</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">5</td><td align="center">10</td><td align="center">1</td><td align="center">3</td><td align="center">a[i] (a[3])</td></tr><tr><td align="center">observation point</td><td align="center">5</td><td align="center">10</td><td align="center">1</td><td align="center">3</td><td align="center">-</td></tr></tbody></table><ul><li>If by assuming <strong>Call-by-Need</strong>, what’s the value in the array a and the variable i?</li></ul><table><thead><tr><th align="center"></th><th align="center">a[1]</th><th align="center">a[2]</th><th align="center">a[3]</th><th align="center">i</th><th align="center">v</th></tr></thead><tbody><tr><td align="center">before mess</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">2</td><td align="center">-</td></tr><tr><td align="center">i :&#x3D; 1</td><td align="center">0</td><td align="center">10</td><td align="center">0</td><td align="center">1</td><td align="center">-</td></tr><tr><td align="center">v :&#x3D; v + 1;</td><td align="center">1</td><td align="center">10</td><td align="center">0</td><td align="center">1</td><td align="center">a[i] (a[1])</td></tr><tr><td align="center">a[i] :&#x3D; 5;</td><td align="center">5</td><td align="center">10</td><td align="center">0</td><td align="center">1</td><td align="center">a[1]</td></tr><tr><td align="center">i :&#x3D; 3</td><td align="center">5</td><td align="center">10</td><td align="center">0</td><td align="center">3</td><td align="center">a[1]</td></tr><tr><td align="center">v :&#x3D; v + 1</td><td align="center">6</td><td align="center">10</td><td align="center">0</td><td align="center">3</td><td align="center">a[1]</td></tr><tr><td align="center">observation point</td><td align="center">6</td><td align="center">10</td><td align="center">0</td><td align="center">3</td><td align="center">-</td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>compiler</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unreal Engine 4 - GPGPU flocking 解析</title>
    <link href="/notes/2024/02/25/ue4-cs-aceyan/"/>
    <url>/notes/2024/02/25/ue4-cs-aceyan/</url>
    
    <content type="html"><![CDATA[<p>source code: <a href="https://github.com/aceyan/UE4_GPGPU_flocking/tree/ComputeShader">https://github.com/aceyan/UE4_GPGPU_flocking/tree/ComputeShader</a></p><h3 id="GPU-Instances"><a href="#GPU-Instances" class="headerlink" title="GPU Instances"></a>GPU Instances</h3><p>這個專案使用 GPU Instancing，一次渲染大量 Static Mesh。為了讓每個 instance 有區別，它賦予每個 instance 一個 CustomData，作為分辨的 ID。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = <span class="hljs-string">&quot;Flocking&quot;</span>)<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UInstancedStaticMeshComponent</span>* InstancedComponent;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; instatnceNum; i++)<br>&#123;<br>FTransform t = <span class="hljs-built_in">FTransform</span>();<br>InstancedComponent-&gt;<span class="hljs-built_in">AddInstance</span>(t);<br>InstancedComponent-&gt;<span class="hljs-built_in">SetCustomDataValue</span>(i, <span class="hljs-number">0</span>, i);<br><span class="hljs-built_in">UE_LOG</span>(LogTemp, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;AddInstance %d&quot;</span>), i);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/notes/./images/ue4-cs-aceyan/InstancedComponent.png" alt="Instanced Component"></p><p>然後藉由 PerInstanceCustomData[0]，取得不同的 Instance ID，然後更新它們各自的 Material 的 World Position Offset (相對位置) ，來達到移動的效果。</p><h3 id="GPGPU"><a href="#GPGPU" class="headerlink" title="GPGPU"></a>GPGPU</h3><p>由於運算量龐大，可以藉由 GPGPU (Compute Shader) 來計算。那要怎麼直接把 GPGPU 算出的結果傳給 World Position Offset？</p><p>這裡使用 Render Target (RT) 去除存每個 Instance 的位置、速度，所以每個 Texel 的 RGB 儲存的是 World Position Offset 的 XYZ。因此，遊戲開始的時候，儲存 Position 的 Render Target 會長這樣，五彩繽紛的顏色就代表各種 World Position Offset。</p><p><img src="/notes/./images/ue4-cs-aceyan/PositionRenderTarget.png" alt="Position Render Target"></p><p>藉由這個方法，CPU 叫 GPU 算完可以直接渲染，不用再回傳到 CPU，所以整個邏輯是 GPGPU -&gt; RenderTarget -&gt; Material。</p><p>最後，只要想辦法取出每個 Instance 對應到的 Texel 的顏色，傳到 World Position Offset 就好。</p><p><img src="/notes/./images/ue4-cs-aceyan/UpdateInstancePosition.png" alt="Update Instance Position"></p><p>看起來很複雜，實際上就是根據 ID 算出對應的 Texel 的座標，左上是 (0, 0)，右下是 (1, 1)，再 Sample 出 Texture Object 某 Texel 的顏色。</p>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4, GPU</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GPGPU</title>
    <link href="/notes/2024/02/21/gpgpu/"/>
    <url>/notes/2024/02/21/gpgpu/</url>
    
    <content type="html"><![CDATA[<h1 id="名詞解釋"><a href="#名詞解釋" class="headerlink" title="名詞解釋"></a>名詞解釋</h1><ul><li><p>CUDA (Compute Unified Device Architecture)</p><ul><li>強大的平行計算平台，讓開發者能夠充分利用 NVIDIA GPU 的計算能力(NVIDIA 專用)，進行高效的計算任務處理</li></ul></li><li><p>OpenCL (Open Computing Language)</p><ul><li>用於編寫在多種處理器上運行的程序，包括 CPU、GPU、DSP（數字訊號處理器）和其他類型的處理器，主要用於通用計算，特別是那些可以利用平行計算的任務</li></ul></li></ul><h1 id="從-GPU-到-GPGPU"><a href="#從-GPU-到-GPGPU" class="headerlink" title="從 GPU 到 GPGPU"></a>從 GPU 到 GPGPU</h1><p>CPU 單核心性能的提高受到<strong>功耗</strong>、<strong>存取記憶體速度</strong>、<strong>設計複雜度</strong>等多重瓶頸的限制，而 GPU 僅侷限於處理圖形繪製的計算任務，是極大的資源浪費。</p><p>2006 年，NVIDIA 公布了統一著色器架構(unified shader architecture)，從此 GPU 進入了通用計算時代。 傳統的 GPU 通常採用固定比例的頂點著色器和像素著色器單元，但這種作法會導致單元使用率低下的問題。為解決這一問題，統一著色器架構整合了頂點著色器和像素著色器，這種無差別的著色器設計，使 GPU 成為一個多核心的通用處理器。</p><h1 id="計算模型"><a href="#計算模型" class="headerlink" title="計算模型"></a>計算模型</h1><h3 id="SIMT-Single-Instruction-Multiple-Threads-，單指令多執行緒"><a href="#SIMT-Single-Instruction-Multiple-Threads-，單指令多執行緒" class="headerlink" title="SIMT (Single Instruction Multiple Threads)，單指令多執行緒"></a>SIMT (Single Instruction Multiple Threads)，單指令多執行緒</h3><ul><li>一行指令被多個執行緒同時執行，與 SIMD 平行類似，在 GPGPU 中被稱為 SIMT 計算模型</li><li>ex: 矩陣乘法<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 從輸入矩陣 A 和 B 中讀取一部份向量 a, b</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N; i++)&#123;<br>  c += a[i] + b[i];<br>&#125;<br><span class="hljs-comment">// 將 c 寫回結果矩陣 C 的對應位置中</span><br></code></pre></td></tr></table></figure></li><li>CUDA 為 SIMT 計算模型引入 thread grid、thread block、thread，對等地，OpenCL 為 SIMT 計算模型引入 NDRange、work-group、work-item</li></ul><h3 id="裝置端和核心函數"><a href="#裝置端和核心函數" class="headerlink" title="裝置端和核心函數"></a>裝置端和核心函數</h3><p>在 CUDA 和 OpenCL 模型中，會把程式劃分成<strong>主機端 (host)</strong> 和<strong>裝置端 (device)</strong> ，分別在 CPU 和 GPGPU 上執行。 CPU 硬體執行主機端程式，GPGPU 硬體將根據程式設計人員給定的執行緒網格 (上面提到的 thread grid) 組織方式等參數，將裝置端程式進一步分發到執行緒中。每個執行緒執行相同的程式，但是是不同的資料。</p><p>以上面的矩陣乘法為例，主機端程式分成三個步驟：</p><h4 id="資料複製"><a href="#資料複製" class="headerlink" title="資料複製"></a>資料複製</h4><ul><li>CPU 將主記憶體資料複製到 GPGPU。主機端程式會先完成 GPGPU 的待處理資料宣告和前置處理，然後 CPU 呼叫 API 對 GPGPU 進行初始化和控制。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 主記憶體的資料</span><br><span class="hljs-type">float</span> A[M * N], B[N * K], C[M * K];<br><span class="hljs-comment">// GPGPU 裝置端全域記憶體</span><br><span class="hljs-type">float</span>* d_A, * d_B, * d_C;<br><br><span class="hljs-type">int</span> size = M * N * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>);<br><span class="hljs-comment">// CPU 呼叫 API 分配裝置端空間 </span><br>cudaMalloc((<span class="hljs-type">void</span>**)&amp; d_A, size);<br><span class="hljs-comment">// CPU 呼叫 API 控制 CPU 和 GPGPU 之間的通訊</span><br><span class="hljs-comment">// 將資料從主機端記憶體複製到 GPGPU 全域記憶體裡面</span><br>cudaMemcpy(d_A, A, size, cudaMemcpyHostToDevice);<br><br>size = N * K * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>);<br>cudaMalloc((<span class="hljs-type">void</span>**)&amp; d_B, size);<br>cudaMemcpy(d_B, B, size, cudaMemcpyHostToDevice);<br><br>size = M * K * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>);<br>cudaMalloc((<span class="hljs-type">void</span>**)&amp; d_C, size);<br></code></pre></td></tr></table></figure></li></ul><h4 id="GPGPU-啟動"><a href="#GPGPU-啟動" class="headerlink" title="GPGPU 啟動"></a>GPGPU 啟動</h4><ul><li>CPU 喚醒 GPGPU 執行緒進行運算，並將執行緒的組織方式和參數傳入 GPGPU 中。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> T_size = <span class="hljs-number">16</span>;<br>dim3 <span class="hljs-title function_">gridDim</span><span class="hljs-params">(M / T_size, K / T_size, <span class="hljs-number">1</span>)</span>;<br>dim3 <span class="hljs-title function_">blockDim</span><span class="hljs-params">(T_size, T_size, <span class="hljs-number">1</span>)</span>;<br><br><span class="hljs-comment">/// 喚醒對應的裝置端程式</span><br><span class="hljs-comment">/// 啟動名為 basic_mul 的裝置端函數</span><br>basic_mul &lt;&lt;&lt; gridDim, blockDim &gt;&gt;&gt; (d_A, d_B, d_C);<br><br><span class="hljs-comment">// 因為 CPU 和 GPGPU 是非同步執行，要使用此函數讓他們同步</span><br><span class="hljs-comment">// 不然可能 CPU 還沒等到 GPGPU 算完就繼續跑</span><br>cudaDeviceSynchronize();<br></code></pre></td></tr></table></figure></li></ul><h4 id="資料寫回"><a href="#資料寫回" class="headerlink" title="資料寫回"></a>資料寫回</h4><ul><li>GPGPU 運算完畢，並將結果寫回主機端記憶體中。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">size = M * K * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>);<br><span class="hljs-comment">// 將裝置端記憶體 d_C 傳回 主機端記憶體 C</span><br>cudaMemcpy(C, d_C, size, cudaMemcpyDeviceToHost);<br><br><span class="hljs-comment">// GPGPU 裝置端空間釋放</span><br>cudaFree(d_A);<br>cudaFree(d_B);<br>cudaFree(d_C);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure></li></ul><p>裝置端程式常常由多個函數組成，這些函數被稱為**核心函數 (kernel)**，這些核心函數會被分配到每個 GPGPU 的執行緒中執行。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// __global__ 關鍵字定義了這個函數會作為核心函數在 GPGPU 上跑</span><br>__global__ <span class="hljs-type">void</span> <span class="hljs-title function_">basic_mul</span><span class="hljs-params">(<span class="hljs-type">float</span>* d_A, <span class="hljs-type">float</span>* d_B, <span class="hljs-type">float</span>* d_C)</span>&#123;<br>  <span class="hljs-type">int</span> row = threadIdx.x + blockIdx.x * blockDim.x;<br>  <span class="hljs-type">int</span> col = threadIdx.y + blockIdx.y * blockDim.y;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++)&#123;<br>    d_C[row * K + col] += d_A[row * N + i] * d_B[col + i * k];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="執行緒模型"><a href="#執行緒模型" class="headerlink" title="執行緒模型"></a>執行緒模型</h1><h3 id="執行緒組織結構"><a href="#執行緒組織結構" class="headerlink" title="執行緒組織結構"></a>執行緒組織結構</h3><p>上面提到，主機端在啟動核心函數時，利用 &lt;&lt;&lt;&gt;&gt;&gt; 向 GPGPU 傳送兩個參數 gridDim 和 blockDim，這兩個參數構造了 GPGPU 計算所採用的執行緒結構。</p><p>CUDA 和 OpenCL 都採用了層次化的執行緒結構，就是前面說的 thread grid、thread block、thread 和 NDRange、work-group、work-item，一一對應。同一個 Block 內的 Thread 可以互相溝通。</p><p><img src="https://www.researchgate.net/publication/328752788/figure/fig3/AS:689781692432384@1541468179263/CUDA-programming-grid-of-thread-blocks-Source-NVIDIA.png" alt="CUDA 的層次化執行緒結構"></p><h3 id="資料索引"><a href="#資料索引" class="headerlink" title="資料索引"></a>資料索引</h3><p>基於上面的執行緒層次，我們需要知道 Thread 在 Grid 中的具體位置，才能讀取合適的資料執行對應的計算。上面例子的 blockIdx、threadIdx 就是用來決定 Thread 的位置。</p>]]></content>
    
    
    <categories>
      
      <category>GPU</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gpu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Push React App to Github Pages</title>
    <link href="/notes/2024/02/08/react-github-pages/"/>
    <url>/notes/2024/02/08/react-github-pages/</url>
    
    <content type="html"><![CDATA[<ul><li><p>安裝套件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install gh-pages --save-dev<br>yarn add -D gh-pages<br></code></pre></td></tr></table></figure></li><li><p>在 package.json 裡面新增</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;homepage&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&#123;url to your website&#125;&quot;</span><br>  <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;predeploy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;npm run build&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;deploy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;gh-pages -d build&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>要 push 的時候就打以下指令，就可以自動 push 到 branch gh-pages</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm run deploy<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>React</tag>
      
      <tag>Gtihub</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE5 Resources</title>
    <link href="/notes/2024/01/31/ue5-resources/"/>
    <url>/notes/2024/01/31/ue5-resources/</url>
    
    <content type="html"><![CDATA[<ol><li><a href="https://zhuanlan.zhihu.com/p/639001043">理解 FrameGraph</a></li><li><a href="https://zhuanlan.zhihu.com/p/637889120">UE5 Render Dependency Graph-实用指南</a></li><li><a href="https://zhuanlan.zhihu.com/p/551981932">剖析虚幻渲染体系（08）- Shader体系（02）</a></li><li><a href="https://www.bilibili.com/video/BV18K411Z7Jg/?spm_id_from=333.337.search-card.all.click&vd_source=cdd130c5068c54677e0ec511d6834ece">[UOD2022]Rendering Dependency Graph解析 | Epic 陈拓</a></li><li><a href="https://zhuanlan.zhihu.com/p/73016473">游戏引擎随笔 0x05：现代图形 API 讲义</a></li><li><a href="https://zhuanlan.zhihu.com/p/438784425">UE4性能分析工具Stats</a></li><li><a href="https://frankorz.com/2021/04/17/compute-shader/index.html">Compute Shader 简介 - 萤火之森</a></li><li><a href="https://michaeljcole.github.io/wiki.unrealengine.com/HLSL_Shaders/">HLSL Shaders</a></li><li><a href="https://github.com/Temaran/UnrealEngineShaderPluginDemo">UnrealEngineShaderPluginDemo</a></li><li><a href="https://zhuanlan.zhihu.com/p/624322431">UE渲染学习(4)ComputeShader</a></li><li><a href="https://www.bilibili.com/read/cv8755619/">Unreal Compute Shader 使用流程笔记</a></li><li><a href="https://zhuanlan.zhihu.com/p/608724638?utm_id=0">UE5中的 Compute Shader使用及详解（二）</a></li><li><a href="https://inlet511.github.io/posts/rdg-05-structured-buffer/#16-%E5%88%9B%E5%BB%BAsrv%E8%A7%86%E5%9B%BE">RDG 05 StructuredBuffer的用法</a></li><li><a href="https://zhuanlan.zhihu.com/p/379638061">UE4 RHICmdList</a></li><li><a href="https://zhuanlan.zhihu.com/p/377411777">Unreal Engine 4 Materials Tutorial——虚幻4引擎教程——材质</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>UE5</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Unreal Engine 5 - Render Dependency Graph (RDG)</title>
    <link href="/notes/2024/01/30/ue5-rdg/"/>
    <url>/notes/2024/01/30/ue5-rdg/</url>
    
    <content type="html"><![CDATA[<h3 id="RDG-是什麼"><a href="#RDG-是什麼" class="headerlink" title="RDG 是什麼"></a>RDG 是什麼</h3><dl><dt><a href="https://docs.unrealengine.com/4.26/en-US/ProgrammingAndScripting/Rendering/RenderDependencyGraph/">官方文件</a>提到</dt><dd>渲染依賴圖（Rendering Dependency Graph，RDG）是一種基於圖形的排程系統，旨在對渲染管線進行整幀優化。</dd></dl><h4 id="基本介紹"><a href="#基本介紹" class="headerlink" title="基本介紹"></a>基本介紹</h4><ul><li><p>RDG 於 Unreal 4.22 引入</p></li><li><p>前身是 Frame Graph ，在 2017 年的 GDC 中由 <a href="https://zh.wikipedia.org/zh-tw/%E5%AF%92%E9%9C%9C%E5%BC%95%E6%93%8E">Frostbite Engine</a> 提出</p></li><li><p>RDG 的概念是不在 GPU 上立即執行通道 (Pass)，而是先收集所有需要渲染的通道，然後按照它們之間的依賴關係順序對圖表進行編譯和執行。過程中，系統會執行各種裁剪和優化操作。</p></li></ul><h4 id="為什麼要用-RDG？"><a href="#為什麼要用-RDG？" class="headerlink" title="為什麼要用 RDG？"></a>為什麼要用 RDG？</h4><ul><li><p>Render pipeline 越來越複雜，導致難以管理且性能不好</p><ul><li>隨著硬體性能日漸提升，各大廠商為了渲染出更出色的畫面效果，render pipeline 也日趨複雜。</li></ul></li></ul><p><img src="/notes/images/ue5-rdg/rendering-systems-overview.png" alt="rendering systems overview" title="Rendering systems overview"></p><ul><li><p>硬體的體系結構以及圖形 API 的優化擴展無法得到充分的利用</p><ul><li><p>現代圖形API (如DirectX 12、Vulkan 和 Metal 2) 與傳統圖形API (如DirectX 11、OpenGL) 的主要區別在於現代圖形 API 將更多的 GPU 管理的責任轉移到應用程式的開發者身上，能夠更有效的利用有限的 GPU 資源，進而提升效能。</p><ul><li><a href="https://zhuanlan.zhihu.com/p/73016473">傳統 API 和現代 API 的介紹</a></li></ul></li><li><p>RDG 與現代圖形 API 的能力相結合，使 RDG 能夠在幕後執行複雜的排程任務：</p><ol><li>執行異步計算通道的自動排程和隔離。</li><li>在幀的不相交間隔期間，使資源之間的別名 (Aliasing) 記憶體保持活躍狀態。</li><li>盡早啟動屏障和佈局轉換，避免管線延遲。</li></ol></li></ul></li></ul><h3 id="RDG-的原理"><a href="#RDG-的原理" class="headerlink" title="RDG 的原理"></a>RDG 的原理</h3><p><img src="/notes/images/ue5-rdg/rdg-in-engine.png" alt="rdg in the game engine" title="RDG in the game engine"></p><p>位於 RHI 和 Render Pass 的中間，RDG 作為 Pass 管理器，在搜集資源描述訊息後，對 Pass 和資源進行分析，並結合硬體特性，以最優的方式執行 Pass，主要有三個階段：</p><ol><li><p>Setup</p><ul><li>蒐集 pass 的訊息(主要是該 Pass 使用到的資源)</li></ul></li><li><p>Compile</p><ul><li>Render Graph 的生成以及分析 (包含 Pass culling、Resources state 的最終生成、Async Compute 優化等等)</li></ul></li><li><p>Execute</p><ul><li>將 Command 提交到 CommandList (包含設置 Barrier、平行優化等)</li></ul></li></ol><p><img src="/notes/images/ue5-rdg/rdg-stages.png" alt="Three stages of RDG" title="Three stages of RDG"></p><h3 id="FRDGBuilder"><a href="#FRDGBuilder" class="headerlink" title="FRDGBuilder"></a>FRDGBuilder</h3><ul><li>RDG 系统的心臟和驅動器，同時也是管家，負責儲存數據、處理狀態轉換、自動管理資源生命週期和屏障 (barrier)、裁剪無效資源，和收集、編譯、執行Pass，提取紋理或緩衝等等功能。</li></ul><h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/554758862">剖析虚幻渲染体系（11）- RDG</a></li><li><a href="https://docs.unrealengine.com/4.26/en-US/ProgrammingAndScripting/Rendering/RenderDependencyGraph/">Rendering Dependency Graph</a></li><li><a href="https://zhuanlan.zhihu.com/p/637889120">UE5 Render Dependency Graph-实用指南</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>UE5</category>
      
      <category>Render</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE5</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flutter GPS background</title>
    <link href="/notes/2024/01/25/flutter-gps/"/>
    <url>/notes/2024/01/25/flutter-gps/</url>
    
    <content type="html"><![CDATA[<blockquote><p>官方文件: <a href="https://pub.dev/packages/background_locator_2/example">https://pub.dev/packages/background_locator_2/example</a><br>Github: <a href="https://github.com/Yukams/background_locator_fixed">https://github.com/Yukams/background_locator_fixed</a></p></blockquote><h3 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h3><p>這個 package 的目的是讓 app 可以順利定位，取得定位的相關訊息 (經緯度、方向、速度等)，最重要的是它也支援<strong>背景運行</strong>，也就是當你 kill 這個 app (在 app switcher 裡 swipe up app)，這個 app 依然在背景中運行，並顯示在手機的 notification drawer 裡來提醒使用者。</p><p><img src="/notes/images/flutter-gps/notification.png" alt="Notification"></p><p>由於 <code>location_permissions</code> 似乎不再更新了，所以在測試的時候都會有問題，無法正確 import package，所以後來我改用 <code>permission_handler</code>，除了詢問 location 的權限，同時也可以要求 notification 的權限。</p><h3 id="程式碼"><a href="#程式碼" class="headerlink" title="程式碼"></a>程式碼</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;dart:async&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;dart:isolate&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;dart:ui&#x27;</span>;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:background_locator_2/background_locator.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:background_locator_2/location_dto.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:background_locator_2/settings/android_settings.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:background_locator_2/settings/ios_settings.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:background_locator_2/settings/locator_settings.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:flutter/material.dart&#x27;</span>;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;package:permission_handler/permission_handler.dart&#x27;</span>;<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;file_manager.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;location_callback_handler.dart&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;location_service_repository.dart&#x27;</span>;<br><br><span class="hljs-keyword">void</span> main() =&gt; runApp(MyApp());<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>&#123;<br>  <span class="hljs-meta">@override</span><br>  _MyAppState createState() =&gt; _MyAppState();<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyAppState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyApp</span>&gt; </span>&#123;<br>  ReceivePort port = ReceivePort();<br><br>  <span class="hljs-built_in">String</span> logStr = <span class="hljs-string">&#x27;&#x27;</span>;<br>  <span class="hljs-built_in">bool</span> isRunning = <span class="hljs-keyword">false</span>;<br><br>  <span class="hljs-meta">@override</span><br>  <span class="hljs-keyword">void</span> initState() &#123;<br>    <span class="hljs-keyword">super</span>.initState();<br><br>    <span class="hljs-keyword">if</span> (IsolateNameServer.lookupPortByName(LocationServiceRepository.isolateName) != <span class="hljs-keyword">null</span>)<br>    &#123;<br>          IsolateNameServer.removePortNameMapping(<br>          LocationServiceRepository.isolateName);<br>    &#125;<br><br>    IsolateNameServer.registerPortWithName(port.sendPort, LocationServiceRepository.isolateName);<br><br>    port.listen((<span class="hljs-built_in">dynamic</span> data) <span class="hljs-keyword">async</span> &#123;<br>        <span class="hljs-keyword">await</span> updateUI(data);<br>      &#125;,<br>    );<br>    initPlatformState();<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  <span class="hljs-keyword">void</span> dispose() &#123;<br>    <span class="hljs-keyword">super</span>.dispose();<br>  &#125;<br><br>  Future&lt;<span class="hljs-keyword">void</span>&gt; updateUI(<span class="hljs-built_in">dynamic</span> data) <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-keyword">final</span> log = <span class="hljs-keyword">await</span> FileManager.readLogFile();<br><br>    <span class="hljs-keyword">if</span> (data != <span class="hljs-keyword">null</span>)&#123;<br>      <span class="hljs-keyword">await</span> _updateNotificationText(data);<br>    &#125;<br><br>    setState(()&#123;<br>      logStr = log;<br>    &#125;);<br>  &#125;<br><br>  Future&lt;<span class="hljs-keyword">void</span>&gt; _updateNotificationText(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; data) <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-keyword">await</span> BackgroundLocator.updateNotificationText(<br>        title: <span class="hljs-string">&quot;new location received&quot;</span>,<br>        msg: <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;DateTime.now()&#125;</span>&quot;</span>,<br>        bigMsg: <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;data[<span class="hljs-string">&#x27;latitude&#x27;</span>]&#125;</span>, <span class="hljs-subst">$&#123;data[<span class="hljs-string">&#x27;longitude&#x27;</span>]&#125;</span>&quot;</span><br>    );<br>  &#125;<br><br>  Future&lt;<span class="hljs-keyword">void</span>&gt; initPlatformState() <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Initializing...&#x27;</span>);<br>    <span class="hljs-keyword">await</span> BackgroundLocator.initialize();<br>    logStr = <span class="hljs-keyword">await</span> FileManager.readLogFile();<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Initialization done&#x27;</span>);<br>    <span class="hljs-keyword">final</span> _isRunning = <span class="hljs-keyword">await</span> BackgroundLocator.isServiceRunning();<br>    setState(() &#123;<br>      isRunning = _isRunning;<br>    &#125;);<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Running <span class="hljs-subst">$&#123;isRunning.toString()&#125;</span>&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@override</span><br>  Widget build(BuildContext context) &#123;<br>    <span class="hljs-keyword">final</span> start = SizedBox(<br>      width: <span class="hljs-built_in">double</span>.maxFinite,<br>      child: ElevatedButton(<br>        child: Text(<span class="hljs-string">&#x27;Start&#x27;</span>),<br>        onPressed: () &#123;<br>          _onStart();<br>        &#125;,<br>      ),<br>    );<br>    <span class="hljs-keyword">final</span> stop = SizedBox(<br>      width: <span class="hljs-built_in">double</span>.maxFinite,<br>      child: ElevatedButton(<br>        child: Text(<span class="hljs-string">&#x27;Stop&#x27;</span>),<br>        onPressed: () &#123;<br>          onStop();<br>        &#125;,<br>      ),<br>    );<br>    <span class="hljs-keyword">final</span> clear = SizedBox(<br>      width: <span class="hljs-built_in">double</span>.maxFinite,<br>      child: ElevatedButton(<br>        child: Text(<span class="hljs-string">&#x27;Clear Log&#x27;</span>),<br>        onPressed: () &#123;<br>          FileManager.clearLogFile();<br>          setState(() &#123;<br>            logStr = <span class="hljs-string">&#x27;&#x27;</span>;<br>          &#125;);<br>        &#125;,<br>      ),<br>    );<br>    <span class="hljs-built_in">String</span> msgStatus = <span class="hljs-string">&quot;-&quot;</span>;<br>    <span class="hljs-keyword">if</span> (isRunning != <span class="hljs-keyword">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (isRunning) &#123;<br>        msgStatus = <span class="hljs-string">&#x27;Is running&#x27;</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        msgStatus = <span class="hljs-string">&#x27;Is not running&#x27;</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">final</span> status = Text(<span class="hljs-string">&quot;Status: <span class="hljs-subst">$msgStatus</span>&quot;</span>);<br><br>    <span class="hljs-keyword">final</span> log = Text(<br>      logStr,<br>    );<br><br>    <span class="hljs-keyword">return</span> MaterialApp(<br>      home: Scaffold(<br>        appBar: AppBar(<br>          title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;Flutter background Locator&#x27;</span>),<br>        ),<br>        body: Container(<br>          width: <span class="hljs-built_in">double</span>.maxFinite,<br>          padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">22</span>),<br>          child: SingleChildScrollView(<br>            child: Column(<br>              crossAxisAlignment: CrossAxisAlignment.center,<br>              children: &lt;Widget&gt;[start, stop, clear, status, log],<br>            ),<br>          ),<br>        ),<br>      ),<br>    );<br>  &#125;<br><br>  <span class="hljs-keyword">void</span> onStop() <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-keyword">await</span> BackgroundLocator.unRegisterLocationUpdate();<br>    <span class="hljs-keyword">final</span> _isRunning = <span class="hljs-keyword">await</span> BackgroundLocator.isServiceRunning();<br>    setState(() &#123;<br>      isRunning = _isRunning;<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-keyword">void</span> _onStart() <span class="hljs-keyword">async</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> _checkNotificationPermission()) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">await</span> _checkLocationPermission()) <span class="hljs-keyword">return</span>;<br>    <span class="hljs-keyword">await</span> _startLocator();<br>    <span class="hljs-keyword">final</span> _isRunning = <span class="hljs-keyword">await</span> BackgroundLocator.isServiceRunning();<br><br>    setState(() &#123;<br>      isRunning = _isRunning;<br>    &#125;);<br>  &#125;<br><br>  Future&lt;<span class="hljs-built_in">bool</span>&gt; _checkLocationPermission() <span class="hljs-keyword">async</span> &#123;<br>    Permission _permission = Permission.location;<br>    PermissionStatus _status = <span class="hljs-keyword">await</span> _permission.request();<br>    <span class="hljs-keyword">if</span> (_status.isPermanentlyDenied) &#123;<br>      <span class="hljs-keyword">await</span> openAppSettings();<br>    &#125;<br>    <span class="hljs-keyword">return</span> _status.isGranted;<br>  &#125;<br><br>  Future&lt;<span class="hljs-built_in">bool</span>&gt; _checkNotificationPermission() <span class="hljs-keyword">async</span> &#123;<br>    Permission _permission = Permission.notification;<br>    PermissionStatus _status = <span class="hljs-keyword">await</span> _permission.request();<br>    <span class="hljs-keyword">if</span> (_status.isPermanentlyDenied) &#123;<br>      <span class="hljs-keyword">await</span> openAppSettings();<br>    &#125;<br>    <span class="hljs-keyword">return</span> _status.isGranted;<br>  &#125;<br><br>  Future&lt;<span class="hljs-keyword">void</span>&gt; _startLocator() <span class="hljs-keyword">async</span>&#123;<br><br>    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; data = &#123;<span class="hljs-string">&#x27;countInit&#x27;</span>: <span class="hljs-number">1</span>&#125;;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> BackgroundLocator.registerLocationUpdate(<br>        LocationCallbackHandler.callback,<br>        initCallback: LocationCallbackHandler.initCallback,<br>        initDataCallback: data,<br>        disposeCallback: LocationCallbackHandler.disposeCallback,<br>        iosSettings: IOSSettings(<br>            accuracy: LocationAccuracy.NAVIGATION,<br>            distanceFilter: <span class="hljs-number">0</span>,<br>            stopWithTerminate: <span class="hljs-keyword">true</span><br>        ),<br>        autoStop: <span class="hljs-keyword">false</span>,<br>        androidSettings: AndroidSettings(<br>            accuracy: LocationAccuracy.NAVIGATION,<br>            interval: <span class="hljs-number">1</span>,<br>            distanceFilter: <span class="hljs-number">0</span>,<br>            client: LocationClient.google,<br>            androidNotificationSettings: AndroidNotificationSettings(<br>                notificationChannelName: <span class="hljs-string">&#x27;Location tracking&#x27;</span>,<br>                notificationTitle: <span class="hljs-string">&#x27;Start Location Tracking&#x27;</span>,<br>                notificationMsg: <span class="hljs-string">&#x27;Track location in background&#x27;</span>,<br>                notificationBigMsg:<br>                <span class="hljs-string">&#x27;Background location is on to keep the app up-tp-date with your location. This is required for main features to work properly when the app is not running.&#x27;</span>,<br>                notificationIcon: <span class="hljs-string">&#x27;&#x27;</span>,<br>                notificationIconColor: Colors.grey,<br>                notificationTapCallback:<br>                LocationCallbackHandler.notificationCallback)<br>        )<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在 AndroidMaifest.xml 裡面要加上：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.POST_NOTIFICATIONS&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.ACCESS_BACKGROUND_LOCATION&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.WAKE_LOCK&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.FOREGROUND_SERVICE&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><!-- ### Demo[![](https://markdown-videos-api.jorgenkh.no/youtube/euh3HlNAERs)](https://youtu.be/euh3HlNAERs) -->]]></content>
    
    
    <categories>
      
      <category>Flutter</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Flutter</tag>
      
      <tag>App</tag>
      
      <tag>ECHO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Recursion</title>
    <link href="/notes/2023/09/13/recursion/"/>
    <url>/notes/2023/09/13/recursion/</url>
    
    <content type="html"><![CDATA[<h2 id="Substitution-Method"><a href="#Substitution-Method" class="headerlink" title="Substitution Method"></a>Substitution Method</h2><h4 id="1-T-n-2T-lfloor-n-2-rfloor-n-T-1-1"><a href="#1-T-n-2T-lfloor-n-2-rfloor-n-T-1-1" class="headerlink" title="1. $T(n) &#x3D; 2T(\lfloor n&#x2F;2 \rfloor) + n$, $T(1) &#x3D; 1$"></a>1. $T(n) &#x3D; 2T(\lfloor n&#x2F;2 \rfloor) + n$, $T(1) &#x3D; 1$</h4><ul><li>Guess $T(n) &#x3D; O(n lgn)$</li><li>Show it by <strong>induction</strong><ul><li>for $n &#x3D; 2$, $T(2) &#x3D; 4$</li><li>for $c &#x3D; 2$, $T(2) \le c n lgn$</li></ul></li><li>Base case: $n_0 &#x3D; 2$hold</li><li>Induction case<ul><li>Assume the guess is true for all $n &#x3D; 2, 3, …, k$</li><li>For $n &#x3D; k + 1$, we have<br>$$<br>\begin{align}<br>  T(n) &amp;&#x3D; 2T(\lfloor n&#x2F;2 \rfloor) + n \newline<br>  &amp;\le 2c\lfloor n&#x2F;2 \rfloor lg \lfloor n&#x2F;2 \rfloor + n \newline<br>  &amp;\le c n lg n&#x2F;2 + n &#x3D; c n lgn - c n + n \newline<br>  &amp;\le c n lg n<br>\end{align}<br>$$</li></ul></li></ul><h4 id="2-T-n-T-lfloor-n-2-rfloor-T-lceil-n-2-rceil-1-T-1-1"><a href="#2-T-n-T-lfloor-n-2-rfloor-T-lceil-n-2-rceil-1-T-1-1" class="headerlink" title="2. $T(n) &#x3D; T(\lfloor n&#x2F;2 \rfloor) + T(\lceil n&#x2F;2 \rceil) + 1$, $T(1) &#x3D; 1$"></a>2. $T(n) &#x3D; T(\lfloor n&#x2F;2 \rfloor) + T(\lceil n&#x2F;2 \rceil) + 1$, $T(1) &#x3D; 1$</h4><ul><li>可以發現當 $n &#x3D; 16 $時<br>$$<br>  \begin{align}<br>T(16) &amp;&#x3D; 2T(8) + 1 \newline<br>&amp;&#x3D; 4T(4) + 2 + 1 \newline<br>&amp;&#x3D; 8T(2) + 4 + 2 + 1 \newline<br>&amp;&#x3D; 16T(1) + 8 + 4 + 2 + 1<br>  \end{align}<br>$$<ul><li>當 n 夠大時， $T(1)$項可以被省略，所以可以猜 $T(n) &#x3D; O(n)$</li></ul></li><li>Base case: for $c &#x3D; 1$, $T(1) &#x3D; 1 \le cn &#x3D; 1$</li><li>Inductive case:<br>$$<br>  \begin{align}<br>T(n) &amp;&#x3D; T(\lfloor n&#x2F;2 \rfloor) + T(\lceil n&#x2F;2 \rceil) + 1 \newline<br>&amp;&#x3D; cn + 1 \newline<br>&amp;\not\le cn<br>  \end{align}<br>$$</li><li>Solution: prove a <strong>stronger</strong> statement<ul><li>$T(n) \le cn - b$</li></ul></li><li>Base case: for $c &#x3D; 2, ; b &#x3D; 1$, $T(2) &#x3D; 3 \le cn - b &#x3D; 3$</li><li>Improved Inductive case:<br>$$<br>  \begin{align}<br>T(n) &amp;&#x3D; T(\lfloor n&#x2F;2 \rfloor) + T(\lceil n&#x2F;2 \rceil) + 1 \newline<br>&amp;&#x3D; c\lfloor n&#x2F;2 \rfloor - b + c \lceil n&#x2F;2 \rceil - b + 1 \newline<br>&amp;&#x3D; cn - b \newline<br>&amp;\le cn ,\quad (b \ge 1)<br>  \end{align}<br>$$</li></ul><h4 id="3-T-n-2T-sqrt-n-lgn"><a href="#3-T-n-2T-sqrt-n-lgn" class="headerlink" title="3. $T(n) &#x3D; 2T(\sqrt{n}) + lgn$"></a>3. $T(n) &#x3D; 2T(\sqrt{n}) + lgn$</h4><ul><li>Set $m &#x3D; lgn$, we get $T(2^m) &#x3D; 2T(2^{m&#x2F;2}) + m$</li><li>Rename $S(m) &#x3D; T(2^m) &#x3D; T(n)$, $S(m) &#x3D; 2S(m&#x2F;2) + m$</li><li>We solve $S(m) &#x3D; O(mlgm)$, $T(n) &#x3D; O(lgn \cdot lg(lgn))$</li></ul><h2 id="Recursion-Tree-Method"><a href="#Recursion-Tree-Method" class="headerlink" title="Recursion Tree Method"></a>Recursion Tree Method</h2><h4 id="1-T-n-2T-n-2-n-2-with-T-1-1"><a href="#1-T-n-2T-n-2-n-2-with-T-1-1" class="headerlink" title="1. $T(n) &#x3D; 2T(n&#x2F;2) + n^2$, with $T(1) &#x3D; 1$"></a>1. $T(n) &#x3D; 2T(n&#x2F;2) + n^2$, with $T(1) &#x3D; 1$</h4><ul><li>Expanding the terms<br>$$<br>  \begin{align}<br>T(n) &amp;&#x3D; 2T(n&#x2F;2) + n^2 \newline<br>&amp;&#x3D; n^2 + n^2&#x2F;2 + 4T(n&#x2F;4) \newline<br>&amp;&#x3D; n^2 + n^2&#x2F;2 + n^2&#x2F;4 + 8T(n&#x2F;8) \newline<br>&amp;&#x3D; … \newline<br>&amp;&#x3D; \sum_{k&#x3D;0}^{lgn - 1} (1&#x2F;2)^k n^2 + 2^{lgn}T(1) \newline<br>&amp;&#x3D; \Theta(n^2) + \Theta(n) &#x3D; \Theta(n^2) \newline<br>  \end{align}<br>$$</li></ul><h4 id="2-T-n-T-n-3-T-2n-3-n-with-T-1-1"><a href="#2-T-n-T-n-3-T-2n-3-n-with-T-1-1" class="headerlink" title="2. $T(n) &#x3D; T(n&#x2F;3) + T({2n}&#x2F;3) + n$, with $T(1) &#x3D; 1$"></a>2. $T(n) &#x3D; T(n&#x2F;3) + T({2n}&#x2F;3) + n$, with $T(1) &#x3D; 1$</h4><ul><li>深度是 $log_{3&#x2F;2}n$，因為右邊項都是原本的 2&#x2F;3</li></ul><h2 id="Master-Method"><a href="#Master-Method" class="headerlink" title="Master Method"></a>Master Method</h2><ul><li>When the <strong>recurrence</strong> is in a special form, we can apply the <strong>Master Theorem</strong> to solve the recurrence immediately</li><li>$T(n) &#x3D; aT(n&#x2F;b) + f(n)$with $a \ge 1$and $b &gt; 1$, where $n&#x2F;b$is either $\lfloor n&#x2F;b \rfloor$or $\lceil n&#x2F;b \rceil$</li><li>There are three cases</li></ul><h4 id="1-Case-1"><a href="#1-Case-1" class="headerlink" title="1. Case 1"></a>1. Case 1</h4><ul><li>$f(n) &#x3D; O(n^{log_b^{a} - \epsilon})$for some constant $\epsilon &gt; 0$</li><li>這代表的意義是，recursion 通常最後可以分成兩項<ol><li><strong>最後一層的數量</strong>，也就是 Divide</li><li><strong>每一層要做的計算</strong>，也就是 Conquer</li></ol></li><li>比較兩者，Case 1 代表 Divide 的計算量比 Conquer 大，所以可以忽略 Conquer 的時間複雜度</li><li>方程式中的 $n^{log_b{a}}$代表最後一層有幾個 node，也可以看成 $a^{log_b{n}}$，代表每一層 <strong>會增加 a</strong> 倍的 node，且總共有 $log_b{n}$層</li><li>Example<ol><li>$T(n) &#x3D; 9T(n&#x2F;3) + n$, T(1) &#x3D; 1<ul><li>We have $a &#x3D; 9, ; b &#x3D; 3, ; f(n) &#x3D; n$</li><li>Since $n^{log_b{a}} &#x3D; n^{log_3{9}} &#x3D; n^2$, $f(n) &#x3D; n &#x3D; O(n^{2-\epsilon})$, we have $T(n) &#x3D; \Theta(n^2)$, where $\epsilon &#x3D; 1$</li></ul></li><li>$T(n) &#x3D; 8T(n&#x2F;2) + n^2$, T(1) &#x3D; 1<ul><li>We have $a &#x3D; 8, b &#x3D; 2 and f(n) &#x3D; \Theta(n^2)$</li><li>Since $n^{log_b{a}} &#x3D; n^{log_2{8}} &#x3D; n^3$, $f(n) &#x3D; n^2 &#x3D; O(n^{3-\epsilon})$, we have $T(n) &#x3D; \Theta(n^3)$, where $\epsilon &#x3D; 1$</li></ul></li><li>$T(n) &#x3D; 7T(n&#x2F;2) + n^2$<ul><li>We have $a &#x3D;7, b &#x3D; 2$, $n^{log_b{a}} &#x3D; n^{lg 7} \approx n^{2.81}$</li><li>Hence, $T(n) &#x3D; \Theta({n^{2.81}})$</li></ul></li></ol></li></ul><h4 id="2-Case-2"><a href="#2-Case-2" class="headerlink" title="2. Case 2"></a>2. Case 2</h4><ul><li>Divide 和 Conquer 計算量一樣</li><li>If $f(n) &#x3D; O(n^{log_b^{a}})$, then $T(n) &#x3D; \Theta(f(n) lg n)$</li><li>Example<ol><li>$T(n) &#x3D; T(2n&#x2F;3) + 1$<ul><li>$a &#x3D; 1, b &#x3D; 3&#x2F;2, f(n) &#x3D; 1$, and $n^{log_b{a}} &#x3D; n^{log_{3&#x2F;2}{1}} &#x3D; 1$</li><li>We have $f(n) &#x3D; \Theta(n^{log_b{a}}) &#x3D; \Theta(1)$</li><li>Thus $T(n) &#x3D; \Theta(lg n)$</li></ul></li></ol></li></ul><h4 id="3-Case-3"><a href="#3-Case-3" class="headerlink" title="3. Case 3"></a>3. Case 3</h4><ul><li>Conquer 計算量比 Divide 大</li><li>If $f(n) &#x3D; \Omega(n^{log_b{a} + \epsilon})$for some constant $\epsilon &gt; 0$</li><li>And if $a f(n&#x2F;b \le cf(n))$for some constant $c &lt; 1$</li><li>Then $T(n) &#x3D; \Theta(f(n))$</li><li>Example: $T(n) &#x3D; 3T(n&#x2F;4) + nlgn$<ul><li>$a &#x3D; 3, b &#x3D; 4$, $f(n) &#x3D; n lg n$, and $n^{log_4{3}} &#x3D; O(n^{0.793})$</li><li>$f(n) &#x3D; \Omega(n^{0.793 + \epsilon})$</li><li>$af(n&#x2F;b) &#x3D; 3f(n&#x2F;4) &#x3D; 3(n&#x2F;4)lg(n&#x2F;4) \le (3&#x2F;4)n lgn &#x3D; cf(n) &#x3D; cf(n)$, for c &#x3D; 3&#x2F;4</li><li>Hence, $T(n) &#x3D; \Theta(n lg n)$</li></ul></li></ul><h4 id="4-不能用的情況"><a href="#4-不能用的情況" class="headerlink" title="4. 不能用的情況"></a>4. 不能用的情況</h4><ol><li><p>$f(n)$is smaller than $n^{log_b{a}}$but <strong>not polynomial smaller</strong></p><ul><li>Example: $T(n) &#x3D; 2T(n&#x2F;2) + n&#x2F;lgn$<ul><li>$n^{log_b{a}} &#x3D; n^{log_2{2}} &#x3D; n$, <strong>n&#x2F;lgn</strong> is smaller than <strong>n</strong> but <strong>not polynomial smaller</strong></li><li>Hence you can’t use Master theorem</li></ul></li></ul></li><li><p>$f(n)$is larger than $n^{log_b{a}}$but <strong>not polynomial larger</strong></p><ul><li>Example: $T(n) &#x3D; 2T(n&#x2F;2) + nlgn$<ul><li>$n^{log_b{a}} &#x3D; n^{log_2{2}} &#x3D; n$, <strong>n&#x2F;lgn</strong> is larger than <strong>n</strong> but <strong>not polynomial larger</strong></li><li>Hence you can’t use Master theorem</li></ul></li></ul></li></ol>]]></content>
    
    
    <categories>
      
      <category>Algorithm</category>
      
      <category>Recursion</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Recursion</tag>
      
      <tag>Algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Simple Discord Music Bot</title>
    <link href="/notes/2023/09/08/simple-discord-music-bot/"/>
    <url>/notes/2023/09/08/simple-discord-music-bot/</url>
    
    <content type="html"><![CDATA[<blockquote><p>一個可以撥放 Youtube playlist 的 Discord 音樂機器人<br>Source code: <a href="https://github.com/933yee/discord-simple-music-bot">https://github.com/933yee/discord-simple-music-bot</a></p></blockquote><h2 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">project<br>  └── bot<br>       ├── bot<span class="hljs-selector-class">.py</span><br>       ├── config<span class="hljs-selector-class">.py</span><br>       └── data<br>            └── data<span class="hljs-selector-class">.py</span><br>       └── cogs<br>            ├── commands<span class="hljs-selector-class">.py</span><br>            └── events<span class="hljs-selector-class">.py</span><br>  └── .env<br></code></pre></td></tr></table></figure><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="main-py"><a href="#main-py" class="headerlink" title="main.py"></a>main.py</h3><ul><li>可以藉由更改<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs py">bot = commands.Bot(command_prefix=<span class="hljs-string">&quot;!&quot;</span>, intents=intents)<br></code></pre></td></tr></table></figure>改變指令的前綴符號</li></ul><h3 id="config-py"><a href="#config-py" class="headerlink" title="config.py"></a>config.py</h3><ul><li>讀取儲存在 .env 檔案裡面 discord 機器人的 Token</li></ul><h3 id="data-py"><a href="#data-py" class="headerlink" title="data.py"></a>data.py</h3><ul><li>全域變數，提供給 events.py、commands.py 做處理，還會記哪些伺服器正在使用這個機器人<ul><li>server_data<ul><li>記錄某伺服器待播的歌曲清單</li></ul></li><li>server_loop<ul><li>記錄某伺服器是否正在循環撥放</li></ul></li></ul></li></ul><h3 id="events-py"><a href="#events-py" class="headerlink" title="events.py"></a>events.py</h3><ul><li>處理事件的地方，像是偵測機器人的開啟、語音頻道的變化（有人離開、加入）等事件。</li></ul><h3 id="commands-py"><a href="#commands-py" class="headerlink" title="commands.py"></a>commands.py</h3><ul><li>新增指令的地方，像是：<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-meta">@commands.command(<span class="hljs-params">description=<span class="hljs-string">&quot;Exit voice channel\n&quot;</span> <span class="hljs-string">&quot; &quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>(<span class="hljs-params">self, ctx</span>):<br>    <span class="hljs-keyword">if</span> ctx.guild.<span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> server_data:<br>        <span class="hljs-keyword">await</span> ctx.voice_client.disconnect()<br>        <span class="hljs-keyword">del</span> server_data[ctx.guild.<span class="hljs-built_in">id</span>]<br>        <span class="hljs-keyword">del</span> server_loop[ctx.guild.<span class="hljs-built_in">id</span>]<br></code></pre></td></tr></table></figure><ul><li>description 是提供給 !help 指令做介紹，簡述指令的功能</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>Side projects</category>
      
      <category>Discord Bot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Side Projects</tag>
      
      <tag>Discord</tag>
      
      <tag>Bot</tag>
      
      <tag>Backend</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>學貸申請步驟</title>
    <link href="/notes/2023/09/06/nthu-loan/"/>
    <url>/notes/2023/09/06/nthu-loan/</url>
    
    <content type="html"><![CDATA[<p>到 <strong><a href="https://www.ccxp.nthu.edu.tw/ccxp/INQUIRE">校務資訊系統</a>&#x2F; 繳費單相關作業(出納組)&#x2F; 繳費單列印&#x2F; 學雜費</strong>，看學費多少，扣掉<strong>不可貸款項目</strong> (體育設施使用費)</p><h4 id="就學貸款申請表"><a href="#就學貸款申請表" class="headerlink" title="就學貸款申請表"></a>就學貸款申請表</h4><ul><li>到校務資訊系統&#x2F; 就學貸款&#x2F;就學貸款申請&#x2F;填寫就學貸款申請表，列印簽名，填好會給<strong>不可貸款項目繳費單</strong></li></ul><h4 id="臺灣銀行撥款通知書第-2-聯"><a href="#臺灣銀行撥款通知書第-2-聯" class="headerlink" title="臺灣銀行撥款通知書第 2 聯"></a>臺灣銀行撥款通知書第 2 聯</h4><ul><li>到 <strong><a href="https://sloan.bot.com.tw/customer/login/SLoanLogin.action">臺灣銀行就學貸款入口網</a></strong> 填寫申請書，填好選擇簡訊 OTP 認證對保</li></ul><h4 id="不可貸款項目繳費證明"><a href="#不可貸款項目繳費證明" class="headerlink" title="不可貸款項目繳費證明"></a>不可貸款項目繳費證明</h4>]]></content>
    
    
    <categories>
      
      <category>Others</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Others</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Time Complexity</title>
    <link href="/notes/2023/01/17/time-complexity/"/>
    <url>/notes/2023/01/17/time-complexity/</url>
    
    <content type="html"><![CDATA[<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*5ZLci3SuR0zM_QlZOADv8Q.jpeg" alt="Big-O Complexity Chart"></p><h2 id="Big-O-O"><a href="#Big-O-O" class="headerlink" title="Big-O ($O$)"></a><strong>Big-O ($O$)</strong></h2><h3 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a><strong>Definition</strong></h3><ul><li>f(n) &#x3D; $O$(g(n)) iff $\exists$ <span style="color:yellow">  c, n<sub>0</sub> &gt; 0 </span> such that<span style="color:yellow"> f(n)$\le$ c $\cdot$ g(n) </span> $\forall$ <span style="color:yellow"> n $\ge$ n<sub>0</sub> </span></li></ul><h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a><strong>Examples</strong></h3><ul><li><dl><dt>3n+2 &#x3D; $O$(n)</dt><dd>When c&#x3D;4, n<sub>0</sub> &#x3D; 2, 3n+2 $\le$ 4n for all n $\ge$ 2.</dd></dl></li><li><dl><dt>100n+6 &#x3D; $O$(n)</dt><dd>When c&#x3D;101, n<sub>0</sub> &#x3D; 6, 100n+6 $\le$ 101n for all n $\ge$ 6. </dd></dl></li><li><dl><dt>10n<sup>2</sup>+4n+2 &#x3D; $O$(n<sup>2</sup>)</dt><dd>When c&#x3D;11, n<sub>0</sub> &#x3D; 5, 10n<sup>2</sup>+4n+2 $\le$ 11n<sup>2</sup> for all n $\ge$ 5. </dd></dl></li><li><h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a><strong>Properties</strong></h3><ul><li>f(n) &#x3D; $O$(g(n)) states that $O$(g(n)) is an <span style="color:yellow"> upper bound </span> of f(n), so n &#x3D; $O$(n) &#x3D; $O$(n<sup>2.5</sup>) &#x3D; $O$(n<sup>3</sup>) &#x3D; $O$(n<sup>n</sup>). However, we want g(n) <span style="color:yellow"> as small as possible </span>.</li><li>Big-O refers to <span style="color:yellow"> worst-case running time </span> of a program.</li></ul></li></ul><h2 id="Big-Omega-Omega"><a href="#Big-Omega-Omega" class="headerlink" title="Big-Omega($\Omega$)"></a><strong>Big-Omega($\Omega$)</strong></h2><h3 id="Definition-1"><a href="#Definition-1" class="headerlink" title="Definition"></a><strong>Definition</strong></h3><ul><li>f(n) &#x3D; $\Omega$(g(n)) iff $\exists$ <span style="color:yellow">  c, n<sub>0</sub> &gt; 0 </span> such that <span style="color:yellow">f(n)$\ge$ c $\cdot$ g(n) </span> $\forall$ <span style="color:yellow"> n  $\ge$ n<sub>0</sub> </span>.</li></ul><h3 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a><strong>Examples</strong></h3><ul><li><dl><dt>3n+2 &#x3D; $\Omega$(n)</dt><dd>When c&#x3D;3, n<sub>0</sub> &#x3D; 1, 3n+2 $\ge$ 3n $\forall$ n $\ge$ 1.</dd></dl></li><li><dl><dt>100n+6 &#x3D; $\Omega$(n)</dt><dd>When c&#x3D;100, n<sub>0</sub> &#x3D; 1, 100n+6 $\ge$ 100n $\forall$ n $\ge$ 1.  </dd></dl></li><li><dl><dt>10n<sup>2</sup>+4n+2 &#x3D; $\Omega$(n<sup>2</sup>)</dt><dd>When c&#x3D;1, n<sub>0</sub> &#x3D; 1, 10n<sup>2</sup>+4n+2 $\ge$ n<sup>2</sup> $\forall$ n $\ge$ 1.</dd></dl></li></ul><h3 id="Properties-1"><a href="#Properties-1" class="headerlink" title="Properties"></a><strong>Properties</strong></h3><ul><li>f(n) &#x3D; $\Omega$(g(n)) states that $\Omega$(g(n)) is a <span style="color:yellow"> lower bound </span> of f(n).</li><li>$\Omega$ refers to <span style="color:yellow"> best-case running time </span> of a program.</li></ul><h2 id="Big-Theta-theta"><a href="#Big-Theta-theta" class="headerlink" title="Big-Theta($\theta$)"></a><strong>Big-Theta($\theta$)</strong></h2><h3 id="Definition-2"><a href="#Definition-2" class="headerlink" title="Definition"></a><strong>Definition</strong></h3><ul><li>f(n) &#x3D; $\theta$(g(n)) iff <span style="color:yellow"> f(n) &#x3D; $O$(g(n)) </span> and <span style="color:yellow"> f(n) &#x3D; $\Omega$(g(n))</span>.</li></ul><h3 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a><strong>Examples</strong></h3><ul><li>3n+2 &#x3D; $\theta$(n)</li><li>100n+6 &#x3D; $\theta$(n)</li><li>10n<sup>2</sup>+4n+2 &#x3D; $\theta$(n<sup>2</sup>)</li></ul><h3 id="Properties-2"><a href="#Properties-2" class="headerlink" title="Properties"></a><strong>Properties</strong></h3><ul><li>f(n) &#x3D; $\theta$(g(n)) states that $\theta$(g(n)) is a <span style="color:yellow"> tight bound </span> of f(n).</li><li>$\theta$ refers to <span style="color:yellow"> average-case running time </span >of a program.</li></ul><h2 id="Cheat-Sheets"><a href="#Cheat-Sheets" class="headerlink" title="Cheat Sheets"></a><strong>Cheat Sheets</strong></h2><p><img src="https://pic4.zhimg.com/80/v2-bea9f0ddbc2d810e9feba3f3cc8b2b7f_720w.webp" alt="Data Structure Operations"><br><img src="https://pic4.zhimg.com/80/v2-c9074ce39abbdebd1120451bf657e67f_720w.webp" alt="Array Sorting"></p><h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul><li><a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjr647gjoiEAxX2hq8BHQilDfMQFnoECBEQAQ&url=https://www.bigocheatsheet.com/&usg=AOvVaw0j8XV1sZ0vh9PgRFBYyAHO&opi=89978449">Big-O Algorithm Complexity Cheat Sheet</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Algorithm</category>
      
      <category>Time Complexity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Algorithm</tag>
      
      <tag>Time Complexity</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
